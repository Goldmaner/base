<!-- templates/parcerias.html -->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Parcerias - Módulo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    body { background-color: #f8f9fa; padding: 20px; }
    .header-section { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
    .filter-section { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
    .table-container { background: #fff; padding: 20px; border-radius: 8px; overflow-x: auto; }
    .table { font-size: 0.9rem; }
    .table th { background-color: #0d6efd; color: white; white-space: nowrap; }
    .btn-action { padding: 5px 15px; }
    .sei-formatted { font-family: 'Courier New', monospace; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <!-- Cabeçalho -->
    <div class="header-section">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2>Parcerias</h2>
          <p class="text-muted mb-0">Visualização e gerenciamento de todas as parcerias</p>
        </div>
        <div>
          <a href="{{ url_for('parcerias.dicionario_oscs') }}" class="btn btn-info me-2" title="Gerenciar e padronizar nomes de OSCs">
            <i class="bi bi-building"></i> Dicionário de OSCs
          </a>
          <a href="{{ url_for('parcerias.conferencia') }}" class="btn btn-warning me-2" title="Comparar parcerias do banco externo com o sistema">
            <i class="bi bi-clipboard-check"></i> Conferir Parcerias
          </a>
          <a href="{{ url_for('parcerias.dgp_alteracoes') }}" class="btn btn-primary me-2" title="Cadastrar e gerenciar alterações em termos">
            <i class="bi bi-arrow-repeat"></i> Cadastrar Alterações
          </a>
          <a href="{{ url_for('parcerias.termos_rescindidos') }}" class="btn btn-danger me-2" title="Cadastrar e gerenciar termos rescindidos">
            <i class="bi bi-x-circle"></i> Cadastrar Termos Rescindidos
          </a>
          <button class="btn btn-success me-2" onclick="exportarCSV()">
            <i class="bi bi-file-earmark-spreadsheet"></i> Exportar CSV
          </button>
          <a href="{{ url_for('parcerias.nova') }}" class="btn btn-success me-2">
            <i class="bi bi-plus-circle"></i> Adicionar Parceria
          </a>
          <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar
          </a>
        </div>
      </div>
    </div>

    <!-- Seção de Filtros -->
    <div class="filter-section">
      <form method="get" action="{{ url_for('parcerias.listar') }}">
        <div class="row mb-3">
          <div class="col-md-12">
            <h5><i class="bi bi-funnel"></i> Filtros</h5>
          </div>
        </div>
        
        <div class="row g-3 mb-3">
          <div class="col-md-3">
            <label for="filtro_termo" class="form-label">Número do Termo</label>
            <input type="text" class="form-control" id="filtro_termo" name="filtro_termo" 
                   value="{{ filtro_termo or '' }}" placeholder="Ex: TCL/001/2024">
          </div>
          <div class="col-md-3">
            <label for="filtro_osc" class="form-label">OSC</label>
            <input type="text" class="form-control" id="filtro_osc" name="filtro_osc" 
                   value="{{ filtro_osc or '' }}" placeholder="Nome da OSC">
          </div>
          <div class="col-md-3">
            <label for="filtro_projeto" class="form-label">Projeto</label>
            <input type="text" class="form-control" id="filtro_projeto" name="filtro_projeto" 
                   value="{{ filtro_projeto or '' }}" placeholder="Nome do projeto">
          </div>
          <div class="col-md-3">
            <label for="filtro_tipo_termo" class="form-label">Tipo de Termo</label>
            <select class="form-select" id="filtro_tipo_termo" name="filtro_tipo_termo">
              <option value="">-- Todos --</option>
              {% for tipo in tipos_contrato %}
                <option value="{{ tipo }}" {% if filtro_tipo_termo == tipo %}selected{% endif %}>{{ tipo }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-3">
            <label for="filtro_status" class="form-label">Status do Termo</label>
            <select class="form-select" id="filtro_status" name="filtro_status">
              <option value="">-- Todos --</option>
              <option value="vigente" {% if filtro_status == 'vigente' %}selected{% endif %}>Vigente</option>
              <option value="encerrado" {% if filtro_status == 'encerrado' %}selected{% endif %}>Encerrado</option>
              <option value="nao_iniciado" {% if filtro_status == 'nao_iniciado' %}selected{% endif %}>Não iniciado</option>
              <option value="rescindido" {% if filtro_status == 'rescindido' %}selected{% endif %}>Rescindido</option>
              <option value="suspenso" {% if filtro_status == 'suspenso' %}selected{% endif %}>Suspenso</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="filtro_pessoa_gestora" class="form-label">Pessoa Gestora</label>
            <select class="form-select" id="filtro_pessoa_gestora" name="filtro_pessoa_gestora">
              <option value="">-- Todas --</option>
              <option value="Nenhuma" {% if filtro_pessoa_gestora == 'Nenhuma' %}selected{% endif %}>Nenhuma</option>
              <option value="Inativos" {% if filtro_pessoa_gestora == 'Inativos' %}selected{% endif %}>Inativos</option>
              {% for pg in pessoas_gestoras_filtro %}
                <option value="{{ pg }}" {% if filtro_pessoa_gestora == pg %}selected{% endif %}>{{ pg }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-12">
            <h6><i class="bi bi-search"></i> Pesquisa por Processo SEI</h6>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="busca_sei_celeb" class="form-label">SEI de Celebração</label>
            <input type="text" class="form-control" id="busca_sei_celeb" name="busca_sei_celeb" 
                   value="{{ busca_sei_celeb or '' }}" placeholder="Ex: 6074.2024/0001234-5">
          </div>
          <div class="col-md-6">
            <label for="busca_sei_pc" class="form-label">SEI de Pagamento/PC</label>
            <input type="text" class="form-control" id="busca_sei_pc" name="busca_sei_pc" 
                   value="{{ busca_sei_pc or '' }}" placeholder="Ex: 6074.2024/0005678-9">
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-12">
            <label for="limite" class="form-label">Mostrar somente</label>
            <select class="form-select" id="limite" name="limite" style="width: 200px;">
              <option value="10" {% if limite == '10' %}selected{% endif %}>10 linhas</option>
              <option value="50" {% if limite == '50' %}selected{% endif %}>50 linhas</option>
              <option value="100" {% if limite == '100' %}selected{% endif %}>100 linhas</option>
              <option value="1000" {% if limite == '1000' %}selected{% endif %}>1000 linhas</option>
              <option value="todas" {% if limite == 'todas' %}selected{% endif %}>Todas</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col-md-12 d-flex gap-2">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-search"></i> Aplicar Filtros
            </button>
            <a href="{{ url_for('parcerias.listar') }}" class="btn btn-secondary">
              <i class="bi bi-x-circle"></i> Limpar Filtros
            </a>
          </div>
        </div>
      </form>
    </div>

    <!-- Tabela de Parcerias -->
    <div class="table-container">
      {% if parcerias %}
        <table class="table table-hover table-bordered" id="tabelaParcerias">
          <thead>
            <tr>
              <th class="text-center">Número do Termo</th>
              <th class="text-center sortable" onclick="sortTable(1)" style="cursor: pointer;">
                OSC <i class="bi bi-arrow-down-up"></i>
              </th>
              <th class="text-center">Projeto</th>
              <th class="text-center">Tipo de Termo</th>
              <th class="text-center">Status</th>
              <th class="text-center">Pessoa Gestora</th>
              <th class="text-center sortable" onclick="sortTable(6)" style="cursor: pointer;">
                Data de Início <i class="bi bi-arrow-down-up"></i>
              </th>
              <th class="text-center sortable" onclick="sortTable(7)" style="cursor: pointer;">
                Data de Término <i class="bi bi-arrow-down-up"></i>
              </th>
              <th class="text-center sortable" onclick="sortTable(8)" style="cursor: pointer;">
                Meses do Projeto <i class="bi bi-arrow-down-up"></i>
              </th>
              <th class="text-center sortable" onclick="sortTable(9)" style="cursor: pointer;">
                Total Valor Previsto <i class="bi bi-arrow-down-up"></i>
              </th>
              <th class="text-center sortable" onclick="sortTable(10)" style="cursor: pointer;">
                Total Valor Pago <i class="bi bi-arrow-down-up"></i>
              </th>
              <th class="text-center">SEI de Celebração</th>
              <th class="text-center">SEI de Pagamento</th>
              <th class="text-center">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for parceria in parcerias %}
              <tr>
                <td class="text-center"><strong>{{ parceria.numero_termo }}</strong></td>
                <td>{{ parceria.osc or '-' }}</td>
                <td>{{ parceria.projeto or '-' }}</td>
                <td class="text-center">{{ parceria.tipo_termo or '-' }}</td>
                <td class="text-center">
                  {% if parceria.status_calculado %}
                    <span class="badge 
                      {% if parceria.status_calculado == 'Vigente' %}bg-success
                      {% elif parceria.status_calculado == 'Encerrado' %}bg-secondary
                      {% elif parceria.status_calculado == 'Não iniciado' %}bg-info
                      {% elif parceria.status_calculado == 'Rescindido' %}bg-danger
                      {% elif parceria.status_calculado == 'Suspenso' %}bg-warning text-dark
                      {% else %}bg-light text-dark{% endif %}">
                      {{ parceria.status_calculado }}
                    </span>
                  {% else %}
                    <span class="badge bg-light text-dark">-</span>
                  {% endif %}
                </td>
                <td class="text-center {% if parceria.status_pg and parceria.status_pg != 'Ativo' and parceria.status_calculado == 'Vigente' %}table-warning{% endif %}">
                  {{ parceria.pessoa_gestora or '-' }}
                  {% if parceria.status_pg and parceria.status_pg != 'Ativo' and parceria.status_calculado == 'Vigente' %}
                    <i class="bi bi-exclamation-triangle text-warning" title="Pessoa gestora inativa em termo vigente"></i>
                    {% if parceria.solicitacao %}
                      <i class="bi bi-check-circle text-success" title="Alteração já solicitada"></i>
                    {% endif %}
                  {% endif %}
                </td>
                <td class="text-center">{{ parceria.inicio.strftime('%d/%m/%Y') if parceria.inicio else '-' }}</td>
                <td class="text-center">{{ parceria.final.strftime('%d/%m/%Y') if parceria.final else '-' }}</td>
                <td class="text-center">{{ parceria.meses if parceria.meses is not none else '-' }}</td>
                <td class="text-end">R$ {{ parceria.total_previsto|format_brl }}</td>
                <td class="text-end">R$ {{ parceria.total_pago|format_brl }}</td>
                <td class="text-center sei-formatted">{{ parceria.sei_celeb or '-' }}</td>
                <td class="text-center sei-formatted">{{ parceria.sei_pc or '-' }}</td>
                <td class="text-center">
                  <a class="btn btn-warning btn-action" href="{{ url_for('parcerias.editar', numero_termo=parceria.numero_termo) }}">
                    <i class="bi bi-pencil"></i> Modificar
                  </a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        <div class="mt-3 p-3 bg-light rounded">
          <div class="row">
            <div class="col-md-6">
              <h6 class="mb-2"><i class="bi bi-info-circle"></i> Resumo dos Resultados</h6>
              <p class="mb-1"><strong>Total de termos exibidos:</strong> <span class="badge bg-primary">{{ parcerias|length }}</span></p>
              {% if total_geral is defined and total_geral != parcerias|length %}
              <p class="mb-0 text-muted"><small>Total no sistema (sem filtros): {{ total_geral }}</small></p>
              {% endif %}
            </div>
            <div class="col-md-6 text-end">
              <h6 class="mb-2"><i class="bi bi-bar-chart"></i> Por Status</h6>
              <div class="d-flex gap-2 justify-content-end flex-wrap">
                {% if contagem_status %}
                  {% for status, count in contagem_status.items() %}
                    <span class="badge 
                      {% if status == 'Vigente' %}bg-success
                      {% elif status == 'Encerrado' %}bg-secondary
                      {% elif status == 'Não iniciado' %}bg-info
                      {% elif status == 'Rescindido' %}bg-danger
                      {% elif status == 'Suspenso' %}bg-warning text-dark
                      {% else %}bg-light text-dark{% endif %}">
                      {{ status }}: {{ count }}
                    </span>
                  {% endfor %}
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% else %}
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i> Nenhuma parceria encontrada no sistema.
        </div>
      {% endif %}
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function exportarCSV() {
      // Mostrar indicador de carregamento
      const btnExportar = event.target.closest('button');
      const textoOriginal = btnExportar.innerHTML;
      btnExportar.disabled = true;
      btnExportar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Exportando...';
      
      // Construir URL com os mesmos parâmetros de filtro da página atual
      const params = new URLSearchParams(window.location.search);
      const exportUrl = '{{ url_for("parcerias.exportar_csv") }}' + '?' + params.toString();
      
      // Fazer requisição para a API de exportação
      window.location.href = exportUrl;
      
      // Restaurar botão após um tempo
      setTimeout(() => {
        btnExportar.disabled = false;
        btnExportar.innerHTML = textoOriginal;
      }, 2000);
    }

    // Função de ordenação de tabela
    let sortDirections = {}; // Armazena a direção da ordenação para cada coluna

    function sortTable(columnIndex) {
      const table = document.getElementById('tabelaParcerias');
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      
      // Determinar direção da ordenação (alternando entre ascendente/descendente)
      if (!sortDirections[columnIndex]) {
        sortDirections[columnIndex] = 'asc';
      } else {
        sortDirections[columnIndex] = sortDirections[columnIndex] === 'asc' ? 'desc' : 'asc';
      }
      const direction = sortDirections[columnIndex];
      
      // Ordenar linhas
      rows.sort((a, b) => {
        const cellA = a.cells[columnIndex];
        const cellB = b.cells[columnIndex];
        
        let valueA = cellA.textContent.trim();
        let valueB = cellB.textContent.trim();
        
        // Remover ícones de aviso do texto antes de comparar
        valueA = valueA.replace(/\s*\u26A0.*$/, '').trim();
        valueB = valueB.replace(/\s*\u26A0.*$/, '').trim();
        
        // Tratar células vazias
        if (valueA === '-') valueA = '';
        if (valueB === '-') valueB = '';
        
        // Detectar tipo de dado e fazer comparação apropriada
        let comparison = 0;
        
        // Datas no formato dd/mm/yyyy
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(valueA) && /^\d{2}\/\d{2}\/\d{4}$/.test(valueB)) {
          const [dayA, monthA, yearA] = valueA.split('/').map(Number);
          const [dayB, monthB, yearB] = valueB.split('/').map(Number);
          const dateA = new Date(yearA, monthA - 1, dayA);
          const dateB = new Date(yearB, monthB - 1, dayB);
          comparison = dateA - dateB;
        }
        // Valores monetários (R$ 1.234,56)
        else if (valueA.startsWith('R$') && valueB.startsWith('R$')) {
          const numA = parseFloat(valueA.replace('R$', '').replace(/\./g, '').replace(',', '.').trim()) || 0;
          const numB = parseFloat(valueB.replace('R$', '').replace(/\./g, '').replace(',', '.').trim()) || 0;
          comparison = numA - numB;
        }
        // Números inteiros
        else if (!isNaN(valueA) && !isNaN(valueB) && valueA !== '' && valueB !== '') {
          comparison = parseFloat(valueA) - parseFloat(valueB);
        }
        // Texto
        else {
          comparison = valueA.localeCompare(valueB, 'pt-BR', { sensitivity: 'base' });
        }
        
        return direction === 'asc' ? comparison : -comparison;
      });
      
      // Reordenar as linhas na tabela
      rows.forEach(row => tbody.appendChild(row));
      
      // Atualizar ícones de ordenação
      const headers = table.querySelectorAll('th.sortable');
      headers.forEach((header, index) => {
        const icon = header.querySelector('i');
        if (icon) {
          // Encontrar qual índice de coluna corresponde a este cabeçalho
          const headerIndex = Array.from(table.querySelectorAll('th')).indexOf(header);
          if (headerIndex === columnIndex) {
            icon.className = direction === 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down';
          } else {
            icon.className = 'bi bi-arrow-down-up';
          }
        }
      });
    }
  </script>
</body>
</html>
