<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Or√ßamento - Preenchimento</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
  /* permitir rolagem horizontal sem limitar a largura da tabela; ocupa 100% da viewport */
  body { margin: 0; padding: 0; }
  .container { max-width: 100%; padding: 1rem; }
  .table-wrapper{ overflow-x: auto; width: 100%; max-width: 100%; margin: 0; }
  /* largura m√≠nima aumentada para cada coluna de m√™s */
  #tabelaOrc2 th.month-th, #tabelaOrc2 td.month-td { min-width: 140px; }
  /* largura m√≠nima maior para colunas de rubrica e categoria */
  #tabelaOrc2 th.col-rubrica, #tabelaOrc2 td.col-rubrica { min-width: 200px; }
  #tabelaOrc2 th.col-categoria, #tabelaOrc2 td.col-categoria { min-width: 260px; }
  /* coluna de total da linha */
  #tabelaOrc2 th.col-total-linha, #tabelaOrc2 td.col-total-linha { min-width: 120px; background-color: #f8f9fa; font-weight: bold; }
  /* permitir que inputs de m√™s fiquem com largura m√≠nima adequada */
  .month-name { min-width: 120px; }
  /* aumentar a altura das linhas e inputs para melhor legibilidade */
  #tabelaOrc2 td, #tabelaOrc2 th { padding: .75rem .5rem; }
  #tabelaOrc2 .form-control { height: calc(1.8em + .75rem); padding: .375rem .5rem; }
  /* resizer handle */
  #tabelaOrc2 th { position: relative; }
  .col-resizer { position: absolute; top: 0; right: 0; width: 8px; height: 100%; cursor: col-resize; z-index: 20; }
  .col-resizer:hover { background: rgba(0,0,0,0.03); }
  /* ocultar colunas de meses */
  .hide-months .month-th, .hide-months .month-td { display: none !important; }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <h2 id="pageTitle">Preenchimento do Or√ßamento Anual ou Proposta Or√ßament√°ria</h2>
    <h5 id="termoSub" class="text-muted">
      {{ numero_termo }} 
      {% if sei_celeb %}
        &nbsp;|&nbsp;<span class="badge bg-info text-dark">SEI: {{ sei_celeb }}</span>
      {% endif %}
      &nbsp;<small class="text-muted">Previsto: {{ total_previsto if total_previsto is defined else 'R$ 0,00' }}</small>
    </h5>
    
    <!-- Dropdown Aditivo -->
    <div class="mt-2 mb-3">
      <label for="aditivoSelect" class="form-label fw-bold">Aditivo:</label>
      <select id="aditivoSelect" class="form-select form-select-sm w-auto d-inline-block ms-2" style="width: 200px !important;">
        {% if aditivos %}
          {% for ad in aditivos %}
            <option value="{{ ad }}" {% if ad == 0 %}selected{% endif %}>
              {% if ad == 0 %}Base{% else %}Aditivo {{ ad }}{% endif %}
            </option>
          {% endfor %}
        {% else %}
          <option value="0" selected>Base</option>
        {% endif %}
      </select>
    </div>

    <div class="mt-3 d-flex gap-2 align-items-center flex-wrap">
      <a class="btn btn-light btn-sm" href="{{ url_for('orcamento.listar') }}">&larr; Voltar</a>
      <button id="toggleMonthsBtn" class="btn btn-outline-secondary btn-sm">
        <span id="toggleMonthsText">üëÅÔ∏è Ocultar Meses</span>
      </button>
      <div class="input-group input-group-sm w-auto">
        <span class="input-group-text">Adicionar meses</span>
        <input id="numCols" type="number" class="form-control" min="1" value="1" style="width:80px">
      </div>
      <button id="addMonthsBtn" class="btn btn-secondary btn-sm">Adicionar</button>
      <!-- Import Excel -->
      <div class="input-group input-group-sm ms-2">
        <input id="excelFileInput" type="file" accept=".xlsx,.xls" class="form-control">
        <button id="importExcelBtn" class="btn btn-outline-primary">Importar Excel</button>
        <button id="downloadTemplateBtn" class="btn btn-outline-secondary ms-1">Modelo de Importa√ß√£o</button>
      </div>
    </div>

    <div class="mt-3">
      <div class="table-wrapper">
      <table class="table table-sm table-bordered" id="tabelaOrc2">
        <thead class="table-light">
          <tr>
            <th class="col-rubrica">Rubrica<span class="col-resizer"></span></th>
            <th>Quantidade</th>
            <th class="col-categoria">Categoria de Despesa<span class="col-resizer"></span></th>
            <!-- month headers -->
            <th class="month-th"><div class="d-flex gap-1"><input class="form-control form-control-sm month-name" value="M√™s 1"><button type="button" class="btn btn-sm btn-outline-danger remove-month">‚úï</button></div><span class="col-resizer"></span></th>
            <th class="month-th"><div class="d-flex gap-1"><input class="form-control form-control-sm month-name" value="M√™s 2"><button type="button" class="btn btn-sm btn-outline-danger remove-month">‚úï</button></div><span class="col-resizer"></span></th>
            <th class="month-th"><div class="d-flex gap-1"><input class="form-control form-control-sm month-name" value="M√™s 3"><button type="button" class="btn btn-sm btn-outline-danger remove-month">‚úï</button></div><span class="col-resizer"></span></th>
            <th class="month-th"><div class="d-flex gap-1"><input class="form-control form-control-sm month-name" value="M√™s 4"><button type="button" class="btn btn-sm btn-outline-danger remove-month">‚úï</button></div><span class="col-resizer"></span></th>
            <th class="col-total-linha">Total</th>
            <th>A√ß√£o</th>
          </tr>
        </thead>
        <tbody id="bodyOrc2">
          {% for i in range(20) %}
          <tr>
            <td class="col-rubrica">
              <select class="form-select form-select-sm" name="rubrica">
                <option value="">Selecione...</option>
                <option>Pessoal</option>
                <option>Materiais</option>
                <option>Administrativas</option>
                <option>Servi√ßos de Terceiros</option>
                <option>Outras Despesas</option>
                <option>Imobilizado</option>
                <option>Implanta√ß√£o</option>
              </select>
            </td>
            <td><input type="text" class="form-control form-control-sm quantidade" value="1"></td>
            <td class="col-categoria">
              <input type="text" class="form-control form-control-sm categoria" 
                     placeholder="Ex: Gerente de Servi√ßo I" 
                     list="categoriasDisponiveis">
            </td>
            <td class="month-td"><input type="text" class="form-control form-control-sm valor" placeholder="0,00"></td>
            <td class="month-td"><input type="text" class="form-control form-control-sm valor" placeholder="0,00"></td>
            <td class="month-td"><input type="text" class="form-control form-control-sm valor" placeholder="0,00"></td>
            <td class="month-td"><input type="text" class="form-control form-control-sm valor" placeholder="0,00"></td>
            <td class="col-total-linha text-end total-linha">0,00</td>
            <td><button type="button" class="btn btn-danger btn-sm remover">Remover</button></td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr class="table-secondary">
            <td colspan="3" class="text-end"><strong>Total</strong></td>
            <!-- totals for month columns will be injected -->
            <td class="col-total month-td">0,00</td>
            <td class="col-total month-td">0,00</td>
            <td class="col-total month-td">0,00</td>
            <td class="col-total month-td">0,00</td>
            <td><strong id="grandTotal">0,00</strong></td>
            <td></td>
          </tr>
        </tfoot>
      </table>
      </div>
      
      <!-- Datalist para categorias dispon√≠veis -->
      <datalist id="categoriasDisponiveis">
        <!-- Ser√° preenchido via JavaScript -->
      </datalist>

      <div class="d-flex gap-2">
        <button id="addLinha" class="btn btn-secondary btn-sm">Adicionar Linha</button>
        <button id="limparBtn" class="btn btn-warning btn-sm">üóëÔ∏è Limpar Tudo</button>
        <button id="salvarOrc2" class="btn btn-primary ms-auto">
          <span id="salvarText">üíæ Salvar</span>
          <span id="salvarSpinner" class="spinner-border spinner-border-sm d-none" role="status">
            <span class="visually-hidden">Salvando...</span>
          </span>
        </button>
      </div>
      
      <!-- Barra de progresso do salvamento -->
      <div id="progressContainer" class="mt-3 d-none">
        <div class="progress" style="height: 25px;">
          <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
               role="progressbar" style="width: 0%;" 
               aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
            <span id="progressText">0%</span>
          </div>
        </div>
        <small id="progressStatus" class="text-muted d-block mt-1">Preparando dados...</small>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- SheetJS para leitura de Excel no cliente -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    // util: criar header de m√™s com bot√£o remover
    function makeMonthHeader(name){
      const th = document.createElement('th');
      th.className = 'month-th';
      const div = document.createElement('div');
      div.className = 'd-flex gap-1';
      const inp = document.createElement('input'); inp.className = 'form-control form-control-sm month-name'; inp.value = name;
      const btn = document.createElement('button'); btn.type='button'; btn.className='btn btn-sm btn-outline-danger remove-month'; btn.textContent='‚úï';
      div.appendChild(inp); div.appendChild(btn); th.appendChild(div);
      btn.onclick = function(){ removeMonthByTh(th); };
      // adicionar resizer ao th
      const res = document.createElement('span'); res.className = 'col-resizer'; th.appendChild(res);
      makeResizable(th);
      return th;
    }

    // centraliza a l√≥gica de remo√ß√£o de um m√™s a partir do elemento <th>
    function removeMonthByTh(th){
      if (!th) return;
      const thead = document.querySelector('#tabelaOrc2 thead tr');
      const currentMonths = thead.querySelectorAll('.month-th').length;
      if (currentMonths <= 1){
        // n√£o permite remover a √∫ltima coluna de m√™s
        alert('Deve permanecer pelo menos 1 m√™s.');
        return;
      }
      const ths = Array.from(thead.querySelectorAll('.month-th'));
      const idx = ths.indexOf(th);
      if (idx >= 0){
        // remover a c√©lula correspondente em cada linha
        document.querySelectorAll('#bodyOrc2 tr').forEach(tr => {
          const cells = tr.querySelectorAll('td');
          const cellIdx = 3 + idx; // 0:rubrica,1:quant,2:categoria -> meses come√ßam em 3
          if (cells[cellIdx]) cells[cellIdx].remove();
        });
        // remover total correspondente
        const foot = document.querySelectorAll('#tabelaOrc2 tfoot .col-total');
        if (foot[idx]) foot[idx].remove();
        th.remove();
        recalcTotals();
      }
    }

    // adicionar meses N de uma vez
    document.getElementById('addMonthsBtn').addEventListener('click', function(){
      const n = parseInt(document.getElementById('numCols').value,10) || 0; if (n<=0) return;
      const thead = document.querySelector('#tabelaOrc2 thead tr'); const currentMonths = thead.querySelectorAll('.month-th').length;
      // Inserir antes da coluna Total (pen√∫ltima posi√ß√£o, pois √∫ltima √© A√ß√£o)
      const totalTh = thead.querySelector('.col-total-linha');
      for (let k=0;k<n;k++){ const idx = currentMonths + k + 1; const th = makeMonthHeader('M√™s ' + idx); thead.insertBefore(th, totalTh); }
  // inserir inputs em cada linha (antes da coluna Total)
  document.querySelectorAll('#bodyOrc2 tr').forEach(tr => { 
    const totalTd = tr.querySelector('.col-total-linha');
    for (let k=0;k<n;k++){ const td = document.createElement('td'); td.className = 'month-td'; td.innerHTML = `<input type="text" class="form-control form-control-sm valor" placeholder="0,00">`; tr.insertBefore(td, totalTd); }
  });
      // adicionar tfoot colunas (antes da coluna do grandTotal)
      const tfootRow = document.querySelector('#tabelaOrc2 tfoot tr'); 
      const grandTotalTd = document.getElementById('grandTotal').parentElement;
      for (let k=0;k<n;k++){ const td = document.createElement('td'); td.className='col-total month-td'; td.textContent='0,00'; tfootRow.insertBefore(td, grandTotalTd); }
    });

    // ligar os bot√µes de remo√ß√£o j√° existentes no HTML inicial
    document.querySelectorAll('#tabelaOrc2 thead .remove-month').forEach(btn => {
      btn.addEventListener('click', function(){
        const th = btn.closest('.month-th');
        removeMonthByTh(th);
      });
    });

    // --- Redimensionamento de colunas (drag) ---
    function makeResizable(th){
      const resizer = th.querySelector('.col-resizer');
      if (!resizer) return;
      let startX, startWidth, colIndex;
      resizer.addEventListener('mousedown', initDrag);

      function initDrag(e){
        e.preventDefault();
        startX = e.clientX;
        const table = document.getElementById('tabelaOrc2');
        const ths = Array.from(table.querySelectorAll('thead tr th'));
        colIndex = ths.indexOf(th);
        startWidth = th.offsetWidth;
        document.addEventListener('mousemove', doDrag);
        document.addEventListener('mouseup', stopDrag);
      }

      function doDrag(e){
        const diff = e.clientX - startX;
        const newWidth = Math.max(40, startWidth + diff);
        // aplicar largura em px ao th e √† todas as c√©lulas correspondentes
        const table = document.getElementById('tabelaOrc2');
        const ths = Array.from(table.querySelectorAll('thead tr th'));
        if (ths[colIndex]) ths[colIndex].style.width = newWidth + 'px';
        // aplicar nas tds
        table.querySelectorAll('tbody tr').forEach(tr => {
          const cells = tr.querySelectorAll('td'); if (cells[colIndex]) cells[colIndex].style.width = newWidth + 'px';
        });
        // aplicar ao tfoot
        const footCells = table.querySelectorAll('tfoot tr td'); if (footCells[colIndex]) footCells[colIndex].style.width = newWidth + 'px';
      }

      function stopDrag(){
        document.removeEventListener('mousemove', doDrag);
        document.removeEventListener('mouseup', stopDrag);
      }
    }

    // inicializar redimension√°veis nos headers existentes
    document.querySelectorAll('#tabelaOrc2 thead tr th').forEach(th => makeResizable(th));

    // ---------- Importar Excel (cliente) ----------
    document.getElementById('importExcelBtn').addEventListener('click', function(){
      const f = document.getElementById('excelFileInput').files[0];
      if (!f){ alert('Selecione um arquivo Excel (.xlsx ou .xls)'); return; }
      const reader = new FileReader();
      reader.onload = function(e){
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, {type:'array'});
        const sheetName = wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(ws, {defval: ''});
        // json √© array de objetos com chaves baseadas no header
        importFromJson(json);
      };
      reader.readAsArrayBuffer(f);
    });

    // gerar e baixar modelo de importa√ß√£o
    document.getElementById('downloadTemplateBtn').addEventListener('click', function(){
      const headers = ['Rubrica','Quantidade','Categoria de Despesa','M√™s 1','M√™s 2','M√™s 3'];
      const ws = XLSX.utils.aoa_to_sheet([headers]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Modelo');
      XLSX.writeFile(wb, 'modelo_importacao_orcamento.xlsx');
    });

    // mapeia colunas do excel para rubrica, quantidade, categoria e meses (qualquer coluna restante √© considerado m√™s)
    function importFromJson(rows){
      if (!rows || rows.length === 0){ alert('Planilha vazia'); return; }
      // filtrar linhas vazias (todas as c√©lulas vazias) para n√£o contar linhas em branco
      const filtered = rows.filter(r => Object.values(r).some(v => String(v).trim() !== ''));
      if (filtered.length === 0){ alert('Planilha n√£o cont√©m linhas preenchidas'); return; }

      // detect keys a partir da primeira linha n√£o vazia
      const keys = Object.keys(filtered[0]);
      // heur√≠stica: procurar colunas com nomes parecidos
      let colRubrica = keys.find(k => /rubri|descr|rubrica/i.test(k)) || keys.find(k => /descricao/i.test(k)) || keys[0];
      let colQuantidade = keys.find(k => /quant/i.test(k)) || keys.find(k => /qtd|qty/i.test(k)) || null;
      let colCategoria = keys.find(k => /categoria|cat/i.test(k)) || keys.find(k => /tipo/i.test(k)) || null;
      // meses: as demais colunas que n√£o sejam rubrica/quantidade/categoria
      const monthCols = keys.filter(k => k !== colRubrica && k !== colQuantidade && k !== colCategoria);

      // ajustar n√∫mero de meses na tabela para igualar monthCols.length (adicionar/remover em bloco)
      const currentMonths = document.querySelectorAll('#tabelaOrc2 thead .month-th').length;
      const needMonths = monthCols.length;
      if (needMonths > currentMonths){
        document.getElementById('numCols').value = needMonths - currentMonths;
        document.getElementById('addMonthsBtn').click();
      } else if (needMonths < currentMonths){
        const thead = document.querySelector('#tabelaOrc2 thead tr');
        // remover do final at√© restarem needMonths
        const ths = thead.querySelectorAll('.month-th');
        for (let i = ths.length - 1; i >= needMonths; i--) {
          removeMonthByTh(ths[i]);
        }
      }

      // ajustar n√∫mero de linhas em bloco: manter exatamente filtered.length
      const tbody = document.getElementById('bodyOrc2');
      let currentRows = tbody.querySelectorAll('tr').length;
      const needRows = filtered.length;
      if (currentRows > needRows){
        // remover linhas extras do final
        for (let i = currentRows - 1; i >= needRows; i--){
          const row = tbody.children[i]; if (row) tbody.removeChild(row);
        }
      } else if (currentRows < needRows){
        // adicionar linhas necess√°rias
        for (let i = currentRows; i < needRows; i++){ document.getElementById('addLinha').click(); }
      }

      // preencher os dados nas linhas agora que o DOM est√° preparado
      const allRows = tbody.querySelectorAll('tr');
      allRows.forEach((tr, i) => {
        const data = filtered[i];
        if (!data) return;
        // preencher rubrica
        const r = data[colRubrica] || '';
        const select = tr.querySelector('select[name="rubrica"]');
        if (select){
          const opt = Array.from(select.options).find(o => (o.text || '').toLowerCase().includes(String(r).toLowerCase()));
          if (opt) select.value = opt.value; else select.value = '';
        }
        // quantidade: '-' => 0
        if (colQuantidade){
          let q = data[colQuantidade]; if (String(q).trim() === '-') q = 0; tr.querySelector('.quantidade').value = q;
        }
        // categoria
        if (colCategoria){ tr.querySelector('.categoria').value = data[colCategoria] || ''; }
        // meses - NORMALIZAR VALORES MONET√ÅRIOS
        const valorInputs = tr.querySelectorAll('input.valor');
        monthCols.forEach((mc, idx) => {
          let v = data[mc];
          if (v === undefined || v === null || String(v).trim() === '' || String(v).trim() === '-') {
            if (valorInputs[idx]) valorInputs[idx].value = '';
            return;
          }
          // Normalizar valor: aceitar 52499.56 (US) ou 52.499,56 (BR)
          let vStr = String(v).replace(/R\$\s*/g, '').trim();
          // Se tiver ponto E v√≠rgula, √© formato BR (1.234,56) -> remover pontos, trocar v√≠rgula por ponto
          if (vStr.includes('.') && vStr.includes(',')) {
            vStr = vStr.replace(/\./g, '').replace(',', '.');
          } 
          // Se tiver apenas v√≠rgula, √© decimal BR (1234,56) -> trocar v√≠rgula por ponto
          else if (vStr.includes(',')) {
            vStr = vStr.replace(',', '.');
          }
          // Converter para n√∫mero e formatar no padr√£o BR para exibi√ß√£o
          const num = parseFloat(vStr);
          if (!isNaN(num) && num !== 0) {
            // Formatar como BR: 52499.56 -> "52.499,56"
            const formatted = num.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            if (valorInputs[idx]) valorInputs[idx].value = formatted;
          } else {
            if (valorInputs[idx]) valorInputs[idx].value = num === 0 ? '0' : '';
          }
        });
      });

      recalcTotals();
      // Log para debug
      console.log('[IMPORTACAO] Linhas importadas:', filtered.length);
      console.log('[IMPORTACAO] Meses detectados:', monthCols.length);
      console.log('[IMPORTACAO] Total calculado:', document.getElementById('grandTotal').textContent);
      alert('Importa√ß√£o conclu√≠da: ' + filtered.length + ' linhas e ' + monthCols.length + ' meses detectados.');
    }

    // adicionar linha
    document.getElementById('addLinha').addEventListener('click', function(){
      const tbody = document.getElementById('bodyOrc2'); const tr = document.createElement('tr');
      // n√∫mero de meses atual
      const monthCount = document.querySelectorAll('#tabelaOrc2 thead .month-th').length;
      let cols = `
        <td>
          <select class="form-select form-select-sm" name="rubrica">
            <option value="">Selecione...</option>
            <option>Pessoal</option>
            <option>Materiais</option>
            <option>Administrativas</option>
            <option>Servi√ßos de Terceiros</option>
            <option>Outras Despesas</option>
            <option>Imobilizado</option>
            <option>Implanta√ß√£o</option>
          </select>
        </td>
        <td><input type="text" class="form-control form-control-sm quantidade" value="1"></td>
        <td><input type="text" class="form-control form-control-sm categoria" placeholder="Ex: Gerente de Servi√ßo I" list="categoriasDisponiveis"></td>`;
  for (let i=0;i<monthCount;i++) cols += `<td class="month-td"><input type="text" class="form-control form-control-sm valor" placeholder="0,00"></td>`;
      cols += `<td class="col-total-linha text-end total-linha">0,00</td>`;
      cols += `<td><button type="button" class="btn btn-danger btn-sm remover">Remover</button></td>`;
      tr.innerHTML = cols; tbody.appendChild(tr); recalcTotals();
    });

    // remover linha
    document.getElementById('bodyOrc2').addEventListener('click', function(e){ if (e.target && e.target.classList.contains('remover')){ e.target.closest('tr').remove(); recalcTotals(); }});

    // salvar: coleta a tabela, normaliza valores e envia para o backend
    document.getElementById('salvarOrc2').addEventListener('click', function(){
      // Mostrar spinner, desabilitar bot√£o e mostrar barra de progresso
      const btnSalvar = document.getElementById('salvarOrc2');
      const salvarText = document.getElementById('salvarText');
      const salvarSpinner = document.getElementById('salvarSpinner');
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const progressStatus = document.getElementById('progressStatus');
      
      salvarText.classList.add('d-none');
      salvarSpinner.classList.remove('d-none');
      btnSalvar.disabled = true;
      progressContainer.classList.remove('d-none');
      
      // Fun√ß√£o para atualizar progresso
      function updateProgress(percent, status) {
        progressBar.style.width = percent + '%';
        progressBar.setAttribute('aria-valuenow', percent);
        progressText.textContent = Math.round(percent) + '%';
        progressStatus.textContent = status;
      }
      
      updateProgress(10, 'Coletando dados da tabela...');
      
      const numeroTermo = '{{ numero_termo|e }}';
      const monthNames = Array.from(document.querySelectorAll('.month-name')).map(n => n.value || 'M√™s');
      const rows = document.querySelectorAll('#bodyOrc2 tr');
      const despesas = [];
      rows.forEach((tr) => {
        const selectRub = tr.querySelector('select[name="rubrica"]');
        const rubrica = selectRub ? selectRub.value : '';
        const qInp = tr.querySelector('.quantidade');
        const quantidade = qInp ? (qInp.value === '-' ? null : qInp.value) : null;
        const categoria = tr.querySelector('.categoria') ? tr.querySelector('.categoria').value : '';
        if (!rubrica) return;
        const valores_por_mes = {};
        tr.querySelectorAll('input.valor').forEach((inp, idx) => {
          const raw = inp.value && inp.value.trim();
          if (!raw) return;
          // normalizar: aceitar formatos 1.234,56 ou 1234.56
          const normalized = String(raw).replace(/\./g,'').replace(',', '.').replace('R$', '').trim();
          const num = parseFloat(normalized);
          if (!isNaN(num) && num !== 0) {
            // enviar como string com ponto decimal ‚Äî backend aceita com ',' e 'R$' tamb√©m
            valores_por_mes[idx+1] = num.toString();
          } else if (normalized === '-' ) {
            // ignorar
          } else if (!isNaN(num) && num === 0) {
            // include zeros explicitly
            valores_por_mes[idx+1] = '0';
          }
        });
        if (Object.keys(valores_por_mes).length > 0) despesas.push({rubrica, quantidade, categoria_despesa: categoria, valores_por_mes});
      });
      
      updateProgress(30, 'Validando dados...');
      
      if (despesas.length === 0) { 
        // Restaurar bot√£o e ocultar progresso
        salvarText.classList.remove('d-none');
        salvarSpinner.classList.add('d-none');
        btnSalvar.disabled = false;
        progressContainer.classList.add('d-none');
        alert('Preencha pelo menos uma despesa com valores'); 
        return; 
      }

      // obter aditivo selecionado
      const aditivoSelecionado = parseInt(document.getElementById('aditivoSelect').value) || 0;

      updateProgress(50, `Enviando ${despesas.length} despesas para o servidor...`);
      
      // enviar para /api/despesa
      fetch('/api/despesa', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({numero_termo: numeroTermo, despesas, month_names: monthNames, aditivo: aditivoSelecionado})
      })
      .then(r => r.json())
      .then(data => {
        updateProgress(80, 'Processando resposta do servidor...');
        
        if (data.warning){
          // Restaurar bot√£o e ocultar progresso para permitir confirma√ß√£o
          salvarText.classList.remove('d-none');
          salvarSpinner.classList.add('d-none');
          btnSalvar.disabled = false;
          progressContainer.classList.add('d-none');
          
          if (confirm(data.message + '\nDeseja prosseguir e salvar mesmo assim?')){
            // Mostrar spinner e progresso novamente
            salvarText.classList.add('d-none');
            salvarSpinner.classList.remove('d-none');
            btnSalvar.disabled = true;
            progressContainer.classList.remove('d-none');
            updateProgress(60, 'Confirmando salvamento...');
            
            // for√ßar com confirmar
            fetch('/api/despesa/confirmar',{
              method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({numero_termo: numeroTermo, despesas, month_names: monthNames, aditivo: aditivoSelecionado})
            }).then(r=>r.json()).then(d=>{
              updateProgress(100, 'Salvamento conclu√≠do!');
              setTimeout(() => {
                if (d.message) alert(d.message);
                else if (d.error) alert('Erro: ' + d.error);
                location.href = '/orcamento';
              }, 500);
            }).catch(e=>{ 
              // Restaurar bot√£o e ocultar progresso em caso de erro
              salvarText.classList.remove('d-none');
              salvarSpinner.classList.add('d-none');
              btnSalvar.disabled = false;
              progressContainer.classList.add('d-none');
              alert('Erro ao confirmar. Veja console.'); 
              console.error(e); 
            });
          }
        } else {
          updateProgress(100, 'Salvamento conclu√≠do com sucesso!');
          setTimeout(() => {
            if (data.message) alert(data.message);
            else if (data.error) alert('Erro: ' + data.error);
            location.href = '/orcamento';
          }, 500);
        }
      }).catch(e=>{ 
        // Restaurar bot√£o e ocultar progresso em caso de erro
        salvarText.classList.remove('d-none');
        salvarSpinner.classList.add('d-none');
        btnSalvar.disabled = false;
        progressContainer.classList.add('d-none');
        alert('Erro ao salvar. Veja console.'); 
        console.error(e); 
      });
    });

    // recalcular totais por coluna, total geral E total por linha
    function recalcTotals(){
      const thead = document.querySelector('#tabelaOrc2 thead tr');
      const monthCount = thead.querySelectorAll('.month-th').length;
      const totals = Array.from({length: monthCount}, ()=>0);
      document.querySelectorAll('#bodyOrc2 tr').forEach(tr => {
        const vals = Array.from(tr.querySelectorAll('input.valor')).map(i=>parseFloat(i.value.replace(/\./g,'').replace(',','.'))||0);
        // Calcular total da linha
        const totalLinha = vals.reduce((a,b)=>a+b,0);
        const totalLinhaCell = tr.querySelector('.total-linha');
        if (totalLinhaCell) {
          totalLinhaCell.textContent = totalLinha.toLocaleString('pt-BR', {minimumFractionDigits:2});
        }
        // Somar para totais por coluna
        for (let j=0;j<monthCount;j++) totals[j] += (vals[j]||0);
      });
      // preencher tfoot
      const foot = document.querySelector('#tabelaOrc2 tfoot tr');
      const colTotals = foot.querySelectorAll('.col-total');
      for (let j=0;j<colTotals.length;j++){
        colTotals[j].textContent = (totals[j]||0).toLocaleString('pt-BR', {minimumFractionDigits:2});
      }
      const grand = totals.reduce((a,b)=>a+b,0);
      document.getElementById('grandTotal').textContent = grand.toLocaleString('pt-BR', {minimumFractionDigits:2});
    }

    // escutar mudan√ßas nos inputs de valor para recalcular
    document.addEventListener('input', function(e){ if (e.target && e.target.classList && e.target.classList.contains('valor')) recalcTotals(); });

    // --- NAVEGA√á√ÉO COM ENTER ---
    document.addEventListener('keydown', function(e){
      if (e.key === 'Enter' && e.target.classList && 
          (e.target.classList.contains('valor') || 
           e.target.classList.contains('quantidade') || 
           e.target.classList.contains('categoria'))){
        e.preventDefault();
        const currentTr = e.target.closest('tr');
        const currentTd = e.target.closest('td');
        const allTds = Array.from(currentTr.querySelectorAll('td'));
        const tdIndex = allTds.indexOf(currentTd);
        
        // Pr√≥xima linha
        const nextTr = currentTr.nextElementSibling;
        if (nextTr && nextTr.tagName === 'TR'){
          const nextTds = nextTr.querySelectorAll('td');
          if (nextTds[tdIndex]){
            // Tentar encontrar input do mesmo tipo
            let nextInput = null;
            if (e.target.classList.contains('valor')) {
              nextInput = nextTds[tdIndex].querySelector('input.valor');
            } else if (e.target.classList.contains('quantidade')) {
              nextInput = nextTds[tdIndex].querySelector('input.quantidade');
            } else if (e.target.classList.contains('categoria')) {
              nextInput = nextTds[tdIndex].querySelector('input.categoria');
            }
            
            if (nextInput) {
              nextInput.focus();
              nextInput.select();
            }
          }
        }
      }
    });

    // --- BOT√ÉO OCULTAR/MOSTRAR MESES ---
    document.getElementById('toggleMonthsBtn').addEventListener('click', function(){
      const table = document.getElementById('tabelaOrc2');
      const isHidden = table.classList.contains('hide-months');
      if (isHidden){
        table.classList.remove('hide-months');
        document.getElementById('toggleMonthsText').textContent = 'üëÅÔ∏è Ocultar Meses';
      } else {
        table.classList.add('hide-months');
        document.getElementById('toggleMonthsText').textContent = 'üëÅÔ∏è Mostrar Meses';
      }
    });

    // --- BOT√ÉO LIMPAR ---
    document.getElementById('limparBtn').addEventListener('click', function(){
      const tbody = document.getElementById('bodyOrc2');
      const hasData = Array.from(tbody.querySelectorAll('input.valor')).some(inp => inp.value.trim() !== '');
      
      if (hasData) {
        if (!confirm('‚ö†Ô∏è Tem certeza que deseja limpar todos os campos do formul√°rio?\n\nIsso apenas resetar√° a interface, os dados salvos no banco de dados N√ÉO ser√£o afetados.')) {
          return;
        }
      }
      
      // Limpar todos os campos da interface
      tbody.querySelectorAll('input, select').forEach(el => {
        if (el.classList.contains('quantidade')) {
          el.value = '1';
        } else if (el.tagName === 'SELECT') {
          el.selectedIndex = 0;
        } else {
          el.value = '';
        }
      });
      
      // Recalcular totais (que ficar√£o zerados)
      recalcTotals();
      
      // Mensagem de confirma√ß√£o
      alert('‚úÖ Formul√°rio limpo com sucesso!\n\nPara ver os dados salvos novamente, recarregue a p√°gina.');
    });

    // carregar dados existentes do termo ao inicializar
    function carregarDadosExistentes(){
      const numeroTermo = '{{ numero_termo|e }}';
      const aditivoSelecionado = document.getElementById('aditivoSelect').value || '0';
      fetch(`/api/despesas/${encodeURIComponent(numeroTermo)}?aditivo=${aditivoSelecionado}`)
      .then(r => r.json())
      .then(data => {
        if (data.error) {
          console.warn('Erro ao carregar despesas:', data.error);
          return;
        }
        
        const despesas = data.despesas || [];
        if (despesas.length === 0) {
          console.log('Nenhuma despesa encontrada para este termo');
          return;
        }
        
        // Determinar quantos meses precisamos baseado nos dados
        let maxMes = 0;
        despesas.forEach(d => {
          Object.keys(d.valores_por_mes || {}).forEach(mes => {
            maxMes = Math.max(maxMes, parseInt(mes));
          });
        });
        
        // Ajustar n√∫mero de colunas de meses se necess√°rio
        const currentMonths = document.querySelectorAll('#tabelaOrc2 thead .month-th').length;
        if (maxMes > currentMonths) {
          document.getElementById('numCols').value = maxMes - currentMonths;
          document.getElementById('addMonthsBtn').click();
        }
        
        // Ajustar n√∫mero de linhas se necess√°rio
        const tbody = document.getElementById('bodyOrc2');
        const currentRows = tbody.querySelectorAll('tr').length;
        const needRows = despesas.length;
        
        if (currentRows > needRows) {
          // Remover linhas extras do final
          for (let i = currentRows - 1; i >= needRows; i--) {
            const row = tbody.children[i];
            if (row) tbody.removeChild(row);
          }
        } else if (currentRows < needRows) {
          // Adicionar linhas necess√°rias
          for (let i = currentRows; i < needRows; i++) {
            document.getElementById('addLinha').click();
          }
        }
        
        // Preencher os dados nas linhas
        const rows = tbody.querySelectorAll('tr');
        despesas.forEach((despesa, index) => {
          if (index >= rows.length) return;
          
          const tr = rows[index];
          
          // Rubrica
          const selectRub = tr.querySelector('select[name="rubrica"]');
          if (selectRub) {
            selectRub.value = despesa.rubrica || '';
          }
          
          // Quantidade
          const qInp = tr.querySelector('.quantidade');
          if (qInp) {
            qInp.value = despesa.quantidade || '1';
          }
          
          // Categoria
          const catInp = tr.querySelector('.categoria');
          if (catInp) {
            catInp.value = despesa.categoria_despesa || '';
          }
          
          // Valores por m√™s
          const valorInputs = tr.querySelectorAll('input.valor');
          valorInputs.forEach((inp, mesIndex) => {
            const mesNum = mesIndex + 1;
            const valor = despesa.valores_por_mes?.[mesNum.toString()];
            if (valor !== undefined) {
              // Formatar como moeda brasileira
              inp.value = valor.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            }
          });
        });
        
        // Recalcular totais ap√≥s carregar dados
        recalcTotals();
        console.log(`Carregadas ${despesas.length} despesas para ${numeroTermo}`);
      })
      .catch(e => {
        console.error('Erro ao carregar dados:', e);
      });
    }

    // Carregar categorias dispon√≠veis do banco de dados
    function carregarCategorias() {
      fetch('/api/categorias')
        .then(r => r.json())
        .then(data => {
          if (data.categorias) {
            const datalist = document.getElementById('categoriasDisponiveis');
            datalist.innerHTML = '';
            data.categorias.forEach(cat => {
              const option = document.createElement('option');
              option.value = cat;
              datalist.appendChild(option);
            });
          }
        })
        .catch(e => console.error('Erro ao carregar categorias:', e));
    }

    // Auto-preencher rubrica quando categoria for selecionada
    function configurarAutoPreenchemento() {
      const tbody = document.getElementById('bodyOrc2');
      
      // Usar delega√ß√£o de eventos para inputs de categoria
      tbody.addEventListener('change', function(e) {
        if (e.target.classList.contains('categoria')) {
          const categoria = e.target.value.trim();
          if (categoria) {
            // Buscar rubrica sugerida
            fetch(`/api/rubrica-sugerida/${encodeURIComponent(categoria)}`)
              .then(r => r.json())
              .then(data => {
                if (data.rubrica) {
                  // Encontrar o select de rubrica na mesma linha
                  const linha = e.target.closest('tr');
                  const selectRubrica = linha.querySelector('select[name="rubrica"]');
                  if (selectRubrica) {
                    // Verificar se a rubrica existe nas op√ß√µes
                    const opcoes = Array.from(selectRubrica.options);
                    const opcaoEncontrada = opcoes.find(opt => opt.value === data.rubrica);
                    if (opcaoEncontrada) {
                      selectRubrica.value = data.rubrica;
                    }
                  }
                }
              })
              .catch(e => console.error('Erro ao buscar rubrica sugerida:', e));
          }
        }
      });
    }

    // inicial
    recalcTotals();
    carregarCategorias();
    configurarAutoPreenchemento();
    carregarDadosExistentes();
    
    // Adicionar listener para mudan√ßa de aditivo
    document.getElementById('aditivoSelect').addEventListener('change', function() {
      // Limpar tabela antes de recarregar
      const tbody = document.getElementById('bodyOrc2');
      const rows = tbody.querySelectorAll('tr');
      rows.forEach(row => {
        // Limpar valores dos inputs
        row.querySelectorAll('input').forEach(input => input.value = '');
        row.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
      });
      // Recarregar dados do aditivo selecionado
      carregarDadosExistentes();
    });
  </script>
</body>
</html>

