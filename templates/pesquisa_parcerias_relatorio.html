<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Relatório de Pesquisas de Parcerias</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    body { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      min-height: 100vh; 
      padding: 20px; 
    }
    .main-container { 
      max-width: 98%; 
      margin: 0 auto; 
      background: white; 
      border-radius: 15px; 
      padding: 30px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
    }
    .btn-voltar {
      background-color: #6c757d;
      color: white;
      border: none;
    }
    .btn-voltar:hover {
      background-color: #5a6268;
      color: white;
    }
    .filter-section {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .table-responsive {
      border-radius: 10px;
      overflow: hidden;
    }
    .table thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .table tbody tr:hover {
      background-color: #f8f9fa;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Cabeçalho -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0">
        <i class="bi bi-file-earmark-text me-2"></i>Relatório de Pesquisas de Parcerias
      </h2>
      <a href="{{ url_for('pesquisa_parcerias.index') }}" class="btn btn-voltar">
        <i class="bi bi-arrow-left me-2"></i>Voltar
      </a>
    </div>

    <!-- Filtros -->
    <div class="filter-section">
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="filtroOsc" class="form-label">
            <i class="bi bi-funnel me-2"></i>Filtrar por Nome da OSC
          </label>
          <input 
            type="text" 
            class="form-control" 
            id="filtroOsc" 
            placeholder="Digite o nome da OSC para filtrar..."
          >
        </div>
        <div class="col-md-3">
          <label for="filtroRespondido" class="form-label">
            <i class="bi bi-check-circle me-2"></i>Respondido?
          </label>
          <select class="form-select" id="filtroRespondido">
            <option value="">Todos</option>
            <option value="true">Sim</option>
            <option value="false">Não</option>
          </select>
        </div>
        <div class="col-md-3 d-flex align-items-end gap-2">
          <button class="btn btn-warning flex-fill" onclick="limparFiltros()">
            <i class="bi bi-x-circle me-2"></i>Limpar
          </button>
          <button class="btn btn-success flex-fill" onclick="exportarCSV()">
            <i class="bi bi-download me-2"></i>CSV
          </button>
        </div>
      </div>
    </div>

    <!-- Tabela de Pesquisas -->
    <div class="table-responsive" style="max-width: 100%; overflow-x: auto;">
      <table class="table table-striped table-hover" style="min-width: 1600px; width: 100%;">
        <thead>
          <tr>
            <th style="min-width: 80px;">Número da Pesquisa</th>
            <th style="min-width: 180px;">Processo SEI da Pesquisa</th>
            <th style="min-width: 120px;">SEI Informado</th>
            <th style="min-width: 250px;">Nome da OSC</th>
            <th style="min-width: 150px;">Nome do Emissor</th>
            <th style="min-width: 120px;">OSC com parceria?</th>
            <th style="min-width: 140px;">Data da Pesquisa</th>
            <th style="min-width: 120px;">Respondido?</th>
            <th style="min-width: 250px;">Observação</th>
            <th class="text-center" style="min-width: 150px;">Ações</th>
          </tr>
        </thead>
        <tbody id="corpoPesquisas">
          <tr>
            <td colspan="10" class="text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Total de registros -->
    <div class="mt-3">
      <p class="text-muted mb-0">
        <strong>Total de pesquisas:</strong> <span id="totalPesquisas">-</span>
      </p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let pesquisas = [];

    // Carregar pesquisas ao iniciar
    document.addEventListener('DOMContentLoaded', async () => {
      await carregarPesquisas();
    });

    // Função para carregar pesquisas
    async function carregarPesquisas() {
      try {
        const response = await fetch('/pesquisa-parcerias/api/pesquisas');
        const data = await response.json();

        if (data.erro) {
          alert('Erro ao carregar pesquisas: ' + data.erro);
          return;
        }

        pesquisas = data.pesquisas;
        pesquisasFiltradas = pesquisas;  // Inicializar com todos os dados
        renderizarTabela(pesquisas);

      } catch (error) {
        console.error('Erro ao carregar pesquisas:', error);
        alert('Erro ao carregar relatório de pesquisas');
      }
    }

    // Função para renderizar tabela
    function renderizarTabela(dados) {
      const tbody = document.getElementById('corpoPesquisas');
      tbody.innerHTML = '';

      if (dados.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="text-center text-muted">
              <i class="bi bi-inbox me-2"></i>Nenhuma pesquisa registrada
            </td>
          </tr>
        `;
        document.getElementById('totalPesquisas').textContent = '0';
        return;
      }

      dados.forEach(pesquisa => {
        const tr = document.createElement('tr');
        tr.id = `pesquisa-${pesquisa.numero_pesquisa}`;
        
        // Número da Pesquisa
        const tdNumero = document.createElement('td');
        tdNumero.textContent = pesquisa.numero_pesquisa || '-';
        tr.appendChild(tdNumero);

        // Processo SEI da Pesquisa (apenas visualização)
        const tdPseiPesquisa = document.createElement('td');
        tdPseiPesquisa.textContent = pesquisa.psei_pesquisa || '-';
        tdPseiPesquisa.className = 'text-muted';
        tr.appendChild(tdPseiPesquisa);

        // SEI Informado (editável)
        const tdSei = document.createElement('td');
        tdSei.innerHTML = `
          <input 
            type="text" 
            class="form-control form-control-sm" 
            id="sei-${pesquisa.numero_pesquisa}"
            value="${pesquisa.sei_informado || ''}"
            placeholder="SEI..."
            maxlength="20"
            style="width: 110px;">
        `;
        tr.appendChild(tdSei);

        // Nome da OSC (editável)
        const tdOsc = document.createElement('td');
        tdOsc.innerHTML = `
          <input 
            type="text" 
            class="form-control form-control-sm" 
            id="osc-${pesquisa.numero_pesquisa}"
            value="${pesquisa.nome_osc || ''}"
            placeholder="Nome da OSC..."
            style="width: 240px;">
        `;
        tr.appendChild(tdOsc);

        // Nome do Emissor
        const tdEmissor = document.createElement('td');
        tdEmissor.textContent = pesquisa.nome_emissor || '-';
        tr.appendChild(tdEmissor);

        // OSC com parceria? (osc_identificada)
        const tdIdentificada = document.createElement('td');
        if (pesquisa.osc_identificada === true) {
          tdIdentificada.innerHTML = '<span class="badge bg-success">Sim</span>';
        } else if (pesquisa.osc_identificada === false) {
          tdIdentificada.innerHTML = '<span class="badge bg-danger">Não</span>';
        } else {
          tdIdentificada.textContent = '-';
        }
        tr.appendChild(tdIdentificada);

        // Data da Pesquisa
        const tdData = document.createElement('td');
        if (pesquisa.criado_em) {
          const data = new Date(pesquisa.criado_em);
          tdData.textContent = data.toLocaleString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        } else {
          tdData.textContent = '-';
        }
        tr.appendChild(tdData);

        // Respondido? (dropdown)
        const tdRespondido = document.createElement('td');
        const selectRespondido = document.createElement('select');
        selectRespondido.className = 'form-select form-select-sm';
        selectRespondido.id = `respondido-${pesquisa.numero_pesquisa}`;
        selectRespondido.style.width = '110px';
        selectRespondido.innerHTML = `
          <option value="false" ${pesquisa.respondido === false || pesquisa.respondido === null ? 'selected' : ''}>Não</option>
          <option value="true" ${pesquisa.respondido === true ? 'selected' : ''}>Sim</option>
        `;
        tdRespondido.appendChild(selectRespondido);
        tr.appendChild(tdRespondido);

        // Observação (textarea inline)
        const tdObs = document.createElement('td');
        tdObs.innerHTML = `
          <textarea 
            class="form-control form-control-sm" 
            id="obs-${pesquisa.numero_pesquisa}"
            rows="2"
            placeholder="Digite observações..."
            style="width: 240px;">${pesquisa.obs || ''}</textarea>
        `;
        tr.appendChild(tdObs);

        // Coluna de Ações
        const tdAcoes = document.createElement('td');
        tdAcoes.className = 'text-center';
        tdAcoes.style.whiteSpace = 'nowrap';
        tdAcoes.innerHTML = `
          <button 
            class="btn btn-success btn-sm me-1 mb-1" 
            onclick="salvarPesquisa(${pesquisa.numero_pesquisa})"
            title="Salvar alterações">
            <i class="bi bi-check-circle"></i> Salvar
          </button>
          <button 
            class="btn btn-danger btn-sm mb-1" 
            onclick="excluirPesquisa(${pesquisa.numero_pesquisa})"
            title="Excluir pesquisa">
            <i class="bi bi-trash"></i>
          </button>
        `;
        tr.appendChild(tdAcoes);

        tbody.appendChild(tr);
      });

      document.getElementById('totalPesquisas').textContent = dados.length;
    }

    // Variável para armazenar pesquisas filtradas
    let pesquisasFiltradas = [];

    // Função para aplicar todos os filtros
    function aplicarFiltros() {
      const filtroOsc = document.getElementById('filtroOsc').value.toLowerCase().trim();
      const filtroRespondido = document.getElementById('filtroRespondido').value;

      let filtradas = pesquisas;

      // Filtro por Nome da OSC
      if (filtroOsc) {
        filtradas = filtradas.filter(p => 
          p.nome_osc && p.nome_osc.toLowerCase().includes(filtroOsc)
        );
      }

      // Filtro por Respondido
      if (filtroRespondido !== '') {
        const valorRespondido = filtroRespondido === 'true';
        filtradas = filtradas.filter(p => p.respondido === valorRespondido);
      }

      pesquisasFiltradas = filtradas;
      renderizarTabela(filtradas);
    }

    // Filtro por nome da OSC
    document.getElementById('filtroOsc').addEventListener('input', aplicarFiltros);

    // Filtro por Respondido
    document.getElementById('filtroRespondido').addEventListener('change', aplicarFiltros);

    // Limpar filtros
    function limparFiltros() {
      document.getElementById('filtroOsc').value = '';
      document.getElementById('filtroRespondido').value = '';
      pesquisasFiltradas = pesquisas;
      renderizarTabela(pesquisas);
    }

    // Exportar CSV com filtros aplicados
    function exportarCSV() {
      const dadosExportar = pesquisasFiltradas.length > 0 ? pesquisasFiltradas : pesquisas;
      
      if (dadosExportar.length === 0) {
        alert('Não há dados para exportar!');
        return;
      }

      // Cabeçalho do CSV
      const headers = [
        'Número da Pesquisa',
        'Processo SEI da Pesquisa',
        'SEI Informado',
        'Nome da OSC',
        'CNPJ',
        'Nome do Emissor',
        'OSC com parceria?',
        'Data da Pesquisa',
        'Respondido?',
        'Observação'
      ];

      // Construir linhas do CSV
      const linhas = dadosExportar.map(p => {
        const data = p.criado_em ? new Date(p.criado_em).toLocaleString('pt-BR') : '';
        const oscIdentificada = p.osc_identificada === true ? 'Sim' : p.osc_identificada === false ? 'Não' : '';
        const respondido = p.respondido === true ? 'Sim' : p.respondido === false ? 'Não' : '';
        
        return [
          p.numero_pesquisa || '',
          p.psei_pesquisa || '',
          p.sei_informado || '',
          p.nome_osc || '',
          p.cnpj || '',
          p.nome_emissor || '',
          oscIdentificada,
          data,
          respondido,
          p.obs || ''
        ].map(campo => `"${String(campo).replace(/"/g, '""')}"`).join(';');
      });

      // Juntar cabeçalho e linhas
      const csvContent = [
        headers.map(h => `"${h}"`).join(';'),
        ...linhas
      ].join('\n');

      // Criar blob e download
      const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      const dataHoje = new Date().toISOString().split('T')[0];
      link.setAttribute('href', url);
      link.setAttribute('download', `pesquisas_parcerias_${dataHoje}.csv`);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      alert(`Exportados ${dadosExportar.length} registro(s) para CSV!`);
    }

    // Salvar alterações de uma pesquisa
    async function salvarPesquisa(numeroPesquisa) {
      const seiInformado = document.getElementById(`sei-${numeroPesquisa}`).value.trim();
      const nomeOsc = document.getElementById(`osc-${numeroPesquisa}`).value.trim();
      const respondido = document.getElementById(`respondido-${numeroPesquisa}`).value === 'true';
      const obs = document.getElementById(`obs-${numeroPesquisa}`).value.trim();

      try {
        const response = await fetch(`/pesquisa-parcerias/api/pesquisas/${numeroPesquisa}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            sei_informado: seiInformado || null,
            nome_osc: nomeOsc || null,
            respondido: respondido,
            obs: obs || null
          })
        });

        const data = await response.json();

        if (data.erro) {
          alert('Erro ao salvar: ' + data.erro);
          return;
        }

        alert('Alterações salvas com sucesso!');
        
        // Atualizar o array de pesquisas localmente
        const pesquisa = pesquisas.find(p => p.numero_pesquisa === numeroPesquisa);
        if (pesquisa) {
          pesquisa.sei_informado = seiInformado || null;
          pesquisa.nome_osc = nomeOsc || null;
          pesquisa.respondido = respondido;
          pesquisa.obs = obs || null;
        }

        // Destacar linha temporariamente
        const linha = document.getElementById(`pesquisa-${numeroPesquisa}`);
        if (linha) {
          linha.style.backgroundColor = '#d4edda';
          setTimeout(() => {
            linha.style.backgroundColor = '';
          }, 1500);
        }

      } catch (error) {
        console.error('Erro ao salvar pesquisa:', error);
        alert('Erro ao salvar alterações');
      }
    }

    // Excluir pesquisa
    async function excluirPesquisa(numeroPesquisa) {
      if (!confirm('Tem certeza que deseja excluir esta pesquisa?\n\nNúmero da Pesquisa: ' + numeroPesquisa)) {
        return;
      }

      try {
        const response = await fetch(`/pesquisa-parcerias/api/pesquisas/${numeroPesquisa}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (data.erro) {
          alert('Erro ao excluir: ' + data.erro);
          return;
        }

        alert('Pesquisa excluída com sucesso!');
        await carregarPesquisas();  // Recarregar lista

      } catch (error) {
        console.error('Erro ao excluir pesquisa:', error);
        alert('Erro ao excluir pesquisa');
      }
    }
  </script>
</body>
</html>
