<!-- templates/parcerias_form.html -->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Formulário de Parceria - Módulo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    body { background-color: #f8f9fa; padding: 20px; }
    .header-section { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
    .form-container { background: #fff; padding: 30px; border-radius: 8px; }
    .form-label { font-weight: 600; }
    .section-title { 
      background-color: #e9ecef; 
      padding: 10px 15px; 
      margin: 20px -30px 20px -30px; 
      font-weight: bold; 
      color: #495057;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Cabeçalho -->
    <div class="header-section">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2>
            {{ 'Nova Parceria' if not parceria else 'Formulário Completo da Parceria' }}
            {% if parceria and parceria.numero_termo and not parceria.get('osc') %}
              <span class="badge bg-info ms-2">
                <i class="bi bi-download"></i> Importação
              </span>
            {% endif %}
          </h2>
          {% if parceria %}
            <p class="text-muted mb-0">Termo: <strong>{{ parceria.numero_termo }}</strong></p>
          {% endif %}
        </div>
        <div>
          <a href="{{ url_for('parcerias.listar') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar
          </a>
        </div>
      </div>
    </div>

    <!-- Formulário -->
    <div class="form-container">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for cat, msg in messages %}
            <div class="alert alert-{{cat}} alert-dismissible fade show" role="alert">
              {{ msg }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- Script para limpar localStorage quando houver sucesso -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for cat, msg in messages %}
            {% if cat == 'success' %}
              <script>
                // Limpar TODOS os autosaves de parcerias ao ter sucesso
                Object.keys(localStorage).forEach(key => {
                  if (key.startsWith('parceriaForm_')) {
                    localStorage.removeItem(key);
                  }
                });
              </script>
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- Alerta de importação -->
      {% if parceria and parceria.numero_termo and not parceria.get('osc') %}
      <div class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="bi bi-info-circle-fill"></i> 
        <strong>Importação:</strong> O número do termo <strong>{{ parceria.numero_termo }}</strong> foi pré-preenchido. Complete os demais dados para cadastrar a parceria.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
      {% endif %}

      <form method="post" action="{{ url_for('parcerias.nova') if modo_importacao or not parceria else url_for('parcerias.editar', numero_termo=parceria.numero_termo) }}">
        
        <!-- Seção: Identificação -->
        <div class="section-title">IDENTIFICAÇÃO DO TERMO</div>
        
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="numero_termo" class="form-label">Número do Termo</label>
            <input type="text" class="form-control" id="numero_termo" name="numero_termo" 
                   value="{{ parceria.numero_termo if parceria else '' }}" 
                   {{ 'readonly' if (parceria and parceria.get('osc')) else 'required' }}>
          </div>
          <div class="col-md-6">
            <label for="tipo_termo" class="form-label">Tipo de Termo</label>
            <select class="form-select" id="tipo_termo" name="tipo_termo">
              <option value="">-- Selecione --</option>
              {% for tipo in tipos_contrato %}
                <option value="{{ tipo }}" {% if parceria and parceria.get('tipo_termo') == tipo %}selected{% endif %}>{{ tipo }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Seção: Organização e Projeto -->
        <div class="section-title">ORGANIZAÇÃO E PROJETO</div>

        <div class="row mb-3">
          <div class="col-md-8">
            <label for="osc" class="form-label">OSC (Organização da Sociedade Civil)</label>
            <input type="text" class="form-control" id="osc" name="osc" 
                   value="{{ parceria.osc or '' }}" 
                   list="osc-list"
                   autocomplete="off">
            <datalist id="osc-list">
              <!-- Opções carregadas via JavaScript -->
            </datalist>
          </div>
          <div class="col-md-4">
            <label for="cnpj" class="form-label">CNPJ da OSC</label>
            <input type="text" class="form-control" id="cnpj" name="cnpj" 
                   value="{{ parceria.cnpj or '' }}"
                   placeholder="Preenchido automaticamente">
          </div>
        </div>

        <div class="mb-3">
          <label for="projeto" class="form-label">Projeto</label>
          <input type="text" class="form-control" id="projeto" name="projeto" 
                 value="{{ parceria.projeto or '' }}">
        </div>

        <div class="mb-3">
          <label for="endereco" class="form-label">Endereço do Projeto</label>
          <textarea class="form-control" id="endereco" name="endereco" rows="2">{{ parceria.endereco or '' }}</textarea>
        </div>

        <!-- Seção: Período e Valores -->
        <div class="section-title">PERÍODO E VALORES</div>

        <div class="row mb-3">
          <div class="col-md-4">
            <label for="inicio" class="form-label">Data de Início</label>
            <input type="date" class="form-control" id="inicio" name="inicio" 
                   value="{{ parceria.get('inicio', '') if parceria else '' }}">
          </div>
          <div class="col-md-4">
            <label for="final" class="form-label">Data de Término</label>
            <input type="date" class="form-control" id="final" name="final" 
                   value="{{ parceria.get('final', '') if parceria else '' }}">
          </div>
          <div class="col-md-4">
            <label for="meses" class="form-label">Meses do Projeto</label>
            <input type="number" class="form-control" id="meses" name="meses" 
                   value="{{ parceria.get('meses', '') if parceria else '' }}"
                   readonly style="background-color: #e9ecef;">
            <small class="text-muted">Calculado automaticamente</small>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label for="total_previsto" class="form-label">Total Valor Previsto (R$)</label>
            <input type="text" class="form-control valor-monetario" id="total_previsto" name="total_previsto" 
                   value="{{ '{:,.2f}'.format(parceria.get('total_previsto', 0)).replace(',', 'X').replace('.', ',').replace('X', '.') if parceria and parceria.get('total_previsto') else '' }}"
                   placeholder="0,00">
            <input type="hidden" id="total_previsto_hidden" name="total_previsto_hidden">
          </div>
          <div class="col-md-6">
            <label for="total_pago" class="form-label">Total Valor Pago (R$)</label>
            <input type="text" class="form-control valor-monetario" id="total_pago" name="total_pago" 
                   value="{{ '{:,.2f}'.format(parceria.get('total_pago', 0)).replace(',', 'X').replace('.', ',').replace('X', '.') if parceria and parceria.get('total_pago') else '0,00' }}"
                   placeholder="0,00">
            <input type="hidden" id="total_pago_hidden" name="total_pago_hidden" value="0">
          </div>
        </div>

        <!-- Seção: Dados Bancários e Características -->
        <div class="section-title">DADOS BANCÁRIOS E CARACTERÍSTICAS</div>

        <div class="mb-3">
          <label for="conta" class="form-label">Conta Específica do Projeto</label>
          <input type="text" class="form-control" id="conta" name="conta" 
                 value="{{ parceria.conta or '' }}">
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="transicao" name="transicao" 
                     {% if parceria and parceria.get('transicao') %}checked{% endif %}>
              <label class="form-check-label" for="transicao">
                É transição de Portaria?
              </label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="contrapartida" name="contrapartida" 
                     {% if parceria and parceria.get('contrapartida') %}checked{% endif %}>
              <label class="form-check-label" for="contrapartida">
                Tem contrapartida?
              </label>
            </div>
          </div>
        </div>

        <!-- Seção: Processos SEI -->
        <div class="section-title">PROCESSOS SEI</div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label for="sei_celeb" class="form-label">SEI de Celebração</label>
            <input type="text" class="form-control" id="sei_celeb" name="sei_celeb" 
                   value="{{ parceria.sei_celeb or '' }}">
          </div>
          <div class="col-md-6">
            <label for="sei_pc" class="form-label">SEI de Pagamento e Prestação de Contas</label>
            <input type="text" class="form-control" id="sei_pc" name="sei_pc" 
                   value="{{ parceria.sei_pc or '' }}">
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label for="sei_plano" class="form-label">SEI do Plano de Trabalho</label>
            <input type="text" class="form-control" id="sei_plano" name="sei_plano" 
                   value="{{ parceria.sei_plano or '' }}">
          </div>
          <div class="col-md-6">
            <label for="sei_orcamento" class="form-label">SEI do Orçamento Anual</label>
            <input type="text" class="form-control" id="sei_orcamento" name="sei_orcamento" 
                   value="{{ parceria.sei_orcamento or '' }}">
          </div>
        </div>

        <!-- Seção: Leis Aplicáveis -->
        <div class="section-title">LEIS APLICÁVEIS</div>

        <div class="row mb-3">
          <div class="col-md-12">
            <label for="portaria" class="form-label">
              Portaria/Legislação
              <small class="text-muted">(preenchimento automático baseado no tipo de termo e data de início)</small>
            </label>
            <select class="form-select" id="portaria" name="portaria">
              <option value="">-- Selecione --</option>
              {% for leg in legislacoes %}
                <option value="{{ leg }}" {% if parceria and parceria.get('portaria') == leg %}selected{% endif %}>{{ leg }}</option>
              {% endfor %}
            </select>
            <div class="form-text">
              <i class="bi bi-info-circle"></i> 
              A portaria é selecionada automaticamente ao informar o número do termo e a data de início.
            </div>
          </div>
        </div>

        <!-- Seção: Pessoa Gestora -->
        <div class="section-title">PESSOA GESTORA</div>
        
        <div class="row mb-3">
          <div class="col-md-8">
            <label for="pessoa_gestora" class="form-label">Pessoa Gestora</label>
            <select class="form-select" id="pessoa_gestora" name="pessoa_gestora">
              <option value="">-- Selecione --</option>
              {% for pg in pessoas_gestoras %}
                <option value="{{ pg.nome_pg }}" data-rf="{{ pg.numero_rf or '' }}" 
                        data-status="{{ pg.status_pg }}"
                        style="{% if pg.status_pg != 'Ativo' %}background-color: #fff3cd; font-style: italic;{% endif %}"
                        {% if parceria and parceria.pessoa_gestora == pg.nome_pg %}selected{% endif %}>
                  {{ pg.nome_pg }}{% if pg.status_pg != 'Ativo' %} (Inativo){% endif %}
                </option>
              {% endfor %}
            </select>
            <div class="form-text">
              <i class="bi bi-info-circle"></i> 
              Selecione a pessoa gestora responsável por esta parceria.
              <span class="text-warning"><i class="bi bi-exclamation-triangle"></i> Pessoas gestoras inativas estão destacadas em amarelo.</span>
            </div>
          </div>
          <div class="col-md-4">
            <label for="rf_pessoa_gestora" class="form-label">R.F. da Pessoa Gestora</label>
            <input type="text" class="form-control" id="rf_pessoa_gestora" name="rf_pessoa_gestora" 
                   value="{{ rf_pessoa_gestora if rf_pessoa_gestora else '' }}" readonly disabled>
            <div class="form-text">
              <i class="bi bi-lock"></i> Preenchido automaticamente
            </div>
          </div>
        </div>

        <!-- Checkbox de Solicitação de Alteração (aparece apenas se pessoa gestora estiver inativa) -->
        <div class="row mb-3" id="solicitacao_alteracao_container" style="display: none;">
          <div class="col-md-12">
            <div class="alert alert-warning">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="solicitacao_alteracao" name="solicitacao_alteracao" 
                       {% if parceria and parceria.solicitacao %}checked{% endif %}>
                <label class="form-check-label" for="solicitacao_alteracao">
                  <strong><i class="bi bi-exclamation-circle"></i> Foi solicitada alteração da pessoa gestora inativa?</strong>
                </label>
                <div class="form-text mt-2">
                  Marque esta opção se já foi solicitada a substituição desta pessoa gestora inativa.
                  Esta informação será registrada no histórico da parceria.
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Botões de Ação -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
          <button type="button" class="btn btn-danger" onclick="exportarPDF()">
            <i class="bi bi-file-pdf"></i> Exportar PDF
          </button>
          <a href="{{ url_for('parcerias.listar') }}" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i> Cancelar
          </a>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle"></i> Salvar Alterações
          </button>
        </div>

      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // ========== VARIÁVEIS GLOBAIS ==========
    const formId = 'parceriaForm_' + (document.getElementById('numero_termo').value || 'nova');
    let autosaveTimeout;
    let lastSaved = Date.now();
    let oscData = {}; // Mapeamento OSC -> CNPJ
    let siglaMapping = {}; // Mapeamento sigla -> tipo de termo

    // ========== 1. CARREGAR DADOS DAS APIs ==========
    async function carregarDados() {
      try {
        // Carregar OSCs
        const oscResponse = await fetch('/parcerias/api/oscs');
        oscData = await oscResponse.json();
        
        // Preencher datalist
        const datalist = document.getElementById('osc-list');
        Object.keys(oscData).forEach(osc => {
          const option = document.createElement('option');
          option.value = osc;
          datalist.appendChild(option);
        });

        // Carregar mapeamento de siglas
        const siglaResponse = await fetch('/parcerias/api/sigla-tipo-termo');
        siglaMapping = await siglaResponse.json();
        
        // Executar automações se houver dados pré-preenchidos (importação)
        executarAutomacoesIniciais();
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
      }
    }

    // ========== 1.1. EXECUTAR AUTOMAÇÕES INICIAIS (IMPORTAÇÃO) ==========
    function executarAutomacoesIniciais() {
      // Detectar tipo de termo se número do termo estiver preenchido
      const numeroTermoInput = document.getElementById('numero_termo');
      if (numeroTermoInput.value && !document.getElementById('tipo_termo').value) {
        detectarTipoTermo();
      }
      
      // Preencher CNPJ se OSC estiver preenchida
      const oscInput = document.getElementById('osc');
      if (oscInput.value && !document.getElementById('cnpj').value) {
        preencherCNPJ();
      }
      
      // Calcular meses se datas de início e fim estiverem preenchidas
      const inicioInput = document.getElementById('inicio');
      const finalInput = document.getElementById('final');
      if (inicioInput.value && finalInput.value) {
        calcularMeses();
      }
      
      // Detectar portaria/legislação automaticamente
      if (inicioInput.value && numeroTermoInput.value && !document.getElementById('portaria').value) {
        detectarPortaria();
      }
    }

    // ========== 2. RECONHECIMENTO AUTOMÁTICO DE TIPO DE TERMO ==========
    function detectarTipoTermo() {
      const numeroTermoInput = document.getElementById('numero_termo');
      const numeroTermo = numeroTermoInput.value.trim().toUpperCase();
      
      if (numeroTermo.length >= 3) {
        const sigla = numeroTermo.substring(0, 3);
        
        if (siglaMapping[sigla]) {
          const tipoSelect = document.getElementById('tipo_termo');
          const opcoes = Array.from(tipoSelect.options);
          
          // Encontrar e selecionar a opção correspondente
          const opcaoCorreta = opcoes.find(opt => opt.value === siglaMapping[sigla]);
          if (opcaoCorreta) {
            tipoSelect.value = opcaoCorreta.value;
            
            // Feedback visual
            tipoSelect.style.borderColor = '#28a745';
            setTimeout(() => {
              tipoSelect.style.borderColor = '';
            }, 1000);
          }
        }
      }
    }

    document.getElementById('numero_termo').addEventListener('input', detectarTipoTermo);

    // ========== 3. PREENCHIMENTO AUTOMÁTICO DE CNPJ ==========
    function preencherCNPJ() {
      const oscInput = document.getElementById('osc');
      const oscSelecionada = oscInput.value;
      
      if (oscData[oscSelecionada]) {
        const cnpjField = document.getElementById('cnpj');
        cnpjField.value = oscData[oscSelecionada];
        
        // Feedback visual
        cnpjField.style.borderColor = '#28a745';
        setTimeout(() => {
          cnpjField.style.borderColor = '';
        }, 1000);
      }
    }

    document.getElementById('osc').addEventListener('change', preencherCNPJ);

    // ========== 3.1. PREENCHIMENTO AUTOMÁTICO DE R.F. DA PESSOA GESTORA ==========
    document.getElementById('pessoa_gestora').addEventListener('change', function(e) {
      const selectPG = e.target;
      const selectedOption = selectPG.options[selectPG.selectedIndex];
      const rf = selectedOption.getAttribute('data-rf') || '';
      const status = selectedOption.getAttribute('data-status') || 'Ativo';
      
      const rfField = document.getElementById('rf_pessoa_gestora');
      rfField.value = rf;
      
      // Mostrar/ocultar checkbox de solicitação se pessoa gestora for inativa
      const solicitacaoContainer = document.getElementById('solicitacao_alteracao_container');
      if (status !== 'Ativo' && selectPG.value !== '') {
        solicitacaoContainer.style.display = 'block';
      } else {
        solicitacaoContainer.style.display = 'none';
        document.getElementById('solicitacao_alteracao').checked = false;
      }
      
      // Feedback visual
      if (rf) {
        rfField.style.borderColor = '#28a745';
        setTimeout(() => {
          rfField.style.borderColor = '';
        }, 1000);
      }
    });
    
    // Verificar status inicial ao carregar a página
    window.addEventListener('DOMContentLoaded', function() {
      const selectPG = document.getElementById('pessoa_gestora');
      const selectedOption = selectPG.options[selectPG.selectedIndex];
      const status = selectedOption.getAttribute('data-status') || 'Ativo';
      const solicitacaoContainer = document.getElementById('solicitacao_alteracao_container');
      
      if (status !== 'Ativo' && selectPG.value !== '') {
        solicitacaoContainer.style.display = 'block';
      }
    });

    // ========== 4. CÁLCULO AUTOMÁTICO DE MESES ==========
    function calcularMeses() {
      const inicioInput = document.getElementById('inicio');
      const finalInput = document.getElementById('final');
      const mesesInput = document.getElementById('meses');
      
      if (inicioInput.value && finalInput.value) {
        const dataInicio = new Date(inicioInput.value + 'T00:00:00');
        const dataFinal = new Date(finalInput.value + 'T00:00:00');
        
        if (dataFinal >= dataInicio) {
          // Calcular diferença em meses
          let meses = (dataFinal.getFullYear() - dataInicio.getFullYear()) * 12;
          meses += dataFinal.getMonth() - dataInicio.getMonth();
          
          // Se o dia final é maior ou igual ao dia inicial, conta o mês completo
          if (dataFinal.getDate() >= dataInicio.getDate()) {
            meses += 1;
          }
          
          mesesInput.value = meses;
          
          // Feedback visual
          mesesInput.style.borderColor = '#28a745';
          setTimeout(() => {
            mesesInput.style.borderColor = '';
          }, 1000);
        } else {
          // Apenas limpa o campo, sem alertar
          mesesInput.value = '';
        }
      }
    }

    document.getElementById('inicio').addEventListener('change', calcularMeses);
    document.getElementById('final').addEventListener('change', calcularMeses);

    // ========== 4.5. SELEÇÃO AUTOMÁTICA DE PORTARIA ==========
    async function detectarPortaria() {
      const inicioInput = document.getElementById('inicio');
      const numeroTermoInput = document.getElementById('numero_termo');
      const portariaSelect = document.getElementById('portaria');
      const transicaoCheckbox = document.getElementById('transicao');
      const finalInput = document.getElementById('final');
      
      const dataInicio = inicioInput.value;
      const numeroTermo = numeroTermoInput.value;
      const dataFinal = finalInput.value;
      
      if (!dataInicio || !numeroTermo) {
        return; // Precisa dos dois dados
      }
      
      try {
        // Buscar portaria automaticamente
        const response = await fetch('/api/portaria-automatica', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            data_inicio: dataInicio,
            numero_termo: numeroTermo
          })
        });
        
        const data = await response.json();
        
        if (data.portaria) {
          // Selecionar a portaria no dropdown
          const opcoes = Array.from(portariaSelect.options);
          const opcaoCorreta = opcoes.find(opt => opt.value === data.portaria);
          
          if (opcaoCorreta) {
            portariaSelect.value = opcaoCorreta.value;
            
            // Feedback visual
            portariaSelect.style.borderColor = '#28a745';
            setTimeout(() => {
              portariaSelect.style.borderColor = '';
            }, 2000);
          }
        }
        
        // Verificar transição se tiver data final
        if (dataFinal && dataInicio) {
          verificarTransicao(dataInicio, dataFinal, numeroTermo);
        }
        
      } catch (error) {
        console.error('Erro ao detectar portaria:', error);
      }
    }
    
    async function verificarTransicao(dataInicio, dataFinal, numeroTermo) {
      const transicaoCheckbox = document.getElementById('transicao');
      
      // Regras de transição:
      // Portaria nº 140/SMDHC/2019 (até 31/12/2023) para Portaria nº 90/SMDHC/2023 (a partir de 01/01/2024)
      // Portaria nº 121/SMDHC/2019 (até 31/12/2023) para Portaria nº 21/SMDHC/2023 (a partir de 01/03/2023)
      
      const inicio = new Date(dataInicio);
      const final = new Date(dataFinal);
      
      const transicao140para090_inicio = new Date('2017-10-01');
      const transicao140para090_fim = new Date('2023-12-31');
      const transicao140para090_nova = new Date('2024-01-01');
      
      const transicao121para021_inicio = new Date('2017-10-01');
      const transicao121para021_fim = new Date('2023-12-31');
      const transicao121para021_nova = new Date('2023-03-01');
      
      let ehTransicao = false;
      
      // Verifica se atravessa a mudança 140 -> 090
      if (inicio >= transicao140para090_inicio && inicio <= transicao140para090_fim && 
          final >= transicao140para090_nova) {
        const numeroTermoUpper = numeroTermo.toUpperCase();
        if (numeroTermoUpper.includes('FUMCAD') || numeroTermoUpper.includes('FMID')) {
          ehTransicao = true;
        }
      }
      
      // Verifica se atravessa a mudança 121 -> 021
      if (inicio >= transicao121para021_inicio && inicio <= transicao121para021_fim && 
          final >= transicao121para021_nova) {
        const numeroTermoUpper = numeroTermo.toUpperCase();
        if (!numeroTermoUpper.includes('FUMCAD') && !numeroTermoUpper.includes('FMID')) {
          ehTransicao = true;
        }
      }
      
      if (ehTransicao) {
        transicaoCheckbox.checked = true;
        // Feedback visual
        const transicaoLabel = document.querySelector('label[for="transicao"]');
        transicaoLabel.style.color = '#ffc107';
        transicaoLabel.innerHTML = '<i class="bi bi-exclamation-triangle"></i> É transição de Portaria?';
        setTimeout(() => {
          transicaoLabel.style.color = '';
          transicaoLabel.textContent = 'É transição de Portaria?';
        }, 5000);
      }
    }
    
    // Chamar detecção ao alterar campos relevantes
    document.getElementById('inicio').addEventListener('change', detectarPortaria);
    document.getElementById('numero_termo').addEventListener('blur', detectarPortaria);
    document.getElementById('final').addEventListener('change', function() {
      const dataInicio = document.getElementById('inicio').value;
      const numeroTermo = document.getElementById('numero_termo').value;
      if (dataInicio && numeroTermo && this.value) {
        verificarTransicao(dataInicio, this.value, numeroTermo);
      }
    });

    // ========== 5. AUTOSAVE (código anterior mantido) ==========
    window.addEventListener('DOMContentLoaded', function() {
      // Carregar dados das APIs primeiro
      carregarDados();
      
      const savedData = localStorage.getItem(formId);
      if (savedData) {
        const data = JSON.parse(savedData);
        const confirmRestore = confirm('Dados não salvos foram encontrados. Deseja restaurá-los?');
        
        if (confirmRestore) {
          // Restaurar todos os campos
          Object.keys(data).forEach(key => {
            const field = document.getElementById(key);
            if (field) {
              if (field.type === 'checkbox') {
                field.checked = data[key];
              } else {
                field.value = data[key];
              }
            }
          });
          
          // Mostrar mensagem
          const alertDiv = document.createElement('div');
          alertDiv.className = 'alert alert-info alert-dismissible fade show';
          alertDiv.innerHTML = `
            <i class="bi bi-info-circle"></i> Dados restaurados do autosave (${new Date(data._timestamp).toLocaleString()})
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
          document.querySelector('.form-container').insertBefore(alertDiv, document.querySelector('form'));
        } else {
          localStorage.removeItem(formId);
        }
      }
    });

    // Salvar dados automaticamente
    function autosaveForm() {
      const formData = {};
      const form = document.querySelector('form');
      const inputs = form.querySelectorAll('input, select, textarea');
      
      inputs.forEach(input => {
        if (input.id && !input.disabled) {
          if (input.type === 'checkbox') {
            formData[input.id] = input.checked;
          } else {
            formData[input.id] = input.value;
          }
        }
      });
      
      formData._timestamp = Date.now();
      localStorage.setItem(formId, JSON.stringify(formData));
      lastSaved = Date.now();
      
      // Mostrar indicador de salvamento
      showSaveIndicator();
    }

    // Indicador visual de autosave
    function showSaveIndicator() {
      let indicator = document.getElementById('saveIndicator');
      if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'saveIndicator';
        indicator.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #28a745; color: white; padding: 10px 20px; border-radius: 5px; z-index: 9999; display: none;';
        indicator.innerHTML = '<i class="bi bi-check-circle"></i> Salvo automaticamente';
        document.body.appendChild(indicator);
      }
      
      indicator.style.display = 'block';
      setTimeout(() => {
        indicator.style.display = 'none';
      }, 2000);
    }

    // Observar mudanças no formulário
    document.querySelectorAll('input, select, textarea').forEach(element => {
      element.addEventListener('input', function() {
        // Cancelar timeout anterior
        clearTimeout(autosaveTimeout);
        
        // Criar novo timeout de 60 segundos
        autosaveTimeout = setTimeout(autosaveForm, 60000);
      });
      
      // Salvar imediatamente ao sair do campo (blur)
      element.addEventListener('blur', function() {
        if (Date.now() - lastSaved > 5000) { // Só salvar se passou mais de 5 segundos
          autosaveForm();
        }
      });
    });

    // Limpar autosave ao submeter o formulário
    document.querySelector('form').addEventListener('submit', function(e) {
      // DEBUG: Verificar checkbox de solicitação
      const checkboxSolicitacao = document.getElementById('solicitacao_alteracao');
      console.log('[DEBUG FORM] Checkbox solicitacao_alteracao existe:', !!checkboxSolicitacao);
      if (checkboxSolicitacao) {
        console.log('[DEBUG FORM] Checkbox está marcado:', checkboxSolicitacao.checked);
        console.log('[DEBUG FORM] Checkbox está visível:', checkboxSolicitacao.offsetParent !== null);
        console.log('[DEBUG FORM] Container visível:', document.getElementById('solicitacao_alteracao_container').style.display);
      }
      
      // Validar datas antes de submeter
      const inicioInput = document.getElementById('inicio');
      const finalInput = document.getElementById('final');
      
      if (inicioInput.value && finalInput.value) {
        const dataInicio = new Date(inicioInput.value + 'T00:00:00');
        const dataFinal = new Date(finalInput.value + 'T00:00:00');
        
        if (dataFinal < dataInicio) {
          e.preventDefault();
          alert('❌ Erro: A data de término não pode ser anterior à data de início!');
          finalInput.focus();
          return false;
        }
      }
      
      // Converter valores monetários formatados para números antes de enviar
      document.querySelectorAll('.valor-monetario').forEach(input => {
        const hiddenInput = document.getElementById(input.id + '_hidden');
        if (hiddenInput) {
          const valorNumerico = converterParaNumero(input.value);
          hiddenInput.value = valorNumerico;
        }
      });
      
      localStorage.removeItem(formId);
    });

    // ========== 6. FORMATAÇÃO MONETÁRIA ==========
    function formatarMoeda(valor) {
      // Remove tudo que não é número
      valor = valor.replace(/\D/g, '');
      
      // Converte para centavos
      valor = (parseInt(valor) / 100).toFixed(2);
      
      // Formata com separadores brasileiros
      valor = valor.replace('.', ',');
      valor = valor.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      
      return valor;
    }

    function converterParaNumero(valorFormatado) {
      if (!valorFormatado) return '0';
      // Remove pontos de milhar e substitui vírgula por ponto
      return valorFormatado.replace(/\./g, '').replace(',', '.');
    }

    // Aplicar formatação monetária aos campos
    document.querySelectorAll('.valor-monetario').forEach(input => {
      // Formatação ao digitar
      input.addEventListener('input', function(e) {
        let valor = e.target.value;
        e.target.value = formatarMoeda(valor);
        
        // Atualizar campo hidden
        const hiddenInput = document.getElementById(e.target.id + '_hidden');
        if (hiddenInput) {
          hiddenInput.value = converterParaNumero(e.target.value);
        }
      });
      
      // Formatação ao sair do campo
      input.addEventListener('blur', function(e) {
        if (!e.target.value || e.target.value === '') {
          if (e.target.id === 'total_pago') {
            e.target.value = '0,00';
            const hiddenInput = document.getElementById(e.target.id + '_hidden');
            if (hiddenInput) {
              hiddenInput.value = '0';
            }
          }
        }
      });
      
      // Inicializar campo hidden com valor inicial
      const hiddenInput = document.getElementById(input.id + '_hidden');
      if (hiddenInput) {
        hiddenInput.value = converterParaNumero(input.value) || '0';
      }
    });

    // Salvar periodicamente a cada 2 minutos
    setInterval(function() {
      const form = document.querySelector('form');
      const inputs = form.querySelectorAll('input, select, textarea');
      let hasContent = false;
      
      inputs.forEach(input => {
        if (input.value && !input.disabled) {
          hasContent = true;
        }
      });
      
      if (hasContent) {
        autosaveForm();
      }
    }, 120000); // 2 minutos

    // Exportar para PDF
    function exportarPDF() {
      const numeroTermo = '{{ parceria.numero_termo if parceria else "" }}';
      
      if (!numeroTermo) {
        alert('Salve a parceria primeiro antes de exportar para PDF.');
        return;
      }
      
      // Mostrar indicador de carregamento
      const btnExportar = event.target.closest('button');
      const textoOriginal = btnExportar.innerHTML;
      btnExportar.disabled = true;
      btnExportar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Gerando PDF...';
      
      // Fazer requisição para a API de exportação usando query string
      window.location.href = `/parcerias/exportar-pdf?numero_termo=${encodeURIComponent(numeroTermo)}`;
      
      // Restaurar botão após um tempo
      setTimeout(() => {
        btnExportar.disabled = false;
        btnExportar.innerHTML = textoOriginal;
      }, 2000);
    }
  </script>
</body>
</html>
