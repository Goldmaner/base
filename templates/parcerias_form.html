<!-- templates/parcerias_form.html -->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Formulário de Parceria - Módulo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f8f9fa; padding: 20px; }
    .header-section { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
    .form-container { background: #fff; padding: 30px; border-radius: 8px; }
    .form-label { font-weight: 600; }
    .section-title { 
      background-color: #e9ecef; 
      padding: 10px 15px; 
      margin: 20px -30px 20px -30px; 
      font-weight: bold; 
      color: #495057;
    }
    
    /* Estilo personalizado para Select2 combinar com Bootstrap 5 */
    .select2-container--bootstrap-5 .select2-selection {
      min-height: 38px !important;
    }
    
    .select2-container {
      width: 100% !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Cabeçalho -->
    <div class="header-section">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2>
            {{ 'Nova Parceria' if not parceria else 'Formulário Completo da Parceria' }}
            {% if parceria and parceria.numero_termo and not parceria.get('osc') %}
              <span class="badge bg-info ms-2">
                <i class="bi bi-download"></i> Importação
              </span>
            {% endif %}
          </h2>
          {% if parceria %}
            <p class="text-muted mb-0">Termo: <strong>{{ parceria.numero_termo }}</strong></p>
          {% endif %}
        </div>
        <div>
          {% if request.args.get('origem') == 'conferencia' %}
          <a href="{{ url_for('parcerias.conferencia') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar para Conferência
          </a>
          {% else %}
          <a href="{{ url_for('parcerias.listar') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar
          </a>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Formulário -->
    <div class="form-container">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for cat, msg in messages %}
            {% if cat != 'success' %}
            <div class="alert alert-{{cat}} alert-dismissible fade show" role="alert">
              {{ msg }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- Script para limpar localStorage quando houver sucesso -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for cat, msg in messages %}
            {% if cat == 'success' %}
              <script>
                // Limpar TODOS os autosaves de parcerias ao ter sucesso
                Object.keys(localStorage).forEach(key => {
                  if (key.startsWith('parceriaForm_')) {
                    localStorage.removeItem(key);
                  }
                });
              </script>
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- Alerta de importação -->
      {% if parceria and parceria.numero_termo and not parceria.get('osc') %}
      <div class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="bi bi-info-circle-fill"></i> 
        <strong>Importação:</strong> O número do termo <strong>{{ parceria.numero_termo }}</strong> foi pré-preenchido. Complete os demais dados para cadastrar a parceria.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
      {% endif %}

      <form method="post" action="{{ url_for('parcerias.nova') if modo_importacao or not parceria else url_for('parcerias.editar', numero_termo=parceria.numero_termo) }}">
        
        <!-- Campo hidden para preservar origem da conferência -->
        {% if request.args.get('origem') == 'conferencia' %}
        <input type="hidden" name="origem_conferencia" value="conferencia">
        {% endif %}
        
        <!-- Seção: Identificação -->
        <div class="section-title">IDENTIFICAÇÃO DO TERMO</div>
        
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="numero_termo" class="form-label">Número do Termo</label>
            <input type="text" class="form-control" id="numero_termo" name="numero_termo" 
                   value="{{ parceria.numero_termo if parceria else '' }}" 
                   {{ 'readonly' if (parceria and parceria.get('osc')) else 'required' }}>
          </div>
          <div class="col-md-6">
            <label for="tipo_termo" class="form-label">Tipo de Termo</label>
            <select class="form-select" id="tipo_termo" name="tipo_termo">
              <option value="">-- Selecione --</option>
              {% for tipo in tipos_contrato %}
                <option value="{{ tipo }}" {% if parceria and parceria.get('tipo_termo') == tipo %}selected{% endif %}>{{ tipo }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Seção: Organização e Projeto -->
        <div class="section-title">ORGANIZAÇÃO E PROJETO</div>

        <div class="row mb-3">
          <div class="col-md-8">
            <label for="osc" class="form-label">OSC (Organização da Sociedade Civil)</label>
            <input type="text" class="form-control" id="osc" name="osc" 
                   value="{{ parceria.osc or '' }}" 
                   list="osc-list"
                   autocomplete="off">
            <datalist id="osc-list">
              <!-- Opções carregadas via JavaScript -->
            </datalist>
          </div>
          <div class="col-md-4">
            <label for="cnpj" class="form-label">CNPJ da OSC</label>
            <input type="text" class="form-control" id="cnpj" name="cnpj" 
                   value="{{ parceria.cnpj or '' }}"
                   placeholder="Preenchido automaticamente">
          </div>
        </div>

        <div class="mb-3">
          <label for="projeto" class="form-label">Projeto</label>
          <input type="text" class="form-control" id="projeto" name="projeto" 
                 value="{{ parceria.projeto or '' }}">
        </div>

        <div class="mb-3">
          <label for="endereco" class="form-label">Localização da Sede da OSC</label>
          <textarea class="form-control" id="endereco" name="endereco" rows="2">{{ parceria.endereco or '' }}</textarea>
        </div>

        <!-- Seção: Período e Valores -->
        <div class="section-title">PERÍODO E VALORES</div>

        {% if termo_rescindido %}
        <!-- Alerta de Termo Rescindido -->
        <div class="alert alert-danger d-flex align-items-center mb-3" role="alert">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2" viewBox="0 0 16 16">
            <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
          </svg>
          <div>
            <strong>⚠️ ATENÇÃO: TERMO RESCINDIDO</strong><br>
            Este termo de parceria foi rescindido em 
            <strong>{{ data_rescisao.strftime('%d/%m/%Y') if data_rescisao else 'data não informada' }}</strong>.
          </div>
        </div>
        {% endif %}

        <div class="row mb-3">
          <div class="col-md-3">
            <label for="inicio" class="form-label">Data de Início</label>
            <input type="date" class="form-control" id="inicio" name="inicio" 
                   max="9999-12-31"
                   value="{{ parceria.get('inicio', '') if parceria else '' }}">
          </div>
          <div class="col-md-3">
            <label for="final" class="form-label">Data de Término</label>
            <input type="date" class="form-control" id="final" name="final" 
                   max="9999-12-31"
                   value="{{ parceria.get('final', '') if parceria else '' }}">
          </div>
          <div class="col-md-3">
            <label for="data_assinatura" class="form-label">Data de Assinatura</label>
            <input type="date" class="form-control" id="data_assinatura" name="data_assinatura" 
                   max="9999-12-31"
                   value="{{ data_assinatura or '' }}">
            <small class="text-muted">Data de assinatura do termo</small>
          </div>
          {% if termo_rescindido %}
          <div class="col-md-3">
            <label for="data_rescisao" class="form-label">
              <span class="badge bg-danger">Data de Rescisão</span>
            </label>
            <input type="date" class="form-control border-danger" id="data_rescisao" name="data_rescisao" 
                   value="{{ data_rescisao.strftime('%Y-%m-%d') if data_rescisao else '' }}"
                   readonly style="background-color: #f8d7da; font-weight: bold;">
          </div>
          {% else %}
          <div class="col-md-3">
            <label for="meses" class="form-label">Meses do Projeto</label>
            <input type="number" class="form-control" id="meses" name="meses" 
                   value="{{ parceria.get('meses', '') if parceria else '' }}"
                   readonly style="background-color: #e9ecef;">
            <small class="text-muted">Calculado automaticamente</small>
          </div>
          {% endif %}
        </div>
        
        {% if termo_rescindido %}
        <div class="row mb-3">
          <div class="col-md-12">
            <label for="meses" class="form-label">Meses do Projeto</label>
            <input type="number" class="form-control" id="meses" name="meses" 
                   value="{{ parceria.get('meses', '') if parceria else '' }}"
                   readonly style="background-color: #e9ecef;">
            <small class="text-muted">Calculado automaticamente</small>
          </div>
        </div>
        {% endif %}

        <div class="row mb-3">
          <div class="col-md-6">
            <label for="total_previsto" class="form-label">Total Valor Previsto (R$)</label>
            <input type="text" class="form-control valor-monetario" id="total_previsto" name="total_previsto" 
                   value="{{ '{:,.2f}'.format(parceria.get('total_previsto', 0)).replace(',', 'X').replace('.', ',').replace('X', '.') if parceria and parceria.get('total_previsto') else '' }}"
                   placeholder="0,00">
            <input type="hidden" id="total_previsto_hidden" name="total_previsto_hidden">
          </div>
          <div class="col-md-6">
            <label for="total_pago" class="form-label">Total Valor Pago (R$)</label>
            <input type="text" class="form-control valor-monetario" id="total_pago" name="total_pago" 
                   value="{{ '{:,.2f}'.format(parceria.get('total_pago', 0)).replace(',', 'X').replace('.', ',').replace('X', '.') if parceria and parceria.get('total_pago') else '0,00' }}"
                   placeholder="0,00">
            <input type="hidden" id="total_pago_hidden" name="total_pago_hidden" value="0">
          </div>
        </div>

        <!-- Seção: Dados Bancários e Características -->
        <div class="section-title">DADOS BANCÁRIOS E CARACTERÍSTICAS</div>

        <div class="mb-3">
          <label for="conta" class="form-label">Conta Específica do Projeto</label>
          <input type="text" class="form-control" id="conta" name="conta" 
                 value="{{ parceria.conta or '' }}">
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="transicao" name="transicao" 
                     {% if parceria and parceria.get('transicao') %}checked{% endif %}>
              <label class="form-check-label" for="transicao">
                É transição de Portaria?
              </label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="contrapartida" name="contrapartida" 
                     {% if parceria and parceria.get('contrapartida') %}checked{% endif %}>
              <label class="form-check-label" for="contrapartida">
                Tem contrapartida?
              </label>
            </div>
          </div>
        </div>

        <!-- Seção: Processos SEI -->
        <div class="section-title">PROCESSOS SEI</div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label for="sei_celeb" class="form-label">SEI de Celebração</label>
            <input type="text" class="form-control" id="sei_celeb" name="sei_celeb" 
                   value="{{ parceria.sei_celeb or '' }}">
          </div>
          <div class="col-md-6">
            <label for="sei_pc" class="form-label">SEI de Pagamento e Prestação de Contas</label>
            <input type="text" class="form-control" id="sei_pc" name="sei_pc" 
                   value="{{ parceria.sei_pc or '' }}">
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label for="termo_sei_doc" class="form-label">
              SEI do Documento
              <small class="text-muted">(Termo Original)</small>
            </label>
            <input type="text" class="form-control" id="termo_sei_doc" name="termo_sei_doc" 
                   value="{{ termo_sei_doc or '' }}" 
                   placeholder="Ex: 123456789">
            <div class="form-text">
              <i class="bi bi-info-circle"></i> 
              Número SEI do documento do termo original (não aditivo/apostilamento).
            </div>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label for="sei_plano" class="form-label">SEI do Plano de Trabalho</label>
            <input type="text" class="form-control" id="sei_plano" name="sei_plano" 
                   value="{{ parceria.sei_plano or '' }}">
          </div>
          <div class="col-md-6">
            <label for="sei_orcamento" class="form-label">SEI do Orçamento Anual</label>
            <input type="text" class="form-control" id="sei_orcamento" name="sei_orcamento" 
                   value="{{ parceria.sei_orcamento or '' }}">
          </div>
        </div>

        <!-- Seção: Leis Aplicáveis -->
        <div class="section-title">LEIS APLICÁVEIS</div>

        <div class="row mb-3">
          <div class="col-md-12">
            <label for="portaria" class="form-label">
              Portaria/Legislação
              <small class="text-muted">(preenchimento automático baseado no tipo de termo e data de início)</small>
            </label>
            <select class="form-select" id="portaria" name="portaria">
              <option value="">-- Selecione --</option>
              {% for leg in legislacoes %}
                <option value="{{ leg }}" {% if parceria and parceria.get('portaria') == leg %}selected{% endif %}>{{ leg }}</option>
              {% endfor %}
            </select>
            <div class="form-text">
              <i class="bi bi-info-circle"></i> 
              A portaria é selecionada automaticamente ao informar o número do termo e a data de início.
            </div>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-12">
            <label for="edital_nome" class="form-label">
              Edital
              <small class="text-muted">(Vincule esta parceria a um edital específico ou opção válida)</small>
            </label>
            <select class="form-select" id="edital_nome" name="edital_nome">
              <option value="">-- Selecione --</option>
              {% for edital in editais %}
                <option value="{{ edital }}" {% if parceria and parceria.get('edital_nome') == edital %}selected{% endif %}>{{ edital }}</option>
              {% endfor %}
            </select>
            <div class="form-text">
              <i class="bi bi-info-circle"></i> 
              Selecione o edital relacionado a esta parceria, se aplicável.
            </div>
          </div>
        </div>

        <!-- Seção: Pessoa Gestora -->
        <div class="section-title">PESSOA GESTORA</div>
        
        <div class="row mb-3">
          <div class="col-md-8">
            <label for="pessoa_gestora" class="form-label">Pessoa Gestora</label>
            <select class="form-select" id="pessoa_gestora" name="pessoa_gestora">
              <option value="">-- Selecione --</option>
              {% for pg in pessoas_gestoras %}
                <option value="{{ pg.nome_pg }}" data-rf="{{ pg.numero_rf or '' }}" 
                        data-status="{{ pg.status_pg }}"
                        style="{% if pg.status_pg != 'Ativo' %}background-color: #fff3cd; font-style: italic;{% endif %}"
                        {% if parceria and parceria.pessoa_gestora == pg.nome_pg %}selected{% endif %}>
                  {{ pg.nome_pg }}{% if pg.status_pg != 'Ativo' %} (Inativo){% endif %}
                </option>
              {% endfor %}
            </select>
            <div class="form-text">
              <i class="bi bi-info-circle"></i> 
              Selecione a pessoa gestora responsável por esta parceria.
              <span class="text-warning"><i class="bi bi-exclamation-triangle"></i> Pessoas gestoras inativas estão destacadas em amarelo.</span>
            </div>
          </div>
          <div class="col-md-4">
            <label for="rf_pessoa_gestora" class="form-label">R.F. da Pessoa Gestora</label>
            <input type="text" class="form-control" id="rf_pessoa_gestora" name="rf_pessoa_gestora" 
                   value="{{ rf_pessoa_gestora if rf_pessoa_gestora else '' }}" readonly disabled>
            <div class="form-text">
              <i class="bi bi-lock"></i> Preenchido automaticamente
            </div>
          </div>
        </div>

        <!-- Checkbox de Solicitação de Alteração (aparece apenas se pessoa gestora estiver inativa) -->
        <div class="row mb-3" id="solicitacao_alteracao_container" style="display: none;">
          <div class="col-md-12">
            <div class="alert alert-warning">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="solicitacao_alteracao" name="solicitacao_alteracao" 
                       {% if parceria and parceria.solicitacao %}checked{% endif %}>
                <label class="form-check-label" for="solicitacao_alteracao">
                  <strong><i class="bi bi-exclamation-circle"></i> Foi solicitada alteração da pessoa gestora inativa?</strong>
                </label>
                <div class="form-text mt-2">
                  Marque esta opção se já foi solicitada a substituição desta pessoa gestora inativa.
                  Esta informação será registrada no histórico da parceria.
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Seção: Informações Adicionais (Collapsed) -->
        <div class="section-title" data-bs-toggle="collapse" data-bs-target="#secaoInfosAdicionais" 
             style="cursor: pointer; user-select: none;">
          <i class="bi bi-plus-circle me-2" id="iconInfosAdicionais"></i>
          INFORMAÇÕES ADICIONAIS
        </div>
        <div class="collapse" id="secaoInfosAdicionais">
          <div class="row mb-3">
            <div class="col-md-12">
              <label for="parceria_responsavel_legal" class="form-label">
                Responsável Legal
                <small class="text-muted">(separe múltiplos responsáveis por ponto-e-vírgula ";")</small>
              </label>
              <textarea class="form-control" id="parceria_responsavel_legal" name="parceria_responsavel_legal" rows="2" 
                        placeholder="Exemplo: Fulano de Tal; Ciclano da Silva; Beltrano Santos">{{ infos_adicionais.parceria_responsavel_legal or '' }}</textarea>
              <div class="form-text">
                <i class="bi bi-info-circle"></i> 
                Para informar múltiplos responsáveis legais, digite os nomes separados por ponto-e-vírgula.
              </div>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-12">
              <label for="parceria_objeto" class="form-label">Objeto da Parceria</label>
              <textarea class="form-control" id="parceria_objeto" name="parceria_objeto" rows="3">{{ infos_adicionais.parceria_objeto or '' }}</textarea>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="parceria_beneficiarios_diretos" class="form-label">Beneficiários Diretos</label>
              <input type="number" class="form-control" id="parceria_beneficiarios_diretos" name="parceria_beneficiarios_diretos" 
                     value="{{ infos_adicionais.parceria_beneficiarios_diretos or '' }}" min="0">
            </div>
            <div class="col-md-6">
              <label for="parceria_beneficiarios_indiretos" class="form-label">Beneficiários Indiretos</label>
              <input type="number" class="form-control" id="parceria_beneficiarios_indiretos" name="parceria_beneficiarios_indiretos" 
                     value="{{ infos_adicionais.parceria_beneficiarios_indiretos or '' }}" min="0">
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-12">
              <label for="parceria_justificativa_projeto" class="form-label">Justificativa do Projeto</label>
              <textarea class="form-control" id="parceria_justificativa_projeto" name="parceria_justificativa_projeto" rows="4">{{ infos_adicionais.parceria_justificativa_projeto or '' }}</textarea>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-12">
              <label for="parceria_abrangencia_projeto" class="form-label">Abrangência do Projeto</label>
              <textarea class="form-control" id="parceria_abrangencia_projeto" name="parceria_abrangencia_projeto" rows="3">{{ infos_adicionais.parceria_abrangencia_projeto or '' }}</textarea>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="parceria_data_suspensao" class="form-label">Data de Suspensão</label>
              <input type="date" class="form-control" id="parceria_data_suspensao" name="parceria_data_suspensao" 
                     value="{{ infos_adicionais.parceria_data_suspensao or '' }}">
            </div>
            <div class="col-md-6">
              <label for="parceria_data_retomada" class="form-label">Data de Retomada</label>
              <input type="date" class="form-control" id="parceria_data_retomada" name="parceria_data_retomada" 
                     value="{{ infos_adicionais.parceria_data_retomada or '' }}">
            </div>
          </div>
        </div>

        <!-- Seção: Endereços (Collapsed) -->
        <div class="section-title" data-bs-toggle="collapse" data-bs-target="#secaoEnderecos" 
             style="cursor: pointer; user-select: none;">
          <i class="bi bi-plus-circle me-2" id="iconEnderecos"></i>
          ENDEREÇOS DO PROJETO
        </div>
        <div class="collapse" id="secaoEnderecos">
          <div class="row mb-3">
            <div class="col-md-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="projetoOnline" name="projeto_online" 
                       onchange="toggleEnderecosFields()">
                <label class="form-check-label" for="projetoOnline">
                  <strong>Projeto Online</strong> <small class="text-muted">(Marque se não houver endereço físico)</small>
                </label>
              </div>
            </div>
          </div>

          <div id="enderecosContainer">
            <!-- Endereços serão carregados dinamicamente -->
          </div>

          <div id="botaoAdicionarEndereco" class="row mb-3">
            <div class="col-md-12">
              <button type="button" class="btn btn-sm btn-outline-primary" onclick="adicionarEndereco()">
                <i class="bi bi-plus-circle"></i> Adicionar Endereço
              </button>
            </div>
          </div>
        </div>

        <!-- Seção: Informações do Vereador (Emendas Parlamentares) -->
        <div id="secaoVereadores" style="display: none;">
          <div class="section-title" data-bs-toggle="collapse" data-bs-target="#secaoVereadoresCollapse" 
               style="cursor: pointer; user-select: none;">
            <i class="bi bi-plus-circle me-2" id="iconVereadores"></i>
            INFORMAÇÕES DO VEREADOR (EMENDA PARLAMENTAR)
          </div>
          <div class="collapse" id="secaoVereadoresCollapse">
            <div class="alert alert-info mb-3">
              <i class="bi bi-info-circle"></i> 
              Esta parceria possui emenda parlamentar. Informe os vereadores responsáveis.
            </div>

            <div id="vereadoresContainer">
              <!-- Vereadores serão carregados dinamicamente -->
            </div>

            <div class="row mb-3">
              <div class="col-md-12">
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="adicionarVereador()">
                  <i class="bi bi-plus-circle"></i> Adicionar Vereador
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Botões de Ação -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
          <button type="button" class="btn btn-danger" onclick="exportarPDF()">
            <i class="bi bi-file-pdf"></i> Exportar PDF
          </button>
          {% if request.args.get('origem') == 'conferencia' %}
          <a href="{{ url_for('parcerias.conferencia') }}" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i> Cancelar
          </a>
          {% else %}
          <a href="{{ url_for('parcerias.listar') }}" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i> Cancelar
          </a>
          {% endif %}
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle"></i> Salvar Alterações
          </button>
        </div>

      </form>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // ========== VARIÁVEIS GLOBAIS ==========
    const formId = 'parceriaForm_' + (document.getElementById('numero_termo').value || 'nova');
    let autosaveTimeout;
    let lastSaved = Date.now();
    let oscData = {}; // Mapeamento OSC -> CNPJ
    let siglaMapping = {}; // Mapeamento sigla -> tipo de termo

    // ========== 1. CARREGAR DADOS DAS APIs ==========
    async function carregarDados() {
      try {
        // Carregar OSCs
        const oscResponse = await fetch('/parcerias/api/oscs');
        oscData = await oscResponse.json();
        
        // Preencher datalist
        const datalist = document.getElementById('osc-list');
        Object.keys(oscData).forEach(osc => {
          const option = document.createElement('option');
          option.value = osc;
          datalist.appendChild(option);
        });

        // Carregar mapeamento de siglas
        const siglaResponse = await fetch('/parcerias/api/sigla-tipo-termo');
        siglaMapping = await siglaResponse.json();
        
        // Executar automações se houver dados pré-preenchidos (importação)
        executarAutomacoesIniciais();
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
      }
    }

    // ========== 1.1. EXECUTAR AUTOMAÇÕES INICIAIS (IMPORTAÇÃO) ==========
    function executarAutomacoesIniciais() {
      // Detectar tipo de termo se número do termo estiver preenchido
      const numeroTermoInput = document.getElementById('numero_termo');
      if (numeroTermoInput.value && !document.getElementById('tipo_termo').value) {
        detectarTipoTermo();
      }
      
      // Preencher CNPJ se OSC estiver preenchida
      const oscInput = document.getElementById('osc');
      if (oscInput.value && !document.getElementById('cnpj').value) {
        preencherCNPJ();
      }
      
      // Calcular meses se datas de início e fim estiverem preenchidas
      const inicioInput = document.getElementById('inicio');
      const finalInput = document.getElementById('final');
      if (inicioInput.value && finalInput.value) {
        calcularMeses();
      }
      
      // Detectar portaria/legislação automaticamente
      if (inicioInput.value && numeroTermoInput.value && !document.getElementById('portaria').value) {
        detectarPortaria();
      }
    }

    // ========== 2. RECONHECIMENTO AUTOMÁTICO DE TIPO DE TERMO ==========
    function detectarTipoTermo() {
      const numeroTermoInput = document.getElementById('numero_termo');
      const numeroTermo = numeroTermoInput.value.trim().toUpperCase();
      
      if (numeroTermo.length >= 3) {
        const sigla = numeroTermo.substring(0, 3);
        
        if (siglaMapping[sigla]) {
          const tipoSelect = document.getElementById('tipo_termo');
          const opcoes = Array.from(tipoSelect.options);
          
          // Encontrar e selecionar a opção correspondente
          const opcaoCorreta = opcoes.find(opt => opt.value === siglaMapping[sigla]);
          if (opcaoCorreta) {
            tipoSelect.value = opcaoCorreta.value;
            
            // Feedback visual
            tipoSelect.style.borderColor = '#28a745';
            setTimeout(() => {
              tipoSelect.style.borderColor = '';
            }, 1000);
          }
        }
      }
    }

    document.getElementById('numero_termo').addEventListener('input', detectarTipoTermo);

    // ========== 3. PREENCHIMENTO AUTOMÁTICO DE CNPJ ==========
    function preencherCNPJ() {
      const oscInput = document.getElementById('osc');
      const oscSelecionada = oscInput.value;
      
      if (oscData[oscSelecionada]) {
        const cnpjField = document.getElementById('cnpj');
        cnpjField.value = oscData[oscSelecionada];
        
        // Feedback visual
        cnpjField.style.borderColor = '#28a745';
        setTimeout(() => {
          cnpjField.style.borderColor = '';
        }, 1000);
      }
    }

    document.getElementById('osc').addEventListener('change', preencherCNPJ);

    // ========== 3.1. PREENCHIMENTO AUTOMÁTICO DE R.F. DA PESSOA GESTORA ==========
    document.getElementById('pessoa_gestora').addEventListener('change', function(e) {
      const selectPG = e.target;
      const selectedOption = selectPG.options[selectPG.selectedIndex];
      const rf = selectedOption.getAttribute('data-rf') || '';
      const status = selectedOption.getAttribute('data-status') || 'Ativo';
      
      const rfField = document.getElementById('rf_pessoa_gestora');
      rfField.value = rf;
      
      // Mostrar/ocultar checkbox de solicitação se pessoa gestora for inativa
      const solicitacaoContainer = document.getElementById('solicitacao_alteracao_container');
      if (status !== 'Ativo' && selectPG.value !== '') {
        solicitacaoContainer.style.display = 'block';
      } else {
        solicitacaoContainer.style.display = 'none';
        document.getElementById('solicitacao_alteracao').checked = false;
      }
      
      // Feedback visual
      if (rf) {
        rfField.style.borderColor = '#28a745';
        setTimeout(() => {
          rfField.style.borderColor = '';
        }, 1000);
      }
    });
    
    // Verificar status inicial ao carregar a página
    window.addEventListener('DOMContentLoaded', function() {
      const selectPG = document.getElementById('pessoa_gestora');
      const selectedOption = selectPG.options[selectPG.selectedIndex];
      const status = selectedOption.getAttribute('data-status') || 'Ativo';
      const solicitacaoContainer = document.getElementById('solicitacao_alteracao_container');
      
      if (status !== 'Ativo' && selectPG.value !== '') {
        solicitacaoContainer.style.display = 'block';
      }

      // Se OSC veio pré-preenchida da conferência, buscar CNPJ automaticamente
      const oscField = document.getElementById('osc');
      const cnpjField = document.getElementById('cnpj');
      if (oscField.value && !cnpjField.value) {
        console.log('[DEBUG] OSC pré-preenchida, buscando CNPJ...');
        preencherCNPJ();
      }
    });

    // ========== 4. CÁLCULO AUTOMÁTICO DE MESES ==========
    function calcularMeses() {
      const inicioInput = document.getElementById('inicio');
      const finalInput = document.getElementById('final');
      const mesesInput = document.getElementById('meses');
      
      if (inicioInput.value && finalInput.value) {
        const dataInicio = new Date(inicioInput.value + 'T00:00:00');
        const dataFinal = new Date(finalInput.value + 'T00:00:00');
        
        if (dataFinal >= dataInicio) {
          // Calcular diferença em meses
          let meses = (dataFinal.getFullYear() - dataInicio.getFullYear()) * 12;
          meses += dataFinal.getMonth() - dataInicio.getMonth();
          
          // Se o dia final é maior ou igual ao dia inicial, conta o mês completo
          if (dataFinal.getDate() >= dataInicio.getDate()) {
            meses += 1;
          }
          
          mesesInput.value = meses;
          
          // Feedback visual
          mesesInput.style.borderColor = '#28a745';
          setTimeout(() => {
            mesesInput.style.borderColor = '';
          }, 1000);
        } else {
          // Apenas limpa o campo, sem alertar
          mesesInput.value = '';
        }
      }
    }

    document.getElementById('inicio').addEventListener('change', calcularMeses);
    document.getElementById('final').addEventListener('change', calcularMeses);

    // ========== 4.5. SELEÇÃO AUTOMÁTICA DE PORTARIA ==========
    async function detectarPortaria() {
      const inicioInput = document.getElementById('inicio');
      const numeroTermoInput = document.getElementById('numero_termo');
      const portariaSelect = document.getElementById('portaria');
      const transicaoCheckbox = document.getElementById('transicao');
      const finalInput = document.getElementById('final');
      
      const dataInicio = inicioInput.value;
      const numeroTermo = numeroTermoInput.value;
      const dataFinal = finalInput.value;
      
      if (!dataInicio || !numeroTermo) {
        return; // Precisa dos dois dados
      }
      
      try {
        // Buscar portaria automaticamente
        const response = await fetch('/api/portaria-automatica', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            data_inicio: dataInicio,
            numero_termo: numeroTermo
          })
        });
        
        const data = await response.json();
        
        if (data.portaria) {
          // Selecionar a portaria no dropdown
          const opcoes = Array.from(portariaSelect.options);
          const opcaoCorreta = opcoes.find(opt => opt.value === data.portaria);
          
          if (opcaoCorreta) {
            portariaSelect.value = opcaoCorreta.value;
            
            // Feedback visual
            portariaSelect.style.borderColor = '#28a745';
            setTimeout(() => {
              portariaSelect.style.borderColor = '';
            }, 2000);
          }
        }
        
        // Verificar transição se tiver data final
        if (dataFinal && dataInicio) {
          verificarTransicao(dataInicio, dataFinal, numeroTermo);
        }
        
      } catch (error) {
        console.error('Erro ao detectar portaria:', error);
      }
    }
    
    async function verificarTransicao(dataInicio, dataFinal, numeroTermo) {
      const transicaoCheckbox = document.getElementById('transicao');
      
      // Regras de transição:
      // Portaria nº 140/SMDHC/2019 (até 31/12/2023) para Portaria nº 90/SMDHC/2023 (a partir de 01/01/2024)
      // Portaria nº 121/SMDHC/2019 (até 31/12/2023) para Portaria nº 21/SMDHC/2023 (a partir de 01/03/2023)
      
      const inicio = new Date(dataInicio);
      const final = new Date(dataFinal);
      
      const transicao140para090_inicio = new Date('2017-10-01');
      const transicao140para090_fim = new Date('2023-12-31');
      const transicao140para090_nova = new Date('2024-01-01');
      
      const transicao121para021_inicio = new Date('2017-10-01');
      const transicao121para021_fim = new Date('2023-12-31');
      const transicao121para021_nova = new Date('2023-03-01');
      
      let ehTransicao = false;
      
      // Verifica se atravessa a mudança 140 -> 090
      if (inicio >= transicao140para090_inicio && inicio <= transicao140para090_fim && 
          final >= transicao140para090_nova) {
        const numeroTermoUpper = numeroTermo.toUpperCase();
        if (numeroTermoUpper.includes('FUMCAD') || numeroTermoUpper.includes('FMID')) {
          ehTransicao = true;
        }
      }
      
      // Verifica se atravessa a mudança 121 -> 021
      if (inicio >= transicao121para021_inicio && inicio <= transicao121para021_fim && 
          final >= transicao121para021_nova) {
        const numeroTermoUpper = numeroTermo.toUpperCase();
        if (!numeroTermoUpper.includes('FUMCAD') && !numeroTermoUpper.includes('FMID')) {
          ehTransicao = true;
        }
      }
      
      if (ehTransicao) {
        transicaoCheckbox.checked = true;
        // Feedback visual
        const transicaoLabel = document.querySelector('label[for="transicao"]');
        transicaoLabel.style.color = '#ffc107';
        transicaoLabel.innerHTML = '<i class="bi bi-exclamation-triangle"></i> É transição de Portaria?';
        setTimeout(() => {
          transicaoLabel.style.color = '';
          transicaoLabel.textContent = 'É transição de Portaria?';
        }, 5000);
      }
    }
    
    // Chamar detecção ao alterar campos relevantes
    document.getElementById('inicio').addEventListener('change', detectarPortaria);
    document.getElementById('numero_termo').addEventListener('blur', detectarPortaria);
    document.getElementById('final').addEventListener('change', function() {
      const dataInicio = document.getElementById('inicio').value;
      const numeroTermo = document.getElementById('numero_termo').value;
      if (dataInicio && numeroTermo && this.value) {
        verificarTransicao(dataInicio, this.value, numeroTermo);
      }
    });

    // ========== 5. AUTOSAVE (código anterior mantido) ==========
    window.addEventListener('DOMContentLoaded', function() {
      // Carregar dados das APIs primeiro
      carregarDados();
      
      const savedData = localStorage.getItem(formId);
      if (savedData) {
        const data = JSON.parse(savedData);
        const confirmRestore = confirm('Dados não salvos foram encontrados. Deseja restaurá-los?');
        
        if (confirmRestore) {
          // Restaurar todos os campos
          Object.keys(data).forEach(key => {
            const field = document.getElementById(key);
            if (field) {
              if (field.type === 'checkbox') {
                field.checked = data[key];
              } else {
                field.value = data[key];
              }
            }
          });
          
          // Mostrar mensagem
          const alertDiv = document.createElement('div');
          alertDiv.className = 'alert alert-info alert-dismissible fade show';
          alertDiv.innerHTML = `
            <i class="bi bi-info-circle"></i> Dados restaurados do autosave (${new Date(data._timestamp).toLocaleString()})
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
          document.querySelector('.form-container').insertBefore(alertDiv, document.querySelector('form'));
        } else {
          localStorage.removeItem(formId);
        }
      }
    });

    // Salvar dados automaticamente
    function autosaveForm() {
      const formData = {};
      const form = document.querySelector('form');
      const inputs = form.querySelectorAll('input, select, textarea');
      
      inputs.forEach(input => {
        if (input.id && !input.disabled) {
          if (input.type === 'checkbox') {
            formData[input.id] = input.checked;
          } else {
            formData[input.id] = input.value;
          }
        }
      });
      
      formData._timestamp = Date.now();
      localStorage.setItem(formId, JSON.stringify(formData));
      lastSaved = Date.now();
      
      // Mostrar indicador de salvamento
      showSaveIndicator();
    }

    // Indicador visual de autosave
    function showSaveIndicator() {
      let indicator = document.getElementById('saveIndicator');
      if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'saveIndicator';
        indicator.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #28a745; color: white; padding: 10px 20px; border-radius: 5px; z-index: 9999; display: none;';
        indicator.innerHTML = '<i class="bi bi-check-circle"></i> Salvo automaticamente';
        document.body.appendChild(indicator);
      }
      
      indicator.style.display = 'block';
      setTimeout(() => {
        indicator.style.display = 'none';
      }, 2000);
    }

    // Observar mudanças no formulário
    document.querySelectorAll('input, select, textarea').forEach(element => {
      element.addEventListener('input', function() {
        // Cancelar timeout anterior
        clearTimeout(autosaveTimeout);
        
        // Criar novo timeout de 60 segundos
        autosaveTimeout = setTimeout(autosaveForm, 60000);
      });
      
      // Salvar imediatamente ao sair do campo (blur)
      element.addEventListener('blur', function() {
        if (Date.now() - lastSaved > 5000) { // Só salvar se passou mais de 5 segundos
          autosaveForm();
        }
      });
    });

    // Limpar autosave ao submeter o formulário
    document.querySelector('form').addEventListener('submit', function(e) {
      // DEBUG: Verificar checkbox de solicitação
      const checkboxSolicitacao = document.getElementById('solicitacao_alteracao');
      console.log('[DEBUG FORM] Checkbox solicitacao_alteracao existe:', !!checkboxSolicitacao);
      if (checkboxSolicitacao) {
        console.log('[DEBUG FORM] Checkbox está marcado:', checkboxSolicitacao.checked);
        console.log('[DEBUG FORM] Checkbox está visível:', checkboxSolicitacao.offsetParent !== null);
        console.log('[DEBUG FORM] Container visível:', document.getElementById('solicitacao_alteracao_container').style.display);
      }
      
      // Validar datas antes de submeter
      const inicioInput = document.getElementById('inicio');
      const finalInput = document.getElementById('final');
      
      // Validar ano máximo (9999)
      if (inicioInput.value) {
        const anoInicio = parseInt(inicioInput.value.split('-')[0]);
        if (anoInicio > 9999) {
          e.preventDefault();
          alert('❌ Erro: Data de início inválida! O ano não pode ultrapassar 9999. Por favor, corrija a data.');
          inicioInput.focus();
          return false;
        }
      }
      
      if (finalInput.value) {
        const anoFinal = parseInt(finalInput.value.split('-')[0]);
        if (anoFinal > 9999) {
          e.preventDefault();
          alert('❌ Erro: Data de término inválida! O ano não pode ultrapassar 9999. Por favor, corrija a data.');
          finalInput.focus();
          return false;
        }
      }
      
      if (inicioInput.value && finalInput.value) {
        const dataInicio = new Date(inicioInput.value + 'T00:00:00');
        const dataFinal = new Date(finalInput.value + 'T00:00:00');
        
        if (dataFinal < dataInicio) {
          e.preventDefault();
          alert('❌ Erro: A data de término não pode ser anterior à data de início!');
          finalInput.focus();
          return false;
        }
      }
      
      // Converter valores monetários formatados para números antes de enviar
      document.querySelectorAll('.valor-monetario').forEach(input => {
        const hiddenInput = document.getElementById(input.id + '_hidden');
        if (hiddenInput) {
          const valorNumerico = converterParaNumero(input.value);
          hiddenInput.value = valorNumerico;
        }
      });
      
      localStorage.removeItem(formId);
    });

    // ========== 6. FORMATAÇÃO MONETÁRIA ==========
    function formatarMoeda(valor) {
      // Remove tudo que não é número
      valor = valor.replace(/\D/g, '');
      
      // Converte para centavos
      valor = (parseInt(valor) / 100).toFixed(2);
      
      // Formata com separadores brasileiros
      valor = valor.replace('.', ',');
      valor = valor.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      
      return valor;
    }

    function converterParaNumero(valorFormatado) {
      if (!valorFormatado) return '0';
      // Remove pontos de milhar e substitui vírgula por ponto
      return valorFormatado.replace(/\./g, '').replace(',', '.');
    }

    // Aplicar formatação monetária aos campos
    document.querySelectorAll('.valor-monetario').forEach(input => {
      // Formatação ao digitar
      input.addEventListener('input', function(e) {
        let valor = e.target.value;
        e.target.value = formatarMoeda(valor);
        
        // Atualizar campo hidden
        const hiddenInput = document.getElementById(e.target.id + '_hidden');
        if (hiddenInput) {
          hiddenInput.value = converterParaNumero(e.target.value);
        }
      });
      
      // Formatação ao sair do campo
      input.addEventListener('blur', function(e) {
        if (!e.target.value || e.target.value === '') {
          if (e.target.id === 'total_pago') {
            e.target.value = '0,00';
            const hiddenInput = document.getElementById(e.target.id + '_hidden');
            if (hiddenInput) {
              hiddenInput.value = '0';
            }
          }
        }
      });
      
      // Inicializar campo hidden com valor inicial
      const hiddenInput = document.getElementById(input.id + '_hidden');
      if (hiddenInput) {
        hiddenInput.value = converterParaNumero(input.value) || '0';
      }
    });

    // Salvar periodicamente a cada 2 minutos
    setInterval(function() {
      const form = document.querySelector('form');
      const inputs = form.querySelectorAll('input, select, textarea');
      let hasContent = false;
      
      inputs.forEach(input => {
        if (input.value && !input.disabled) {
          hasContent = true;
        }
      });
      
      if (hasContent) {
        autosaveForm();
      }
    }, 120000); // 2 minutos

    // Exportar para PDF
    function exportarPDF() {
      const numeroTermo = '{{ parceria.numero_termo if parceria else "" }}';
      
      if (!numeroTermo) {
        alert('Salve a parceria primeiro antes de exportar para PDF.');
        return;
      }
      
      // Mostrar indicador de carregamento
      const btnExportar = event.target.closest('button');
      const textoOriginal = btnExportar.innerHTML;
      btnExportar.disabled = true;
      btnExportar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Gerando PDF...';
      
      // Fazer requisição para a API de exportação usando query string
      window.location.href = `/parcerias/exportar-pdf?numero_termo=${encodeURIComponent(numeroTermo)}`;
      
      // Restaurar botão após um tempo
      setTimeout(() => {
        btnExportar.disabled = false;
        btnExportar.innerHTML = textoOriginal;
      }, 2000);
    }

    // ========== INFORMAÇÕES ADICIONAIS E ENDEREÇOS ==========
    
    let contadorEnderecos = 0;

    // Toggle ícones de collapsed
    document.getElementById('secaoInfosAdicionais').addEventListener('show.bs.collapse', function() {
      document.getElementById('iconInfosAdicionais').className = 'bi bi-dash-circle me-2';
    });
    document.getElementById('secaoInfosAdicionais').addEventListener('hide.bs.collapse', function() {
      document.getElementById('iconInfosAdicionais').className = 'bi bi-plus-circle me-2';
    });
    document.getElementById('secaoEnderecos').addEventListener('show.bs.collapse', function() {
      document.getElementById('iconEnderecos').className = 'bi bi-dash-circle me-2';
    });
    document.getElementById('secaoEnderecos').addEventListener('hide.bs.collapse', function() {
      document.getElementById('iconEnderecos').className = 'bi bi-plus-circle me-2';
    });
    document.getElementById('secaoVereadoresCollapse').addEventListener('show.bs.collapse', function() {
      document.getElementById('iconVereadores').className = 'bi bi-dash-circle me-2';
    });
    document.getElementById('secaoVereadoresCollapse').addEventListener('hide.bs.collapse', function() {
      document.getElementById('iconVereadores').className = 'bi bi-plus-circle me-2';
    });

    // Toggle campos de endereço quando marcar "Projeto Online"
    function toggleEnderecosFields() {
      const checked = document.getElementById('projetoOnline').checked;
      const container = document.getElementById('enderecosContainer');
      const botaoAdicionar = document.getElementById('botaoAdicionarEndereco');
      
      if (checked) {
        container.style.display = 'none';
        botaoAdicionar.style.display = 'none';
      } else {
        container.style.display = 'block';
        botaoAdicionar.style.display = 'block';
      }
    }

    // Adicionar novo endereço
    function adicionarEndereco(dados = {}) {
      contadorEnderecos++;
      const id = dados.id || `novo_${contadorEnderecos}`;
      
      const enderecoHTML = `
        <div class="endereco-item border rounded p-3 mb-3" data-endereco-id="${id}">
          <div class="d-flex justify-content-between mb-2">
            <h6 class="mb-0">Endereço #${contadorEnderecos}</h6>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerEndereco('${id}')">
              <i class="bi bi-trash"></i> Remover
            </button>
          </div>
          
          <input type="hidden" name="endereco_id[]" value="${id}">
          
          <div class="row mb-2">
            <div class="col-md-8">
              <label class="form-label">Logradouro</label>
              <input type="text" class="form-control" name="parceria_logradouro[]" value="${dados.parceria_logradouro || ''}">
            </div>
            <div class="col-md-4">
              <label class="form-label">Número</label>
              <input type="number" class="form-control" name="parceria_numero[]" value="${dados.parceria_numero || ''}">
            </div>
          </div>
          
          <div class="row mb-2">
            <div class="col-md-6">
              <label class="form-label">Complemento</label>
              <input type="text" class="form-control" name="parceria_complemento[]" value="${dados.parceria_complemento || ''}">
            </div>
            <div class="col-md-6">
              <label class="form-label">CEP</label>
              <input type="text" class="form-control cep-mask" name="parceria_cep[]" value="${dados.parceria_cep || ''}" placeholder="00000-000">
            </div>
          </div>
          
          <div class="row mb-2">
            <div class="col-md-4">
              <label class="form-label">Distrito</label>
              <select class="form-select select2-distrito" name="parceria_distrito[]" data-endereco-id="${id}" onchange="atualizarRegionalizacao('${id}')">
                <option value="">-- Selecione --</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Subprefeitura</label>
              <input type="text" class="form-control" name="parceria_subprefeitura[]" id="subprefeitura_${id}" readonly value="${dados.subprefeitura || ''}">
            </div>
            <div class="col-md-4">
              <label class="form-label">Região</label>
              <input type="text" class="form-control" name="parceria_regiao[]" id="regiao_${id}" readonly value="${dados.regiao || ''}">
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('enderecosContainer').insertAdjacentHTML('beforeend', enderecoHTML);
      
      // Inicializar Select2 para o novo distrito
      const selectElement = document.querySelector(`[data-endereco-id="${id}"].select2-distrito`);
      $(selectElement).select2({
        theme: 'bootstrap-5',
        width: '100%',
        ajax: {
          url: '/parcerias/api/distritos',
          dataType: 'json',
          delay: 250,
          data: function (params) {
            return { q: params.term };
          },
          processResults: function (data) {
            return { results: data };
          },
          cache: true
        },
        placeholder: 'Digite para buscar distrito...',
        allowClear: true,
        minimumInputLength: 0
      });
      
      // Se tem dados de distrito, pré-selecionar
      if (dados.parceria_distrito) {
        const option = new Option(dados.distrito_nome || dados.parceria_distrito, dados.parceria_distrito, true, true);
        $(selectElement).append(option).trigger('change');
      }
      
      // Aplicar máscara CEP
      aplicarMascaraCEP();
    }

    // Remover endereço
    function removerEndereco(id) {
      if (confirm('Deseja remover este endereço?')) {
        const elemento = document.querySelector(`[data-endereco-id="${id}"]`);
        if (elemento) {
          elemento.remove();
        }
      }
    }

    // Atualizar regionalização ao selecionar distrito
    function atualizarRegionalizacao(enderecoId) {
      const select = document.querySelector(`[data-endereco-id="${enderecoId}"].select2-distrito`);
      const codigo = select.value;
      
      if (!codigo) {
        document.getElementById(`subprefeitura_${enderecoId}`).value = '';
        document.getElementById(`regiao_${enderecoId}`).value = '';
        return;
      }
      
      fetch(`/parcerias/api/distrito-info/${codigo}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            document.getElementById(`subprefeitura_${enderecoId}`).value = data.subprefeitura || '';
            document.getElementById(`regiao_${enderecoId}`).value = data.regiao || '';
          }
        })
        .catch(error => console.error('Erro ao buscar info do distrito:', error));
    }

    // Aplicar máscara CEP
    function aplicarMascaraCEP() {
      document.querySelectorAll('.cep-mask').forEach(input => {
        input.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\D/g, '');
          if (value.length > 5) {
            value = value.slice(0, 5) + '-' + value.slice(5, 8);
          }
          e.target.value = value;
        });
      });
    }

    // Carregar endereços existentes ao carregar página
    document.addEventListener('DOMContentLoaded', function() {
      // Se houver endereços salvos, carregar
      {% if enderecos %}
        {% for endereco in enderecos %}
          adicionarEndereco({
            id: '{{ endereco.id }}',
            parceria_logradouro: '{{ endereco.parceria_logradouro or "" }}',
            parceria_numero: '{{ endereco.parceria_numero or "" }}',
            parceria_complemento: '{{ endereco.parceria_complemento or "" }}',
            parceria_cep: '{{ endereco.parceria_cep or "" }}',
            parceria_distrito: '{{ endereco.parceria_distrito or "" }}',
            distrito_nome: '{{ endereco.distrito_nome or "" }}',
            subprefeitura: '{{ endereco.subprefeitura or "" }}',
            regiao: '{{ endereco.regiao or "" }}'
          });
        {% endfor %}
      {% endif %}
      
      // Verificar se é projeto online
      {% if projeto_online %}
        document.getElementById('projetoOnline').checked = true;
        toggleEnderecosFields();
      {% endif %}
      
      // Inicializar verificação de emenda parlamentar
      verificarEmendaParlamentar();
      
      // Se houver vereadores salvos, carregar
      {% if vereadores_emenda %}
        {% for vereador in vereadores_emenda %}
          adicionarVereador({
            id: '{{ vereador.id }}',
            vereador_nome: '{{ vereador.vereador_nome or "" }}',
            status: '{{ vereador.status or "" }}',
            valor: '{{ vereador.valor or "" }}',
            observacoes: '{{ vereador.observacoes or "" }}'
          });
        {% endfor %}
      {% endif %}
    });

    // ========== SEÇÃO VEREADORES (EMENDAS PARLAMENTARES) ==========
    
    let contadorVereadores = 0;

    // Verificar se deve mostrar seção de vereadores
    function verificarEmendaParlamentar() {
      const editalSelect = document.getElementById('edital_nome');
      const secaoVereadores = document.getElementById('secaoVereadores');
      
      if (editalSelect.value === 'Sem Edital (Emenda Parlamentar)') {
        secaoVereadores.style.display = 'block';
      } else {
        secaoVereadores.style.display = 'none';
      }
    }

    // Observar mudanças no campo edital
    document.getElementById('edital_nome').addEventListener('change', verificarEmendaParlamentar);

    // Adicionar novo vereador
    function adicionarVereador(dados = {}) {
      contadorVereadores++;
      const id = dados.id || `novo_${contadorVereadores}`;
      const statusCalculado = dados.status || '{{ "Celebrado" if data_assinatura else "" }}';
      
      const vereadorHTML = `
        <div class="vereador-item border rounded p-3 mb-3" data-vereador-id="${id}">
          <div class="d-flex justify-content-between mb-2">
            <h6 class="mb-0">Vereador #${contadorVereadores}</h6>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerVereador('${id}')">
              <i class="bi bi-trash"></i> Remover
            </button>
          </div>
          
          <input type="hidden" name="vereador_id[]" value="${id}">
          
          <div class="row mb-2">
            <div class="col-md-6">
              <label class="form-label">Nome do Vereador</label>
              <select class="form-select select2-vereador" name="vereador_nome[]" data-vereador-id="${id}">
                <option value="">-- Selecione --</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Status</label>
              <input type="text" class="form-control" name="vereador_status[]" value="${statusCalculado}" readonly style="background-color: #e9ecef;">
              <small class="text-muted">Status calculado automaticamente</small>
            </div>
          </div>
          
          <div class="row mb-2">
            <div class="col-md-6">
              <label class="form-label">Valor (R$)</label>
              <input type="text" class="form-control valor-monetario-vereador" name="vereador_valor[]" 
                     value="${dados.valor ? formatarMoedaVereador(dados.valor) : ''}" placeholder="0,00">
            </div>
            <div class="col-md-6">
              <label class="form-label">Observações</label>
              <input type="text" class="form-control" name="vereador_observacoes[]" value="${dados.observacoes || ''}">
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('vereadoresContainer').insertAdjacentHTML('beforeend', vereadorHTML);
      
      // Inicializar Select2 para o novo vereador
      const selectElement = document.querySelector(`[data-vereador-id="${id}"].select2-vereador`);
      $(selectElement).select2({
        theme: 'bootstrap-5',
        width: '100%',
        ajax: {
          url: '/parcerias/api/lista/c_geral_vereadores',
          dataType: 'json',
          delay: 250,
          data: function (params) {
            return { q: params.term };
          },
          processResults: function (data) {
            return { 
              results: data.map(item => ({
                id: item.vereador_nome,
                text: item.vereador_nome
              }))
            };
          },
          cache: true
        },
        placeholder: 'Digite para buscar vereador...',
        allowClear: true,
        minimumInputLength: 0,
        language: {
          noResults: function() {
            return "Nenhum vereador encontrado";
          },
          searching: function() {
            return "Buscando...";
          },
          inputTooShort: function() {
            return "Digite para buscar";
          }
        }
      });
      
      // Se tem dados de vereador, pré-selecionar
      if (dados.vereador_nome) {
        const option = new Option(dados.vereador_nome, dados.vereador_nome, true, true);
        $(selectElement).append(option).trigger('change');
      }
      
      // Aplicar formatação monetária
      aplicarFormatacaoMonetariaVereador();
    }

    // Remover vereador
    function removerVereador(id) {
      if (confirm('Deseja remover este vereador?')) {
        const elemento = document.querySelector(`[data-vereador-id="${id}"]`);
        if (elemento) {
          elemento.remove();
        }
      }
    }

    // Formatação monetária para campos de vereador
    function formatarMoedaVereador(valor) {
      if (!valor) return '0,00';
      valor = valor.toString().replace(/\D/g, '');
      valor = (parseInt(valor) / 100).toFixed(2);
      valor = valor.replace('.', ',');
      valor = valor.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      return valor;
    }

    function aplicarFormatacaoMonetariaVereador() {
      document.querySelectorAll('.valor-monetario-vereador').forEach(input => {
        input.addEventListener('input', function(e) {
          let valor = e.target.value.replace(/\D/g, '');
          e.target.value = formatarMoedaVereador(valor);
        });
        
        input.addEventListener('blur', function(e) {
          if (!e.target.value || e.target.value === '') {
            e.target.value = '0,00';
          }
        });
      });
    }
  
  </script>
</body>
</html>
