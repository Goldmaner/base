<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Listas Suspensas - FAF</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>
<body>
  <div class="container-fluid mt-4">
    <!-- Cabeçalho -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2><i class="bi bi-list-ul"></i> Listas Suspensas</h2>
        <p class="text-muted">Gerenciamento de tabelas categóricas</p>
      </div>
      <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Voltar
      </a>
    </div>

    <!-- Seleção de Tabela -->
    <div class="card mb-4">
      <div class="card-body">
        <label for="seletorTabela" class="form-label fw-bold">Selecione a tabela:</label>
        <select id="seletorTabela" class="form-select form-select-lg" onchange="carregarTabela()">
          <option value="">-- Escolha uma tabela --</option>
          {% for chave, config in tabelas.items() %}
          <option value="{{ chave }}">{{ config.nome }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- Área de conteúdo da tabela -->
    <div id="areaConteudo" style="display: none;">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0" id="tituloTabela"></h5>
          <div>
            <button class="btn btn-warning me-2" onclick="limparFiltros()" id="btnLimparFiltros" style="display: none;">
              <i class="bi bi-x-circle"></i> Limpar Filtros
            </button>
            <button class="btn btn-success" onclick="abrirModalCriar()">
              <i class="bi bi-plus-circle"></i> Adicionar
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover table-striped" id="tabelaDados">
              <thead class="table-dark">
                <tr id="cabecalhoTabela"></tr>
              </thead>
              <tbody id="corpoTabela"></tbody>
              <tfoot id="rodapeTabela" class="table-secondary"></tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Criar/Editar -->
  <div class="modal fade" id="modalFormulario" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="tituloModal">Novo Registro</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formularioRegistro">
            <div id="camposFormulario"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="salvarRegistro()">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let tabelaAtual = null;
    let configAtual = null;
    let registroEditando = null;
    let modalFormulario = null;

    document.addEventListener('DOMContentLoaded', function() {
      modalFormulario = new bootstrap.Modal(document.getElementById('modalFormulario'));
    });

    async function carregarTabela() {
      const select = document.getElementById('seletorTabela');
      tabelaAtual = select.value;
      
      if (!tabelaAtual) {
        document.getElementById('areaConteudo').style.display = 'none';
        return;
      }

      try {
        const response = await fetch(`/listas/api/dados/${tabelaAtual}`);
        const data = await response.json();
        
        if (data.erro) {
          alert('Erro: ' + data.erro);
          return;
        }

        configAtual = data.config;
        const dados = data.dados;

        // Atualizar título
        document.getElementById('tituloTabela').textContent = configAtual.nome;

        // Construir cabeçalho da tabela
        const cabecalho = document.getElementById('cabecalhoTabela');
        cabecalho.innerHTML = '';
        
        // Adicionar colunas editáveis
        for (const col of configAtual.colunas_editaveis) {
          const th = document.createElement('th');
          th.textContent = configAtual.labels[col];
          
          // Adicionar filtro se a coluna estiver na lista de filtros
          if (configAtual.colunas_filtro && configAtual.colunas_filtro.includes(col)) {
            const filterIcon = document.createElement('i');
            filterIcon.className = 'bi bi-funnel ms-2';
            filterIcon.style.cursor = 'pointer';
            filterIcon.onclick = () => filtrarColuna(col);
            th.appendChild(filterIcon);
          }
          
          cabecalho.appendChild(th);
        }
        
        // Adicionar colunas calculadas (não editáveis)
        if (configAtual.colunas_calculadas) {
          for (const col of configAtual.colunas_calculadas) {
            const th = document.createElement('th');
            th.textContent = configAtual.labels[col];
            
            // Adicionar ícones de ordenação para colunas calculadas
            if (col === 'total_pareceres' || col === 'total_parcerias') {
              th.style.cursor = 'pointer';
              th.setAttribute('data-ordem', 'desc'); // Ordem inicial: descendente
              th.setAttribute('data-coluna', col); // Identificar coluna
              
              const sortIcon = document.createElement('i');
              sortIcon.className = 'bi bi-sort-down ms-2';
              sortIcon.id = `iconOrdem_${col}`;
              th.appendChild(sortIcon);
              
              if (col === 'total_pareceres') {
                th.onclick = () => ordenarPorColuna('total_pareceres');
              } else if (col === 'total_parcerias') {
                th.onclick = () => ordenarPorColuna('total_parcerias');
              }
            }
            
            cabecalho.appendChild(th);
          }
        }
        
        // Coluna de ações
        const thAcoes = document.createElement('th');
        thAcoes.textContent = 'Ações';
        thAcoes.style.width = '150px';
        cabecalho.appendChild(thAcoes);

        // Construir corpo da tabela
        const corpo = document.getElementById('corpoTabela');
        corpo.innerHTML = '';

        for (const registro of dados) {
          const tr = document.createElement('tr');
          
          // Adicionar dados editáveis
          for (const col of configAtual.colunas_editaveis) {
            const td = document.createElement('td');
            td.textContent = registro[col] || '-';
            td.setAttribute('data-col', col);
            tr.appendChild(td);
          }
          
          // Adicionar dados calculados (não editáveis)
          if (configAtual.colunas_calculadas) {
            for (const col of configAtual.colunas_calculadas) {
              const td = document.createElement('td');
              td.textContent = registro[col] !== undefined ? registro[col] : '-';
              td.setAttribute('data-col', col);
              // Destaque visual para colunas calculadas
              td.style.backgroundColor = '#f8f9fa';
              td.style.fontWeight = 'bold';
              tr.appendChild(td);
            }
          }

          // Adicionar ações
          const tdAcoes = document.createElement('td');
          tdAcoes.innerHTML = `
            <button class="btn btn-sm btn-primary" onclick='editarRegistro(${JSON.stringify(registro)})'>
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="excluirRegistro(${registro.id})">
              <i class="bi bi-trash"></i>
            </button>
          `;
          tr.appendChild(tdAcoes);

          corpo.appendChild(tr);
        }
        
        // Adicionar rodapé com soma (se for pessoa_gestora)
        atualizarRodape();

        // Mostrar área de conteúdo
        document.getElementById('areaConteudo').style.display = 'block';

      } catch (error) {
        console.error('Erro ao carregar tabela:', error);
        alert('Erro ao carregar dados da tabela');
      }
    }

    function abrirModalCriar() {
      registroEditando = null;
      document.getElementById('tituloModal').textContent = `Novo Registro - ${configAtual.nome}`;
      
      // Construir formulário
      const camposDiv = document.getElementById('camposFormulario');
      camposDiv.innerHTML = '';

      for (const col of configAtual.colunas_editaveis) {
        const div = document.createElement('div');
        div.className = 'mb-3';
        
        const label = document.createElement('label');
        label.className = 'form-label';
        label.textContent = configAtual.labels[col];
        
        let input;
        
        // Verificar se é um campo select_dinamico (lista de sugestões)
        if (configAtual.tipos_campo && configAtual.tipos_campo[col] === 'select_dinamico') {
          // Criar input com datalist para sugestões (permite digitação livre)
          input = document.createElement('input');
          input.type = 'text';
          input.className = 'form-control';
          input.setAttribute('list', `datalist_${col}`);
          
          // Criar datalist com as opções
          const datalist = document.createElement('datalist');
          datalist.id = `datalist_${col}`;
          
          const opcoes = configAtual.tipos_campo[`opcoes_${col}`] || [];
          for (const opcao of opcoes) {
            const opt = document.createElement('option');
            opt.value = opcao;
            datalist.appendChild(opt);
          }
          
          div.appendChild(label);
          div.appendChild(input);
          div.appendChild(datalist);
        } else if (configAtual.tipos_campo && configAtual.tipos_campo[col] === 'text_com_datalist') {
          // Campo de texto com sugestões (datalist)
          input = document.createElement('input');
          input.type = 'text';
          input.className = 'form-control';
          input.setAttribute('list', `datalist_${col}`);
          
          // Criar datalist com as opções
          const datalist = document.createElement('datalist');
          datalist.id = `datalist_${col}`;
          
          const opcoes = configAtual.tipos_campo[`opcoes_${col}`] || [];
          for (const opcao of opcoes) {
            const opt = document.createElement('option');
            opt.value = opcao;
            datalist.appendChild(opt);
          }
          
          div.appendChild(label);
          div.appendChild(input);
          div.appendChild(datalist);
        } else if (configAtual.tipos_campo && configAtual.tipos_campo[col] === 'select') {
          // Select tradicional (dropdown restritivo)
          input = document.createElement('select');
          input.className = 'form-select';
          
          // Adicionar opção vazia
          const opcaoVazia = document.createElement('option');
          opcaoVazia.value = '';
          opcaoVazia.textContent = '-- Selecione --';
          input.appendChild(opcaoVazia);
          
          // Adicionar opções do dropdown
          const opcoes = configAtual.tipos_campo[`opcoes_${col}`] || [];
          for (const opcao of opcoes) {
            const opt = document.createElement('option');
            opt.value = opcao;
            opt.textContent = opcao;
            input.appendChild(opt);
          }
          
          div.appendChild(label);
          div.appendChild(input);
        } else if (col === 'descricao') {
          input = document.createElement('textarea');
          input.rows = 3;
          input.className = 'form-control';
          
          div.appendChild(label);
          div.appendChild(input);
        } else {
          input = document.createElement('input');
          input.type = 'text';
          input.className = 'form-control';
          
          div.appendChild(label);
          div.appendChild(input);
        }
        
        input.id = `campo_${col}`;
        // Campos opcionais: e-mail, número RF, setor, e-mail de coordenador
        const camposOpcionais = ['email_pg', 'numero_rf', 'setor', 'e_mail_c'];
        if (!camposOpcionais.includes(col)) {
          input.required = true;
        }
        
        div.appendChild(label);
        div.appendChild(input);
        camposDiv.appendChild(div);
      }

      modalFormulario.show();
    }

    function editarRegistro(registro) {
      registroEditando = registro;
      document.getElementById('tituloModal').textContent = `Editar Registro - ${configAtual.nome}`;
      
      // Construir formulário com valores
      const camposDiv = document.getElementById('camposFormulario');
      camposDiv.innerHTML = '';

      for (const col of configAtual.colunas_editaveis) {
        const div = document.createElement('div');
        div.className = 'mb-3';
        
        const label = document.createElement('label');
        label.className = 'form-label';
        label.textContent = configAtual.labels[col];
        
        let input;
        
        // Verificar se é um campo select_dinamico (lista de sugestões)
        if (configAtual.tipos_campo && configAtual.tipos_campo[col] === 'select_dinamico') {
          // Criar input com datalist para sugestões (permite digitação livre)
          input = document.createElement('input');
          input.type = 'text';
          input.className = 'form-control';
          input.setAttribute('list', `datalist_${col}`);
          input.value = registro[col] || '';
          
          // Criar datalist com as opções
          const datalist = document.createElement('datalist');
          datalist.id = `datalist_${col}`;
          
          const opcoes = configAtual.tipos_campo[`opcoes_${col}`] || [];
          for (const opcao of opcoes) {
            const opt = document.createElement('option');
            opt.value = opcao;
            datalist.appendChild(opt);
          }
          
          div.appendChild(label);
          div.appendChild(input);
          div.appendChild(datalist);
        } else if (configAtual.tipos_campo && configAtual.tipos_campo[col] === 'text_com_datalist') {
          // Campo de texto com sugestões (datalist)
          input = document.createElement('input');
          input.type = 'text';
          input.className = 'form-control';
          input.setAttribute('list', `datalist_${col}`);
          input.value = registro[col] || '';
          
          // Criar datalist com as opções
          const datalist = document.createElement('datalist');
          datalist.id = `datalist_${col}`;
          
          const opcoes = configAtual.tipos_campo[`opcoes_${col}`] || [];
          for (const opcao of opcoes) {
            const opt = document.createElement('option');
            opt.value = opcao;
            datalist.appendChild(opt);
          }
          
          div.appendChild(label);
          div.appendChild(input);
          div.appendChild(datalist);
        } else if (configAtual.tipos_campo && configAtual.tipos_campo[col] === 'select') {
          // Select tradicional (dropdown restritivo)
          input = document.createElement('select');
          input.className = 'form-select';
          
          // Adicionar opção vazia
          const opcaoVazia = document.createElement('option');
          opcaoVazia.value = '';
          opcaoVazia.textContent = '-- Selecione --';
          input.appendChild(opcaoVazia);
          
          // Adicionar opções do dropdown
          const opcoes = configAtual.tipos_campo[`opcoes_${col}`] || [];
          for (const opcao of opcoes) {
            const opt = document.createElement('option');
            opt.value = opcao;
            opt.textContent = opcao;
            input.appendChild(opt);
          }
          
          input.value = registro[col] || '';
          
          div.appendChild(label);
          div.appendChild(input);
        } else if (col === 'descricao') {
          input = document.createElement('textarea');
          input.rows = 3;
          input.className = 'form-control';
          input.value = registro[col] || '';
          
          div.appendChild(label);
          div.appendChild(input);
        } else {
          input = document.createElement('input');
          input.type = 'text';
          input.className = 'form-control';
          input.value = registro[col] || '';
          
          div.appendChild(label);
          div.appendChild(input);
        }
        
        input.id = `campo_${col}`;
        // Campos opcionais: e-mail, número RF, setor, e-mail de coordenador
        const camposOpcionais = ['email_pg', 'numero_rf', 'setor', 'e_mail_c'];
        if (!camposOpcionais.includes(col)) {
          input.required = true;
        }
        
        camposDiv.appendChild(div);
      }

      modalFormulario.show();
    }

    async function salvarRegistro() {
      // Coletar dados do formulário
      const dados = {};
      for (const col of configAtual.colunas_editaveis) {
        const input = document.getElementById(`campo_${col}`);
        // Campos opcionais: e-mail, número RF, setor, e-mail de coordenador
        const camposOpcionais = ['email_pg', 'numero_rf', 'setor', 'e_mail_c'];
        if (!input.value.trim() && !camposOpcionais.includes(col)) {
          alert(`O campo ${configAtual.labels[col]} é obrigatório`);
          return;
        }
        dados[col] = input.value.trim();
      }
      
      // Validação especial: RF não pode ser duplicado (exceto se vazio)
      if (tabelaAtual === 'c_pessoa_gestora' && dados.numero_rf && dados.numero_rf !== '') {
        // Buscar todos os dados atuais
        const response = await fetch(`/listas/api/dados/${tabelaAtual}`);
        const data = await response.json();
        
        for (const registro of data.dados) {
          // Ignorar o próprio registro quando estiver editando
          if (registroEditando && registro.id === registroEditando.id) {
            continue;
          }
          
          // Verificar duplicação
          if (registro.numero_rf && registro.numero_rf === dados.numero_rf) {
            alert(`O R.F. "${dados.numero_rf}" já está cadastrado para "${registro.nome_pg}". Por favor, use um R.F. diferente.`);
            return;
          }
        }
      }

      try {
        let url, method;
        
        if (registroEditando) {
          // Editar
          url = `/listas/api/dados/${tabelaAtual}/${registroEditando.id}`;
          method = 'PUT';
        } else {
          // Criar
          url = `/listas/api/dados/${tabelaAtual}`;
          method = 'POST';
        }

        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(dados)
        });

        const result = await response.json();

        if (result.erro) {
          alert('Erro: ' + result.erro);
          return;
        }

        // Fechar modal e recarregar tabela
        modalFormulario.hide();
        carregarTabela();
        
        alert(result.mensagem);

      } catch (error) {
        console.error('Erro ao salvar:', error);
        alert('Erro ao salvar registro');
      }
    }

    async function excluirRegistro(id) {
      if (!confirm('Tem certeza que deseja excluir este registro?')) {
        return;
      }

      try {
        const response = await fetch(`/listas/api/dados/${tabelaAtual}/${id}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (result.erro) {
          alert('Erro: ' + result.erro);
          return;
        }

        carregarTabela();
        alert(result.mensagem);

      } catch (error) {
        console.error('Erro ao excluir:', error);
        alert('Erro ao excluir registro');
      }
    }

    function filtrarColuna(coluna) {
      // Se for coluna de status, mostrar opções específicas
      if (coluna === 'status_pg') {
        const opcoes = configAtual.tipos_campo.opcoes_status_pg || ['Ativo', 'Inativo', 'Desconhecido'];
        let opcoesHtml = '<option value="">Todos</option>';
        
        for (const opcao of opcoes) {
          opcoesHtml += `<option value="${opcao}">${opcao}</option>`;
        }
        
        const filtro = prompt(`Escolha o status:\n\nDigite:\n- "Ativo" para Ativos\n- "Inativo" para Inativos\n- "Desconhecido" para Desconhecidos\n- Deixe vazio para mostrar todos`);
        
        if (filtro === null) return; // Cancelou
        
        aplicarFiltro(coluna, filtro, true); // true = filtro exato
      } else {
        // Para outras colunas, filtro por texto parcial
        const filtro = prompt(`Filtrar por ${configAtual.labels[coluna]}:\n(Deixe vazio para mostrar todos)`);
        if (filtro === null) return; // Cancelou
        
        aplicarFiltro(coluna, filtro, false); // false = filtro parcial
      }
    }
    
    function aplicarFiltro(coluna, filtro, exato = false) {
      const tbody = document.getElementById('corpoTabela');
      const linhas = tbody.getElementsByTagName('tr');
      
      for (let linha of linhas) {
        const celulas = linha.getElementsByTagName('td');
        let encontrou = false;
        
        for (let celula of celulas) {
          if (celula.getAttribute('data-col') === coluna) {
            const texto = celula.textContent.trim();
            const filtroTrim = filtro.trim();
            
            if (filtroTrim === '') {
              encontrou = true;
            } else if (exato) {
              // Filtro exato (case-insensitive)
              encontrou = texto.toLowerCase() === filtroTrim.toLowerCase();
            } else {
              // Filtro parcial (case-insensitive)
              encontrou = texto.toLowerCase().includes(filtroTrim.toLowerCase());
            }
            break;
          }
        }
        
        linha.style.display = encontrou ? '' : 'none';
      }
      
      // Mostrar botão de limpar filtros
      document.getElementById('btnLimparFiltros').style.display = 'inline-block';
      
      // Atualizar soma do rodapé
      atualizarRodape();
    }
    
    function limparFiltros() {
      const tbody = document.getElementById('corpoTabela');
      const linhas = tbody.getElementsByTagName('tr');
      
      for (let linha of linhas) {
        linha.style.display = '';
      }
      
      // Esconder botão de limpar filtros
      document.getElementById('btnLimparFiltros').style.display = 'none';
      
      // Atualizar soma do rodapé
      atualizarRodape();
    }
    
    function atualizarRodape() {
      const rodape = document.getElementById('rodapeTabela');
      rodape.innerHTML = '';
      
      // Só mostrar rodapé se for pessoa_gestora e tiver coluna de pareceres
      if (tabelaAtual !== 'c_pessoa_gestora' || !configAtual.colunas_calculadas || !configAtual.colunas_calculadas.includes('total_pareceres')) {
        return;
      }
      
      const tr = document.createElement('tr');
      
      // Contar gestores visíveis
      const tbody = document.getElementById('corpoTabela');
      const linhas = tbody.getElementsByTagName('tr');
      let totalGestores = 0;
      
      for (let linha of linhas) {
        if (linha.style.display !== 'none') {
          totalGestores++;
        }
      }
      
      // Preencher células vazias até a coluna de nome_pg
      const totalColunas = configAtual.colunas_editaveis.length;
      const indiceNome = configAtual.colunas_editaveis.indexOf('nome_pg');
      
      for (let i = 0; i < indiceNome; i++) {
        const td = document.createElement('td');
        tr.appendChild(td);
      }
      
      // Célula com contagem de gestores (na coluna nome_pg)
      const tdContagem = document.createElement('td');
      tdContagem.textContent = `Total: ${totalGestores} gestor${totalGestores !== 1 ? 'es' : ''}`;
      tdContagem.style.fontWeight = 'bold';
      tdContagem.style.fontStyle = 'italic';
      tdContagem.style.color = '#0d6efd';
      tr.appendChild(tdContagem);
      
      // Preencher células vazias entre nome_pg e as colunas calculadas
      const numColunasEditaveis = configAtual.colunas_editaveis.length;
      const colunasAteCalculadas = numColunasEditaveis - indiceNome - 1; // Quantas colunas entre nome_pg e as calculadas
      
      for (let i = 0; i < colunasAteCalculadas; i++) {
        const td = document.createElement('td');
        tr.appendChild(td);
      }
      
      // Célula com a soma de PARECERES
      const tdSomaPareceres = document.createElement('td');
      let somaPareceres = 0;
      
      // Somar apenas linhas visíveis
      for (let linha of linhas) {
        if (linha.style.display !== 'none') {
          const celulas = linha.getElementsByTagName('td');
          for (let celula of celulas) {
            if (celula.getAttribute('data-col') === 'total_pareceres') {
              const valor = parseInt(celula.textContent) || 0;
              somaPareceres += valor;
              break;
            }
          }
        }
      }
      
      tdSomaPareceres.innerHTML = '<strong>TOTAL:</strong><br>' + somaPareceres;
      tdSomaPareceres.style.fontWeight = 'bold';
      tdSomaPareceres.style.fontSize = '1.1em';
      tdSomaPareceres.style.backgroundColor = '#d4edda';
      tdSomaPareceres.style.textAlign = 'center';
      tr.appendChild(tdSomaPareceres);
      
      // Célula com a soma de PARCERIAS
      const tdSomaParcerias = document.createElement('td');
      let somaParcerias = 0;
      
      // Somar apenas linhas visíveis
      for (let linha of linhas) {
        if (linha.style.display !== 'none') {
          const celulas = linha.getElementsByTagName('td');
          for (let celula of celulas) {
            if (celula.getAttribute('data-col') === 'total_parcerias') {
              const valor = parseInt(celula.textContent) || 0;
              somaParcerias += valor;
              break;
            }
          }
        }
      }
      
      tdSomaParcerias.innerHTML = '<strong>TOTAL:</strong><br>' + somaParcerias;
      tdSomaParcerias.style.fontWeight = 'bold';
      tdSomaParcerias.style.fontSize = '1.1em';
      tdSomaParcerias.style.backgroundColor = '#cfe2ff';
      tdSomaParcerias.style.textAlign = 'center';
      tr.appendChild(tdSomaParcerias);
      
      // Célula de ações (vazia)
      const tdAcoes = document.createElement('td');
      tr.appendChild(tdAcoes);
      
      rodape.appendChild(tr);
    }
    
    function ordenarPorColuna(nomeColuna) {
      const tbody = document.getElementById('corpoTabela');
      const linhas = Array.from(tbody.getElementsByTagName('tr'));
      
      // Obter ordem atual do cabeçalho
      const thColuna = document.querySelector(`th[data-coluna="${nomeColuna}"]`);
      if (!thColuna) {
        console.error(`Cabeçalho não encontrado para coluna: ${nomeColuna}`);
        return;
      }
      
      const ordemAtual = thColuna.getAttribute('data-ordem');
      const novaOrdem = ordemAtual === 'desc' ? 'asc' : 'desc';
      
      // Filtrar apenas linhas visíveis para ordenar
      const linhasVisiveis = linhas.filter(linha => linha.style.display !== 'none');
      const linhasOcultas = linhas.filter(linha => linha.style.display === 'none');
      
      // Ordenar linhas visíveis
      linhasVisiveis.sort((a, b) => {
        let valorA = 0;
        let valorB = 0;
        
        // Encontrar célula da coluna especificada
        const celulasA = a.getElementsByTagName('td');
        const celulasB = b.getElementsByTagName('td');
        
        for (let celula of celulasA) {
          if (celula.getAttribute('data-col') === nomeColuna) {
            valorA = parseInt(celula.textContent) || 0;
            break;
          }
        }
        
        for (let celula of celulasB) {
          if (celula.getAttribute('data-col') === nomeColuna) {
            valorB = parseInt(celula.textContent) || 0;
            break;
          }
        }
        
        if (novaOrdem === 'desc') {
          return valorB - valorA;
        } else {
          return valorA - valorB;
        }
      });
      
      // Limpar tbody e reinserir linhas ordenadas, seguidas pelas ocultas
      tbody.innerHTML = '';
      linhasVisiveis.forEach(linha => tbody.appendChild(linha));
      linhasOcultas.forEach(linha => tbody.appendChild(linha));
      
      // Atualizar ícone e atributo de ordem
      thColuna.setAttribute('data-ordem', novaOrdem);
      const icone = document.getElementById(`iconOrdem_${nomeColuna}`);
      if (icone) {
        if (novaOrdem === 'desc') {
          icone.className = 'bi bi-sort-down ms-2';
        } else {
          icone.className = 'bi bi-sort-up ms-2';
        }
      }
      
      // Atualizar rodapé (não muda valores, mas garante consistência visual)
      atualizarRodape();
    }
    
    // Manter compatibilidade com nome antigo
    function ordenarPorPareceres() {
      ordenarPorColuna('total_pareceres');
    }
  </script>
</body>
</html>
