<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Operação: Pesquisa de Parcerias</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    body { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      min-height: 100vh; 
      padding: 20px; 
    }
    .main-container { 
      max-width: 900px; 
      margin: 0 auto; 
      background: white; 
      border-radius: 15px; 
      padding: 30px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
    }
    .btn-voltar {
      background-color: #6c757d;
      color: white;
      border: none;
    }
    .btn-voltar:hover {
      background-color: #5a6268;
      color: white;
    }
    .form-section {
      background-color: #f8f9fa;
      padding: 25px;
      border-radius: 10px;
      margin-top: 20px;
    }
    .btn-registro {
      background-color: #198754;
      color: white;
      padding: 12px 30px;
      border: none;
    }
    .btn-registro:hover {
      background-color: #157347;
      color: white;
    }
    .btn-prosseguir {
      background-color: #0d6efd;
      color: white;
      padding: 12px 30px;
      border: none;
    }
    .btn-prosseguir:hover {
      background-color: #0b5ed7;
      color: white;
    }
    .btn-relatorio {
      background-color: #0dcaf0;
      color: black;
    }
    .btn-relatorio:hover {
      background-color: #31d2f2;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Cabeçalho -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0">
        <i class="bi bi-search me-2"></i>Operação: Pesquisa de Parcerias
      </h2>
      <div>
        <a href="{{ url_for('pesquisa_parcerias.relatorio') }}" class="btn btn-relatorio me-2">
          <i class="bi bi-file-earmark-text me-2"></i>Relatório de Pesquisas
        </a>
        <a href="{{ url_for('main.index') }}" class="btn btn-voltar">
          <i class="bi bi-arrow-left me-2"></i>Voltar
        </a>
      </div>
    </div>

    <!-- Formulário -->
    <div class="form-section">
      <form id="formPesquisa">
        <!-- Número da Pesquisa -->
        <div class="mb-3">
          <label for="numeroPesquisa" class="form-label">
            <i class="bi bi-hash me-2"></i>Número da Pesquisa
          </label>
          <div class="d-flex align-items-center gap-2">
            <input 
              type="number" 
              class="form-control" 
              id="numeroPesquisa" 
              name="numero_pesquisa"
              readonly
              min="1"
              placeholder="Será gerado automaticamente..."
              style="flex: 1;"
            >
            {% if user['tipo_usuario'] == 'Agente Público' %}
            <div class="form-check mb-0">
              <input 
                class="form-check-input" 
                type="checkbox" 
                id="permitirEdicaoNumero"
              >
              <label class="form-check-label" for="permitirEdicaoNumero">
                Editar
              </label>
            </div>
            {% endif %}
          </div>
          <small class="text-muted">Geração automática anual (reseta em janeiro)</small>
        </div>

        <!-- Processo SEI da Pesquisa -->
        <div class="mb-3">
          <label for="pseiPesquisa" class="form-label">
            <i class="bi bi-folder2-open me-2"></i>Processo SEI da Pesquisa
          </label>
          <input 
            type="text" 
            class="form-control" 
            id="pseiPesquisa" 
            name="psei_pesquisa"
            maxlength="30" 
            placeholder="Ex: 6074.2025/0004245-3"
            required
          >
          <small class="text-muted">Número do processo SEI completo (com barras e hífen)</small>
        </div>

        <!-- Documento SEI -->
        <div class="mb-3">
          <label for="seiSolicitacao" class="form-label">
            <i class="bi bi-file-earmark-text me-2"></i>Documento SEI de Solicitação de Pesquisa de Parcerias
          </label>
          <input 
            type="text" 
            class="form-control" 
            id="seiSolicitacao" 
            name="sei_informado"
            maxlength="12" 
            pattern="[0-9]*" 
            placeholder="Digite apenas números (máx. 12 caracteres)"
            required
          >
          <small class="text-muted">Apenas números, máximo 12 caracteres</small>
        </div>

        <!-- Nome da OSC -->
        <div class="mb-3">
          <label for="nomeOsc" class="form-label">
            <i class="bi bi-building me-2"></i>Nome da OSC pesquisada
          </label>
          <input 
            type="text" 
            class="form-control" 
            id="nomeOsc" 
            name="nome_osc"
            list="listaOscs"
            placeholder="Digite o nome da OSC..."
            required
          >
          <datalist id="listaOscs">
            <!-- Opções serão carregadas via JavaScript -->
          </datalist>
          <small class="text-muted">Digite para ver sugestões ou escreva um novo nome</small>
        </div>

        <!-- Checkbox: OSC não identificada -->
        <div class="mb-3">
          <div class="form-check">
            <input 
              class="form-check-input" 
              type="checkbox" 
              id="oscNaoIdentificada" 
              name="osc_nao_identificada"
            >
            <label class="form-check-label" for="oscNaoIdentificada">
              <i class="bi bi-exclamation-triangle me-2"></i>OSC não identificada nos bancos de dados
            </label>
          </div>
        </div>

        <!-- CNPJ (preenchido automaticamente ou editável se não identificada) -->
        <div class="mb-3">
          <label for="cnpj" class="form-label">
            <i class="bi bi-card-text me-2"></i>CNPJ
          </label>
          <input 
            type="text" 
            class="form-control" 
            id="cnpj" 
            name="cnpj"
            placeholder="Será preenchido automaticamente ao selecionar OSC conhecida"
          >
          <small class="text-muted" id="cnpjHelp">Preenchimento automático</small>
        </div>

        <!-- Nome do Emissor -->
        <div class="mb-3">
          <label for="nomeEmissor" class="form-label">
            <i class="bi bi-person-badge me-2"></i>Nome do Emissor
          </label>
          <select class="form-select" id="nomeEmissor" name="nome_emissor" required>
            <option value="">Selecione um analista...</option>
          </select>
        </div>

        <!-- Botões de Ação -->
        <div class="d-flex justify-content-end gap-3 mt-4">
          <button type="button" class="btn btn-registro" onclick="salvarParaRegistro()">
            <i class="bi bi-save me-2"></i>Para Registro
          </button>
          <button type="button" class="btn btn-prosseguir" onclick="prosseguirPesquisa()">
            <i class="bi bi-arrow-right me-2"></i>Prosseguir Pesquisa
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Carrega lista de OSCs únicas ao carregar a página
    document.addEventListener('DOMContentLoaded', async () => {
      await carregarProximoNumero();
      await carregarOscs();
      await carregarAnalistas();
    });

    // Função para carregar o próximo número de pesquisa
    async function carregarProximoNumero() {
      try {
        const response = await fetch('/pesquisa-parcerias/api/proximo-numero');
        const data = await response.json();
        
        if (data.erro) {
          console.error('Erro ao carregar próximo número:', data.erro);
          return;
        }

        document.getElementById('numeroPesquisa').value = data.proximo_numero;

      } catch (error) {
        console.error('Erro ao carregar próximo número:', error);
        alert('Erro ao carregar próximo número de pesquisa');
      }
    }

    // Função para carregar OSCs únicas
    async function carregarOscs() {
      try {
        const response = await fetch('/pesquisa-parcerias/api/oscs');
        const data = await response.json();
        
        const datalist = document.getElementById('listaOscs');
        
        if (data.erro) {
          console.error('Erro ao carregar OSCs:', data.erro);
          return;
        }

        data.oscs.forEach(osc => {
          const option = document.createElement('option');
          option.value = osc;
          datalist.appendChild(option);
        });

      } catch (error) {
        console.error('Erro ao carregar OSCs:', error);
        alert('Erro ao carregar lista de OSCs');
      }
    }

    // Função para carregar analistas ativos
    async function carregarAnalistas() {
      try {
        const response = await fetch('/pesquisa-parcerias/api/analistas-ativos');
        const data = await response.json();
        
        const select = document.getElementById('nomeEmissor');
        
        if (data.erro) {
          console.error('Erro ao carregar analistas:', data.erro);
          return;
        }

        data.analistas.forEach(analista => {
          const option = document.createElement('option');
          option.value = analista.nome_analista;
          option.textContent = analista.nome_analista;
          select.appendChild(option);
        });

      } catch (error) {
        console.error('Erro ao carregar analistas:', error);
        alert('Erro ao carregar lista de analistas');
      }
    }

    // Listener para preencher CNPJ automaticamente ao digitar OSC conhecida
    document.getElementById('nomeOsc').addEventListener('input', async function() {
      const nomeOsc = this.value.trim();
      
      // Se checkbox "não identificada" estiver marcado, não buscar CNPJ
      if (document.getElementById('oscNaoIdentificada').checked) {
        return;
      }
      
      if (!nomeOsc) {
        document.getElementById('cnpj').value = '';
        return;
      }

      try {
        const response = await fetch(`/pesquisa-parcerias/api/cnpj/${encodeURIComponent(nomeOsc)}`);
        const data = await response.json();
        
        if (data.erro) {
          // OSC não encontrada, limpar CNPJ
          document.getElementById('cnpj').value = '';
          return;
        }

        document.getElementById('cnpj').value = data.cnpj || '';

      } catch (error) {
        console.error('Erro ao buscar CNPJ:', error);
      }
    });

    // Listener para checkbox "OSC não identificada"
    document.getElementById('oscNaoIdentificada').addEventListener('change', function() {
      const cnpjInput = document.getElementById('cnpj');
      const cnpjHelp = document.getElementById('cnpjHelp');
      
      if (this.checked) {
        // Permitir edição manual do CNPJ
        cnpjInput.removeAttribute('readonly');
        cnpjInput.value = '';
        cnpjInput.placeholder = 'Digite o CNPJ manualmente';
        cnpjHelp.textContent = 'Digite o CNPJ (se disponível)';
        cnpjInput.required = false;
      } else {
        // Voltar para preenchimento automático
        cnpjInput.setAttribute('readonly', 'readonly');
        cnpjInput.value = '';
        cnpjInput.placeholder = 'Será preenchido automaticamente ao selecionar OSC conhecida';
        cnpjHelp.textContent = 'Preenchimento automático';
        cnpjInput.required = false;
        
        // Tentar buscar CNPJ se houver OSC digitada
        const nomeOsc = document.getElementById('nomeOsc').value.trim();
        if (nomeOsc) {
          document.getElementById('nomeOsc').dispatchEvent(new Event('input'));
        }
      }
    });

    // Listener para checkbox "Permitir Edição do Número" (apenas para Agente Público)
    const checkboxEdicao = document.getElementById('permitirEdicaoNumero');
    if (checkboxEdicao) {
      checkboxEdicao.addEventListener('change', function() {
        const numeroInput = document.getElementById('numeroPesquisa');
        if (this.checked) {
          numeroInput.removeAttribute('readonly');
          numeroInput.focus();
        } else {
          numeroInput.setAttribute('readonly', 'readonly');
        }
      });
    }

    // Validar entrada numérica do SEI
    document.getElementById('seiSolicitacao').addEventListener('input', function(e) {
      this.value = this.value.replace(/[^0-9]/g, '');
    });

    // Função para salvar Para Registro
    async function salvarParaRegistro() {
      const form = document.getElementById('formPesquisa');
      
      // Validar formulário
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const dados = {
        numero_pesquisa: parseInt(document.getElementById('numeroPesquisa').value),
        psei_pesquisa: document.getElementById('pseiPesquisa').value,
        sei_informado: document.getElementById('seiSolicitacao').value,
        nome_osc: document.getElementById('nomeOsc').value,
        cnpj: document.getElementById('cnpjOsc').value || '',
        nome_emissor: document.getElementById('nomeEmissor').value,
        osc_identificada: !document.getElementById('oscNaoIdentificada').checked // Inverte: se "não identificada" está marcado, osc_identificada = false
      };

      try {
        const response = await fetch('/pesquisa-parcerias/api/salvar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dados)
        });

        const result = await response.json();

        if (result.erro) {
          alert('Erro ao salvar: ' + result.erro);
          return;
        }

        alert('Pesquisa registrada com sucesso!\nNúmero da Pesquisa: ' + result.numero_pesquisa);
        
        // Limpar formulário
        form.reset();
        document.getElementById('cnpjOsc').value = '';
        document.getElementById('cnpjOsc').setAttribute('readonly', 'readonly');
        document.getElementById('cnpjOsc').placeholder = 'Será preenchido automaticamente ao selecionar OSC conhecida';
        
        // Desmarcar checkbox de edição (se existir)
        const checkboxEdicao = document.getElementById('permitirEdicaoNumero');
        if (checkboxEdicao) {
          checkboxEdicao.checked = false;
        }
        document.getElementById('numeroPesquisa').setAttribute('readonly', 'readonly');
        
        // Recarregar próximo número
        await carregarProximoNumero();

      } catch (error) {
        console.error('Erro ao salvar:', error);
        alert('Erro ao salvar pesquisa');
      }
    }

    // Função para prosseguir com a pesquisa (gera texto automático)
    async function prosseguirPesquisa() {
      const form = document.getElementById('formPesquisa');
      
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      try {
        // Coletar dados do formulário
        console.log('DEBUG: Coletando dados do formulário...');
        console.log('numeroPesquisa:', document.getElementById('numeroPesquisa'));
        console.log('seiSolicitacao:', document.getElementById('seiSolicitacao'));
        console.log('nomeOsc:', document.getElementById('nomeOsc'));
        console.log('nomeEmissor:', document.getElementById('nomeEmissor'));
        console.log('oscNaoIdentificada:', document.getElementById('oscNaoIdentificada'));
        
        const dados = {
          numero_pesquisa: parseInt(document.getElementById('numeroPesquisa').value) || 0,
          psei_pesquisa: document.getElementById('pseiPesquisa').value,
          sei_informado: document.getElementById('seiSolicitacao').value,
          nome_osc: document.getElementById('nomeOsc').value,
          cnpj: document.getElementById('cnpj').value || '',
          nome_emissor: document.getElementById('nomeEmissor').value,
          osc_identificada: !document.getElementById('oscNaoIdentificada').checked
        };
        
        console.log('Dados coletados:', dados);

        // Enviar para API
        const response = await fetch('/pesquisa-parcerias/api/prosseguir-pesquisa', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(dados)
        });

        const result = await response.json();

        if (result.erro) {
          alert('Erro: ' + result.erro);
          return;
        }

        // Redirecionar para página de texto automático
        if (result.redirect) {
          window.location.href = result.redirect;
        }

      } catch (error) {
        console.error('Erro ao prosseguir pesquisa:', error);
        alert('Erro ao processar pesquisa');
      }
    }
  </script>
</body>
</html>
