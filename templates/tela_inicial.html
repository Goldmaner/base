<!-- templates/tela_inicial.html -->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>P√°gina Inicial - M√≥dulo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    body { background-color: #f8f9fa; padding-top:50px; }
    .main-container { max-width:900px; margin:0 auto; padding:30px; background:#fff; border-radius:10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .btn-module { 
      width:100%; 
      padding:15px 20px; 
      margin-bottom:10px; 
      font-size:1rem; 
      color:white; 
      border:none; 
      text-align:left; 
      display:flex; 
      align-items:center; 
      transition: all 0.2s;
      border-radius: 5px;
    }
    .btn-module:hover {
      transform: translateX(5px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .btn-module i {
      font-size: 1.3rem;
      margin-right: 12px;
      min-width: 24px;
    }
    .accordion-button:not(.collapsed) {
      background-color: #f8f9fa;
      color: #000;
    }
    .accordion-button {
      font-size: 1.1rem;
      font-weight: 600;
      padding: 15px 20px;
    }
    .accordion-body {
      padding: 20px;
      background-color: #fafbfc;
    }
    .section-badge {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 10px;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <div class="container main-container">
    <div class="d-flex justify-content-between align-items-center">
      <h2>
        {% if user['tipo_usuario'] == 'Agente DGP' %}
          M√≥dulo de Divis√£o de Gest√£o de Parcerias
        {% else %}
          M√≥dulo de An√°lise de Contas
        {% endif %}
      </h2>
      <div>
        <small>Logado como: <strong>{{ user['email'] }}</strong></small><br>
        <small>Tipo: <span class="badge bg-info">{{ user['tipo_usuario'] }}</span></small>
        {% if user['tipo_usuario'] == 'Agente P√∫blico' %}
        <button type="button" class="btn btn-sm btn-success ms-2" onclick="verUsuariosAtivos()" title="Ver usu√°rios online">
          <i class="bi bi-people-fill"></i> <span id="badge-usuarios-ativos" class="badge bg-light text-dark">0</span> online
        </button>
        {% endif %}
        <br>
        <button type="button" class="btn btn-sm btn-outline-primary mt-2 me-2" data-bs-toggle="modal" data-bs-target="#modalAlterarSenha">
          <i class="bi bi-key"></i> Alterar Senha
        </button>
        <a href="{{ url_for('auth.logout') }}" class="btn btn-sm btn-outline-secondary mt-2">Sair</a>
      </div>
    </div>

    <div class="mt-4">
      {% set user_acessos = user.get('acessos', '') %}
      {% set is_admin = user['tipo_usuario'] == 'Agente P√∫blico' %}
      
      <!-- Accordion Principal -->
      <div class="accordion" id="accordionModulos">
        
        <!-- Se√ß√£o: Geral -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGeral">
              <i class="bi bi-house-door me-2"></i> Geral
              <span class="badge bg-primary section-badge">4</span>
            </button>
          </h2>
          <div id="collapseGeral" class="accordion-collapse collapse show" data-bs-parent="#accordionModulos">
            <div class="accordion-body">
              <div class="row g-2">
                {% if is_admin or 'parcerias' in user_acessos %}
                <div class="col-md-6">
                  <a href="{{ url_for('parcerias.listar') }}" class="btn btn-module" style="background-color:#0d6efd;">
                    <i class="bi bi-people-fill"></i> Parcerias
                  </a>
                </div>
                {% endif %}
                
                {% if is_admin or 'orcamento' in user_acessos %}
                <div class="col-md-6">
                  <a href="{{ url_for('orcamento.listar') }}" class="btn btn-module" style="background-color:#0d6efd;">
                    <i class="bi bi-currency-dollar"></i> Or√ßamento Anual
                  </a>
                </div>
                {% endif %}
                
                {% if is_admin or 'certidoes' in user_acessos %}
                <div class="col-md-6">
                  <a href="{{ url_for('certidoes.index') }}" class="btn btn-module" style="background-color:#9C27B0;">
                    <i class="bi bi-file-earmark-check"></i> Central de Certid√µes
                  </a>
                </div>
                {% endif %}
                
                {% if is_admin or 'parcerias_notificacoes' in user_acessos %}
                <div class="col-md-6">
                  <a href="{{ url_for('parcerias_notificacoes.listar') }}" class="btn btn-module" style="background-color:#fd7e14;">
                    <i class="bi bi-envelope-fill"></i> Of√≠cios, Documentos e Notifica√ß√µes
                  </a>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        
        <!-- Se√ß√£o: An√°lise de Contas -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAnalises">
              <i class="bi bi-clipboard-check me-2"></i> An√°lise de Contas
              <span class="badge bg-success section-badge">4</span>
            </button>
          </h2>
          <div id="collapseAnalises" class="accordion-collapse collapse" data-bs-parent="#accordionModulos">
            <div class="accordion-body">
              <div class="row g-2">
                {% if is_admin or 'analises' in user_acessos %}
                <div class="col-md-6">
                  <a href="{{ url_for('analises_pc.meus_processos') }}" class="btn btn-module" style="background-color:#198754;">
                    <i class="bi bi-plus-circle-fill"></i> Iniciar ou prosseguir an√°lise
                  </a>
                </div>
                <div class="col-md-6">
                  <a href="{{ url_for('analises.listar') }}" class="btn btn-module" style="background-color:#198754;">
                    <i class="bi bi-arrow-clockwise"></i> Menu de Presta√ß√µes de Contas
                  </a>
                </div>
                {% endif %}
                
                {% if (is_admin or 'pesquisa_parcerias' in user_acessos) and user['tipo_usuario'] in ['Agente DAC', 'Agente P√∫blico'] %}
                <div class="col-md-6">
                  <a href="{{ url_for('pesquisa_parcerias.index') }}" class="btn btn-module" style="background-color:#20c997;">
                    <i class="bi bi-search"></i> Pesquisa de Parcerias
                  </a>
                </div>
                {% endif %}
                
                {% if is_admin or 'gestao_financeira' in user_acessos %}
                <div class="col-md-6">
                  <a href="{{ url_for('gestao_financeira.index') }}" class="btn btn-module" style="background-color:#28a745;">
                    <i class="bi bi-cash-coin"></i> Gest√£o Financeira
                  </a>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        
        <!-- Se√ß√£o: Gest√£o de Parcerias -->
        {% if is_admin or 'cents' in user_acessos or 'celebracao_parcerias' in user_acessos %}
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGP">
              <i class="bi bi-building me-2"></i> Gest√£o de Parcerias
              <span class="badge bg-purple section-badge" style="background-color:#764ba2;">2</span>
            </button>
          </h2>
          <div id="collapseGP" class="accordion-collapse collapse" data-bs-parent="#accordionModulos">
            <div class="accordion-body">
              <div class="row g-2">
                {% if is_admin or 'cents' in user_acessos %}
                <div class="col-md-6">
                  <a href="{{ url_for('cents.index') }}" class="btn btn-module" style="background-color:#764ba2;">
                    <i class="bi bi-file-earmark-medical"></i> CENTS
                  </a>
                </div>
                {% endif %}
                {% if is_admin or 'celebracao_parcerias' in user_acessos %}
                <div class="col-md-6">
                  <a href="{{ url_for('celebracao_parcerias.index') }}" class="btn btn-module" style="background-color:#764ba2;">
                    <i class="bi bi-people-fill"></i> Celebra√ß√£o de Parcerias
                  </a>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        
        <!-- Se√ß√£o: Departamento de Parcerias -->
        {% if is_admin or 'editais' in user_acessos or 'gestao_orcamentaria' in user_acessos %}
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDP">
              <i class="bi bi-megaphone me-2"></i> Departamento de Parcerias
              <span class="badge bg-info section-badge">2</span>
            </button>
          </h2>
          <div id="collapseDP" class="accordion-collapse collapse" data-bs-parent="#accordionModulos">
            <div class="accordion-body">
              <div class="row g-2">
                {% if is_admin or 'editais' in user_acessos %}
                <div class="col-md-6">
                  <a href="{{ url_for('editais.listar') }}" class="btn btn-module" style="background-color:#0dcaf0; color:#000;">
                    <i class="bi bi-megaphone"></i> Edital
                  </a>
                </div>
                {% endif %}
                {% if is_admin or 'gestao_orcamentaria' in user_acessos %}
                <div class="col-md-6">
                  <a href="{{ url_for('gestao_orcamentaria.index') }}" class="btn btn-module" style="background-color:#764ba2; color:#fff;">
                    <i class="bi bi-calculator"></i> Gest√£o Or√ßament√°ria
                  </a>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        
        <!-- Se√ß√£o: Gest√£o de Dados -->
        {% if is_admin or 'listas' in user_acessos or 'modelos_textos' in user_acessos %}
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDados">
              <i class="bi bi-database me-2"></i> Gest√£o de Dados
              <span class="badge bg-warning text-dark section-badge">2</span>
            </button>
          </h2>
          <div id="collapseDados" class="accordion-collapse collapse" data-bs-parent="#accordionModulos">
            <div class="accordion-body">
              <div class="row g-2">
                {% if is_admin or 'listas' in user_acessos %}
                <div class="col-md-6">
                  <a href="{{ url_for('listas.index') }}" class="btn btn-module" style="background-color:#ffc107; color:#000;">
                    <i class="bi bi-list-ul"></i> Listas Suspensas
                  </a>
                </div>
                {% endif %}
                
                {% if is_admin or 'modelos_textos' in user_acessos %}
                <div class="col-md-6">
                  <a href="{{ url_for('main.modelos_textos_index') }}" class="btn btn-module" style="background-color:#ffc107; color:#000;">
                    <i class="bi bi-file-text"></i> Modelos de Texto
                  </a>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        
        <!-- Se√ß√£o: Gest√£o de Pessoas e Usu√°rios -->
        {% if is_admin or 'usuarios' in user_acessos or 'ferias' in user_acessos %}
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePessoas">
              <i class="bi bi-person-badge me-2"></i> Gest√£o de Pessoas e Usu√°rios
              <span class="badge bg-secondary section-badge">2</span>
            </button>
          </h2>
          <div id="collapsePessoas" class="accordion-collapse collapse" data-bs-parent="#accordionModulos">
            <div class="accordion-body">
              <div class="row g-2">
                {% if is_admin or 'usuarios' in user_acessos %}
                <div class="col-md-6">
                  <a href="#" class="btn btn-module" style="background-color:#6f42c1;" data-bs-toggle="modal" data-bs-target="#modalUsuarios">
                    <i class="bi bi-people"></i> Gerenciar Usu√°rios
                  </a>
                </div>
                {% endif %}
                
                {% if is_admin or 'ferias' in user_acessos %}
                <div class="col-md-6">
                  <a href="{{ url_for('ferias.listar') }}" class="btn btn-module" style="background-color:#6f42c1;">
                    <i class="bi bi-calendar-check"></i> F√©rias
                  </a>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        
        <!-- Se√ß√£o: Op√ß√µes de Administrador -->
        {% if is_admin or 'portarias' in user_acessos %}
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAdmin">
              <i class="bi bi-gear me-2"></i> Op√ß√µes de Administrador
              <span class="badge bg-danger section-badge">1</span>
            </button>
          </h2>
          <div id="collapseAdmin" class="accordion-collapse collapse" data-bs-parent="#accordionModulos">
            <div class="accordion-body">
              <div class="row g-2">
                {% if is_admin or 'portarias' in user_acessos %}
                <div class="col-12">
                  <a href="{{ url_for('main.gerenciar_portarias') }}" class="btn btn-module" style="background-color:#dc3545;">
                    <i class="bi bi-file-earmark-text"></i> Gerenciar Portarias/Legisla√ß√µes
                  </a>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        
      </div>
    </div>
  </div>

  <!-- Modal de Gerenciamento de Usu√°rios -->
  <div class="modal fade" id="modalUsuarios" tabindex="-1" aria-labelledby="modalUsuariosLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="modalUsuariosLabel">
            <i class="bi bi-people-fill me-2"></i>Gerenciar Usu√°rios
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Bot√£o Adicionar Novo Usu√°rio -->
          <div class="mb-3">
            <button class="btn btn-success" onclick="mostrarFormNovo()">
              <i class="bi bi-plus-circle me-2"></i>Adicionar Novo Usu√°rio
            </button>
          </div>

          <!-- Filtros de Usu√°rios -->
          <div class="card mb-3">
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="filtroEmail" class="form-label">
                    <i class="bi bi-search me-1"></i>Buscar por E-mail
                  </label>
                  <input type="text" class="form-control" id="filtroEmail" 
                         placeholder="Digite o e-mail..." 
                         onkeyup="filtrarUsuarios()">
                </div>
                <div class="col-md-4">
                  <label for="filtroTipo" class="form-label">
                    <i class="bi bi-funnel me-1"></i>Filtrar por Tipo
                  </label>
                  <select class="form-select" id="filtroTipo" onchange="filtrarUsuarios()">
                    <option value="">Todos os tipos</option>
                    <option value="Agente P√∫blico">Agente P√∫blico</option>
                    <option value="Agente DAC">Agente DAC</option>
                    <option value="Agente DGP">Agente DGP</option>
                    <option value="Agente DP">Agente DP</option>
                    <option value="Externo">Externo</option>
                  </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                  <button class="btn btn-outline-secondary w-100" onclick="limparFiltros()">
                    <i class="bi bi-x-circle me-1"></i>Limpar
                  </button>
                </div>
              </div>
              <div class="mt-2">
                <small class="text-muted">
                  <i class="bi bi-info-circle me-1"></i>
                  <span id="contadorUsuarios">Carregando...</span>
                </small>
              </div>
            </div>
          </div>

          <!-- Formul√°rio de Novo Usu√°rio (inicialmente oculto) -->
          <div id="formNovoUsuario" class="card mb-3" style="display: none;">
            <div class="card-header bg-success text-white">
              <i class="bi bi-person-plus me-2"></i>Novo Usu√°rio
            </div>
            <div class="card-body">
              <form id="formCriarUsuario" onsubmit="criarUsuario(event)">
                <div class="mb-3">
                  <label for="novoEmail" class="form-label">E-mail</label>
                  <input type="email" class="form-control" id="novoEmail" required>
                </div>
                <div class="mb-3">
                  <label for="novaSenha" class="form-label">Senha Inicial</label>
                  <input type="text" class="form-control" id="novaSenha" required>
                  <small class="text-muted">A senha ser√° exibida apenas uma vez. Anote!</small>
                </div>
                <div class="mb-3">
                  <label for="novoTipo" class="form-label">Tipo de Usu√°rio</label>
                  <select class="form-select" id="novoTipo" required>
                    <option value="">-- Selecione --</option>
                    <option value="Agente P√∫blico">Agente P√∫blico (Admin)</option>
                    <option value="Agente DAC">Agente DAC</option>
                    <option value="Agente DGP">Agente DGP</option>
                    <option value="Agente DP">Agente DP</option>
                    <option value="Externo">Externo</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="novoDUsuario" class="form-label">Registro do Usu√°rio</label>
                  <input type="text" class="form-control" id="novoDUsuario" maxlength="20" placeholder="Ex: DAC, DGP, DP...">
                  <small class="text-muted">Campo opcional. M√°ximo 20 caracteres.</small>
                </div>
                <div class="d-flex gap-2">
                  <button type="submit" class="btn btn-success">
                    <i class="bi bi-check-circle me-2"></i>Criar
                  </button>
                  <button type="button" class="btn btn-secondary" onclick="cancelarFormNovo()">
                    <i class="bi bi-x-circle me-2"></i>Cancelar
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Lista de Usu√°rios -->
          <div id="listaUsuarios">
            <div class="text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
              </div>
            </div>
          </div>

          <!-- Pagina√ß√£o -->
          <div id="paginacaoUsuarios" class="mt-3 d-flex justify-content-between align-items-center" style="display: none !important;">
            <div>
              <select class="form-select form-select-sm d-inline-block w-auto" id="itensPorPagina" onchange="alterarItensPorPagina()">
                <option value="10">10 por p√°gina</option>
                <option value="20">20 por p√°gina</option>
                <option value="50">50 por p√°gina</option>
                <option value="999999">Todos</option>
              </select>
            </div>
            <nav>
              <ul class="pagination pagination-sm mb-0" id="listaPaginacao">
                <!-- P√°ginas ser√£o inseridas aqui -->
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Vari√°veis globais para armazenar usu√°rios e controle de pagina√ß√£o
    let todosUsuarios = [];
    let usuariosFiltrados = [];
    let paginaAtual = 1;
    let itensPorPagina = 10;

    // Carregar usu√°rios quando o modal √© aberto
    document.getElementById('modalUsuarios').addEventListener('shown.bs.modal', function () {
      carregarUsuarios();
    });

    function mostrarFormNovo() {
      document.getElementById('formNovoUsuario').style.display = 'block';
    }

    function cancelarFormNovo() {
      document.getElementById('formNovoUsuario').style.display = 'none';
      document.getElementById('formCriarUsuario').reset();
    }

    function limparFiltros() {
      document.getElementById('filtroEmail').value = '';
      document.getElementById('filtroTipo').value = '';
      filtrarUsuarios();
    }

    function filtrarUsuarios() {
      const filtroEmail = document.getElementById('filtroEmail').value.toLowerCase();
      const filtroTipo = document.getElementById('filtroTipo').value;

      usuariosFiltrados = todosUsuarios.filter(user => {
        const matchEmail = user.email.toLowerCase().includes(filtroEmail);
        const matchTipo = filtroTipo === '' || user.tipo_usuario === filtroTipo;
        return matchEmail && matchTipo;
      });

      paginaAtual = 1; // Resetar para primeira p√°gina ao filtrar
      atualizarExibicao();
    }

    function alterarItensPorPagina() {
      itensPorPagina = parseInt(document.getElementById('itensPorPagina').value);
      paginaAtual = 1;
      atualizarExibicao();
    }

    function irParaPagina(pagina) {
      paginaAtual = pagina;
      atualizarExibicao();
    }

    function atualizarExibicao() {
      const totalUsuarios = usuariosFiltrados.length;
      const totalPaginas = Math.ceil(totalUsuarios / itensPorPagina);
      
      // Atualizar contador
      document.getElementById('contadorUsuarios').textContent = 
        `Exibindo ${totalUsuarios} usu√°rio(s)${todosUsuarios.length !== totalUsuarios ? ' (filtrado de ' + todosUsuarios.length + ')' : ''}`;

      // Calcular √≠ndices da p√°gina atual
      const inicio = (paginaAtual - 1) * itensPorPagina;
      const fim = Math.min(inicio + itensPorPagina, totalUsuarios);
      const usuariosPagina = usuariosFiltrados.slice(inicio, fim);

      // Renderizar tabela
      renderizarTabela(usuariosPagina);

      // Atualizar pagina√ß√£o
      renderizarPaginacao(totalPaginas);
    }

    function renderizarTabela(usuarios) {
      const listaUsuariosDiv = document.getElementById('listaUsuarios');
      
      if (usuarios.length === 0) {
        listaUsuariosDiv.innerHTML = `
          <div class="alert alert-info">
            <i class="bi bi-info-circle-fill me-2"></i>
            Nenhum usu√°rio encontrado com os filtros aplicados.
          </div>`;
        return;
      }

      let html = '<div class="table-responsive"><table class="table table-hover">';
      html += '<thead class="table-dark"><tr>';
      html += '<th>ID</th><th>E-mail</th><th>Tipo</th><th>D. Usu√°rio</th><th>Data Cria√ß√£o</th><th class="text-center">A√ß√µes</th>';
      html += '</tr></thead><tbody>';
      
      usuarios.forEach(user => {
        html += '<tr>';
        html += `<td>${user.id}</td>`;
        html += `<td>${user.email}</td>`;
        
        // Definir cor do badge baseado no tipo
        let badgeClass = 'bg-secondary';
        if (user.tipo_usuario === 'Agente P√∫blico') badgeClass = 'bg-primary';
        else if (user.tipo_usuario.startsWith('Agente')) badgeClass = 'bg-info';
        else if (user.tipo_usuario === 'Externo') badgeClass = 'bg-warning text-dark';
        
        html += `<td><span class="badge ${badgeClass}">${user.tipo_usuario}</span></td>`;
        html += `<td>${user.d_usuario || '<span class="text-muted">-</span>'}</td>`;
        html += `<td>${new Date(user.data_criacao).toLocaleDateString('pt-BR')}</td>`;
        html += `<td class="text-center">
          <button class="btn btn-sm btn-info me-1" onclick="resetarSenha(${user.id}, '${user.email}')" title="Resetar Senha">
            <i class="bi bi-key"></i>
          </button>
          <button class="btn btn-sm btn-warning me-1" onclick="editarUsuario(${user.id}, '${user.email}', '${user.tipo_usuario}', '${user.d_usuario || ''}')" title="Editar">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-sm btn-danger" onclick="excluirUsuario(${user.id}, '${user.email}')" title="Excluir">
            <i class="bi bi-trash"></i>
          </button>
        </td>`;
        html += '</tr>';
      });
      
      html += '</tbody></table></div>';
      listaUsuariosDiv.innerHTML = html;
    }

    function renderizarPaginacao(totalPaginas) {
      const paginacaoDiv = document.getElementById('paginacaoUsuarios');
      const listaPaginacao = document.getElementById('listaPaginacao');

      if (totalPaginas <= 1) {
        paginacaoDiv.style.display = 'none';
        return;
      }

      paginacaoDiv.style.display = 'flex';
      let html = '';

      // Bot√£o Anterior
      html += `<li class="page-item ${paginaAtual === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="irParaPagina(${paginaAtual - 1}); return false;">Anterior</a>
      </li>`;

      // P√°ginas numeradas (mostrar no m√°ximo 5 p√°ginas)
      let inicioPaginas = Math.max(1, paginaAtual - 2);
      let fimPaginas = Math.min(totalPaginas, inicioPaginas + 4);
      
      if (fimPaginas - inicioPaginas < 4) {
        inicioPaginas = Math.max(1, fimPaginas - 4);
      }

      if (inicioPaginas > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="irParaPagina(1); return false;">1</a></li>`;
        if (inicioPaginas > 2) {
          html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
      }

      for (let i = inicioPaginas; i <= fimPaginas; i++) {
        html += `<li class="page-item ${i === paginaAtual ? 'active' : ''}">
          <a class="page-link" href="#" onclick="irParaPagina(${i}); return false;">${i}</a>
        </li>`;
      }

      if (fimPaginas < totalPaginas) {
        if (fimPaginas < totalPaginas - 1) {
          html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        html += `<li class="page-item"><a class="page-link" href="#" onclick="irParaPagina(${totalPaginas}); return false;">${totalPaginas}</a></li>`;
      }

      // Bot√£o Pr√≥ximo
      html += `<li class="page-item ${paginaAtual === totalPaginas ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="irParaPagina(${paginaAtual + 1}); return false;">Pr√≥ximo</a>
      </li>`;

      listaPaginacao.innerHTML = html;
    }

    async function carregarUsuarios() {
      console.log('[DEBUG] Iniciando carregamento de usu√°rios...');
      const listaUsuariosDiv = document.getElementById('listaUsuarios');
      listaUsuariosDiv.innerHTML = '<div class="text-center p-3"><div class="spinner-border" role="status"><span class="visually-hidden">Carregando...</span></div><p class="mt-2">Carregando usu√°rios...</p></div>';
      
      try {
        console.log('[DEBUG] Fazendo requisi√ß√£o para /api/usuarios');
        const response = await fetch('/api/usuarios');
        console.log('[DEBUG] Response status:', response.status);
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.erro || 'Erro ao carregar usu√°rios');
        }
        
        todosUsuarios = await response.json();
        usuariosFiltrados = [...todosUsuarios]; // C√≥pia inicial
        console.log('[DEBUG] Usu√°rios recebidos:', todosUsuarios.length);
        
        paginaAtual = 1;
        atualizarExibicao();
        
        console.log('[DEBUG] Tabela de usu√°rios renderizada com sucesso');
      } catch (error) {
        console.error('[ERRO] Erro ao carregar usu√°rios:', error);
        listaUsuariosDiv.innerHTML = `<div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <strong>Erro ao carregar usu√°rios:</strong> ${error.message}
          <br><small>Verifique o console do navegador (F12) para mais detalhes.</small>
        </div>`;
      }
    }

    async function criarUsuario(event) {
      event.preventDefault();
      
      const email = document.getElementById('novoEmail').value;
      const senha = document.getElementById('novaSenha').value;
      const tipo = document.getElementById('novoTipo').value;
      const d_usuario = document.getElementById('novoDUsuario').value;
      
      try {
        const response = await fetch('/api/usuarios', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, senha, tipo_usuario: tipo, d_usuario })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert(`Usu√°rio criado com sucesso!\n\nE-mail: ${email}\nSenha: ${senha}\n\nAnote a senha, ela n√£o ser√° exibida novamente!`);
          cancelarFormNovo();
          carregarUsuarios();
        } else {
          alert('Erro: ' + result.erro);
        }
      } catch (error) {
        console.error('Erro ao criar usu√°rio:', error);
        alert('Erro ao criar usu√°rio.');
      }
    }

    async function editarUsuario(id, email, tipo, d_usuario) {
      // Buscar dados completos do usu√°rio incluindo acessos
      let acessosAtuais = [];
      try {
        const response = await fetch(`/api/usuarios/${id}`);
        if (response.ok) {
          const userData = await response.json();
          acessosAtuais = userData.acessos ? userData.acessos.split(';').filter(a => a.trim()) : [];
        }
      } catch (error) {
        console.error('Erro ao buscar dados do usu√°rio:', error);
      }
      
      // Lista de todos os m√≥dulos/blueprints dispon√≠veis (ORDEM ATUALIZADA)
      const modulosDisponiveis = [
        // Geral
        { id: 'parcerias', nome: 'Parcerias', grupo: 'Geral' },
        { id: 'orcamento', nome: 'Or√ßamento Anual', grupo: 'Geral' },
        { id: 'certidoes', nome: 'Central de Certid√µes', grupo: 'Geral' },
        { id: 'parcerias_notificacoes', nome: 'Of√≠cios, Documentos e Notifica√ß√µes', grupo: 'Geral' },
        
        // An√°lise de Contas
        { id: 'analises', nome: 'Iniciar ou prosseguir an√°lise', grupo: 'An√°lise de Contas' },
        { id: 'analises', nome: 'Menu de Presta√ß√µes de Contas', grupo: 'An√°lise de Contas' },
        { id: 'pesquisa_parcerias', nome: 'Pesquisa de Parcerias', grupo: 'An√°lise de Contas' },
        { id: 'gestao_financeira', nome: 'Gest√£o Financeira', grupo: 'An√°lise de Contas' },
        
        // Gest√£o de Parcerias
        { id: 'cents', nome: 'CENTS', grupo: 'Gest√£o de Parcerias' },
        { id: 'celebracao_parcerias', nome: 'Celebra√ß√£o de Parcerias', grupo: 'Gest√£o de Parcerias' },
        
        // Departamento de Parcerias
        { id: 'editais', nome: 'Edital', grupo: 'Departamento de Parcerias' },
        { id: 'gestao_orcamentaria', nome: 'Gest√£o Or√ßament√°ria', grupo: 'Departamento de Parcerias' },
        
        // Gest√£o de Dados
        { id: 'listas', nome: 'Listas Suspensas', grupo: 'Gest√£o de Dados' },
        { id: 'modelos_textos', nome: 'Modelos de Texto', grupo: 'Gest√£o de Dados' },
        
        // Gest√£o de Pessoas e Usu√°rios
        { id: 'usuarios', nome: 'Gerenciar Usu√°rios', grupo: 'Gest√£o de Pessoas e Usu√°rios' },
        { id: 'ferias', nome: 'F√©rias', grupo: 'Gest√£o de Pessoas e Usu√°rios' },
        
        // Op√ß√µes de Administrador
        { id: 'portarias', nome: 'Gerenciar Portarias/Legisla√ß√µes', grupo: 'Op√ß√µes de Administrador' },
        
        // M√≥dulos de An√°lise PC (sub-m√≥dulos t√©cnicos)
        { id: 'conc_bancaria', nome: 'Concilia√ß√£o Banc√°ria', grupo: 'M√≥dulos T√©cnicos' },
        { id: 'conc_rendimentos', nome: 'Rendimentos', grupo: 'M√≥dulos T√©cnicos' },
        { id: 'conc_contrapartida', nome: 'Contrapartida', grupo: 'M√≥dulos T√©cnicos' },
        { id: 'conc_relatorio', nome: 'Relat√≥rio de Concilia√ß√£o', grupo: 'M√≥dulos T√©cnicos' }
      ];
      
      // Agrupar m√≥dulos
      const grupos = {};
      modulosDisponiveis.forEach(mod => {
        if (!grupos[mod.grupo]) grupos[mod.grupo] = [];
        grupos[mod.grupo].push(mod);
      });
      
      // Gerar HTML dos checkboxes agrupados
      let checkboxesHtml = '';
      Object.keys(grupos).forEach(grupo => {
        checkboxesHtml += `<div class="mb-3">`;
        checkboxesHtml += `<h6 class="text-muted mb-2"><i class="bi bi-folder me-1"></i>${grupo}</h6>`;
        grupos[grupo].forEach(mod => {
          const checked = tipo === 'Agente P√∫blico' || acessosAtuais.includes(mod.id) ? 'checked' : '';
          const disabled = tipo === 'Agente P√∫blico' ? 'disabled' : '';
          checkboxesHtml += `
            <div class="form-check">
              <input class="form-check-input acesso-checkbox" type="checkbox" 
                     value="${mod.id}" id="acesso_${mod.id}" ${checked} ${disabled}>
              <label class="form-check-label" for="acesso_${mod.id}">
                ${mod.nome}
              </label>
            </div>`;
        });
        checkboxesHtml += `</div>`;
      });
      
      // Criar formul√°rio modal usando Bootstrap
      const modalHtml = `
        <div class="modal fade" id="modalEditarUsuario" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Editar Usu√°rio: ${email}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">Tipo de Usu√°rio</label>
                  <select class="form-select" id="editTipo" onchange="atualizarAcessosDisponiveis(this.value)">
                    <option value="Agente P√∫blico" ${tipo === 'Agente P√∫blico' ? 'selected' : ''}>Agente P√∫blico (Admin)</option>
                    <option value="Agente DAC" ${tipo === 'Agente DAC' ? 'selected' : ''}>Agente DAC</option>
                    <option value="Agente DGP" ${tipo === 'Agente DGP' ? 'selected' : ''}>Agente DGP</option>
                    <option value="Agente DP" ${tipo === 'Agente DP' ? 'selected' : ''}>Agente DP</option>
                    <option value="Externo" ${tipo === 'Externo' ? 'selected' : ''}>Externo</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Registro do Usu√°rio</label>
                  <input type="text" class="form-control" id="editDUsuario" value="${d_usuario}" maxlength="20" placeholder="Ex: DAC, DGP, DP...">
                  <small class="text-muted">M√°ximo 20 caracteres</small>
                </div>
                
                <hr>
                
                <div class="mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label mb-0"><i class="bi bi-key-fill me-2"></i>Controle de Acessos</label>
                    <div id="acessosControls">
                      <button type="button" class="btn btn-sm btn-outline-primary me-1" onclick="marcarTodos()">
                        <i class="bi bi-check-all"></i> Marcar Todos
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="desmarcarTodos()">
                        <i class="bi bi-x"></i> Desmarcar Todos
                      </button>
                    </div>
                  </div>
                  <small class="text-muted d-block mb-3">
                    <i class="bi bi-info-circle me-1"></i>
                    Agente P√∫blico tem acesso total (n√£o edit√°vel). Para outros tipos, selecione os m√≥dulos permitidos.
                  </small>
                  <div id="checkboxesAcessos" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; background-color: #f8f9fa;">
                    ${checkboxesHtml}
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="salvarEdicao(${id})">
                  <i class="bi bi-check-circle me-2"></i>Salvar
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Remover modal antigo se existir
      const oldModal = document.getElementById('modalEditarUsuario');
      if (oldModal) oldModal.remove();
      
      // Adicionar novo modal ao body
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Mostrar modal
      const modal = new bootstrap.Modal(document.getElementById('modalEditarUsuario'));
      modal.show();
    }
    
    function atualizarAcessosDisponiveis(tipoUsuario) {
      const checkboxes = document.querySelectorAll('.acesso-checkbox');
      const controls = document.getElementById('acessosControls');
      
      if (tipoUsuario === 'Agente P√∫blico') {
        // Agente P√∫blico: marcar todos e desabilitar
        checkboxes.forEach(cb => {
          cb.checked = true;
          cb.disabled = true;
        });
        controls.style.display = 'none';
      } else {
        // Outros: habilitar edi√ß√£o
        checkboxes.forEach(cb => {
          cb.disabled = false;
        });
        controls.style.display = 'block';
      }
    }
    
    function marcarTodos() {
      const checkboxes = document.querySelectorAll('.acesso-checkbox:not([disabled])');
      checkboxes.forEach(cb => cb.checked = true);
    }
    
    function desmarcarTodos() {
      const checkboxes = document.querySelectorAll('.acesso-checkbox:not([disabled])');
      checkboxes.forEach(cb => cb.checked = false);
    }
    
    async function salvarEdicao(id) {
      const novoTipo = document.getElementById('editTipo').value;
      const novoDUsuario = document.getElementById('editDUsuario').value.trim();
      
      // Coletar acessos selecionados
      const checkboxes = document.querySelectorAll('.acesso-checkbox:checked');
      const acessosSelecionados = Array.from(checkboxes).map(cb => cb.value);
      const acessosString = acessosSelecionados.join(';');
      
      console.log('[DEBUG] Salvando usu√°rio:', { id, novoTipo, novoDUsuario, acessos: acessosString });
      
      try {
        const response = await fetch(`/api/usuarios/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            tipo_usuario: novoTipo,
            d_usuario: novoDUsuario,
            acessos: acessosString
          })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          // Avisar que as permiss√µes foram atualizadas
          let mensagem = 'Usu√°rio atualizado com sucesso!';
          
          // Se o usu√°rio editado est√° logado neste momento
          const userEmailElement = document.getElementById('usuarioEmailEdit');
          if (userEmailElement) {
            const userEmail = userEmailElement.value;
            const sessionEmail = '{{ session.get("email", "") }}';
            
            if (userEmail === sessionEmail) {
              mensagem += '\n\n‚ö†Ô∏è ATEN√á√ÉO: Voc√™ editou suas pr√≥prias permiss√µes!\nAs altera√ß√µes foram aplicadas imediatamente.';
            } else {
              mensagem += '\n\nSe o usu√°rio estiver logado, as permiss√µes ser√£o atualizadas automaticamente na pr√≥xima a√ß√£o.';
            }
          }
          
          alert(mensagem);
          bootstrap.Modal.getInstance(document.getElementById('modalEditarUsuario')).hide();
          carregarUsuarios();
        } else {
          alert('Erro: ' + result.erro);
        }
      } catch (error) {
        console.error('Erro ao editar usu√°rio:', error);
        alert('Erro ao editar usu√°rio.');
      }
    }

    async function excluirUsuario(id, email) {
      if (!confirm(`Tem certeza que deseja excluir o usu√°rio "${email}"?\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
        return;
      }
      
      try {
        const response = await fetch(`/api/usuarios/${id}`, {
          method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('Usu√°rio exclu√≠do com sucesso!');
          carregarUsuarios();
        } else {
          alert('Erro: ' + result.erro);
        }
      } catch (error) {
        console.error('Erro ao excluir usu√°rio:', error);
        alert('Erro ao excluir usu√°rio.');
      }
    }

    async function resetarSenha(id, email) {
      const novaSenha = prompt(`Resetar senha do usu√°rio "${email}".\n\nDigite a nova senha:`, '');
      
      if (novaSenha === null || novaSenha.trim() === '') {
        return;
      }
      
      if (novaSenha.length < 4) {
        alert('Senha muito curta! M√≠nimo 4 caracteres.');
        return;
      }
      
      try {
        const response = await fetch(`/api/usuarios/${id}/resetar-senha`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nova_senha: novaSenha })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert(`Senha resetada com sucesso!\n\nE-mail: ${email}\nNova Senha: ${novaSenha}\n\nAnote a senha, ela n√£o ser√° exibida novamente!`);
          carregarUsuarios();
        } else {
          alert('Erro: ' + result.erro);
        }
      } catch (error) {
        console.error('Erro ao resetar senha:', error);
        alert('Erro ao resetar senha.');
      }
    }
    
    // Verificar se h√° aviso de sess√£o ativa
    async function verificarSessaoAtiva() {
      try {
        const response = await fetch('/api/verificar-sessao-ativa');
        const result = await response.json();
        
        if (result.sessao_ativa) {
          setTimeout(() => {
            const msg = `‚ö†Ô∏è AVISO DE SESS√ÉO\n\n` +
                       `Voc√™ j√° estava logado em outro dispositivo/navegador.\n\n` +
                       `Sua sess√£o anterior foi substitu√≠da por este novo login.\n\n` +
                       `Se voc√™ n√£o reconhece esta atividade, altere sua senha imediatamente.`;
            alert(msg);
          }, 500);
        }
      } catch (error) {
        console.error('Erro ao verificar sess√£o:', error);
      }
    }
    
    // Executar verifica√ß√£o ao carregar p√°gina
    document.addEventListener('DOMContentLoaded', function() {
      verificarSessaoAtiva();
      
      // Configurar bot√µes de toggle senha
      const configurarToggleSenha = function() {
        const modal = document.getElementById('modalAlterarSenha');
        const inputGroups = modal.querySelectorAll('.input-group');
        
        inputGroups.forEach((group) => {
          const input = group.querySelector('input[type="password"], input[type="text"]');
          const button = group.querySelector('button');
          const icon = button ? button.querySelector('i') : null;
          
          if (input && button && icon) {
            // Garantir que o input seja sempre type="text" e usar CSS para ocultar
            input.setAttribute('data-password-field', 'true');
            
            // Se estiver como password, converter para text e marcar como oculto
            if (input.type === 'password') {
              input.type = 'text';
              input.style.webkitTextSecurity = 'disc';
              input.style.textSecurity = 'disc';
              input.setAttribute('data-showing', 'false');
            }
            
            // Clonar bot√£o para remover listeners antigos
            const buttonClone = button.cloneNode(true);
            button.parentNode.replaceChild(buttonClone, button);
            
            // Adicionar listener
            buttonClone.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              
              const iconAtual = buttonClone.querySelector('i');
              const showing = input.getAttribute('data-showing') === 'true';
              
              console.log(`Toggle senha em ${input.id}: ${showing ? 'ocultar' : 'mostrar'}, valor atual: "${input.value}"`);
              
              if (showing) {
                // Ocultar
                input.style.webkitTextSecurity = 'disc';
                input.style.textSecurity = 'disc';
                input.setAttribute('data-showing', 'false');
                iconAtual.className = 'bi bi-eye';
              } else {
                // Mostrar
                input.style.webkitTextSecurity = 'none';
                input.style.textSecurity = 'none';
                input.setAttribute('data-showing', 'true');
                iconAtual.className = 'bi bi-eye-slash';
              }
              
              console.log(`Depois do toggle: valor="${input.value}"`);
            });
          }
        });
      };
      
      // Configurar quando modal abrir
      const modalAlterarSenha = document.getElementById('modalAlterarSenha');
      if (modalAlterarSenha) {
        modalAlterarSenha.addEventListener('shown.bs.modal', function() {
          // Resetar campos para password
          ['senhaAtual', 'novaSenha', 'confirmaSenha'].forEach(id => {
            const input = document.getElementById(id);
            const icon = document.getElementById('icon-' + id);
            if (input && icon) {
              input.type = 'password';
              icon.className = 'bi bi-eye';
            }
          });
          
          // Configurar event listeners
          configurarToggleSenha();
        });
      }
    });

    // Fun√ß√£o para alterar senha
    window.alterarSenha = async function() {
      console.log('üîµ INICIANDO alterarSenha()');
      
      // Buscar TODOS os inputs no modal PRIMEIRO
      const modal = document.getElementById('modalAlterarSenha');
      const todosInputs = modal.querySelectorAll('input');
      console.log(`üîç Total de inputs no modal: ${todosInputs.length}`);
      
      // Capturar valores DIRETAMENTE do querySelectorAll
      let senhaAtual = '';
      let novaSenha = '';
      let confirmaSenha = '';
      
      todosInputs.forEach((input, index) => {
        console.log(`   Input ${index + 1}: id="${input.id}", type="${input.type}", value="${input.value}"`);
        
        if (input.id === 'senhaAtual') {
          senhaAtual = input.value;
          console.log(`   ‚úÖ Capturado senhaAtual: "${senhaAtual}"`);
        } else if (input.id === 'novaSenha') {
          novaSenha = input.value;
          console.log(`   ‚úÖ Capturado novaSenha: "${novaSenha}"`);
        } else if (input.id === 'confirmaSenha') {
          confirmaSenha = input.value;
          console.log(`   ‚úÖ Capturado confirmaSenha: "${confirmaSenha}"`);
        }
      });
      
      const mensagemDiv = document.getElementById('mensagemAlterarSenha');

      console.log('üîê Valores finais:', {
        senhaAtual: senhaAtual,
        novaSenha: novaSenha,
        confirmaSenha: confirmaSenha
      });

      // Valida√ß√µes frontend
      if (!senhaAtual || !novaSenha || !confirmaSenha) {
        mensagemDiv.className = 'alert alert-warning';
        mensagemDiv.textContent = 'Por favor, preencha todos os campos.';
        mensagemDiv.classList.remove('d-none');
        return;
      }

      if (novaSenha.length < 6) {
        mensagemDiv.className = 'alert alert-warning';
        mensagemDiv.textContent = 'A nova senha deve ter no m√≠nimo 6 caracteres.';
        mensagemDiv.classList.remove('d-none');
        return;
      }

      if (novaSenha !== confirmaSenha) {
        mensagemDiv.className = 'alert alert-warning';
        mensagemDiv.textContent = 'A nova senha e a confirma√ß√£o n√£o coincidem.';
        mensagemDiv.classList.remove('d-none');
        return;
      }

      try {
        const response = await fetch('/api/alterar-minha-senha', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            senha_atual: senhaAtual,
            nova_senha: novaSenha,
            confirma_senha: confirmaSenha
          })
        });

        const result = await response.json();

        if (response.ok) {
          mensagemDiv.className = 'alert alert-success';
          mensagemDiv.textContent = result.mensagem;
          mensagemDiv.classList.remove('d-none');
          
          // Limpar campos
          document.getElementById('formAlterarSenha').reset();
          
          // Fechar modal ap√≥s 2 segundos
          setTimeout(() => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalAlterarSenha'));
            modal.hide();
            mensagemDiv.classList.add('d-none');
          }, 2000);
        } else {
          mensagemDiv.className = 'alert alert-danger';
          mensagemDiv.textContent = result.erro || 'Erro ao alterar senha.';
          mensagemDiv.classList.remove('d-none');
        }
      } catch (error) {
        console.error('Erro ao alterar senha:', error);
        mensagemDiv.className = 'alert alert-danger';
        mensagemDiv.textContent = 'Erro ao conectar com o servidor.';
        mensagemDiv.classList.remove('d-none');
      }
    }
  </script>

  <!-- Modal de Alterar Senha -->
  <div class="modal fade" id="modalAlterarSenha" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-key"></i> Alterar Minha Senha</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <form id="formAlterarSenha">
            <div class="mb-3">
              <label for="senhaAtual" class="form-label">Senha Atual</label>
              <div class="input-group">
                <input type="password" class="form-control" id="senhaAtual" required>
                <button class="btn btn-outline-secondary" type="button">
                  <i class="bi bi-eye" id="icon-senhaAtual"></i>
                </button>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="novaSenha" class="form-label">Nova Senha (m√≠nimo 6 caracteres)</label>
              <div class="input-group">
                <input type="password" class="form-control" id="novaSenha" required minlength="6">
                <button class="btn btn-outline-secondary" type="button">
                  <i class="bi bi-eye" id="icon-novaSenha"></i>
                </button>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="confirmaSenha" class="form-label">Confirmar Nova Senha</label>
              <div class="input-group">
                <input type="password" class="form-control" id="confirmaSenha" required minlength="6">
                <button class="btn btn-outline-secondary" type="button">
                  <i class="bi bi-eye" id="icon-confirmaSenha"></i>
                </button>
              </div>
            </div>

            <div id="mensagemAlterarSenha" class="alert d-none"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="alterarSenha()">
            <i class="bi bi-check-lg"></i> Alterar Senha
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Usu√°rios Ativos -->
  <div class="modal fade" id="modalUsuariosAtivos" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-people-fill"></i> Usu√°rios Online</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <small class="text-muted">
              <i class="bi bi-info-circle"></i> Mostrando usu√°rios com atividade nos √∫ltimos 15 minutos
            </small>
          </div>
          
          <!-- Filtro por Tipo de Usu√°rio -->
          <div class="mb-3">
            <label for="filtroTipoAtivos" class="form-label">
              <i class="bi bi-funnel"></i> Filtrar por Tipo
            </label>
            <select class="form-select" id="filtroTipoAtivos" onchange="filtrarUsuariosAtivos()">
              <option value="">Todos os tipos</option>
              <option value="Agente P√∫blico">Agente P√∫blico</option>
              <option value="Agente DAC">Agente DAC</option>
              <option value="Agente DGP">Agente DGP</option>
              <option value="Agente DP">Agente DP</option>
              <option value="Externo">Externo</option>
            </select>
          </div>
          
          <div id="listaUsuariosAtivos">
            <div class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          <button type="button" class="btn btn-primary" onclick="carregarUsuariosAtivos()">
            <i class="bi bi-arrow-clockwise"></i> Atualizar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Vari√°vel global para armazenar todos os usu√°rios ativos
    let todosUsuariosAtivos = [];

    // Fun√ß√£o para ver usu√°rios ativos
    function verUsuariosAtivos() {
      const modal = new bootstrap.Modal(document.getElementById('modalUsuariosAtivos'));
      modal.show();
      carregarUsuariosAtivos();
    }

    // Fun√ß√£o para carregar lista de usu√°rios ativos
    async function carregarUsuariosAtivos() {
      const lista = document.getElementById('listaUsuariosAtivos');
      
      try {
        lista.innerHTML = `
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Carregando...</span>
            </div>
          </div>
        `;
        
        const response = await fetch('/api/usuarios-ativos');
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.erro || 'Erro ao carregar usu√°rios');
        }
        
        // Armazenar todos os usu√°rios
        todosUsuariosAtivos = data.usuarios || [];
        
        // Resetar filtro
        document.getElementById('filtroTipoAtivos').value = '';
        
        // Renderizar lista
        filtrarUsuariosAtivos();
        
      } catch (error) {
        console.error('Erro ao carregar usu√°rios ativos:', error);
        lista.innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> Erro ao carregar lista: ${error.message}
          </div>
        `;
      }
    }

    // Fun√ß√£o para filtrar usu√°rios ativos por tipo
    function filtrarUsuariosAtivos() {
      const lista = document.getElementById('listaUsuariosAtivos');
      const filtroTipo = document.getElementById('filtroTipoAtivos').value;
      
      // Filtrar usu√°rios
      const usuariosFiltrados = filtroTipo === '' 
        ? todosUsuariosAtivos 
        : todosUsuariosAtivos.filter(user => user.tipo_usuario === filtroTipo);
      
      if (usuariosFiltrados.length === 0) {
        lista.innerHTML = `
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> ${filtroTipo ? 'Nenhum usu√°rio ativo com este tipo.' : 'Nenhum usu√°rio ativo no momento.'}
          </div>
        `;
        return;
      }
      
      // Montar HTML da lista
      let html = '<div class="list-group">';
      
      usuariosFiltrados.forEach(user => {
        const corBadge = user.segundos_inativo < 60 ? 'success' : user.segundos_inativo < 300 ? 'primary' : 'secondary';
        const iconeDepartamento = user.d_usuario ? `<small class="text-muted"><i class="bi bi-building"></i> ${user.d_usuario}</small>` : '';
        
        html += `
          <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1">
                  <i class="bi bi-person-circle"></i> ${user.email}
                </h6>
                <div>
                  <span class="badge bg-info">${user.tipo_usuario}</span>
                  ${iconeDepartamento}
                </div>
              </div>
              <div class="text-end">
                <span class="badge bg-${corBadge}">
                  <i class="bi bi-clock"></i> ${user.tempo_ativo}
                </span>
              </div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      
      // Adicionar contador
      const total = todosUsuariosAtivos.length;
      const filtrados = usuariosFiltrados.length;
      const contador = filtroTipo && filtrados < total 
        ? `<div class="alert alert-light mt-2 mb-0"><small><i class="bi bi-funnel"></i> Exibindo ${filtrados} de ${total} usu√°rio(s)</small></div>`
        : `<div class="alert alert-light mt-2 mb-0"><small><i class="bi bi-people"></i> Total: ${total} usu√°rio(s) ativo(s)</small></div>`;
      
      lista.innerHTML = html + contador;
    }

    // Atualizar badge de usu√°rios ativos a cada 30 segundos
    async function atualizarBadgeUsuariosAtivos() {
      try {
        const response = await fetch('/api/usuarios-ativos');
        const data = await response.json();
        
        if (response.ok) {
          const badge = document.getElementById('badge-usuarios-ativos');
          if (badge) {
            badge.textContent = data.total;
          }
        }
      } catch (error) {
        console.error('Erro ao atualizar badge:', error);
      }
    }

    // Configurar atualiza√ß√£o autom√°tica do badge
    document.addEventListener('DOMContentLoaded', function() {
      const badge = document.getElementById('badge-usuarios-ativos');
      if (badge) {
        // Atualizar imediatamente
        atualizarBadgeUsuariosAtivos();
        
        // Atualizar a cada 30 segundos
        setInterval(atualizarBadgeUsuariosAtivos, 30000);
      }
    });
  </script>
</body>
</html>
