<!-- templates/tela_inicial.html -->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Página Inicial - Módulo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    body { background-color: #f8f9fa; padding-top:50px; }
    .main-container { max-width:800px; margin:0 auto; padding:30px; background:#fff; border-radius:10px; }
    .btn-main { width:100%; padding:20px; margin-bottom:20px; font-size:1.1rem; background-color:#0d6efd; color:white; border:none; text-align:left; }
    .btn-admin { background-color:#0dcaf0; color:#000; }
  </style>
</head>
<body>
  <div class="container main-container">
    <div class="d-flex justify-content-between align-items-center">
      <h2>
        {% if user['tipo_usuario'] == 'Agente DGP' %}
          Módulo de Divisão de Gestão de Parcerias
        {% else %}
          Módulo de Análise de Contas
        {% endif %}
      </h2>
      <div>
        <small>Logado como: <strong>{{ user['email'] }}</strong></small><br>
        <small>Tipo: <span class="badge bg-info">{{ user['tipo_usuario'] }}</span></small><br>
        <a href="{{ url_for('auth.logout') }}" class="btn btn-sm btn-outline-secondary mt-2">Sair</a>
      </div>
    </div>

    <div class="mt-4">
      <!-- Grid de 2-2-2 para os botões principais -->
      <div class="row g-3">
        {% set user_acessos = user.get('acessos', '') %}
        {% set is_admin = user['tipo_usuario'] == 'Agente Público' %}
        
        {% if is_admin or 'instrucoes' in user_acessos %}
        <div class="col-md-6">
          <a href="{{ url_for('instrucoes.listar_view') }}" class="btn btn-main">
            <i class="bi bi-plus-circle-fill me-2"></i>Iniciar ou prosseguir análise
          </a>
        </div>
        {% endif %}
        
        {% if is_admin or 'analises' in user_acessos %}
        <div class="col-md-6">
          <a href="{{ url_for('analises.listar') }}" class="btn btn-main">
            <i class="bi bi-arrow-clockwise me-2"></i>Menu de Prestações de Contas
          </a>
        </div>
        {% endif %}
        
        {% if is_admin or 'orcamento' in user_acessos %}
        <div class="col-md-6">
          <a href="{{ url_for('orcamento.listar') }}" class="btn btn-main">
            <i class="bi bi-currency-dollar me-2"></i>Orçamento anual
          </a>
        </div>
        {% endif %}
        
        {% if is_admin or 'parcerias' in user_acessos %}
        <div class="col-md-6">
          <a href="{{ url_for('parcerias.listar') }}" class="btn btn-main">
            <i class="bi bi-people-fill me-2"></i>Parcerias
          </a>
        </div>
        {% endif %}
        
        {% if (is_admin or 'pesquisa_parcerias' in user_acessos) and user['tipo_usuario'] in ['Agente DAC', 'Agente Público'] %}
        <div class="col-md-6">
          <a href="{{ url_for('pesquisa_parcerias.index') }}" class="btn btn-main" style="background-color: #198754;">
            <i class="bi bi-search me-2"></i>Pesquisa de Parcerias
          </a>
        </div>
        {% endif %}
        
        {% if is_admin or 'parcerias_notificacoes' in user_acessos %}
        <div class="col-md-6">
          <a href="{{ url_for('parcerias_notificacoes.listar') }}" class="btn btn-main" style="background-color: #fd7e14;">
            <i class="bi bi-envelope-fill me-2"></i>Ofícios, Documentos e Notificações
          </a>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Listas Suspensas (para Agente Público e outros Agentes) -->
    {% if user['tipo_usuario'] in ['Agente Público', 'Agente DAC', 'Agente DGP', 'Agente DP'] %}
      {% if is_admin or 'listas' in user_acessos %}
      <div class="mt-4 p-3 border-top">
        <h5>Gestão de Dados</h5>
        <div class="row g-3">
          <div class="col-12">
            <a href="{{ url_for('listas.index') }}" class="btn btn-main btn-admin">
              <i class="bi bi-list-ul me-2"></i>Listas suspensas
            </a>
          </div>
        </div>
      </div>
      {% endif %}
    {% endif %}

    <!-- Opções de Administração -->
    {% if is_admin or 'portarias' in user_acessos or 'usuarios' in user_acessos or 'modelos_textos' in user_acessos %}
      <div class="mt-4 p-3 border-top">
        <h5>Opções do Administrador</h5>
        <div class="row g-3">
          {% if is_admin or 'portarias' in user_acessos %}
          <div class="col-12">
            <a href="{{ url_for('main.gerenciar_portarias') }}" class="btn btn-main btn-admin">
              <i class="bi bi-file-earmark-text me-2"></i>Gerenciar Portarias/Legislações
            </a>
          </div>
          {% endif %}
          
          {% if is_admin or 'usuarios' in user_acessos %}
          <div class="col-12">
            <a href="#" class="btn btn-main btn-admin" data-bs-toggle="modal" data-bs-target="#modalUsuarios">
              <i class="bi bi-people me-2"></i>Gerenciar Usuários
            </a>
          </div>
          {% endif %}
          
          {% if is_admin or 'modelos_textos' in user_acessos %}
          <div class="col-12">
            <a href="{{ url_for('main.modelos_textos_index') }}" class="btn btn-main btn-admin">
              <i class="bi bi-file-text me-2"></i>Modelos de texto
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Modal de Gerenciamento de Usuários -->
  <div class="modal fade" id="modalUsuarios" tabindex="-1" aria-labelledby="modalUsuariosLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="modalUsuariosLabel">
            <i class="bi bi-people-fill me-2"></i>Gerenciar Usuários
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Botão Adicionar Novo Usuário -->
          <div class="mb-3">
            <button class="btn btn-success" onclick="mostrarFormNovo()">
              <i class="bi bi-plus-circle me-2"></i>Adicionar Novo Usuário
            </button>
          </div>

          <!-- Filtros de Usuários -->
          <div class="card mb-3">
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="filtroEmail" class="form-label">
                    <i class="bi bi-search me-1"></i>Buscar por E-mail
                  </label>
                  <input type="text" class="form-control" id="filtroEmail" 
                         placeholder="Digite o e-mail..." 
                         onkeyup="filtrarUsuarios()">
                </div>
                <div class="col-md-4">
                  <label for="filtroTipo" class="form-label">
                    <i class="bi bi-funnel me-1"></i>Filtrar por Tipo
                  </label>
                  <select class="form-select" id="filtroTipo" onchange="filtrarUsuarios()">
                    <option value="">Todos os tipos</option>
                    <option value="Agente Público">Agente Público</option>
                    <option value="Agente DAC">Agente DAC</option>
                    <option value="Agente DGP">Agente DGP</option>
                    <option value="Agente DP">Agente DP</option>
                    <option value="Externo">Externo</option>
                  </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                  <button class="btn btn-outline-secondary w-100" onclick="limparFiltros()">
                    <i class="bi bi-x-circle me-1"></i>Limpar
                  </button>
                </div>
              </div>
              <div class="mt-2">
                <small class="text-muted">
                  <i class="bi bi-info-circle me-1"></i>
                  <span id="contadorUsuarios">Carregando...</span>
                </small>
              </div>
            </div>
          </div>

          <!-- Formulário de Novo Usuário (inicialmente oculto) -->
          <div id="formNovoUsuario" class="card mb-3" style="display: none;">
            <div class="card-header bg-success text-white">
              <i class="bi bi-person-plus me-2"></i>Novo Usuário
            </div>
            <div class="card-body">
              <form id="formCriarUsuario" onsubmit="criarUsuario(event)">
                <div class="mb-3">
                  <label for="novoEmail" class="form-label">E-mail</label>
                  <input type="email" class="form-control" id="novoEmail" required>
                </div>
                <div class="mb-3">
                  <label for="novaSenha" class="form-label">Senha Inicial</label>
                  <input type="text" class="form-control" id="novaSenha" required>
                  <small class="text-muted">A senha será exibida apenas uma vez. Anote!</small>
                </div>
                <div class="mb-3">
                  <label for="novoTipo" class="form-label">Tipo de Usuário</label>
                  <select class="form-select" id="novoTipo" required>
                    <option value="">-- Selecione --</option>
                    <option value="Agente Público">Agente Público (Admin)</option>
                    <option value="Agente DAC">Agente DAC</option>
                    <option value="Agente DGP">Agente DGP</option>
                    <option value="Agente DP">Agente DP</option>
                    <option value="Externo">Externo</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="novoDUsuario" class="form-label">Registro do Usuário</label>
                  <input type="text" class="form-control" id="novoDUsuario" maxlength="20" placeholder="Ex: DAC, DGP, DP...">
                  <small class="text-muted">Campo opcional. Máximo 20 caracteres.</small>
                </div>
                <div class="d-flex gap-2">
                  <button type="submit" class="btn btn-success">
                    <i class="bi bi-check-circle me-2"></i>Criar
                  </button>
                  <button type="button" class="btn btn-secondary" onclick="cancelarFormNovo()">
                    <i class="bi bi-x-circle me-2"></i>Cancelar
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Lista de Usuários -->
          <div id="listaUsuarios">
            <div class="text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
              </div>
            </div>
          </div>

          <!-- Paginação -->
          <div id="paginacaoUsuarios" class="mt-3 d-flex justify-content-between align-items-center" style="display: none !important;">
            <div>
              <select class="form-select form-select-sm d-inline-block w-auto" id="itensPorPagina" onchange="alterarItensPorPagina()">
                <option value="10">10 por página</option>
                <option value="20">20 por página</option>
                <option value="50">50 por página</option>
                <option value="999999">Todos</option>
              </select>
            </div>
            <nav>
              <ul class="pagination pagination-sm mb-0" id="listaPaginacao">
                <!-- Páginas serão inseridas aqui -->
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Variáveis globais para armazenar usuários e controle de paginação
    let todosUsuarios = [];
    let usuariosFiltrados = [];
    let paginaAtual = 1;
    let itensPorPagina = 10;

    // Carregar usuários quando o modal é aberto
    document.getElementById('modalUsuarios').addEventListener('shown.bs.modal', function () {
      carregarUsuarios();
    });

    function mostrarFormNovo() {
      document.getElementById('formNovoUsuario').style.display = 'block';
    }

    function cancelarFormNovo() {
      document.getElementById('formNovoUsuario').style.display = 'none';
      document.getElementById('formCriarUsuario').reset();
    }

    function limparFiltros() {
      document.getElementById('filtroEmail').value = '';
      document.getElementById('filtroTipo').value = '';
      filtrarUsuarios();
    }

    function filtrarUsuarios() {
      const filtroEmail = document.getElementById('filtroEmail').value.toLowerCase();
      const filtroTipo = document.getElementById('filtroTipo').value;

      usuariosFiltrados = todosUsuarios.filter(user => {
        const matchEmail = user.email.toLowerCase().includes(filtroEmail);
        const matchTipo = filtroTipo === '' || user.tipo_usuario === filtroTipo;
        return matchEmail && matchTipo;
      });

      paginaAtual = 1; // Resetar para primeira página ao filtrar
      atualizarExibicao();
    }

    function alterarItensPorPagina() {
      itensPorPagina = parseInt(document.getElementById('itensPorPagina').value);
      paginaAtual = 1;
      atualizarExibicao();
    }

    function irParaPagina(pagina) {
      paginaAtual = pagina;
      atualizarExibicao();
    }

    function atualizarExibicao() {
      const totalUsuarios = usuariosFiltrados.length;
      const totalPaginas = Math.ceil(totalUsuarios / itensPorPagina);
      
      // Atualizar contador
      document.getElementById('contadorUsuarios').textContent = 
        `Exibindo ${totalUsuarios} usuário(s)${todosUsuarios.length !== totalUsuarios ? ' (filtrado de ' + todosUsuarios.length + ')' : ''}`;

      // Calcular índices da página atual
      const inicio = (paginaAtual - 1) * itensPorPagina;
      const fim = Math.min(inicio + itensPorPagina, totalUsuarios);
      const usuariosPagina = usuariosFiltrados.slice(inicio, fim);

      // Renderizar tabela
      renderizarTabela(usuariosPagina);

      // Atualizar paginação
      renderizarPaginacao(totalPaginas);
    }

    function renderizarTabela(usuarios) {
      const listaUsuariosDiv = document.getElementById('listaUsuarios');
      
      if (usuarios.length === 0) {
        listaUsuariosDiv.innerHTML = `
          <div class="alert alert-info">
            <i class="bi bi-info-circle-fill me-2"></i>
            Nenhum usuário encontrado com os filtros aplicados.
          </div>`;
        return;
      }

      let html = '<div class="table-responsive"><table class="table table-hover">';
      html += '<thead class="table-dark"><tr>';
      html += '<th>ID</th><th>E-mail</th><th>Tipo</th><th>D. Usuário</th><th>Data Criação</th><th class="text-center">Ações</th>';
      html += '</tr></thead><tbody>';
      
      usuarios.forEach(user => {
        html += '<tr>';
        html += `<td>${user.id}</td>`;
        html += `<td>${user.email}</td>`;
        
        // Definir cor do badge baseado no tipo
        let badgeClass = 'bg-secondary';
        if (user.tipo_usuario === 'Agente Público') badgeClass = 'bg-primary';
        else if (user.tipo_usuario.startsWith('Agente')) badgeClass = 'bg-info';
        else if (user.tipo_usuario === 'Externo') badgeClass = 'bg-warning text-dark';
        
        html += `<td><span class="badge ${badgeClass}">${user.tipo_usuario}</span></td>`;
        html += `<td>${user.d_usuario || '<span class="text-muted">-</span>'}</td>`;
        html += `<td>${new Date(user.data_criacao).toLocaleDateString('pt-BR')}</td>`;
        html += `<td class="text-center">
          <button class="btn btn-sm btn-info me-1" onclick="resetarSenha(${user.id}, '${user.email}')" title="Resetar Senha">
            <i class="bi bi-key"></i>
          </button>
          <button class="btn btn-sm btn-warning me-1" onclick="editarUsuario(${user.id}, '${user.email}', '${user.tipo_usuario}', '${user.d_usuario || ''}')" title="Editar">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-sm btn-danger" onclick="excluirUsuario(${user.id}, '${user.email}')" title="Excluir">
            <i class="bi bi-trash"></i>
          </button>
        </td>`;
        html += '</tr>';
      });
      
      html += '</tbody></table></div>';
      listaUsuariosDiv.innerHTML = html;
    }

    function renderizarPaginacao(totalPaginas) {
      const paginacaoDiv = document.getElementById('paginacaoUsuarios');
      const listaPaginacao = document.getElementById('listaPaginacao');

      if (totalPaginas <= 1) {
        paginacaoDiv.style.display = 'none';
        return;
      }

      paginacaoDiv.style.display = 'flex';
      let html = '';

      // Botão Anterior
      html += `<li class="page-item ${paginaAtual === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="irParaPagina(${paginaAtual - 1}); return false;">Anterior</a>
      </li>`;

      // Páginas numeradas (mostrar no máximo 5 páginas)
      let inicioPaginas = Math.max(1, paginaAtual - 2);
      let fimPaginas = Math.min(totalPaginas, inicioPaginas + 4);
      
      if (fimPaginas - inicioPaginas < 4) {
        inicioPaginas = Math.max(1, fimPaginas - 4);
      }

      if (inicioPaginas > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="irParaPagina(1); return false;">1</a></li>`;
        if (inicioPaginas > 2) {
          html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
      }

      for (let i = inicioPaginas; i <= fimPaginas; i++) {
        html += `<li class="page-item ${i === paginaAtual ? 'active' : ''}">
          <a class="page-link" href="#" onclick="irParaPagina(${i}); return false;">${i}</a>
        </li>`;
      }

      if (fimPaginas < totalPaginas) {
        if (fimPaginas < totalPaginas - 1) {
          html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        html += `<li class="page-item"><a class="page-link" href="#" onclick="irParaPagina(${totalPaginas}); return false;">${totalPaginas}</a></li>`;
      }

      // Botão Próximo
      html += `<li class="page-item ${paginaAtual === totalPaginas ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="irParaPagina(${paginaAtual + 1}); return false;">Próximo</a>
      </li>`;

      listaPaginacao.innerHTML = html;
    }

    async function carregarUsuarios() {
      console.log('[DEBUG] Iniciando carregamento de usuários...');
      const listaUsuariosDiv = document.getElementById('listaUsuarios');
      listaUsuariosDiv.innerHTML = '<div class="text-center p-3"><div class="spinner-border" role="status"><span class="visually-hidden">Carregando...</span></div><p class="mt-2">Carregando usuários...</p></div>';
      
      try {
        console.log('[DEBUG] Fazendo requisição para /api/usuarios');
        const response = await fetch('/api/usuarios');
        console.log('[DEBUG] Response status:', response.status);
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.erro || 'Erro ao carregar usuários');
        }
        
        todosUsuarios = await response.json();
        usuariosFiltrados = [...todosUsuarios]; // Cópia inicial
        console.log('[DEBUG] Usuários recebidos:', todosUsuarios.length);
        
        paginaAtual = 1;
        atualizarExibicao();
        
        console.log('[DEBUG] Tabela de usuários renderizada com sucesso');
      } catch (error) {
        console.error('[ERRO] Erro ao carregar usuários:', error);
        listaUsuariosDiv.innerHTML = `<div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <strong>Erro ao carregar usuários:</strong> ${error.message}
          <br><small>Verifique o console do navegador (F12) para mais detalhes.</small>
        </div>`;
      }
    }

    async function criarUsuario(event) {
      event.preventDefault();
      
      const email = document.getElementById('novoEmail').value;
      const senha = document.getElementById('novaSenha').value;
      const tipo = document.getElementById('novoTipo').value;
      const d_usuario = document.getElementById('novoDUsuario').value;
      
      try {
        const response = await fetch('/api/usuarios', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, senha, tipo_usuario: tipo, d_usuario })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert(`Usuário criado com sucesso!\n\nE-mail: ${email}\nSenha: ${senha}\n\nAnote a senha, ela não será exibida novamente!`);
          cancelarFormNovo();
          carregarUsuarios();
        } else {
          alert('Erro: ' + result.erro);
        }
      } catch (error) {
        console.error('Erro ao criar usuário:', error);
        alert('Erro ao criar usuário.');
      }
    }

    async function editarUsuario(id, email, tipo, d_usuario) {
      // Buscar dados completos do usuário incluindo acessos
      let acessosAtuais = [];
      try {
        const response = await fetch(`/api/usuarios/${id}`);
        if (response.ok) {
          const userData = await response.json();
          acessosAtuais = userData.acessos ? userData.acessos.split(';').filter(a => a.trim()) : [];
        }
      } catch (error) {
        console.error('Erro ao buscar dados do usuário:', error);
      }
      
      // Lista de todos os módulos/blueprints disponíveis
      const modulosDisponiveis = [
        { id: 'instrucoes', nome: 'Iniciar ou prosseguir análise', grupo: 'Principal' },
        { id: 'analises', nome: 'Menu de Prestações de Contas', grupo: 'Principal' },
        { id: 'orcamento', nome: 'Orçamento anual', grupo: 'Principal' },
        { id: 'parcerias', nome: 'Parcerias', grupo: 'Principal' },
        { id: 'pesquisa_parcerias', nome: 'Pesquisa de Parcerias', grupo: 'Principal' },
        { id: 'parcerias_notificacoes', nome: 'Ofícios, Documentos e Notificações', grupo: 'Principal' },
        { id: 'listas', nome: 'Listas suspensas', grupo: 'Gestão' },
        { id: 'conc_bancaria', nome: 'Conciliação Bancária', grupo: 'Análise PC' },
        { id: 'conc_rendimentos', nome: 'Rendimentos', grupo: 'Análise PC' },
        { id: 'conc_contrapartida', nome: 'Contrapartida', grupo: 'Análise PC' },
        { id: 'conc_relatorio', nome: 'Relatório de Conciliação', grupo: 'Análise PC' },
        { id: 'portarias', nome: 'Gerenciar Portarias/Legislações', grupo: 'Admin' },
        { id: 'usuarios', nome: 'Gerenciar Usuários', grupo: 'Admin' },
        { id: 'modelos_textos', nome: 'Modelos de texto', grupo: 'Admin' }
      ];
      
      // Agrupar módulos
      const grupos = {};
      modulosDisponiveis.forEach(mod => {
        if (!grupos[mod.grupo]) grupos[mod.grupo] = [];
        grupos[mod.grupo].push(mod);
      });
      
      // Gerar HTML dos checkboxes agrupados
      let checkboxesHtml = '';
      Object.keys(grupos).forEach(grupo => {
        checkboxesHtml += `<div class="mb-3">`;
        checkboxesHtml += `<h6 class="text-muted mb-2"><i class="bi bi-folder me-1"></i>${grupo}</h6>`;
        grupos[grupo].forEach(mod => {
          const checked = tipo === 'Agente Público' || acessosAtuais.includes(mod.id) ? 'checked' : '';
          const disabled = tipo === 'Agente Público' ? 'disabled' : '';
          checkboxesHtml += `
            <div class="form-check">
              <input class="form-check-input acesso-checkbox" type="checkbox" 
                     value="${mod.id}" id="acesso_${mod.id}" ${checked} ${disabled}>
              <label class="form-check-label" for="acesso_${mod.id}">
                ${mod.nome}
              </label>
            </div>`;
        });
        checkboxesHtml += `</div>`;
      });
      
      // Criar formulário modal usando Bootstrap
      const modalHtml = `
        <div class="modal fade" id="modalEditarUsuario" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Editar Usuário: ${email}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">Tipo de Usuário</label>
                  <select class="form-select" id="editTipo" onchange="atualizarAcessosDisponiveis(this.value)">
                    <option value="Agente Público" ${tipo === 'Agente Público' ? 'selected' : ''}>Agente Público (Admin)</option>
                    <option value="Agente DAC" ${tipo === 'Agente DAC' ? 'selected' : ''}>Agente DAC</option>
                    <option value="Agente DGP" ${tipo === 'Agente DGP' ? 'selected' : ''}>Agente DGP</option>
                    <option value="Agente DP" ${tipo === 'Agente DP' ? 'selected' : ''}>Agente DP</option>
                    <option value="Externo" ${tipo === 'Externo' ? 'selected' : ''}>Externo</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Registro do Usuário</label>
                  <input type="text" class="form-control" id="editDUsuario" value="${d_usuario}" maxlength="20" placeholder="Ex: DAC, DGP, DP...">
                  <small class="text-muted">Máximo 20 caracteres</small>
                </div>
                
                <hr>
                
                <div class="mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label mb-0"><i class="bi bi-key-fill me-2"></i>Controle de Acessos</label>
                    <div id="acessosControls">
                      <button type="button" class="btn btn-sm btn-outline-primary me-1" onclick="marcarTodos()">
                        <i class="bi bi-check-all"></i> Marcar Todos
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="desmarcarTodos()">
                        <i class="bi bi-x"></i> Desmarcar Todos
                      </button>
                    </div>
                  </div>
                  <small class="text-muted d-block mb-3">
                    <i class="bi bi-info-circle me-1"></i>
                    Agente Público tem acesso total (não editável). Para outros tipos, selecione os módulos permitidos.
                  </small>
                  <div id="checkboxesAcessos" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; background-color: #f8f9fa;">
                    ${checkboxesHtml}
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="salvarEdicao(${id})">
                  <i class="bi bi-check-circle me-2"></i>Salvar
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Remover modal antigo se existir
      const oldModal = document.getElementById('modalEditarUsuario');
      if (oldModal) oldModal.remove();
      
      // Adicionar novo modal ao body
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Mostrar modal
      const modal = new bootstrap.Modal(document.getElementById('modalEditarUsuario'));
      modal.show();
    }
    
    function atualizarAcessosDisponiveis(tipoUsuario) {
      const checkboxes = document.querySelectorAll('.acesso-checkbox');
      const controls = document.getElementById('acessosControls');
      
      if (tipoUsuario === 'Agente Público') {
        // Agente Público: marcar todos e desabilitar
        checkboxes.forEach(cb => {
          cb.checked = true;
          cb.disabled = true;
        });
        controls.style.display = 'none';
      } else {
        // Outros: habilitar edição
        checkboxes.forEach(cb => {
          cb.disabled = false;
        });
        controls.style.display = 'block';
      }
    }
    
    function marcarTodos() {
      const checkboxes = document.querySelectorAll('.acesso-checkbox:not([disabled])');
      checkboxes.forEach(cb => cb.checked = true);
    }
    
    function desmarcarTodos() {
      const checkboxes = document.querySelectorAll('.acesso-checkbox:not([disabled])');
      checkboxes.forEach(cb => cb.checked = false);
    }
    
    async function salvarEdicao(id) {
      const novoTipo = document.getElementById('editTipo').value;
      const novoDUsuario = document.getElementById('editDUsuario').value.trim();
      
      // Coletar acessos selecionados
      const checkboxes = document.querySelectorAll('.acesso-checkbox:checked');
      const acessosSelecionados = Array.from(checkboxes).map(cb => cb.value);
      const acessosString = acessosSelecionados.join(';');
      
      console.log('[DEBUG] Salvando usuário:', { id, novoTipo, novoDUsuario, acessos: acessosString });
      
      try {
        const response = await fetch(`/api/usuarios/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            tipo_usuario: novoTipo,
            d_usuario: novoDUsuario,
            acessos: acessosString
          })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('Usuário atualizado com sucesso!');
          bootstrap.Modal.getInstance(document.getElementById('modalEditarUsuario')).hide();
          carregarUsuarios();
        } else {
          alert('Erro: ' + result.erro);
        }
      } catch (error) {
        console.error('Erro ao editar usuário:', error);
        alert('Erro ao editar usuário.');
      }
    }

    async function excluirUsuario(id, email) {
      if (!confirm(`Tem certeza que deseja excluir o usuário "${email}"?\n\nEsta ação não pode ser desfeita!`)) {
        return;
      }
      
      try {
        const response = await fetch(`/api/usuarios/${id}`, {
          method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('Usuário excluído com sucesso!');
          carregarUsuarios();
        } else {
          alert('Erro: ' + result.erro);
        }
      } catch (error) {
        console.error('Erro ao excluir usuário:', error);
        alert('Erro ao excluir usuário.');
      }
    }

    async function resetarSenha(id, email) {
      const novaSenha = prompt(`Resetar senha do usuário "${email}".\n\nDigite a nova senha:`, '');
      
      if (novaSenha === null || novaSenha.trim() === '') {
        return;
      }
      
      if (novaSenha.length < 4) {
        alert('Senha muito curta! Mínimo 4 caracteres.');
        return;
      }
      
      try {
        const response = await fetch(`/api/usuarios/${id}/resetar-senha`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nova_senha: novaSenha })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert(`Senha resetada com sucesso!\n\nE-mail: ${email}\nNova Senha: ${novaSenha}\n\nAnote a senha, ela não será exibida novamente!`);
          carregarUsuarios();
        } else {
          alert('Erro: ' + result.erro);
        }
      } catch (error) {
        console.error('Erro ao resetar senha:', error);
        alert('Erro ao resetar senha.');
      }
    }
  </script>
</body>
</html>
