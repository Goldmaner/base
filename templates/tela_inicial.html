<!-- templates/tela_inicial.html -->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Página Inicial - Módulo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    body { background-color: #f8f9fa; padding-top:50px; }
    .main-container { max-width:800px; margin:0 auto; padding:30px; background:#fff; border-radius:10px; }
    .btn-main { width:100%; padding:20px; margin-bottom:20px; font-size:1.1rem; background-color:#0d6efd; color:white; border:none; text-align:left; }
    .btn-admin { background-color:#0dcaf0; color:#000; }
  </style>
</head>
<body>
  <div class="container main-container">
    <div class="d-flex justify-content-between align-items-center">
      <h2>Módulo de Análise de Contas</h2>
      <div>
        <small>Logado como: <strong>{{ user['email'] }}</strong></small><br>
        <small>Tipo: <span class="badge bg-info">{{ user['tipo_usuario'] }}</span></small><br>
        <a href="{{ url_for('auth.logout') }}" class="btn btn-sm btn-outline-secondary mt-2">Sair</a>
      </div>
    </div>

    <div class="mt-4">
      <a href="{{ url_for('instrucoes.listar_view') }}" class="btn btn-main">
        <i class="bi bi-plus-circle-fill me-2"></i>Iniciar nova análise
      </a>
      <a href="{{ url_for('analises.listar') }}" class="btn btn-main">
        <i class="bi bi-arrow-clockwise me-2"></i>Menu de Prestações de Contas
      </a>
      <a href="{{ url_for('orcamento.listar') }}" class="btn btn-main">
        <i class="bi bi-currency-dollar me-2"></i>Orçamento anual
      </a>
      <a href="{{ url_for('parcerias.listar') }}" class="btn btn-main">
        <i class="bi bi-people-fill me-2"></i>Parcerias
      </a>
    </div>

    <!-- Listas Suspensas (para Agente Público e outros Agentes) -->
    {% if user['tipo_usuario'] in ['Agente Público', 'Agente DAC', 'Agente DGP', 'Agente DP'] %}
      <div class="mt-4 p-3 border-top">
        <h5>Gestão de Dados</h5>
        <a href="{{ url_for('listas.index') }}" class="btn btn-main btn-admin">
          <i class="bi bi-list-ul me-2"></i>Listas suspensas
        </a>
      </div>
    {% endif %}

    {% if user['tipo_usuario'] == 'Agente Público' %}
      <div class="mt-4 p-3 border-top">
        <h5>Opções do Administrador</h5>
        <a href="{{ url_for('main.gerenciar_portarias') }}" class="btn btn-main btn-admin">
          <i class="bi bi-file-earmark-text me-2"></i>Gerenciar Portarias/Legislações
        </a>
        <a href="#" class="btn btn-main btn-admin" data-bs-toggle="modal" data-bs-target="#modalUsuarios">
          <i class="bi bi-people me-2"></i>Gerenciar Usuários
        </a>
        <a href="#" class="btn btn-main btn-admin">
          <i class="bi bi-file-text me-2"></i>Modelos de texto
        </a>
      </div>
    {% endif %}
  </div>

  <!-- Modal de Gerenciamento de Usuários -->
  <div class="modal fade" id="modalUsuarios" tabindex="-1" aria-labelledby="modalUsuariosLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="modalUsuariosLabel">
            <i class="bi bi-people-fill me-2"></i>Gerenciar Usuários
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Botão Adicionar Novo Usuário -->
          <div class="mb-3">
            <button class="btn btn-success" onclick="mostrarFormNovo()">
              <i class="bi bi-plus-circle me-2"></i>Adicionar Novo Usuário
            </button>
          </div>

          <!-- Formulário de Novo Usuário (inicialmente oculto) -->
          <div id="formNovoUsuario" class="card mb-3" style="display: none;">
            <div class="card-header bg-success text-white">
              <i class="bi bi-person-plus me-2"></i>Novo Usuário
            </div>
            <div class="card-body">
              <form id="formCriarUsuario" onsubmit="criarUsuario(event)">
                <div class="mb-3">
                  <label for="novoEmail" class="form-label">E-mail</label>
                  <input type="email" class="form-control" id="novoEmail" required>
                </div>
                <div class="mb-3">
                  <label for="novaSenha" class="form-label">Senha Inicial</label>
                  <input type="text" class="form-control" id="novaSenha" required>
                  <small class="text-muted">A senha será exibida apenas uma vez. Anote!</small>
                </div>
                <div class="mb-3">
                  <label for="novoTipo" class="form-label">Tipo de Usuário</label>
                  <select class="form-select" id="novoTipo" required>
                    <option value="">-- Selecione --</option>
                    <option value="Agente Público">Agente Público (Admin)</option>
                    <option value="Agente DAC">Agente DAC</option>
                    <option value="Agente DGP">Agente DGP</option>
                    <option value="Agente DP">Agente DP</option>
                    <option value="Externo">Externo</option>
                  </select>
                </div>
                <div class="d-flex gap-2">
                  <button type="submit" class="btn btn-success">
                    <i class="bi bi-check-circle me-2"></i>Criar
                  </button>
                  <button type="button" class="btn btn-secondary" onclick="cancelarFormNovo()">
                    <i class="bi bi-x-circle me-2"></i>Cancelar
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Lista de Usuários -->
          <div id="listaUsuarios">
            <div class="text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Carregar usuários quando o modal é aberto
    document.getElementById('modalUsuarios').addEventListener('shown.bs.modal', function () {
      carregarUsuarios();
    });

    function mostrarFormNovo() {
      document.getElementById('formNovoUsuario').style.display = 'block';
    }

    function cancelarFormNovo() {
      document.getElementById('formNovoUsuario').style.display = 'none';
      document.getElementById('formCriarUsuario').reset();
    }

    async function carregarUsuarios() {
      console.log('[DEBUG] Iniciando carregamento de usuários...');
      const listaUsuariosDiv = document.getElementById('listaUsuarios');
      listaUsuariosDiv.innerHTML = '<div class="text-center p-3"><div class="spinner-border" role="status"><span class="visually-hidden">Carregando...</span></div><p class="mt-2">Carregando usuários...</p></div>';
      
      try {
        console.log('[DEBUG] Fazendo requisição para /api/usuarios');
        const response = await fetch('/api/usuarios');
        console.log('[DEBUG] Response status:', response.status);
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.erro || 'Erro ao carregar usuários');
        }
        
        const usuarios = await response.json();
        console.log('[DEBUG] Usuários recebidos:', usuarios.length);
        
        let html = '<div class="table-responsive"><table class="table table-hover">';
        html += '<thead class="table-dark"><tr>';
        html += '<th>ID</th><th>E-mail</th><th>Tipo</th><th>Data Criação</th><th class="text-center">Ações</th>';
        html += '</tr></thead><tbody>';
        
        usuarios.forEach(user => {
          html += '<tr>';
          html += `<td>${user.id}</td>`;
          html += `<td>${user.email}</td>`;
          
          // Definir cor do badge baseado no tipo
          let badgeClass = 'bg-secondary';
          if (user.tipo_usuario === 'Agente Público') badgeClass = 'bg-primary';
          else if (user.tipo_usuario.startsWith('Agente')) badgeClass = 'bg-info';
          else if (user.tipo_usuario === 'Externo') badgeClass = 'bg-warning text-dark';
          
          html += `<td><span class="badge ${badgeClass}">${user.tipo_usuario}</span></td>`;
          html += `<td>${new Date(user.data_criacao).toLocaleDateString('pt-BR')}</td>`;
          html += `<td class="text-center">
            <button class="btn btn-sm btn-info me-1" onclick="resetarSenha(${user.id}, '${user.email}')" title="Resetar Senha">
              <i class="bi bi-key"></i>
            </button>
            <button class="btn btn-sm btn-warning me-1" onclick="editarUsuario(${user.id}, '${user.email}', '${user.tipo_usuario}')" title="Editar Tipo">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="excluirUsuario(${user.id}, '${user.email}')" title="Excluir">
              <i class="bi bi-trash"></i>
            </button>
          </td>`;
          html += '</tr>';
        });
        
        html += '</tbody></table></div>';
        listaUsuariosDiv.innerHTML = html;
        console.log('[DEBUG] Tabela de usuários renderizada com sucesso');
      } catch (error) {
        console.error('[ERRO] Erro ao carregar usuários:', error);
        listaUsuariosDiv.innerHTML = `<div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <strong>Erro ao carregar usuários:</strong> ${error.message}
          <br><small>Verifique o console do navegador (F12) para mais detalhes.</small>
        </div>`;
      }
    }

    async function criarUsuario(event) {
      event.preventDefault();
      
      const email = document.getElementById('novoEmail').value;
      const senha = document.getElementById('novaSenha').value;
      const tipo = document.getElementById('novoTipo').value;
      
      try {
        const response = await fetch('/api/usuarios', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, senha, tipo_usuario: tipo })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert(`Usuário criado com sucesso!\n\nE-mail: ${email}\nSenha: ${senha}\n\nAnote a senha, ela não será exibida novamente!`);
          cancelarFormNovo();
          carregarUsuarios();
        } else {
          alert('Erro: ' + result.erro);
        }
      } catch (error) {
        console.error('Erro ao criar usuário:', error);
        alert('Erro ao criar usuário.');
      }
    }

    async function editarUsuario(id, email, tipo) {
      const opcoes = `Alterar tipo de usuário de "${email}":

1 - Agente Público (Admin)
2 - Agente DAC
3 - Agente DGP
4 - Agente DP
5 - Externo

Digite o número correspondente:`;
      
      const novoTipo = prompt(opcoes, '1');
      
      if (novoTipo === null) return;
      
      const tipos = {
        '1': 'Agente Público',
        '2': 'Agente DAC',
        '3': 'Agente DGP',
        '4': 'Agente DP',
        '5': 'Externo'
      };
      
      const tipoFinal = tipos[novoTipo];
      
      if (!tipoFinal) {
        alert('Opção inválida!');
        return;
      }
      
      try {
        const response = await fetch(`/api/usuarios/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tipo_usuario: tipoFinal })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('Usuário atualizado com sucesso!');
          carregarUsuarios();
        } else {
          alert('Erro: ' + result.erro);
        }
      } catch (error) {
        console.error('Erro ao editar usuário:', error);
        alert('Erro ao editar usuário.');
      }
    }

    async function excluirUsuario(id, email) {
      if (!confirm(`Tem certeza que deseja excluir o usuário "${email}"?\n\nEsta ação não pode ser desfeita!`)) {
        return;
      }
      
      try {
        const response = await fetch(`/api/usuarios/${id}`, {
          method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('Usuário excluído com sucesso!');
          carregarUsuarios();
        } else {
          alert('Erro: ' + result.erro);
        }
      } catch (error) {
        console.error('Erro ao excluir usuário:', error);
        alert('Erro ao excluir usuário.');
      }
    }

    async function resetarSenha(id, email) {
      const novaSenha = prompt(`Resetar senha do usuário "${email}".\n\nDigite a nova senha:`, '');
      
      if (novaSenha === null || novaSenha.trim() === '') {
        return;
      }
      
      if (novaSenha.length < 4) {
        alert('Senha muito curta! Mínimo 4 caracteres.');
        return;
      }
      
      try {
        const response = await fetch(`/api/usuarios/${id}/resetar-senha`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nova_senha: novaSenha })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert(`Senha resetada com sucesso!\n\nE-mail: ${email}\nNova Senha: ${novaSenha}\n\nAnote a senha, ela não será exibida novamente!`);
          carregarUsuarios();
        } else {
          alert('Erro: ' + result.erro);
        }
      } catch (error) {
        console.error('Erro ao resetar senha:', error);
        alert('Erro ao resetar senha.');
      }
    }
  </script>
</body>
</html>
