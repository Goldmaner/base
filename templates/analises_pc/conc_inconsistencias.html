<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio de Inconsist√™ncias - Concilia√ß√£o Banc√°ria</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 30px 0;
        }
        
        .container-main {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 1200px;
        }
        
        .header-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .header-title h3 {
            margin: 0;
            font-weight: bold;
        }
        
        .btn-voltar {
            background: #6c757d;
            color: white;
            border: none;
            transition: all 0.3s;
        }
        
        .btn-voltar:hover {
            background: #5a6268;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .modelo-texto-container {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 30px;
            margin-top: 20px;
            font-family: Calibri, Arial, sans-serif;
            font-size: 12pt;
            line-height: 1.6;
        }
        
        .alert-info-custom {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        /* Anima√ß√£o para cards de inconsist√™ncia */
        .card {
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        /* Tabela de transa√ß√µes */
        .table-responsive {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .table-hover tbody tr:hover {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="container-main">
            <!-- Header -->
            <div class="header-title">
                <div class="d-flex justify-content-between align-items-center">
                    <h3>
                        <i class="bi bi-file-earmark-text me-2"></i>
                        Relat√≥rio de Inconsist√™ncias
                    </h3>
                    <a href="{{ url_for('conc_bancaria.index') }}" id="btnVoltar" class="btn btn-voltar btn-lg">
                        <i class="bi bi-arrow-left me-2"></i>Voltar
                    </a>
                </div>
            </div>

            <!-- Informa√ß√µes -->
            <div class="alert-info-custom">
                <h5 class="mb-2">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    Sobre este Relat√≥rio
                </h5>
                <p class="mb-0">
                    Este documento apresenta o modelo de texto para emiss√£o do <strong>Relat√≥rio de Inconsist√™ncias</strong> 
                    identificadas durante a an√°lise de concilia√ß√£o banc√°ria da presta√ß√£o de contas.
                </p>
                <p class="mb-0 mt-2">
                    <small class="text-muted">
                        <i class="bi bi-lightbulb me-1"></i>
                        <strong>Instru√ß√µes:</strong> Preencha o formul√°rio abaixo para gerar o relat√≥rio personalizado com os dados da parceria.
                    </small>
                </p>
            </div>

            <!-- Formul√°rio de Gera√ß√£o -->
            <div class="card border-info mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-pencil-square me-2"></i>
                        Dados para Gera√ß√£o do Relat√≥rio
                    </h5>
                </div>
                <div class="card-body">
                    <form id="formRelatorio">
                        <div class="row">
                            <!-- Sele√ß√£o de Relat√≥rio -->
                            <div class="col-md-6 mb-3">
                                <label for="selectRelatorio" class="form-label fw-bold">
                                    <i class="bi bi-file-earmark-text me-1"></i>
                                    N√∫mero do Relat√≥rio de Inconsist√™ncias
                                </label>
                                <select class="form-select" id="selectRelatorio" required>
                                    <option value="">Carregando...</option>
                                </select>
                                <small class="text-muted">Selecione o n√∫mero do documento que ser√° emitido</small>
                            </div>

                            <!-- Termo (preenchido automaticamente) -->
                            <div class="col-md-6 mb-3">
                                <label for="inputTermo" class="form-label fw-bold">
                                    <i class="bi bi-file-text me-1"></i>
                                    N√∫mero do Termo
                                </label>
                                <input type="text" class="form-control" id="inputTermo" readonly>
                                <small class="text-muted">Preenchido automaticamente ap√≥s sele√ß√£o</small>
                            </div>

                            <!-- OSC (preenchido automaticamente) -->
                            <div class="col-md-6 mb-3">
                                <label for="inputOSC" class="form-label fw-bold">
                                    <i class="bi bi-building me-1"></i>
                                    OSC
                                </label>
                                <input type="text" class="form-control" id="inputOSC" readonly>
                            </div>

                            <!-- Projeto (preenchido automaticamente) -->
                            <div class="col-md-6 mb-3">
                                <label for="inputProjeto" class="form-label fw-bold">
                                    <i class="bi bi-folder me-1"></i>
                                    Projeto
                                </label>
                                <input type="text" class="form-control" id="inputProjeto" readonly>
                            </div>

                            <!-- M√™s Inicial -->
                            <div class="col-md-6 mb-3">
                                <label for="selectMesInicio" class="form-label fw-bold">
                                    <i class="bi bi-calendar-check me-1"></i>
                                    M√™s Inicial de An√°lise
                                </label>
                                <select class="form-select" id="selectMesInicio" required>
                                    <option value="">Selecione o termo primeiro</option>
                                </select>
                                <small class="text-muted">Primeiro m√™s do per√≠odo analisado</small>
                            </div>

                            <!-- M√™s Final -->
                            <div class="col-md-6 mb-3">
                                <label for="selectMesFim" class="form-label fw-bold">
                                    <i class="bi bi-calendar-x me-1"></i>
                                    M√™s Final de An√°lise
                                </label>
                                <select class="form-select" id="selectMesFim" required>
                                    <option value="">Selecione o termo primeiro</option>
                                </select>
                                <small class="text-muted">√öltimo m√™s do per√≠odo analisado</small>
                            </div>
                        </div>

                        <!-- Bot√£o de Gera√ß√£o -->
                        <div class="text-center mt-3">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-gear-fill me-2"></i>
                                Gerar Relat√≥rio Personalizado
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Loading -->
            <div id="loadingRelatorio" class="text-center my-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Gerando...</span>
                </div>
                <p class="mt-2 text-muted">Gerando relat√≥rio personalizado...</p>
            </div>

            <!-- √Årea de Resultado -->
            <div id="areaResultado" style="display: none;">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-check-circle me-2"></i>
                            Relat√≥rio Gerado com Sucesso
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="modelo-texto-container" id="textoGerado">
                            <!-- Preenchido via JavaScript -->
                        </div>
                    </div>
                    <div class="card-footer bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="bi bi-pencil-square me-1"></i>
                                Para editar este modelo, acesse: 
                                <a href="{{ url_for('main.modelos_textos_list') }}" target="_blank">Modelos de Texto</a>
                            </small>
                            <button class="btn btn-outline-success btn-sm" onclick="copiarTextoGerado()">
                                <i class="bi bi-clipboard me-1"></i>Copiar Texto
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========================================================== -->
            <!-- SE√á√ÉO: INCONSIST√äNCIAS IDENTIFICADAS -->
            <!-- ========================================================== -->
            <div id="secaoInconsistencias" style="display: none;" class="mt-5">
                <hr class="my-5">
                
                <div class="header-title">
                    <h3>
                        <i class="bi bi-exclamation-diamond me-2"></i>
                        Inconsist√™ncias Identificadas
                    </h3>
                </div>

                <div class="alert alert-info mb-4">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Instru√ß√µes:</strong> Revise as inconsist√™ncias identificadas automaticamente e clique em "Ratificar" para confirmar 
                    e registrar na lista de inconsist√™ncias do termo.
                </div>

                <!-- Container das inconsist√™ncias -->
                <div id="containerInconsistencias">
                    <!-- Preenchido dinamicamente via JavaScript -->
                </div>

                <!-- Mensagem quando n√£o houver inconsist√™ncias -->
                <div id="msgSemInconsistencias" style="display: none;">
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        <strong>Nenhuma inconsist√™ncia identificada!</strong> 
                        Todas as verifica√ß√µes foram aprovadas para este termo.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ============================================================
        // Vari√°veis Globais
        // ============================================================
        let relatoriosDisponiveis = [];
        let mesesDisponiveis = [];
        let dadosRelatorioSelecionado = null;

        // ============================================================
        // Carregar dados ao iniciar p√°gina
        // ============================================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('[DEBUG] ========================================');
            console.log('[DEBUG] P√°gina conc_inconsistencias.html carregada');
            console.log('[DEBUG] ========================================');
            
            // Capturar termo da URL de origem (referrer)
            const referrer = document.referrer;
            console.log('[DEBUG] P√°gina de origem (referrer):', referrer);
            
            let termoOrigem = null;
            if (referrer && referrer.includes('/conc_bancaria/')) {
                // Extrair par√¢metro 'termo' da URL de origem
                try {
                    const urlReferrer = new URL(referrer);
                    termoOrigem = urlReferrer.searchParams.get('termo');
                    console.log('[DEBUG] Termo extra√≠do da URL de origem:', termoOrigem);
                } catch (e) {
                    console.log('[DEBUG] N√£o foi poss√≠vel extrair termo do referrer');
                }
            }
            
            // Testar se bot√£o Voltar est√° acess√≠vel e configurar href inicial
            const btnVoltar = document.getElementById('btnVoltar');
            if (btnVoltar) {
                console.log('[DEBUG] ‚úÖ Bot√£o Voltar encontrado!');
                
                // Se h√° termo de origem, configurar bot√£o para voltar com o termo
                if (termoOrigem) {
                    btnVoltar.href = `/conc_bancaria/?termo=${encodeURIComponent(termoOrigem)}`;
                    console.log('[DEBUG] üéØ Bot√£o Voltar configurado com termo de origem!');
                    console.log('[DEBUG] URL de retorno:', btnVoltar.href);
                } else {
                    console.log('[DEBUG] Href inicial (sem termo):', btnVoltar.href);
                }
            } else {
                console.error('[DEBUG] ‚ùå Bot√£o Voltar N√ÉO encontrado!');
            }
            
            await carregarRelatoriosDisponiveis();
            configurarEventListeners();
            console.log('[DEBUG] Inicializa√ß√£o completa. Aguardando sele√ß√£o de relat√≥rio...');
        });

        // ============================================================
        // Carregar lista de relat√≥rios dispon√≠veis
        // ============================================================
        async function carregarRelatoriosDisponiveis() {
            try {
                const response = await fetch('/analises_pc/api/listar-relatorios-inconsistencias');
                const data = await response.json();

                if (data.dados && data.dados.length > 0) {
                    relatoriosDisponiveis = data.dados;
                    
                    const selectRelatorio = document.getElementById('selectRelatorio');
                    selectRelatorio.innerHTML = '<option value="">Selecione um relat√≥rio...</option>';
                    
                    data.dados.forEach(rel => {
                        const option = document.createElement('option');
                        option.value = rel.id;
                        option.textContent = `${rel.formatado} - ${rel.osc || 'OSC n√£o informada'} (Termo: ${rel.numero_termo})`;
                        option.dataset.numeroDoc = rel.numero_doc;
                        option.dataset.anoDoc = rel.ano_doc;
                        option.dataset.numeroTermo = rel.numero_termo;
                        option.dataset.osc = rel.osc || '';
                        option.dataset.projeto = rel.projeto || '';
                        selectRelatorio.appendChild(option);
                    });
                } else {
                    document.getElementById('selectRelatorio').innerHTML = '<option value="">Nenhum relat√≥rio cadastrado</option>';
                }
            } catch (error) {
                console.error('Erro ao carregar relat√≥rios:', error);
                alert('‚ùå Erro ao carregar lista de relat√≥rios. Verifique o console.');
            }
        }

        // ============================================================
        // Configurar event listeners
        // ============================================================
        function configurarEventListeners() {
            console.log('[DEBUG] Configurando event listeners...');
            
            // Quando selecionar relat√≥rio
            document.getElementById('selectRelatorio').addEventListener('change', async function() {
                console.log('[DEBUG] Dropdown de relat√≥rio alterado, valor:', this.value);
                const selectedOption = this.options[this.selectedIndex];
                
                if (this.value) {
                    console.log('[DEBUG] Relat√≥rio selecionado:', {
                        id: this.value,
                        numeroTermo: selectedOption.dataset.numeroTermo,
                        osc: selectedOption.dataset.osc
                    });
                    
                    // Preencher campos automaticamente
                    document.getElementById('inputTermo').value = selectedOption.dataset.numeroTermo;
                    document.getElementById('inputOSC').value = selectedOption.dataset.osc;
                    document.getElementById('inputProjeto').value = selectedOption.dataset.projeto;
                    
                    // Armazenar dados do relat√≥rio
                    dadosRelatorioSelecionado = {
                        id: this.value,
                        numero_doc: selectedOption.dataset.numeroDoc,
                        ano_doc: selectedOption.dataset.anoDoc,
                        numero_termo: selectedOption.dataset.numeroTermo,
                        osc: selectedOption.dataset.osc,
                        projeto: selectedOption.dataset.projeto
                    };
                    
                    // Atualizar bot√£o Voltar para retornar ao termo espec√≠fico em conc_bancaria
                    const btnVoltar = document.getElementById('btnVoltar');
                    const termoParam = selectedOption.dataset.numeroTermo;
                    const urlVoltar = `/conc_bancaria/?termo=${encodeURIComponent(termoParam)}`;
                    btnVoltar.href = urlVoltar;
                    console.log('[DEBUG IMPORTANTE] Bot√£o Voltar atualizado!');
                    console.log('[DEBUG IMPORTANTE] Termo:', termoParam);
                    console.log('[DEBUG IMPORTANTE] URL completa:', urlVoltar);
                    console.log('[DEBUG IMPORTANTE] Href do bot√£o:', btnVoltar.href);
                    
                    // Carregar meses dispon√≠veis para o termo
                    await carregarMesesDisponiveis(selectedOption.dataset.numeroTermo);
                } else {
                    console.log('[DEBUG] Relat√≥rio desmarcado, limpando campos');
                    // Limpar campos
                    document.getElementById('inputTermo').value = '';
                    document.getElementById('inputOSC').value = '';
                    document.getElementById('inputProjeto').value = '';
                    document.getElementById('selectMesInicio').innerHTML = '<option value="">Selecione o termo primeiro</option>';
                    document.getElementById('selectMesFim').innerHTML = '<option value="">Selecione o termo primeiro</option>';
                    dadosRelatorioSelecionado = null;
                    
                    // Restaurar link padr√£o do bot√£o Voltar
                    const btnVoltar = document.getElementById('btnVoltar');
                    btnVoltar.href = '/conc_bancaria/';
                    console.log('[DEBUG] Bot√£o Voltar restaurado para:', btnVoltar.href);
                }
            });

            // Submit do formul√°rio
            document.getElementById('formRelatorio').addEventListener('submit', async function(e) {
                e.preventDefault();
                await gerarRelatorioPersonalizado();
            });

            // Mudan√ßa no select de relat√≥rio deve carregar inconsist√™ncias
            document.getElementById('selectRelatorio').addEventListener('change', async function() {
                const selectedOption = this.options[this.selectedIndex];
                if (this.value && selectedOption.dataset.numeroTermo) {
                    console.log('[DEBUG TERMO] N√∫mero do termo selecionado:', selectedOption.dataset.numeroTermo);
                    console.log('[DEBUG TERMO] Tipo:', typeof selectedOption.dataset.numeroTermo);
                    console.log('[DEBUG TERMO] Valor ap√≥s encodeURIComponent:', encodeURIComponent(selectedOption.dataset.numeroTermo));
                    await carregarInconsistencias(selectedOption.dataset.numeroTermo);
                } else {
                    document.getElementById('secaoInconsistencias').style.display = 'none';
                }
            });
        }

        // ============================================================
        // Carregar meses dispon√≠veis para o termo
        // ============================================================
        async function carregarMesesDisponiveis(numeroTermo) {
            try {
                const response = await fetch(`/analises_pc/api/meses-disponiveis/${encodeURIComponent(numeroTermo)}`);
                const data = await response.json();

                if (data.meses && data.meses.length > 0) {
                    mesesDisponiveis = data.meses;
                    
                    const selectMesInicio = document.getElementById('selectMesInicio');
                    const selectMesFim = document.getElementById('selectMesFim');
                    
                    selectMesInicio.innerHTML = '<option value="">Selecione o m√™s inicial...</option>';
                    selectMesFim.innerHTML = '<option value="">Selecione o m√™s final...</option>';
                    
                    data.meses.forEach(mes => {
                        const optionInicio = document.createElement('option');
                        optionInicio.value = mes.valor;
                        optionInicio.textContent = mes.valor;
                        selectMesInicio.appendChild(optionInicio);
                        
                        const optionFim = document.createElement('option');
                        optionFim.value = mes.valor;
                        optionFim.textContent = mes.valor;
                        selectMesFim.appendChild(optionFim);
                    });

                    // Pr√©-selecionar primeiro e √∫ltimo m√™s
                    if (data.meses.length > 0) {
                        selectMesInicio.value = data.meses[0].valor;
                        selectMesFim.value = data.meses[data.meses.length - 1].valor;
                    }
                } else {
                    document.getElementById('selectMesInicio').innerHTML = '<option value="">Nenhum m√™s dispon√≠vel</option>';
                    document.getElementById('selectMesFim').innerHTML = '<option value="">Nenhum m√™s dispon√≠vel</option>';
                    alert('‚ö†Ô∏è Nenhum m√™s de an√°lise encontrado para este termo. Verifique se h√° dados em conc_extrato.');
                }
            } catch (error) {
                console.error('Erro ao carregar meses:', error);
                alert('‚ùå Erro ao carregar meses dispon√≠veis. Verifique o console.');
            }
        }

        // ============================================================
        // Gerar relat√≥rio personalizado
        // ============================================================
        async function gerarRelatorioPersonalizado() {
            // Valida√ß√µes
            if (!dadosRelatorioSelecionado) {
                alert('‚ö†Ô∏è Selecione um relat√≥rio antes de gerar!');
                return;
            }

            const mesInicio = document.getElementById('selectMesInicio').value;
            const mesFim = document.getElementById('selectMesFim').value;

            if (!mesInicio || !mesFim) {
                alert('‚ö†Ô∏è Selecione os meses de in√≠cio e fim!');
                return;
            }

            // Mostrar loading
            document.getElementById('loadingRelatorio').style.display = 'block';
            document.getElementById('areaResultado').style.display = 'none';

            try {
                const response = await fetch('/analises_pc/api/gerar-texto-relatorio-inconsistencias', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        numero_doc: dadosRelatorioSelecionado.numero_doc,
                        ano_doc: dadosRelatorioSelecionado.ano_doc,
                        numero_termo: dadosRelatorioSelecionado.numero_termo,
                        mes_inicio: mesInicio,
                        mes_fim: mesFim
                    })
                });

                const data = await response.json();

                if (response.ok && data.texto_gerado) {
                    // Mostrar resultado
                    document.getElementById('textoGerado').innerHTML = data.texto_gerado;
                    document.getElementById('areaResultado').style.display = 'block';
                    
                    // Adicionar bot√£o de gerar PDF
                    const botoesPDF = `
                        <div class="mt-4 d-flex gap-2 justify-content-end">
                            <button class="btn btn-danger btn-lg" onclick="gerarPDF()">
                                <i class="bi bi-file-earmark-pdf me-2"></i>
                                Gerar PDF do Relat√≥rio
                            </button>
                        </div>
                    `;
                    document.getElementById('areaResultado').insertAdjacentHTML('beforeend', botoesPDF);
                    
                    // Scroll suave at√© o resultado
                    document.getElementById('areaResultado').scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    alert('‚ùå Erro ao gerar relat√≥rio: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao gerar relat√≥rio:', error);
                alert('‚ùå Erro ao gerar relat√≥rio. Verifique o console.');
            } finally {
                document.getElementById('loadingRelatorio').style.display = 'none';
            }
        }

        // ============================================================
        // Copiar texto gerado
        // ============================================================
        function copiarTextoGerado() {
            const textoDiv = document.getElementById('textoGerado');
            const range = document.createRange();
            range.selectNode(textoDiv);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            
            try {
                document.execCommand('copy');
                alert('‚úÖ Texto copiado para a √°rea de transfer√™ncia!');
            } catch (err) {
                console.error('Erro ao copiar:', err);
                alert('‚ùå Erro ao copiar texto. Use Ctrl+C manualmente.');
            }
            
            window.getSelection().removeAllRanges();
        }

        // ============================================================
        // Carregar inconsist√™ncias identificadas
        // ============================================================
        async function carregarInconsistencias(numeroTermo) {
            console.log('[DEBUG] ==========================================');
            console.log('[DEBUG] Carregando inconsist√™ncias para termo:', numeroTermo);
            console.log('[DEBUG] Tipo do termo:', typeof numeroTermo);
            console.log('[DEBUG] Termo √© undefined?', numeroTermo === undefined);
            console.log('[DEBUG] Termo √© null?', numeroTermo === null);
            console.log('[DEBUG] Termo vazio?', numeroTermo === '');
            
            try {
                const termoEncoded = encodeURIComponent(numeroTermo);
                console.log('[DEBUG] Termo ap√≥s encodeURIComponent:', termoEncoded);
                
                const url = `/analises_pc/api/identificar-inconsistencias/${termoEncoded}`;
                console.log('[DEBUG] URL COMPLETA da requisi√ß√£o:', url);
                console.log('[DEBUG] URL com protocolo:', window.location.origin + url);
                
                const response = await fetch(url);
                console.log('[DEBUG] Status da resposta:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[DEBUG] Erro na resposta:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('[DEBUG] Inconsist√™ncias recebidas:', data);

                if (response.ok && data.inconsistencias) {
                    const container = document.getElementById('containerInconsistencias');
                    const secao = document.getElementById('secaoInconsistencias');
                    const msgSem = document.getElementById('msgSemInconsistencias');

                    if (data.inconsistencias.length === 0) {
                        // Sem inconsist√™ncias
                        container.innerHTML = '';
                        msgSem.style.display = 'block';
                        secao.style.display = 'block';
                    } else {
                        // Renderizar inconsist√™ncias
                        msgSem.style.display = 'none';
                        container.innerHTML = '';
                        
                        data.inconsistencias.forEach((inc, index) => {
                            const cardHtml = criarCardInconsistencia(inc, index, numeroTermo, index + 1);
                            container.insertAdjacentHTML('beforeend', cardHtml);
                        });
                        
                        // Adicionar bot√£o de ratifica√ß√£o no final
                        const totalTransacoes = data.inconsistencias.reduce((sum, inc) => sum + (inc.transacoes?.length || 0), 0);
                        const pendentes = data.inconsistencias.filter(inc => !inc.ratificada).length;
                        const ratificadas = data.inconsistencias.filter(inc => inc.ratificada).length;
                        
                        const btnRatificarTodas = `
                            <div class="alert alert-info d-flex justify-content-between align-items-center mt-4">
                                <div>
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>${data.inconsistencias.length} inconsist√™ncia(s) identificada(s)</strong>
                                    ${totalTransacoes > 0 ? ` - ${totalTransacoes} registro(s) no total` : ''}
                                    <br>
                                    <small class="text-muted">
                                        <span class="badge bg-warning text-dark me-1">${pendentes} Pendente(s)</span>
                                        <span class="badge bg-success">${ratificadas} Ratificada(s)</span>
                                    </small>
                                </div>
                                <div class="d-flex gap-2">
                                    ${ratificadas > 0 ? `
                                    <button class="btn btn-danger btn-lg" onclick="resetarInconsistencias('${numeroTermo}')">
                                        <i class="bi bi-trash me-2"></i>
                                        Resetar Inconsist√™ncias
                                    </button>
                                    ` : ''}
                                    ${pendentes > 0 ? `
                                    <button class="btn btn-success btn-lg" onclick="ratificarTodasInconsistencias('${numeroTermo}')">
                                        <i class="bi bi-check-circle me-2"></i>
                                        Ratificar Pendentes (${pendentes})
                                    </button>
                                    ` : '<span class="text-success"><i class="bi bi-check-circle me-2"></i>Todas ratificadas!</span>'}
                                </div>
                            </div>
                        `;
                        container.insertAdjacentHTML('beforeend', btnRatificarTodas);
                        
                        secao.style.display = 'block';
                        
                        // Scroll suave at√© a se√ß√£o
                        setTimeout(() => {
                            secao.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 300);
                    }
                } else {
                    console.error('Erro na resposta:', data);
                    alert('‚ùå Erro ao carregar inconsist√™ncias: ' + (data.erro || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao carregar inconsist√™ncias:', error);
                
                let mensagemErro = '‚ùå Erro ao carregar inconsist√™ncias.\n\n';
                
                if (error.message.includes('404')) {
                    mensagemErro += 'üîç CAUSA: A rota /analises_pc/api/identificar-inconsistencias n√£o foi encontrada.\n\n';
                    mensagemErro += '‚úÖ SOLU√á√ÉO:\n';
                    mensagemErro += '1. Verifique se o servidor Flask foi REINICIADO ap√≥s adicionar a rota\n';
                    mensagemErro += '2. Verifique se a rota est√° registrada em routes/analises_pc/routes.py\n';
                    mensagemErro += '3. Verifique se o blueprint analises_pc_bp est√° registrado corretamente\n\n';
                    mensagemErro += 'üìù Detalhes t√©cnicos no console do navegador.';
                } else if (error.message.includes('JSON')) {
                    mensagemErro += 'üîç CAUSA: O servidor retornou HTML em vez de JSON (provavelmente erro 500).\n\n';
                    mensagemErro += '‚úÖ SOLU√á√ÉO:\n';
                    mensagemErro += '1. Verifique os logs do servidor Flask para ver o erro\n';
                    mensagemErro += '2. Verifique se h√° erro de sintaxe na rota\n';
                    mensagemErro += '3. Verifique se todas as depend√™ncias est√£o corretas\n\n';
                    mensagemErro += 'üìù Detalhes t√©cnicos no console do navegador.';
                } else {
                    mensagemErro += 'Detalhes: ' + error.message;
                }
                
                alert(mensagemErro);
            }
        }

        // ============================================================
        // Criar card de inconsist√™ncia
        // ============================================================
        function criarCardInconsistencia(inc, index, numeroTermo, numero) {
            // Verificar se √© um card composto
            if (inc.tipo_card === 'composto') {
                return criarCardComposto(inc, index, numeroTermo, numero);
            }
            
            // Construir HTML da tabela apenas se houver transa√ß√µes e mostrar_tabela n√£o for false
            let tabelaHtml = '';
            if (inc.transacoes && inc.transacoes.length > 0 && inc.mostrar_tabela !== false) {
                // Verificar se √© tabela customizada de rubrica trimestral
                if (inc.tipo_tabela === 'rubrica_trimestral') {
                    const divergenciasHtml = inc.transacoes.map(d => `
                        <tr>
                            <td><strong>${d.rubrica}</strong></td>
                            <td class="text-center">${d.trimestre}¬∫ Trimestre</td>
                            <td class="text-end">${formatarMoeda(d.valor_previsto)}</td>
                            <td class="text-end">${formatarMoeda(d.valor_executado)}</td>
                            <td class="text-end ${d.diferenca < 0 ? 'text-danger fw-bold' : ''}">${formatarMoeda(d.diferenca)}</td>
                        </tr>
                    `).join('');
                    
                    tabelaHtml = `
                        <!-- Tabela de diverg√™ncias por rubrica/trimestre -->
                        <h6 class="mb-3">
                            <i class="bi bi-table me-2"></i>
                            Diverg√™ncias Identificadas (${inc.transacoes.length})
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Rubrica</th>
                                        <th class="text-center">Trimestre</th>
                                        <th class="text-center">Previsto (R$)</th>
                                        <th class="text-center">Executado (R$)</th>
                                        <th class="text-center">Diferen√ßa (R$)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${divergenciasHtml}
                                </tbody>
                            </table>
                        </div>
                        <div class="alert alert-warning mt-3 mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Aten√ß√£o:</strong> Diferen√ßa negativa indica que a execu√ß√£o superou o previsto para o trimestre.
                        </div>
                    `;
                } else if (inc.tipo_tabela === 'despesa_sem_previsao') {
                    // Tabela customizada para despesas sem previs√£o no per√≠odo (Card 18)
                    const despesasHtml = inc.transacoes.map(d => `
                        <tr>
                            <td><strong>${d.categoria_despesa}</strong></td>
                            <td class="text-center">${d.mes}¬∫ m√™s</td>
                            <td class="text-end text-danger fw-bold">${formatarMoeda(d.valor_executado)}</td>
                        </tr>
                    `).join('');
                    
                    tabelaHtml = `
                        <!-- Tabela de despesas sem previs√£o mensal -->
                        <h6 class="mb-3">
                            <i class="bi bi-table me-2"></i>
                            Despesas Identificadas (${inc.transacoes.length})
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Categoria de Despesa</th>
                                        <th class="text-center">M√™s de Vig√™ncia</th>
                                        <th class="text-center">Valor Executado (R$)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${despesasHtml}
                                </tbody>
                            </table>
                        </div>
                        <div class="alert alert-warning mt-3 mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Aten√ß√£o:</strong> Valores executados em meses sem previs√£o or√ßament√°ria.
                        </div>
                    `;
                } else if (inc.tipo_tabela === 'aplicacao_48h') {
                    // Tabela reduzida para aus√™ncia de aplica√ß√£o em 48h (Card 21)
                    const parcelasHtml = inc.transacoes.map(t => `
                        <tr>
                            <td class="text-center">${formatarData(t.data)}</td>
                            <td class="text-end">${formatarMoeda(t.discriminacao)}</td>
                            <td class="text-center">${t.cat_transacao || '-'}</td>
                        </tr>
                    `).join('');
                    
                    tabelaHtml = `
                        <!-- Tabela reduzida para parcelas sem aplica√ß√£o em 48h -->
                        <h6 class="mb-3">
                            <i class="bi bi-table me-2"></i>
                            Parcelas sem Aplica√ß√£o em 48h (${inc.transacoes.length})
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th class="text-center">Data</th>
                                        <th class="text-center">Valor (R$)</th>
                                        <th class="text-center">Categoria</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${parcelasHtml}
                                </tbody>
                            </table>
                        </div>
                        <div class="alert alert-warning mt-3 mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Aten√ß√£o:</strong> Parcelas recebidas sem aplica√ß√£o financeira registrada dentro do prazo legal de 48 horas.
                        </div>
                    `;
                } else if (inc.tipo_tabela === 'aplicacao_divergente') {
                    // Tabela reduzida para aplica√ß√µes divergentes (Card 22)
                    const aplicacoesHtml = inc.transacoes.map(t => `
                        <tr>
                            <td class="text-center">${formatarData(t.data)}</td>
                            <td class="text-end">${formatarMoeda(t.discriminacao)}</td>
                            <td class="text-center">${t.cat_transacao || '-'}</td>
                        </tr>
                    `).join('');
                    
                    tabelaHtml = `
                        <!-- Tabela reduzida para aplica√ß√µes divergentes -->
                        <h6 class="mb-3">
                            <i class="bi bi-table me-2"></i>
                            Aplica√ß√µes Divergentes (${inc.transacoes.length})
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th class="text-center">Data</th>
                                        <th class="text-center">Valor (R$)</th>
                                        <th class="text-center">Tipo de Aplica√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${aplicacoesHtml}
                                </tbody>
                            </table>
                        </div>
                        <div class="alert alert-warning mt-3 mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Aten√ß√£o:</strong> Recursos aplicados em modalidades diferentes de poupan√ßa. Conforme legisla√ß√£o, recursos devem ser aplicados em caderneta de poupan√ßa.
                        </div>
                    `;
                } else {
                    // Tabela padr√£o de transa√ß√µes
                    const transacoesHtml = inc.transacoes.map(t => `
                        <tr data-id-extrato="${t.id_conc_extrato || ''}">
                            <td class="text-center">${t.indice || '-'}</td>
                            <td class="text-center">${formatarData(t.data)}</td>
                            <td class="text-end">${formatarMoeda(t.credito)}</td>
                            <td class="text-end">${formatarMoeda(t.debito)}</td>
                            <td class="text-end">${formatarMoeda(t.discriminacao)}</td>
                            <td class="text-center"><span class="badge bg-secondary">${t.cat_transacao || '-'}</span></td>
                            <td class="text-center">${formatarCompetencia(t.competencia)}</td>
                            <td>${t.origem_destino || '-'}</td>
                            <td class="text-center status-detalhado" style="display: none;">
                                <select class="form-select form-select-sm" onchange="atualizarStatusTransacao('${inc.nome_item}', ${t.id_conc_extrato || 0}, this.value, '${numeroTermo}')">
                                    <option value="N√£o atendida">N√£o atendida</option>
                                    <option value="Para an√°lise">Para an√°lise</option>
                                    <option value="Atendida">Atendida</option>
                                </select>
                            </td>
                        </tr>
                    `).join('');
                    
                    tabelaHtml = `
                        <!-- Tabela de transa√ß√µes -->
                        <h6 class="mb-3">
                            <i class="bi bi-table me-2"></i>
                            Transa√ß√µes Identificadas (${inc.transacoes.length})
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover table-bordered" id="tabela-${index}">
                                <thead class="table-dark">
                                    <tr>
                                        <th class="text-center">√çndice</th>
                                        <th class="text-center">Data</th>
                                        <th class="text-center">Cr√©dito (R$)</th>
                                        <th class="text-center">D√©bito (R$)</th>
                                        <th class="text-center">Discrimina√ß√£o (R$)</th>
                                        <th class="text-center">Categoria</th>
                                        <th class="text-center">Compet√™ncia</th>
                                        <th>Origem/Destino</th>
                                        <th class="text-center status-detalhado-header" style="display: none;">Status Individual</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${transacoesHtml}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            }

            const classeStatus = inc.ratificada ? 'border-success' : 'border-warning';
            const corHeader = inc.ratificada ? 'bg-success' : 'bg-warning';
            const textoHeader = inc.ratificada ? 'text-white' : 'text-dark';
            const iconeStatus = inc.ratificada ? 'bi-check-circle-fill' : 'bi-exclamation-triangle';
            const badgeStatus = inc.ratificada ? '<span class="badge bg-light text-success ms-2"><i class="bi bi-check-circle me-1"></i>Ratificada</span>' : '<span class="badge bg-light text-warning ms-2"><i class="bi bi-clock me-1"></i>Pendente</span>';
            
            // Status dropdown (somente se ratificada)
            const statusDropdown = inc.ratificada ? `
                <div class="d-flex align-items-center gap-2">
                    <label class="text-white mb-0 me-2">Status:</label>
                    <select class="form-select form-select-sm" style="width: auto;" onchange="atualizarStatusCard('${inc.nome_item}', this.value, ${index}, '${numeroTermo}')" data-status-atual="${inc.status || 'N√£o atendida'}">
                        <option value="N√£o atendida" ${(!inc.status || inc.status === 'N√£o atendida') ? 'selected' : ''}>N√£o atendida</option>
                        <option value="Para an√°lise" ${inc.status === 'Para an√°lise' ? 'selected' : ''}>Para an√°lise</option>
                        <option value="Atendida" ${inc.status === 'Atendida' ? 'selected' : ''}>Atendida</option>
                    </select>
                </div>
            ` : '';
            
            // Checkbox "Avaliar detalhadamente" (somente se ratificada e tiver transa√ß√µes)
            const avaliacaoDetalhada = inc.ratificada && inc.transacoes && inc.transacoes.length > 0 && inc.mostrar_tabela !== false && inc.tipo_tabela !== 'rubrica_trimestral' && inc.tipo_tabela !== 'despesa_sem_previsao' ? `
                <div class="form-check form-check-inline ms-3">
                    <input class="form-check-input" type="checkbox" id="checkbox-detalhado-${index}" onchange="toggleAvaliacaoDetalhada(${index})">
                    <label class="form-check-label text-white" for="checkbox-detalhado-${index}">
                        Avaliar detalhadamente
                    </label>
                </div>
            ` : '';
            
            return `
                <div class="card ${classeStatus} mb-4" id="card-inconsistencia-${index}" data-nome-item="${inc.nome_item}" data-ratificada="${inc.ratificada}">
                    <div class="card-header ${corHeader} ${textoHeader}">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <h5 class="mb-0">
                                <i class="bi ${iconeStatus} me-2"></i>
                                ${numero}. ${inc.nome_item}
                                ${inc.transacoes && inc.transacoes.length > 0 ? `<span class="badge bg-dark ms-2">${inc.transacoes.length} registro(s)</span>` : ''}
                                ${badgeStatus}
                            </h5>
                            <div class="d-flex align-items-center gap-2">
                                ${statusDropdown}
                                ${avaliacaoDetalhada}
                                ${!inc.ratificada ? `<button class="btn btn-sm btn-outline-danger" onclick="excluirCard(${index}, event)" title="Excluir desta visualiza√ß√£o"><i class="bi bi-trash"></i></button>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Descri√ß√£o -->
                        <div class="alert alert-light border-start border-warning border-4 mb-3">
                            <strong>Descri√ß√£o:</strong>
                            <p class="mb-0 mt-2">${inc.modelo_texto}</p>
                        </div>

                        ${tabelaHtml}
                    </div>
                </div>
            `;
        }

        // ============================================================
        // Criar card composto (m√∫ltiplas inconsist√™ncias nas mesmas transa√ß√µes)
        // ============================================================
        function criarCardComposto(inc, index, numeroTermo, numero) {
            // Construir t√≠tulos e descri√ß√µes dos itens compostos
            const titulosHtml = inc.itens_compostos.map((item, idx) => 
                `<h5 class="mb-0">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    ${numero}.${idx + 1} ${item.nome_item}
                </h5>`
            ).join('<div class="my-2"></div>');
            
            const descricoesHtml = inc.itens_compostos.map((item, idx) => 
                `<div class="mb-3">
                    <strong>${numero}.${idx + 1} Descri√ß√£o:</strong>
                    <p class="mb-0 mt-1">${item.modelo_texto}</p>
                </div>`
            ).join('');
            
            // Construir tabela de transa√ß√µes (compartilhada)
            const transacoesHtml = inc.transacoes.map(t => `
                <tr>
                    <td class="text-center">${t.indice || '-'}</td>
                    <td class="text-center">${formatarData(t.data)}</td>
                    <td class="text-end">${formatarMoeda(t.credito)}</td>
                    <td class="text-end">${formatarMoeda(t.debito)}</td>
                    <td class="text-end">${formatarMoeda(t.discriminacao)}</td>
                    <td class="text-center"><span class="badge bg-secondary">${t.cat_transacao || '-'}</span></td>
                    <td class="text-center">${formatarCompetencia(t.competencia)}</td>
                    <td>${t.origem_destino || '-'}</td>
                </tr>
            `).join('');
            
            const tabelaHtml = `
                <h6 class="mb-3">
                    <i class="bi bi-table me-2"></i>
                    Transa√ß√µes Identificadas (${inc.transacoes.length})
                </h6>
                <div class="table-responsive">
                    <table class="table table-sm table-hover table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th class="text-center">√çndice</th>
                                <th class="text-center">Data</th>
                                <th class="text-center">Cr√©dito (R$)</th>
                                <th class="text-center">D√©bito (R$)</th>
                                <th class="text-center">Discrimina√ß√£o (R$)</th>
                                <th class="text-center">Categoria</th>
                                <th class="text-center">Compet√™ncia</th>
                                <th>Origem/Destino</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${transacoesHtml}
                        </tbody>
                    </table>
                </div>
            `;
            
            const classeStatus = inc.ratificada ? 'border-success' : 'border-warning';
            const corHeader = inc.ratificada ? 'bg-success' : 'bg-warning';
            const textoHeader = inc.ratificada ? 'text-white' : 'text-dark';
            const iconeStatus = inc.ratificada ? 'bi-check-circle-fill' : 'bi-exclamation-triangle';
            const badgeStatus = inc.ratificada ? '<span class="badge bg-light text-success ms-2"><i class="bi bi-check-circle me-1"></i>Ratificada</span>' : '<span class="badge bg-light text-warning ms-2"><i class="bi bi-clock me-1"></i>Pendente</span>';
            
            // Contar total de inconsist√™ncias compostas
            const totalItens = inc.itens_compostos.length;
            
            // Serializar nomes dos itens para o data attribute
            const nomesItensJson = JSON.stringify(inc.itens_compostos.map(item => item.nome_item));
            
            return `
                <div class="card ${classeStatus} mb-4" id="card-inconsistencia-${index}" data-tipo-card="composto" data-nomes-itens='${nomesItensJson}' data-ratificada="${inc.ratificada}">
                    <div class="card-header ${corHeader} ${textoHeader}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge bg-dark me-2">CARD COMPOSTO</span>
                                ${titulosHtml}
                                <span class="badge bg-dark ms-2 mt-2">${inc.transacoes.length} registro(s)</span>
                                ${badgeStatus}
                            </div>
                            ${!inc.ratificada ? `<button class="btn btn-sm btn-outline-danger" onclick="excluirCard(${index}, event)" title="Excluir desta visualiza√ß√£o"><i class="bi bi-trash"></i></button>` : ''}
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Descri√ß√µes -->
                        <div class="alert alert-light border-start border-warning border-4 mb-3">
                            ${descricoesHtml}
                        </div>

                        ${tabelaHtml}
                    </div>
                </div>
            `;
        }

        // ============================================================
        // Excluir card (apenas visual, n√£o afeta banco de dados)
        // ============================================================
        function excluirCard(index, event) {
            event.stopPropagation();
            
            const card = document.getElementById(`card-inconsistencia-${index}`);
            const nomeItem = card.dataset.nomeItem;
            
            if (!confirm(`Deseja remover "${nomeItem}" desta visualiza√ß√£o?\n\nNota: Isso √© apenas visual. A inconsist√™ncia ser√° identificada novamente ao recarregar.`)) {
                return;
            }
            
            // Marcar como exclu√≠do (para ser ignorado em ratifica√ß√µes)
            card.dataset.excluido = 'true';
            
            // Anima√ß√£o de remo√ß√£o
            card.style.transition = 'all 0.3s ease';
            card.style.opacity = '0';
            card.style.transform = 'translateX(-100%)';
            
            setTimeout(() => {
                card.remove();
                
                // Atualizar contador do bot√£o de ratifica√ß√£o
                const cardsRestantes = document.querySelectorAll('[id^="card-inconsistencia-"]').length;
                if (cardsRestantes === 0) {
                    document.getElementById('containerInconsistencias').innerHTML = '';
                    document.getElementById('msgSemInconsistencias').style.display = 'block';
                }
            }, 300);
        }

        // ============================================================
        // Ratificar todas as inconsist√™ncias
        // ============================================================
        async function ratificarTodasInconsistencias(numeroTermo) {
            // Coletar todos os nomes de itens dos cards N√ÉO RATIFICADOS e N√ÉO EXCLU√çDOS
            const cards = document.querySelectorAll('[id^="card-inconsistencia-"][data-ratificada="false"]:not([data-excluido="true"])');
            const nomesItens = [];
            
            cards.forEach(card => {
                if (card.dataset.tipoCard === 'composto') {
                    // Card composto - adicionar todos os itens compostos
                    const nomesCompostos = JSON.parse(card.dataset.nomesItens);
                    nomesItens.push(...nomesCompostos);
                } else {
                    // Card simples
                    nomesItens.push(card.dataset.nomeItem);
                }
            });
            
            if (nomesItens.length === 0) {
                alert('‚ö†Ô∏è Nenhuma inconsist√™ncia para ratificar.');
                return;
            }
            
            if (!confirm(`Confirma a ratifica√ß√£o de ${nomesItens.length} inconsist√™ncia(s)?\n\nIsso ir√° registrar todas as transa√ß√µes identificadas na lista de inconsist√™ncias do termo.\n\nInconsist√™ncias:\n${nomesItens.map((n, i) => `${i+1}. ${n}`).join('\n')}`)) {
                return;
            }

            const btn = event.target.closest('button');
            const textOriginal = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Ratificando todas...';
            btn.disabled = true;

            try {
                let totalRegistros = 0;
                let erros = [];
                
                // Ratificar cada inconsist√™ncia
                for (const nomeItem of nomesItens) {
                    try {
                        const response = await fetch('/analises_pc/api/ratificar-inconsistencia', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                nome_item: nomeItem,
                                numero_termo: numeroTermo
                            })
                        });

                        const data = await response.json();

                        if (response.ok && data.sucesso) {
                            totalRegistros += data.registros_inseridos || 0;
                        } else {
                            erros.push(`${nomeItem}: ${data.erro || 'Erro desconhecido'}`);
                        }
                    } catch (error) {
                        erros.push(`${nomeItem}: ${error.message}`);
                    }
                }
                
                // Mostrar resultado
                if (erros.length === 0) {
                    alert(`‚úÖ Todas as inconsist√™ncias foram ratificadas com sucesso!\n\n${totalRegistros} registro(s) adicionado(s) √† lista de inconsist√™ncias.\n\nRecarregando p√°gina para atualizar status...`);
                } else {
                    alert(`‚ö†Ô∏è Ratifica√ß√£o conclu√≠da com alguns erros:\n\n‚úÖ Sucesso: ${nomesItens.length - erros.length}/${nomesItens.length}\n‚ùå Erros: ${erros.length}\n\nRegistros inseridos: ${totalRegistros}\n\nErros:\n${erros.join('\n')}\n\nRecarregando p√°gina para atualizar status...`);
                }
                
                // Recarregar inconsist√™ncias para atualizar status visual
                setTimeout(() => {
                    carregarInconsistencias(numeroTermo);
                }, 1000);
            } catch (error) {
                console.error('Erro ao ratificar inconsist√™ncias:', error);
                alert('‚ùå Erro ao ratificar inconsist√™ncias. Verifique o console.');
                btn.innerHTML = textOriginal;
                btn.disabled = false;
            }
        }

        // ============================================================
        // Ratificar inconsist√™ncia individual (mantida para compatibilidade)
        // ============================================================
        async function ratificarInconsistencia(nomeItem, index, numeroTermo) {
            if (!confirm(`Confirma a ratifica√ß√£o da inconsist√™ncia "${nomeItem}"?\n\nIsso ir√° registrar todas as transa√ß√µes identificadas na lista de inconsist√™ncias do termo.`)) {
                return;
            }

            const btn = event.target.closest('button');
            const textOriginal = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Ratificando...';
            btn.disabled = true;

            try {
                const response = await fetch('/analises_pc/api/ratificar-inconsistencia', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nome_item: nomeItem,
                        numero_termo: numeroTermo
                    })
                });

                const data = await response.json();

                if (response.ok && data.sucesso) {
                    // Remover card da tela
                    const card = document.getElementById(`card-inconsistencia-${index}`);
                    card.style.transition = 'all 0.5s ease';
                    card.style.opacity = '0';
                    card.style.transform = 'translateX(100%)';
                    
                    setTimeout(() => {
                        card.remove();
                        
                        // Verificar se ainda h√° inconsist√™ncias
                        const container = document.getElementById('containerInconsistencias');
                        if (container.children.length === 0) {
                            document.getElementById('msgSemInconsistencias').style.display = 'block';
                        }
                    }, 500);

                    alert(`‚úÖ Inconsist√™ncia ratificada com sucesso!\n\n${data.registros_inseridos} registro(s) adicionado(s) √† lista de inconsist√™ncias.`);
                } else {
                    alert('‚ùå Erro ao ratificar: ' + (data.erro || 'Erro desconhecido'));
                    btn.innerHTML = textOriginal;
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('Erro ao ratificar:', error);
                alert('‚ùå Erro ao ratificar inconsist√™ncia. Verifique o console.');
                btn.innerHTML = textOriginal;
                btn.disabled = false;
            }
        }

        // ============================================================
        // Toggle avalia√ß√£o detalhada (mostrar status individual)
        // ============================================================
        function toggleAvaliacaoDetalhada(index) {
            const checkbox = document.getElementById(`checkbox-detalhado-${index}`);
            const tabela = document.getElementById(`tabela-${index}`);
            
            if (checkbox.checked) {
                // Mostrar coluna de status individual
                tabela.querySelectorAll('.status-detalhado-header').forEach(el => el.style.display = '');
                tabela.querySelectorAll('.status-detalhado').forEach(el => el.style.display = '');
            } else {
                // Ocultar coluna de status individual
                tabela.querySelectorAll('.status-detalhado-header').forEach(el => el.style.display = 'none');
                tabela.querySelectorAll('.status-detalhado').forEach(el => el.style.display = 'none');
            }
        }

        // ============================================================
        // Atualizar status do card (n√≠vel de card)
        // ============================================================
        async function atualizarStatusCard(nomeItem, novoStatus, index, numeroTermo) {
            const select = event.target;
            const statusAnterior = select.dataset.statusAtual;
            
            if (statusAnterior === novoStatus) {
                return; // Sem mudan√ßa
            }
            
            try {
                const response = await fetch('/analises_pc/api/atualizar-status-inconsistencia', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nome_item: nomeItem,
                        numero_termo: numeroTermo,
                        status: novoStatus,
                        scope: 'card'
                    })
                });

                const data = await response.json();

                if (response.ok && data.sucesso) {
                    select.dataset.statusAtual = novoStatus;
                    
                    // Feedback visual
                    const card = document.getElementById(`card-inconsistencia-${index}`);
                    card.style.transition = 'all 0.3s ease';
                    card.style.transform = 'scale(1.02)';
                    setTimeout(() => {
                        card.style.transform = 'scale(1)';
                    }, 300);
                    
                    // Toast de sucesso (opcional)
                    console.log(`‚úÖ Status atualizado: ${statusAnterior} ‚Üí ${novoStatus} (${data.registros_atualizados} registro(s))`);
                } else {
                    alert('‚ùå Erro ao atualizar status: ' + (data.erro || 'Erro desconhecido'));
                    select.value = statusAnterior; // Reverter
                }
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
                alert('‚ùå Erro ao atualizar status. Verifique o console.');
                select.value = statusAnterior; // Reverter
            }
        }

        // ============================================================
        // Atualizar status de transa√ß√£o individual
        // ============================================================
        async function atualizarStatusTransacao(nomeItem, idConctrato, novoStatus, numeroTermo) {
            try {
                const response = await fetch('/analises_pc/api/atualizar-status-inconsistencia', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nome_item: nomeItem,
                        numero_termo: numeroTermo,
                        id_conc_extrato: idConctrato,
                        status: novoStatus,
                        scope: 'transaction'
                    })
                });

                const data = await response.json();

                if (response.ok && data.sucesso) {
                    // Feedback visual na linha
                    const row = event.target.closest('tr');
                    row.style.transition = 'all 0.3s ease';
                    row.style.backgroundColor = '#d4edda';
                    setTimeout(() => {
                        row.style.backgroundColor = '';
                    }, 1000);
                    
                    console.log(`‚úÖ Status da transa√ß√£o ${idConctrato} atualizado para: ${novoStatus}`);
                } else {
                    alert('‚ùå Erro ao atualizar status: ' + (data.erro || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
                alert('‚ùå Erro ao atualizar status. Verifique o console.');
            }
        }

        // ============================================================
        // Fun√ß√µes auxiliares de formata√ß√£o
        // ============================================================
        function formatarData(data) {
            if (!data) return '-';
            
            // Se j√° vier como string DD/MM/YYYY, retornar direto
            if (typeof data === 'string' && data.includes('/')) {
                return data;
            }
            
            // Tentar parsear diferentes formatos
            let d;
            if (typeof data === 'string' && data.includes('-')) {
                // Formato YYYY-MM-DD ou ISO
                d = new Date(data + 'T00:00:00');
            } else {
                d = new Date(data);
            }
            
            // Verificar se a data √© v√°lida
            if (isNaN(d.getTime())) {
                console.warn('[WARN] Data inv√°lida:', data);
                return String(data); // Retornar valor original como fallback
            }
            
            return d.toLocaleDateString('pt-BR');
        }

        function formatarCompetencia(competencia) {
            if (!competencia) return '-';
            
            // Se j√° vier formatado (ex: "Janeiro/2024"), retornar direto
            if (typeof competencia === 'string' && competencia.includes('/') && !competencia.includes('-')) {
                return competencia;
            }
            
            // Tentar parsear a data
            let d;
            if (typeof competencia === 'string' && competencia.includes('-')) {
                // Formato YYYY-MM-DD ou ISO
                d = new Date(competencia + 'T00:00:00');
            } else {
                d = new Date(competencia);
            }
            
            // Verificar se a data √© v√°lida
            if (isNaN(d.getTime())) {
                console.warn('[WARN] Compet√™ncia inv√°lida:', competencia);
                return String(competencia); // Retornar valor original como fallback
            }
            
            const mes = d.toLocaleDateString('pt-BR', { month: 'long' });
            const ano = d.getFullYear();
            return `${mes.charAt(0).toUpperCase() + mes.slice(1)}/${ano}`;
        }

        function formatarMoeda(valor) {
            if (!valor || isNaN(valor)) return 'R$ 0,00';
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor);
        }

        // ============================================================
        // Resetar Inconsist√™ncias
        // ============================================================
        async function resetarInconsistencias(numeroTermo) {
            if (!confirm(`‚ö†Ô∏è ATEN√á√ÉO!\n\nDeseja RESETAR todas as inconsist√™ncias ratificadas do termo ${numeroTermo}?\n\nIsso ir√° REMOVER permanentemente:\n- Todas as inconsist√™ncias da lista padr√£o\n- Todas as inconsist√™ncias agregadas\n- Todas as inconsist√™ncias globais\n\nEsta a√ß√£o N√ÉO PODE SER DESFEITA!\n\nDeseja continuar?`)) {
                return;
            }

            const btn = event.target.closest('button');
            const textOriginal = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Resetando...';
            btn.disabled = true;

            try {
                const response = await fetch(`/analises_pc/api/resetar-inconsistencias/${encodeURIComponent(numeroTermo)}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok && data.sucesso) {
                    alert(`‚úÖ Inconsist√™ncias resetadas com sucesso!\n\n${data.total_deletados} registro(s) removido(s):\n- Lista padr√£o: ${data.detalhes.lista_inconsistencias}\n- Agregadas: ${data.detalhes.lista_inconsistencias_agregadas}\n- Globais: ${data.detalhes.lista_inconsistencias_globais}\n\nRecarregando p√°gina...`);
                    
                    // Recarregar inconsist√™ncias
                    setTimeout(() => {
                        carregarInconsistencias(numeroTermo);
                    }, 1000);
                } else {
                    alert('‚ùå Erro ao resetar inconsist√™ncias: ' + (data.erro || 'Erro desconhecido'));
                    btn.innerHTML = textOriginal;
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('Erro ao resetar inconsist√™ncias:', error);
                alert('‚ùå Erro ao resetar inconsist√™ncias. Verifique o console.');
                btn.innerHTML = textOriginal;
                btn.disabled = false;
            }
        }

        // ============================================================
        // Gerar PDF do relat√≥rio
        // ============================================================
        async function gerarPDF() {
            if (!dadosRelatorioSelecionado) {
                alert('‚ö†Ô∏è Erro: dados do relat√≥rio n√£o encontrados.');
                return;
            }

            const mesInicio = document.getElementById('selectMesInicio').value;
            const mesFim = document.getElementById('selectMesFim').value;

            if (!mesInicio || !mesFim) {
                alert('‚ö†Ô∏è Selecione os meses de in√≠cio e fim!');
                return;
            }

            // Mostrar loading
            const btn = event.target;
            const textOriginal = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Gerando PDF...';
            btn.disabled = true;

            try {
                const response = await fetch('/analises_pc/api/gerar-pdf-relatorio-inconsistencias', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        numero_doc: dadosRelatorioSelecionado.numero_doc,
                        ano_doc: dadosRelatorioSelecionado.ano_doc,
                        numero_termo: dadosRelatorioSelecionado.numero_termo,
                        mes_inicio: mesInicio,
                        mes_fim: mesFim
                    })
                });

                if (response.ok) {
                    // Fazer download do PDF
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Relatorio_Inconsistencias_${dadosRelatorioSelecionado.numero_termo}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                    
                    alert('‚úÖ PDF gerado com sucesso!');
                } else {
                    const data = await response.json();
                    alert('‚ùå Erro ao gerar PDF: ' + (data.erro || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('‚ùå Erro ao gerar PDF. Verifique o console.');
            } finally {
                btn.innerHTML = textOriginal;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
