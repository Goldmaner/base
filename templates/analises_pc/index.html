<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-list de An√°lise de Presta√ß√£o de Contas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 30px;
            padding-bottom: 50px;
        }
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section-title {
            color: #0d6efd;
            border-bottom: 2px solid #0d6efd;
            padding-bottom: 10px;
            margin-bottom: 20px;
            margin-top: 30px;
        }
        .info-box {
            background-color: #e7f3ff;
            border-left: 4px solid #0d6efd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .checklist-item {
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            transition: background-color 0.3s;
        }
        .checklist-item:hover {
            background-color: #e9ecef;
        }
        .checklist-item.checked {
            background-color: #d1e7dd;
            border-color: #198754;
        }
        .checklist-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
        }
        .checklist-item label {
            margin: 0;
            cursor: pointer;
            user-select: none;
        }
        .recurso-section {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .recurso-title {
            color: #856404;
            font-weight: bold;
            margin-bottom: 15px;
        }
        #checklistArea {
            display: none;
        }
        .btn-action {
            margin: 5px;
        }
        .form-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .info-badge {
            display: inline-block;
            margin-left: 10px;
            cursor: pointer;
            background-color: #0d6efd;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: bold;
            vertical-align: middle;
            transition: all 0.3s;
            pointer-events: auto;
            z-index: 10;
            position: relative;
            border: none;
            outline: none;
        }
        .info-badge:hover {
            background-color: #0a58ca;
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(13, 110, 253, 0.4);
        }
        .info-badge:active {
            transform: scale(0.98);
        }
        .info-badge:focus {
            outline: 2px solid #0a58ca;
            outline-offset: 2px;
        }
        .info-badge.warning {
            background-color: #dc3545;
        }
        .info-badge.warning:hover {
            background-color: #bb2d3b;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
        }
        .modal-instrucao .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        .instrucao-content {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #0d6efd;
            margin-bottom: 20px;
            line-height: 1.8;
        }
        .instrucao-content ol,
        .instrucao-content ul {
            margin: 10px 0;
            padding-left: 30px;
        }
        .instrucao-content li {
            margin: 8px 0;
            font-size: 12pt;
        }
        .instrucao-content ul[type="circle"] {
            list-style-type: circle;
        }
        .sei-box {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #0d6efd;
        }
        .sei-box strong {
            color: #0d6efd;
        }
        .section-title-modal {
            background-color: #e9ecef;
            padding: 10px 15px;
            margin: 25px -15px 20px -15px;
            font-weight: bold;
            color: #495057;
            border-left: 4px solid #0d6efd;
        }
        #modalDadosBase .form-label {
            font-size: 0.95rem;
        }
        #modalDadosBase input[readonly],
        #modalDadosBase textarea[readonly],
        #modalDadosBase select[disabled] {
            background-color: #f8f9fa;
            border-color: #dee2e6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container main-container">
        <h2 class="text-center mb-4">Check-list de An√°lise de Presta√ß√£o de Contas</h2>

        <!-- Bot√µes de Navega√ß√£o -->
        <div class="mb-4 d-flex justify-content-between align-items-center">
            <div>
                <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
                    ‚Üê Voltar
                </a>
            </div>
            <div>
                <a href="{{ url_for('analises_pc.meus_processos') }}" class="btn btn-info">
                    <i class="bi bi-person-check"></i> Meus Processos
                </a>
                <a href="{{ url_for('analises_pc.central_modelos') }}" class="btn btn-outline-primary">
                    <i class="bi bi-file-earmark-text"></i> Central de Modelos
                </a>
            </div>
        </div>

        <!-- Se√ß√£o de Configura√ß√£o Inicial -->
        <div id="configSection" class="form-section">
            <h4 class="section-title">Dados Iniciais</h4>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="numeroTermo" class="form-label">N√∫mero do Termo *</label>
                    <select id="numeroTermo" class="form-select" required>
                        <option value="">Selecione...</option>
                        {% for termo in termos %}
                        <option value="{{ termo.numero_termo }}">{{ termo.numero_termo }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-4 mb-3">
                    <label for="mesesAnalisados" class="form-label">Meses em An√°lise *</label>
                    <select id="mesesAnalisados" class="form-select" required disabled>
                        <option value="">Selecione um termo primeiro...</option>
                    </select>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" id="novoMes" onchange="toggleNovoMes()">
                        <label class="form-check-label" for="novoMes">
                            Adicionar novo per√≠odo
                        </label>
                    </div>
                    <input type="text" class="form-control mt-2" id="mesesAnalisadosNovo" 
                           placeholder="Ex: 01/2024" style="display: none;">
                    <small class="text-muted">Formato: MM/AAAA</small>
                </div>
                
                <div class="col-md-4 mb-3">
                    <label for="analistas" class="form-label">Analista(s) Respons√°vel(is) *</label>
                    <select id="analistas" class="form-select" multiple required>
                        {% for analista in analistas %}
                        <option value="{{ analista.nome_analista }}">{{ analista.nome_analista }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="text-center mt-3">
                <button class="btn btn-primary btn-lg" onclick="carregarChecklist()">
                    Prosseguir
                </button>
            </div>
        </div>

        <!-- Se√ß√£o do Checklist (inicialmente oculta) -->
        <div id="checklistArea">
            <div class="info-box">
                <strong>Termo:</strong> <span id="infoTermo"></span> | 
                <strong>Meses:</strong> <span id="infoMeses"></span> | 
                <strong>Analista(s):</strong> <span id="infoAnalistas"></span>
            </div>

            <h4 class="section-title">Checklist de Etapas</h4>
            
            <!-- Checklist Principal -->
            <div id="checklistPrincipal">
                <div class="checklist-item" data-order="1">
                    <input type="checkbox" id="check_avaliacao_celebracao" onchange="handleCheckboxChange(this)">
                    <label for="check_avaliacao_celebracao">
                        Avalia√ß√£o do processo de celebra√ß√£o
                    </label>
                    <button type="button" class="info-badge" onclick="abrirModalInstrucao(); return false;">
                        üìã Ver Instru√ß√£o
                    </button>
                </div>
                
                <div class="checklist-item" data-order="2">
                    <input type="checkbox" id="check_avaliacao_prestacao_contas" onchange="handleCheckboxChange(this)">
                    <label for="check_avaliacao_prestacao_contas">
                        Avalia√ß√£o do processo de presta√ß√£o de contas / pagamento
                    </label>
                    <button type="button" class="info-badge" onclick="abrirModalInstrucaoPC(); return false;">
                        üìã Ver Instru√ß√£o
                    </button>
                </div>
                
                <div class="checklist-item" data-order="3">
                    <input type="checkbox" id="check_preenchimento_dados_base" onchange="handleCheckboxChange(this)">
                    <label for="check_preenchimento_dados_base">
                        Preenchimento de dados base
                    </label>
                    <button type="button" class="info-badge" onclick="abrirModalDadosBase(); return false;">
                        ‚úèÔ∏è Conferir e/ou concluir preenchimento
                    </button>
                </div>
                
                <div class="checklist-item" data-order="4">
                    <input type="checkbox" id="check_preenchimento_orcamento_anual" onchange="handleCheckboxChange(this)">
                    <label for="check_preenchimento_orcamento_anual">Preenchimento de or√ßamento anual</label>
                    <button type="button" class="info-badge" id="badgeOrcamento" onclick="abrirOrcamento(); return false;">
                        üìä Conferir, modificar e/ou preencher or√ßamento
                    </button>
                </div>
                
                <div class="checklist-item" data-order="5">
                    <input type="checkbox" id="check_preenchimento_conciliacao_bancaria" onchange="handleCheckboxChange(this)">
                    <label for="check_preenchimento_conciliacao_bancaria">Preenchimento da concilia√ß√£o banc√°ria</label>
                    <button class="btn btn-sm btn-info action-btn ms-3" onclick="abrirConciliacaoBancaria()" title="Construir e/ou consultar concilia√ß√µes banc√°rias">
                        <i class="bi bi-bank me-1"></i>Construir e/ou consultar concilia√ß√µes banc√°rias existentes
                    </button>
                </div>
                
                <div class="checklist-item" data-order="6">
                    <input type="checkbox" id="check_avaliacao_dados_bancarios" onchange="handleCheckboxChange(this)">
                    <label for="check_avaliacao_dados_bancarios">Avalia√ß√£o dos dados banc√°rios</label>
                </div>
                
                <div class="checklist-item" data-order="7">
                    <input type="checkbox" id="check_documentos_sei_1" onchange="handleCheckboxChange(this)">
                    <label for="check_documentos_sei_1">Extra√ß√£o, inclus√£o e encaminhamento de documentos no SEI</label>
                </div>
                
                <div class="checklist-item" data-order="8">
                    <input type="checkbox" id="check_avaliacao_resposta_inconsistencia" onchange="handleCheckboxChange(this)">
                    <label for="check_avaliacao_resposta_inconsistencia">Avalia√ß√£o das respostas de inconsist√™ncias da organiza√ß√£o (se houver)</label>
                </div>
                
                <div class="checklist-item" data-order="9">
                    <input type="checkbox" id="check_emissao_parecer" onchange="handleCheckboxChange(this)">
                    <label for="check_emissao_parecer">Emiss√£o de parecer ou manifesta√ß√£o cab√≠vel</label>
                </div>
                
                <div class="checklist-item" data-order="10">
                    <input type="checkbox" id="check_documentos_sei_2" onchange="handleCheckboxChange(this)">
                    <label for="check_documentos_sei_2">Extra√ß√£o, inclus√£o e encaminhamento de documentos no SEI</label>
                </div>
            </div>

            <!-- Se√ß√£o de Recursos -->
            <h4 class="section-title mt-4">Fases Recursais (se houver)</h4>
            <div id="recursosContainer"></div>
            
            <div class="text-center mt-3">
                <button class="btn btn-warning" onclick="adicionarRecurso()">
                    + Incluir Fase Recursal
                </button>
            </div>

            <!-- Checklist Final -->
            <h4 class="section-title mt-4">Etapas Finais</h4>
            <div id="checklistFinal">
                <div class="checklist-item" data-order="11">
                    <input type="checkbox" id="check_tratativas_restituicao" onchange="handleCheckboxChange(this)">
                    <label for="check_tratativas_restituicao">Tratativas de restitui√ß√£o</label>
                </div>
                
                <div class="checklist-item" data-order="12">
                    <input type="checkbox" id="check_encaminhamento_encerramento" onchange="handleCheckboxChange(this)">
                    <label for="check_encaminhamento_encerramento">Encaminhamentos para encerramento, CADIN ou prescri√ß√£o</label>
                </div>
            </div>

            <!-- Bot√µes de A√ß√£o -->
            <div class="d-flex justify-content-center mt-4">
                <button class="btn btn-success btn-lg btn-action" onclick="salvarChecklist()">
                    üíæ Salvar Avan√ßos
                </button>
                <button class="btn btn-secondary btn-action" onclick="voltarConfig()">
                    ‚Üê Voltar para Configura√ß√£o
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Instru√ß√£o -->
    <div class="modal fade modal-instrucao" id="modalInstrucao" tabindex="-1" aria-labelledby="modalInstrucaoLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalInstrucaoLabel">
                        üìã Instru√ß√£o: Avalia√ß√£o do Processo de Celebra√ß√£o
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Processo SEI de Celebra√ß√£o -->
                    <div class="sei-box mb-4">
                        <strong>üìÑ Processo SEI de Celebra√ß√£o:</strong>
                        <div id="seiCelebInfo" class="mt-2 fs-5">
                            <span class="spinner-border spinner-border-sm me-2"></span>Carregando...
                        </div>
                    </div>
                    
                    <!-- Instru√ß√£o -->
                    <div>
                        <h6 class="text-primary mb-3">üìñ Instru√ß√£o Completa:</h6>
                        <div class="instrucao-content" id="instrucaoTexto">
                            <div class="text-center text-muted">
                                <span class="spinner-border spinner-border-sm me-2"></span>Carregando instru√ß√£o...
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="{{ url_for('analises_pc.central_modelos') }}" class="btn btn-primary me-auto" target="_blank">
                        üìÅ Acessar Central de Modelos
                    </a>
                    <button type="button" class="btn btn-success" onclick="criarPastaModelo()" id="btnCriarPasta">
                        <i class="bi bi-folder-plus"></i> Criar Pasta Modelo
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        ‚úñ Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Instru√ß√£o de Presta√ß√£o de Contas -->
    <div class="modal fade modal-instrucao" id="modalInstrucaoPC" tabindex="-1" aria-labelledby="modalInstrucaoPCLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="modalInstrucaoPCLabel">
                        üìã Instru√ß√£o: Avalia√ß√£o do Processo de Presta√ß√£o de Contas
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Processo SEI de Presta√ß√£o de Contas -->
                    <div class="sei-box mb-4">
                        <strong>üìÑ Processo SEI de Presta√ß√£o de Contas / Pagamento:</strong>
                        <div id="seiPCInfo" class="mt-2 fs-5">
                            <span class="spinner-border spinner-border-sm me-2"></span>Carregando...
                        </div>
                    </div>
                    
                    <!-- Instru√ß√£o -->
                    <div>
                        <h6 class="text-success mb-3">üìñ Instru√ß√£o Completa:</h6>
                        <div class="instrucao-content" id="instrucaoPCTexto">
                            <div class="text-center text-muted">
                                <span class="spinner-border spinner-border-sm me-2"></span>Carregando instru√ß√£o...
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="{{ url_for('analises_pc.central_modelos') }}" class="btn btn-primary me-auto" target="_blank">
                        üìÅ Acessar Central de Modelos
                    </a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        ‚úñ Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Dados Base -->
    <div class="modal fade" id="modalDadosBase" tabindex="-1" aria-labelledby="modalDadosBaseLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="modalDadosBaseLabel">
                        ‚úèÔ∏è Dados Base da Parceria
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Alerta de termo rescindido -->
                    <div id="alertaRescisao" class="alert alert-danger d-none mb-4" role="alert">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>ATEN√á√ÉO:</strong> Este termo consta como <strong>RESCINDIDO</strong> no sistema.
                    </div>

                    <form id="formDadosBase">
                        <!-- Se√ß√£o: Identifica√ß√£o -->
                        <div class="section-title-modal">IDENTIFICA√á√ÉO DO TERMO</div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="db_numero_termo" class="form-label fw-bold">N√∫mero do Termo</label>
                                <input type="text" class="form-control" id="db_numero_termo" name="numero_termo" readonly>
                            </div>
                            <div class="col-md-6">
                                <label for="db_tipo_termo" class="form-label fw-bold">Tipo de Termo</label>
                                <input type="text" class="form-control" id="db_tipo_termo" name="tipo_termo">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="db_osc" class="form-label fw-bold">OSC (Organiza√ß√£o da Sociedade Civil)</label>
                            <input type="text" class="form-control" id="db_osc" name="osc">
                        </div>

                        <div class="mb-3">
                            <label for="db_projeto" class="form-label fw-bold">Projeto</label>
                            <textarea class="form-control" id="db_projeto" name="projeto" rows="2"></textarea>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="db_portaria" class="form-label fw-bold">Portaria Aplicada</label>
                                <select class="form-select" id="db_portaria" name="portaria">
                                    <option value="">Selecione a portaria...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="db_cnpj" class="form-label fw-bold">CNPJ</label>
                                <input type="text" class="form-control" id="db_cnpj" name="cnpj">
                            </div>
                        </div>

                        <!-- Se√ß√£o: Vig√™ncia e Valores -->
                        <div class="section-title-modal">VIG√äNCIA E VALORES</div>

                        <!-- Alerta de Termo Rescindido -->
                        <div id="alertaRescindido" class="alert alert-danger d-none mb-3" role="alert">
                            <div class="d-flex align-items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2" viewBox="0 0 16 16">
                                    <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                                </svg>
                                <div>
                                    <strong>‚ö†Ô∏è ATEN√á√ÉO: TERMO RESCINDIDO</strong><br>
                                    Este termo de parceria foi rescindido em <strong id="dataRescisaoTexto"></strong>.
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="db_inicio" class="form-label fw-bold">Data de In√≠cio</label>
                                <input type="date" class="form-control" id="db_inicio" name="inicio">
                            </div>
                            <div class="col-md-4">
                                <label for="db_final" class="form-label fw-bold">Data de T√©rmino</label>
                                <input type="date" class="form-control" id="db_final" name="final">
                            </div>
                            <div class="col-md-4">
                                <label for="db_meses" class="form-label fw-bold">Meses</label>
                                <input type="number" class="form-control" id="db_meses" name="meses" readonly style="background-color: #e9ecef;">
                            </div>
                        </div>

                        <!-- Campo de Data de Rescis√£o (aparece apenas se termo for rescindido) -->
                        <div class="row mb-3 d-none" id="rowDataRescisao">
                            <div class="col-md-12">
                                <label for="db_data_rescisao" class="form-label fw-bold">
                                    <span class="badge bg-danger">Data de Rescis√£o</span>
                                </label>
                                <input type="date" class="form-control border-danger" id="db_data_rescisao" name="data_rescisao" 
                                       readonly style="background-color: #f8d7da; font-weight: bold;">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="db_total_previsto" class="form-label fw-bold">Total Previsto (R$)</label>
                                <input type="text" class="form-control" id="db_total_previsto" name="total_previsto">
                            </div>
                            <div class="col-md-6">
                                <label for="db_total_pago" class="form-label fw-bold">Total Pago (R$)</label>
                                <input type="text" class="form-control" id="db_total_pago" name="total_pago">
                            </div>
                        </div>

                        <!-- Se√ß√£o: Dados Banc√°rios e Caracter√≠sticas -->
                        <div class="section-title-modal">DADOS BANC√ÅRIOS E CARACTER√çSTICAS</div>

                        <div class="mb-3">
                            <label for="db_conta" class="form-label fw-bold">Conta</label>
                            <input type="text" class="form-control" id="db_conta" name="conta">
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">√â transi√ß√£o de Portaria?</label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="transicao" id="db_transicao_sim" value="1">
                                        <label class="form-check-label" for="db_transicao_sim">Sim</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="transicao" id="db_transicao_nao" value="0">
                                        <label class="form-check-label" for="db_transicao_nao">N√£o</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Tem contrapartida?</label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="contrapartida" id="db_contrapartida_sim" value="1">
                                        <label class="form-check-label" for="db_contrapartida_sim">Sim</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="contrapartida" id="db_contrapartida_nao" value="0">
                                        <label class="form-check-label" for="db_contrapartida_nao">N√£o</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Se√ß√£o: Processos SEI -->
                        <div class="section-title-modal">PROCESSOS SEI</div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="db_sei_celeb" class="form-label fw-bold">SEI de Celebra√ß√£o</label>
                                <input type="text" class="form-control" id="db_sei_celeb" name="sei_celeb">
                            </div>
                            <div class="col-md-6">
                                <label for="db_sei_pc" class="form-label fw-bold">SEI de Pagamento/Presta√ß√£o de Contas</label>
                                <input type="text" class="form-control" id="db_sei_pc" name="sei_pc">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="db_sei_plano" class="form-label fw-bold">Documento SEI do Plano de Trabalho</label>
                                <input type="text" class="form-control" id="db_sei_plano" name="sei_plano">
                            </div>
                            <div class="col-md-6">
                                <label for="db_sei_orcamento" class="form-label fw-bold">Documento SEI de Or√ßamento Anual</label>
                                <input type="text" class="form-control" id="db_sei_orcamento" name="sei_orcamento">
                            </div>
                        </div>

                        <!-- Se√ß√£o: Pessoa Gestora -->
                        <div class="section-title-modal">PESSOA GESTORA</div>

                        <div class="mb-3">
                            <label for="db_nome_pg" class="form-label fw-bold">Nome da Pessoa Gestora</label>
                            <select class="form-select" id="db_nome_pg" name="nome_pg">
                                <option value="">Carregando...</option>
                            </select>
                            <small class="text-muted">Se n√£o houver pessoa gestora cadastrada, selecione uma da lista</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger me-auto" onclick="exportarDadosBasePDF()">
                        <i class="bi bi-file-pdf"></i> Exportar PDF
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        ‚úñ Cancelar
                    </button>
                    <button type="button" class="btn btn-success" onclick="salvarDadosBase()">
                        üíæ Salvar Altera√ß√µes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script>
        let recursosCount = 0;
        let checklistOrdem = [
            'avaliacao_celebracao',
            'avaliacao_prestacao_contas',
            'preenchimento_dados_base',
            'preenchimento_orcamento_anual',
            'preenchimento_conciliacao_bancaria',
            'avaliacao_dados_bancarios',
            'documentos_sei_1',
            'avaliacao_resposta_inconsistencia',
            'emissao_parecer',
            'documentos_sei_2',
            'tratativas_restituicao',
            'encaminhamento_encerramento'
        ];

        // Inicializar Select2
        $(document).ready(function() {
            $('#numeroTermo').select2({
                theme: 'bootstrap-5',
                placeholder: 'Selecione um termo...',
                allowClear: true
            });
            
            // Quando selecionar um termo, buscar meses dispon√≠veis
            $('#numeroTermo').on('change', function() {
                const numeroTermo = $(this).val();
                if (numeroTermo) {
                    buscarMesesDisponiveis(numeroTermo);
                } else {
                    $('#mesesAnalisados').prop('disabled', true).html('<option value="">Selecione um termo primeiro...</option>');
                    $('#novoMes').prop('checked', false);
                    $('#mesesAnalisadosNovo').hide();
                }
            });

            $('#analistas').select2({
                theme: 'bootstrap-5',
                placeholder: 'Selecione um ou mais analistas...',
                allowClear: true
            });
            
            $('#mesesAnalisados').select2({
                theme: 'bootstrap-5',
                placeholder: 'Selecione o per√≠odo...',
                allowClear: true
            });
            
            // Verificar se h√° par√¢metros de URL (vindos de "Meus Processos")
            const urlParams = new URLSearchParams(window.location.search);
            const termoParam = urlParams.get('termo');
            const mesesParam = urlParams.get('meses');
            const autoLoad = urlParams.get('autoload') === 'true'; // Flag para carregar automaticamente
            
            if (termoParam && mesesParam) {
                // Aguardar um pouco para garantir que o Select2 foi inicializado
                setTimeout(async () => {
                    // Selecionar o termo
                    $('#numeroTermo').val(termoParam).trigger('change');
                    
                    // Aguardar carregar os meses
                    await buscarMesesDisponiveis(termoParam);
                    
                    // Selecionar o m√™s
                    setTimeout(async () => {
                        $('#mesesAnalisados').val(mesesParam).trigger('change');
                        
                        if (autoLoad) {
                            // Carregar analistas do checklist existente e depois carregar automaticamente
                            setTimeout(async () => {
                                await carregarChecklistAutomatico(termoParam, mesesParam);
                            }, 800);
                        } else {
                            // Apenas rolar para o formul√°rio
                            $('html, body').animate({
                                scrollTop: $('#configSection').offset().top - 20
                            }, 500);
                        }
                    }, 500);
                }, 300);
            }
        });
        
        async function carregarChecklistAutomatico(numeroTermo, mesesAnalisados) {
            try {
                // Primeiro, buscar os analistas do checklist
                const response = await fetch('/analises_pc/api/carregar_checklist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        numero_termo: numeroTermo,
                        meses_analisados: mesesAnalisados
                    })
                });

                const data = await response.json();
                
                if (data.analistas && data.analistas.length > 0) {
                    // Selecionar os analistas
                    $('#analistas').val(data.analistas).trigger('change');
                    
                    // Aguardar um pouco e depois carregar o checklist
                    setTimeout(() => {
                        carregarChecklist();
                    }, 300);
                } else {
                    // Se n√£o houver analistas, apenas rolar para o formul√°rio
                    $('html, body').animate({
                        scrollTop: $('#configSection').offset().top - 20
                    }, 500);
                }
            } catch (error) {
                console.error('Erro ao carregar checklist automaticamente:', error);
                // Em caso de erro, apenas rolar para o formul√°rio
                $('html, body').animate({
                    scrollTop: $('#configSection').offset().top - 20
                }, 500);
            }
        }
        
        async function buscarMesesDisponiveis(numeroTermo) {
            try {
                const response = await fetch('/analises_pc/api/buscar_meses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        numero_termo: numeroTermo
                    })
                });
                const data = await response.json();
                
                const selectMeses = $('#mesesAnalisados');
                selectMeses.html('');
                
                if (data.meses && data.meses.length > 0) {
                    selectMeses.append('<option value="">Selecione o per√≠odo...</option>');
                    data.meses.forEach(mes => {
                        selectMeses.append(`<option value="${mes}">${mes} (existente)</option>`);
                    });
                    selectMeses.prop('disabled', false);
                } else {
                    selectMeses.append('<option value="">Nenhum per√≠odo encontrado</option>');
                    selectMeses.prop('disabled', true);
                    // Marcar automaticamente "novo per√≠odo"
                    $('#novoMes').prop('checked', true);
                    toggleNovoMes();
                }
                
                // Reinicializar Select2
                selectMeses.select2({
                    theme: 'bootstrap-5',
                    placeholder: 'Selecione o per√≠odo...',
                    allowClear: true
                });
                
            } catch (error) {
                console.error('Erro ao buscar meses:', error);
                alert('Erro ao buscar per√≠odos dispon√≠veis');
            }
        }
        
        function toggleNovoMes() {
            const checkbox = $('#novoMes');
            const inputNovo = $('#mesesAnalisadosNovo');
            const selectExistente = $('#mesesAnalisados');
            
            if (checkbox.is(':checked')) {
                inputNovo.show();
                selectExistente.prop('disabled', true);
                selectExistente.val('').trigger('change');
            } else {
                inputNovo.hide();
                inputNovo.val('');
                if ($('#numeroTermo').val()) {
                    selectExistente.prop('disabled', false);
                }
            }
        }

        async function carregarChecklist() {
            const numeroTermo = $('#numeroTermo').val();
            let mesesAnalisados;
            
            // Verificar se est√° usando novo per√≠odo ou existente
            if ($('#novoMes').is(':checked')) {
                mesesAnalisados = $('#mesesAnalisadosNovo').val();
            } else {
                mesesAnalisados = $('#mesesAnalisados').val();
            }
            
            const analistas = $('#analistas').val();

            if (!numeroTermo || !mesesAnalisados || !analistas || analistas.length === 0) {
                alert('Por favor, preencha todos os campos obrigat√≥rios!');
                return;
            }

            try {
                const response = await fetch('/analises_pc/api/carregar_checklist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        numero_termo: numeroTermo,
                        meses_analisados: mesesAnalisados
                    })
                });

                const data = await response.json();

                // Atualizar informa√ß√µes
                $('#infoTermo').text(numeroTermo);
                $('#infoMeses').text(mesesAnalisados);
                $('#infoAnalistas').text(analistas.join(', '));

                // Limpar checkboxes
                $('input[type="checkbox"]').prop('checked', false);
                $('.checklist-item').removeClass('checked');

                // Preencher checklist se existir
                if (data.checklist) {
                    Object.keys(data.checklist).forEach(key => {
                        const checkbox = $(`#check_${key}`);
                        if (checkbox.length && data.checklist[key]) {
                            checkbox.prop('checked', true);
                            checkbox.closest('.checklist-item').addClass('checked');
                        }
                    });
                }

                // Carregar recursos
                recursosCount = 0;
                $('#recursosContainer').empty();
                if (data.recursos && data.recursos.length > 0) {
                    data.recursos.forEach(recurso => {
                        adicionarRecurso(recurso);
                    });
                }

                // Mostrar checklist
                $('#configSection').hide();
                $('#checklistArea').show();
                
                // Buscar e armazenar informa√ß√µes adicionais (instru√ß√£o + SEI)
                await carregarInfoAdicional(numeroTermo);

            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao carregar checklist!');
            }
        }
        
        // Vari√°veis globais para armazenar dados da instru√ß√£o
        let dadosInstrucao = {
            instrucao: null,
            sei_celeb: null,
            instrucao_pc: null,
            sei_pc: null
        };
        
        async function carregarInfoAdicional(numeroTermo) {
            try {
                const response = await fetch('/analises_pc/api/buscar_info_adicional', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        numero_termo: numeroTermo
                    })
                });
                
                const data = await response.json();
                
                // Armazenar dados globalmente
                dadosInstrucao.instrucao = data.instrucao;
                dadosInstrucao.sei_celeb = data.sei_celeb;
                dadosInstrucao.instrucao_pc = data.instrucao_pc;
                dadosInstrucao.sei_pc = data.sei_pc;
                
            } catch (error) {
                console.error('Erro ao carregar informa√ß√µes adicionais:', error);
                dadosInstrucao.instrucao = null;
                dadosInstrucao.sei_celeb = null;
                dadosInstrucao.instrucao_pc = null;
                dadosInstrucao.sei_pc = null;
            }
        }
        
        function abrirModalInstrucao() {
            // Preencher SEI de Celebra√ß√£o
            const seiElement = document.getElementById('seiCelebInfo');
            if (dadosInstrucao.sei_celeb) {
                seiElement.innerHTML = `<strong class="text-primary fs-4">${dadosInstrucao.sei_celeb}</strong>`;
            } else {
                seiElement.innerHTML = `<em class="text-muted">Processo SEI n√£o informado no cadastro do termo</em>`;
            }
            
            // Preencher Instru√ß√£o
            const instrucaoElement = document.getElementById('instrucaoTexto');
            if (dadosInstrucao.instrucao) {
                instrucaoElement.innerHTML = dadosInstrucao.instrucao;
            } else {
                instrucaoElement.innerHTML = `<em class="text-muted">Instru√ß√£o n√£o cadastrada no sistema</em>`;
            }
            
            // Abrir modal
            const modal = new bootstrap.Modal(document.getElementById('modalInstrucao'));
            modal.show();
        }
        
        function abrirModalInstrucaoPC() {
            // Preencher SEI de Presta√ß√£o de Contas
            const seiElement = document.getElementById('seiPCInfo');
            if (dadosInstrucao.sei_pc) {
                seiElement.innerHTML = `<strong class="text-success fs-4">${dadosInstrucao.sei_pc}</strong>`;
            } else {
                seiElement.innerHTML = `<em class="text-muted">Processo SEI n√£o informado no cadastro do termo</em>`;
            }
            
            // Preencher Instru√ß√£o
            const instrucaoElement = document.getElementById('instrucaoPCTexto');
            if (dadosInstrucao.instrucao_pc) {
                instrucaoElement.innerHTML = dadosInstrucao.instrucao_pc;
            } else {
                instrucaoElement.innerHTML = `<em class="text-muted">Instru√ß√£o n√£o cadastrada no sistema</em>`;
            }
            
            // Abrir modal
            const modal = new bootstrap.Modal(document.getElementById('modalInstrucaoPC'));
            modal.show();
        }
        
        // Fun√ß√£o para abrir modal de dados base
        async function abrirModalDadosBase() {
            console.log('[DEBUG] abrirModalDadosBase chamada');
            
            const numeroTermo = document.getElementById('numeroTermo').value;
            console.log('[DEBUG] N√∫mero do termo:', numeroTermo);
            
            if (!numeroTermo) {
                alert('Selecione um termo primeiro!');
                return;
            }
            
            try {
                console.log('[DEBUG] Fazendo fetch para buscar_dados_base...');
                
                // Buscar dados da parceria
                const response = await fetch('/analises_pc/api/buscar_dados_base', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        numero_termo: numeroTermo
                    })
                });
                
                console.log('[DEBUG] Response recebida:', response.status);
                
                const data = await response.json();
                console.log('[DEBUG] Data recebida:', data);
                
                if (data.error) {
                    alert('Erro ao carregar dados: ' + data.error);
                    return;
                }
                
                // Mostrar alerta e campo se termo √© rescindido
                if (data.is_rescindido && data.data_rescisao) {
                    // Mostrar alerta
                    document.getElementById('alertaRescindido').classList.remove('d-none');
                    
                    // Formatar data para exibi√ß√£o no alerta (DD/MM/YYYY)
                    const dataRescisao = new Date(data.data_rescisao);
                    const dataFormatada = dataRescisao.toLocaleDateString('pt-BR');
                    document.getElementById('dataRescisaoTexto').textContent = dataFormatada;
                    
                    // Mostrar campo de data de rescis√£o
                    document.getElementById('rowDataRescisao').classList.remove('d-none');
                    document.getElementById('db_data_rescisao').value = data.data_rescisao;
                } else {
                    // Esconder alerta e campo
                    document.getElementById('alertaRescindido').classList.add('d-none');
                    document.getElementById('rowDataRescisao').classList.add('d-none');
                }
                
                console.log('[DEBUG] Preenchendo formul√°rio...');
                // Preencher formul√°rio
                preencherFormularioDadosBase(data.parceria);
                
                console.log('[DEBUG] Carregando portarias...');
                // Carregar lista de portarias
                await carregarListaPortarias(data.parceria.portaria);
                
                console.log('[DEBUG] Carregando pessoas gestoras...');
                // Carregar lista de pessoas gestoras
                await carregarListaPessoasGestoras(data.nome_pg);
                
                console.log('[DEBUG] Abrindo modal...');
                // Abrir modal
                const modal = new bootstrap.Modal(document.getElementById('modalDadosBase'));
                modal.show();
                console.log('[DEBUG] Modal aberta!');
                
            } catch (error) {
                console.error('[ERRO] Erro ao carregar dados base:', error);
                alert('Erro ao carregar dados da parceria: ' + error.message);
            }
        }
        
        // Fun√ß√£o para preencher o formul√°rio
        function preencherFormularioDadosBase(parceria) {
            // Fun√ß√£o auxiliar para verificar se o valor √© vazio/nulo/NaN
            function isValorVazio(valor) {
                return valor === null || valor === undefined || valor === '' || 
                       (typeof valor === 'number' && isNaN(valor)) ||
                       (typeof valor === 'string' && valor.toLowerCase() === 'nan');
            }
            
            // Preencher campos de texto
            const campos = [
                'numero_termo', 'tipo_termo', 'osc', 'projeto', 
                'cnpj', 'inicio', 'final', 'meses', 'total_previsto', 'total_pago',
                'conta', 'sei_celeb', 'sei_pc', 'sei_plano', 'sei_orcamento'
            ];
            
            campos.forEach(campo => {
                const elemento = document.getElementById(`db_${campo}`);
                if (elemento) {
                    const valor = parceria[campo];
                    
                    // Definir valor
                    if (campo === 'inicio' || campo === 'final') {
                        // Formatar datas
                        elemento.value = valor && !isValorVazio(valor) ? valor.split('T')[0] : '';
                    } else {
                        elemento.value = valor && !isValorVazio(valor) ? valor : '';
                    }
                    
                    // Definir se √© readonly baseado em se tem valor
                    if (campo !== 'numero_termo' && campo !== 'meses') {
                        if (!isValorVazio(valor)) {
                            elemento.setAttribute('readonly', 'readonly');
                            elemento.style.backgroundColor = '#f8f9fa';
                            elemento.style.cursor = 'not-allowed';
                        } else {
                            elemento.removeAttribute('readonly');
                            elemento.style.backgroundColor = 'white';
                            elemento.style.cursor = 'text';
                        }
                    }
                }
            });
            
            // Preencher radio buttons - SEMPRE EDIT√ÅVEIS
            if (parceria.transicao !== null && parceria.transicao !== undefined) {
                const transicaoValue = parceria.transicao;
                if (transicaoValue === 1 || transicaoValue === '1') {
                    document.getElementById('db_transicao_sim').checked = true;
                } else {
                    document.getElementById('db_transicao_nao').checked = true;
                }
            }
            
            if (parceria.contrapartida !== null && parceria.contrapartida !== undefined) {
                const contrapartidaValue = parceria.contrapartida;
                if (contrapartidaValue === 1 || contrapartidaValue === '1') {
                    document.getElementById('db_contrapartida_sim').checked = true;
                } else {
                    document.getElementById('db_contrapartida_nao').checked = true;
                }
            }
        }
        
        // Fun√ß√£o para carregar lista de portarias
        async function carregarListaPortarias(portariaAtual) {
            try {
                const response = await fetch('/analises_pc/api/listar_portarias');
                const data = await response.json();
                
                const select = document.getElementById('db_portaria');
                select.innerHTML = '<option value="">Selecione a portaria...</option>';
                
                if (data.portarias && data.portarias.length > 0) {
                    data.portarias.forEach(port => {
                        const option = document.createElement('option');
                        option.value = port.lei;
                        option.textContent = port.lei;
                        if (portariaAtual && port.lei === portariaAtual) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar portarias:', error);
            }
        }
        
        // Fun√ß√£o para carregar lista de pessoas gestoras
        async function carregarListaPessoasGestoras(nomePgAtual) {
            try {
                const response = await fetch('/analises_pc/api/listar_pessoas_gestoras');
                const data = await response.json();
                
                const select = document.getElementById('db_nome_pg');
                select.innerHTML = '<option value="">Selecione uma pessoa gestora</option>';
                
                if (data.pessoas_gestoras && data.pessoas_gestoras.length > 0) {
                    data.pessoas_gestoras.forEach(pg => {
                        const option = document.createElement('option');
                        option.value = pg.nome_pg;
                        option.textContent = pg.nome_pg;
                        if (nomePgAtual && pg.nome_pg === nomePgAtual) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                }
                
            } catch (error) {
                console.error('Erro ao carregar pessoas gestoras:', error);
            }
        }
        
        // Fun√ß√£o para salvar dados base
        async function salvarDadosBase() {
            const numeroTermo = document.getElementById('db_numero_termo').value;
            const formData = new FormData(document.getElementById('formDadosBase'));
            
            const dados = {};
            formData.forEach((value, key) => {
                dados[key] = value;
            });
            
            try {
                const response = await fetch('/analises_pc/api/salvar_dados_base', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        numero_termo: numeroTermo,
                        dados: dados
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Dados salvos com sucesso!');
                    bootstrap.Modal.getInstance(document.getElementById('modalDadosBase')).hide();
                } else {
                    alert('Erro ao salvar: ' + (result.error || 'Erro desconhecido'));
                }
                
            } catch (error) {
                console.error('Erro ao salvar dados base:', error);
                alert('Erro ao salvar dados');
            }
        }

        // Fun√ß√£o para exportar dados base para PDF
        function exportarDadosBasePDF() {
            const numeroTermo = document.getElementById('db_numero_termo').value;
            
            if (!numeroTermo) {
                alert('Nenhum termo selecionado para exportar.');
                return;
            }
            
            // Mostrar indicador de carregamento
            const btnExportar = event.target.closest('button');
            const textoOriginal = btnExportar.innerHTML;
            btnExportar.disabled = true;
            btnExportar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Gerando PDF...';
            
            // Fazer requisi√ß√£o para a API de exporta√ß√£o
            window.location.href = `/analises_pc/api/exportar_dados_base_pdf?numero_termo=${encodeURIComponent(numeroTermo)}`;
            
            // Restaurar bot√£o ap√≥s um tempo
            setTimeout(() => {
                btnExportar.disabled = false;
                btnExportar.innerHTML = textoOriginal;
            }, 2000);
        }

        // Fun√ß√£o para verificar e abrir or√ßamento anual
        async function abrirOrcamento() {
            const numeroTermo = document.getElementById('numeroTermo').value;
            
            if (!numeroTermo) {
                alert('Selecione um termo primeiro!');
                return;
            }
            
            try {
                // Verificar se existe or√ßamento
                const response = await fetch('/analises_pc/api/verificar_orcamento', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        numero_termo: numeroTermo
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert('Erro ao verificar or√ßamento: ' + data.error);
                    return;
                }
                
                const badge = document.getElementById('badgeOrcamento');
                
                if (!data.tem_orcamento) {
                    // N√£o tem or√ßamento - badge vermelha
                    badge.classList.add('warning');
                    
                    // Mostrar alerta
                    const confirmacao = confirm(
                        '‚ö†Ô∏è O or√ßamento anual dessa parceria deve ser preenchido.\n\n' +
                        'Deseja abrir a p√°gina de or√ßamento para preencher agora?'
                    );
                    
                    if (confirmacao) {
                        // Abrir em nova aba
                        window.open(data.url_orcamento, '_blank');
                    }
                } else {
                    // Tem or√ßamento - badge azul
                    badge.classList.remove('warning');
                    
                    // Abrir em nova aba para visualizar/editar
                    window.open(data.url_orcamento, '_blank');
                }
                
            } catch (error) {
                console.error('Erro ao verificar or√ßamento:', error);
                alert('Erro ao verificar or√ßamento do termo');
            }
        }

        function abrirConciliacaoBancaria() {
            const numeroTermo = document.getElementById('numeroTermo').value;
            
            if (!numeroTermo) {
                alert('Selecione um termo primeiro!');
                return;
            }
            
            // Abrir p√°gina de concilia√ß√£o banc√°ria em nova aba com o termo pr√©-selecionado
            const url = `/conc_bancaria/?termo=${encodeURIComponent(numeroTermo)}`;
            window.open(url, '_blank');
        }

        function adicionarRecurso(recursoData = null) {
            recursosCount++;
            const tipoRecurso = recursoData ? recursoData.tipo_recurso : recursosCount;
            
            const recursoHtml = `
                <div class="recurso-section" data-tipo="${tipoRecurso}">
                    <div class="recurso-title">
                        Recurso ${tipoRecurso}
                        <button class="btn btn-sm btn-danger float-end" onclick="removerRecurso(this)">
                            ‚úñ Remover
                        </button>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="recurso_${tipoRecurso}_resposta" 
                               ${recursoData && recursoData.avaliacao_resposta_recursal ? 'checked' : ''}>
                        <label for="recurso_${tipoRecurso}_resposta">
                            Avalia√ß√£o das respostas recursais da organiza√ß√£o
                        </label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="recurso_${tipoRecurso}_parecer"
                               ${recursoData && recursoData.emissao_parecer_recursal ? 'checked' : ''}>
                        <label for="recurso_${tipoRecurso}_parecer">
                            Emiss√£o de parecer ou manifesta√ß√£o cab√≠vel
                        </label>
                    </div>
                    
                    <div class="checklist-item">
                        <input type="checkbox" id="recurso_${tipoRecurso}_documentos"
                               ${recursoData && recursoData.documentos_sei ? 'checked' : ''}>
                        <label for="recurso_${tipoRecurso}_documentos">
                            Extra√ß√£o, inclus√£o e encaminhamento de documentos no SEI
                        </label>
                    </div>
                </div>
            `;
            
            $('#recursosContainer').append(recursoHtml);
        }

        function removerRecurso(btn) {
            if (confirm('Tem certeza que deseja remover esta fase recursal?')) {
                $(btn).closest('.recurso-section').remove();
            }
        }

        function handleCheckboxChange(checkbox) {
            const item = $(checkbox).closest('.checklist-item');
            
            if (checkbox.checked) {
                item.addClass('checked');
                
                // Marcar todas as anteriores automaticamente
                const order = parseInt(item.data('order'));
                if (order) {
                    $('.checklist-item').each(function() {
                        const itemOrder = parseInt($(this).data('order'));
                        if (itemOrder && itemOrder < order) {
                            $(this).find('input[type="checkbox"]').prop('checked', true);
                            $(this).addClass('checked');
                        }
                    });
                }
            } else {
                item.removeClass('checked');
            }
        }

        async function salvarChecklist() {
            const numeroTermo = $('#infoTermo').text();
            const mesesAnalisados = $('#infoMeses').text();
            const analistas = $('#analistas').val();

            // Coletar dados do checklist principal
            const checklistData = {};
            checklistOrdem.forEach(item => {
                const checkbox = $(`#check_${item}`);
                checklistData[item] = checkbox.prop('checked') || false;
            });

            // Coletar dados dos recursos
            const recursos = [];
            $('.recurso-section').each(function() {
                const tipoRecurso = parseInt($(this).data('tipo'));
                recursos.push({
                    tipo_recurso: tipoRecurso,
                    avaliacao_resposta_recursal: $(`#recurso_${tipoRecurso}_resposta`).prop('checked') || false,
                    emissao_parecer_recursal: $(`#recurso_${tipoRecurso}_parecer`).prop('checked') || false,
                    documentos_sei: $(`#recurso_${tipoRecurso}_documentos`).prop('checked') || false
                });
            });

            try {
                const response = await fetch('/analises_pc/api/salvar_checklist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        numero_termo: numeroTermo,
                        meses_analisados: mesesAnalisados,
                        nome_analista: analistas[0], // Para compatibilidade
                        analistas: analistas,
                        checklist: checklistData,
                        recursos: recursos
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('‚úì Checklist salvo com sucesso!');
                } else {
                    alert('Erro ao salvar: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao salvar checklist!');
            }
        }

        function voltarConfig() {
            if (confirm('Deseja voltar para a configura√ß√£o? Certifique-se de salvar seus avan√ßos antes.')) {
                $('#checklistArea').hide();
                $('#configSection').show();
            }
        }

        async function criarPastaModelo() {
            const numeroTermo = $('#numeroTermo').val();
            
            if (!numeroTermo) {
                alert('‚ùå Por favor, selecione um termo primeiro!');
                return;
            }

            const btn = document.getElementById('btnCriarPasta');
            const btnOriginalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Criando pastas...';

            try {
                const response = await fetch('/analises_pc/api/criar_pasta_modelo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        numero_termo: numeroTermo
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('‚úÖ ' + data.message + '\n\nüìÅ Pasta criada em:\n' + data.caminho);
                } else {
                    alert('‚ùå Erro: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao criar pasta modelo!');
            } finally {
                btn.disabled = false;
                btn.innerHTML = btnOriginalHTML;
            }
        }
    </script>
</body>
</html>
