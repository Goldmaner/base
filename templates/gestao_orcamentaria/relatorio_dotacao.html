<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório de Dotação Orçamentária - Gestão Orçamentária</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    
    <style>
    body {
        background: #f5f5f5;
        min-height: 100vh;
        padding: 20px;
    }
    
    .main-container {
        max-width: 98%;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .header-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .filter-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .table-container {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow-x: auto;
    }
    
    .agrupado-container {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .table-dotacoes {
        width: 100%;
        font-size: 0.9rem;
    }
    
    .table-dotacoes th {
        background-color: #667eea;
        color: white;
        font-weight: 600;
        text-align: center;
        vertical-align: middle;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .table-dotacoes td {
        vertical-align: middle;
    }
    
    .valor-positivo {
        color: #28a745;
        font-weight: 600;
    }
    
    .valor-negativo {
        color: #dc3545;
        font-weight: 600;
    }
    
    .info-badge {
        background-color: #e9ecef;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        font-size: 0.9rem;
        display: inline-block;
        margin-right: 1rem;
        margin-bottom: 0.5rem;
    }
    
    .btn-action {
        margin: 0.25rem;
    }
    
    .ultima-atualizacao {
        font-size: 0.85rem;
        color: #6c757d;
        font-style: italic;
    }
    
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }
    
    .loading-content {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        text-align: center;
    }
</style>
</head>
<body>
<div class="main-container">

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Carregando...</span>
        </div>
        <p class="mt-3 mb-0">Carregando dados...</p>
    </div>
</div>

<!-- Header -->
<div class="header-section">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2 class="mb-2">
                <i class="bi bi-graph-up-arrow me-2"></i>
                Relatório de Dotação Orçamentária
            </h2>
            <p class="mb-0 opacity-75">Consulte saldos, valores pagos e detalhamento por projeto-atividade</p>
        </div>
        <button class="btn btn-light btn-lg" onclick="window.location.href='/gestao_orcamentaria'">
            <i class="bi bi-arrow-left me-2"></i>Voltar
        </button>
    </div>
</div>

<!-- Filtros -->
<div class="filter-card">
    <h5 class="mb-3">
        <i class="bi bi-funnel me-2"></i>Filtros
    </h5>
    <div class="row g-3">
        <div class="col-md-4">
            <label for="filtroConta" class="form-label">Código da Conta Despesa</label>
            <input type="text" class="form-control" id="filtroConta" value="33503900" placeholder="Digite o código">
        </div>
        <div class="col-md-4">
            <label for="filtroProjeto" class="form-label">Código do Projeto-Atividade</label>
            <input type="text" class="form-control" id="filtroProjeto" placeholder="Digite parte do código (opcional)">
        </div>
        <div class="col-md-4 d-flex align-items-end">
            <button class="btn btn-primary w-100" onclick="carregarDados()">
                <i class="bi bi-search me-2"></i>Buscar
            </button>
        </div>
    </div>
</div>

<!-- Informações e Ações -->
<div class="mb-3 d-flex justify-content-between align-items-center">
    <div>
        <span class="info-badge">
            <i class="bi bi-table me-1"></i>
            <strong id="totalRegistros">0</strong> registros
        </span>
        <span class="info-badge ultima-atualizacao">
            <i class="bi bi-clock me-1"></i>
            Última atualização: <strong id="ultimaAtualizacao">-</strong>
        </span>
    </div>
    <button class="btn btn-success" onclick="exportarCSV()">
        <i class="bi bi-file-earmark-spreadsheet me-2"></i>Exportar CSV
    </button>
</div>

<!-- Tabela Principal -->
<div class="table-container">
    <h5 class="mb-3">
        <i class="bi bi-list-ul me-2"></i>Detalhamento das Dotações
    </h5>
    <table class="table table-hover table-bordered table-dotacoes" id="tabelaDotacoes">
        <thead>
            <tr>
                <th style="width: 12%;">Dotação Formatada</th>
                <th style="width: 10%;">Código Proj-Ativ</th>
                <th style="width: 22%;">Texto Projeto-Atividade</th>
                <th style="width: 8%;">Cód. Conta</th>
                <th style="width: 12%;">Saldo Dotação</th>
                <th style="width: 12%;">Valor Total Empenhado</th>
                <th style="width: 12%;">Valor Total Pago</th>
                <th style="width: 12%;">Data Atualização</th>
            </tr>
        </thead>
        <tbody id="corpoTabela">
            <tr>
                <td colspan="8" class="text-center text-muted py-5">
                    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                    <p class="mt-2">Nenhum dado encontrado. Use os filtros acima para buscar.</p>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Relatório Agrupado -->
<div class="agrupado-container">
    <h5 class="mb-3">
        <i class="bi bi-pie-chart me-2"></i>Relatório por Dotação Orçamentária com Saldo
    </h5>
    <div class="mb-3">
        <span class="info-badge">
            <i class="bi bi-layers me-1"></i>
            <strong id="totalProjetos">0</strong> dotações
        </span>
    </div>
    <table class="table table-hover table-bordered table-dotacoes" id="tabelaAgrupado">
        <thead>
            <tr>
                <th style="width: 20%;">Dotação Formatada</th>
                <th style="width: 12%;">Código Proj-Ativ</th>
                <th style="width: 30%;">Texto Projeto-Atividade</th>
                <th style="width: 10%;">Cód. Conta</th>
                <th style="width: 15%;">Saldo Dotação</th>
                <th style="width: 13%;">Última Atualização</th>
            </tr>
        </thead>
        <tbody id="corpoTabelaAgrupado">
            <tr>
                <td colspan="6" class="text-center text-muted py-5">
                    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                    <p class="mt-2">Aguardando busca de dados...</p>
                </td>
            </tr>
        </tbody>
        <tfoot class="table-secondary">
            <tr>
                <th colspan="4" class="text-end">SUBTOTAL:</th>
                <th class="text-end valor-moeda" id="subtotal_saldo_agrupado">R$ 0,00</th>
                <th></th>
            </tr>
        </tfoot>
    </table>
</div>

<script>
    let dadosCompletos = [];
    let dadosAgrupados = [];

    // Formatar valor como moeda brasileira
    function formatarMoeda(valor) {
        const num = parseFloat(valor);
        if (isNaN(num)) return 'R$ 0,00';
        return num.toLocaleString('pt-BR', {
            style: 'currency',
            currency: 'BRL',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    // Mostrar loading
    function mostrarLoading() {
        $('#loadingOverlay').css('display', 'flex');
    }

    // Esconder loading
    function esconderLoading() {
        $('#loadingOverlay').hide();
    }

    // Carregar dados das dotações
    async function carregarDados() {
        console.log('[DEBUG] Iniciando carregamento de dados...');
        
        const codConta = $('#filtroConta').val().trim();
        const codProjeto = $('#filtroProjeto').val().trim();
        
        console.log('[DEBUG] Filtros:', { codConta, codProjeto });

        if (!codConta) {
            alert('Por favor, informe o Código da Conta Despesa.');
            return;
        }

        mostrarLoading();

        try {
            // Carregar dados principais
            const params = new URLSearchParams({
                cod_cta_desp: codConta
            });
            
            if (codProjeto) {
                params.append('cod_proj_atvd', codProjeto);
            }

            const url = `/gestao_orcamentaria/api/dotacoes?${params}`;
            console.log('[DEBUG] URL da API:', url);
            
            const response = await fetch(url);
            console.log('[DEBUG] Response status:', response.status);
            
            const data = await response.json();
            console.log('[DEBUG] Dados recebidos:', data);

            if (data.success) {
                dadosCompletos = data.dados;
                console.log('[DEBUG] Total de registros:', dadosCompletos.length);
                renderizarTabela();
                
                // Atualizar informações
                $('#totalRegistros').text(data.total_registros);
                
                // Última atualização (pegar a mais recente)
                if (dadosCompletos.length > 0) {
                    const datas = dadosCompletos.map(d => d.criado_em).filter(d => d);
                    if (datas.length > 0) {
                        $('#ultimaAtualizacao').text(datas[0]);
                    }
                }
            } else {
                alert('Erro ao carregar dados: ' + data.error);
            }

            // Carregar dados agrupados
            await carregarDadosAgrupados(codConta);

        } catch (error) {
            console.error('Erro ao carregar dados:', error);
            alert('Erro ao carregar dados. Verifique o console para mais detalhes.');
        } finally {
            esconderLoading();
        }
    }

    // Carregar dados agrupados
    async function carregarDadosAgrupados(codConta) {
        try {
            const response = await fetch(`/gestao_orcamentaria/api/dotacoes/agrupado-projeto?cod_cta_desp=${codConta}`);
            const data = await response.json();

            if (data.success) {
                dadosAgrupados = data.dados;
                renderizarTabelaAgrupado();
                $('#totalProjetos').text(data.total_dotacoes);
            } else {
                console.error('Erro ao carregar dados agrupados:', data.error);
            }
        } catch (error) {
            console.error('Erro ao carregar dados agrupados:', error);
        }
    }

    // Renderizar tabela principal
    function renderizarTabela() {
        const tbody = $('#corpoTabela');
        tbody.empty();

        if (dadosCompletos.length === 0) {
            tbody.append(`
                <tr>
                    <td colspan="8" class="text-center text-muted py-5">
                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                        <p class="mt-2">Nenhum dado encontrado com os filtros aplicados.</p>
                    </td>
                </tr>
            `);
            return;
        }

        dadosCompletos.forEach(item => {
            const saldoClass = item.saldo_dotacao >= 0 ? 'valor-positivo' : 'valor-negativo';
            const empenhadoClass = item.val_tot_eph >= 0 ? 'valor-positivo' : 'valor-negativo';
            const pagoClass = item.val_tot_pgto_dota >= 0 ? 'valor-positivo' : 'valor-negativo';

            const row = `
                <tr>
                    <td>${item.dotacao_formatada || '-'}</td>
                    <td class="text-center">${item.cod_proj_atvd_sof || '-'}</td>
                    <td>${item.txt_proj_atvd || '-'}</td>
                    <td class="text-center">${item.cod_cta_desp || '-'}</td>
                    <td class="text-end ${saldoClass}">${formatarMoeda(item.saldo_dotacao)}</td>
                    <td class="text-end ${empenhadoClass}">${formatarMoeda(item.val_tot_eph)}</td>
                    <td class="text-end ${pagoClass}">${formatarMoeda(item.val_tot_pgto_dota)}</td>
                    <td class="text-center"><small>${item.criado_em || '-'}</small></td>
                </tr>
            `;
            tbody.append(row);
        });
        
        // Calcular e atualizar subtotais
        const subtotalSaldo = dadosCompletos.reduce((sum, item) => sum + (item.saldo_dotacao || 0), 0);
        const subtotalEmpenhado = dadosCompletos.reduce((sum, item) => sum + (item.val_tot_eph || 0), 0);
        const subtotalPago = dadosCompletos.reduce((sum, item) => sum + (item.val_tot_pgto_dota || 0), 0);
        
        $('#subtotal_saldo').text(formatarMoeda(subtotalSaldo));
        $('#subtotal_empenhado').text(formatarMoeda(subtotalEmpenhado));
        $('#subtotal_pago').text(formatarMoeda(subtotalPago));
    }

    // Renderizar tabela agrupada
    function renderizarTabelaAgrupado() {
        const tbody = $('#corpoTabelaAgrupado');
        tbody.empty();

        if (dadosAgrupados.length === 0) {
            tbody.append(`
                <tr>
                    <td colspan="6" class="text-center text-muted py-5">
                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                        <p class="mt-2">Nenhum dado encontrado.</p>
                    </td>
                </tr>
            `);
            return;
        }

        dadosAgrupados.forEach(item => {
            const saldoClass = item.total_saldo >= 0 ? 'valor-positivo' : 'valor-negativo';

            const row = `
                <tr>
                    <td><strong>${item.dotacao_formatada || '-'}</strong></td>
                    <td class="text-center">${item.cod_proj_atvd_sof || '-'}</td>
                    <td>${item.txt_proj_atvd || '-'}</td>
                    <td class="text-center">${item.cod_cta_desp || '-'}</td>
                    <td class="text-end ${saldoClass}"><strong>${formatarMoeda(item.total_saldo)}</strong></td>
                    <td class="text-center"><small>${item.ultima_atualizacao || '-'}</small></td>
                </tr>
            `;
            tbody.append(row);
        });
        
        // Calcular e atualizar subtotal
        const subtotalSaldoAgrupado = dadosAgrupados.reduce((sum, item) => sum + (item.total_saldo || 0), 0);
        $('#subtotal_saldo_agrupado').text(formatarMoeda(subtotalSaldoAgrupado));
    }

    // Exportar para CSV
    function exportarCSV() {
        if (dadosCompletos.length === 0) {
            alert('Não há dados para exportar.');
            return;
        }

        let csv = 'Dotação Formatada;Código Proj-Ativ;Texto Projeto-Atividade;Cód. Conta;Saldo Dotação;Valor Total Empenhado;Valor Total Pago;Data Atualização\n';

        dadosCompletos.forEach(item => {
            csv += `"${item.dotacao_formatada || ''}";`;
            csv += `"${item.cod_proj_atvd_sof || ''}";`;
            csv += `"${item.txt_proj_atvd || ''}";`;
            csv += `"${item.cod_cta_desp || ''}";`;
            csv += `${item.saldo_dotacao || 0};`;
            csv += `${item.val_tot_eph || 0};`;
            csv += `${item.val_tot_pgto_dota || 0};`;
            csv += `"${item.criado_em || ''}"\n`;
        });

        // Adicionar seção agrupada
        csv += '\n\nRELATÓRIO POR DOTAÇÃO ORÇAMENTÁRIA\n';
        csv += 'Dotação Formatada;Código Proj-Ativ;Texto Projeto-Atividade;Cód. Conta;Saldo Dotação;Última Atualização\n';

        dadosAgrupados.forEach(item => {
            csv += `"${item.dotacao_formatada || ''}";`;
            csv += `"${item.cod_proj_atvd_sof || ''}";`;
            csv += `"${item.txt_proj_atvd || ''}";`;
            csv += `"${item.cod_cta_desp || ''}";`;
            csv += `${item.total_saldo || 0};`;
            csv += `"${item.ultima_atualizacao || ''}"\n`;
        });

        // Download
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `relatorio_dotacoes_${new Date().getTime()}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Carregar dados ao iniciar (com filtro padrão)
    $(document).ready(function() {
        // Permitir buscar com Enter
        $('#filtroConta, #filtroProjeto').on('keypress', function(e) {
            if (e.which === 13) {
                carregarDados();
            }
        });

        // Carregar dados iniciais com filtro padrão
        carregarDados();
    });
</script>

</div><!-- Fecha main-container -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
</body>
</html>
