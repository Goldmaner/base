<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API SOF - Consultas - FAF</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body {
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .container-fluid {
            max-width: 98%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header-section h2 {
            margin: 0;
            font-weight: 600;
        }
        
        .header-section p {
            margin: 0.5rem 0 0 0;
            opacity: 0.95;
        }
        
        .header-section hr {
            margin: 1rem 0 0 0;
            opacity: 0.3;
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        
        .card-header {
            border-radius: 10px 10px 0 0 !important;
            font-weight: 600;
            border-bottom: none;
        }
        
        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .sticky-top {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .table-dark {
            background-color: #667eea !important;
        }
        
        .text-truncate-custom {
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 2rem;
        }
        
        .nav-tabs .nav-link {
            color: #6c757d;
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
        }
        
        .nav-tabs .nav-link:hover {
            border-bottom: 3px solid #667eea;
            color: #667eea;
        }
        
        .nav-tabs .nav-link.active {
            color: #667eea;
            background: transparent;
            border-bottom: 3px solid #667eea;
            font-weight: 600;
        }
        
        .column-selector {
            background-color: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 1.5rem;
        }
        
        .column-checkbox {
            margin-right: 15px;
            margin-bottom: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-outline-light {
            border: 2px solid white;
            font-weight: 500;
        }
        
        .btn-outline-light:hover {
            background: white;
            color: #667eea;
            transform: translateY(-1px);
        }
        
        .badge {
            padding: 0.5rem 1rem;
            font-weight: 500;
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <!-- Cabeçalho -->
    <div class="header-section">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h2><i class="bi bi-cloud-download"></i> API SOF - Consultas</h2>
            <a href="/gestao_orcamentaria/" class="btn btn-outline-light btn-sm">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
        </div>
        <p>Integração com Sistema Orçamentário e Financeiro da Prefeitura de SP</p>
        <hr>
    </div>

    <!-- Abas de Navegação -->
    <ul class="nav nav-tabs mb-4" id="sofTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-contratos" data-bs-toggle="tab" data-bs-target="#contratos-tab" type="button" role="tab">
                <i class="bi bi-file-text"></i> Contratos
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-empenhos" data-bs-toggle="tab" data-bs-target="#empenhos-tab" type="button" role="tab">
                <i class="bi bi-cash-stack"></i> Empenhos
            </button>
        </li>
    </ul>

    <!-- Conteúdo das Abas -->
    <div class="tab-content" id="sofTabsContent">
        
        <!-- ABA 1: CONTRATOS -->
        <div class="tab-pane fade show active" id="contratos-tab" role="tabpanel">
            <!-- Filtros de Consulta - Contratos -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-funnel"></i> Filtros - Contratos</h5>
                </div>
                <div class="card-body">
                    <form id="formFiltrosContratos">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="anoContrato" class="form-label">
                                    Ano do Contrato <span class="text-danger">*</span>
                                </label>
                                <input type="number" class="form-control" id="anoContrato" name="anoContrato" 
                                       value="2026" min="2020" max="2030" required>
                            </div>

                            <div class="col-md-3 mb-3">
                                <label for="codOrgaoContrato" class="form-label">Código do Órgão</label>
                                <input type="text" class="form-control" id="codOrgaoContrato" name="codOrgao" 
                                       value="34" placeholder="34 (SMDHC)">
                                <small class="text-muted">34 = SMDHC</small>
                            </div>

                            <div class="col-md-3 mb-3">
                                <label for="codEmpresaContrato" class="form-label">Código da Empresa</label>
                                <input type="text" class="form-control" id="codEmpresaContrato" name="codEmpresa" 
                                       value="01" placeholder="01">
                            </div>

                            <div class="col-md-3 mb-3">
                                <label for="codContrato" class="form-label">Código do Contrato</label>
                                <input type="number" class="form-control" id="codContrato" name="codContrato" 
                                       placeholder="Ex: 2663">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="numCpfCnpjContrato" class="form-label">CNPJ/CPF do Credor</label>
                                <input type="text" class="form-control" id="numCpfCnpjContrato" name="numCpfCnpj" 
                                       placeholder="Digite CNPJ ou CPF">
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="numProcessoContrato" class="form-label">Número do Processo</label>
                                <input type="text" class="form-control" id="numProcessoContrato" name="numProcesso" 
                                       placeholder="Ex: 6074202300022130">
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="numPaginaContrato" class="form-label">Página</label>
                                <input type="number" class="form-control" id="numPaginaContrato" name="numPagina" 
                                       value="1" min="1" placeholder="1">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <button type="button" class="btn btn-primary" id="btnConsultarContratos">
                                    <i class="bi bi-search"></i> Consultar Contratos
                                </button>
                                <button type="button" class="btn btn-success" id="btnExportarCSVContratos">
                                    <i class="bi bi-download"></i> Exportar CSV (Todos)
                                </button>
                                <button type="button" class="btn btn-secondary" id="btnTestarConexao">
                                    <i class="bi bi-plug"></i> Testar Conexão
                                </button>
                                <button type="reset" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle"></i> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Resultados - Contratos -->
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-table"></i> Resultados - Contratos</h5>
                    <span id="badgeTotalContratos" class="badge bg-light text-dark">0 contratos</span>
                </div>
                <div class="card-body">
                    <div id="loadingSpinnerContratos" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-2">Consultando API SOF...</p>
                    </div>

                    <div id="divErroContratos" class="alert alert-danger" style="display: none;">
                        <i class="bi bi-exclamation-triangle"></i> 
                        <span id="textoErroContratos"></span>
                    </div>

                    <div id="divSucessoContratos" class="alert alert-success" style="display: none;">
                        <i class="bi bi-check-circle"></i> 
                        <span id="textoSucessoContratos"></span>
                    </div>

                    <div id="divTabelaContratos" class="table-responsive" style="display: none;">
                        <table class="table table-striped table-hover table-sm" id="tabelaContratos">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th>Código</th>
                                    <th>Ano</th>
                                    <th>Processo</th>
                                    <th>Tipo</th>
                                    <th>Órgão</th>
                                    <th>Valor Principal</th>
                                    <th>Valor Empenhado</th>
                                    <th>Valor Liquidado</th>
                                    <th>Valor Pago</th>
                                    <th>Objeto</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyContratos">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA 2: EMPENHOS -->
        <div class="tab-pane fade" id="empenhos-tab" role="tabpanel">
            <!-- Filtros de Consulta - Empenhos -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-funnel"></i> Filtros - Empenhos</h5>
                </div>
                <div class="card-body">
                    <form id="formFiltrosEmpenhos">
                        <div class="row">
                            <div class="col-md-2 mb-3">
                                <label for="anoEmpenho" class="form-label">
                                    Ano <span class="text-danger">*</span>
                                </label>
                                <input type="number" class="form-control" id="anoEmpenho" name="anoEmpenho" 
                                       value="2026" min="2020" max="2030" required>
                            </div>

                            <div class="col-md-2 mb-3">
                                <label for="mesEmpenho" class="form-label">
                                    Mês <span class="text-danger">*</span>
                                </label>
                                <input type="number" class="form-control" id="mesEmpenho" name="mesEmpenho" 
                                       value="1" min="1" max="12" required>
                            </div>

                            <div class="col-md-2 mb-3">
                                <label for="codOrgaoEmpenho" class="form-label">Cód. Órgão</label>
                                <input type="text" class="form-control" id="codOrgaoEmpenho" name="codOrgao" 
                                       value="34" placeholder="34">
                            </div>

                            <div class="col-md-2 mb-3">
                                <label for="codEmpresaEmpenho" class="form-label">Cód. Empresa</label>
                                <input type="text" class="form-control" id="codEmpresaEmpenho" name="codEmpresa" 
                                       value="01" placeholder="01">
                            </div>

                            <div class="col-md-2 mb-3">
                                <label for="codEmpenho" class="form-label">Cód. Empenho</label>
                                <input type="number" class="form-control" id="codEmpenho" name="codEmpenho" 
                                       placeholder="Ex: 2357">
                            </div>

                            <div class="col-md-2 mb-3">
                                <label for="codContratoEmpenho" class="form-label">Cód. Contrato</label>
                                <input type="number" class="form-control" id="codContratoEmpenho" name="codContrato" 
                                       placeholder="Ex: 2663">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="numCpfCnpjEmpenho" class="form-label">CNPJ/CPF</label>
                                <input type="text" class="form-control" id="numCpfCnpjEmpenho" name="numCpfCnpj" 
                                       placeholder="Digite CNPJ ou CPF">
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="txtRazaoSocial" class="form-label">Razão Social</label>
                                <input type="text" class="form-control" id="txtRazaoSocial" name="txtRazaoSocial" 
                                       placeholder="Nome do credor">
                            </div>

                            <div class="col-md-2 mb-3">
                                <label for="anoExercicio" class="form-label">Ano Exercício</label>
                                <input type="number" class="form-control" id="anoExercicio" name="anoExercicio" 
                                       placeholder="2026">
                            </div>

                            <div class="col-md-2 mb-3">
                                <label for="numPaginaEmpenho" class="form-label">Página</label>
                                <input type="number" class="form-control" id="numPaginaEmpenho" name="numPagina" 
                                       value="1" min="1">
                                <small class="text-muted">Limite: 50 por página</small>
                            </div>
                        </div>

                        <!-- Filtros Avançados (Colapsável) -->
                        <div class="mb-3">
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosAvancados">
                                <i class="bi bi-gear"></i> Filtros Avançados
                            </button>
                        </div>

                        <div class="collapse" id="filtrosAvancados">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label for="codUnidade" class="form-label">Cód. Unidade</label>
                                    <input type="number" class="form-control" id="codUnidade" name="codUnidade">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="codFuncao" class="form-label">Cód. Função</label>
                                    <input type="number" class="form-control" id="codFuncao" name="codFuncao">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="codSubFuncao" class="form-label">Cód. Subfunção</label>
                                    <input type="number" class="form-control" id="codSubFuncao" name="codSubFuncao">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="codPrograma" class="form-label">Cód. Programa</label>
                                    <input type="number" class="form-control" id="codPrograma" name="codPrograma">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label for="codProjetoAtividade" class="form-label">Cód. Projeto/Atividade</label>
                                    <input type="number" class="form-control" id="codProjetoAtividade" name="codProjetoAtividade">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="codCategoria" class="form-label">Cód. Categoria</label>
                                    <input type="number" class="form-control" id="codCategoria" name="codCategoria">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="codGrupo" class="form-label">Cód. Grupo</label>
                                    <input type="number" class="form-control" id="codGrupo" name="codGrupo">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="codModalidade" class="form-label">Cód. Modalidade</label>
                                    <input type="number" class="form-control" id="codModalidade" name="codModalidade">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="codElemento" class="form-label">Cód. Elemento</label>
                                    <input type="number" class="form-control" id="codElemento" name="codElemento">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="codFonteRecurso" class="form-label">Cód. Fonte Recurso</label>
                                    <input type="number" class="form-control" id="codFonteRecurso" name="codFonteRecurso">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <button type="button" class="btn btn-info text-white" id="btnConsultarEmpenhos">
                                    <i class="bi bi-search"></i> Consultar Empenhos
                                </button>
                                <button type="button" class="btn btn-success" id="btnExportarCSV">
                                    <i class="bi bi-download"></i> Exportar CSV (Todos)
                                </button>
                                <button type="reset" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle"></i> Limpar
                                </button>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle"></i> 
                                        <strong>Exportar CSV:</strong> Busca automaticamente TODAS as páginas e gera arquivo completo com as colunas selecionadas.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Seletor de Colunas -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning">
                    <button class="btn btn-link text-decoration-none text-dark w-100 text-start p-0" type="button" data-bs-toggle="collapse" data-bs-target="#collapseColunasEmpenhos">
                        <h6 class="mb-0"><i class="bi bi-columns"></i> Selecionar Colunas para Exibir <i class="bi bi-chevron-down float-end"></i></h6>
                    </button>
                </div>
                <div class="collapse" id="collapseColunasEmpenhos">
                <div class="card-body column-selector">
                    <div class="row">
                        <div class="col-12 mb-2">
                            <strong>Colunas Padrão:</strong>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="numReserva" id="col_numReserva" checked>
                                <label class="form-check-label" for="col_numReserva">Num. Reserva</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="codEmpenho" id="col_codEmpenho" checked>
                                <label class="form-check-label" for="col_codEmpenho">Cód. Empenho</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="anoEmpenho" id="col_anoEmpenho" checked>
                                <label class="form-check-label" for="col_anoEmpenho">Ano</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="mesEmpenho" id="col_mesEmpenho" checked>
                                <label class="form-check-label" for="col_mesEmpenho">Mês</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="datEmpenho" id="col_datEmpenho" checked>
                                <label class="form-check-label" for="col_datEmpenho">Data</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="codProcesso" id="col_codProcesso" checked>
                                <label class="form-check-label" for="col_codProcesso">Processo</label>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-12 mb-2">
                            <strong>Colunas Adicionais:</strong>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="numCpfCnpj" id="col_numCpfCnpj">
                                <label class="form-check-label" for="col_numCpfCnpj">CNPJ/CPF</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="txtRazaoSocial" id="col_txtRazaoSocial">
                                <label class="form-check-label" for="col_txtRazaoSocial">Razão Social</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="codEmpresa" id="col_codEmpresa">
                                <label class="form-check-label" for="col_codEmpresa">Cód. Empresa</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="nomEmpresa" id="col_nomEmpresa">
                                <label class="form-check-label" for="col_nomEmpresa">Nome Empresa</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="numContrato" id="col_numContrato">
                                <label class="form-check-label" for="col_numContrato">Num. Contrato</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="anoContrato" id="col_anoContrato">
                                <label class="form-check-label" for="col_anoContrato">Ano Contrato</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="codContrato" id="col_codContrato_emp">
                                <label class="form-check-label" for="col_codContrato_emp">Cód. Contrato</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="anoExercicio" id="col_anoExercicio">
                                <label class="form-check-label" for="col_anoExercicio">Ano Exercício</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="codOrgao" id="col_codOrgao_emp">
                                <label class="form-check-label" for="col_codOrgao_emp">Cód. Órgão</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="txDescricaoOrgao" id="col_txDescricaoOrgao">
                                <label class="form-check-label" for="col_txDescricaoOrgao">Descrição Órgão</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="codUnidade" id="col_codUnidade">
                                <label class="form-check-label" for="col_codUnidade">Cód. Unidade</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="txDescricaoUnidade" id="col_txDescricaoUnidade">
                                <label class="form-check-label" for="col_txDescricaoUnidade">Descrição Unidade</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="codFuncao" id="col_codFuncao">
                                <label class="form-check-label" for="col_codFuncao">Cód. Função</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="txDescricaoFuncao" id="col_txDescricaoFuncao">
                                <label class="form-check-label" for="col_txDescricaoFuncao">Descrição Função</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="codSubFuncao" id="col_codSubFuncao">
                                <label class="form-check-label" for="col_codSubFuncao">Cód. Subfunção</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="txDescricaoSubFuncao" id="col_txDescricaoSubFuncao">
                                <label class="form-check-label" for="col_txDescricaoSubFuncao">Descrição Subfunção</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="codPrograma" id="col_codPrograma">
                                <label class="form-check-label" for="col_codPrograma">Cód. Programa</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="txDescricaoPrograma" id="col_txDescricaoPrograma">
                                <label class="form-check-label" for="col_txDescricaoPrograma">Descrição Programa</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="codProjetoAtividade" id="col_codProjetoAtividade">
                                <label class="form-check-label" for="col_codProjetoAtividade">Cód. Proj/Ativ</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="txDescricaoProjetoAtividade" id="col_txDescricaoProjetoAtividade">
                                <label class="form-check-label" for="col_txDescricaoProjetoAtividade">Descrição Proj/Ativ</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="codCategoria" id="col_codCategoria">
                                <label class="form-check-label" for="col_codCategoria">Cód. Categoria</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="txDescricaoCategoriaEconomica" id="col_txDescricaoCategoriaEconomica">
                                <label class="form-check-label" for="col_txDescricaoCategoriaEconomica">Descrição Categoria</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="codGrupo" id="col_codGrupo">
                                <label class="form-check-label" for="col_codGrupo">Cód. Grupo</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="txDescricaoGrupoDespesa" id="col_txDescricaoGrupoDespesa">
                                <label class="form-check-label" for="col_txDescricaoGrupoDespesa">Descrição Grupo</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="codModalidade" id="col_codModalidade">
                                <label class="form-check-label" for="col_codModalidade">Cód. Modalidade</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="txDescricaoModalidade" id="col_txDescricaoModalidade">
                                <label class="form-check-label" for="col_txDescricaoModalidade">Descrição Modalidade</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="codElemento" id="col_codElemento">
                                <label class="form-check-label" for="col_codElemento">Cód. Elemento</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="txDescricaoElemento" id="col_txDescricaoElemento">
                                <label class="form-check-label" for="col_txDescricaoElemento">Descrição Elemento</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="codFonteRecurso" id="col_codFonteRecurso">
                                <label class="form-check-label" for="col_codFonteRecurso">Cód. Fonte Recurso</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="txDescricaoFonteRecurso" id="col_txDescricaoFonteRecurso">
                                <label class="form-check-label" for="col_txDescricaoFonteRecurso">Descrição Fonte Recurso</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="codItemDespesa" id="col_codItemDespesa">
                                <label class="form-check-label" for="col_codItemDespesa">Cód. Item Despesa</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="txDescricaoItemDespesa" id="col_txDescricaoItemDespesa">
                                <label class="form-check-label" for="col_txDescricaoItemDespesa">Descrição Item</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="codSubElemento" id="col_codSubElemento">
                                <label class="form-check-label" for="col_codSubElemento">Cód. SubElemento</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="txDescricaoSubElementoDespesa" id="col_txDescricaoSubElementoDespesa">
                                <label class="form-check-label" for="col_txDescricaoSubElementoDespesa">Descrição SubElemento</label>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-12 mb-2">
                            <strong>Valores Financeiros:</strong>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="valTotalEmpenhado" id="col_valTotalEmpenhado">
                                <label class="form-check-label" for="col_valTotalEmpenhado">Valor Empenhado</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="valAnuladoEmpenho" id="col_valAnuladoEmpenho">
                                <label class="form-check-label" for="col_valAnuladoEmpenho">Valor Anulado</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="valEmpenhadoLiquido" id="col_valEmpenhadoLiquido">
                                <label class="form-check-label" for="col_valEmpenhadoLiquido">Empenhado Líquido</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="valLiquidado" id="col_valLiquidado">
                                <label class="form-check-label" for="col_valLiquidado">Valor Liquidado</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="valPagoExercicio" id="col_valPagoExercicio">
                                <label class="form-check-label" for="col_valPagoExercicio">Pago Exercício</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check column-checkbox">
                                <input class="form-check-input coluna-empenho" type="checkbox" value="valPagoRestos" id="col_valPagoRestos">
                                <label class="form-check-label" for="col_valPagoRestos">Pago Restos</label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="button" class="btn btn-sm btn-secondary" id="btnSelecionarTodas">
                            <i class="bi bi-check-all"></i> Selecionar Todas
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="btnDesmarcarTodas">
                            <i class="bi bi-x"></i> Desmarcar Todas
                        </button>
                        <button type="button" class="btn btn-sm btn-primary" id="btnRestaurarPadrao">
                            <i class="bi bi-arrow-clockwise"></i> Restaurar Padrão
                        </button>
                    </div>
                </div>
                </div>
            </div>

            <!-- Resultados - Empenhos -->
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-table"></i> Resultados - Empenhos</h5>
                    <div>
                        <span id="badgeTotalEmpenhos" class="badge bg-light text-dark me-2">0 empenhos</span>
                        <span id="badgePaginaEmpenhos" class="badge bg-info" style="display: none;">Página 1</span>
                    </div>
                </div>
                <div class="card-body">
                    <div id="loadingSpinnerEmpenhos" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-2">Consultando API SOF...</p>
                    </div>

                    <div id="divErroEmpenhos" class="alert alert-danger" style="display: none;">
                        <i class="bi bi-exclamation-triangle"></i> 
                        <span id="textoErroEmpenhos"></span>
                    </div>

                    <div id="divSucessoEmpenhos" class="alert alert-success" style="display: none;">
                        <i class="bi bi-check-circle"></i> 
                        <span id="textoSucessoEmpenhos"></span>
                    </div>

                    <div id="divTabelaEmpenhos" class="table-responsive" style="display: none;">
                        <table class="table table-striped table-hover table-sm" id="tabelaEmpenhos">
                            <thead class="table-dark sticky-top" id="theadEmpenhos">
                                <!-- Gerado dinamicamente -->
                            </thead>
                            <tbody id="tbodyEmpenhos">
                            </tbody>
                        </table>
                    </div>

                    <!-- Controles de Paginação -->
                    <div id="divPaginacaoEmpenhos" class="d-flex justify-content-between align-items-center mt-3" style="display: none !important;">
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="btnPaginaAnterior" disabled>
                            <i class="bi bi-chevron-left"></i> Anterior
                        </button>
                        <span id="infoPaginacao" class="text-muted">Página <span id="paginaAtual">1</span></span>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="btnProximaPagina">
                            Próxima <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
$(document).ready(function() {
    
    // =======================================================================
    // CACHE E PREFERÊNCIAS DO USUÁRIO
    // =======================================================================
    
    let paginaAtualEmpenhos = 1;
    let ultimosFiltrosEmpenhos = {};
    
    // Restaurar preferências do localStorage
    function carregarPreferencias() {
        // Restaurar aba ativa
        const abaAtiva = localStorage.getItem('sofapi_aba_ativa');
        if (abaAtiva === 'empenhos') {
            $('#tab-empenhos').tab('show');
        }
        
        // Restaurar colunas selecionadas
        const colunasSalvas = localStorage.getItem('sofapi_colunas_empenhos');
        if (colunasSalvas) {
            const colunas = JSON.parse(colunasSalvas);
            $('.coluna-empenho').prop('checked', false);
            colunas.forEach(coluna => {
                $(`#col_${coluna}`).prop('checked', true);
            });
        }
        
        // Restaurar filtros de empenhos
        const filtrosSalvos = localStorage.getItem('sofapi_filtros_empenhos');
        if (filtrosSalvos) {
            const filtros = JSON.parse(filtrosSalvos);
            Object.keys(filtros).forEach(key => {
                const valor = filtros[key];
                if (valor !== null && valor !== '') {
                    $(`#${key}`).val(valor);
                }
            });
        }
    }
    
    // Salvar preferências no localStorage
    function salvarPreferencias() {
        // Salvar colunas selecionadas
        const colunas = [];
        $('.coluna-empenho:checked').each(function() {
            colunas.push($(this).val());
        });
        localStorage.setItem('sofapi_colunas_empenhos', JSON.stringify(colunas));
        
        // Salvar filtros de empenhos
        const filtros = {
            anoEmpenho: $('#anoEmpenho').val(),
            mesEmpenho: $('#mesEmpenho').val(),
            codOrgaoEmpenho: $('#codOrgaoEmpenho').val(),
            codEmpresaEmpenho: $('#codEmpresaEmpenho').val(),
            codEmpenho: $('#codEmpenho').val(),
            codContratoEmpenho: $('#codContratoEmpenho').val(),
            numCpfCnpjEmpenho: $('#numCpfCnpjEmpenho').val(),
            txtRazaoSocial: $('#txtRazaoSocial').val(),
            anoExercicio: $('#anoExercicio').val()
        };
        localStorage.setItem('sofapi_filtros_empenhos', JSON.stringify(filtros));
    }
    
    // Salvar aba ativa
    $('#sofTabs button[data-bs-toggle="tab"]').on('shown.bs.tab', function(e) {
        const abaId = $(e.target).attr('id');
        if (abaId === 'tab-empenhos') {
            localStorage.setItem('sofapi_aba_ativa', 'empenhos');
        } else {
            localStorage.setItem('sofapi_aba_ativa', 'contratos');
        }
    });
    
    // Carregar preferências ao iniciar
    carregarPreferencias();
    
    // Salvar preferências quando houver mudanças
    $('.coluna-empenho').on('change', salvarPreferencias);
    $('#formFiltrosEmpenhos input').on('change', salvarPreferencias);
    
    // =======================================================================
    // CONTRATOS - Lógica da Aba 1
    // =======================================================================
    
    // Testar Conexão
    $('#btnTestarConexao').click(function() {
        const btn = $(this);
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span> Testando...');
        
        $.ajax({
            url: '/gestao_orcamentaria/sof-api/api/testar-conexao',
            type: 'GET',
            success: function(response) {
                if (response.success) {
                    $('#divSucessoContratos').show().find('#textoSucessoContratos').text(
                        `${response.mensagem} (${response.duracao_ms}ms)`
                    );
                    setTimeout(() => $('#divSucessoContratos').fadeOut(), 5000);
                } else {
                    $('#divErroContratos').show().find('#textoErroContratos').text(response.mensagem);
                }
            },
            error: function(xhr) {
                $('#divErroContratos').show().find('#textoErroContratos').text(
                    'Erro ao testar conexão: ' + (xhr.responseJSON?.mensagem || 'Erro desconhecido')
                );
            },
            complete: function() {
                btn.prop('disabled', false).html('<i class="bi bi-plug"></i> Testar Conexão');
            }
        });
    });

    // Consultar Contratos
    $('#btnConsultarContratos').click(function() {
        const anoContrato = $('#anoContrato').val();
        if (!anoContrato) {
            alert('Ano do Contrato é obrigatório!');
            $('#anoContrato').focus();
            return;
        }

        $('#divErroContratos, #divSucessoContratos, #divTabelaContratos').hide();
        $('#loadingSpinnerContratos').show();

        const btn = $(this);
        btn.prop('disabled', true);

        const filtros = {
            anoContrato: $('#anoContrato').val(),
            codOrgao: $('#codOrgaoContrato').val(),
            codEmpresa: $('#codEmpresaContrato').val(),
            codContrato: $('#codContrato').val() || null,
            numCpfCnpj: $('#numCpfCnpjContrato').val() || null,
            numProcesso: $('#numProcessoContrato').val() || null,
            numPagina: $('#numPaginaContrato').val() || 1
        };

        $.ajax({
            url: '/gestao_orcamentaria/sof-api/api/consultar-contratos',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(filtros),
            success: function(response) {
                $('#loadingSpinnerContratos').hide();
                
                if (response.success) {
                    const contratos = response.contratos;
                    const total = response.total;
                    
                    $('#badgeTotalContratos').text(`${total} contrato${total !== 1 ? 's' : ''}`);
                    
                    if (total > 0) {
                        renderizarTabelaContratos(contratos);
                        $('#divTabelaContratos').show();
                        
                        $('#divSucessoContratos').show().find('#textoSucessoContratos').text(
                            `${total} contrato(s) encontrado(s) em ${response.duracao_ms}ms`
                        );
                        setTimeout(() => $('#divSucessoContratos').fadeOut(), 5000);
                    } else {
                        $('#divErroContratos').show().find('#textoErroContratos').text(
                            'Nenhum contrato encontrado com os filtros informados.'
                        );
                    }
                } else {
                    $('#divErroContratos').show().find('#textoErroContratos').text(
                        'Erro: ' + (response.erro || 'Erro desconhecido')
                    );
                }
            },
            error: function(xhr) {
                $('#loadingSpinnerContratos').hide();
                const erro = xhr.responseJSON?.erro || 'Erro ao consultar API';
                $('#divErroContratos').show().find('#textoErroContratos').text(erro);
            },
            complete: function() {
                btn.prop('disabled', false);
            }
        });
    });

    function renderizarTabelaContratos(contratos) {
        const tbody = $('#tbodyContratos');
        tbody.empty();

        contratos.forEach(contrato => {
            const tr = $('<tr>');
            
            tr.append(`<td>${contrato.codContrato || '-'}</td>`);
            tr.append(`<td>${contrato.anoContrato || '-'}</td>`);
            tr.append(`<td><small>${contrato.codProcesso || '-'}</small></td>`);
            tr.append(`<td><small>${contrato.txtTipoContratacao || '-'}</small></td>`);
            tr.append(`<td><small>${contrato.txtDescricaoOrgao || '-'}</small></td>`);
            tr.append(`<td class="text-end">${formatarMoeda(contrato.valPrincipal)}</td>`);
            tr.append(`<td class="text-end">${formatarMoeda(contrato.valTotalEmpenhado)}</td>`);
            tr.append(`<td class="text-end">${formatarMoeda(contrato.valLiquidado)}</td>`);
            tr.append(`<td class="text-end">${formatarMoeda(contrato.valPago)}</td>`);
            tr.append(`<td class="text-truncate-custom" title="${contrato.txtObjetoContrato || '-'}">
                ${contrato.txtObjetoContrato || '-'}
            </td>`);
            
            tbody.append(tr);
        });
    }
    
    // Exportar Contratos para CSV
    $('#btnExportarCSVContratos').click(async function() {
        const anoContrato = $('#anoContrato').val();
        
        if (!anoContrato) {
            alert('Preencha o Ano do Contrato para exportar!');
            return;
        }
        
        const btn = $(this);
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span> Exportando...');
        
        try {
            // Preparar filtros base
            const filtrosBase = {
                anoContrato: anoContrato,
                codOrgao: $('#codOrgaoContrato').val() || null,
                codEmpresa: $('#codEmpresaContrato').val() || null,
                codContrato: $('#codContrato').val() || null,
                numCpfCnpj: $('#numCpfCnpjContrato').val() || null,
                numProcesso: $('#numProcessoContrato').val() || null
            };
            
            let todosContratos = [];
            let paginaAtual = 1;
            let temMaisPaginas = true;
            
            // Buscar todas as páginas (API SOF retorna até 50 por página)
            while (temMaisPaginas) {
                const filtros = { ...filtrosBase, numPagina: paginaAtual };
                
                const response = await $.ajax({
                    url: '/gestao_orcamentaria/sof-api/api/consultar-contratos',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(filtros)
                });
                
                if (response.success && response.contratos.length > 0) {
                    todosContratos = todosContratos.concat(response.contratos);
                    btn.html(`<span class="spinner-border spinner-border-sm me-1"></span> Exportando... Página ${paginaAtual} (${todosContratos.length} contratos)`);
                    
                    // API retorna 50 por página. Se retornou menos, é a última
                    if (response.contratos.length < 50) {
                        temMaisPaginas = false;
                    } else {
                        paginaAtual++;
                    }
                } else {
                    temMaisPaginas = false;
                }
            }
            
            if (todosContratos.length === 0) {
                alert('Nenhum contrato encontrado para exportar!');
                return;
            }
            
            // Gerar CSV com BOM UTF-8
            let csv = '\ufeff';
            
            // Cabeçalho fixo
            const colunas = ['codContrato', 'anoContrato', 'codProcesso', 'txtTipoContratacao', 'txtDescricaoOrgao', 
                           'valPrincipal', 'valTotalEmpenhado', 'valLiquidado', 'valPago', 'txtObjetoContrato'];
            const labels = ['Cód. Contrato', 'Ano', 'Processo', 'Tipo Contratação', 'Órgão', 
                          'Valor Principal', 'Valor Empenhado', 'Valor Liquidado', 'Valor Pago', 'Objeto'];
            
            csv += labels.join(';') + '\n';
            
            // Dados
            todosContratos.forEach(contrato => {
                const linha = colunas.map(coluna => {
                    let valor = contrato[coluna];
                    
                    if (valor === null || valor === undefined) {
                        return '';
                    }
                    
                    // Formatação por tipo
                    if (coluna.startsWith('val')) {
                        // Valores monetários
                        const valorNum = parseFloat(valor) || 0;
                        return valorNum.toFixed(2).replace('.', ',');
                    } else if (coluna === 'codProcesso') {
                        // Processo como texto
                        return `="${valor}"`;
                    } else {
                        // Texto
                        valor = String(valor).replace(/\r?\n/g, ' ').replace(/;/g, ',');
                        if (valor.includes(',') || valor.includes(' ')) {
                            valor = `"${valor}"`;
                        }
                        return valor;
                    }
                });
                
                csv += linha.join(';') + '\n';
            });
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const dataHora = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const nomeArquivo = `contratos_${anoContrato}_${dataHora}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', nomeArquivo);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Mensagem de sucesso
            $('#divSucessoContratos').show().find('#textoSucessoContratos').text(
                `CSV exportado com sucesso! ${todosContratos.length} contrato(s) em ${paginaAtual} página(s).`
            );
            setTimeout(() => $('#divSucessoContratos').fadeOut(), 5000);
            
        } catch (error) {
            console.error('Erro ao exportar CSV:', error);
            $('#divErroContratos').show().find('#textoErroContratos').text(
                'Erro ao exportar CSV: ' + (error.responseJSON?.erro || error.message || 'Erro desconhecido')
            );
        } finally {
            btn.prop('disabled', false).html('<i class="bi bi-download"></i> Exportar CSV (Todos)');
        }
    });

    // =======================================================================
    // EMPENHOS - Lógica da Aba 2
    // =======================================================================
    
    // Mapeamento de campos para labels amigáveis
    const colunasLabels = {
        // Padrão
        numReserva: 'Num. Reserva',
        codEmpenho: 'Cód. Empenho',
        anoEmpenho: 'Ano',
        mesEmpenho: 'Mês',
        datEmpenho: 'Data',
        codProcesso: 'Processo',
        // Credor
        numCpfCnpj: 'CNPJ/CPF',
        txtRazaoSocial: 'Razão Social',
        // Empresa
        codEmpresa: 'Cód. Empresa',
        nomEmpresa: 'Nome Empresa',
        // Contrato
        numContrato: 'Num. Contrato',
        anoContrato: 'Ano Contrato',
        codContrato: 'Cód. Contrato',
        anoExercicio: 'Ano Exercício',
        // Órgão/Unidade
        codOrgao: 'Cód. Órgão',
        txDescricaoOrgao: 'Descrição Órgão',
        codUnidade: 'Cód. Unidade',
        txDescricaoUnidade: 'Descrição Unidade',
        // Função/Subfunção
        codFuncao: 'Cód. Função',
        txDescricaoFuncao: 'Descrição Função',
        codSubFuncao: 'Cód. Subfunção',
        txDescricaoSubFuncao: 'Descrição Subfunção',
        // Programa/Projeto
        codPrograma: 'Cód. Programa',
        txDescricaoPrograma: 'Descrição Programa',
        codProjetoAtividade: 'Cód. Proj/Ativ',
        txDescricaoProjetoAtividade: 'Descrição Proj/Ativ',
        // Categoria/Grupo
        codCategoria: 'Cód. Categoria',
        txDescricaoCategoriaEconomica: 'Descrição Categoria',
        codGrupo: 'Cód. Grupo',
        txDescricaoGrupoDespesa: 'Descrição Grupo',
        // Modalidade
        codModalidade: 'Cód. Modalidade',
        txDescricaoModalidade: 'Descrição Modalidade',
        // Elemento
        codElemento: 'Cód. Elemento',
        txDescricaoElemento: 'Descrição Elemento',
        // Fonte de Recurso
        codFonteRecurso: 'Cód. Fonte Recurso',
        txDescricaoFonteRecurso: 'Descrição Fonte Recurso',
        // Item/SubElemento
        codItemDespesa: 'Cód. Item Despesa',
        txDescricaoItemDespesa: 'Descrição Item',
        codSubElemento: 'Cód. SubElemento',
        txDescricaoSubElementoDespesa: 'Descrição SubElemento',
        // VALORES FINANCEIROS
        valTotalEmpenhado: 'Valor Empenhado',
        valAnuladoEmpenho: 'Valor Anulado',
        valEmpenhadoLiquido: 'Empenhado Líquido',
        valLiquidado: 'Valor Liquidado',
        valPagoExercicio: 'Pago Exercício',
        valPagoRestos: 'Pago Restos'
    };

    // Botões de seleção de colunas
    $('#btnSelecionarTodas').click(function() {
        $('.coluna-empenho').prop('checked', true);
    });

    $('#btnDesmarcarTodas').click(function() {
        $('.coluna-empenho').prop('checked', false);
    });

    $('#btnRestaurarPadrao').click(function() {
        $('.coluna-empenho').prop('checked', false);
        $('#col_numReserva, #col_codEmpenho, #col_anoEmpenho, #col_mesEmpenho, #col_datEmpenho, #col_codProcesso').prop('checked', true);
    });

    // Consultar Empenhos
    function consultarEmpenhos(numeroPagina = 1) {
        const anoEmpenho = $('#anoEmpenho').val();
        const mesEmpenho = $('#mesEmpenho').val();
        
        if (!anoEmpenho) {
            alert('Ano do Empenho é obrigatório!');
            $('#anoEmpenho').focus();
            return;
        }
        
        if (!mesEmpenho) {
            alert('Mês do Empenho é obrigatório!');
            $('#mesEmpenho').focus();
            return;
        }

        $('#divErroEmpenhos, #divSucessoEmpenhos, #divTabelaEmpenhos, #divPaginacaoEmpenhos').hide();
        $('#loadingSpinnerEmpenhos').show();
        
        paginaAtualEmpenhos = numeroPagina;
        $('#paginaAtual').text(paginaAtualEmpenhos);
        $('#badgePaginaEmpenhos').text(`Página ${paginaAtualEmpenhos}`).show();

        $('#btnConsultarEmpenhos').prop('disabled', true);

        const filtros = {
            anoEmpenho: anoEmpenho,
            mesEmpenho: mesEmpenho,
            codOrgao: $('#codOrgaoEmpenho').val() || null,
            codEmpresa: $('#codEmpresaEmpenho').val() || null,
            codEmpenho: $('#codEmpenho').val() || null,
            codContrato: $('#codContratoEmpenho').val() || null,
            numCpfCnpj: $('#numCpfCnpjEmpenho').val() || null,
            txtRazaoSocial: $('#txtRazaoSocial').val() || null,
            anoExercicio: $('#anoExercicio').val() || null,
            codUnidade: $('#codUnidade').val() || null,
            codFuncao: $('#codFuncao').val() || null,
            codSubFuncao: $('#codSubFuncao').val() || null,
            codPrograma: $('#codPrograma').val() || null,
            codProjetoAtividade: $('#codProjetoAtividade').val() || null,
            codCategoria: $('#codCategoria').val() || null,
            codGrupo: $('#codGrupo').val() || null,
            codModalidade: $('#codModalidade').val() || null,
            codElemento: $('#codElemento').val() || null,
            codFonteRecurso: $('#codFonteRecurso').val() || null,
            numPagina: numeroPagina
        };
        
        // Salvar filtros para paginação
        ultimosFiltrosEmpenhos = filtros;

        $.ajax({
            url: '/gestao_orcamentaria/sof-api/api/consultar-empenhos',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(filtros),
            success: function(response) {
                $('#loadingSpinnerEmpenhos').hide();
                
                if (response.success) {
                    const empenhos = response.empenhos;
                    const total = response.total;
                    
                    $('#badgeTotalEmpenhos').text(`${total} empenho${total !== 1 ? 's' : ''}`);
                    
                    if (total > 0) {
                        renderizarTabelaEmpenhos(empenhos);
                        $('#divTabelaEmpenhos').show();
                        
                        // Mostrar controles de paginação
                        $('#divPaginacaoEmpenhos').show();
                        
                        // Habilitar/desabilitar botões
                        $('#btnPaginaAnterior').prop('disabled', paginaAtualEmpenhos === 1);
                        // API SOF retorna até 50 registros por página
                        $('#btnProximaPagina').prop('disabled', total < 50);
                        
                        $('#divSucessoEmpenhos').show().find('#textoSucessoEmpenhos').text(
                            `${total} empenho(s) encontrado(s) na página ${paginaAtualEmpenhos} (${response.duracao_ms}ms)`
                        );
                        setTimeout(() => $('#divSucessoEmpenhos').fadeOut(), 5000);
                    } else {
                        if (paginaAtualEmpenhos === 1) {
                            $('#divErroEmpenhos').show().find('#textoErroEmpenhos').text(
                                'Nenhum empenho encontrado com os filtros informados.'
                            );
                        } else {
                            $('#divErroEmpenhos').show().find('#textoErroEmpenhos').text(
                                'Não há mais resultados. Esta é a última página.'
                            );
                            $('#btnProximaPagina').prop('disabled', true);
                        }
                    }
                } else {
                    $('#divErroEmpenhos').show().find('#textoErroEmpenhos').text(
                        'Erro: ' + (response.erro || 'Erro desconhecido')
                    );
                }
            },
            error: function(xhr) {
                $('#loadingSpinnerEmpenhos').hide();
                const erro = xhr.responseJSON?.erro || 'Erro ao consultar API';
                $('#divErroEmpenhos').show().find('#textoErroEmpenhos').text(erro);
            },
            complete: function() {
                $('#btnConsultarEmpenhos').prop('disabled', false);
            }
        });
    }
    
    // Evento do botão Consultar Empenhos
    $('#btnConsultarEmpenhos').click(function() {
        consultarEmpenhos(1); // Sempre começar na página 1
    });
    
    // Navegação de páginas
    $('#btnPaginaAnterior').click(function() {
        if (paginaAtualEmpenhos > 1) {
            consultarEmpenhos(paginaAtualEmpenhos - 1);
        }
    });
    
    $('#btnProximaPagina').click(function() {
        consultarEmpenhos(paginaAtualEmpenhos + 1);
    });
    
    // =======================================================================
    // EXPORTAR CSV - BUSCAR TODAS AS PÁGINAS
    // =======================================================================
    
    $('#btnExportarCSV').click(async function() {
        const anoEmpenho = $('#anoEmpenho').val();
        const mesEmpenho = $('#mesEmpenho').val();
        
        if (!anoEmpenho || !mesEmpenho) {
            alert('Preencha Ano e Mês para exportar!');
            return;
        }
        
        // Obter colunas selecionadas
        const colunasSelecionadas = [];
        $('.coluna-empenho:checked').each(function() {
            colunasSelecionadas.push($(this).val());
        });
        
        if (colunasSelecionadas.length === 0) {
            alert('Selecione ao menos uma coluna para exportar!');
            return;
        }
        
        const btn = $(this);
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span> Exportando...');
        
        try {
            // Preparar filtros base
            const filtrosBase = {
                anoEmpenho: anoEmpenho,
                mesEmpenho: mesEmpenho,
                codOrgao: $('#codOrgaoEmpenho').val() || null,
                codEmpresa: $('#codEmpresaEmpenho').val() || null,
                codEmpenho: $('#codEmpenho').val() || null,
                codContrato: $('#codContratoEmpenho').val() || null,
                numCpfCnpj: $('#numCpfCnpjEmpenho').val() || null,
                txtRazaoSocial: $('#txtRazaoSocial').val() || null,
                anoExercicio: $('#anoExercicio').val() || null,
                codUnidade: $('#codUnidade').val() || null,
                codFuncao: $('#codFuncao').val() || null,
                codSubFuncao: $('#codSubFuncao').val() || null,
                codPrograma: $('#codPrograma').val() || null,
                codProjetoAtividade: $('#codProjetoAtividade').val() || null,
                codCategoria: $('#codCategoria').val() || null,
                codGrupo: $('#codGrupo').val() || null,
                codModalidade: $('#codModalidade').val() || null,
                codElemento: $('#codElemento').val() || null,
                codFonteRecurso: $('#codFonteRecurso').val() || null
            };
            
            let todosEmpenhos = [];
            let paginaAtual = 1;
            let temMaisPaginas = true;
            
            // Buscar todas as páginas (API SOF retorna até 50 por página)
            while (temMaisPaginas) {
                const filtros = { ...filtrosBase, numPagina: paginaAtual };
                
                const response = await $.ajax({
                    url: '/gestao_orcamentaria/sof-api/api/consultar-empenhos',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(filtros)
                });
                
                if (response.success && response.empenhos.length > 0) {
                    todosEmpenhos = todosEmpenhos.concat(response.empenhos);
                    btn.html(`<span class="spinner-border spinner-border-sm me-1"></span> Exportando... Página ${paginaAtual} (${todosEmpenhos.length} registros)`);
                    
                    // API retorna 50 por página. Se retornou menos, é a última
                    if (response.empenhos.length < 50) {
                        temMaisPaginas = false;
                    } else {
                        paginaAtual++;
                    }
                } else {
                    temMaisPaginas = false;
                }
            }
            
            if (todosEmpenhos.length === 0) {
                alert('Nenhum empenho encontrado para exportar!');
                return;
            }
            
            // Gerar CSV
            // Adicionar BOM UTF-8 para Excel reconhecer encoding
            let csv = '\ufeff';
            
            // Cabeçalho
            const cabecalho = colunasSelecionadas.map(col => colunasLabels[col] || col);
            csv += cabecalho.join(';') + '\n';
            
            // Dados
            todosEmpenhos.forEach(empenho => {
                const linha = colunasSelecionadas.map(coluna => {
                    let valor = empenho[coluna];
                    
                    // Limpar valor para CSV
                    if (valor === null || valor === undefined) {
                        return '';
                    }
                    
                    // Formatação especial por tipo de coluna
                    if (coluna.startsWith('val')) {
                        // Valores monetários - formatar com 2 casas decimais
                        const valorNum = parseFloat(valor) || 0;
                        return valorNum.toFixed(2).replace('.', ',');
                    } else if (coluna === 'codProcesso' || coluna === 'numCpfCnpj') {
                        // Números grandes - forçar como texto com aspas
                        return `="${valor}"`;
                    } else {
                        // Texto normal - converter e limpar
                        valor = String(valor).replace(/\r?\n/g, ' ').replace(/;/g, ',');
                        // Colocar entre aspas se contém vírgula ou espaço
                        if (valor.includes(',') || valor.includes(' ')) {
                            valor = `"${valor}"`;
                        }
                        return valor;
                    }
                });
                
                csv += linha.join(';') + '\n';
            });
            
            // Download do arquivo
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const dataHora = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const nomeArquivo = `empenhos_${anoEmpenho}_${mesEmpenho}_${dataHora}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', nomeArquivo);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Mostrar mensagem de sucesso
            $('#divSucessoEmpenhos').show().find('#textoSucessoEmpenhos').text(
                `CSV exportado com sucesso! ${todosEmpenhos.length} empenho(s) em ${paginaAtual} página(s).`
            );
            setTimeout(() => $('#divSucessoEmpenhos').fadeOut(), 5000);
            
        } catch (error) {
            console.error('Erro ao exportar CSV:', error);
            $('#divErroEmpenhos').show().find('#textoErroEmpenhos').text(
                'Erro ao exportar CSV: ' + (error.responseJSON?.erro || error.message || 'Erro desconhecido')
            );
        } finally {
            btn.prop('disabled', false).html('<i class="bi bi-download"></i> Exportar CSV (Todos)');
        }
    });

    function renderizarTabelaEmpenhos(empenhos) {
        // Obter colunas selecionadas
        const colunasSelecionadas = [];
        $('.coluna-empenho:checked').each(function() {
            colunasSelecionadas.push($(this).val());
        });

        if (colunasSelecionadas.length === 0) {
            alert('Selecione ao menos uma coluna para exibir!');
            return;
        }

        // Gerar cabeçalho dinâmico
        const thead = $('#theadEmpenhos');
        thead.empty();
        const trHead = $('<tr>');
        colunasSelecionadas.forEach(coluna => {
            trHead.append(`<th>${colunasLabels[coluna] || coluna}</th>`);
        });
        thead.append(trHead);

        // Gerar corpo da tabela
        const tbody = $('#tbodyEmpenhos');
        tbody.empty();

        empenhos.forEach(empenho => {
            const tr = $('<tr>');
            
            colunasSelecionadas.forEach(coluna => {
                let valor = empenho[coluna];
                
                // Formatações específicas
                if (valor === null || valor === undefined) {
                    valor = '-';
                } else if (coluna === 'datEmpenho' && valor) {
                    // Manter formato da data
                    valor = valor;
                } else if (coluna === 'numCpfCnpj' && valor) {
                    // Formatar CNPJ/CPF
                    valor = `<small>${valor}</small>`;
                } else if (coluna.startsWith('txDescricao') || coluna === 'txtRazaoSocial' || coluna === 'nomEmpresa') {
                    // Truncar textos longos
                    valor = `<span class="text-truncate-custom" title="${valor}">${valor}</span>`;
                } else if (coluna.startsWith('val')) {
                    // Formatar valores monetários
                    valor = `<span class="text-end d-block">${formatarMoeda(valor)}</span>`;
                }
                
                tr.append(`<td>${valor}</td>`);
            });
            
            tbody.append(tr);
        });
    }

    // =======================================================================
    // FUNÇÕES UTILITÁRIAS
    // =======================================================================
    
    function formatarMoeda(valor) {
        if (valor === null || valor === undefined) return 'R$ 0,00';
        return 'R$ ' + parseFloat(valor).toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
});
</script>
</body>
</html>
