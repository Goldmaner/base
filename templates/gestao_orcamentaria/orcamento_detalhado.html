<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Or√ßamento Detalhado - Gest√£o Or√ßament√°ria</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    
    <style>
        body {
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }
        .main-container {
            max-width: 98%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #764ba2;
        }
        
        .page-title {
            color: #667eea;
            font-weight: 700;
            font-size: 2rem;
        }
        
        .ano-referencia-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .ano-referencia-container label {
            margin: 0;
            font-weight: 600;
        }
        
        .ano-referencia-container input {
            width: 100px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 700;
            border: 2px solid white;
        }
        
        .filtros-container {
            background: #fff;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #dee2e6;
        }
        
        .table-responsive {
            max-height: 70vh;
            overflow: auto;
        }
        
        .table thead th {
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            z-index: 10;
            text-align: center;
            font-size: 0.9rem;
            padding: 12px 8px;
        }
        
        .table tbody td {
            vertical-align: middle;
            padding: 10px;
            font-size: 0.9rem;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .valor-moeda {
            text-align: right;
            font-weight: 600;
            color: #198754;
            font-family: 'Courier New', monospace;
        }
        
        .loading-spinner {
            text-align: center;
            padding: 50px;
        }
        
        .sem-dados {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
        
        .btn-voltar {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .btn-exportar {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .btn-limpar-filtros {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-weight: 600;
        }
    </style>
</head>
<body>

<div class="main-container">
    <!-- Cabe√ßalho -->
    <div class="header-section">
        <div>
            <h2 class="page-title">
                <i class="bi bi-file-earmark-text me-3"></i>
                Or√ßamento Detalhado
            </h2>
            <p class="text-muted mb-0">Relat√≥rio consolidado de dota√ß√µes or√ßament√°rias e valores programados</p>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <div class="ano-referencia-container">
                <label for="ano_referencia">Ano de Refer√™ncia:</label>
                <input type="number" class="form-control" id="ano_referencia" min="2015" max="2030" value="">
            </div>
            <button class="btn btn-exportar" onclick="exportarCSV()">
                <i class="bi bi-file-earmark-spreadsheet me-2"></i>Exportar CSV
            </button>
            <button class="btn btn-limpar-filtros" onclick="limparFiltros()">
                <i class="bi bi-eraser me-2"></i>Limpar Filtros
            </button>
            <a href="/gestao_orcamentaria" class="btn btn-voltar">
                <i class="bi bi-arrow-left me-2"></i>Voltar
            </a>
        </div>
    </div>
    
    <!-- Se√ß√£o de Filtros -->
    <div class="filtros-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                <i class="bi bi-funnel me-2"></i>Filtros
            </h5>
            <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosCollapse" aria-expanded="false">
                <i class="bi bi-chevron-down" id="iconFiltros"></i> Mostrar/Ocultar Filtros
            </button>
        </div>
        
        <div class="collapse" id="filtrosCollapse">
            <!-- FILTROS PRINCIPAIS -->
            <div class="mb-3">
                <button class="btn btn-light w-100 text-start d-flex justify-content-between align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#secaoPrincipais" aria-expanded="true">
                    <span><i class="bi bi-file-text"></i> <strong>Filtros Principais</strong></span>
                    <i class="bi bi-chevron-down"></i>
                </button>
                <div class="collapse show" id="secaoPrincipais">
                    <div class="card card-body mt-2">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="filtro_numero_termo" class="form-label">Termo ou Edital</label>
                                <input type="text" class="form-control" id="filtro_numero_termo" placeholder="Ex: TCL/001/2024 ou Edital 001/2024">
                            </div>
                            <div class="col-md-3">
                                <label for="filtro_dotacao" class="form-label">Dota√ß√£o Or√ßament√°ria</label>
                                <input type="text" class="form-control" id="filtro_dotacao" 
                                       list="lista_dotacao" placeholder="Digite para buscar...">
                                <datalist id="lista_dotacao">
                                    <!-- Op√ß√µes populadas via JavaScript -->
                                </datalist>
                            </div>
                            <div class="col-md-3">
                                <label for="filtro_projeto_atividade" class="form-label">Projeto-Atividade</label>
                                <input type="text" class="form-control" id="filtro_projeto_atividade" 
                                       list="lista_projeto_atividade" placeholder="Digite para buscar...">
                                <datalist id="lista_projeto_atividade">
                                    <!-- Op√ß√µes populadas via JavaScript -->
                                </datalist>
                            </div>
                            <div class="col-md-3">
                                <label for="filtro_programatica" class="form-label">Program√°tica</label>
                                <input type="text" class="form-control" id="filtro_programatica" 
                                       list="lista_programatica" placeholder="Digite para buscar...">
                                <datalist id="lista_programatica">
                                    <!-- Op√ß√µes populadas via JavaScript -->
                                </datalist>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- FILTROS ADICIONAIS (COLUNAS OPCIONAIS) -->
            <div class="mb-3">
                <button class="btn btn-light w-100 text-start d-flex justify-content-between align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#secaoAdicionais" aria-expanded="false">
                    <span><i class="bi bi-sliders"></i> <strong>Filtros Adicionais</strong></span>
                    <i class="bi bi-chevron-down"></i>
                </button>
                <div class="collapse" id="secaoAdicionais">
                    <div class="card card-body mt-2">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="filtro_tipo_contrato" class="form-label">Tipo de Contrato</label>
                                <input type="text" class="form-control" id="filtro_tipo_contrato" list="lista_tipo_contrato" placeholder="Digite para buscar...">
                                <datalist id="lista_tipo_contrato">
                                    <!-- Op√ß√µes populadas via JavaScript -->
                                </datalist>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Data de T√©rmino</label>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <select class="form-select form-select-sm" id="filtro_mes_termino">
                                            <option value="">M√™s</option>
                                            <option value="01">Janeiro</option>
                                            <option value="02">Fevereiro</option>
                                            <option value="03">Mar√ßo</option>
                                            <option value="04">Abril</option>
                                            <option value="05">Maio</option>
                                            <option value="06">Junho</option>
                                            <option value="07">Julho</option>
                                            <option value="08">Agosto</option>
                                            <option value="09">Setembro</option>
                                            <option value="10">Outubro</option>
                                            <option value="11">Novembro</option>
                                            <option value="12">Dezembro</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <input type="number" class="form-control form-control-sm" id="filtro_ano_termino" placeholder="Ano" min="2000" max="2099">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="filtro_cnpj" class="form-label">CNPJ</label>
                                <input type="text" class="form-control" id="filtro_cnpj" placeholder="Ex: 12.345.678/0001-99">
                            </div>
                            <div class="col-md-3">
                                <label for="filtro_sei_pc" class="form-label">SEI de Pgto./PC</label>
                                <input type="text" class="form-control" id="filtro_sei_pc" placeholder="Ex: 6074.2024/0001234-5">
                            </div>
                            <div class="col-md-3">
                                <label for="filtro_osc" class="form-label">OSC</label>
                                <input type="text" class="form-control" id="filtro_osc" list="lista_osc" placeholder="Digite para buscar...">
                                <datalist id="lista_osc">
                                    <!-- Op√ß√µes populadas via JavaScript -->
                                </datalist>
                            </div>
                            <div class="col-md-3">
                                <label for="filtro_projeto" class="form-label">Projeto</label>
                                <input type="text" class="form-control" id="filtro_projeto" list="lista_projeto" placeholder="Digite para buscar...">
                                <datalist id="lista_projeto">
                                    <!-- Op√ß√µes populadas via JavaScript -->
                                </datalist>
                            </div>
                            <div class="col-md-3">
                                <label for="filtro_sei_celeb" class="form-label">SEI de Celebra√ß√£o</label>
                                <input type="text" class="form-control" id="filtro_sei_celeb" placeholder="Ex: 6074.2024/0005678-9">
                            </div>
                        </div>
                        
                        <!-- Filtros de Valores -->
                        <div class="row g-3 mt-2 border-top pt-3">
                            <div class="col-12">
                                <h6 class="text-muted mb-3"><i class="bi bi-calculator"></i> Filtros de Valores</h6>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Total Programado</label>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <input type="number" class="form-control form-control-sm" id="filtro_programado_min" placeholder="M√≠nimo" step="0.01">
                                    </div>
                                    <div class="col-6">
                                        <input type="number" class="form-control form-control-sm" id="filtro_programado_max" placeholder="M√°ximo" step="0.01">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Total Projetado</label>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <input type="number" class="form-control form-control-sm" id="filtro_projetado_min" placeholder="M√≠nimo" step="0.01">
                                    </div>
                                    <div class="col-6">
                                        <input type="number" class="form-control form-control-sm" id="filtro_projetado_max" placeholder="M√°ximo" step="0.01">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Total Global</label>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <input type="number" class="form-control form-control-sm" id="filtro_global_min" placeholder="M√≠nimo" step="0.01">
                                    </div>
                                    <div class="col-6">
                                        <input type="number" class="form-control form-control-sm" id="filtro_global_max" placeholder="M√°ximo" step="0.01">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bot√µes de a√ß√£o -->
            <div class="row">
                <div class="col-md-12 d-flex gap-2">
                    <button type="button" class="btn btn-primary" onclick="aplicarFiltros()">
                        <i class="bi bi-search"></i> Aplicar Filtros
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="limparFiltros()">
                        <i class="bi bi-x-circle"></i> Limpar Filtros
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modo Cronograma Detalhado -->
    <div class="alert alert-info border mb-3">
        <strong><i class="bi bi-calendar-week me-2"></i>Modo de Exibi√ß√£o:</strong>
        <label class="ms-3">
            <input type="checkbox" id="chk_cronograma_detalhado" onchange="alternarModoCronograma()">
            <strong>Modo Cronograma Detalhado</strong>
            <small class="text-muted">(Afeta apenas Total Global expandido - mostra valores mensais com parcelas)</small>
        </label>
    </div>
    
    <!-- Colunas Opcionais -->
    <div class="alert alert-light border mb-3">
        <strong><i class="bi bi-eye me-2"></i>Colunas Opcionais:</strong>
        <label class="ms-3"><input type="checkbox" id="chk_tipo_contrato" onchange="atualizarColunasVisiveis()"> Tipo de Contrato</label>
        <label class="ms-3"><input type="checkbox" id="chk_data_termino" onchange="atualizarColunasVisiveis()"> Data de T√©rmino</label>
        <label class="ms-3"><input type="checkbox" id="chk_cnpj" onchange="atualizarColunasVisiveis()"> CNPJ</label>
        <label class="ms-3"><input type="checkbox" id="chk_sei_pc" onchange="atualizarColunasVisiveis()"> SEI de Pgto. / PC</label>
        <label class="ms-3"><input type="checkbox" id="chk_osc" onchange="atualizarColunasVisiveis()"> OSC</label>
        <label class="ms-3"><input type="checkbox" id="chk_projeto" onchange="atualizarColunasVisiveis()"> Projeto</label>
        <label class="ms-3"><input type="checkbox" id="chk_sei_celeb" onchange="atualizarColunasVisiveis()"> SEI de Celebra√ß√£o</label>
    </div>
    
    <!-- Totais do Or√ßamento -->
    <div class="alert alert-success border mb-3">
        <div class="row text-center">
            <div class="col-md-3">
                <strong><i class="bi bi-cash-stack me-2"></i>Total Programado:</strong>
                <span class="h5 ms-2" id="total_programado_header">R$ 0,00</span>
            </div>
            <div class="col-md-3">
                <strong><i class="bi bi-graph-up me-2"></i>Total Projetado:</strong>
                <span class="h5 ms-2" id="total_projetado_header">R$ 0,00</span>
            </div>
            <div class="col-md-3">
                <strong><i class="bi bi-calculator-fill me-2"></i>Total Global:</strong>
                <span class="h5 ms-2 text-success" id="total_global_header">R$ 0,00</span>
            </div>
            <div class="col-md-3">
                <strong><i class="bi bi-list-check me-2"></i>Termos:</strong>
                <span class="h5 ms-2" id="total_termos_header">0</span>
            </div>
        </div>
    </div>
    
    <!-- Tabela -->
    <div class="table-responsive">
        <table class="table table-hover table-bordered" id="tabelaOrcamento">
            <thead>
                <tr>
                    <th>Dota√ß√£o Or√ßament√°ria</th>
                    <th>Projeto-Atividade</th>
                    <th>Program√°tica</th>
                    <th>Termo ou Edital</th>
                    <th class="col-tipo-contrato" style="display: none;">Tipo de Contrato</th>
                    <th class="col-data-termino" style="display: none;">Data de T√©rmino</th>
                    <th class="col-cnpj" style="display: none;">CNPJ</th>
                    <th class="col-sei-pc" style="display: none;">SEI de Pgto. / PC</th>
                    <th class="col-osc" style="display: none;">OSC</th>
                    <th class="col-projeto" style="display: none;">Projeto</th>
                    <th class="col-sei-celeb" style="display: none;">SEI de Celebra√ß√£o</th>
                    <th onclick="toggleCronogramaProgramado()" style="cursor: pointer; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);" title="Clique para expandir cronograma mensal (Programadas)">
                        Total Programado
                        <i class="bi bi-calendar3" id="icone-cronograma-programado"></i>
                    </th>
                    <th onclick="toggleCronogramaProjetado()" style="cursor: pointer; background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);" title="Clique para expandir cronograma mensal (Projetadas)">
                        Total Projetado
                        <i class="bi bi-calendar3" id="icone-cronograma-projetado"></i>
                    </th>
                    <th onclick="toggleCronogramaGlobal()" style="cursor: pointer; background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);" title="Clique para expandir cronograma mensal (Global: Programadas + Projetadas)" class="bg-info bg-opacity-75 text-white">
                        Total Global
                        <i class="bi bi-calendar3" id="icone-cronograma-global"></i>
                    </th>
                </tr>
            </thead>
            <tbody id="corpoTabela">
                <!-- Preenchido via JavaScript -->
            </tbody>
            <tfoot class="table-secondary">
                <tr>
                    <th colspan="4" class="text-end">TOTAL GERAL:</th>
                    <th class="col-tipo-contrato" style="display: none;"></th>
                    <th class="col-data-termino" style="display: none;"></th>
                    <th class="col-cnpj" style="display: none;"></th>
                    <th class="col-sei-pc" style="display: none;"></th>
                    <th class="col-osc" style="display: none;"></th>
                    <th class="col-projeto" style="display: none;"></th>
                    <th class="col-sei-celeb" style="display: none;"></th>
                    <th class="valor-moeda" id="total_programado_footer">R$ 0,00</th>
                    <th class="valor-moeda" id="total_projetado_footer">R$ 0,00</th>                    <th class="valor-moeda bg-success bg-opacity-50" id="total_global_footer">R$ 0,00</th>                </tr>
            </tfoot>
        </table>
    </div>
    
    <!-- Loading -->
    <div class="loading-spinner" id="loading" style="display: none;">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-3">Carregando dados...</p>
    </div>
    
    <!-- Sem dados -->
    <div class="sem-dados" id="sem-dados" style="display: none;">
        <i class="bi bi-inbox" style="font-size: 4rem;"></i>
        <p class="mt-3">Nenhum termo encontrado para o ano selecionado</p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
    let dadosCompletos = [];
    let dadosFiltrados = [];
    let cronogramaProgramadoExpandido = false;
    let cronogramaProjetadoExpandido = false;
    let cronogramaGlobalExpandido = false;
    let dadosCronograma = {};
    let modoDetalhado = false;
    let dadosCronogramaDetalhado = {};
    
    // Configurar toastr
    toastr.options = {
        "closeButton": true,
        "progressBar": true,
        "positionClass": "toast-top-right",
        "timeOut": "3000"
    };
    
    // Inicializar
    $(document).ready(function() {
        // ‚ö° NOVO: Restaurar ano e filtros salvos
        const filtrosSalvos = restaurarFiltros();
        
        // Se n√£o h√° ano salvo, usar ano atual
        if (!filtrosSalvos || !filtrosSalvos.ano_referencia) {
            const anoAtual = new Date().getFullYear();
            $('#ano_referencia').val(anoAtual);
        }
        
        // Carregar dados
        carregarDados();
        
        // Event listener para mudan√ßa de ano
        $('#ano_referencia').on('change', function() {
            salvarFiltros(); // ‚ö° NOVO: Salvar ao mudar ano
            carregarDados();
        });
    });
    
    // ==================== EXPANS√ÉO DO CRONOGRAMA MENSAL ====================
    // Quando o usu√°rio clica no cabe√ßalho "Total Programado", a tabela se expande
    // mostrando 12 colunas adicionais (Jan-Dez) com os valores das parcelas Programadas.
    // Cada valor mensal √© o VALOR INTEGRAL da parcela que tem vigencia_inicial naquele m√™s.
    // Exemplo: Parcela 2026-01-01 a 2026-04-01 com R$ 458.732,28 ‚Üí Janeiro = R$ 458.732,28
    //
    // De forma an√°loga, clicar em "Total Projetado" expande com parcelas Projetadas.
    // Os dois cronogramas s√£o independentes e podem estar abertos simultaneamente.
    
    // Toggle do cronograma de Programadas
    function toggleCronogramaProgramado() {
        cronogramaProgramadoExpandido = !cronogramaProgramadoExpandido;
        
        if (cronogramaProgramadoExpandido) {
            $('#icone-cronograma-programado').removeClass('bi-calendar3').addClass('bi-calendar3-fill');
            carregarCronogramaMensal();
        } else {
            $('#icone-cronograma-programado').removeClass('bi-calendar3-fill').addClass('bi-calendar3');
            renderizarTabela();
        }
    }
    
    // Toggle do cronograma de Projetadas
    function toggleCronogramaProjetado() {
        cronogramaProjetadoExpandido = !cronogramaProjetadoExpandido;
        
        if (cronogramaProjetadoExpandido) {
            $('#icone-cronograma-projetado').removeClass('bi-calendar3').addClass('bi-calendar3-fill');
            carregarCronogramaMensal();
        } else {
            $('#icone-cronograma-projetado').removeClass('bi-calendar3-fill').addClass('bi-calendar3');
            renderizarTabela();
        }
    }
    
    // Toggle do cronograma Global (soma de Programadas + Projetadas)
    function toggleCronogramaGlobal() {
        cronogramaGlobalExpandido = !cronogramaGlobalExpandido;
        
        if (cronogramaGlobalExpandido) {
            $('#icone-cronograma-global').removeClass('bi-calendar3').addClass('bi-calendar3-fill');
            if (modoDetalhado) {
                carregarCronogramaDetalhado();
            } else {
                carregarCronogramaMensal();
            }
        } else {
            $('#icone-cronograma-global').removeClass('bi-calendar3-fill').addClass('bi-calendar3');
            renderizarTabela();
        }
    }
    
    // Alternar entre modo normal e modo detalhado
    function alternarModoCronograma() {
        modoDetalhado = $('#chk_cronograma_detalhado').is(':checked');
        
        console.log('[DEBUG] Modo detalhado:', modoDetalhado);
        
        // Se cronograma global est√° expandido, recarregar com o modo correto
        if (cronogramaGlobalExpandido) {
            if (modoDetalhado) {
                carregarCronogramaDetalhado();
                toastr.info('Modo Cronograma Detalhado ativado');
            } else {
                carregarCronogramaMensal();
                toastr.info('Modo Cronograma Normal ativado');
            }
        }
        
        salvarFiltros(); // Salvar prefer√™ncia
    }
    
    // Carregar dados do cronograma mensal
    function carregarCronogramaMensal() {
        const ano = $('#ano_referencia').val();
        
        if (!ano) {
            toastr.error('Por favor, selecione um ano de refer√™ncia');
            return;
        }
        
        // Carregar dados dos TERMOS (Programadas e Projetadas)
        $.ajax({
            url: '/gestao_orcamentaria/api/cronograma-mensal',
            method: 'GET',
            data: { ano_referencia: ano },
            success: function(response) {
                if (response.success) {
                    console.log('[DEBUG CRONOGRAMA] Dados dos termos recebidos:', response);
                    dadosCronograma = {
                        programados: response.dados_programados || {},
                        projetados: response.dados_projetados || {}
                    };
                    
                    // Agora carregar dados dos EDITAIS
                    carregarCronogramaEditais();
                } else {
                    toastr.error('Erro ao carregar cronograma: ' + response.error);
                }
            },
            error: function(xhr) {
                toastr.error('Erro ao carregar cronograma: ' + (xhr.responseJSON?.error || 'Erro desconhecido'));
            }
        });
    }
    
    // Carregar dados do cronograma de EDITAIS
    function carregarCronogramaEditais() {
        const ano = $('#ano_referencia').val();
        
        if (!ano) {
            toastr.error('Por favor, selecione um ano de refer√™ncia');
            return;
        }
        
        $.ajax({
            url: '/gestao_orcamentaria/api/cronograma-editais',
            method: 'GET',
            data: { ano_referencia: ano },
            success: function(response) {
                if (response.success) {
                    console.log('[DEBUG CRONOGRAMA EDITAIS] Dados recebidos:', response);
                    
                    // ‚ö° MESCLAR editais no objeto projetados (editais s√≥ t√™m valores projetados)
                    const dadosEditais = response.dados_editais || {};
                    for (const editalNome in dadosEditais) {
                        dadosCronograma.projetados[editalNome] = dadosEditais[editalNome];
                    }
                    
                    renderizarTabela();
                    toastr.success('Cronograma mensal carregado (termos + editais)!');
                } else {
                    toastr.error('Erro ao carregar cronograma de editais: ' + response.error);
                    // Mesmo com erro, renderizar o que j√° foi carregado
                    renderizarTabela();
                }
            },
            error: function(xhr) {
                toastr.error('Erro ao carregar cronograma de editais: ' + (xhr.responseJSON?.error || 'Erro desconhecido'));
                // Mesmo com erro, renderizar o que j√° foi carregado
                renderizarTabela();
            }
        });
    }
    
    // Carregar dados do cronograma DETALHADO (tabela ultra_liquidacoes_cronograma)
    function carregarCronogramaDetalhado() {
        const ano = $('#ano_referencia').val();
        
        if (!ano) {
            toastr.error('Por favor, selecione um ano de refer√™ncia');
            return;
        }
        
        // Carregar dados detalhados dos TERMOS
        $.ajax({
            url: '/gestao_orcamentaria/api/cronograma-detalhado',
            method: 'GET',
            data: { ano_referencia: ano },
            success: function(response) {
                if (response.success) {
                    console.log('[DEBUG CRONOGRAMA DETALHADO] Dados dos termos recebidos:', response);
                    dadosCronogramaDetalhado = response.dados || {};
                    
                    // Agora carregar dados dos EDITAIS (mesma fonte para modo detalhado)
                    carregarCronogramaEditaisDetalhado();
                } else {
                    toastr.error('Erro ao carregar cronograma detalhado: ' + response.error);
                }
            },
            error: function(xhr) {
                toastr.error('Erro ao carregar cronograma detalhado: ' + (xhr.responseJSON?.error || 'Erro desconhecido'));
            }
        });
    }
    
    // Carregar dados do cronograma de EDITAIS para modo detalhado
    function carregarCronogramaEditaisDetalhado() {
        const ano = $('#ano_referencia').val();
        
        if (!ano) {
            toastr.error('Por favor, selecione um ano de refer√™ncia');
            return;
        }
        
        $.ajax({
            url: '/gestao_orcamentaria/api/cronograma-editais',
            method: 'GET',
            data: { ano_referencia: ano },
            success: function(response) {
                if (response.success) {
                    console.log('[DEBUG CRONOGRAMA EDITAIS DETALHADO] Dados recebidos:', response);
                    
                    // ‚ö° Para editais no modo detalhado, usar mesma estrutura (sem parcelas)
                    const dadosEditais = response.dados_editais || {};
                    for (const editalNome in dadosEditais) {
                        dadosCronogramaDetalhado[editalNome] = {};
                        for (const mes in dadosEditais[editalNome]) {
                            dadosCronogramaDetalhado[editalNome][mes] = {
                                valor: dadosEditais[editalNome][mes],
                                parcelas: []  // Editais n√£o t√™m parcelas individuais
                            };
                        }
                    }
                    
                    renderizarTabela();
                    toastr.success('Cronograma detalhado carregado (termos + editais)!');
                } else {
                    toastr.error('Erro ao carregar cronograma de editais: ' + response.error);
                    // Mesmo com erro, renderizar o que j√° foi carregado
                    renderizarTabela();
                }
            },
            error: function(xhr) {
                toastr.error('Erro ao carregar cronograma de editais: ' + (xhr.responseJSON?.error || 'Erro desconhecido'));
                // Mesmo com erro, renderizar o que j√° foi carregado
                renderizarTabela();
            }
        });
    }
    
    // Carregar dados do servidor
    function carregarDados() {
        const ano = $('#ano_referencia').val();
        
        if (!ano) {
            toastr.error('Por favor, selecione um ano de refer√™ncia');
            return;
        }
        
        $('#loading').show();
        $('#sem-dados').hide();
        $('#corpoTabela').empty();
        
        $.ajax({
            url: '/gestao_orcamentaria/api/orcamento-detalhado',
            method: 'GET',
            data: { ano_referencia: ano },
            success: function(response) {
                $('#loading').hide();
                
                if (response.success) {
                    dadosCompletos = response.dados;
                    dadosFiltrados = [...dadosCompletos];
                    
                    if (dadosCompletos.length === 0) {
                        $('#sem-dados').show();
                    } else {
                        popularDropdownsFiltros(); // Preencher dropdowns com valores √∫nicos
                        aplicarFiltros();
                        renderizarTabela();
                        atualizarResumo();
                    }
                } else {
                    toastr.error('Erro ao carregar dados: ' + response.error);
                    $('#sem-dados').show();
                }
            },
            error: function(xhr) {
                $('#loading').hide();
                $('#sem-dados').show();
                toastr.error('Erro ao carregar dados: ' + (xhr.responseJSON?.error || 'Erro desconhecido'));
            }
        });
    }
    
    // Popular autocomplete (datalist) com valores √∫nicos dos dados carregados
    function popularDropdownsFiltros() {
        // Fun√ß√£o auxiliar para obter valores √∫nicos e ordenados
        const obterValoresUnicos = (campo) => {
            const valores = new Set();
            dadosCompletos.forEach(item => {
                const valor = item[campo];
                if (valor && valor !== '-' && String(valor).trim() !== '') {
                    valores.add(String(valor).trim());
                }
            });
            return Array.from(valores).sort();
        };
        
        // Popular Tipo de Contrato (datalist)
        const tiposContrato = obterValoresUnicos('tipo_contrato');
        const datalistTipoContrato = $('#lista_tipo_contrato');
        datalistTipoContrato.empty();
        tiposContrato.forEach(tipo => {
            datalistTipoContrato.append($('<option>').val(tipo));
        });
        
        // Popular OSC (datalist)
        const oscs = obterValoresUnicos('osc');
        const datalistOsc = $('#lista_osc');
        datalistOsc.empty();
        oscs.forEach(osc => {
            datalistOsc.append($('<option>').val(osc));
        });
        
        // Popular Projeto (datalist)
        const projetos = obterValoresUnicos('projeto');
        const datalistProjeto = $('#lista_projeto');
        datalistProjeto.empty();
        projetos.forEach(projeto => {
            datalistProjeto.append($('<option>').val(projeto));
        });
        
        // Popular Dota√ß√£o Or√ßament√°ria (datalist)
        const dotacoes = obterValoresUnicos('dotacao_orcamentaria');
        const datalistDotacao = $('#lista_dotacao');
        datalistDotacao.empty();
        dotacoes.forEach(dotacao => {
            datalistDotacao.append($('<option>').val(dotacao));
        });
        
        // Popular Projeto-Atividade (datalist)
        const projetosAtividade = obterValoresUnicos('projeto_atividade');
        const datalistProjetoAtividade = $('#lista_projeto_atividade');
        datalistProjetoAtividade.empty();
        projetosAtividade.forEach(pa => {
            datalistProjetoAtividade.append($('<option>').val(pa));
        });
        
        // Popular Program√°tica (datalist)
        const programaticas = obterValoresUnicos('programatica');
        const datalistProgramatica = $('#lista_programatica');
        datalistProgramatica.empty();
        programaticas.forEach(prog => {
            datalistProgramatica.append($('<option>').val(prog));
        });
        
        console.log('‚úÖ Autocomplete de filtros populados:', {
            tiposContrato: tiposContrato.length,
            oscs: oscs.length,
            projetos: projetos.length,
            dotacoes: dotacoes.length,
            projetosAtividade: projetosAtividade.length,
            programaticas: programaticas.length
        });
    }
    
    // Atualizar visibilidade das colunas opcionais
    function atualizarColunasVisiveis() {
        const mostrarTipoContrato = $('#chk_tipo_contrato').is(':checked');
        const mostrarDataTermino = $('#chk_data_termino').is(':checked');
        const mostrarCnpj = $('#chk_cnpj').is(':checked');
        const mostrarSeiPc = $('#chk_sei_pc').is(':checked');
        const mostrarOsc = $('#chk_osc').is(':checked');
        const mostrarProjeto = $('#chk_projeto').is(':checked');
        const mostrarSeiCeleb = $('#chk_sei_celeb').is(':checked');
        
        $('.col-tipo-contrato').toggle(mostrarTipoContrato);
        $('.col-data-termino').toggle(mostrarDataTermino);
        $('.col-cnpj').toggle(mostrarCnpj);
        $('.col-sei-pc').toggle(mostrarSeiPc);
        $('.col-osc').toggle(mostrarOsc);
        $('.col-projeto').toggle(mostrarProjeto);
        $('.col-sei-celeb').toggle(mostrarSeiCeleb);
        
        salvarFiltros(); // ‚ö° NOVO: Salvar estado das colunas
    }
    
    // Renderizar tabela
    function renderizarTabela() {
        const tbody = $('#corpoTabela');
        tbody.empty();
        
        if (dadosFiltrados.length === 0) {
            $('#sem-dados').show();
            return;
        }
        
        $('#sem-dados').hide();
        
        const thead = $('#tabelaOrcamento thead tr');
        const thProgramado = thead.find('th').filter(function() {
            return $(this).text().includes('Total Programado');
        });
        const thProjetado = thead.find('th').filter(function() {
            return $(this).text().includes('Total Projetado');
        });
        const thGlobal = thead.find('th').filter(function() {
            return $(this).text().includes('Total Global');
        });
        
        // Remover colunas de meses anteriores se existirem
        thead.find('.col-mes-programado').remove();
        thead.find('.col-mes-projetado').remove();
        thead.find('.col-mes-global').remove();
        
        // Se cronograma PROGRAMADO expandido, adicionar 12 colunas antes de "Total Programado"
        if (cronogramaProgramadoExpandido) {
            const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            meses.forEach(function(mes, index) {
                const thMes = $('<th>').addClass('col-mes-programado').text(mes + ' üìÖ').css({
                    'min-width': '120px',
                    'background': 'linear-gradient(135deg, #28a745 0%, #20c997 100%)',
                    'font-size': '0.85rem'
                }).attr('title', 'Programadas: ' + mes);
                thMes.insertBefore(thProgramado);
            });
        }
        
        // Se cronograma PROJETADO expandido, adicionar 12 colunas antes de "Total Projetado"
        if (cronogramaProjetadoExpandido) {
            const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            meses.forEach(function(mes, index) {
                const thMes = $('<th>').addClass('col-mes-projetado').text(mes + ' üîÆ').css({
                    'min-width': '120px',
                    'background': 'linear-gradient(135deg, #ffc107 0%, #ff9800 100%)',
                    'font-size': '0.85rem'
                }).attr('title', 'Projetadas: ' + mes);
                thMes.insertBefore(thProjetado);
            });
        }
        
        // Se cronograma GLOBAL expandido, adicionar 12 colunas antes de "Total Global"
        if (cronogramaGlobalExpandido) {
            const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            meses.forEach(function(mes, index) {
                const thMes = $('<th>').addClass('col-mes-global').text(mes + ' üåç').css({
                    'min-width': '120px',
                    'background': 'linear-gradient(135deg, #17a2b8 0%, #138496 100%)',
                    'font-size': '0.85rem'
                }).attr('title', 'Global (Prog + Proj): ' + mes);
                thMes.insertBefore(thGlobal);
            });
        }
        
        // Habilitar scroll horizontal se algum cronograma expandido
        if (cronogramaProgramadoExpandido || cronogramaProjetadoExpandido || cronogramaGlobalExpandido) {
            $('.table-responsive').css('overflow-x', 'auto');
        }
        
        dadosFiltrados.forEach(function(item) {
            const tr = $('<tr>');
            
            tr.append($('<td>').text(item.dotacao_orcamentaria || '-'));
            tr.append($('<td>').addClass('text-center').text(item.projeto_atividade || '-'));
            tr.append($('<td>').text(item.programatica || '-'));
            tr.append($('<td>').text(item.numero_termo || '-'));
            
            // Colunas opcionais
            tr.append($('<td>').addClass('col-tipo-contrato').css('display', $('#chk_tipo_contrato').is(':checked') ? '' : 'none').text(item.tipo_contrato || '-'));
            tr.append($('<td>').addClass('col-data-termino').css('display', $('#chk_data_termino').is(':checked') ? '' : 'none').text(item.data_termino || '-'));
            tr.append($('<td>').addClass('col-cnpj').css('display', $('#chk_cnpj').is(':checked') ? '' : 'none').text(item.cnpj || '-'));
            tr.append($('<td>').addClass('col-sei-pc').css('display', $('#chk_sei_pc').is(':checked') ? '' : 'none').text(item.sei_pc || '-'));
            tr.append($('<td>').addClass('col-osc').css('display', $('#chk_osc').is(':checked') ? '' : 'none').text(item.osc || '-'));
            tr.append($('<td>').addClass('col-projeto').css('display', $('#chk_projeto').is(':checked') ? '' : 'none').text(item.projeto || '-'));
            tr.append($('<td>').addClass('col-sei-celeb').css('display', $('#chk_sei_celeb').is(':checked') ? '' : 'none').text(item.sei_celeb || '-'));
            
            // Se cronograma PROGRAMADO expandido, adicionar 12 colunas de valores mensais ANTES de Total Programado
            if (cronogramaProgramadoExpandido) {
                const cronogramaProgramado = dadosCronograma.programados?.[item.numero_termo] || {};
                
                for (let mes = 1; mes <= 12; mes++) {
                    const valorProgramado = cronogramaProgramado[mes] || 0;
                    
                    const tdMes = $('<td>').addClass('valor-moeda col-mes-programado')
                        .text(formatarMoeda(valorProgramado))
                        .css({
                            'background': valorProgramado > 0 ? '#d4edda' : '#fff',
                            'font-weight': valorProgramado > 0 ? '600' : 'normal'
                        });
                    
                    tr.append(tdMes);
                }
            }
            
            tr.append($('<td>').addClass('valor-moeda').text(formatarMoeda(item.total_programado)));
            
            // Se cronograma PROJETADO expandido, adicionar 12 colunas de valores mensais ANTES de Total Projetado
            if (cronogramaProjetadoExpandido) {
                const cronogramaProjetado = dadosCronograma.projetados?.[item.numero_termo] || {};
                
                for (let mes = 1; mes <= 12; mes++) {
                    const valorProjetado = cronogramaProjetado[mes] || 0;
                    
                    const tdMes = $('<td>').addClass('valor-moeda col-mes-projetado')
                        .text(formatarMoeda(valorProjetado))
                        .css({
                            'background': valorProjetado > 0 ? '#fff3cd' : '#fff',
                            'font-weight': valorProjetado > 0 ? '600' : 'normal'
                        });
                    
                    tr.append(tdMes);
                }
            }
            
            tr.append($('<td>').addClass('valor-moeda').text(formatarMoeda(item.total_projetado)));
            
            // Se cronograma GLOBAL expandido, adicionar 12 colunas de valores mensais ANTES de Total Global
            if (cronogramaGlobalExpandido) {
                // MODO DETALHADO: Usa dados da tabela ultra_liquidacoes_cronograma
                if (modoDetalhado) {
                    const cronogramaDetalhado = dadosCronogramaDetalhado[item.numero_termo] || {};
                    
                    for (let mes = 1; mes <= 12; mes++) {
                        const dadosMes = cronogramaDetalhado[mes] || { valor: 0, parcelas: [] };
                        const valorMes = dadosMes.valor;
                        const parcelas = dadosMes.parcelas || [];
                        
                        const tdMes = $('<td>').addClass('valor-moeda col-mes-global');
                        
                        // Criar container para valor e badges
                        const container = $('<div>').css({
                            'display': 'flex',
                            'flex-direction': 'column',
                            'align-items': 'flex-end',
                            'gap': '4px'
                        });
                        
                        // Valor monet√°rio
                        const valorSpan = $('<span>').text(formatarMoeda(valorMes)).css({
                            'font-weight': valorMes > 0 ? '600' : 'normal'
                        });
                        container.append(valorSpan);
                        
                        // Badges das parcelas
                        if (parcelas.length > 0) {
                            const badgesContainer = $('<div>').css({
                                'display': 'flex',
                                'flex-wrap': 'wrap',
                                'gap': '2px',
                                'justify-content': 'flex-end'
                            });
                            
                            parcelas.forEach(parcela => {
                                const badge = $('<span>').addClass('badge bg-primary').text(parcela).css({
                                    'font-size': '0.7rem',
                                    'padding': '2px 6px'
                                });
                                badgesContainer.append(badge);
                            });
                            
                            container.append(badgesContainer);
                        }
                        
                        tdMes.append(container).css({
                            'background': valorMes > 0 ? '#d1ecf1' : '#fff',
                            'min-width': '150px',
                            'padding': '8px'
                        });
                        
                        tr.append(tdMes);
                    }
                } 
                // MODO NORMAL: Soma de Programadas + Projetadas
                else {
                    const cronogramaProgramado = dadosCronograma.programados?.[item.numero_termo] || {};
                    const cronogramaProjetado = dadosCronograma.projetados?.[item.numero_termo] || {};
                    
                    for (let mes = 1; mes <= 12; mes++) {
                        const valorProgramado = cronogramaProgramado[mes] || 0;
                        const valorProjetado = cronogramaProjetado[mes] || 0;
                        const valorGlobalMes = valorProgramado + valorProjetado;
                        
                        const tdMes = $('<td>').addClass('valor-moeda col-mes-global')
                            .text(formatarMoeda(valorGlobalMes))
                            .css({
                                'background': valorGlobalMes > 0 ? '#d1ecf1' : '#fff',
                                'font-weight': valorGlobalMes > 0 ? '600' : 'normal'
                            })
                            .attr('title', `Programado: ${formatarMoeda(valorProgramado)}\nProjetado: ${formatarMoeda(valorProjetado)}`);
                        
                        tr.append(tdMes);
                    }
                }
            }
            
            // Adicionar Total Global
            const totalGlobal = (item.total_programado || 0) + (item.total_projetado || 0);
            tr.append($('<td>').addClass('valor-moeda bg-success bg-opacity-10').text(formatarMoeda(totalGlobal)));
            
            tbody.append(tr);
        });
        
        // Atualizar totais do footer
        const totalProgramado = dadosFiltrados.reduce((sum, item) => sum + (item.total_programado || 0), 0);
        const totalProjetado = dadosFiltrados.reduce((sum, item) => sum + (item.total_projetado || 0), 0);
        const totalGlobal = totalProgramado + totalProjetado;
        
        const footerRow = $('#tabelaOrcamento tfoot tr');
        footerRow.find('.col-mes-programado').remove();
        footerRow.find('.col-mes-projetado').remove();
        
        // Se cronograma PROGRAMADO expandido, adicionar totais mensais
        if (cronogramaProgramadoExpandido) {
            const thProgramado = $('#total_programado_footer');
            
            for (let mes = 1; mes <= 12; mes++) {
                let totalMesProgramado = 0;
                
                dadosFiltrados.forEach(function(item) {
                    const cronogramaProg = dadosCronograma.programados?.[item.numero_termo] || {};
                    totalMesProgramado += cronogramaProg[mes] || 0;
                });
                
                const thMes = $('<th>').addClass('valor-moeda col-mes-programado')
                    .text(formatarMoeda(totalMesProgramado))
                    .css({
                        'background': totalMesProgramado > 0 ? '#d4edda' : '#f8f9fa',
                        'font-weight': '700'
                    });
                thMes.insertBefore(thProgramado);
            }
        }
        
        $('#total_programado_footer').text(formatarMoeda(totalProgramado));
        
        // Se cronograma PROJETADO expandido, adicionar totais mensais
        if (cronogramaProjetadoExpandido) {
            const thProjetado = $('#total_projetado_footer');
            
            for (let mes = 1; mes <= 12; mes++) {
                let totalMesProjetado = 0;
                
                dadosFiltrados.forEach(function(item) {
                    const cronogramaProj = dadosCronograma.projetados?.[item.numero_termo] || {};
                    totalMesProjetado += cronogramaProj[mes] || 0;
                });
                
                const thMes = $('<th>').addClass('valor-moeda col-mes-projetado')
                    .text(formatarMoeda(totalMesProjetado))
                    .css({
                        'background': totalMesProjetado > 0 ? '#fff3cd' : '#f8f9fa',
                        'font-weight': '700'
                    });
                thMes.insertBefore(thProjetado);
            }
        }
        
        $('#total_projetado_footer').text(formatarMoeda(totalProjetado));
        
        // Se cronograma GLOBAL expandido, adicionar totais mensais
        if (cronogramaGlobalExpandido) {
            const thGlobal = $('#total_global_footer');
            
            // MODO DETALHADO: Usa dados da tabela ultra_liquidacoes_cronograma
            if (modoDetalhado) {
                for (let mes = 1; mes <= 12; mes++) {
                    let totalMesDetalhado = 0;
                    
                    dadosFiltrados.forEach(function(item) {
                        const cronogramaDetalhado = dadosCronogramaDetalhado[item.numero_termo] || {};
                        const dadosMes = cronogramaDetalhado[mes] || { valor: 0, parcelas: [] };
                        totalMesDetalhado += dadosMes.valor || 0;
                    });
                    
                    const thMes = $('<th>').addClass('valor-moeda col-mes-global')
                        .text(formatarMoeda(totalMesDetalhado))
                        .css({
                            'background': totalMesDetalhado > 0 ? '#d1ecf1' : '#f8f9fa',
                            'font-weight': '700'
                        })
                        .attr('title', 'Modo Detalhado');
                    thMes.insertBefore(thGlobal);
                }
            }
            // MODO NORMAL: Soma de Programadas + Projetadas
            else {
                for (let mes = 1; mes <= 12; mes++) {
                    let totalMesProgramado = 0;
                    let totalMesProjetado = 0;
                    
                    dadosFiltrados.forEach(function(item) {
                        const cronogramaProg = dadosCronograma.programados?.[item.numero_termo] || {};
                        const cronogramaProj = dadosCronograma.projetados?.[item.numero_termo] || {};
                        totalMesProgramado += cronogramaProg[mes] || 0;
                        totalMesProjetado += cronogramaProj[mes] || 0;
                    });
                    
                    const totalMesGlobal = totalMesProgramado + totalMesProjetado;
                    const thMes = $('<th>').addClass('valor-moeda col-mes-global')
                        .text(formatarMoeda(totalMesGlobal))
                        .css({
                            'background': totalMesGlobal > 0 ? '#d1ecf1' : '#f8f9fa',
                            'font-weight': '700'
                        })
                        .attr('title', `Programado: ${formatarMoeda(totalMesProgramado)}\nProjetado: ${formatarMoeda(totalMesProjetado)}`);
                    thMes.insertBefore(thGlobal);
                }
            }
        }
        
        $('#total_global_footer').text(formatarMoeda(totalGlobal));
    }
    
    // Atualizar cards de resumo
    function atualizarResumo() {
        // Atualizar apenas o banner verde (header)
        $('#total_termos_header').text(dadosFiltrados.length);
        
        const totalProgramado = dadosFiltrados.reduce((sum, item) => sum + (item.total_programado || 0), 0);
        $('#total_programado_header').text(formatarMoeda(totalProgramado));
        
        const totalProjetado = dadosFiltrados.reduce((sum, item) => sum + (item.total_projetado || 0), 0);
        $('#total_projetado_header').text(formatarMoeda(totalProjetado));
        
        const totalGlobal = totalProgramado + totalProjetado;
        $('#total_global_header').text(formatarMoeda(totalGlobal));
    }
    // ==================== FILTROS SIMPLIFICADOS ====================
    
    function aplicarFiltros() {
        salvarFiltros(); // ‚ö° NOVO: Salvar filtros antes de aplicar
        
        // Coletar valores dos filtros
        const filtros = {
            numero_termo: $('#filtro_numero_termo').val().toLowerCase(),
            dotacao: $('#filtro_dotacao').val().toLowerCase(),
            projeto_atividade: $('#filtro_projeto_atividade').val().toLowerCase(),
            programatica: $('#filtro_programatica').val().toLowerCase(),
            tipo_contrato: $('#filtro_tipo_contrato').val().toLowerCase(),
            mes_termino: $('#filtro_mes_termino').val(),
            ano_termino: $('#filtro_ano_termino').val(),
            cnpj: $('#filtro_cnpj').val().toLowerCase(),
            sei_pc: $('#filtro_sei_pc').val().toLowerCase(),
            osc: $('#filtro_osc').val().toLowerCase(),
            projeto: $('#filtro_projeto').val().toLowerCase(),
            sei_celeb: $('#filtro_sei_celeb').val().toLowerCase(),
            programado_min: $('#filtro_programado_min').val() === '' ? null : parseFloat($('#filtro_programado_min').val()),
            programado_max: $('#filtro_programado_max').val() === '' ? null : parseFloat($('#filtro_programado_max').val()),
            projetado_min: $('#filtro_projetado_min').val() === '' ? null : parseFloat($('#filtro_projetado_min').val()),
            projetado_max: $('#filtro_projetado_max').val() === '' ? null : parseFloat($('#filtro_projetado_max').val()),
            global_min: $('#filtro_global_min').val() === '' ? null : parseFloat($('#filtro_global_min').val()),
            global_max: $('#filtro_global_max').val() === '' ? null : parseFloat($('#filtro_global_max').val())
        };
        
        // DEBUG: Log dos filtros de valores
        console.log('üîç DEBUG FILTROS DE VALORES:', {
            programado_min: filtros.programado_min,
            programado_max: filtros.programado_max,
            projetado_min: filtros.projetado_min,
            projetado_max: filtros.projetado_max,
            global_min: filtros.global_min,
            global_max: filtros.global_max
        });
        
        // Filtrar dados
        dadosFiltrados = dadosCompletos.filter(item => {
            // Verificar cada filtro
            if (filtros.numero_termo && !item.numero_termo.toLowerCase().includes(filtros.numero_termo)) return false;
            if (filtros.dotacao && !item.dotacao_orcamentaria.toLowerCase().includes(filtros.dotacao)) return false;
            if (filtros.projeto_atividade && !item.projeto_atividade.toLowerCase().includes(filtros.projeto_atividade)) return false;
            if (filtros.programatica && !item.programatica.toLowerCase().includes(filtros.programatica)) return false;
            if (filtros.tipo_contrato && !item.tipo_contrato.toLowerCase().includes(filtros.tipo_contrato)) return false;
            
            // Filtro de data de t√©rmino (suporta m√™s/ano separados)
            if (filtros.mes_termino || filtros.ano_termino) {
                if (item.data_termino) {
                    // Formato vindo do backend: dd/mm/YYYY
                    const partes = item.data_termino.split('/');
                    const ano = partes[2]; // Ano est√° na posi√ß√£o 2
                    const mes = partes[1]; // M√™s est√° na posi√ß√£o 1
                    
                    if (filtros.ano_termino && ano !== String(filtros.ano_termino).trim()) return false;
                    if (filtros.mes_termino && mes !== filtros.mes_termino) return false;
                } else {
                    return false; // Se filtro est√° ativo mas item n√£o tem data
                }
            }
            
            if (filtros.cnpj && !item.cnpj.toLowerCase().includes(filtros.cnpj)) return false;
            if (filtros.sei_pc && !item.sei_pc.toLowerCase().includes(filtros.sei_pc)) return false;
            if (filtros.osc && !item.osc.toLowerCase().includes(filtros.osc)) return false;
            if (filtros.projeto && !item.projeto.toLowerCase().includes(filtros.projeto)) return false;
            if (filtros.sei_celeb && !item.sei_celeb.toLowerCase().includes(filtros.sei_celeb)) return false;
            
            // Filtros de valores (min/max) - DEBUG
            if (filtros.programado_min !== null && item.total_programado < filtros.programado_min) {
                console.log(`‚ùå Filtrado por programado_min: ${item.numero_termo} (${item.total_programado} < ${filtros.programado_min})`);
                return false;
            }
            if (filtros.programado_max !== null && item.total_programado > filtros.programado_max) {
                console.log(`‚ùå Filtrado por programado_max: ${item.numero_termo} (${item.total_programado} > ${filtros.programado_max})`);
                return false;
            }
            if (filtros.projetado_min !== null && item.total_projetado < filtros.projetado_min) return false;
            if (filtros.projetado_max !== null && item.total_projetado > filtros.projetado_max) return false;
            if (filtros.global_min !== null && item.total_global < filtros.global_min) return false;
            if (filtros.global_max !== null && item.total_global > filtros.global_max) return false;
            
            return true;
        });
        
        renderizarTabela();
        atualizarResumo();
        toastr.success(`${dadosFiltrados.length} termos encontrados`);
    }
    
    function limparFiltros() {
        // Limpar campos de texto
        $('#filtro_numero_termo, #filtro_dotacao, #filtro_projeto_atividade, #filtro_programatica').val('');
        $('#filtro_cnpj, #filtro_sei_pc, #filtro_sei_celeb').val('');
        
        // Limpar autocomplete (inputs com datalist)
        $('#filtro_tipo_contrato, #filtro_osc, #filtro_projeto').val('');
        
        // Limpar data de t√©rmino
        $('#filtro_mes_termino, #filtro_ano_termino').val('');
        
        // Limpar filtros de valores
        $('#filtro_programado_min, #filtro_programado_max').val('');
        $('#filtro_projetado_min, #filtro_projetado_max').val('');
        $('#filtro_global_min, #filtro_global_max').val('');
        
        // ‚ö° NOVO: Remover filtros do localStorage (mant√©m apenas ano e colunas)
        const filtrosSalvos = JSON.parse(localStorage.getItem('orcamento_detalhado_filtros') || '{}');
        const apenasAnoEColunas = {
            ano_referencia: filtrosSalvos.ano_referencia,
            chk_tipo_contrato: filtrosSalvos.chk_tipo_contrato,
            chk_data_termino: filtrosSalvos.chk_data_termino,
            chk_cnpj: filtrosSalvos.chk_cnpj,
            chk_sei_pc: filtrosSalvos.chk_sei_pc,
            chk_osc: filtrosSalvos.chk_osc,
            chk_projeto: filtrosSalvos.chk_projeto,
            chk_sei_celeb: filtrosSalvos.chk_sei_celeb
        };
        localStorage.setItem('orcamento_detalhado_filtros', JSON.stringify(apenasAnoEColunas));
        
        // Resetar dados filtrados
        dadosFiltrados = [...dadosCompletos];
        renderizarTabela();
        atualizarResumo();
        toastr.info('Filtros limpos');
    }
    
    // Toggle √≠cone do collapse
    $('#filtrosCollapse').on('show.bs.collapse', function() {
        $('#iconFiltros').removeClass('bi-chevron-down').addClass('bi-chevron-up');
    }).on('hide.bs.collapse', function() {
        $('#iconFiltros').removeClass('bi-chevron-up').addClass('bi-chevron-down');
    });
    
    // Exportar para CSV
    function exportarCSV() {
        const ano = $('#ano_referencia').val();
        
        if (!ano) {
            toastr.error('Por favor, selecione um ano de refer√™ncia');
            return;
        }
        
        if (dadosFiltrados.length === 0) {
            toastr.warning('Nenhum dado para exportar');
            return;
        }
        
        // Criar CSV
        const BOM = '\uFEFF';
        const cabecalho = ['Dota√ß√£o Or√ßament√°ria', 'Projeto-Atividade', 'Program√°tica', 'Termo ou Edital'];
        
        // Adicionar colunas opcionais ao cabe√ßalho se estiverem vis√≠veis
        if ($('#chk_tipo_contrato').is(':checked')) cabecalho.push('Tipo de Contrato');
        if ($('#chk_data_termino').is(':checked')) cabecalho.push('Data de T√©rmino');
        if ($('#chk_cnpj').is(':checked')) cabecalho.push('CNPJ');
        if ($('#chk_sei_pc').is(':checked')) cabecalho.push('SEI de Pgto. / PC');
        if ($('#chk_osc').is(':checked')) cabecalho.push('OSC');
        if ($('#chk_projeto').is(':checked')) cabecalho.push('Projeto');
        if ($('#chk_sei_celeb').is(':checked')) cabecalho.push('SEI de Celebra√ß√£o');
        
        // Se cronograma PROGRAMADO expandido, adicionar colunas de meses
        if (cronogramaProgramadoExpandido) {
            const meses = ['Jan (Prog)', 'Fev (Prog)', 'Mar (Prog)', 'Abr (Prog)', 'Mai (Prog)', 'Jun (Prog)', 
                          'Jul (Prog)', 'Ago (Prog)', 'Set (Prog)', 'Out (Prog)', 'Nov (Prog)', 'Dez (Prog)'];
            meses.forEach(mes => cabecalho.push(mes));
        }
        
        cabecalho.push('Total Programado');
        
        // Se cronograma PROJETADO expandido, adicionar colunas de meses
        if (cronogramaProjetadoExpandido) {
            const meses = ['Jan (Proj)', 'Fev (Proj)', 'Mar (Proj)', 'Abr (Proj)', 'Mai (Proj)', 'Jun (Proj)', 
                          'Jul (Proj)', 'Ago (Proj)', 'Set (Proj)', 'Out (Proj)', 'Nov (Proj)', 'Dez (Proj)'];
            meses.forEach(mes => cabecalho.push(mes));
        }
        
        cabecalho.push('Total Projetado');
        
        // Se cronograma GLOBAL expandido, adicionar colunas de meses
        if (cronogramaGlobalExpandido) {
            const meses = ['Jan (Global)', 'Fev (Global)', 'Mar (Global)', 'Abr (Global)', 'Mai (Global)', 'Jun (Global)', 
                          'Jul (Global)', 'Ago (Global)', 'Set (Global)', 'Out (Global)', 'Nov (Global)', 'Dez (Global)'];
            meses.forEach(mes => cabecalho.push(mes));
        }
        
        cabecalho.push('Total Global');
        
        const linhas = [cabecalho.join(';')];
        
        dadosFiltrados.forEach(function(item) {
            const linha = [
                item.dotacao_orcamentaria || '',
                item.projeto_atividade || '',
                item.programatica || '',
                item.numero_termo || ''
            ];
            
            // Adicionar colunas opcionais se estiverem vis√≠veis
            if ($('#chk_tipo_contrato').is(':checked')) linha.push(item.tipo_contrato || '');
            if ($('#chk_data_termino').is(':checked')) linha.push(item.data_termino || '');
            if ($('#chk_cnpj').is(':checked')) linha.push(item.cnpj || '');
            if ($('#chk_sei_pc').is(':checked')) linha.push(item.sei_pc || '');
            if ($('#chk_osc').is(':checked')) linha.push(item.osc || '');
            if ($('#chk_projeto').is(':checked')) linha.push(item.projeto || '');
            if ($('#chk_sei_celeb').is(':checked')) linha.push(item.sei_celeb || '');
            
            // Se cronograma PROGRAMADO expandido, adicionar valores mensais
            if (cronogramaProgramadoExpandido) {
                const cronogramaProg = dadosCronograma.programados?.[item.numero_termo] || {};
                for (let mes = 1; mes <= 12; mes++) {
                    const valorMes = cronogramaProg[mes] || 0;
                    linha.push(formatarMoedaExcel(valorMes));
                }
            }
            
            linha.push(formatarMoedaExcel(item.total_programado));
            
            // Se cronograma PROJETADO expandido, adicionar valores mensais
            if (cronogramaProjetadoExpandido) {
                const cronogramaProj = dadosCronograma.projetados?.[item.numero_termo] || {};
                for (let mes = 1; mes <= 12; mes++) {
                    const valorMes = cronogramaProj[mes] || 0;
                    linha.push(formatarMoedaExcel(valorMes));
                }
            }
            
            linha.push(formatarMoedaExcel(item.total_projetado));
            
            // Se cronograma GLOBAL expandido, adicionar valores mensais
            if (cronogramaGlobalExpandido) {
                // MODO DETALHADO: Usa dados da tabela ultra_liquidacoes_cronograma
                if (modoDetalhado) {
                    const cronogramaDetalhado = dadosCronogramaDetalhado[item.numero_termo] || {};
                    
                    for (let mes = 1; mes <= 12; mes++) {
                        const dadosMes = cronogramaDetalhado[mes] || {};
                        const valorMes = dadosMes.valor || 0;
                        linha.push(formatarMoedaExcel(valorMes));
                    }
                }
                // MODO NORMAL: Soma de Programadas + Projetadas
                else {
                    const cronogramaProg = dadosCronograma.programados?.[item.numero_termo] || {};
                    const cronogramaProj = dadosCronograma.projetados?.[item.numero_termo] || {};
                    for (let mes = 1; mes <= 12; mes++) {
                        const valorProg = cronogramaProg[mes] || 0;
                        const valorProj = cronogramaProj[mes] || 0;
                        const valorGlobal = valorProg + valorProj;
                        linha.push(formatarMoedaExcel(valorGlobal));
                    }
                }
            }
            
            linha.push(formatarMoedaExcel(item.total_global || ((item.total_programado || 0) + (item.total_projetado || 0))));
            
            linhas.push(linha.join(';'));
        });
        
        const csvContent = BOM + linhas.join('\r\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `orcamento_detalhado_${ano}_${new Date().getTime()}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        toastr.success('CSV exportado com sucesso!');
    }
    
    // Formatar moeda para exibi√ß√£o
    function formatarMoeda(valor) {
        if (!valor) return 'R$ 0,00';
        return 'R$ ' + parseFloat(valor).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    
    // Formatar moeda para Excel (formato BR com v√≠rgula)
    function formatarMoedaExcel(valor) {
        if (!valor) return '0,00';
        return parseFloat(valor).toFixed(2).replace('.', ',');
    }
    
    // ==================== PERSIST√äNCIA DE FILTROS ====================
    
    // Salvar filtros no localStorage
    function salvarFiltros() {
        const filtros = {
            // Ano de refer√™ncia
            ano_referencia: $('#ano_referencia').val(),
            
            // Filtros de texto
            numero_termo: $('#filtro_numero_termo').val(),
            dotacao: $('#filtro_dotacao').val(),
            projeto_atividade: $('#filtro_projeto_atividade').val(),
            programatica: $('#filtro_programatica').val(),
            tipo_contrato: $('#filtro_tipo_contrato').val(),
            mes_termino: $('#filtro_mes_termino').val(),
            ano_termino: $('#filtro_ano_termino').val(),
            cnpj: $('#filtro_cnpj').val(),
            sei_pc: $('#filtro_sei_pc').val(),
            osc: $('#filtro_osc').val(),
            projeto: $('#filtro_projeto').val(),
            sei_celeb: $('#filtro_sei_celeb').val(),
            
            // Filtros de valores
            programado_min: $('#filtro_programado_min').val(),
            programado_max: $('#filtro_programado_max').val(),
            projetado_min: $('#filtro_projetado_min').val(),
            projetado_max: $('#filtro_projetado_max').val(),
            global_min: $('#filtro_global_min').val(),
            global_max: $('#filtro_global_max').val(),
            
            // Checkboxes de colunas
            chk_tipo_contrato: $('#chk_tipo_contrato').is(':checked'),
            chk_data_termino: $('#chk_data_termino').is(':checked'),
            chk_cnpj: $('#chk_cnpj').is(':checked'),
            chk_sei_pc: $('#chk_sei_pc').is(':checked'),
            chk_osc: $('#chk_osc').is(':checked'),
            chk_projeto: $('#chk_projeto').is(':checked'),
            chk_sei_celeb: $('#chk_sei_celeb').is(':checked'),
            
            // Modo cronograma detalhado
            chk_cronograma_detalhado: $('#chk_cronograma_detalhado').is(':checked')
        };
        
        localStorage.setItem('orcamento_detalhado_filtros', JSON.stringify(filtros));
        console.log('üíæ Filtros salvos no localStorage');
    }
    
    // Restaurar filtros do localStorage
    function restaurarFiltros() {
        const filtrosSalvos = localStorage.getItem('orcamento_detalhado_filtros');
        
        if (!filtrosSalvos) {
            console.log('‚ÑπÔ∏è Nenhum filtro salvo encontrado');
            return null;
        }
        
        try {
            const filtros = JSON.parse(filtrosSalvos);
            console.log('üìÇ Restaurando filtros:', filtros);
            
            // Restaurar ano de refer√™ncia
            if (filtros.ano_referencia) {
                $('#ano_referencia').val(filtros.ano_referencia);
            }
            
            // Restaurar filtros de texto
            $('#filtro_numero_termo').val(filtros.numero_termo || '');
            $('#filtro_dotacao').val(filtros.dotacao || '');
            $('#filtro_projeto_atividade').val(filtros.projeto_atividade || '');
            $('#filtro_programatica').val(filtros.programatica || '');
            $('#filtro_tipo_contrato').val(filtros.tipo_contrato || '');
            $('#filtro_mes_termino').val(filtros.mes_termino || '');
            $('#filtro_ano_termino').val(filtros.ano_termino || '');
            $('#filtro_cnpj').val(filtros.cnpj || '');
            $('#filtro_sei_pc').val(filtros.sei_pc || '');
            $('#filtro_osc').val(filtros.osc || '');
            $('#filtro_projeto').val(filtros.projeto || '');
            $('#filtro_sei_celeb').val(filtros.sei_celeb || '');
            
            // Restaurar filtros de valores
            $('#filtro_programado_min').val(filtros.programado_min || '');
            $('#filtro_programado_max').val(filtros.programado_max || '');
            $('#filtro_projetado_min').val(filtros.projetado_min || '');
            $('#filtro_projetado_max').val(filtros.projetado_max || '');
            $('#filtro_global_min').val(filtros.global_min || '');
            $('#filtro_global_max').val(filtros.global_max || '');
            
            // Restaurar checkboxes de colunas
            $('#chk_tipo_contrato').prop('checked', filtros.chk_tipo_contrato || false);
            $('#chk_data_termino').prop('checked', filtros.chk_data_termino || false);
            $('#chk_cnpj').prop('checked', filtros.chk_cnpj || false);
            $('#chk_sei_pc').prop('checked', filtros.chk_sei_pc || false);
            $('#chk_osc').prop('checked', filtros.chk_osc || false);
            $('#chk_projeto').prop('checked', filtros.chk_projeto || false);
            $('#chk_sei_celeb').prop('checked', filtros.chk_sei_celeb || false);
            
            // Restaurar modo cronograma detalhado
            $('#chk_cronograma_detalhado').prop('checked', filtros.chk_cronograma_detalhado || false);
            modoDetalhado = filtros.chk_cronograma_detalhado || false;
            
            // Aplicar visibilidade das colunas
            $('.col-tipo-contrato').toggle(filtros.chk_tipo_contrato || false);
            $('.col-data-termino').toggle(filtros.chk_data_termino || false);
            $('.col-cnpj').toggle(filtros.chk_cnpj || false);
            $('.col-sei-pc').toggle(filtros.chk_sei_pc || false);
            $('.col-osc').toggle(filtros.chk_osc || false);
            $('.col-projeto').toggle(filtros.chk_projeto || false);
            $('.col-sei-celeb').toggle(filtros.chk_sei_celeb || false);
            
            console.log('‚úÖ Filtros restaurados com sucesso');
            return filtros;
        } catch (e) {
            console.error('‚ùå Erro ao restaurar filtros:', e);
            localStorage.removeItem('orcamento_detalhado_filtros');
            return null;
        }
    }
</script>

</body>
</html>
