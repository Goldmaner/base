<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Adicionar An√°lises de Presta√ß√£o de Contas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    body { background-color: #f8f9fa; }
    .analise-card { margin-bottom: 20px; border-left: 4px solid #28a745; }
    .form-check-inline { margin-right: 15px; }
    .termo-option { 
      padding: 10px; 
      margin: 5px 0; 
      border: 1px solid #ddd; 
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .termo-option:hover {
      background-color: #e9ecef;
    }
    .termo-option input[type="radio"] {
      margin-right: 10px;
    }
    #prestacoesContainer {
      display: none;
    }
    .loading {
      text-align: center;
      padding: 20px;
    }
    /* Estilos para modal de revis√£o */
    #modalRevisaoTodos .card {
      transition: border-left 0.3s ease;
    }
    #modalRevisaoTodos .table-sm th,
    #modalRevisaoTodos .table-sm td {
      padding: 0.5rem;
      font-size: 0.9rem;
    }
    #revisaoTermosContainer {
      max-height: 500px;
      overflow-y: auto;
    }
    .termo-checkbox {
      transform: scale(1.2);
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <!-- Cabe√ßalho -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2><i class="bi bi-plus-circle"></i> Adicionar An√°lises de Presta√ß√£o de Contas</h2>
        <p class="text-muted">Selecione um termo para gerar automaticamente as presta√ß√µes de contas</p>
      </div>
      <a href="{{ url_for('analises.listar') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Voltar
      </a>
    </div>

    {% if termos_pendentes %}
    <!-- Sele√ß√£o de Termo -->
    <div class="card mb-4">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> Termos Pendentes de An√°lise</h5>
      </div>
      <div class="card-body">
        <p class="mb-3">Selecione o termo para o qual deseja criar as presta√ß√µes de contas:</p>
        
        <!-- Checkbox para mostrar ACP/TCC/TCP -->
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="mostrarAcpTcc">
          <label class="form-check-label" for="mostrarAcpTcc">
            <strong>Mostrar ACP, TCC e TCP?</strong>
            <small class="text-muted">(Por padr√£o, estes tipos de termo ficam ocultos)</small>
          </label>
        </div>
        
        <div id="termosContainer">
          {% for termo in termos_pendentes %}
          <div class="termo-option" data-tipo-termo="{{ 'acp-tcc' if 'ACP' in termo.numero_termo.upper() or 'TCC' in termo.numero_termo.upper() or 'TCP' in termo.numero_termo.upper() else 'normal' }}">
            <input type="radio" 
                   name="termo_selecionado" 
                   id="termo_{{ loop.index }}" 
                   value="{{ termo.numero_termo }}"
                   data-inicio="{{ termo.inicio }}"
                   data-termino="{{ termo.final }}"
                   data-portaria="{{ termo.portaria or '' }}">
            <label for="termo_{{ loop.index }}" style="cursor: pointer; width: 100%;">
              <strong>{{ termo.numero_termo }}</strong>
              {% if termo.data_rescisao %}
                <span class="badge bg-danger ms-2" title="Termo rescindido em {{ termo.data_rescisao.strftime('%d/%m/%Y') }}">
                  üî¥ RESCINDIDO
                </span>
              {% endif %}
              <br>
              <small class="text-muted">
                Per√≠odo: {{ termo.inicio.strftime('%d/%m/%Y') if termo.inicio else 'N/A' }} 
                at√© 
                {% if termo.data_rescisao %}
                  <strong class="text-danger">{{ termo.data_rescisao.strftime('%d/%m/%Y') }}</strong>
                  <span class="text-danger" title="Data de rescis√£o - as presta√ß√µes ser√£o calculadas at√© esta data">(rescindido)</span>
                  <span class="text-muted" style="text-decoration: line-through;">{{ termo.final.strftime('%d/%m/%Y') if termo.final else 'N/A' }}</span>
                {% else %}
                  {{ termo.final.strftime('%d/%m/%Y') if termo.final else 'N/A' }}
                {% endif %}
                {% if termo.portaria %}| Portaria: {{ termo.portaria }}{% endif %}
              </small>
            </label>
          </div>
          {% endfor %}
        </div>

        <div class="mt-3">
          <button type="button" class="btn btn-primary btn-lg" id="btnGerarPrestacoes">
            <i class="bi bi-calculator me-2"></i>Gerar Presta√ß√µes (Termo Selecionado)
          </button>
          <button type="button" class="btn btn-success btn-lg ms-2" id="btnGerarTodos">
            <i class="bi bi-lightning-charge me-2"></i>Gerar Todos os Termos Pendentes
          </button>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div id="loadingContainer" class="loading" style="display: none;">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Calculando...</span>
      </div>
      <p class="mt-2">Calculando presta√ß√µes de contas...</p>
    </div>

    <!-- Formul√°rio de Presta√ß√µes (gerado dinamicamente) -->
    <div id="prestacoesContainer">
      <div class="card mb-4">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="bi bi-list-check"></i> Presta√ß√µes de Contas Geradas
          </h5>
          <small id="termoSelecionadoDisplay"></small>
        </div>
        <div class="card-body">
          <p class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            As presta√ß√µes foram calculadas automaticamente. Revise as informa√ß√µes e preencha os campos necess√°rios.
          </p>
          
          <!-- Bot√£o de a√ß√£o r√°pida -->
          <div class="mb-3">
            <button type="button" class="btn btn-warning" id="btnMarcarEncerradoAdd">
              <i class="bi bi-check-all me-2"></i>Marcar Tudo como Encerrado
            </button>
            <small class="text-muted ms-3">
              Marca: Notifica√ß√£o, Parecer, Fase Recursal, Encerramento e zera valores de devolu√ß√£o
            </small>
          </div>

          <form id="formAdicionarAnalises">
            <input type="hidden" id="numeroTermoHidden" name="numero_termo">
            <div id="prestacoesListContainer"></div>

            <!-- Bot√µes de a√ß√£o -->
            <div class="mt-4 text-end">
              <button type="button" class="btn btn-secondary btn-lg" id="btnCancelar">
                <i class="bi bi-x-circle me-2"></i>Cancelar
              </button>
              <button type="submit" class="btn btn-success btn-lg">
                <i class="bi bi-check-circle me-2"></i>Salvar Todas as Presta√ß√µes
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    {% else %}
    <!-- Mensagem quando n√£o h√° termos pendentes -->
    <div class="alert alert-info">
      <h4><i class="bi bi-info-circle me-2"></i>Nenhum Termo Pendente</h4>
      <p>Todos os termos cadastrados j√° possuem an√°lises de presta√ß√£o de contas registradas.</p>
      <a href="{{ url_for('analises.listar') }}" class="btn btn-primary mt-2">
        <i class="bi bi-arrow-left me-2"></i>Voltar para An√°lises
      </a>
    </div>
    {% endif %}

  </div>

  <!-- Modal de Revis√£o - M√∫ltiplos Termos -->
  <div class="modal fade" id="modalRevisaoTodos" tabindex="-1" aria-labelledby="modalRevisaoLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="modalRevisaoLabel">
            <i class="bi bi-check2-square me-2"></i>Revis√£o - Adicionar Todos os Termos Pendentes
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info mb-3">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Revis√£o Final:</strong> Revise as presta√ß√µes geradas para cada termo. 
            Desmarque os termos que N√ÉO deseja adicionar. Marque/desmarque campos conforme necess√°rio.
          </div>
          
          <!-- A√ß√µes em massa -->
          <div class="mb-3 p-3 bg-light border rounded">
            <h6>A√ß√µes em Massa:</h6>
            <button type="button" class="btn btn-sm btn-outline-primary" id="btnSelecionarTodos">
              <i class="bi bi-check-all"></i> Selecionar Todos
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnDeselecionarTodos">
              <i class="bi bi-x"></i> Desselecionar Todos
            </button>
            <button type="button" class="btn btn-sm btn-outline-warning" id="btnMarcarEncerradoTodos">
              <i class="bi bi-check-circle"></i> Marcar Todos como Encerrado
            </button>
          </div>
          
          <!-- Container de termos -->
          <div id="revisaoTermosContainer"></div>
          
          <!-- Resumo -->
          <div class="alert alert-secondary mt-3">
            <strong>Resumo:</strong>
            <span id="resumoTermosSelecionados">0 termos selecionados</span>, 
            <span id="resumoPrestacoes">0 presta√ß√µes no total</span>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle"></i> Cancelar
          </button>
          <button type="button" class="btn btn-success" id="btnSalvarTodos">
            <i class="bi bi-check-circle"></i> Salvar Termos Selecionados
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let prestacoesGeradas = [];
    let todosTermosData = []; // Armazena dados de todos os termos
    const analistasData = {{ analistas | tojson }};

    // Filtrar termos ACP/TCC
    document.getElementById('mostrarAcpTcc')?.addEventListener('change', function() {
      const mostrar = this.checked;
      const termosAcpTcc = document.querySelectorAll('[data-tipo-termo="acp-tcc"]');
      
      termosAcpTcc.forEach(termo => {
        termo.style.display = mostrar ? 'block' : 'none';
      });
    });

    // Inicializar: ocultar ACP/TCC por padr√£o
    document.addEventListener('DOMContentLoaded', function() {
      const termosAcpTcc = document.querySelectorAll('[data-tipo-termo="acp-tcc"]');
      termosAcpTcc.forEach(termo => {
        termo.style.display = 'none';
      });
    });

    // Gerar TODOS os termos pendentes
    document.getElementById('btnGerarTodos')?.addEventListener('click', async function() {
      const todosTermos = Array.from(document.querySelectorAll('input[name="termo_selecionado"]'))
        .filter(radio => {
          // Filtrar apenas termos vis√≠veis (n√£o-ACP/TCC se checkbox desmarcado)
          const termoOption = radio.closest('.termo-option');
          return termoOption && termoOption.style.display !== 'none';
        })
        .map(radio => ({
          numero_termo: radio.value,
          inicio: radio.dataset.inicio,
          termino: radio.dataset.termino,
          portaria: radio.dataset.portaria
        }));
      
      if (todosTermos.length === 0) {
        alert('Nenhum termo vis√≠vel para processar.');
        return;
      }
      
      if (!confirm(`Voc√™ est√° prestes a gerar presta√ß√µes para ${todosTermos.length} termo(s). Continuar?`)) {
        return;
      }
      
      // Mostrar loading
      document.getElementById('loadingContainer').style.display = 'block';
      document.getElementById('loadingContainer').querySelector('p').textContent = 
        `Processando ${todosTermos.length} termo(s)...`;
      document.querySelector('.card').style.display = 'none';
      
      try {
        // Processar todos os termos em sequ√™ncia
        todosTermosData = [];
        
        for (const [index, termo] of todosTermos.entries()) {
          document.getElementById('loadingContainer').querySelector('p').textContent = 
            `Processando termo ${index + 1} de ${todosTermos.length}: ${termo.numero_termo}...`;
          
          const response = await fetch('/analises/api/calcular-prestacoes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ numero_termo: termo.numero_termo })
          });
          
          const result = await response.json();
          
          if (response.ok) {
            todosTermosData.push({
              numero_termo: termo.numero_termo,
              prestacoes: result.prestacoes,
              rescindido: result.rescindido,
              aviso: result.aviso,
              selecionado: true // Por padr√£o, todos v√™m selecionados
            });
          } else {
            console.error(`Erro ao processar ${termo.numero_termo}:`, result.erro);
            todosTermosData.push({
              numero_termo: termo.numero_termo,
              prestacoes: [],
              erro: result.erro,
              selecionado: false
            });
          }
        }
        
        // Esconder loading
        document.getElementById('loadingContainer').style.display = 'none';
        
        // Renderizar modal de revis√£o
        renderizarModalRevisao();
        
        // Abrir modal
        const modal = new bootstrap.Modal(document.getElementById('modalRevisaoTodos'));
        modal.show();
        
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao processar termos: ' + error.message);
        document.getElementById('loadingContainer').style.display = 'none';
        document.querySelector('.card').style.display = 'block';
      }
    });
    
    // Gerar presta√ß√µes ao clicar no bot√£o (termo individual)
    document.getElementById('btnGerarPrestacoes')?.addEventListener('click', async function() {
      const termoSelecionado = document.querySelector('input[name="termo_selecionado"]:checked');
      
      if (!termoSelecionado) {
        alert('Por favor, selecione um termo antes de gerar as presta√ß√µes.');
        return;
      }

      const numeroTermo = termoSelecionado.value;
      
      // Mostrar loading
      document.getElementById('loadingContainer').style.display = 'block';
      document.getElementById('termosContainer').style.display = 'none';
      document.querySelector('#btnGerarPrestacoes').disabled = true;

      try {
        const response = await fetch('/analises/api/calcular-prestacoes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ numero_termo: numeroTermo })
        });

        const result = await response.json();

        if (response.ok) {
          prestacoesGeradas = result.prestacoes;
          renderizarPrestacoes(numeroTermo, prestacoesGeradas, result.rescindido, result.aviso);
          
          // Esconder loading e sele√ß√£o de termos
          document.getElementById('loadingContainer').style.display = 'none';
          document.querySelector('.card').style.display = 'none';
          document.getElementById('prestacoesContainer').style.display = 'block';
        } else {
          alert('Erro ao calcular presta√ß√µes: ' + result.erro);
          document.getElementById('loadingContainer').style.display = 'none';
          document.getElementById('termosContainer').style.display = 'block';
          document.querySelector('#btnGerarPrestacoes').disabled = false;
        }
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao calcular presta√ß√µes: ' + error.message);
        document.getElementById('loadingContainer').style.display = 'none';
        document.getElementById('termosContainer').style.display = 'block';
        document.querySelector('#btnGerarPrestacoes').disabled = false;
      }
    });

    // Renderizar presta√ß√µes no formul√°rio
    function renderizarPrestacoes(numeroTermo, prestacoes, rescindido, aviso) {
      document.getElementById('numeroTermoHidden').value = numeroTermo;
      
      // Adicionar badge de rescindido no display do termo
      let termoDisplay = `Termo: ${numeroTermo} - ${prestacoes.length} presta√ß√£o(√µes) gerada(s)`;
      if (rescindido) {
        termoDisplay += ' <span class="badge bg-danger ms-2">üî¥ RESCINDIDO</span>';
      }
      document.getElementById('termoSelecionadoDisplay').innerHTML = termoDisplay;
      
      const container = document.getElementById('prestacoesListContainer');
      container.innerHTML = '';
      
      // Adicionar alerta de rescis√£o se houver
      if (rescindido && aviso) {
        const alertHtml = `
          <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>Aten√ß√£o!</strong> ${aviso}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        `;
        container.innerHTML = alertHtml;
      }

      prestacoes.forEach((prestacao, index) => {
        const idx = index + 1;
        
        const cardHtml = `
          <div class="card analise-card">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">
                Presta√ß√£o ${prestacao.tipo_prestacao} - N√∫mero ${prestacao.numero_prestacao}
              </h5>
              <small>Vig√™ncia: ${formatarData(prestacao.vigencia_inicial)} at√© ${formatarData(prestacao.vigencia_final)}</small>
            </div>
            <div class="card-body">
              <input type="hidden" name="tipo_prestacao_${idx}" value="${prestacao.tipo_prestacao}">
              <input type="hidden" name="numero_prestacao_${idx}" value="${prestacao.numero_prestacao}">
              <input type="hidden" name="vigencia_inicial_${idx}" value="${prestacao.vigencia_inicial}">
              <input type="hidden" name="vigencia_final_${idx}" value="${prestacao.vigencia_final}">
              
              <div class="row g-3">
                <!-- Campos booleanos -->
                <div class="col-md-12">
                  <label class="form-label fw-bold">Status da Presta√ß√£o</label>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="entregue_${idx}" name="entregue_${idx}">
                    <label class="form-check-label" for="entregue_${idx}">Entregue</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="cobrado_${idx}" name="cobrado_${idx}">
                    <label class="form-check-label" for="cobrado_${idx}">Cobrado</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="e_notificacao_${idx}" name="e_notificacao_${idx}">
                    <label class="form-check-label" for="e_notificacao_${idx}">Notifica√ß√£o</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="e_parecer_${idx}" name="e_parecer_${idx}">
                    <label class="form-check-label" for="e_parecer_${idx}">Parecer</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="e_fase_recursal_${idx}" name="e_fase_recursal_${idx}">
                    <label class="form-check-label" for="e_fase_recursal_${idx}">Fase Recursal</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="e_encerramento_${idx}" name="e_encerramento_${idx}">
                    <label class="form-check-label" for="e_encerramento_${idx}">Encerramento</label>
                  </div>
                </div>

                <!-- Datas e valores -->
                <div class="col-md-4">
                  <label for="data_parecer_dp_${idx}" class="form-label">Data Parecer DP</label>
                  <input type="date" class="form-control" id="data_parecer_dp_${idx}" name="data_parecer_dp_${idx}">
                </div>

                <div class="col-md-4">
                  <label for="data_parecer_pg_${idx}" class="form-label">Data Parecer PG</label>
                  <input type="date" class="form-control" id="data_parecer_pg_${idx}" name="data_parecer_pg_${idx}">
                </div>

                <div class="col-md-4">
                  <label for="responsavel_dp_${idx}" class="form-label">Respons√°vel DP</label>
                  <select class="form-control" id="responsavel_dp_${idx}" name="responsavel_dp_${idx}">
                    <option value="">Selecione...</option>
                    ${analistasData.map(a => `<option value="${a.id}">${a.nome_analista}</option>`).join('')}
                  </select>
                </div>

                <div class="col-md-4">
                  <label for="responsavel_pg_${idx}" class="form-label">Respons√°vel PG</label>
                  <input type="text" class="form-control" id="responsavel_pg_${idx}" name="responsavel_pg_${idx}">
                </div>

                <div class="col-md-4">
                  <label for="valor_devolucao_${idx}" class="form-label">Valor Devolu√ß√£o (R$)</label>
                  <input type="number" step="0.01" class="form-control" id="valor_devolucao_${idx}" name="valor_devolucao_${idx}">
                </div>

                <div class="col-md-4">
                  <label for="valor_devolvido_${idx}" class="form-label">Valor Devolvido (R$)</label>
                  <input type="number" step="0.01" class="form-control" id="valor_devolvido_${idx}" name="valor_devolvido_${idx}">
                </div>

                <!-- Observa√ß√µes -->
                <div class="col-md-12">
                  <label for="observacoes_${idx}" class="form-label">Observa√ß√µes</label>
                  <textarea class="form-control" id="observacoes_${idx}" name="observacoes_${idx}" rows="2"></textarea>
                </div>
              </div>
            </div>
          </div>
        `;
        
        container.insertAdjacentHTML('beforeend', cardHtml);
      });
    }

    // Fun√ß√£o auxiliar para formatar data
    function formatarData(dataStr) {
      if (!dataStr) return 'N/A';
      const [ano, mes, dia] = dataStr.split('-');
      return `${dia}/${mes}/${ano}`;
    }

    // Bot√£o "Marcar tudo como encerrado"
    document.addEventListener('click', function(e) {
      if (e.target.id === 'btnMarcarEncerradoAdd' || e.target.closest('#btnMarcarEncerradoAdd')) {
        if (!confirm('Deseja marcar todas as presta√ß√µes como encerradas? Isso ir√° marcar as checkboxes e zerar os valores de devolu√ß√£o.')) {
          return;
        }
        
        const totalPrestacoes = prestacoesGeradas.length;
        
        for (let i = 1; i <= totalPrestacoes; i++) {
          document.getElementById(`e_notificacao_${i}`).checked = true;
          document.getElementById(`e_parecer_${i}`).checked = true;
          document.getElementById(`e_fase_recursal_${i}`).checked = true;
          document.getElementById(`e_encerramento_${i}`).checked = true;
          document.getElementById(`valor_devolucao_${i}`).value = '0.00';
          document.getElementById(`valor_devolvido_${i}`).value = '0.00';
        }
        
        alert('Todas as presta√ß√µes foram marcadas como encerradas com valores zerados!');
      }
    });

    // Bot√£o Cancelar
    document.getElementById('btnCancelar')?.addEventListener('click', function() {
      if (confirm('Deseja cancelar? Todas as presta√ß√µes geradas ser√£o perdidas.')) {
        window.location.href = '/analises';
      }
    });

    // Submit do formul√°rio
    document.getElementById('formAdicionarAnalises')?.addEventListener('submit', async function(e) {
      e.preventDefault();

      if (!confirm('Confirma o salvamento de todas as presta√ß√µes de contas?')) {
        return;
      }

      const numeroTermo = document.getElementById('numeroTermoHidden').value;
      const analises = [];

      prestacoesGeradas.forEach((prestacao, index) => {
        const idx = index + 1;
        
        analises.push({
          tipo_prestacao: prestacao.tipo_prestacao,
          numero_prestacao: prestacao.numero_prestacao,
          vigencia_inicial: prestacao.vigencia_inicial,
          vigencia_final: prestacao.vigencia_final,
          entregue: document.getElementById(`entregue_${idx}`).checked,
          cobrado: document.getElementById(`cobrado_${idx}`).checked,
          e_notificacao: document.getElementById(`e_notificacao_${idx}`).checked,
          e_parecer: document.getElementById(`e_parecer_${idx}`).checked,
          e_fase_recursal: document.getElementById(`e_fase_recursal_${idx}`).checked,
          e_encerramento: document.getElementById(`e_encerramento_${idx}`).checked,
          data_parecer_dp: document.getElementById(`data_parecer_dp_${idx}`).value || null,
          data_parecer_pg: document.getElementById(`data_parecer_pg_${idx}`).value || null,
          responsavel_dp: document.getElementById(`responsavel_dp_${idx}`).value || null,
          responsavel_pg: document.getElementById(`responsavel_pg_${idx}`).value || null,
          valor_devolucao: document.getElementById(`valor_devolucao_${idx}`).value || null,
          valor_devolvido: document.getElementById(`valor_devolvido_${idx}`).value || null,
          observacoes: document.getElementById(`observacoes_${idx}`).value || null
        });
      });

      try {
        const response = await fetch('/analises/adicionar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ numero_termo: numeroTermo, analises })
        });

        const result = await response.json();

        if (response.ok) {
          alert('Presta√ß√µes de contas adicionadas com sucesso!');
          window.location.href = '/analises';
        } else {
          alert('Erro: ' + result.erro);
        }
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao salvar: ' + error.message);
      }
    });
    
    // ============================================
    // FUN√á√ïES PARA M√öLTIPLOS TERMOS
    // ============================================
    
    function renderizarModalRevisao() {
      const container = document.getElementById('revisaoTermosContainer');
      container.innerHTML = '';
      
      todosTermosData.forEach((termoData, termoIndex) => {
        const termoCard = document.createElement('div');
        termoCard.className = 'card mb-3';
        termoCard.style.borderLeft = termoData.selecionado ? '4px solid #28a745' : '4px solid #ccc';
        
        let headerClass = 'bg-primary text-white';
        if (termoData.rescindido) headerClass = 'bg-warning text-dark';
        if (termoData.erro) headerClass = 'bg-danger text-white';
        
        let headerHTML = `
          <div class="card-header ${headerClass}">
            <div class="form-check d-inline-block me-3">
              <input class="form-check-input termo-checkbox" 
                     type="checkbox" 
                     id="termo_check_${termoIndex}" 
                     ${termoData.selecionado ? 'checked' : ''}
                     data-termo-index="${termoIndex}">
              <label class="form-check-label fw-bold" for="termo_check_${termoIndex}">
                ${termoData.numero_termo}
              </label>
            </div>
            ${termoData.rescindido ? '<span class="badge bg-danger ms-2">üî¥ RESCINDIDO</span>' : ''}
            <span class="badge bg-light text-dark ms-2">${termoData.prestacoes.length} presta√ß√£o(√µes)</span>
          </div>
        `;
        
        let bodyHTML = '';
        
        if (termoData.erro) {
          bodyHTML = `
            <div class="card-body">
              <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Erro:</strong> ${termoData.erro}
              </div>
            </div>
          `;
        } else {
          // Aviso de rescis√£o
          if (termoData.rescindido && termoData.aviso) {
            bodyHTML += `
              <div class="alert alert-warning m-3">
                <i class="bi bi-exclamation-triangle me-2"></i>${termoData.aviso}
              </div>
            `;
          }
          
          // Renderizar presta√ß√µes
          bodyHTML += '<div class="card-body"><div class="table-responsive"><table class="table table-sm table-bordered">';
          bodyHTML += `
            <thead class="table-light">
              <tr>
                <th>Presta√ß√£o</th>
                <th>Vig√™ncia</th>
                <th class="text-center">
                  <input type="checkbox" class="form-check-input" 
                         id="check_encerrado_termo_${termoIndex}" 
                         title="Marcar todas como encerrado">
                  Encerrado
                </th>
                <th>Respons√°vel PG</th>
              </tr>
            </thead>
            <tbody>
          `;
          
          termoData.prestacoes.forEach((prestacao, prestIndex) => {
            bodyHTML += `
              <tr>
                <td><strong>${prestacao.tipo_prestacao} - ${prestacao.numero_prestacao}</strong></td>
                <td><small>${formatarData(prestacao.vigencia_inicial)} at√© ${formatarData(prestacao.vigencia_final)}</small></td>
                <td class="text-center">
                  <input type="checkbox" class="form-check-input checkbox-encerrado" 
                         id="encerrado_${termoIndex}_${prestIndex}"
                         data-termo-index="${termoIndex}"
                         data-prest-index="${prestIndex}">
                </td>
                <td>
                  <select class="form-select form-select-sm" 
                          id="responsavel_pg_${termoIndex}_${prestIndex}"
                          data-termo-index="${termoIndex}"
                          data-prest-index="${prestIndex}">
                    <option value="">Selecione...</option>
                    ${analistasData.map(a => `<option value="${a.id}">${a.nome_analista}</option>`).join('')}
                  </select>
                </td>
              </tr>
            `;
          });
          
          bodyHTML += '</tbody></table></div></div>';
        }
        
        termoCard.innerHTML = headerHTML + bodyHTML;
        container.appendChild(termoCard);
      });
      
      atualizarResumo();
      configurarEventosModal();
    }
    
    function configurarEventosModal() {
      // Checkbox de sele√ß√£o de termo
      document.querySelectorAll('.termo-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const termoIndex = parseInt(this.dataset.termoIndex);
          todosTermosData[termoIndex].selecionado = this.checked;
          
          // Atualizar borda do card
          const card = this.closest('.card');
          card.style.borderLeft = this.checked ? '4px solid #28a745' : '4px solid #ccc';
          
          atualizarResumo();
        });
      });
      
      // Checkbox "Marcar todas como encerrado" por termo
      todosTermosData.forEach((termoData, termoIndex) => {
        const checkTermo = document.getElementById(`check_encerrado_termo_${termoIndex}`);
        if (checkTermo) {
          checkTermo.addEventListener('change', function() {
            const marcado = this.checked;
            termoData.prestacoes.forEach((prest, prestIndex) => {
              const checkPrest = document.getElementById(`encerrado_${termoIndex}_${prestIndex}`);
              if (checkPrest) {
                checkPrest.checked = marcado;
                aplicarEncerramento(termoIndex, prestIndex, marcado);
              }
            });
          });
        }
      });
      
      // Checkbox individual de encerramento
      document.querySelectorAll('.checkbox-encerrado').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const termoIndex = parseInt(this.dataset.termoIndex);
          const prestIndex = parseInt(this.dataset.prestIndex);
          aplicarEncerramento(termoIndex, prestIndex, this.checked);
        });
      });
    }
    
    function aplicarEncerramento(termoIndex, prestIndex, encerrado) {
      const prestacao = todosTermosData[termoIndex].prestacoes[prestIndex];
      if (encerrado) {
        prestacao.e_notificacao = true;
        prestacao.e_parecer = true;
        prestacao.e_fase_recursal = true;
        prestacao.e_encerramento = true;
        prestacao.valor_devolucao = 0;
        prestacao.valor_devolvido = 0;
      } else {
        prestacao.e_notificacao = false;
        prestacao.e_parecer = false;
        prestacao.e_fase_recursal = false;
        prestacao.e_encerramento = false;
      }
    }
    
    function atualizarResumo() {
      const termosSelecionados = todosTermosData.filter(t => t.selecionado && !t.erro);
      const totalPrestacoes = termosSelecionados.reduce((sum, t) => sum + t.prestacoes.length, 0);
      
      document.getElementById('resumoTermosSelecionados').textContent = 
        `${termosSelecionados.length} termo(s) selecionado(s)`;
      document.getElementById('resumoPrestacoes').textContent = 
        `${totalPrestacoes} presta√ß√£o(√µes) no total`;
    }
    
    // Bot√µes de a√ß√£o em massa
    document.getElementById('btnSelecionarTodos')?.addEventListener('click', function() {
      document.querySelectorAll('.termo-checkbox').forEach(cb => {
        if (!cb.disabled) {
          cb.checked = true;
          cb.dispatchEvent(new Event('change'));
        }
      });
    });
    
    document.getElementById('btnDeselecionarTodos')?.addEventListener('click', function() {
      document.querySelectorAll('.termo-checkbox').forEach(cb => {
        cb.checked = false;
        cb.dispatchEvent(new Event('change'));
      });
    });
    
    document.getElementById('btnMarcarEncerradoTodos')?.addEventListener('click', function() {
      if (!confirm('Marcar TODAS as presta√ß√µes de TODOS os termos como encerrado?')) return;
      
      todosTermosData.forEach((termoData, termoIndex) => {
        if (termoData.selecionado && !termoData.erro) {
          termoData.prestacoes.forEach((prest, prestIndex) => {
            const check = document.getElementById(`encerrado_${termoIndex}_${prestIndex}`);
            if (check) {
              check.checked = true;
              aplicarEncerramento(termoIndex, prestIndex, true);
            }
          });
        }
      });
      
      alert('Todas as presta√ß√µes marcadas como encerrado!');
    });
    
    // Salvar todos os termos selecionados
    document.getElementById('btnSalvarTodos')?.addEventListener('click', async function() {
      const termosSelecionados = todosTermosData.filter(t => t.selecionado && !t.erro);
      
      if (termosSelecionados.length === 0) {
        alert('Nenhum termo selecionado para salvar!');
        return;
      }
      
      const totalPrestacoes = termosSelecionados.reduce((sum, t) => sum + t.prestacoes.length, 0);
      
      if (!confirm(`Confirma o salvamento de ${termosSelecionados.length} termo(s) com ${totalPrestacoes} presta√ß√£o(√µes)?`)) {
        return;
      }
      
      // Preparar dados
      const termosParaSalvar = termosSelecionados.map((termoData, termoIndex) => {
        // Encontrar termoIndex original em todosTermosData
        const indexOriginal = todosTermosData.indexOf(termoData);
        
        const analises = termoData.prestacoes.map((prestacao, prestIndex) => {
          const responsavelPgSelect = document.getElementById(`responsavel_pg_${indexOriginal}_${prestIndex}`);
          const responsavel_pg = responsavelPgSelect ? responsavelPgSelect.value : null;
          
          return {
            tipo_prestacao: prestacao.tipo_prestacao,
            numero_prestacao: prestacao.numero_prestacao,
            vigencia_inicial: prestacao.vigencia_inicial,
            vigencia_final: prestacao.vigencia_final,
            entregue: prestacao.entregue || false,
            cobrado: prestacao.cobrado || false,
            e_notificacao: prestacao.e_notificacao || false,
            e_parecer: prestacao.e_parecer || false,
            e_fase_recursal: prestacao.e_fase_recursal || false,
            e_encerramento: prestacao.e_encerramento || false,
            data_parecer_dp: null,
            data_parecer_pg: null,
            responsavel_dp: null,
            responsavel_pg: responsavel_pg,
            valor_devolucao: prestacao.valor_devolucao || 0,
            valor_devolvido: prestacao.valor_devolvido || 0,
            observacoes: null
          };
        });
        
        return {
          numero_termo: termoData.numero_termo,
          analises: analises
        };
      });
      
      try {
        this.disabled = true;
        this.innerHTML = '<span class=\"spinner-border spinner-border-sm me-2\"></span>Salvando...';
        
        const response = await fetch('/analises/api/adicionar-multiplos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ termos: termosParaSalvar })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert(`Sucesso! ${result.termos_salvos} termo(s) com ${result.prestacoes_salvas} presta√ß√£o(√µes) adicionadas!`);
          window.location.href = '/analises';
        } else {
          alert('Erro: ' + result.erro);
          this.disabled = false;
          this.innerHTML = '<i class=\"bi bi-check-circle\"></i> Salvar Termos Selecionados';
        }
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao salvar: ' + error.message);
        this.disabled = false;
        this.innerHTML = '<i class=\"bi bi-check-circle\"></i> Salvar Termos Selecionados';
      }
    });
  </script>
</body>
</html>
