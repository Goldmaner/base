<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultar Encaminhamentos - Gestão Financeira</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- jQuery UI (para autocomplete) -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    
    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px; 
        }
        .main-container { 
            max-width: 1400px;
            margin: 0 auto; 
            background: white; 
            border-radius: 15px; 
            padding: 40px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
        }
        
        .filtro-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .table-responsive {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .table thead th {
            position: sticky;
            top: 0;
            background: #17a2b8;
            color: white;
            z-index: 10;
            text-align: center;
            font-size: 0.9rem;
            padding: 12px 8px;
        }
        
        .table tbody td {
            vertical-align: middle;
            padding: 10px;
        }
        
        .btn-visualizar {
            background-color: #28a745;
            color: white;
            border: none;
        }
        
        .btn-visualizar:hover {
            background-color: #218838;
            color: white;
        }
        
        /* Modal de visualização */
        .modal-xl {
            max-width: 95%;
            width: 95%;
        }
        
        #conteudoEncHTML {
            border: 2px solid #dee2e6;
            padding: 30px;
            background: #fff;
            border-radius: 8px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        /* Classes CSS do SEI para formatação de documentos */
        #conteudoEncHTML p.Centralizado_Timbre,
        p.Centralizado_Timbre {font-size:18pt;font-family:Calibri;text-align:center;word-wrap:normal;margin:1pt;}
        #conteudoEncHTML p.Titulo_Centralizado,
        p.Titulo_Centralizado {font-size:18pt;font-family:Calibri;text-align:center;font-weight:bold;word-wrap:normal;margin:1pt;}
        #conteudoEncHTML p.Texto_Justificado,
        p.Texto_Justificado {font-size:12pt;font-family:Calibri;text-align:justify;word-wrap:normal;margin:1pt;}
        #conteudoEncHTML p.Texto_Justificado_Recuo_Primeira_Linha,
        p.Texto_Justificado_Recuo_Primeira_Linha {font-size:12pt;font-family:Calibri;text-align:justify;text-indent:94.4882px;word-wrap:normal;margin:1pt;}
        #conteudoEncHTML p.Texto_Alinhado_Esquerda,
        p.Texto_Alinhado_Esquerda {font-size:12pt;font-family:Calibri;word-wrap:normal;margin:1pt;}
        #conteudoEncHTML p.Texto_Centralizado,
        p.Texto_Centralizado {font-size:12pt;font-family:Calibri;text-align:center;word-wrap:normal;margin:1pt;}
        
        #conteudoEncHTML table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }
        
        #conteudoEncHTML table td,
        #conteudoEncHTML table th {
            border: 1px solid #000;
            padding: 8px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Cabeçalho -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-0">
                    <i class="bi bi-file-earmark-text me-2"></i>Consultar Encaminhamentos de Pagamento
                </h2>
                <p class="text-muted mb-0">Histórico de encaminhamentos gerados no sistema</p>
            </div>
            <div>
                <a href="/gestao_financeira/ultra-liquidacoes" class="btn btn-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Voltar
                </a>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filtro-card">
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label fw-bold">
                        <i class="bi bi-search me-2"></i>Filtrar por Termo:
                    </label>
                    <input type="text" class="form-control" id="filtroTermo" 
                           placeholder="Digite o número do termo (ex: TCL/004/2024)...">
                </div>
                <div class="col-md-6 d-flex align-items-end gap-2">
                    <button class="btn btn-primary" onclick="buscarEncaminhamentos()">
                        <i class="bi bi-search me-2"></i>Buscar
                    </button>
                    <button class="btn btn-secondary" onclick="limparFiltro()">
                        <i class="bi bi-x-circle me-2"></i>Limpar
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div class="text-center py-5" id="loading" style="display: none;">
            <div class="spinner-border text-info"></div>
            <p class="mt-2">Carregando encaminhamentos...</p>
        </div>

        <!-- Tabela de Encaminhamentos -->
        <div class="table-responsive">
            <table class="table table-hover table-bordered">
                <thead>
                    <tr>
                        <th style="width: 15%;">Nº Termo</th>
                        <th style="width: 12%;">Gerado Por</th>
                        <th style="width: 12%;">Gerado Em</th>
                        <th style="width: 12%;">Nº SEI</th>
                        <th style="width: 39%;">Parcelas</th>
                        <th style="width: 10%;" class="text-center">Ação</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela">
                    <tr>
                        <td colspan="6" class="text-center text-muted py-5">
                            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                            <p class="mt-2">Nenhum encaminhamento encontrado</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Total de registros -->
        <div class="mt-3 text-muted">
            <strong>Total:</strong> <span id="totalRegistros">0</span> encaminhamento(s) encontrado(s)
        </div>
    </div>

    <!-- Modal Visualizar HTML do Encaminhamento -->
    <div class="modal fade" id="modalVisualizarHTML" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-eye me-2"></i>Encaminhamento de Pagamento
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="conteudoEncHTML"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="copiarHTML()">
                        <i class="bi bi-clipboard me-2"></i>Copiar
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function() {
            carregarTermosAutocomplete();
            buscarEncaminhamentos();

            // Enter no campo de filtro
            $('#filtroTermo').on('keypress', function(e) {
                if (e.which === 13) {
                    buscarEncaminhamentos();
                }
            });
        });

        // Carregar lista de termos para autocomplete
        function carregarTermosAutocomplete() {
            $.ajax({
                url: '/gestao_financeira/ultra-liquidacoes/api/encaminhamentos-termos',
                method: 'GET',
                success: function(data) {
                    const termosUnicos = data.termos || [];
                    
                    $('#filtroTermo').autocomplete({
                        source: termosUnicos,
                        minLength: 2
                    });
                },
                error: function(xhr) {
                    console.error('Erro ao carregar termos:', xhr.responseText);
                }
            });
        }

        // Buscar encaminhamentos
        function buscarEncaminhamentos() {
            $('#loading').show();
            $('#corpoTabela').empty();

            const filtroTermo = $('#filtroTermo').val().trim();

            $.ajax({
                url: '/gestao_financeira/ultra-liquidacoes/api/encaminhamentos',
                method: 'GET',
                data: { numero_termo: filtroTermo },
                success: function(data) {
                    $('#loading').hide();
                    renderizarTabela(data.encaminhamentos || []);
                    $('#totalRegistros').text(data.total || 0);
                },
                error: function(xhr) {
                    $('#loading').hide();
                    alert('Erro ao buscar encaminhamentos: ' + xhr.responseText);
                }
            });
        }

        // Renderizar tabela de encaminhamentos
        function renderizarTabela(encaminhamentos) {
            const tbody = $('#corpoTabela');
            tbody.empty();

            if (encaminhamentos.length === 0) {
                tbody.append(`
                    <tr>
                        <td colspan="6" class="text-center text-muted py-5">
                            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                            <p class="mt-2">Nenhum encaminhamento encontrado</p>
                        </td>
                    </tr>
                `);
                return;
            }

            encaminhamentos.forEach(function(enc) {
                const tr = $('<tr>');
                
                // Nº Termo
                tr.append($('<td>').html(`<strong>${enc.numero_termo || '-'}</strong>`));
                
                // Gerado Por
                tr.append($('<td>').text(enc.created_por || '-'));
                
                // Gerado Em (formatar data/hora)
                const dataFormatada = enc.created_em ? 
                    new Date(enc.created_em).toLocaleString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '-';
                tr.append($('<td>').text(dataFormatada));
                
                // Nº SEI
                tr.append($('<td>').html(`<span class="badge bg-info">${enc.numero_sei || '-'}</span>`));
                
                // Parcelas
                const parcelas = enc.parcela_numero || '-';
                tr.append($('<td>').html(`<small class="text-muted">${parcelas}</small>`));
                
                // Ação
                const tdAcao = $('<td>').addClass('text-center');
                const btnVisualizar = $('<button>')
                    .addClass('btn btn-sm btn-visualizar')
                    .html('<i class="bi bi-eye me-1"></i>Visualizar')
                    .on('click', function() {
                        visualizarHTML(enc.id, enc.enc_pagamento_completo);
                    });
                tdAcao.append(btnVisualizar);
                tr.append(tdAcao);
                
                tbody.append(tr);
            });
        }

        // Limpar filtro
        function limparFiltro() {
            $('#filtroTermo').val('');
            buscarEncaminhamentos();
        }

        // Visualizar HTML do encaminhamento
        function visualizarHTML(id, html) {
            $('#conteudoEncHTML').html(html);
            $('#modalVisualizarHTML').modal('show');
        }

        // Copiar HTML do encaminhamento
        function copiarHTML() {
            const conteudo = document.getElementById('conteudoEncHTML');
            
            const range = document.createRange();
            range.selectNodeContents(conteudo);
            
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            try {
                document.execCommand('copy');
                
                const btn = event.target.closest('button');
                const textoOriginal = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Copiado!';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-primary');
                
                setTimeout(() => {
                    btn.innerHTML = textoOriginal;
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-success');
                }, 2000);
                
            } catch (err) {
                alert('Erro ao copiar. Use Ctrl+C manualmente.');
            }
            
            selection.removeAllRanges();
        }
    </script>
</body>
</html>
