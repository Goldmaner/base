<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultra Liquidações - Gestão Financeira</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- jQuery UI (para autocomplete) -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    
    <style>
    body {
        background: #f5f5f5;
        min-height: 100vh;
        padding: 20px;
    }
    .main-container {
        max-width: 98%;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    /* Tabs de seção */
    .secao-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #dee2e6;
    }
    .secao-tab {
        padding: 12px 24px;
        background: #f8f9fa;
        border: none;
        border-radius: 8px 8px 0 0;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }
    .secao-tab:hover {
        background: #e9ecef;
    }
    .secao-tab.active {
        background: white;
        border-bottom: 3px solid #198754;
        color: #198754;
    }
    
    /* Filtros colapsáveis */
    .filtros-container {
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 20px;
        overflow: hidden;
    }
    .filtros-header {
        padding: 15px 20px;
        background: #e9ecef;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
    }
    .filtros-header:hover {
        background: #dee2e6;
    }
    .filtros-body {
        padding: 20px;
        display: none;
    }
    .filtros-body.show {
        display: block;
    }
    
    /* Checkbox colunas expandidas */
    .colunas-expandidas {
        background: #fff3cd;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .colunas-expandidas label {
        margin-right: 20px;
        cursor: pointer;
    }
    
    /* Tabela */
    .table-responsive {
        max-height: 75vh;
        overflow: auto;
    }
    .table thead th {
        position: sticky;
        top: 0;
        background: #198754;
        color: white;
        z-index: 10;
        text-align: center;
        font-size: 0.9rem;
        padding: 12px 8px;
    }
    .table tbody td {
        vertical-align: middle;
        padding: 8px;
        font-size: 0.85rem;
    }
    
    /* Valores moeda */
    .valor-moeda {
        text-align: right;
        font-weight: 600;
        color: #198754;
    }
    
    /* Linha com pendência */
    .table tbody tr.linha-pendencia {
        background-color: #fff3cd !important;
    }
    .table tbody tr.linha-pendencia:hover {
        background-color: #ffe69c !important;
    }
    .table tbody tr.linha-pendencia td {
        background-color: inherit !important;
    }
    
    /* Linha necessita pagamento (verde claro) */
    .table tbody tr.linha-necessita-pagamento {
        background-color: #d1f2d1 !important;
    }
    .table tbody tr.linha-necessita-pagamento:hover {
        background-color: #b8e6b8 !important;
    }
    .table tbody tr.linha-necessita-pagamento td {
        background-color: inherit !important;
    }
    
    /* Linha com empenho disponível (verde escuro) */
    .table tbody tr.linha-empenho-disponivel {
        background-color: #5cb85c !important;
        color: white !important;
    }
    .table tbody tr.linha-empenho-disponivel:hover {
        background-color: #4cae4c !important;
    }
    .table tbody tr.linha-empenho-disponivel td {
        background-color: inherit !important;
        color: inherit !important;
    }
    
    /* Badge de pendências nas tabs */
    .badge-pendencias {
        background-color: #ffc107;
        color: #000;
        font-size: 0.75rem;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 8px;
    }
    
    .badge-necessita-pagamento {
        background-color: #28a745;
        color: #fff;
        font-size: 0.75rem;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 8px;
    }
    
    /* Tabs de Edição */
    #tabsEdicao .nav-link {
        color: #666;
        border: 1px solid transparent;
        border-radius: 8px 8px 0 0;
        padding: 12px 20px;
        font-weight: 500;
        transition: all 0.3s;
    }
    #tabsEdicao .nav-link:hover {
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }
    #tabsEdicao .nav-link.active {
        color: #198754;
        background-color: #fff;
        border-color: #dee2e6 #dee2e6 #fff;
        font-weight: 600;
    }
    #tabsEdicaoContent {
        border-top: 1px solid #dee2e6;
        padding-top: 20px;
    }
    
    /* Validação de campos */
    .campo-erro {
        background-color: #fff5f5 !important;
        border-color: #e53e3e !important;
    }
    .campo-aviso {
        background-color: #fffbeb !important;
        border-color: #f59e0b !important;
    }
    
    /* Paginação */
    .paginacao {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
    }
    .paginacao-simples {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .btn-pagina {
        padding: 8px 12px;
        border: 1px solid #dee2e6;
        background: white;
        cursor: pointer;
        border-radius: 4px;
    }
    .btn-pagina:hover:not(:disabled) {
        background: #f8f9fa;
    }
    .btn-pagina:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .btn-pagina.active {
        background: #198754;
        color: white;
        border-color: #198754;
    }
    
    /* Botões de ação */
    .btn-acao {
        padding: 4px 8px;
        font-size: 0.85rem;
        margin: 0 2px;
    }
    
    /* Modal */
    .modal-xl {
        max-width: 95%;
        width: 95%;
    }
    
    /* Subtotal */
    .linha-subtotal {
        background-color: #e9ecef;
        font-weight: bold;
        border-top: 3px solid #198754;
    }
    .linha-subtotal td {
        background-color: #e9ecef !important;
        padding: 12px 8px;
    }
    
    /* Tooltip info */
    .info-icon {
        cursor: help;
        color: #0dcaf0;
        margin-left: 5px;
    }
</style>
</head>
<body>

<div class="main-container">
    <!-- Cabeçalho -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="bi bi-cash-coin me-2"></i>Ultra Liquidações
        </h2>
        <div class="d-flex gap-2">
            <div class="btn-group">
                <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="bi bi-download me-2"></i>Exportar CSV
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="exportarCSV('tudo')">Exportar TUDO</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportarCSV('secao')">Exportar Seção Atual</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportarCSV('filtrado')">Exportar com Filtros</a></li>
                </ul>
            </div>
            <button type="button" class="btn btn-primary" onclick="abrirModalAdicionarParcelas()">
                <i class="bi bi-plus-circle me-2"></i>Adicionar Parcelas
            </button>
            <a href="/gestao_financeira/ultra-liquidacoes/consultar-encaminhamentos" class="btn btn-info">
                <i class="bi bi-file-earmark-text me-2"></i>Consultar Encaminhamentos
            </a>
            <div class="btn-group">
                <button type="button" class="btn btn-warning dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-bug me-2"></i>DEBUG
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="debugValidacaoTermo()">Validar Termo</a></li>
                    <li><a class="dropdown-item" href="#" onclick="debugRelatorioCompleto()">Relatório Completo</a></li>
                </ul>
            </div>
            <a href="{{ url_for('gestao_financeira.index') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left me-2"></i>Voltar
            </a>
        </div>
    </div>
    
    <!-- Tabs de Seção -->
    <div class="secao-tabs">
        <button class="secao-tab active" data-secao="nao_pago" onclick="trocarSecao('nao_pago')">
            <i class="bi bi-x-circle me-2"></i>Não Pago
            <span class="badge-pendencias" id="badge-nao-pago" style="display: none;">0</span>
            <span class="badge-necessita-pagamento" id="badge-verde-nao-pago" style="display: none;">0</span>
        </button>
        <button class="secao-tab" data-secao="encaminhado" onclick="trocarSecao('encaminhado')">
            <i class="bi bi-arrow-right-circle me-2"></i>Encaminhado para Pagamento
            <span class="badge-pendencias" id="badge-encaminhado" style="display: none;">0</span>
            <span class="badge-necessita-pagamento" id="badge-verde-encaminhado" style="display: none;">0</span>
        </button>
        <button class="secao-tab" data-secao="pago" onclick="trocarSecao('pago')">
            <i class="bi bi-check-circle me-2"></i>Pago
            <span class="badge-pendencias" id="badge-pago" style="display: none;">0</span>
            <span class="badge-necessita-pagamento" id="badge-verde-pago" style="display: none;">0</span>
        </button>
    </div>
    
    <!-- Colunas Expandidas -->
    <div class="colunas-expandidas">
        <strong><i class="bi bi-eye me-2"></i>Colunas Adicionais:</strong>
        <label><input type="checkbox" id="chk_osc" onchange="atualizarColunas()"> OSC</label>
        <label><input type="checkbox" id="chk_cnpj" onchange="atualizarColunas()"> CNPJ</label>
        <label><input type="checkbox" id="chk_projeto" onchange="atualizarColunas()"> Projeto</label>
        <label><input type="checkbox" id="chk_sei_celeb" onchange="atualizarColunas()"> Processo Celebração</label>
        <label><input type="checkbox" id="chk_sei_pc" onchange="atualizarColunas()"> Processo PGTO/PC</label>
    </div>
    
    <!-- Filtros Colapsáveis -->
    <div class="filtros-container">
        <div class="filtros-header" onclick="toggleFiltros()">
            <span><i class="bi bi-funnel me-2"></i>Filtros Avançados</span>
            <i class="bi bi-chevron-down" id="icone-filtros"></i>
        </div>
        <div class="filtros-body" id="filtros-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Número do Termo</label>
                    <input type="text" class="form-control" id="filtro_numero_termo" list="lista_termos" placeholder="Digite ou selecione...">
                    <datalist id="lista_termos"></datalist>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Tipo de Parcela</label>
                    <select class="form-select" id="filtro_parcela_tipo">
                        <option value="Programada" selected>Programada (padrão)</option>
                        <option value="">Todos</option>
                        {% for tipo in tipos_parcela %}
                        {% if tipo != 'Programada' %}
                        <option value="{{ tipo }}">{{ tipo }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Número da Parcela</label>
                    <input type="text" class="form-control" id="filtro_parcela_numero" placeholder="Digite...">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Tipo de Contrato</label>
                    <input type="text" class="form-control" id="filtro_tipo_termo" list="lista_tipos_termo" placeholder="Digite ou selecione...">
                    <datalist id="lista_tipos_termo"></datalist>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Filtrar por Cor</label>
                    <select class="form-select" id="filtro_tipo_pendencia">
                        <option value="">Todas as Cores</option>
                        <option value="sem_cor">⚪ Sem Cor (Regularizados)</option>
                        <option value="amarelo">🟡 Amarelo (Inconsistências)</option>
                        <option value="verde_claro">🟢 Verde Claro (Necessita Pagamento)</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Data Término - Ano</label>
                    <select class="form-select" id="filtro_ano_termino_termo">
                        <option value="">Todos</option>
                    </select>
                </div>
            </div>
            <div class="row g-3 mt-2">
                <div class="col-md-2">
                    <label class="form-label">Vig. Inicial - Mês</label>
                    <select class="form-select" id="filtro_vig_inicial_mes">
                        <option value="">Todos</option>
                        <option value="01">Janeiro</option>
                        <option value="02">Fevereiro</option>
                        <option value="03">Março</option>
                        <option value="04">Abril</option>
                        <option value="05">Maio</option>
                        <option value="06">Junho</option>
                        <option value="07">Julho</option>
                        <option value="08">Agosto</option>
                        <option value="09">Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <label class="form-label">Ano</label>
                    <select class="form-select" id="filtro_vig_inicial_ano">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Vig. Final - Mês</label>
                    <select class="form-select" id="filtro_vig_final_mes">
                        <option value="">Todos</option>
                        <option value="01">Janeiro</option>
                        <option value="02">Fevereiro</option>
                        <option value="03">Março</option>
                        <option value="04">Abril</option>
                        <option value="05">Maio</option>
                        <option value="06">Junho</option>
                        <option value="07">Julho</option>
                        <option value="08">Agosto</option>
                        <option value="09">Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <label class="form-label">Ano</label>
                    <select class="form-select" id="filtro_vig_final_ano">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Data Pagamento</label>
                    <input type="date" class="form-control" id="filtro_data_pagamento">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Observações</label>
                    <input type="text" class="form-control" id="filtro_observacoes" placeholder="Digite...">
                </div>
            <div class="row mt-3">
                <div class="col-md-12">
                    <label class="form-label fw-bold">Status Secundário</label>
                    <div class="d-flex flex-wrap gap-3">
                        <label><input type="checkbox" class="filtro-status-sec" value="Parcial" checked> Parcial</label>
                        <label><input type="checkbox" class="filtro-status-sec" value="Integral" checked> Integral</label>
                        <label><input type="checkbox" class="filtro-status-sec" value="Glosa" checked> Glosa</label>
                        <label><input type="checkbox" class="filtro-status-sec" value="Falta Certidão" checked> Falta Certidão</label>
                        <label><input type="checkbox" class="filtro-status-sec" value="Falta encarte de Prestações" checked> Falta encarte de Prestações</label>
                        <label><input type="checkbox" class="filtro-status-sec" value="Aguardando Alteração" checked> Aguardando Alteração</label>
                        <label><input type="checkbox" class="filtro-status-sec" value="-" checked> - (vazio)</label>
                        <label><input type="checkbox" class="filtro-status-sec" value="Antigos"> Antigos</label>
                        <label><input type="checkbox" class="filtro-status-sec" value="Rescisão"> Rescisão</label>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-3">
                    <label class="form-label">OSC</label>
                    <input type="text" class="form-control" id="filtro_osc" list="lista_oscs" placeholder="Digite ou selecione...">
                    <datalist id="lista_oscs"></datalist>
                </div>
                <div class="col-md-3">
                    <label class="form-label">CNPJ</label>
                    <input type="text" class="form-control" id="filtro_cnpj" list="lista_cnpjs" placeholder="Digite ou selecione...">
                    <datalist id="lista_cnpjs"></datalist>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Processo Celebração</label>
                    <input type="text" class="form-control" id="filtro_sei_celeb" list="lista_seis_celeb" placeholder="Digite ou selecione...">
                    <datalist id="lista_seis_celeb"></datalist>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Processo PGTO/PC</label>
                    <input type="text" class="form-control" id="filtro_sei_pc" list="lista_seis_pc" placeholder="Digite ou selecione...">
                    <datalist id="lista_seis_pc"></datalist>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <button class="btn btn-primary" onclick="aplicarFiltros()">
                        <i class="bi bi-search me-2"></i>Aplicar Filtros
                    </button>
                    <button class="btn btn-secondary ms-2" onclick="limparFiltros()">
                        <i class="bi bi-x-circle me-2"></i>Limpar Filtros
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Paginação Topo -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <span id="info-registros" class="text-muted"></span>
        </div>
        <div class="paginacao-simples">
            <button class="btn btn-sm btn-outline-secondary" id="btn-anterior-topo" onclick="paginaAnterior()" disabled>
                <i class="bi bi-chevron-left"></i> Anterior
            </button>
            <span class="mx-3" id="info-pagina-topo">Página 1 de 1</span>
            <button class="btn btn-sm btn-outline-secondary" id="btn-proxima-topo" onclick="proximaPagina()" disabled>
                Próxima <i class="bi bi-chevron-right"></i>
            </button>
        </div>
    </div>
    
    <!-- Tabela -->
    <div class="table-responsive">
        <table class="table table-hover table-bordered" id="tabelaParcelas">
            <thead>
                <tr>
                    <th>Vigência Inicial</th>
                    <th>Vigência Final</th>
                    <th>Número do Termo</th>
                    <th>Tipo Parcela</th>
                    <th>Nº Parcela</th>
                    <th>Valor 53/23</th>
                    <th>Valor 53/24</th>
                    <th>Valor Previsto</th>
                    <th>Subtraído / Glosado</th>
                    <th>Encaminhado</th>
                    <th>Pago</th>
                    <th>Status</th>
                    <th>Status Sec.</th>
                    <th>Data Pgto</th>
                    <th>Observações</th>
                    <th class="col-osc" style="display: none;">OSC</th>
                    <th class="col-cnpj" style="display: none;">CNPJ</th>
                    <th class="col-projeto" style="display: none;">Projeto</th>
                    <th class="col-sei-celeb" style="display: none;">Proc. Celeb.</th>
                    <th class="col-sei-pc" style="display: none;">Proc. PGTO/PC</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="corpo-tabela">
                <!-- Preenchido via JavaScript -->
            </tbody>
        </table>
    </div>
    
    <!-- Loading -->
    <div class="text-center py-5" id="loading" style="display: none;">
        <div class="spinner-border text-success"></div>
        <p class="mt-2">Carregando...</p>
    </div>
    
    <!-- Sem dados -->
    <div class="text-center py-5" id="sem-dados" style="display: none;">
        <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
        <p class="mt-3 text-muted">Nenhuma parcela encontrada</p>
    </div>
</div>

<!-- Modal Editar Parcela -->
<div class="modal fade" id="modalEditarParcela" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Editar Parcela(s)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Tabs de Edição -->
                <ul class="nav nav-tabs mb-4" id="tabsEdicao" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-individual" data-bs-toggle="tab" 
                                data-bs-target="#content-individual" type="button" role="tab">
                            <i class="bi bi-file-earmark-text me-2"></i>Edição Individual
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-coletiva" data-bs-toggle="tab" 
                                data-bs-target="#content-coletiva" type="button" role="tab">
                            <i class="bi bi-files me-2"></i>Edição Coletiva (Todas do Termo)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-cronograma-edicao" data-bs-toggle="tab" 
                                data-bs-target="#content-cronograma-edicao" type="button" role="tab">
                            <i class="bi bi-calendar3 me-2"></i>Cronograma Mensal
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="tabsEdicaoContent">
                    <!-- ABA: Edição Individual -->
                    <div class="tab-pane fade show active" id="content-individual" role="tabpanel">
                        <form id="formEditarParcela">
                            <input type="hidden" id="edit_id">
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label fw-bold">Informações da Parceria</label>
                            <div class="alert alert-info">
                                <strong>Termo:</strong> <span id="info_numero_termo"></span><br>
                                <strong>OSC:</strong> <span id="info_osc"></span><br>
                                <strong>CNPJ:</strong> <span id="info_cnpj"></span><br>
                                <strong>Vigência da Parceria:</strong> <span id="info_vigencia_parceria"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Vigência Inicial *</label>
                            <input type="date" class="form-control" id="edit_vigencia_inicial" required>
                            <small class="text-muted">Limitado ao mês de início da parceria</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Vigência Final *</label>
                            <input type="date" class="form-control" id="edit_vigencia_final" required>
                            <small class="text-muted">Limitado ao mês de término da parceria</small>
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Tipo de Parcela</label>
                            <select class="form-select" id="edit_parcela_tipo">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Número da Parcela</label>
                            <input type="text" class="form-control" id="edit_parcela_numero">
                            <small class="text-muted">Edite conforme necessário (ex: Parcial, Complementar)</small>
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Valor Elemento 53/23</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control campo-moeda" id="edit_valor_elemento_53_23" onchange="validarValores()" placeholder="0,00">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Valor Elemento 53/24</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control campo-moeda" id="edit_valor_elemento_53_24" onchange="validarValores()" placeholder="0,00">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Valor Previsto *</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control campo-moeda" id="edit_valor_previsto" required onchange="validarValores()" placeholder="0,00">
                            </div>
                            <small class="text-danger" id="erro_valor_previsto" style="display: none;">
                                ⚠️ Deve ser igual à soma dos elementos 23 + 24
                            </small>
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Valor Subtraído</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control campo-moeda" id="edit_valor_subtraido" onchange="validarValores()" placeholder="0,00">
                            </div>
                            <small class="text-danger" id="erro_valor_subtraido" style="display: none;">
                                ⚠️ Não pode superar o valor previsto
                            </small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Valor Encaminhado</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control campo-moeda" id="edit_valor_encaminhado" onchange="validarValores()" placeholder="0,00">
                            </div>
                            <small class="text-danger" id="erro_valor_encaminhado" style="display: none;">
                                ⚠️ Não pode superar previsto - subtraído
                            </small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">
                                Valor Pago
                                <i class="bi bi-info-circle info-icon" data-bs-toggle="tooltip" 
                                   title="Marque 'Pagamento inconsistente' se o valor pago supera o previsto de forma irrecuperável"></i>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control campo-moeda" id="edit_valor_pago" onchange="validarValores()" placeholder="0,00">
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="edit_pagamento_inconsistente" onchange="validarValores()">
                                <label class="form-check-label" for="edit_pagamento_inconsistente">
                                    Pagamento inconsistente
                                    <i class="bi bi-info-circle info-icon" data-bs-toggle="tooltip" 
                                       title="Marca o pagamento como inconsistente e adiciona observação. Use apenas se não há como corrigir."></i>
                                </label>
                            </div>
                            <small class="text-danger" id="erro_valor_pago" style="display: none;">
                                ⚠️ Valor pago supera o permitido
                            </small>
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Status *</label>
                            <select class="form-select" id="edit_parcela_status" required>
                                <option value="">Selecione...</option>
                                <option value="Não Pago">Não Pago</option>
                                <option value="Encaminhado para Pagamento">Encaminhado para Pagamento</option>
                                <option value="Pago">Pago</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Status Secundário</label>
                            <select class="form-select" id="edit_parcela_status_secundario">
                                <option value="">-</option>
                                <option value="Parcial">Parcial</option>
                                <option value="Integral">Integral</option>
                                <option value="Glosa">Glosa</option>
                                <option value="Falta Certidão">Falta Certidão</option>
                                <option value="Falta encarte de Prestações">Falta encarte de Prestações</option>
                                <option value="Aguardando Alteração">Aguardando Alteração</option>
                                <option value="Antigos">Antigos</option>
                                <option value="Rescisão">Rescisão</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Data de Pagamento</label>
                            <input type="date" class="form-control" id="edit_data_pagamento">
                        </div>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control" id="edit_observacoes" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- ABA: Cronograma Mensal -->
            <div class="tab-pane fade" id="content-cronograma" role="tabpanel">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Cronograma Mensal do Termo</strong>
                    <br>Visualize e edite o cronograma mensal de valores. Os dados são carregados de <code>gestao_financeira.ultra_liquidacoes_cronograma</code>.
                </div>
                
                <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                    <table class="table table-sm table-bordered">
                        <thead class="table-info">
                            <tr>
                                <th style="width: 15%;">Mês/Ano</th>
                                <th style="width: 20%;">Valor 53-23</th>
                                <th style="width: 20%;">Valor 53-24</th>
                                <th style="width: 20%;">Total Mês</th>
                                <th style="width: 25%;">Nº Parcela</th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaCronogramaOLD_DESATIVADO">
                            <!-- ABA ANTIGA - NÃO USAR -->
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <th>TOTAIS:</th>
                                <th id="total_23_cronograma_edicao_OLD">R$ 0,00</th>
                                <th id="total_24_cronograma_edicao_OLD">R$ 0,00</th>
                                <th id="total_geral_cronograma_edicao_OLD">R$ 0,00</th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="text-center mt-3" id="loadingCronogramaEdicao_OLD" style="display: none;">
                    <div class="spinner-border text-info"></div>
                    <p class="mt-2">Carregando cronograma...</p>
                </div>
                
                <div class="text-center mt-3" id="semCronogramaEdicao_OLD" style="display: none;">
                    <i class="bi bi-calendar-x" style="font-size: 2rem; color: #ccc;"></i>
                    <p class="text-muted">Nenhum cronograma encontrado para este termo.</p>
                </div>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-success" onclick="salvarCronogramaEdicao()" disabled>
                        <i class="bi bi-check-circle me-2"></i>Salvar Alterações do Cronograma (DESATIVADO)
                    </button>
                </div>
            </div>
            
            <!-- ABA: Edição Coletiva -->
            <div class="tab-pane fade" id="content-coletiva" role="tabpanel">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Termo:</strong> <span id="coletivo_numero_termo"></span> | 
                    <strong>OSC:</strong> <span id="coletivo_info_osc"></span> | 
                    <strong>CNPJ:</strong> <span id="coletivo_info_cnpj"></span> | 
                    <strong>Vigência:</strong> <span id="coletivo_info_vigencia_parceria"></span>
                </div>
                
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Edição em Tabela:</strong> Edite diretamente as células da tabela abaixo. 
                    Total de <strong id="coletivo_total_parcelas">0</strong> parcelas. 
                    Clique em "Salvar Alterações Coletivas" para aplicar todas as mudanças.
                </div>
                
                <div class="mb-3 d-flex gap-2 align-items-center">
                    <button type="button" class="btn btn-primary" id="btnAdicionarLinhaColetiva">
                        <i class="bi bi-plus-circle me-2"></i>Adicionar Parcela
                    </button>
                    <button type="button" class="btn btn-success" id="btnExportarCSVColetivo">
                        <i class="bi bi-file-earmark-spreadsheet me-2"></i>Exportar CSV
                    </button>
                    <small class="text-muted">Separador: ponto e vírgula (;)</small>
                </div>
                
                <input type="hidden" id="coletivo_numero_termo_hidden">
                
                <!-- Tabela editável -->
                <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                    <table class="table table-bordered table-sm" id="tabelaEdicaoColetiva">
                        <thead class="table-success">
                            <tr>
                                <th style="width: 60px;">Ações</th>
                                <th style="min-width: 120px;">Vigência Inicial</th>
                                <th style="min-width: 120px;">Vigência Final</th>
                                <th style="min-width: 150px;">Tipo Parcela</th>
                                <th style="min-width: 150px;">Nº Parcela</th>
                                <th style="min-width: 120px;">Valor 53/23</th>
                                <th style="min-width: 120px;">Valor 53/24</th>
                                <th style="min-width: 120px;">Valor Previsto</th>
                                <th style="min-width: 120px;">Subtraído</th>
                                <th style="min-width: 120px;">Encaminhado</th>
                                <th style="min-width: 120px;">Pago</th>
                                <th style="min-width: 180px;">Status</th>
                                <th style="min-width: 180px;">Status Sec.</th>
                                <th style="min-width: 120px;">Data Pgto</th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaColetiva">
                            <!-- Preenchido via JavaScript -->
                        </tbody>
                        <tfoot>
                            <tr class="linha-subtotal">
                                <td colspan="5" class="text-end"><strong>SUBTOTAIS:</strong></td>
                                <td class="text-end" id="subtotal-val-23">R$ 0,00</td>
                                <td class="text-end" id="subtotal-val-24">R$ 0,00</td>
                                <td class="text-end" id="subtotal-val-previsto">R$ 0,00</td>
                                <td class="text-end" id="subtotal-val-subtraido">R$ 0,00</td>
                                <td class="text-end" id="subtotal-val-encaminhado">R$ 0,00</td>
                                <td class="text-end" id="subtotal-val-pago">R$ 0,00</td>
                                <td colspan="3"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="text-center mt-3" id="loadingColetivo" style="display: none;">
                    <div class="spinner-border text-success"></div>
                    <p>Carregando parcelas...</p>
                </div>
            </div>
            
            <!-- ABA: Cronograma Mensal -->
            <div class="tab-pane fade" id="content-cronograma-edicao" role="tabpanel">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-calendar3 me-2"></i>
                    <strong>Cronograma Mensal do Termo</strong>
                    <br>Visualize e edite o cronograma mensal de valores. Os dados são carregados de <code>gestao_financeira.ultra_liquidacoes_cronograma</code>.
                </div>
                
                <input type="hidden" id="cronograma_numero_termo_hidden">
                
                <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                    <table class="table table-sm table-bordered">
                        <thead class="table-info">
                            <tr>
                                <th style="width: 12%;">Info Alteração<br><small class="text-muted" style="font-weight: normal;">"-" = Base | 1, 2, 3... = Aditivo</small></th>
                                <th style="width: 12%;">Mês/Ano</th>
                                <th style="width: 14%;">Valor 53-23</th>
                                <th style="width: 14%;">Valor 53-24</th>
                                <th style="width: 14%;">Total Mês</th>
                                <th style="width: 14%;">Nº Parcela</th>
                                <th style="width: 10%;">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaCronogramaEdicao">
                            <!-- Preenchido via JavaScript -->
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <td colspan="2" class="text-end fw-bold">TOTAIS:</td>
                                <td id="total_23_cronograma_edicao" class="fw-bold">R$ 0,00</td>
                                <td id="total_24_cronograma_edicao" class="fw-bold">R$ 0,00</td>
                                <td id="total_geral_cronograma_edicao" class="fw-bold">R$ 0,00</td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="text-center mt-3" id="loadingCronogramaEdicao" style="display: none;">
                    <div class="spinner-border text-info"></div>
                    <p class="mt-2">Carregando cronograma...</p>
                </div>
                
                <div class="text-center mt-3" id="semCronogramaEdicao" style="display: none;">
                    <i class="bi bi-calendar-x" style="font-size: 2rem; color: #ccc;"></i>
                    <p class="text-muted">Nenhum cronograma encontrado para este termo.</p>
                </div>
                
                <div class="mb-3">
                    <button type="button" class="btn btn-sm btn-primary" onclick="adicionarMesInicioCronogramaEdicao()">
                        <i class="bi bi-arrow-up-circle me-1"></i>Adicionar Mês no Início
                    </button>
                    <button type="button" class="btn btn-sm btn-success" onclick="adicionarMesFinalCronogramaEdicao()">
                        <i class="bi bi-arrow-down-circle me-1"></i>Adicionar Mês no Final
                    </button>
                    <button type="button" class="btn btn-sm btn-info" onclick="gerarTodosMesesPorVigencia()">
                        <i class="bi bi-calendar-range me-1"></i>Adicionar Meses de acordo com Parcelas
                    </button>
                    <button type="button" class="btn btn-sm btn-warning" onclick="limparLinhasDuplicadasCronogramaEdicao()">
                        <i class="bi bi-trash me-1"></i>Limpar Duplicadas (Valor 0)
                    </button>
                </div>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-success" onclick="salvarCronogramaEdicao()">
                        <i class="bi bi-check-circle me-2"></i>Salvar Alterações do Cronograma
                    </button>
                </div>
            </div>
        </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success" id="btnSalvarModal" onclick="salvarParcela()">
                    <i class="bi bi-check-circle me-2"></i>Salvar Alterações
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Adicionar Parcelas -->
<div class="modal fade" id="modalAdicionarParcelas" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Adicionar Parcelas de Novo Termo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- FASE 1: Seleção do Termo -->
                <div id="fase1_selecao" style="display: block;">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>FASE 1: Seleção do Termo</strong><br>
                        Selecione um termo que ainda não possui parcelas cadastradas.
                    </div>
                    
                    <!-- Checkbox para Parcelas Projetadas -->
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="chk_parcelas_projetadas" onchange="alternarTipoSelecaoTermo()">
                        <label class="form-check-label" for="chk_parcelas_projetadas">
                            <strong>Adicionar Parcelas Projetadas</strong>
                            <br><small class="text-muted">Permite selecionar qualquer Termo de Colaboração ainda vigente</small>
                        </label>
                    </div>
                    
                    <!-- Seleção Normal (termos sem parcelas) -->
                    <div id="selecao_normal" style="display: block;">
                        <div class="mb-3">
                            <label class="form-label"><strong>Selecione o Termo da Parceria</strong></label>
                            <select class="form-select" id="novo_numero_termo" required>
                                <option value="">Carregando termos disponíveis...</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Seleção de Termos Vigentes de Colaboração (com autocomplete) -->
                    <div id="selecao_projetadas" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label"><strong>Selecione o Termo de Colaboração Vigente</strong></label>
                            <input type="text" class="form-control" id="input_termo_colaboracao" list="lista_termos_colaboracao" placeholder="Digite para buscar...">
                            <datalist id="lista_termos_colaboracao">
                                <option value="">Carregando...</option>
                            </datalist>
                            <small class="text-muted">Apenas Termos de Colaboração com vigência ativa</small>
                        </div>
                    </div>
                    
                    <div id="info_termo_selecionado" style="display: none;">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Informações do Termo</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>OSC:</strong> <span id="info_novo_osc"></span></p>
                                        <p class="mb-1"><strong>CNPJ:</strong> <span id="info_novo_cnpj"></span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Vigência:</strong> <span id="info_novo_vigencia"></span></p>
                                        <p class="mb-1"><strong>Tipo:</strong> <span id="info_novo_tipo"></span></p>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Processo Celebração:</strong> <span id="info_novo_sei_celeb"></span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Processo PGTO/PC:</strong> <span id="info_novo_sei_pc"></span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-3" id="loadingTermos" style="display: none;">
                        <div class="spinner-border text-primary"></div>
                        <p>Carregando termos disponíveis...</p>
                    </div>
                </div>
                
                <!-- FASE 2: Cronograma Mensal -->
                <div id="fase2_cronograma" style="display: none;">
                    <button type="button" class="btn btn-sm btn-secondary mb-3" onclick="voltarParaFase1()" id="btnVoltarFase1">
                        <i class="bi bi-arrow-left me-2"></i>Voltar para Seleção
                    </button>
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-calendar3 me-2"></i>
                        <strong>FASE 2: Definir Cronograma Mensal</strong><br>
                        Preencha os valores mensais para elemento 53-23 e 53-24. Os valores podem ser zero.
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label"><strong>Tipo de Parcela:</strong></label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="tipo_parcela_manual" id="tipo_mensal" value="mensal">
                                <label class="btn btn-outline-primary" for="tipo_mensal">Parcela Mensal</label>
                                
                                <input type="radio" class="btn-check" name="tipo_parcela_manual" id="tipo_trimestral" value="trimestral">
                                <label class="btn btn-outline-primary" for="tipo_trimestral">Parcela Trimestral</label>
                                
                                <input type="radio" class="btn-check" name="tipo_parcela_manual" id="tipo_semestral" value="semestral" checked>
                                <label class="btn btn-outline-primary" for="tipo_semestral">Parcela Semestral</label>
                                
                                <input type="radio" class="btn-check" name="tipo_parcela_manual" id="tipo_unica" value="unica">
                                <label class="btn btn-outline-primary" for="tipo_unica">Parcela Única</label>
                            </div>
                            <small class="text-muted" id="tipo_parcela_sugestao"></small>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning py-2 mb-2" id="aviso_salvar" style="display: none;">
                        <i class="bi bi-exclamation-triangle me-2"></i><strong>Atenção:</strong> Apenas meses novos devem ter "Salvar?" marcado. <strong>NÃO marque</strong> meses já existentes (cinza), exceto em casos excepcionais de correção.
                    </div>
                    
                    <div class="mb-2">
                        <button type="button" class="btn btn-sm btn-primary" onclick="adicionarLinhaInicioCronograma()">
                            <i class="bi bi-arrow-up-circle me-1"></i>Adicionar Mês no Início
                        </button>
                        <button type="button" class="btn btn-sm btn-success" onclick="adicionarLinhaCronograma()">
                            <i class="bi bi-arrow-down-circle me-1"></i>Adicionar Mês no Final
                        </button>
                        <small class="text-muted ms-2">Adiciona novo mês antes ou depois dos existentes</small>
                    </div>
                    
                    <div class="table-responsive" style="max-height: 50vh; overflow-y: auto;">
                        <table class="table table-sm table-bordered">
                            <thead class="table-primary">
                                <tr>
                                    <th style="width: 8%;">Salvar?</th>
                                    <th style="width: 10%;">Info Alteração<br><small class="text-muted" style="font-weight: normal;">"-" = Base | 1, 2... = Aditivo</small></th>
                                    <th style="width: 12%;">Mês/Ano</th>
                                    <th style="width: 16%;">Valor 53-23</th>
                                    <th style="width: 16%;">Valor 53-24</th>
                                    <th style="width: 14%;">Total Mês</th>
                                    <th style="width: 14%;">Nº Parcela</th>
                                    <th style="width: 6%;">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="corpo_cronograma">
                                <!-- Preenchido via JavaScript -->
                            </tbody>
                            <tfoot class="table-secondary">
                                <tr>
                                    <th colspan="2">TOTAIS:</th>
                                    <th></th>
                                    <th id="total_23_cronograma">R$ 0,00</th>
                                    <th id="total_24_cronograma">R$ 0,00</th>
                                    <th id="total_geral_cronograma">R$ 0,00</th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                
                <!-- FASE 3: Preview e edição das parcelas finais -->
                <div id="fase3_parcelas" style="display: none;">
                    <h6 class="mb-3">
                        <i class="bi bi-pencil-square me-2"></i>Fase 3: Editar Parcelas Finais
                    </h6>
                    <p class="text-muted">Revise e edite as parcelas antes de salvar definitivamente</p>
                    
                    <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                        <table class="table table-sm table-bordered">
                            <thead class="table-success">
                                <tr>
                                    <th style="width: 5%;">Salvar?</th>
                                    <th>Vig. Inicial</th>
                                    <th>Vig. Final</th>
                                    <th>Nº Parcela</th>
                                    <th>Tipo Parcela</th>
                                    <th>Info Alteração<br><small class="text-muted" style="font-weight: normal;">"-" = Base | 1, 2, 3... = Aditivo</small></th>
                                    <th>Valor 53-23</th>
                                    <th>Valor 53-24</th>
                                    <th>Valor Previsto</th>
                                    <th>Status</th>
                                    <th>Status Sec.</th>
                                </tr>
                            </thead>
                            <tbody id="corpo_parcelas_finais">
                                <!-- Preenchido via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-secondary" id="btnVoltarFase2" onclick="voltarParaFase2()" style="display: none;">
                    <i class="bi bi-arrow-left-circle me-2"></i>Voltar para Cronograma
                </button>
                <button type="button" class="btn btn-primary" id="btnAvancarCronograma" onclick="avancarParaCronograma()" style="display: none;">
                    <i class="bi bi-arrow-right-circle me-2"></i>Avançar para Cronograma
                </button>
                <button type="button" class="btn btn-success" id="btnSalvarCronograma" onclick="salvarCronograma()" style="display: none;">
                    <i class="bi bi-check-circle me-2"></i>Salvar Cronograma e Prosseguir
                </button>
                <button type="button" class="btn btn-success" id="btnConfirmarParcelas" onclick="confirmarParcelasFinais()" style="display: none;">
                    <i class="bi bi-check-circle me-2"></i>Confirmar e Adicionar Parcelas
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let secaoAtual = 'nao_pago';
    let paginaAtual = 1;
    let dadosAtuais = [];
    let modoParcelasProjetadas = false;  // Flag para controlar se está adicionando projetadas
    let totalMesesOriginais = 0;  // Quantos meses já existiam no cronograma original
    let ultimoInfoAlteracaoSalvo = 'Base';  // ⚡ NOVO: Armazena o último info_alteracao SALVO no banco
    
    // ⚡ NOVO: Cache global de status para evitar múltiplas requisições
    let cacheStatusPagamento = null;
    let cacheStatusCarregando = false;
    
    // Função auxiliar para formatar centavos em moeda
    function formatarCentavosParaMoeda(centavos) {
        const reais = Math.floor(centavos / 100);
        const cents = centavos % 100;
        return reais.toLocaleString('pt-BR') + ',' + cents.toString().padStart(2, '0');
    }
    
    // Função auxiliar para converter moeda em centavos
    function converterMoedaParaCentavos(valor) {
        // Remove tudo exceto números e vírgula
        const limpo = valor.replace(/[^\d,]/g, '');
        // Substitui vírgula por ponto e converte
        const numero = parseFloat(limpo.replace(',', '.'));
        return Math.round(numero * 100);
    }
    
    // Função para converter valor com formato BR (vírgula decimal, ponto milhar) para número
    function parseMoedaBR(valor) {
        if (!valor || valor === '') return null;
        // Remove tudo exceto números, pontos e vírgulas
        const limpo = valor.toString().replace(/[^\d,.]/g, '');
        // Remove pontos (separadores de milhar) e substitui vírgula por ponto
        const numero = limpo.replace(/\./g, '').replace(',', '.');
        const resultado = parseFloat(numero);
        return isNaN(resultado) ? null : resultado;
    }
    
    // ==================== NAVEGAÇÃO COM ENTER ====================
    // Função genérica para navegar com Enter em tabelas editáveis
    function habilitarNavegacaoEnter(seletorTabela, seletorCampos) {
        $(document).on('keydown', `${seletorTabela} ${seletorCampos}`, function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                
                const $campo = $(this);
                const $tr = $campo.closest('tr');
                const $tbody = $tr.closest('tbody');
                const colIndex = $campo.closest('td').index();
                const $proximaTr = $tr.next('tr');
                
                if ($proximaTr.length > 0) {
                    // Encontrar campo editável na mesma coluna da próxima linha
                    const $proximoCampo = $proximaTr.find('td').eq(colIndex).find(seletorCampos);
                    
                    if ($proximoCampo.length > 0) {
                        $proximoCampo.focus().select();
                    }
                } else {
                    // Se estiver na última linha, voltar para primeira linha (opcional)
                    const $primeiraTr = $tbody.find('tr:first');
                    const $primeiroCampo = $primeiraTr.find('td').eq(colIndex).find(seletorCampos);
                    
                    if ($primeiroCampo.length > 0) {
                        $primeiroCampo.focus().select();
                    }
                }
            }
        });
    }
    
    // Inicializar
    $(document).ready(function() {
        carregarDadosFiltros();
        
        // ⚡ NOVO: Restaurar filtros salvos antes de carregar dados
        restaurarFiltros();
        
        carregarDados();
        popularAnosVigencia();
        
        // ⚡ NOVO: Habilitar navegação com Enter nas tabelas editáveis
        // Edição Coletiva
        habilitarNavegacaoEnter('#corpoTabelaColetiva', 'input, select, textarea');
        // Cronograma Mensal (Adicionar Parcelas)
        habilitarNavegacaoEnter('#corpo_cronograma', 'input, select');
        // Cronograma de Edição (Editar Termo)
        habilitarNavegacaoEnter('#corpoTabelaCronogramaEdicao', 'input, select');
        
        // Inicializar tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Formatar campos de moeda no modal - REMOVIDO para evitar problemas de formatação
        
        // Monitorar mudança de aba para alterar texto do botão
        $('#tabsEdicao button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
            const abaAtiva = $(e.target).attr('id');
            const btnSalvar = $('#btnSalvarModal');
            
            if (abaAtiva === 'tab-coletiva') {
                btnSalvar.html('<i class="bi bi-check-circle me-2"></i>Salvar Alterações Coletivas');
                
                // Carregar parcelas quando mudar para aba coletiva
                const numeroTermo = $('#coletivo_numero_termo_hidden').val();
                if (numeroTermo) {
                    carregarParcelasColetivas(numeroTermo);
                }
            } else if (abaAtiva === 'tab-cronograma-edicao') {
                btnSalvar.hide(); // Ocultar botão padrão, usaremos botão próprio da aba
                
                // Carregar cronograma quando mudar para aba de cronograma
                const numeroTermo = $('#edit_numero_termo').val() || $('#coletivo_numero_termo_hidden').val();
                if (numeroTermo) {
                    carregarCronogramaEdicao(numeroTermo);
                }
            } else {
                btnSalvar.html('<i class="bi bi-check-circle me-2"></i>Salvar Alterações').show();
            }
        });
        
        // ✨ LISTENER: Resetar modal de adicionar parcelas ao fechar
        $('#modalAdicionarParcelas').on('hidden.bs.modal', function () {
            console.log('🗑️ Modal fechado - estado será resetado ao reabrir');
            // O reset completo é feito na função abrirModalAdicionarParcelas()
        });
        
        // ✨ LISTENER: Adicionar nova linha na edição coletiva
        $('#btnAdicionarLinhaColetiva').on('click', function() {
            adicionarNovaLinhaColetiva();
        });
    });
    
    // ⚡ NOVA FUNÇÃO: Carregar status de pagamento uma única vez e cachear
    function carregarStatusPagamento() {
        return new Promise((resolve, reject) => {
            // Se já tem cache, retornar imediatamente
            if (cacheStatusPagamento) {
                resolve(cacheStatusPagamento);
                return;
            }
            
            // Se já está carregando, aguardar
            if (cacheStatusCarregando) {
                const interval = setInterval(() => {
                    if (cacheStatusPagamento) {
                        clearInterval(interval);
                        resolve(cacheStatusPagamento);
                    }
                }, 100);
                return;
            }
            
            // Fazer requisição
            cacheStatusCarregando = true;
            $.ajax({
                url: '/gestao_financeira/ultra-liquidacoes/api/status-pagamento',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        cacheStatusPagamento = response.status;
                        cacheStatusCarregando = false;
                        resolve(cacheStatusPagamento);
                    } else {
                        cacheStatusCarregando = false;
                        reject('Erro ao carregar status');
                    }
                },
                error: function(xhr) {
                    console.error('❌ Erro ao carregar status de pagamento:', xhr);
                    cacheStatusCarregando = false;
                    reject('Erro de rede ao carregar status');
                }
            });
        });
    }
    
    // Carregar dados para autocomplete dos filtros
    function carregarDadosFiltros() {
        $.ajax({
            url: '/gestao_financeira/ultra-liquidacoes/api/filtros-dados',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    // Preencher datalists
                    $('#lista_termos').empty();
                    response.termos.forEach(function(termo) {
                        $('#lista_termos').append($('<option>').val(termo));
                    });
                    
                    $('#lista_oscs').empty();
                    response.oscs.forEach(function(osc) {
                        $('#lista_oscs').append($('<option>').val(osc));
                    });
                    
                    $('#lista_cnpjs').empty();
                    response.cnpjs.forEach(function(cnpj) {
                        $('#lista_cnpjs').append($('<option>').val(cnpj));
                    });
                    
                    $('#lista_seis_celeb').empty();
                    response.seis_celeb.forEach(function(sei) {
                        $('#lista_seis_celeb').append($('<option>').val(sei));
                    });
                    
                    $('#lista_seis_pc').empty();
                    response.seis_pc.forEach(function(sei) {
                        $('#lista_seis_pc').append($('<option>').val(sei));
                    });
                    
                    $('#lista_tipos_termo').empty();
                    response.tipos_contrato.forEach(function(tipo) {
                        $('#lista_tipos_termo').append($('<option>').val(tipo));
                    });
                }
            },
            error: function(xhr) {
                console.error('Erro ao carregar dados de filtros:', xhr.responseJSON?.error || 'Erro desconhecido');
            }
        });
    }
    
    // Popular anos de vigência (de 2015 até ano atual + 5)
    function popularAnosVigencia() {
        const anoAtual = new Date().getFullYear();
        const anoInicio = 2015;
        const anoFim = anoAtual + 5;
        
        for (let ano = anoInicio; ano <= anoFim; ano++) {
            $('#filtro_vig_inicial_ano, #filtro_vig_final_ano').append($('<option>').val(ano).text(ano));
        }
    }
    
    // Alternar filtros
    function toggleFiltros() {
        const body = document.getElementById('filtros-body');
        const icone = document.getElementById('icone-filtros');
        
        if (body.classList.contains('show')) {
            body.classList.remove('show');
            icone.classList.remove('bi-chevron-up');
            icone.classList.add('bi-chevron-down');
        } else {
            body.classList.add('show');
            icone.classList.remove('bi-chevron-down');
            icone.classList.add('bi-chevron-up');
        }
    }
    
    // Trocar seção
    function trocarSecao(secao) {
        secaoAtual = secao;
        paginaAtual = 1;
        
        // Atualizar tabs
        document.querySelectorAll('.secao-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`[data-secao="${secao}"]`).classList.add('active');
        
        // Atualizar nome da coluna Data Pgto baseado na seção
        const thDataPgto = $('#tabelaParcelas thead th:contains("Data")').filter(function() {
            return $(this).text().includes('Pgto') || $(this).text().includes('Encaminhamento');
        });
        
        if (secao === 'encaminhado') {
            thDataPgto.text('Data de Encaminhamento');
        } else {
            thDataPgto.text('Data Pgto');
        }
        
        salvarFiltros(); // ⚡ NOVO: Salvar seção ativa
        carregarDados();
    }
    
    // Atualizar colunas expandidas
    function atualizarColunas() {
        const mostrarOsc = document.getElementById('chk_osc').checked;
        const mostrarCnpj = document.getElementById('chk_cnpj').checked;
        const mostrarProjeto = document.getElementById('chk_projeto').checked;
        const mostrarSeiCeleb = document.getElementById('chk_sei_celeb').checked;
        const mostrarSeiPc = document.getElementById('chk_sei_pc').checked;
        
        document.querySelectorAll('.col-osc').forEach(el => {
            el.style.display = mostrarOsc ? '' : 'none';
        });
        document.querySelectorAll('.col-cnpj').forEach(el => {
            el.style.display = mostrarCnpj ? '' : 'none';
        });
        document.querySelectorAll('.col-projeto').forEach(el => {
            el.style.display = mostrarProjeto ? '' : 'none';
        });
        document.querySelectorAll('.col-sei-celeb').forEach(el => {
            el.style.display = mostrarSeiCeleb ? '' : 'none';
        });
        document.querySelectorAll('.col-sei-pc').forEach(el => {
            el.style.display = mostrarSeiPc ? '' : 'none';
        });
        
        salvarFiltros(); // ⚡ NOVO: Salvar estado das colunas
        carregarDados();
    }
    
    // Carregar dados
    function carregarDados() {
        $('#loading').show();
        $('#sem-dados').hide();
        $('#corpo-tabela').empty();
        
        // Coletar status secundários selecionados
        const statusSecSelecionados = [];
        $('.filtro-status-sec:checked').each(function() {
            statusSecSelecionados.push($(this).val());
        });
        
        const params = new URLSearchParams({
            secao: secaoAtual,
            pagina: paginaAtual,
            mostrar_osc: document.getElementById('chk_osc').checked,
            mostrar_cnpj: document.getElementById('chk_cnpj').checked,
            mostrar_projeto: document.getElementById('chk_projeto').checked,
            mostrar_sei_celeb: document.getElementById('chk_sei_celeb').checked,
            mostrar_sei_pc: document.getElementById('chk_sei_pc').checked,
            numero_termo: $('#filtro_numero_termo').val() || '',
            parcela_tipo: $('#filtro_parcela_tipo').val() || '',
            parcela_numero: $('#filtro_parcela_numero').val() || '',
            tipo_termo: $('#filtro_tipo_termo').val() || '',
            tipo_pendencia: $('#filtro_tipo_pendencia').val() || '',
            ano_termino_termo: $('#filtro_ano_termino_termo').val() || '',
            vigencia_inicial_mes: $('#filtro_vig_inicial_mes').val() || '',
            vigencia_inicial_ano: $('#filtro_vig_inicial_ano').val() || '',
            vigencia_final_mes: $('#filtro_vig_final_mes').val() || '',
            vigencia_final_ano: $('#filtro_vig_final_ano').val() || '',
            vigencia_inicial: '',  // Manter compatibilidade
            vigencia_final: '',    // Manter compatibilidade
            data_pagamento: $('#filtro_data_pagamento').val() || '',
            observacoes: $('#filtro_observacoes').val() || '',
            status_secundarios: statusSecSelecionados.join(','),
            osc: $('#filtro_osc').val() || '',
            cnpj: $('#filtro_cnpj').val() || '',
            sei_celeb: $('#filtro_sei_celeb').val() || '',
            sei_pc: $('#filtro_sei_pc').val() || ''
        });
        
        // DEBUG: Log do filtro de pendência sendo enviado
        console.log('🔍 DEBUG FRONTEND: filtro_tipo_pendencia =', $('#filtro_tipo_pendencia').val());
        console.log('🔍 DEBUG FRONTEND: params =', Object.fromEntries(params.entries()));
        
        $.ajax({
            url: '/gestao_financeira/ultra-liquidacoes/api/parcelas?' + params.toString(),
            method: 'GET',
            success: function(response) {
                $('#loading').hide();
                
                if (response.success && response.data.length > 0) {
                    dadosAtuais = response.data;
                    renderizarTabela(response.data);
                    renderizarPaginacao(response.pagina, response.total_paginas);
                    
                    // Atualizar info de registros
                    const inicio = ((response.pagina - 1) * response.por_pagina) + 1;
                    const fim = Math.min(response.pagina * response.por_pagina, response.total);
                    $('#info-registros').text(`Mostrando ${inicio} a ${fim} de ${response.total} registros`);
                    
                    // Atualizar badge de pendências
                    if (secaoAtual === 'nao_pago' || secaoAtual === 'encaminhado' || secaoAtual === 'pago') {
                        let badgeId, badgeVerdeId;
                        
                        if (secaoAtual === 'nao_pago') {
                            badgeId = 'badge-nao-pago';
                            badgeVerdeId = 'badge-verde-nao-pago';
                        } else if (secaoAtual === 'encaminhado') {
                            badgeId = 'badge-encaminhado';
                            badgeVerdeId = 'badge-verde-encaminhado';
                        } else {
                            badgeId = 'badge-pago';
                            badgeVerdeId = 'badge-verde-pago';
                        }
                        
                        if (response.total_pendencias > 0) {
                            $('#' + badgeId).text(response.total_pendencias).show();
                        } else {
                            $('#' + badgeId).hide();
                        }
                        
                        // Badge verde: só mostrar se > 0, com cor verde escuro
                        if (response.total_necessita_pagamento > 0) {
                            $('#' + badgeVerdeId)
                                .text(response.total_necessita_pagamento)
                                .css('background-color', '#28a745')
                                .show();
                        } else {
                            $('#' + badgeVerdeId).hide();
                        }
                    }
                } else {
                    $('#sem-dados').show();
                }
            },
            error: function(xhr) {
                $('#loading').hide();
                alert('Erro ao carregar dados: ' + (xhr.responseJSON?.error || 'Erro desconhecido'));
            }
        });
    }
    
    // Renderizar tabela
    function renderizarTabela(dados) {
        const tbody = $('#corpo-tabela');
        tbody.empty();
        
        dados.forEach(function(parcela) {
            const tr = $('<tr>');
            
            // Destacar linha se tiver pendência (AMARELO tem prioridade)
            if (parcela.tem_pendencia === true || parcela.tem_pendencia === 'true' || 
                (parcela.pendencias && parcela.pendencias.length > 0)) {
                
                tr.addClass('linha-pendencia');
                tr.attr('title', '⚠️ Inconsistência: ' + (parcela.pendencias_descricao || 'Verificar'));
                tr.css({
                    'cursor': 'help',
                    'background-color': '#fff3cd !important'
                });
            }
            // Se NÃO tem inconsistência mas EMPENHO COBRE VALOR (VERDE ESCURO)
            else if (parcela.empenho_cobre_valor === true || parcela.empenho_cobre_valor === 'true') {
                
                tr.addClass('linha-empenho-disponivel');
                
                // Tooltip com detalhes de empenhos
                if (parcela.detalhes_empenhos && parcela.detalhes_empenhos.length > 0) {
                    let tooltip = '🟢 Empenho cobre valor previsto\n\n💰 EMPENHOS DISPONÍVEIS:\n';
                    let totalDisponivel = 0;
                    parcela.detalhes_empenhos.forEach(emp => {
                        tooltip += `Empenho ${emp.cod_eph} (${emp.ano_eph}) - Item ${emp.cod_item_desp_sof}\n`;
                        tooltip += `  Total: R$ ${emp.val_tot_eph.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                        tooltip += `  Cancelado: R$ ${(emp.val_tot_canc_eph || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                        tooltip += `  Pago: R$ ${emp.val_tot_pago_eph.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                        tooltip += `  DISPONÍVEL: R$ ${emp.disponivel.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n\n`;
                        totalDisponivel += emp.disponivel;
                    });
                    tooltip += `TOTAL DISPONÍVEL: R$ ${totalDisponivel.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    tr.attr('title', tooltip);
                } else {
                    tr.attr('title', '🟢 Empenho cobre valor previsto');
                }
                
                tr.css({
                    'cursor': 'help',
                    'background-color': '#5cb85c !important',
                    'color': 'white !important'
                });
            }
            // Se NÃO tem inconsistência mas PAGO INTEGRAL (AZUL ESCURO) - Encaminhado
            else if (parcela.pago_integral === true || parcela.pago_integral === 'true') {
                
                tr.addClass('linha-pago-integral');
                
                // Tooltip com detalhes de pagamento
                if (parcela.detalhes_empenhos && parcela.detalhes_empenhos.length > 0) {
                    let tooltip = '🔵 PAGO INTEGRAL - Alterar status para "Pago"\n\n💵 VALORES PAGOS:\n';
                    
                    // Filtrar empenhos por elemento
                    let empenhos23 = parcela.detalhes_empenhos.filter(e => e.cod_item_desp_sof == '23');
                    let empenhos24 = parcela.detalhes_empenhos.filter(e => e.cod_item_desp_sof == '24');
                    
                    if (empenhos23.length > 0) {
                        empenhos23.forEach(emp => {
                            tooltip += `\nEmpenho ${emp.cod_eph} (${emp.ano_eph}) - Item 53-23\n`;
                            tooltip += `  Total: R$ ${emp.val_tot_eph.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                            tooltip += `  Cancelado: R$ ${(emp.val_tot_canc_eph || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                            tooltip += `  PAGO: R$ ${emp.val_tot_pago_eph.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                        });
                    }
                    
                    if (empenhos24.length > 0) {
                        empenhos24.forEach(emp => {
                            tooltip += `\nEmpenho ${emp.cod_eph} (${emp.ano_eph}) - Item 53-24\n`;
                            tooltip += `  Total: R$ ${emp.val_tot_eph.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                            tooltip += `  Cancelado: R$ ${(emp.val_tot_canc_eph || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                            tooltip += `  PAGO: R$ ${emp.val_tot_pago_eph.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                        });
                    }
                    
                    tooltip += `\n📊 PAGO NESTA PARCELA:\n`;
                    if (parcela.valor_pago_23 > 0) {
                        tooltip += `  Elemento 53-23: R$ ${parcela.valor_pago_23.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                    }
                    if (parcela.valor_pago_24 > 0) {
                        tooltip += `  Elemento 53-24: R$ ${parcela.valor_pago_24.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                    }
                    tooltip += `\n✅ PAGO INTEGRAL`;
                    
                    tr.attr('title', tooltip);
                } else {
                    tr.attr('title', '🔵 PAGO INTEGRAL - Alterar status para "Pago"');
                }
                
                tr.css({
                    'cursor': 'help',
                    'background-color': '#0d6efd !important',  // Azul Bootstrap
                    'color': 'white !important'
                });
            }
            // Se NÃO tem inconsistência mas PAGO PARCIAL (AZUL CLARO) - Encaminhado
            else if (parcela.pago_parcial === true || parcela.pago_parcial === 'true') {
                
                tr.addClass('linha-pago-parcial');
                
                // Tooltip com detalhes de pagamento
                if (parcela.detalhes_empenhos && parcela.detalhes_empenhos.length > 0) {
                    let tooltip = '🔷 PAGO PARCIAL - Aguardar pagamento completo\n\n💵 VALORES PAGOS:\n';
                    
                    // Filtrar empenhos por elemento
                    let empenhos23 = parcela.detalhes_empenhos.filter(e => e.cod_item_desp_sof == '23');
                    let empenhos24 = parcela.detalhes_empenhos.filter(e => e.cod_item_desp_sof == '24');
                    
                    if (empenhos23.length > 0) {
                        empenhos23.forEach(emp => {
                            tooltip += `\nEmpenho ${emp.cod_eph} (${emp.ano_eph}) - Item 53-23\n`;
                            tooltip += `  Total: R$ ${emp.val_tot_eph.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                            tooltip += `  Cancelado: R$ ${(emp.val_tot_canc_eph || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                            tooltip += `  PAGO: R$ ${emp.val_tot_pago_eph.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                        });
                    }
                    
                    if (empenhos24.length > 0) {
                        empenhos24.forEach(emp => {
                            tooltip += `\nEmpenho ${emp.cod_eph} (${emp.ano_eph}) - Item 53-24\n`;
                            tooltip += `  Total: R$ ${emp.val_tot_eph.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                            tooltip += `  Cancelado: R$ ${(emp.val_tot_canc_eph || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                            tooltip += `  PAGO: R$ ${emp.val_tot_pago_eph.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                        });
                    }
                    
                    tooltip += `\n📊 PAGO NESTA PARCELA:\n`;
                    if (parcela.valor_pago_23 > 0) {
                        tooltip += `  Elemento 53-23: R$ ${parcela.valor_pago_23.toLocaleString('pt-BR', {minimumFractionDigits: 2})} de R$ ${parcela.valor_elemento_53_23.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                    }
                    if (parcela.valor_pago_24 > 0) {
                        tooltip += `  Elemento 53-24: R$ ${parcela.valor_pago_24.toLocaleString('pt-BR', {minimumFractionDigits: 2})} de R$ ${parcela.valor_elemento_53_24.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                    }
                    tooltip += `\n⚠️ PAGO PARCIAL`;
                    
                    tr.attr('title', tooltip);
                } else {
                    tr.attr('title', '🔷 PAGO PARCIAL - Aguardar pagamento completo');
                }
                
                tr.css({
                    'cursor': 'help',
                    'background-color': '#6c9bd1 !important',  // Azul claro
                    'color': 'white !important'
                });
            }
            // Se NÃO tem inconsistência, empenho NÃO cobre mas NECESSITA PAGAMENTO (VERDE CLARO)
            else if (parcela.necessita_pagamento === true || parcela.necessita_pagamento === 'true') {
                
                tr.addClass('linha-necessita-pagamento');
                
                // Tooltip com detalhes de empenhos (se houver)
                if (parcela.detalhes_empenhos && parcela.detalhes_empenhos.length > 0) {
                    let tooltip = '🟡 Necessário realizar trâmites de pagamento\n\n💰 EMPENHOS DISPONÍVEIS:\n';
                    let totalDisponivel = 0;
                    parcela.detalhes_empenhos.forEach(emp => {
                        tooltip += `Empenho ${emp.cod_eph} (${emp.ano_eph}) - Item ${emp.cod_item_desp_sof}\n`;
                        tooltip += `  Total: R$ ${emp.val_tot_eph.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                        tooltip += `  Liquidado: R$ ${emp.val_tot_lqdc_eph.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                        tooltip += `  Pago: R$ ${emp.val_tot_pago_eph.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                        tooltip += `  DISPONÍVEL: R$ ${emp.disponivel.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n\n`;
                        totalDisponivel += emp.disponivel;
                    });
                    tooltip += `TOTAL DISPONÍVEL: R$ ${totalDisponivel.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    tr.attr('title', tooltip);
                } else {
                    tr.attr('title', '🟡 Necessário realizar trâmites de pagamento dessa parcela');
                }
                
                tr.css({
                    'cursor': 'help',
                    'background-color': '#d1f2d1 !important'
                });
            }
            
            tr.append($('<td>').text(parcela.vigencia_inicial));
            tr.append($('<td>').text(parcela.vigencia_final));
            tr.append($('<td>').text(parcela.numero_termo));
            tr.append($('<td>').text(parcela.parcela_tipo));
            tr.append($('<td>').text(parcela.parcela_numero));
            tr.append($('<td>').addClass('valor-moeda').text(formatarMoeda(parcela.valor_elemento_53_23)));
            tr.append($('<td>').addClass('valor-moeda').text(formatarMoeda(parcela.valor_elemento_53_24)));
            tr.append($('<td>').addClass('valor-moeda').text(formatarMoeda(parcela.valor_previsto)));
            tr.append($('<td>').addClass('valor-moeda').text(formatarMoeda(parcela.valor_subtraido)));
            tr.append($('<td>').addClass('valor-moeda').text(formatarMoeda(parcela.valor_encaminhado)));
            tr.append($('<td>').addClass('valor-moeda').text(formatarMoeda(parcela.valor_pago)));
            tr.append($('<td>').text(parcela.parcela_status));
            tr.append($('<td>').text(parcela.parcela_status_secundario || '-'));
            tr.append($('<td>').text(parcela.data_pagamento || '-'));
            tr.append($('<td>').text(truncarTexto(parcela.observacoes, 50)));
            
            // Colunas expandidas
            if (parcela.osc !== null && parcela.osc !== undefined) {
                tr.append($('<td>').addClass('col-osc').css('display', document.getElementById('chk_osc').checked ? '' : 'none').text(parcela.osc));
            }
            if (parcela.cnpj !== null && parcela.cnpj !== undefined) {
                tr.append($('<td>').addClass('col-cnpj').css('display', document.getElementById('chk_cnpj').checked ? '' : 'none').text(parcela.cnpj));
            }
            if (parcela.projeto !== null && parcela.projeto !== undefined) {
                tr.append($('<td>').addClass('col-projeto').css('display', document.getElementById('chk_projeto').checked ? '' : 'none').text(parcela.projeto || '-'));
            }
            if (parcela.sei_celeb !== null && parcela.sei_celeb !== undefined) {
                tr.append($('<td>').addClass('col-sei-celeb').css('display', document.getElementById('chk_sei_celeb').checked ? '' : 'none').text(parcela.sei_celeb));
            }
            if (parcela.sei_pc !== null && parcela.sei_pc !== undefined) {
                tr.append($('<td>').addClass('col-sei-pc').css('display', document.getElementById('chk_sei_pc').checked ? '' : 'none').text(parcela.sei_pc));
            }
            
            // Ações
            const tdAcoes = $('<td>');
            const btnEditar = $('<button>').addClass('btn btn-sm btn-primary btn-acao')
                .html('<i class="bi bi-pencil"></i>')
                .attr('title', 'Editar')
                .on('click', function() { editarParcela(parcela.id); });
            
            const btnExcluir = $('<button>').addClass('btn btn-sm btn-danger btn-acao')
                .html('<i class="bi bi-trash"></i>')
                .attr('title', 'Excluir')
                .on('click', function() { excluirParcela(parcela.id); });
            
            const btnEncaminhamento = $('<button>').addClass('btn btn-sm btn-success btn-acao')
                .html('<i class="bi bi-file-earmark-text"></i>')
                .attr('title', 'Encaminhamento de Pagamento')
                .on('click', function() { 
                    window.location.href = `/gestao_financeira/ultra-liquidacoes/encaminhamento-pagamento/${encodeURIComponent(parcela.numero_termo)}`; 
                });
            
            tdAcoes.append(btnEditar).append(btnExcluir).append(btnEncaminhamento);
            tr.append(tdAcoes);
            
            tbody.append(tr);
        });
    }
    
    // Renderizar paginação
    function renderizarPaginacao(pagina, totalPaginas) {
        // Atualizar botões do topo
        $('#info-pagina-topo').text(`Página ${pagina} de ${totalPaginas}`);
        $('#btn-anterior-topo').prop('disabled', pagina <= 1);
        $('#btn-proxima-topo').prop('disabled', pagina >= totalPaginas);
    }
    
    // Funções de navegação simples para topo
    function paginaAnterior() {
        if (paginaAtual > 1) {
            paginaAtual--;
            carregarDados();
        }
    }
    
    function proximaPagina() {
        paginaAtual++;
        carregarDados();
    }
    
    // Aplicar filtros
    function aplicarFiltros() {
        paginaAtual = 1;
        salvarFiltros(); // ⚡ NOVO: Salvar filtros no localStorage
        carregarDados();
    }
    
    // Limpar filtros
    function limparFiltros() {
        $('#filtro_numero_termo, #filtro_parcela_numero, #filtro_tipo_termo, #filtro_tipo_pendencia, #filtro_data_pagamento, #filtro_observacoes, #filtro_osc, #filtro_cnpj, #filtro_sei_celeb, #filtro_sei_pc').val('');
        $('#filtro_parcela_tipo').val('Programada');
        localStorage.removeItem('ultra_liquidacoes_filtros'); // ⚡ NOVO: Limpar filtros salvos
        $('#filtro_vig_inicial_mes, #filtro_vig_inicial_ano, #filtro_vig_final_mes, #filtro_vig_final_ano').val('');
        aplicarFiltros();
    }
    
    // Carregar total de parcelas do termo
    function carregarTotalParcelasTermo(numeroTermo) {
        $.ajax({
            url: `/gestao_financeira/ultra-liquidacoes/api/termo-info/${encodeURIComponent(numeroTermo)}`,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    $('#coletivo_total_parcelas').text(response.total);
                }
            },
            error: function() {
                $('#coletivo_total_parcelas').text('?');
            }
        });
    }
    
    // Carregar parcelas do termo para edição coletiva
    function carregarParcelasColetivas(numeroTermo) {
        $('#loadingColetivo').show();
        $('#corpoTabelaColetiva').empty();
        
        $.ajax({
            url: `/gestao_financeira/ultra-liquidacoes/api/termo/${encodeURIComponent(numeroTermo)}/parcelas`,
            method: 'GET',
            success: function(response) {
                $('#loadingColetivo').hide();
                
                if (response.success && response.parcelas.length > 0) {
                    $('#coletivo_total_parcelas').text(response.parcelas.length);
                    
                    // Rastrear IDs originais para detectar exclusões
                    parcelasOriginaisIds = response.parcelas.map(p => p.id);
                    
                    // Armazenar tipos disponíveis globalmente
                    window.tiposParcelaDisponiveis = response.tipos_parcela || [];
                    
                    renderizarTabelaColetiva(response.parcelas, response.tipos_parcela);
                } else {
                    $('#corpoTabelaColetiva').html('<tr><td colspan="14" class="text-center">Nenhuma parcela encontrada</td></tr>');
                    parcelasOriginaisIds = [];
                }
            },
            error: function(xhr) {
                $('#loadingColetivo').hide();
                alert('Erro ao carregar parcelas: ' + (xhr.responseJSON?.error || 'Erro desconhecido'));
            }
        });
    }
    
    // Renderizar tabela editável coletiva
    function renderizarTabelaColetiva(parcelas, tiposDisponiveis) {
        const tbody = $('#corpoTabelaColetiva');
        tbody.empty();
        
        console.log('🔍 DEBUG COLETIVA: Renderizando', parcelas.length, 'parcelas');
        if (parcelas.length > 0) {
            console.log('🔍 DEBUG COLETIVA: Primeira parcela:', parcelas[0]);
            console.log('🔍 DEBUG COLETIVA: valor_pago bruto:', parcelas[0].valor_pago, 'tipo:', typeof parcelas[0].valor_pago);
        }
        
        parcelas.forEach(function(p) {
            const tr = $('<tr>').data('parcela-id', p.id);
            
            // Coluna de ações (botão excluir)
            const btnExcluir = $('<button>').
                addClass('btn btn-danger btn-sm').
                attr('type', 'button').
                html('<i class="bi bi-trash"></i>').
                on('click', function() {
                    if (confirm('⚠️ Excluir esta parcela?')) {
                        tr.remove();
                        recalcularSubtotaisColetivos();
                    }
                });
            tr.append($('<td>').append(btnExcluir));
            
            // Vigência Inicial - formato mês/ano
            const vigInicialMesAno = p.vigencia_inicial ? converterDataParaMesAno(p.vigencia_inicial) : '';
            tr.append($('<td>').html(`<input type="month" class="form-control form-control-sm edit-vig-inicial" value="${vigInicialMesAno}">`));
            
            // Vigência Final - formato mês/ano
            const vigFinalMesAno = p.vigencia_final ? converterDataParaMesAno(p.vigencia_final) : '';
            tr.append($('<td>').html(`<input type="month" class="form-control form-control-sm edit-vig-final" value="${vigFinalMesAno}">`));
            
            // Tipo Parcela
            let selectTipo = '<select class="form-select form-select-sm edit-tipo">';
            tiposDisponiveis.forEach(function(tipo) {
                selectTipo += `<option value="${tipo}" ${p.parcela_tipo === tipo ? 'selected' : ''}>${tipo}</option>`;
            });
            selectTipo += '</select>';
            tr.append($('<td>').html(selectTipo));
            
            // Nº Parcela
            tr.append($('<td>').html(`<input type="text" class="form-control form-control-sm edit-numero" value="${p.parcela_numero || ''}">`));
            
            // 🔧 CORRIGIDO: Formatar valores usando toLocaleString direto (igual à edição individual)
            const val23 = p.valor_elemento_53_23 ? parseFloat(p.valor_elemento_53_23).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '';
            const val24 = p.valor_elemento_53_24 ? parseFloat(p.valor_elemento_53_24).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '';
            const valPrevisto = p.valor_previsto ? parseFloat(p.valor_previsto).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '';
            const valSubtraido = p.valor_subtraido ? parseFloat(p.valor_subtraido).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '';
            const valEncaminhado = p.valor_encaminhado ? parseFloat(p.valor_encaminhado).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '';
            const valPago = p.valor_pago ? parseFloat(p.valor_pago).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '';
            
            console.log('🔍 DEBUG COLETIVA: Parcela ID', p.id, '- valor_pago:', p.valor_pago, '→ formatado:', valPago);
            
            tr.append($('<td>').html(`<input type="text" class="form-control form-control-sm campo-moeda edit-val-23" value="${val23}">`));
            tr.append($('<td>').html(`<input type="text" class="form-control form-control-sm campo-moeda edit-val-24" value="${val24}">`));
            tr.append($('<td>').html(`<input type="text" class="form-control form-control-sm campo-moeda edit-val-previsto" value="${valPrevisto}">`));
            tr.append($('<td>').html(`<input type="text" class="form-control form-control-sm campo-moeda edit-val-subtraido" value="${valSubtraido}">`));
            tr.append($('<td>').html(`<input type="text" class="form-control form-control-sm campo-moeda edit-val-encaminhado" value="${valEncaminhado}">`));
            tr.append($('<td>').html(`<input type="text" class="form-control form-control-sm campo-moeda edit-val-pago" value="${valPago}">`));
            
            // Status
            const selectStatus = `
                <select class="form-select form-select-sm edit-status">
                    <option value="Não Pago" ${p.parcela_status === 'Não Pago' ? 'selected' : ''}>Não Pago</option>
                    <option value="Encaminhado para Pagamento" ${p.parcela_status === 'Encaminhado para Pagamento' ? 'selected' : ''}>Encaminhado</option>
                    <option value="Pago" ${p.parcela_status === 'Pago' ? 'selected' : ''}>Pago</option>
                </select>`;
            tr.append($('<td>').html(selectStatus));
            
            // Status Secundário
            const selectStatusSec = `
                <select class="form-select form-select-sm edit-status-sec">
                    <option value="">-</option>
                    <option value="Parcial" ${p.parcela_status_secundario === 'Parcial' ? 'selected' : ''}>Parcial</option>
                    <option value="Integral" ${p.parcela_status_secundario === 'Integral' ? 'selected' : ''}>Integral</option>
                    <option value="Glosa" ${p.parcela_status_secundario === 'Glosa' ? 'selected' : ''}>Glosa</option>
                    <option value="Falta Certidão" ${p.parcela_status_secundario === 'Falta Certidão' ? 'selected' : ''}>Falta Certidão</option>
                    <option value="Falta encarte de Prestações" ${p.parcela_status_secundario === 'Falta encarte de Prestações' ? 'selected' : ''}>Falta encarte</option>
                    <option value="Aguardando Alteração" ${p.parcela_status_secundario === 'Aguardando Alteração' ? 'selected' : ''}>Aguardando Alteração</option>
                    <option value="Antigos" ${p.parcela_status_secundario === 'Antigos' ? 'selected' : ''}>Antigos</option>
                    <option value="Rescisão" ${p.parcela_status_secundario === 'Rescisão' ? 'selected' : ''}>Rescisão</option>
                </select>`;
            tr.append($('<td>').html(selectStatusSec));
            
            // Data Pagamento
            tr.append($('<td>').html(`<input type="date" class="form-control form-control-sm edit-data-pgto" value="${converterDataParaInput(p.data_pagamento) || ''}">`));
            
            tbody.append(tr);
        });
        
        // Aplicar máscaras monetárias aos inputs de valor
        $('#corpoTabelaColetiva .edit-val-23, #corpoTabelaColetiva .edit-val-24, #corpoTabelaColetiva .edit-val-previsto, #corpoTabelaColetiva .edit-val-subtraido, #corpoTabelaColetiva .edit-val-encaminhado, #corpoTabelaColetiva .edit-val-pago').each(function() {
            aplicarMascaraMonetaria(this);
        });
        
        // Adicionar eventos para recalcular subtotais ao editar
        $('#corpoTabelaColetiva').on('blur change', '.edit-val-23, .edit-val-24, .edit-val-previsto, .edit-val-subtraido, .edit-val-encaminhado, .edit-val-pago', function() {
            calcularSubtotais();
        });
        
        // Adicionar suporte para colar do Excel
        habilitarColarExcelColetiva();
        
        // Calcular subtotais iniciais
        calcularSubtotais();
    }
    
    // Adicionar nova linha vazia na tabela coletiva
    function adicionarNovaLinhaColetiva() {
        const tbody = $('#corpoTabelaColetiva');
        const tiposDisponiveis = window.tiposParcelaDisponiveis || ['Programada', 'Reprogramada', 'Devolvida'];
        
        // Criar nova linha SEM ID (será INSERT)
        const tr = $('<tr>'); // Sem data-parcela-id = nova parcela
        
        // Coluna de ações (botão excluir)
        const btnExcluir = $('<button>').
            addClass('btn btn-danger btn-sm').
            attr('type', 'button').
            html('<i class="bi bi-trash"></i>').
            on('click', function() {
                if (confirm('⚠️ Excluir esta parcela?')) {
                    tr.remove();
                    recalcularSubtotaisColetivos();
                }
            });
        tr.append($('<td>').append(btnExcluir));
        
        // Vigência Inicial - vazio
        tr.append($('<td>').html('<input type="month" class="form-control form-control-sm edit-vig-inicial" value="">'));
        
        // Vigência Final - vazio
        tr.append($('<td>').html('<input type="month" class="form-control form-control-sm edit-vig-final" value="">'));
        
        // Tipo Parcela - select
        let selectTipo = '<select class="form-select form-select-sm edit-tipo">';
        tiposDisponiveis.forEach(function(tipo) {
            selectTipo += `<option value="${tipo}">${tipo}</option>`;
        });
        selectTipo += '</select>';
        tr.append($('<td>').html(selectTipo));
        
        // Nº Parcela - vazio
        tr.append($('<td>').html('<input type="text" class="form-control form-control-sm edit-numero" value="">'));
        
        // Valores monetários - vazios
        tr.append($('<td>').html('<input type="text" class="form-control form-control-sm campo-moeda edit-val-23" value="">'));
        tr.append($('<td>').html('<input type="text" class="form-control form-control-sm campo-moeda edit-val-24" value="">'));
        tr.append($('<td>').html('<input type="text" class="form-control form-control-sm campo-moeda edit-val-previsto" value="">'));
        tr.append($('<td>').html('<input type="text" class="form-control form-control-sm campo-moeda edit-val-subtraido" value="">'));
        tr.append($('<td>').html('<input type="text" class="form-control form-control-sm campo-moeda edit-val-encaminhado" value="">'));
        tr.append($('<td>').html('<input type="text" class="form-control form-control-sm campo-moeda edit-val-pago" value="">'));
        
        // Status
        const selectStatus = `
            <select class="form-select form-select-sm edit-status">
                <option value="Não Pago" selected>Não Pago</option>
                <option value="Encaminhado para Pagamento">Encaminhado</option>
                <option value="Pago">Pago</option>
            </select>`;
        tr.append($('<td>').html(selectStatus));
        
        // Status Secundário
        const selectStatusSec = `
            <select class="form-select form-select-sm edit-status-sec">
                <option value="" selected>-</option>
                <option value="Parcial">Parcial</option>
                <option value="Integral">Integral</option>
                <option value="Glosa">Glosa</option>
                <option value="Falta Certidão">Falta Certidão</option>
                <option value="Falta encarte de Prestações">Falta encarte</option>
                <option value="Aguardando Alteração">Aguardando Alteração</option>
                <option value="Antigos">Antigos</option>
                <option value="Rescisão">Rescisão</option>
            </select>`;
        tr.append($('<td>').html(selectStatusSec));
        
        // Data Pagamento - vazio
        tr.append($('<td>').html('<input type="date" class="form-control form-control-sm edit-data-pgto" value="">'));
        
        tbody.append(tr);
        
        // Aplicar máscaras monetárias
        tr.find('.campo-moeda').each(function() {
            aplicarMascaraMonetaria(this);
        });
        
        // Recalcular subtotais
        calcularSubtotais();
        
        // Atualizar contador
        $('#coletivo_total_parcelas').text($('#corpoTabelaColetiva tr').length);
    }
    
    // Alias para recalcular subtotais
    function recalcularSubtotaisColetivos() {
        calcularSubtotais();
        $('#coletivo_total_parcelas').text($('#corpoTabelaColetiva tr').length);
    }
    
    // Editar parcela
    function editarParcela(id) {
        $.ajax({
            url: `/gestao_financeira/ultra-liquidacoes/api/parcela/${id}`,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    const dados = response.data;
                    
                    console.log('🔍 DEBUG INDIVIDUAL: Dados recebidos da API:', dados);
                    console.log('🔍 DEBUG INDIVIDUAL: valor_pago bruto:', dados.valor_pago, 'tipo:', typeof dados.valor_pago);
                    
                    // Preencher aba individual
                    $('#edit_id').val(dados.id);
                    $('#info_numero_termo').text(dados.numero_termo);
                    $('#info_osc').text(dados.osc || '-');
                    $('#info_cnpj').text(dados.cnpj || '-');
                    $('#info_vigencia_parceria').text(`${dados.inicio_parceria} a ${dados.final_parceria}`);
                    
                    $('#edit_vigencia_inicial').val(converterDataParaInput(dados.vigencia_inicial));
                    $('#edit_vigencia_final').val(converterDataParaInput(dados.vigencia_final));
                    $('#edit_parcela_numero').val(dados.parcela_numero);
                    
                    // 🔧 Formatar valores monetários ao carregar
                    const val23 = dados.valor_elemento_53_23 ? parseFloat(dados.valor_elemento_53_23).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '';
                    const val24 = dados.valor_elemento_53_24 ? parseFloat(dados.valor_elemento_53_24).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '';
                    const valPrevisto = dados.valor_previsto ? parseFloat(dados.valor_previsto).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '';
                    const valSubtraido = dados.valor_subtraido ? parseFloat(dados.valor_subtraido).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '';
                    const valEncaminhado = dados.valor_encaminhado ? parseFloat(dados.valor_encaminhado).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '';
                    const valPago = dados.valor_pago ? parseFloat(dados.valor_pago).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '';
                    
                    console.log('🔍 DEBUG INDIVIDUAL: Valores formatados:');
                    console.log('  - val23:', val23);
                    console.log('  - val24:', val24);
                    console.log('  - valPrevisto:', valPrevisto);
                    console.log('  - valPago:', valPago);
                    
                    // 🔍 DEBUG: Verificar tipo e existência dos inputs
                    console.log('🔍 DEBUG INPUTS:');
                    console.log('  #edit_valor_elemento_53_23 - existe:', $('#edit_valor_elemento_53_23').length, 'type:', $('#edit_valor_elemento_53_23').attr('type'));
                    console.log('  #edit_valor_pago - existe:', $('#edit_valor_pago').length, 'type:', $('#edit_valor_pago').attr('type'));
                    
                    $('#edit_valor_elemento_53_23').val(val23);
                    console.log('  Após .val(val23), valor no campo:', $('#edit_valor_elemento_53_23').val());
                    
                    $('#edit_valor_elemento_53_24').val(val24);
                    $('#edit_valor_previsto').val(valPrevisto);
                    $('#edit_valor_subtraido').val(valSubtraido);
                    $('#edit_valor_encaminhado').val(valEncaminhado);
                    $('#edit_valor_pago').val(valPago);
                    console.log('  Após .val(valPago), valor no campo:', $('#edit_valor_pago').val());
                    
                    $('#edit_parcela_status').val(dados.parcela_status);
                    $('#edit_parcela_status_secundario').val(dados.parcela_status_secundario);
                    $('#edit_data_pagamento').val(converterDataParaInput(dados.data_pagamento));
                    $('#edit_observacoes').val(dados.observacoes);
                    
                    // Preencher select de tipos (individual)
                    const selectTipo = $('#edit_parcela_tipo');
                    selectTipo.empty().append('<option value="">Selecione...</option>');
                    dados.tipos_parcela_disponiveis.forEach(function(tipo) {
                        selectTipo.append($('<option>').val(tipo).text(tipo));
                    });
                    selectTipo.val(dados.parcela_tipo);
                    
                    // Verificar pagamento inconsistente
                    $('#edit_pagamento_inconsistente').prop('checked', dados.observacoes && dados.observacoes.includes('Pagamento inconsistente'));
                    
                    // Preencher aba coletiva
                    $('#coletivo_numero_termo_hidden').val(dados.numero_termo);
                    $('#coletivo_numero_termo').text(dados.numero_termo);
                    $('#coletivo_info_osc').text(dados.osc || '-');
                    $('#coletivo_info_cnpj').text(dados.cnpj || '-');
                    $('#coletivo_info_vigencia_parceria').text(`${dados.inicio_parceria} a ${dados.final_parceria}`);
                    
                    // Resetar para aba individual
                    $('#tab-individual').tab('show');
                    
                    $('#modalEditarParcela').modal('show');
                }
            },
            error: function(xhr) {
                alert('Erro ao carregar parcela: ' + (xhr.responseJSON?.error || 'Erro desconhecido'));
            }
        });
    }
    
    // Validar valores
    function validarValores() {
        const valor23 = parseMoedaBR($('#edit_valor_elemento_53_23').val()) || 0;
        const valor24 = parseMoedaBR($('#edit_valor_elemento_53_24').val()) || 0;
        const previsto = parseMoedaBR($('#edit_valor_previsto').val()) || 0;
        const subtraido = parseMoedaBR($('#edit_valor_subtraido').val()) || 0;
        const encaminhado = parseMoedaBR($('#edit_valor_encaminhado').val()) || 0;
        const pago = parseMoedaBR($('#edit_valor_pago').val()) || 0;
        const inconsistente = $('#edit_pagamento_inconsistente').is(':checked');
        
        let temErro = false;
        
        // Validação: 23 + 24 = Previsto
        if (Math.abs((valor23 + valor24) - previsto) > 0.01) {
            $('#edit_valor_previsto').addClass('campo-erro');
            $('#erro_valor_previsto').show();
            temErro = true;
        } else {
            $('#edit_valor_previsto').removeClass('campo-erro');
            $('#erro_valor_previsto').hide();
        }
        
        // Validação: Subtraído <= Previsto
        if (subtraido > previsto) {
            $('#edit_valor_subtraido').addClass('campo-erro');
            $('#erro_valor_subtraido').show();
            temErro = true;
        } else {
            $('#edit_valor_subtraido').removeClass('campo-erro');
            $('#erro_valor_subtraido').hide();
        }
        
        // Validação: Encaminhado <= (Previsto - Subtraído)
        if (encaminhado > (previsto - subtraido)) {
            $('#edit_valor_encaminhado').addClass('campo-erro');
            $('#erro_valor_encaminhado').show();
            temErro = true;
        } else {
            $('#edit_valor_encaminhado').removeClass('campo-erro');
            $('#erro_valor_encaminhado').hide();
        }
        
        // Validação: Pago (com checkbox inconsistente)
        if (!inconsistente && pago > previsto) {
            $('#edit_valor_pago').addClass('campo-erro');
            $('#erro_valor_pago').show();
            temErro = true;
        } else if (inconsistente && pago > previsto) {
            $('#edit_valor_pago').removeClass('campo-erro').addClass('campo-aviso');
            $('#erro_valor_pago').hide();
        } else {
            $('#edit_valor_pago').removeClass('campo-erro campo-aviso');
            $('#erro_valor_pago').hide();
        }
        
        return !temErro;
    }
    
    // Salvar parcela
    function salvarParcela() {
        // Verificar qual aba está ativa
        const abaAtiva = $('#tabsEdicao .nav-link.active').attr('id');
        
        if (abaAtiva === 'tab-coletiva') {
            salvarEdicaoColetiva();
        } else {
            salvarEdicaoIndividual();
        }
    }
    
    // Salvar edição individual
    function salvarEdicaoIndividual() {
        if (!validarValores()) {
            if (!confirm('Há erros de validação. Deseja salvar mesmo assim?')) {
                return;
            }
        }
        
        const id = $('#edit_id').val();
        const inconsistente = $('#edit_pagamento_inconsistente').is(':checked');
        let observacoes = $('#edit_observacoes').val();
        
        // Adicionar texto se marcou inconsistente e ainda não tem
        if (inconsistente && !observacoes.includes('Pagamento inconsistente')) {
            observacoes += (observacoes ? '\n' : '') + 'Pagamento inconsistente';
        }
        
        const dados = {
            vigencia_inicial: converterInputParaData($('#edit_vigencia_inicial').val()),
            vigencia_final: converterInputParaData($('#edit_vigencia_final').val()),
            parcela_tipo: $('#edit_parcela_tipo').val(),
            parcela_numero: $('#edit_parcela_numero').val(),
            valor_elemento_53_23: parseMoedaBR($('#edit_valor_elemento_53_23').val()),
            valor_elemento_53_24: parseMoedaBR($('#edit_valor_elemento_53_24').val()),
            valor_previsto: parseMoedaBR($('#edit_valor_previsto').val()),
            valor_subtraido: parseMoedaBR($('#edit_valor_subtraido').val()),
            valor_encaminhado: parseMoedaBR($('#edit_valor_encaminhado').val()),
            valor_pago: parseMoedaBR($('#edit_valor_pago').val()),
            parcela_status: $('#edit_parcela_status').val(),
            parcela_status_secundario: $('#edit_parcela_status_secundario').val(),
            data_pagamento: converterInputParaData($('#edit_data_pagamento').val()),
            observacoes: observacoes
        };
        
        console.log('Salvando parcela ID:', id);
        console.log('Dados enviados:', dados);
        
        $.ajax({
            url: `/gestao_financeira/ultra-liquidacoes/api/parcela/${id}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(dados),
            success: function(response) {
                console.log('Resposta do servidor:', response);
                if (response.success) {
                    $('#modalEditarParcela').modal('hide');
                    carregarDados();
                    alert('✅ Parcela atualizada com sucesso!');
                } else {
                    alert('⚠️ Erro: ' + (response.error || 'Resposta sem sucesso'));
                }
            },
            error: function(xhr) {
                console.error('Erro no AJAX:', xhr);
                alert('Erro ao salvar: ' + (xhr.responseJSON?.error || 'Erro desconhecido'));
            }
        });
    }
    
    // Array global para rastrear IDs originais (carregados do servidor)
    let parcelasOriginaisIds = [];
    
    // Salvar edição coletiva
    function salvarEdicaoColetiva() {
        const numeroTermo = $('#coletivo_numero_termo_hidden').val();
        
        // Coletar IDs das parcelas atualmente na tabela
        const idsAtual = [];
        const parcelas = [];
        
        $('#corpoTabelaColetiva tr').each(function() {
            const tr = $(this);
            const id = tr.data('parcela-id');
            
            // Se tem ID, adicionar à lista de IDs atuais
            if (id) {
                idsAtual.push(id);
            }
            
            // Pegar valores dos inputs
            const vigInicialInput = tr.find('.edit-vig-inicial').val();
            const vigFinalInput = tr.find('.edit-vig-final').val();
            
            // Converter datas
            const vigInicialConvertida = converterInputParaData(vigInicialInput);
            const vigFinalConvertida = converterInputParaData(vigFinalInput);
            
            // Debug: Log da conversão
            if (vigInicialInput) {
                console.log(`Vig Inicial: ${vigInicialInput} → ${vigInicialConvertida}`);
            }
            if (vigFinalInput) {
                console.log(`Vig Final: ${vigFinalInput} → ${vigFinalConvertida}`);
            }
            
            parcelas.push({
                id: id || null,  // null = nova parcela (INSERT)
                vigencia_inicial: vigInicialConvertida,
                vigencia_final: vigFinalConvertida,
                parcela_tipo: tr.find('.edit-tipo').val(),
                parcela_numero: tr.find('.edit-numero').val(),
                valor_elemento_53_23: desformatarValorMonetario(tr.find('.edit-val-23').val()),
                valor_elemento_53_24: desformatarValorMonetario(tr.find('.edit-val-24').val()),
                valor_previsto: desformatarValorMonetario(tr.find('.edit-val-previsto').val()),
                valor_subtraido: desformatarValorMonetario(tr.find('.edit-val-subtraido').val()),
                valor_encaminhado: desformatarValorMonetario(tr.find('.edit-val-encaminhado').val()),
                valor_pago: desformatarValorMonetario(tr.find('.edit-val-pago').val()),
                parcela_status: tr.find('.edit-status').val(),
                parcela_status_secundario: tr.find('.edit-status-sec').val(),
                data_pagamento: converterInputParaData(tr.find('.edit-data-pgto').val())
            });
        });
        
        // Identificar parcelas excluídas (estavam em parcelasOriginaisIds mas não estão em idsAtual)
        const idsExcluir = parcelasOriginaisIds.filter(id => !idsAtual.includes(id));
        
        // Confirmação
        const novas = parcelas.filter(p => !p.id).length;
        const editadas = parcelas.filter(p => p.id).length;
        const excluidas = idsExcluir.length;
        
        let mensagem = `⚠️ Confirma as alterações do termo ${numeroTermo}?\n\n`;
        if (novas > 0) mensagem += `• ${novas} parcela(s) nova(s)\n`;
        if (editadas > 0) mensagem += `• ${editadas} parcela(s) editada(s)\n`;
        if (excluidas > 0) mensagem += `• ${excluidas} parcela(s) excluída(s)\n`;
        
        if (!confirm(mensagem)) {
            return;
        }
        
        console.log('Salvando edição coletiva - Termo:', numeroTermo);
        console.log('Parcelas (total):', parcelas.length);
        console.log('IDs para excluir:', idsExcluir);
        
        $.ajax({
            url: `/gestao_financeira/ultra-liquidacoes/api/termo/${encodeURIComponent(numeroTermo)}/atualizar-multiplas`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({ 
                parcelas: parcelas,
                ids_excluir: idsExcluir
            }),
            success: function(response) {
                console.log('Resposta edição coletiva:', response);
                if (response.success) {
                    $('#modalEditarParcela').modal('hide');
                    carregarDados();
                    alert(`✅ ${response.message}`);
                } else {
                    alert('⚠️ Erro: ' + (response.error || 'Resposta sem sucesso'));
                }
            },
            error: function(xhr) {
                console.error('Erro no AJAX coletivo:', xhr);
                alert('Erro ao salvar edição coletiva: ' + (xhr.responseJSON?.error || 'Erro desconhecido'));
            }
        });
    }
    
    // Excluir parcela
    function excluirParcela(id) {
        if (!confirm('⚠️ Tem certeza que deseja excluir esta parcela?\n\nEsta ação não pode ser desfeita.')) {
            return;
        }
        
        $.ajax({
            url: `/gestao_financeira/ultra-liquidacoes/api/parcela/${id}`,
            method: 'DELETE',
            success: function(response) {
                if (response.success) {
                    carregarDados();
                    alert('✅ Parcela excluída com sucesso!');
                }
            },
            error: function(xhr) {
                alert('Erro ao excluir: ' + (xhr.responseJSON?.error || 'Erro desconhecido'));
            }
        });
    }
    
    // Exportar CSV
    function exportarCSV(modo) {
        let url = `/gestao_financeira/ultra-liquidacoes/api/exportar-csv?modo=${modo}&secao=${secaoAtual}`;
        
        // Se modo for 'filtrado', adicionar todos os filtros
        if (modo === 'filtrado') {
            // Filtros de texto
            const numeroTermo = $('#filtro_numero_termo').val();
            const osc = $('#filtro_osc').val();
            const cnpj = $('#filtro_cnpj').val();
            const parcelaTipo = $('#filtro_parcela_tipo').val();
            const parcelaNumero = $('#filtro_parcela_numero').val();
            const statusSecundario = $('#filtro_status_secundario').val();
            
            // Filtros de data
            const vigenciaInicialDe = $('#filtro_vigencia_inicial_de').val();
            const vigenciaInicialAte = $('#filtro_vigencia_inicial_ate').val();
            const vigenciaFinalDe = $('#filtro_vigencia_final_de').val();
            const vigenciaFinalAte = $('#filtro_vigencia_final_ate').val();
            const dataPagamentoDe = $('#filtro_data_pagamento_de').val();
            const dataPagamentoAte = $('#filtro_data_pagamento_ate').val();
            const anoVigencia = $('#filtro_ano_vigencia').val();
            
            // Adicionar à URL
            if (numeroTermo) url += `&numero_termo=${encodeURIComponent(numeroTermo)}`;
            if (osc) url += `&osc=${encodeURIComponent(osc)}`;
            if (cnpj) url += `&cnpj=${encodeURIComponent(cnpj)}`;
            if (parcelaTipo) url += `&parcela_tipo=${encodeURIComponent(parcelaTipo)}`;
            if (parcelaNumero) url += `&parcela_numero=${encodeURIComponent(parcelaNumero)}`;
            if (statusSecundario) url += `&status_secundario=${encodeURIComponent(statusSecundario)}`;
            if (vigenciaInicialDe) url += `&vigencia_inicial_de=${vigenciaInicialDe}`;
            if (vigenciaInicialAte) url += `&vigencia_inicial_ate=${vigenciaInicialAte}`;
            if (vigenciaFinalDe) url += `&vigencia_final_de=${vigenciaFinalDe}`;
            if (vigenciaFinalAte) url += `&vigencia_final_ate=${vigenciaFinalAte}`;
            if (dataPagamentoDe) url += `&data_pagamento_de=${dataPagamentoDe}`;
            if (dataPagamentoAte) url += `&data_pagamento_ate=${dataPagamentoAte}`;
            if (anoVigencia) url += `&ano_vigencia=${anoVigencia}`;
        }
        
        window.location.href = url;
    }
    
    // DEBUG: Função para validar cálculos de um termo
    function debugValidacaoTermo() {
        const numeroTermo = prompt('⚠️ DEBUG: Digite o número do termo para validar:');
        if (!numeroTermo) return;
        
        $.ajax({
            url: `/gestao_financeira/ultra-liquidacoes/api/debug-termo?numero_termo=${encodeURIComponent(numeroTermo)}`,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    let msg = `🔍 DEBUG - TERMO: ${numeroTermo}\n\n`;
                    msg += `📄 PARCELAS ENCONTRADAS:\n`;
                    msg += `  - Total de parcelas: ${response.total_parcelas}\n`;
                    msg += `  - Programadas: ${response.parcelas_programadas}\n`;
                    msg += `  - Projetadas: ${response.parcelas_projetadas}\n`;
                    msg += `  - Outras: ${response.parcelas_outras}\n\n`;
                    
                    msg += `💰 CÁLCULOS:\n`;
                    msg += `  - Soma Programadas: R$ ${response.soma_programadas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                    msg += `  - Soma Projetadas: R$ ${response.soma_projetadas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                    msg += `  - Soma TOTAL (todas): R$ ${response.soma_total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n\n`;
                    
                    msg += `📊 PARCERIA (public.parcerias):\n`;
                    msg += `  - Total Previsto: R$ ${response.total_previsto_parceria.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n\n`;
                    
                    msg += `✅ VALIDAÇÃO:\n`;
                    msg += `  - Diferença (Programadas - Parceria): R$ ${response.diferenca.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                    msg += `  - Status: ${response.status_validacao}\n\n`;
                    
                    if (response.detalhes_parcelas && response.detalhes_parcelas.length > 0) {
                        msg += `📋 DETALHES DAS PARCELAS:\n`;
                        response.detalhes_parcelas.forEach(p => {
                            msg += `  - ${p.tipo} | Parc ${p.numero} | Vig: ${p.vigencia} | Previsto: R$ ${p.valor_previsto.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                        });
                    }
                    
                    alert(msg);
                    console.log('DEBUG COMPLETO:', response);
                } else {
                    alert('⚠️ Erro: ' + response.error);
                }
            },
            error: function(xhr) {
                alert('❌ Erro ao buscar dados de debug: ' + (xhr.responseJSON?.error || 'Erro desconhecido'));
            }
        });
    }
    
    function debugRelatorioCompleto() {
        $.ajax({
            url: '/gestao_financeira/ultra-liquidacoes/api/debug-relatorio',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    // Criar janela popup com relatório formatado
                    const popup = window.open('', 'DEBUG Relatório', 'width=900,height=700,scrollbars=yes');
                    
                    let html = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>DEBUG - Relatório Completo</title>
                        <style>
                            body {
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                                padding: 20px;
                                background: #f8f9fa;
                            }
                            h1 {
                                color: #333;
                                border-bottom: 3px solid #007bff;
                                padding-bottom: 10px;
                            }
                            h2 {
                                color: #666;
                                margin-top: 30px;
                                background: #e9ecef;
                                padding: 10px;
                                border-left: 4px solid #ffc107;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin: 20px 0;
                                background: white;
                                box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                            }
                            th, td {
                                padding: 12px;
                                text-align: left;
                                border-bottom: 1px solid #ddd;
                            }
                            th {
                                background: #007bff;
                                color: white;
                                font-weight: bold;
                            }
                            tr:hover {
                                background: #f5f5f5;
                            }
                            .badge {
                                padding: 5px 10px;
                                border-radius: 4px;
                                font-size: 12px;
                            }
                            .badge-warning {
                                background: #ffc107;
                                color: #000;
                            }
                            .badge-danger {
                                background: #dc3545;
                                color: white;
                            }
                            .badge-success {
                                background: #28a745;
                                color: white;
                            }
                            .totais {
                                background: #fff3cd;
                                padding: 15px;
                                border-left: 4px solid #ffc107;
                                margin: 20px 0;
                            }
                            .btn-print {
                                background: #007bff;
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                cursor: pointer;
                                border-radius: 4px;
                                margin: 10px 0;
                            }
                            .btn-print:hover {
                                background: #0056b3;
                            }
                            @media print {
                                .btn-print {
                                    display: none;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        <h1>🐛 DEBUG - Relatório Completo de Ultra Liquidações</h1>
                        <button class="btn-print" onclick="window.print()">🖨️ Imprimir Relatório</button>
                        
                        <h2>📅 PRORROGAÇÕES DETECTADAS</h2>
                        <div class="totais">
                            <strong>Total de termos com prorrogação:</strong> ${response.total_prorrogacoes}
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Termo</th>
                                    <th>Edital</th>
                                    <th>OSC</th>
                                    <th>Período Parceria</th>
                                    <th>Meses Parceria</th>
                                    <th>Período UL</th>
                                    <th>Meses Preenchidos</th>
                                    <th>Meses Faltantes</th>
                                    <th>Total Cronograma</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    if (response.prorrogacoes && response.prorrogacoes.length > 0) {
                        response.prorrogacoes.forEach(p => {
                            html += `
                                <tr>
                                    <td><strong>${p.termo}</strong></td>
                                    <td style="font-size:11px;">${p.edital_nome || 'N/A'}</td>
                                    <td style="font-size:11px;">${p.osc || 'N/A'}</td>
                                    <td>${p.inicio_parceria} a ${p.fim_parceria}</td>
                                    <td><strong>${p.meses_parceria}</strong></td>
                                    <td>${p.min_vigencia_ul} a ${p.max_vigencia_ul}</td>
                                    <td><strong>${p.meses_preenchidos_ul}</strong></td>
                                    <td><span class="badge badge-warning">${p.meses_faltantes}</span></td>
                                    <td>${p.total_cronograma || 'R$ 0,00'}</td>
                                </tr>
                            `;
                        });
                    } else {
                        html += '<tr><td colspan="9" style="text-align:center;">Nenhuma prorrogação detectada</td></tr>';
                    }
                    
                    html += `
                            </tbody>
                        </table>
                        
                        <h2>💰 AVISOS DE CÁLCULO DE EMPENHOS</h2>
                        <div class="totais">
                            <strong>Total de avisos:</strong> ${response.total_avisos_empenhos}
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Termo</th>
                                    <th>Mensagem</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    if (response.avisos_empenhos && response.avisos_empenhos.length > 0) {
                        response.avisos_empenhos.forEach(a => {
                            const badgeClass = a.tipo === 'erro_geral' ? 'badge-danger' : 'badge-warning';
                            html += `
                                <tr>
                                    <td><span class="badge ${badgeClass}">${a.tipo}</span></td>
                                    <td><strong>${a.termo || 'N/A'}</strong></td>
                                    <td>${a.mensagem}</td>
                                </tr>
                            `;
                        });
                    } else {
                        html += '<tr><td colspan="3" style="text-align:center;"><span class="badge badge-success">✅ Nenhum aviso - Tudo funcionando corretamente</span></td></tr>';
                    }
                    
                    html += `
                            </tbody>
                        </table>
                        
                        <div class="totais">
                            <strong>ℹ️ Observações:</strong><br>
                            - <strong>Prorrogação detectada:</strong> Termo tem início antes ou fim depois das vigências registradas em Ultra Liquidações<br>
                            - <strong>Ajuste de datas:</strong> Se faltam ≤ 5 dias para fim do mês, considera mês seguinte (início) ou mês atual (fim)<br>
                            - <strong>Motivo "inicio < min_ul":</strong> Data de início da parceria é anterior à primeira vigência em UL<br>
                            - <strong>Motivo "final > max_ul":</strong> Data final da parceria é posterior à última vigência em UL<br>
                            - <strong>Motivo "ambos":</strong> Ambas as condições acima são verdadeiras<br>
                            - <strong>Avisos de empenhos:</strong> Erros ao calcular empenhos (tabela back_empenhos pode não existir ou ter problemas)
                        </div>
                    </body>
                    </html>
                    `;
                    
                    popup.document.write(html);
                    popup.document.close();
                } else {
                    alert('⚠️ Erro: ' + response.error);
                }
            },
            error: function(xhr) {
                alert('❌ Erro ao buscar relatório de debug: ' + (xhr.responseJSON?.error || 'Erro desconhecido'));
            }
        });
    }
    
    // ==================== FUNÇÕES PARA CRONOGRAMA MENSAL ====================
    
    let termoSelecionadoGlobal = null;
    
    // Helper: Converter valor digitado em Info Alteração para formato do banco
    function converterInfoAlteracao(valor) {
        if (!valor || valor.trim() === '' || valor.trim() === '-') {
            return 'Base';
        }
        
        const numero = parseInt(valor.trim());
        if (!isNaN(numero) && numero > 0) {
            return `Aditivo ${numero}`;
        }
        
        return 'Base'; // Fallback para valores inválidos
    }
    
    // Abrir modal de adicionar parcelas
    function abrirModalAdicionarParcelas() {
        // RESET COMPLETO DO MODAL
        console.log('🔄 Resetando modal completamente...');
        
        // Resetar variável global
        termoSelecionadoGlobal = null;
        modoParcelasProjetadas = false;
        
        // Resetar checkboxes
        $('#chk_parcelas_projetadas').prop('checked', false);
        
        // Limpar campos
        $('#novo_numero_termo').val('');
        $('#input_termo_colaboracao').val('');
        $('#info_termo_selecionado').hide();
        
        // Limpar tabelas
        $('#corpo_cronograma').empty();
        $('#corpo_parcelas_finais').empty();
        
        // ⚡ CRÍTICO: Resetar estado dos botões de salvar
        $('#btnSalvarCronograma').prop('disabled', false).html('💾 Salvar Cronograma e Prosseguir');
        $('#btnConfirmarParcelas').prop('disabled', false).html('✅ Confirmar e Salvar Parcelas');
        console.log('🔘 Botões resetados: Salvar e Confirmar');
        
        // Esconder TODAS as fases e botões
        $('#fase1_selecao').hide();
        $('#fase2_cronograma').hide();
        $('#fase3_parcelas').hide();
        $('#btnAvancarCronograma').hide();
        $('#btnSalvarCronograma').hide();
        $('#btnVoltarFase1').hide();
        $('#btnVoltarFase2').hide();
        $('#btnConfirmarParcelas').hide();
        
        // Mostrar apenas FASE 1
        $('#fase1_selecao').show();
        
        // Abrir modal
        $('#modalAdicionarParcelas').modal('show');
        
        // Carregar termos disponíveis
        carregarTermosDisponiveis();
        
        console.log('✅ Modal resetado para FASE 1');
    }
    
    // Voltar para fase 1 (seleção do termo)
    function voltarParaFase1() {
        $('#fase2_cronograma').hide();
        $('#fase1_selecao').show();
        $('#btnSalvarCronograma').hide();
        $('#btnAvancarCronograma').show();
        $('#btnVoltarFase1').hide();
    }
    
    // Gerar meses entre duas datas
    function gerarMesesVigencia(dataInicio, dataFim) {
        const meses = [];
        const inicio = new Date(dataInicio);
        const fim = new Date(dataFim);
        
        // Ajustar para primeiro dia do mês
        inicio.setDate(1);
        
        while (inicio <= fim) {
            const mesAno = {
                data: new Date(inicio),
                mesNome: inicio.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' }),
                mes: inicio.getMonth() + 1,
                ano: inicio.getFullYear()
            };
            meses.push(mesAno);
            inicio.setMonth(inicio.getMonth() + 1);
        }
        
        return meses;
    }
    
    // Calcular número da parcela baseado no tipo
    function calcularNumeroParcela(indexMes, tipoParcela, totalMeses, mes, ano) {
        if (tipoParcela === 'unica') {
            return 'Parcela Única';
        }
        
        if (tipoParcela === 'mensal') {
            return `${indexMes + 1}ª Parcela`;
        }
        
        if (tipoParcela === 'trimestral') {
            const parcelaIdx = Math.floor(indexMes / 3);
            const mesNaParcela = indexMes % 3;
            
            // Verificar se muda de ano
            const mesAtual = mes;
            const anoAtual = ano;
            
            // Se é primeiro mês da parcela (0, 3, 6...)
            if (mesNaParcela === 0) {
                // Verificar se os próximos 2 meses estão no mesmo ano
                const proximoMes2 = new Date(anoAtual, mesAtual - 1 + 2, 1);
                if (proximoMes2.getFullYear() > anoAtual) {
                    return `${parcelaIdx + 1}ª Parcela Parcial`;
                }
                return `${parcelaIdx + 1}ª Parcela`;
            } else {
                // Se é continuação e passou de ano
                const mesAnterior = new Date(anoAtual, mesAtual - 2, 1);
                if (mesAnterior.getFullYear() < anoAtual) {
                    return `${parcelaIdx + 1}ª Parcela Complementar`;
                }
                return `${parcelaIdx + 1}ª Parcela`;
            }
        }
        
        if (tipoParcela === 'semestral') {
            const parcelaIdx = Math.floor(indexMes / 6);
            const mesNaParcela = indexMes % 6;
            
            const mesAtual = mes;
            const anoAtual = ano;
            
            // Verificar se cruza ano
            const inicioSemestre = new Date(anoAtual, mesAtual - 1 - mesNaParcela, 1);
            const fimSemestre = new Date(anoAtual, mesAtual - 1 + (5 - mesNaParcela), 1);
            
            const anoInicio = inicioSemestre.getFullYear();
            const anoFim = fimSemestre.getFullYear();
            
            // Se o semestre cruza o ano
            if (anoInicio !== anoFim) {
                // Meses do ano anterior = Parcial
                if (anoAtual === anoInicio) {
                    return `${parcelaIdx + 1}ª Parcela Parcial`;
                }
                // Meses do ano seguinte = Complementar
                else {
                    return `${parcelaIdx + 1}ª Parcela Complementar`;
                }
            }
            
            return `${parcelaIdx + 1}ª Parcela`;
        }
        
        return '';
    }
    
    // Detectar tipo de parcela automático
    function detectarTipoParcela(termo) {
        // Emenda Parlamentar = Parcela Única
        if (termo.edital_nome && termo.edital_nome.includes('Sem Edital (EmendaParlamentar)')) {
            return 'unica';
        }
        
        // TCL - SESANA = Parcela Trimestral
        if (termo.numero_termo && termo.numero_termo.includes('TCL') && termo.numero_termo.includes('SESANA')) {
            return 'trimestral';
        }
        
        // Padrão = Parcela Semestral
        return 'semestral';
    }
    
    // Avançar para fase de cronograma
    function avancarParaCronograma() {
        const termo = termoSelecionadoGlobal;
        console.log('🚀 [avancarParaCronograma] Iniciando...', termo);
        
        if (!termo) {
            alert('⚠️ Selecione um termo antes de continuar.');
            return;
        }
        
        // Detectar se está em modo de parcelas projetadas
        modoParcelasProjetadas = $('#chk_parcelas_projetadas').is(':checked');
        console.log('🔍 Modo Parcelas Projetadas:', modoParcelasProjetadas);
        
        // Mudar de fase
        console.log('👁️ [avancarParaCronograma] Ocultando FASE 1...');
        $('#fase1_selecao').hide();
        
        console.log('👁️ [avancarParaCronograma] Mostrando FASE 2...');
        $('#fase2_cronograma').show();
        
        console.log('👁️ [avancarParaCronograma] Verificando se FASE 2 está visível:', $('#fase2_cronograma').is(':visible'));
        console.log('👁️ [avancarParaCronograma] Verificando tbody do cronograma:', $('#corpo_cronograma').length, 'encontrado(s)');
        
        console.log('👁️ [avancarParaCronograma] Alternando botões...');
        $('#btnAvancarCronograma').hide();
        $('#btnSalvarCronograma').show();
        $('#btnVoltarFase1').show();
        
        // Detectar tipo automático
        const tipoAuto = detectarTipoParcela(termo);
        $(`#tipo_${tipoAuto}`).prop('checked', true);
        
        // Mostrar sugestão
        let sugestaoTexto = '';
        if (tipoAuto === 'unica') {
            sugestaoTexto = '💡 Detectado: Emenda Parlamentar → Parcela Única';
        } else if (tipoAuto === 'trimestral') {
            sugestaoTexto = '💡 Detectado: TCL SESANA → Parcela Trimestral';
        } else {
            sugestaoTexto = '💡 Padrão: Parcela Semestral';
        }
        $('#tipo_parcela_sugestao').text(sugestaoTexto);
        
        // Se for modo projetadas, mostrar alerta
        if (modoParcelasProjetadas) {
            $('#aviso_salvar').show();
            const alertDiv = $('<div>')
                .addClass('alert alert-info alert-dismissible fade show')
                .html(`
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Modo: Parcelas Projetadas</strong><br>
                    Os meses já cadastrados aparecerão bloqueados (cinza). Você pode apenas adicionar novos meses ao final.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `);
            $('#fase2_cronograma').prepend(alertDiv);
        }
        
        // Tentar carregar cronograma existente
        carregarCronogramaExistente(termo.numero_termo);
        
        // Adicionar evento de mudança no tipo de parcela
        $('input[name="tipo_parcela_manual"]').off('change').on('change', function() {
            // Apenas atualizar números das parcelas sem recriar o cronograma
            atualizarNumerosParcelas();
        });
    }
    
    // Carregar cronograma existente do banco
    function carregarCronogramaExistente(numeroTermo) {
        console.log('🔍 Tentando carregar cronograma para:', numeroTermo);
        
        $.ajax({
            url: '/gestao_financeira/ultra-liquidacoes/api/carregar-cronograma',
            method: 'GET',
            data: { numero_termo: numeroTermo },
            success: function(response) {
                console.log('📥 Resposta do servidor:', response);
                
                if (response.success && response.cronograma && response.cronograma.length > 0) {
                    console.log('📋 Cronograma existente encontrado:', response.cronograma.length, 'linhas');
                    console.log('🔍 DEBUG: Dados recebidos do servidor:', response.cronograma.slice(0, 2));
                    
                    // ⚡ NOVO: Armazenar o último info_alteracao SALVO no banco
                    const ultimoRegistro = response.cronograma[response.cronograma.length - 1];
                    ultimoInfoAlteracaoSalvo = ultimoRegistro.info_alteracao || 'Base';
                    console.log('💾 Último info_alteracao SALVO no banco:', ultimoInfoAlteracaoSalvo);
                    
                    // CORREÇÃO: No modo parcelas projetadas, SEMPRE usar os dados salvos como referência
                    // para garantir que os meses batam exatamente com o que está no banco
                    if (modoParcelasProjetadas) {
                        console.log('✅ Modo projetadas: gerando cronograma com base nos dados salvos (datas corretas do banco)');
                        console.log('🔍 DEBUG: modoParcelasProjetadas = true, chamando gerarCronogramaDesdeZero()');
                        gerarCronogramaDesdeZero(response.cronograma);
                    } else if (termoSelecionadoGlobal && termoSelecionadoGlobal.inicio && termoSelecionadoGlobal.final) {
                        // Modo normal: gerar pela vigência do termo e popular valores
                        gerarCronograma();
                        popularValoresSalvos(response.cronograma);
                    } else {
                        // Fallback: sem datas no termo, usar dados salvos
                        console.log('⚠️ Termo sem datas, gerando cronograma apenas com dados salvos');
                        gerarCronogramaDesdeZero(response.cronograma);
                    }
                } else {
                    console.log('📋 Nenhum cronograma salvo. Gerando novo.');
                    gerarCronograma();
                }
            },
            error: function(xhr, status, error) {
                console.log('❌ Erro ao carregar cronograma:', error);
                console.log('❌ Status:', status);
                console.log('❌ Response:', xhr.responseText);
                console.log('⚠️ Gerando cronograma novo.');
                gerarCronograma();
            }
        });
    }
    
    // Popular valores salvos no cronograma já gerado
    function popularValoresSalvos(dadosSalvos) {
        console.log('📝 Populando valores salvos:', dadosSalvos.length, 'registros');
        console.log('📝 Primeiros 3 registros:', dadosSalvos.slice(0, 3));
        
        // Criar mapa de valores por data (YYYY-MM-DD)
        const valoresPorMes = {};
        let temDivergencia = false;
        
        dadosSalvos.forEach(function(dado) {
            // Normalizar data para YYYY-MM-DD (servidor envia como GMT string)
            const dataKey = new Date(dado.nome_mes).toISOString().split('T')[0];
            
            // VERIFICAR: se valor_mes_23 e valor_mes_24 são NULL/0, usar valor_mes
            let valor23 = dado.valor_mes_23;
            let valor24 = dado.valor_mes_24;
            
            // Se ambos são NULL/0 e valor_mes existe, usar valor_mes inteiro para 23
            if ((valor23 === null || valor23 === 0) && (valor24 === null || valor24 === 0) && dado.valor_mes) {
                console.log(`⚠️ Divergência detectada: Mês ${dado.nome_mes} tem valor_mes=${dado.valor_mes} mas sem divisão 23/24`);
                valor23 = dado.valor_mes;  // Colocar tudo em 23 por padrão
                valor24 = 0;
                temDivergencia = true;
            } else {
                valor23 = valor23 || 0;
                valor24 = valor24 || 0;
            }
            
            valoresPorMes[dataKey] = {
                valor_23: valor23,
                valor_24: valor24,
                parcela_numero: dado.parcela_numero || '',
                tem_divergencia: (valor23 + valor24) > 0 && dado.valor_mes && Math.abs((valor23 + valor24) - dado.valor_mes) > 0.01
            };
            console.log(`  📅 Mapeando: ${dado.nome_mes} → ${dataKey} → 23: ${valor23}, 24: ${valor24}`);
        });
        
        // Mostrar alerta de divergência se necessário
        if (temDivergencia) {
            const alertDiv = $('<div>')
                .addClass('alert alert-warning alert-dismissible fade show mt-3')
                .html(`
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Divergência Detectada:</strong> O cronograma possui valores em <code>valor_mes</code> 
                    mas não tem divisão em <code>valor_mes_23</code> e <code>valor_mes_24</code>. 
                    Os valores foram carregados em "Valor 53/23" para facilitar edição. 
                    <strong>Por favor, distribua os valores corretamente entre os elementos 23 e 24.</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `);
            $('#modal_adicionar .modal-body').prepend(alertDiv);
        }
        
        console.log('📊 Mapa de valores:', valoresPorMes);
        console.log('📊 Chaves do mapa:', Object.keys(valoresPorMes));
        
        // Percorrer linhas do cronograma e popular
        let linhasPopuladas = 0;
        totalMesesOriginais = 0;  // Resetar contador
        
        $('#corpo_cronograma tr').each(function(index) {
            const tr = $(this);
            const val23Input = tr.find('.cronograma-val-23');
            const val24Input = tr.find('.cronograma-val-24');
            
            const mes = parseInt(val23Input.data('mes'));
            const ano = parseInt(val23Input.data('ano'));
            
            if (isNaN(mes) || isNaN(ano)) {
                console.warn(`⚠️ Linha ${index + 1} sem data válida, pulando`);
                return;
            }
            
            // Criar chave YYYY-MM-DD (dia sempre 01)
            const dataKey = `${ano}-${String(mes).padStart(2, '0')}-01`;
            
            console.log(`  🔍 Linha ${index + 1}: Procurando ${dataKey} no mapa...`);
            
            if (valoresPorMes[dataKey]) {
                const valores = valoresPorMes[dataKey];
                
                const centavos23 = Math.round(valores.valor_23 * 100);
                const centavos24 = Math.round(valores.valor_24 * 100);
                
                console.log(`    ✅ ENCONTRADO! 23: ${centavos23} centavos, 24: ${centavos24} centavos`);
                
                val23Input.data('centavos', centavos23).val(formatarCentavosParaMoeda(centavos23));
                val24Input.data('centavos', centavos24).val(formatarCentavosParaMoeda(centavos24));
                
                // Se for modo projetadas, tornar campos readonly e destacar linha
                if (modoParcelasProjetadas) {
                    val23Input.prop('readonly', true).addClass('bg-light text-muted');
                    val24Input.prop('readonly', true).addClass('bg-light text-muted');
                    tr.css('background-color', '#f8f9fa');
                    tr.attr('data-readonly', 'true');  // Marcar linha como readonly
                    
                    // Remover botão de excluir se existir
                    tr.find('button').remove();
                    
                    totalMesesOriginais++;  // Contar meses que já existiam
                }
                
                console.log(`    ✅ Valores formatados: 23: "${val23Input.val()}", 24: "${val24Input.val()}"`);
                linhasPopuladas++;
            } else {
                console.log(`    ❌ NÃO ENCONTRADO no mapa`);
            }
        });
        
        console.log(`✅ ${linhasPopuladas} linhas populadas de ${$('#corpo_cronograma tr').length} totais`);
        recalcularTotaisCronograma();
        console.log('✅ Valores populados com sucesso!');
    }
    
    // Gerar cronograma diretamente dos dados salvos (quando não há datas no termo)
    function gerarCronogramaDesdeZero(dadosSalvos) {
        console.log('🆕 Gerando cronograma desde zero com', dadosSalvos.length, 'registros');
        console.log('🔍 DEBUG: Primeiro registro ANTES de ordenar:', dadosSalvos[0]);
        console.log('🔍 DEBUG: Último registro ANTES de ordenar:', dadosSalvos[dadosSalvos.length - 1]);
        
        const tbody = $('#corpo_cronograma');
        tbody.empty();
        
        // Ordenar por data
        dadosSalvos.sort((a, b) => new Date(a.nome_mes) - new Date(b.nome_mes));
        
        console.log('🔍 DEBUG: Primeiro registro DEPOIS de ordenar:', dadosSalvos[0]);
        console.log('🔍 DEBUG: nome_mes do primeiro:', dadosSalvos[0].nome_mes);
        console.log('🔍 DEBUG: Data parseada:', new Date(dadosSalvos[0].nome_mes));
        
        // Criar uma linha para cada registro
        dadosSalvos.forEach(function(dado, index) {
            const data = new Date(dado.nome_mes);
            // CORREÇÃO: Usar UTC para evitar problemas de timezone
            const mes = data.getUTCMonth() + 1;
            const ano = data.getUTCFullYear();
            
            if (index === 0) {
                console.log('🔍 DEBUG: Primeira linha sendo criada:');
                console.log('  - dado.nome_mes:', dado.nome_mes);
                console.log('  - data parseada:', data);
                console.log('  - mes extraído (UTC):', mes);
                console.log('  - ano extraído (UTC):', ano);
            }
            
            const meses = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
            const mesNome = `${meses[mes - 1]}/${String(ano).slice(-2)}`;
            
            if (index === 0) {
                console.log('  - mesNome gerado:', mesNome);
            }
            
            // Valores
            let valor23 = dado.valor_mes_23 || 0;
            let valor24 = dado.valor_mes_24 || 0;
            
            // Se ambos são 0 e valor_mes existe, usar valor_mes
            if (valor23 === 0 && valor24 === 0 && dado.valor_mes) {
                valor23 = dado.valor_mes;
            }
            
            const centavos23 = Math.round(valor23 * 100);
            const centavos24 = Math.round(valor24 * 100);
            
            const tr = $('<tr>');
            
            // Checkbox "Salvar?" - desmarcado se for linha existente em modo projetadas
            const tdCheck = $('<td>').addClass('text-center');
            const checkbox = $('<input>').attr({
                type: 'checkbox',
                class: 'form-check-input cronograma-checkbox-salvar',
                checked: !modoParcelasProjetadas // Desmarcado se modo projetadas (são linhas existentes)
            });
            if (modoParcelasProjetadas) {
                checkbox.prop('disabled', true); // Desabilitar em linhas existentes
            }
            tdCheck.append(checkbox);
            tr.append(tdCheck);
            
            // Info Alteração - input editável com conversão automática
            const infoAlteracao = dado.info_alteracao || 'Base';
            const tdInfoAlteracao = $('<td>');
            
            // Converter de "Base" ou "Aditivo X" para formato editável ("-" ou "X")
            let valorDisplay = '-'; // Padrão para Base
            if (infoAlteracao !== 'Base') {
                const match = infoAlteracao.match(/Aditivo (\d+)/);
                if (match) {
                    valorDisplay = match[1];
                }
            }
            
            const inputInfoAlteracao = $('<input>').attr({
                type: 'text',
                maxlength: '2',
                placeholder: '-'
            }).addClass('form-control form-control-sm text-center cronograma-info-alteracao').val(valorDisplay);
            tdInfoAlteracao.append(inputInfoAlteracao);
            tr.append(tdInfoAlteracao);
            
            tr.append($('<td>').addClass('fw-bold').text(mesNome));
            
            const input23 = $('<input>')
                .attr('type', 'text')
                .addClass('form-control form-control-sm cronograma-val-23')
                .data('mes', mes)
                .data('ano', ano)
                .data('centavos', centavos23)
                .val(formatarCentavosParaMoeda(centavos23));
            
            const input24 = $('<input>')
                .attr('type', 'text')
                .addClass('form-control form-control-sm cronograma-val-24')
                .data('mes', mes)
                .data('ano', ano)
                .data('centavos', centavos24)
                .val(formatarCentavosParaMoeda(centavos24));
            
            // Se for modo projetadas, tornar readonly
            if (modoParcelasProjetadas) {
                input23.prop('readonly', true).addClass('bg-light text-muted');
                input24.prop('readonly', true).addClass('bg-light text-muted');
                tr.css('background-color', '#f8f9fa');
                tr.attr('data-readonly', 'true');  // Marcar linha como readonly
                totalMesesOriginais++;
            }
            
            tr.append($('<td>').html(input23));
            tr.append($('<td>').html(input24));
            
            // ⚡ CORREÇÃO: Calcular Total Mês a partir dos valores 53-23 e 53-24 (não usar valor_mes do banco)
            // O valor_mes do banco pode estar desatualizado se o usuário editou manualmente
            const totalMesCalculado = (centavos23 + centavos24) / 100;
            // Adiciona atributo data-valor-mes-banco para uso na divergência
            tr.attr('data-valor-mes-banco', dado.valor_mes !== null ? dado.valor_mes : '');
            const tdTotalMes = $('<td>').addClass('cronograma-total-mes fw-bold text-end').text('R$ ' + totalMesCalculado.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
            // Badge de divergência (apenas se houver)
            const valorMesBanco = dado.valor_mes !== null ? parseFloat(dado.valor_mes) : 0;
            const divergente = Math.abs(totalMesCalculado - valorMesBanco) > 0.01;
            if (divergente) {
                tdTotalMes.append(
                    $('<span>').addClass('badge bg-danger ms-2 badge-divergencia').text('Divergência: ' + (totalMesCalculado > valorMesBanco ? '+' : '-') + 'R$ ' + Math.abs(totalMesCalculado - valorMesBanco).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}))
                );
            }
            tr.append(tdTotalMes);
            
            // Nº da Parcela - editável se linha nova no modo projetadas
            const tdParcela = $('<td>').addClass('text-muted');
            const parcelaNumero = dado.parcela_numero || '';
            tdParcela.text(parcelaNumero);
            tdParcela.attr('data-parcela-numero', parcelaNumero);
            tr.append(tdParcela);
            
            // Botão de excluir apenas na última linha E se não for modo projetadas
            const tdAcao = $('<td>').addClass('text-center');
            if (index === dadosSalvos.length - 1 && !modoParcelasProjetadas) {
                const btnExcluir = $('<button>')
                    .addClass('btn btn-sm btn-outline-danger')
                    .html('<i class="bi bi-trash"></i>')
                    .attr('title', 'Excluir última linha')
                    .on('click', function() {
                        excluirUltimaLinhaCronograma();
                    });
                tdAcao.append(btnExcluir);
            }
            tr.append(tdAcao);
            
            tbody.append(tr);
        });
        
        aplicarEventosCronograma();
        recalcularTotaisCronograma();
        
        console.log('✅ Cronograma gerado desde zero com', dadosSalvos.length, 'linhas');
    }
    
    // Gerar cronograma baseado no termo selecionado
    function gerarCronograma() {
        const termo = termoSelecionadoGlobal;
        console.log('🔍 [gerarCronograma] termoSelecionadoGlobal:', termo);
        
        if (!termo) {
            console.error('❌ [gerarCronograma] termo é null ou undefined');
            return;
        }
        
        if (!termo.inicio || !termo.final) {
            console.error('❌ [gerarCronograma] termo não tem propriedades inicio/final:', termo);
            alert('⚠️ Erro: Termo selecionado não possui datas de vigência.\nPropriedades disponíveis: ' + Object.keys(termo).join(', '));
            return;
        }
        
        const tipoParcela = $('input[name="tipo_parcela_manual"]:checked').val();
        console.log('🔍 [gerarCronograma] tipoParcela:', tipoParcela);
        
        // Converter datas (vem em formato dd/mm/yyyy)
        console.log('🔍 [gerarCronograma] termo.inicio:', termo.inicio, 'termo.final:', termo.final);
        const partesInicio = termo.inicio.split('/');
        const partesFim = termo.final.split('/');
        const dataInicio = new Date(partesInicio[2], partesInicio[1] - 1, partesInicio[0]);
        const dataFim = new Date(partesFim[2], partesFim[1] - 1, partesFim[0]);
        console.log('🔍 [gerarCronograma] dataInicio:', dataInicio, 'dataFim:', dataFim);
        
        const meses = gerarMesesVigencia(dataInicio, dataFim);
        console.log('📊 [gerarCronograma] Total de meses gerados:', meses.length);
        console.log('📊 [gerarCronograma] Meses:', meses);
        
        const tbody = $('#corpo_cronograma');
        tbody.empty();
        
        if (meses.length === 0) {
            console.error('❌ [gerarCronograma] Nenhum mês gerado!');
            alert('⚠️ Erro: Não foi possível gerar cronograma.\nVerifique se as datas de vigência estão corretas.');
            return;
        }
        
        console.log('🔨 [gerarCronograma] Iniciando construção de linhas da tabela...');
        
        meses.forEach(function(mesObj, index) {
            const numeroParcela = calcularNumeroParcela(index, tipoParcela, meses.length, mesObj.mes, mesObj.ano);
            
            const tr = $('<tr>');
            
            // Checkbox "Salvar?" - sempre marcado ao gerar novo
            const tdCheck = $('<td>').addClass('text-center');
            const checkbox = $('<input>').attr({
                type: 'checkbox',
                class: 'form-check-input cronograma-checkbox-salvar',
                checked: true
            });
            tdCheck.append(checkbox);
            tr.append(tdCheck);
            
            // Info Alteração - input editável com conversão automática (padrão: Base = "-")
            const tdInfoAlteracao = $('<td>');
            const inputInfoAlteracao = $('<input>').attr({
                type: 'text',
                maxlength: '2',
                placeholder: '-'
            }).addClass('form-control form-control-sm text-center cronograma-info-alteracao').val('-');
            tdInfoAlteracao.append(inputInfoAlteracao);
            tr.append(tdInfoAlteracao);
            
            tr.append($('<td>').addClass('fw-bold').text(mesObj.mesNome));
            tr.append($('<td>').html(`<input type="text" class="form-control form-control-sm cronograma-val-23" data-mes="${mesObj.mes}" data-ano="${mesObj.ano}" value="0,00">`));
            tr.append($('<td>').html(`<input type="text" class="form-control form-control-sm cronograma-val-24" data-mes="${mesObj.mes}" data-ano="${mesObj.ano}" value="0,00">`));
            tr.append($('<td>').addClass('cronograma-total-mes fw-bold text-end').text('R$ 0,00'));
            
            // Nº da Parcela - editável no modo projetadas, readonly no modo normal
            const tdParcela = $('<td>');
            if (modoParcelasProjetadas) {
                const inputParcela = $('<input>').attr({
                    type: 'text',
                    class: 'form-control form-control-sm cronograma-input-parcela',
                    placeholder: 'Ex: 1ª Parcela',
                    value: numeroParcela
                });
                tdParcela.html(inputParcela);
            } else {
                tdParcela.addClass('text-muted').text(numeroParcela);
            }
            tdParcela.attr('data-parcela-numero', numeroParcela);
            tr.append(tdParcela);
            
            // Adicionar botão de excluir apenas para a última linha
            const tdAcao = $('<td>').addClass('text-center');
            if (index === meses.length - 1) {
                const btnExcluir = $('<button>')
                    .addClass('btn btn-sm btn-outline-danger')
                    .html('<i class="bi bi-trash"></i>')
                    .attr('title', 'Excluir última linha')
                    .on('click', function() {
                        excluirUltimaLinhaCronograma();
                    });
                tdAcao.append(btnExcluir);
            }
            tr.append(tdAcao);
            
            tbody.append(tr);
        });
        
        console.log('✅ [gerarCronograma] Linhas adicionadas ao tbody. Total:', $('#corpo_cronograma tr').length);
        
        aplicarEventosCronograma();
        recalcularTotaisCronograma();
        
        console.log('✅ [gerarCronograma] Cronograma gerado com sucesso!');
    }
    
    // Aplicar eventos de calculadora aos campos do cronograma
    function aplicarEventosCronograma() {
        // Inicializar campos vazios com 0,00
        $('.cronograma-val-23, .cronograma-val-24').each(function() {
            if (!$(this).data('centavos')) {
                $(this).val('0,00').data('centavos', 0);
            }
        });
        
        // Evento PASTE para campo de Nº Parcela
        $('.cronograma-input-parcela').off('paste').on('paste', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const clipboardData = e.originalEvent.clipboardData || window.clipboardData;
            const pastedData = clipboardData.getData('text');
            
            console.log('🔍 PASTE detectado no Nº Parcela:', pastedData);
            
            if (!pastedData.trim()) return;
            
            // Separar por quebras de linha
            const linhas = pastedData.split(/\r?\n/).filter(l => l.trim());
            const celulaAtual = $(this).closest('tr');
            const indexAtual = celulaAtual.index();
            
            console.log('📋 Colando', linhas.length, 'valores de Nº Parcela');
            
            // Colar valores em sequência
            linhas.forEach((linha, offset) => {
                const indexDestino = indexAtual + offset;
                const trDestino = $('#corpo_cronograma tr').eq(indexDestino);
                
                if (trDestino.length > 0) {
                    const campoNumParcela = trDestino.find('.cronograma-input-parcela');
                    
                    if (campoNumParcela.length > 0) {
                        // Pegar primeiro valor se tiver tabs (múltiplas colunas)
                        let valor = linha.trim();
                        if (valor.includes('\t')) {
                            valor = valor.split('\t')[0].trim();
                        }
                        
                        campoNumParcela.val(valor);
                        console.log(`  → Linha ${indexDestino + 1}: ${valor}`);
                    }
                }
            });
            
            console.log('✅ Paste de Nº Parcela concluído!');
        });
        
        // Evento PASTE com alta prioridade (antes do keydown)
        $('.cronograma-val-23, .cronograma-val-24').off('paste').on('paste', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const clipboardData = e.originalEvent.clipboardData || window.clipboardData;
            const pastedData = clipboardData.getData('text');
            
            console.log('🔍 PASTE detectado:', pastedData);
            
            // Se vazio, não fazer nada
            if (!pastedData.trim()) return;
            
            // Separar por quebras de linha (múltiplas células do Excel)
            const linhas = pastedData.split(/\r?\n/).filter(l => l.trim());
            
            // Determinar se é coluna 23 ou 24
            const isCol23 = $(this).hasClass('cronograma-val-23');
            const celulaAtual = $(this).closest('tr');
            const indexAtual = celulaAtual.index();
            
            console.log('📋 Colando', linhas.length, 'valores na coluna', isCol23 ? '53-23' : '53-24');
            
            // Colar valores em sequência
            linhas.forEach((linha, offset) => {
                const indexDestino = indexAtual + offset;
                const trDestino = $('#corpo_cronograma tr').eq(indexDestino);
                
                if (trDestino.length > 0) {
                    const campo = isCol23 ? trDestino.find('.cronograma-val-23') : trDestino.find('.cronograma-val-24');
                    
                    // Limpar e formatar valor
                    let valorLimpo = linha.trim();
                    
                    // Se contém tab (Excel com múltiplas colunas), pegar primeira coluna
                    if (valorLimpo.includes('\t')) {
                        valorLimpo = valorLimpo.split('\t')[0];
                    }
                    
                    // Remover espaços, R$, etc
                    valorLimpo = valorLimpo.replace(/[^\d,.-]/g, '');
                    
                    // Converter formatos comuns: "1.234,56" ou "1234.56" para centavos
                    // Se contém vírgula, é formato BR (1.234,56)
                    if (valorLimpo.includes(',')) {
                        valorLimpo = valorLimpo.replace(/\./g, '').replace(',', '.');
                    }
                    // Senão, é formato US (1234.56) - já está ok
                    
                    const valorNum = parseFloat(valorLimpo) || 0;
                    const centavos = Math.round(valorNum * 100);
                    
                    console.log('  →', linha, '→', valorLimpo, '→', valorNum, '→', centavos, 'centavos');
                    
                    // Atualizar campo com formato calculadora
                    campo.data('centavos', centavos);
                    campo.val(formatarCentavosParaMoeda(centavos));
                }
            });
            
            recalcularTotaisCronograma();
            console.log('✅ Paste concluído!');
        });
        
        // ⚡ NOVO: Adicionar evento de blur para recalcular quando usuário editar manualmente
        $('.cronograma-val-23, .cronograma-val-24').off('blur').on('blur', function() {
            // Recalcular ao sair do campo para garantir que Total Mês está atualizado
            recalcularTotaisCronograma();
        });
        
        $('.cronograma-val-23, .cronograma-val-24').off('keydown').on('keydown', function(e) {
            // Enter: deixar para navegação (não processar aqui)
            if (e.key === 'Enter' || e.keyCode === 13) {
                // NÃO prevenir default - deixar o evento bubbling acontecer
                return true; // Deixar para função de navegação capturar
            }
            
            // Permitir Ctrl+C, Ctrl+V, Ctrl+X, Ctrl+A
            if (e.ctrlKey || e.metaKey) {
                console.log('⌨️ Atalho detectado:', e.keyCode);
                return true; // Permitir atalhos de teclado
            }
            
            // Permitir apenas números, backspace, delete, tab, setas (removido enter da lista)
            const allowed = [8, 9, 37, 38, 39, 40, 46, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105];
            
            if (!allowed.includes(e.keyCode)) {
                e.preventDefault();
                return false;
            }
            
            // Se for número
            if ((e.keyCode >= 48 && e.keyCode <= 57) || (e.keyCode >= 96 && e.keyCode <= 105)) {
                e.preventDefault();
                
                const numero = e.keyCode >= 96 ? e.keyCode - 96 : e.keyCode - 48;
                let centavos = parseInt($(this).data('centavos') || 0);
                
                // Adicionar dígito (multiplicar por 10 e somar)
                centavos = centavos * 10 + numero;
                
                // Limitar a 999999999 centavos (9.999.999,99)
                if (centavos > 999999999) {
                    centavos = 999999999;
                }
                
                $(this).data('centavos', centavos);
                $(this).val(formatarCentavosParaMoeda(centavos));
                recalcularTotaisCronograma();
            }
            // Se for backspace
            else if (e.keyCode === 8) {
                e.preventDefault();
                
                let centavos = parseInt($(this).data('centavos') || 0);
                centavos = Math.floor(centavos / 10);
                
                $(this).data('centavos', centavos);
                $(this).val(formatarCentavosParaMoeda(centavos));
                recalcularTotaisCronograma();
            }
        });
    }
    
    // Excluir última linha do cronograma
    function atualizarNumerosParcelas() {
        const tipoParcela = $('input[name="tipo_parcela_manual"]:checked').val();
        const totalLinhas = $('#corpo_cronograma tr').length;
        
        $('#corpo_cronograma tr').each(function(index) {
            const tr = $(this);
            const input = tr.find('.cronograma-val-23');
            const mes = parseInt(input.data('mes'));
            const ano = parseInt(input.data('ano'));
            
            const numeroParcela = calcularNumeroParcela(index, tipoParcela, totalLinhas, mes, ano);
            // Coluna 6 = Nº Parcela (0:Salvar, 1:Info, 2:Mês, 3:Val23, 4:Val24, 5:Total, 6:Parcela, 7:Ação)
            tr.find('td').eq(6).text(numeroParcela);
        });
        
        console.log(`✅ Números de parcelas atualizados para tipo: ${tipoParcela}`);
    }
    
    function adicionarLinhaCronograma() {
        const totalLinhas = $('#corpo_cronograma tr').length;
        
        if (totalLinhas === 0) {
            alert('⚠️ Erro: não há linhas no cronograma para calcular o próximo mês.');
            return;
        }
        
        // Pegar última linha para calcular próximo mês
        const ultimaLinha = $('#corpo_cronograma tr:last');
        const ultimoInput = ultimaLinha.find('.cronograma-val-23');
        const ultimoMes = parseInt(ultimoInput.data('mes'));
        const ultimoAno = parseInt(ultimoInput.data('ano'));
        
        // Calcular próximo mês/ano
        let proximoMes = ultimoMes + 1;
        let proximoAno = ultimoAno;
        
        if (proximoMes > 12) {
            proximoMes = 1;
            proximoAno = ultimoAno + 1;
        }
        
        // Obter nome do mês
        const meses = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
        const mesNome = `${meses[proximoMes - 1]}/${String(proximoAno).slice(-2)}`;
        
        // Calcular número da parcela com base no tipo de parcela selecionado
        const tipoParcela = $('input[name="tipo_parcela_manual"]:checked').val();
        const numeroParcela = calcularNumeroParcela(totalLinhas, tipoParcela, totalLinhas + 1, proximoMes, proximoAno);
        
        // Remover botão de excluir da antiga última linha
        ultimaLinha.find('td:last').empty();
        
        // Criar nova linha
        const tr = $('<tr>');
        
        // Checkbox "Salvar?" - marcado para linha nova
        const tdCheck = $('<td>').addClass('text-center');
        const checkbox = $('<input>').attr({
            type: 'checkbox',
            class: 'form-check-input cronograma-checkbox-salvar',
            checked: true
        });
        tdCheck.append(checkbox);
        tr.append(tdCheck);
        
        // Info Alteração - input editável com conversão automática
        const tdInfoAlteracao = $('<td>');
        
        // ⚡ CORRETO: Se modo projetadas, usar o último valor SALVO NO BANCO (não última linha da tabela)
        let valorDisplay = '-';
        if (modoParcelasProjetadas) {
            console.log('🔍 Usando ultimoInfoAlteracaoSalvo do banco:', ultimoInfoAlteracaoSalvo);
            if (ultimoInfoAlteracaoSalvo === 'Base') {
                valorDisplay = '1'; // Primeiro aditivo
            } else if (ultimoInfoAlteracaoSalvo && ultimoInfoAlteracaoSalvo.startsWith('Aditivo ')) {
                const numeroAtual = parseInt(ultimoInfoAlteracaoSalvo.replace('Aditivo ', ''));
                if (!isNaN(numeroAtual)) {
                    valorDisplay = (numeroAtual + 1).toString();
                }
            }
            console.log('📝 Valor display para nova linha:', valorDisplay);
        }
        
        const inputInfoAlteracao = $('<input>').attr({
            type: 'text',
            maxlength: '2',
            placeholder: '-'
        }).addClass('form-control form-control-sm text-center cronograma-info-alteracao').val(valorDisplay);
        tdInfoAlteracao.append(inputInfoAlteracao);
        tr.append(tdInfoAlteracao);
        
        tr.append($('<td>').addClass('fw-bold').text(mesNome));
        tr.append($('<td>').html(`<input type="text" class="form-control form-control-sm cronograma-val-23" data-mes="${proximoMes}" data-ano="${proximoAno}" value="0,00">`));
        tr.append($('<td>').html(`<input type="text" class="form-control form-control-sm cronograma-val-24" data-mes="${proximoMes}" data-ano="${proximoAno}" value="0,00">`));
        tr.append($('<td>').addClass('cronograma-total-mes fw-bold text-end').text('R$ 0,00'));
        
        // Nº da Parcela - editável se modo projetadas
        const tdParcela = $('<td>');
        if (modoParcelasProjetadas) {
            const inputParcela = $('<input>').attr({
                type: 'text',
                class: 'form-control form-control-sm cronograma-input-parcela',
                placeholder: 'Ex: 2ª Parcela',
                value: numeroParcela
            });
            tdParcela.html(inputParcela);
        } else {
            tdParcela.addClass('text-muted').text(numeroParcela);
        }
        tdParcela.attr('data-parcela-numero', numeroParcela);
        tr.append(tdParcela);
        
        // Adicionar botão de excluir na nova última linha
        const tdAcao = $('<td>').addClass('text-center');
        const btnExcluir = $('<button>')
            .addClass('btn btn-sm btn-outline-danger')
            .html('<i class="bi bi-trash"></i>')
            .attr('title', 'Excluir última linha')
            .on('click', function() {
                excluirUltimaLinhaCronograma();
            });
        tdAcao.append(btnExcluir);
        tr.append(tdAcao);
        
        $('#corpo_cronograma').append(tr);
        
        // Aplicar eventos aos novos campos
        aplicarEventosCronograma();
        recalcularTotaisCronograma();
        
        // Scroll para a nova linha
        const container = $('#corpo_cronograma').closest('.table-responsive');
        container.scrollTop(container[0].scrollHeight);
        
        console.log(`✅ Linha adicionada: ${mesNome}, Parcela: ${numeroParcela}`);
    }
    
    function adicionarLinhaInicioCronograma() {
        const totalLinhas = $('#corpo_cronograma tr').length;
        
        if (totalLinhas === 0) {
            alert('⚠️ Erro: não há linhas no cronograma para calcular o mês anterior.');
            return;
        }
        
        // Pegar primeira linha para calcular mês anterior
        const primeiraLinha = $('#corpo_cronograma tr:first');
        const primeiroInput = primeiraLinha.find('.cronograma-val-23');
        const primeiroMes = parseInt(primeiroInput.data('mes'));
        const primeiroAno = parseInt(primeiroInput.data('ano'));
        
        // Calcular mês/ano anterior
        let anteriorMes = primeiroMes - 1;
        let anteriorAno = primeiroAno;
        
        if (anteriorMes < 1) {
            anteriorMes = 12;
            anteriorAno = primeiroAno - 1;
        }
        
        // Obter nome do mês
        const meses = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
        const mesNome = `${meses[anteriorMes - 1]}/${String(anteriorAno).slice(-2)}`;
        
        // Calcular número da parcela (será recalculado depois para todas as linhas)
        const tipoParcela = $('input[name="tipo_parcela_manual"]:checked').val();
        const numeroParcela = calcularNumeroParcela(0, tipoParcela, totalLinhas + 1, anteriorMes, anteriorAno);
        
        // Criar nova linha
        const tr = $('<tr>');
        
        // Checkbox "Salvar?" - marcado para linha nova
        const tdCheck = $('<td>').addClass('text-center');
        const checkbox = $('<input>').attr({
            type: 'checkbox',
            class: 'form-check-input cronograma-checkbox-salvar',
            checked: true
        });
        tdCheck.append(checkbox);
        tr.append(tdCheck);
        
        // Info Alteração - input editável com conversão automática
        const tdInfoAlteracao = $('<td>');
        
        // ⚡ CORRETO: Se modo projetadas, usar o último valor SALVO NO BANCO (não primeira linha da tabela)
        let valorDisplay = '-';
        if (modoParcelasProjetadas) {
            console.log('🔍 Usando ultimoInfoAlteracaoSalvo do banco:', ultimoInfoAlteracaoSalvo);
            if (ultimoInfoAlteracaoSalvo === 'Base') {
                valorDisplay = '1'; // Primeiro aditivo
            } else if (ultimoInfoAlteracaoSalvo && ultimoInfoAlteracaoSalvo.startsWith('Aditivo ')) {
                const numeroAtual = parseInt(ultimoInfoAlteracaoSalvo.replace('Aditivo ', ''));
                if (!isNaN(numeroAtual)) {
                    valorDisplay = (numeroAtual + 1).toString();
                }
            }
            console.log('📝 Valor display para nova linha (início):', valorDisplay);
        }
        
        const inputInfoAlteracao = $('<input>').attr({
            type: 'text',
            maxlength: '2',
            placeholder: '-'
        }).addClass('form-control form-control-sm text-center cronograma-info-alteracao').val(valorDisplay);
        tdInfoAlteracao.append(inputInfoAlteracao);
        tr.append(tdInfoAlteracao);
        
        tr.append($('<td>').addClass('fw-bold').text(mesNome));
        tr.append($('<td>').html(`<input type="text" class="form-control form-control-sm cronograma-val-23" data-mes="${anteriorMes}" data-ano="${anteriorAno}" value="0,00">`));
        tr.append($('<td>').html(`<input type="text" class="form-control form-control-sm cronograma-val-24" data-mes="${anteriorMes}" data-ano="${anteriorAno}" value="0,00">`));
        tr.append($('<td>').addClass('cronograma-total-mes fw-bold text-end').text('R$ 0,00'));
        
        // Nº da Parcela - editável se modo projetadas
        const tdParcela = $('<td>');
        if (modoParcelasProjetadas) {
            const inputParcela = $('<input>').attr({
                type: 'text',
                class: 'form-control form-control-sm cronograma-input-parcela',
                placeholder: 'Ex: 1ª Parcela',
                value: numeroParcela
            });
            tdParcela.html(inputParcela);
        } else {
            tdParcela.addClass('text-muted').text(numeroParcela);
        }
        tdParcela.attr('data-parcela-numero', numeroParcela);
        tr.append(tdParcela);
        tr.append($('<td>').addClass('text-center')); // Sem botão de excluir
        
        // Inserir no início
        $('#corpo_cronograma').prepend(tr);
        
        // Recalcular números de parcela de todas as linhas
        atualizarNumerosParcelas();
        
        // Garantir que apenas a última linha tenha botão de excluir
        $('#corpo_cronograma tr td:last-child').empty();
        const ultimaLinha = $('#corpo_cronograma tr:last');
        const tdAcao = ultimaLinha.find('td:last');
        const btnExcluir = $('<button>')
            .addClass('btn btn-sm btn-outline-danger')
            .html('<i class="bi bi-trash"></i>')
            .attr('title', 'Excluir última linha')
            .on('click', function() {
                excluirUltimaLinhaCronograma();
            });
        tdAcao.append(btnExcluir);
        
        // Aplicar eventos aos novos campos
        aplicarEventosCronograma();
        recalcularTotaisCronograma();
        
        // Scroll para o topo
        const container = $('#corpo_cronograma').closest('.table-responsive');
        container.scrollTop(0);
        
        console.log(`✅ Linha adicionada no início: ${mesNome}, Parcela: ${numeroParcela}`);
    }
    
    function excluirUltimaLinhaCronograma() {
        const totalLinhas = $('#corpo_cronograma tr').length;
        
        if (totalLinhas <= 1) {
            alert('⚠️ Não é possível excluir. O cronograma deve ter ao menos 1 mês.');
            return;
        }
        
        if (confirm('Deseja realmente excluir o último mês do cronograma?')) {
            // Remover última linha
            $('#corpo_cronograma tr:last').remove();
            
            // Remover botão de excluir da antiga penúltima linha (agora última)
            $('#corpo_cronograma tr').find('.btn-outline-danger').remove();
            
            // Adicionar botão de excluir na nova última linha
            const ultimaLinha = $('#corpo_cronograma tr:last');
            const tdAcao = ultimaLinha.find('td:last');
            tdAcao.empty().addClass('text-center');
            
            const btnExcluir = $('<button>')
                .addClass('btn btn-sm btn-outline-danger')
                .html('<i class="bi bi-trash"></i>')
                .attr('title', 'Excluir última linha')
                .on('click', function() {
                    excluirUltimaLinhaCronograma();
                });
            
            tdAcao.append(btnExcluir);
            
            // Recalcular totais
            recalcularTotaisCronograma();
        }
    }
    
    // Recalcular totais do cronograma
    // ⚡ IMPORTANTE: Total Mês é recalculado DINAMICAMENTE (soma de 53-23 + 53-24 na linha)
    function recalcularTotaisCronograma() {
        let total23Centavos = 0;
        let total24Centavos = 0;
        
        $('#corpo_cronograma tr').each(function() {
            const tr = $(this);
            // Pega valores dos inputs (em texto), converte para float
            let val23 = (tr.find('.cronograma-val-23').val() || '0').replace(/\./g, '').replace(',', '.');
            let val24 = (tr.find('.cronograma-val-24').val() || '0').replace(/\./g, '').replace(',', '.');
            val23 = parseFloat(val23) || 0;
            val24 = parseFloat(val24) || 0;
            const totalMes = val23 + val24;
            // Exibe exatamente o valor digitado, sem forçar casas decimais
            tr.find('.cronograma-total-mes').text('R$ ' + totalMes.toLocaleString('pt-BR'));
            // Badge de divergência (mantém lógica anterior)
            const valorMesBanco = tr.attr('data-valor-mes-banco') !== undefined && tr.attr('data-valor-mes-banco') !== '' ? parseFloat(tr.attr('data-valor-mes-banco')) : null;
            let badge = tr.find('.badge-divergencia');
            if (valorMesBanco !== null) {
                const divergente = Math.abs(totalMes - valorMesBanco) > 0.01;
                if (badge.length) {
                    if (!divergente) {
                        badge.remove();
                    } else {
                        badge.text('Divergência: ' + (totalMes > valorMesBanco ? '+' : '-') + 'R$ ' + Math.abs(totalMes - valorMesBanco).toLocaleString('pt-BR'));
                    }
                } else if (divergente) {
                    tr.find('.cronograma-total-mes').append(
                        $('<span>').addClass('badge bg-danger ms-2 badge-divergencia').text('Divergência: ' + (totalMes > valorMesBanco ? '+' : '-') + 'R$ ' + Math.abs(totalMes - valorMesBanco).toLocaleString('pt-BR'))
                    );
                }
            } else if (badge.length) {
                badge.remove();
            }
            total23Centavos += Math.round(val23 * 100);
            total24Centavos += Math.round(val24 * 100);
        });
        
        const total23 = total23Centavos / 100;
        const total24 = total24Centavos / 100;
        const totalGeral = (total23Centavos + total24Centavos) / 100;
        
        $('#total_23_cronograma').text('R$ ' + total23.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        $('#total_24_cronograma').text('R$ ' + total24.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        $('#total_geral_cronograma').text('R$ ' + totalGeral.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
    }
    
    // Salvar cronograma e avançar para FASE 3
    function salvarCronograma() {
        console.log('🚦 DEBUG: Início de salvarCronograma()');
        
        const termo = termoSelecionadoGlobal;
        console.log('🔍 DEBUG: termoSelecionadoGlobal:', termo);
        
        if (!termo) {
            alert('⚠️ Erro: termo não selecionado.');
            return;
        }
        
        const tipoParcela = $('input[name="tipo_parcela_manual"]:checked').val();
        console.log('🔍 DEBUG: tipoParcela:', tipoParcela);
        
        const cronograma = [];
        
        console.log('🔍 DEBUG: Total de linhas no cronograma:', $('#corpo_cronograma tr').length);
        
        $('#corpo_cronograma tr').each(function(index) {
            const tr = $(this);
            
            console.log(`🔍 DEBUG: Processando linha ${index + 1}`);
            
            // NOVA PROTEÇÃO: Verificar se checkbox "Salvar?" está marcado
            const checkboxSalvar = tr.find('.cronograma-checkbox-salvar');
            console.log(`  - Checkbox encontrado:`, checkboxSalvar.length > 0);
            console.log(`  - Checkbox marcado:`, checkboxSalvar.is(':checked'));
            
            if (!checkboxSalvar.is(':checked')) {
                console.log(`⏭️ Pulando linha ${index + 1} (checkbox desmarcado) - não será salva`);
                return; // Pula para próxima iteração
            }
            
            // Se for modo projetadas E a linha é readonly, PULAR (não salvar)
            const isReadonly = tr.attr('data-readonly') === 'true';
            console.log(`  - É readonly:`, isReadonly);
            
            if (modoParcelasProjetadas && isReadonly) {
                console.log(`⏭️ Pulando linha ${index + 1} (readonly) - não será salva`);
                return; // Pula para próxima iteração
            }
            
            const mesNome = tr.find('td:eq(2)').text(); // Ajustado: eq(2) por causa das colunas checkbox e info_alteracao
            const val23Input = tr.find('.cronograma-val-23');
            const val24Input = tr.find('.cronograma-val-24');
            
            // Info Alteração - converter valor digitado para formato do banco (- → Base, 1 → Aditivo 1, etc.)
            const valorDigitado = tr.find('.cronograma-info-alteracao').val();
            const infoAlteracao = converterInfoAlteracao(valorDigitado);
            
            // Nº da Parcela - pegar do input se existir (modo projetadas), senão do texto
            const tdParcela = tr.find('td').eq(6); // Ajustado por causa das novas colunas (checkbox + info_alteracao)
            const inputParcela = tdParcela.find('.cronograma-input-parcela');
            const parcela_numero = inputParcela.length > 0 ? inputParcela.val().trim() : tdParcela.text().trim();
            
            const centavos23 = parseInt(val23Input.data('centavos')) || 0;
            const centavos24 = parseInt(val24Input.data('centavos')) || 0;
            const val23 = centavos23 / 100;
            const val24 = centavos24 / 100;
            const valorMes = val23 + val24;
            
            const mes = parseInt(val23Input.data('mes'));
            const ano = parseInt(val23Input.data('ano'));
            
            // Validar se mês e ano são válidos
            if (isNaN(mes) || isNaN(ano) || mes < 1 || mes > 12 || ano < 2000 || ano > 2100) {
                console.error('❌ Data inválida na linha', index + 1, '- mês:', mes, 'ano:', ano);
                alert(`❌ Erro: Data inválida na linha ${index + 1}. Mês: ${mes}, Ano: ${ano}`);
                return false; // Interrompe o each
            }
            
            const nomeMesData = new Date(ano, mes - 1, 1).toISOString().split('T')[0];
            
            console.log(`✅ Salvando linha ${index + 1}: ${mesNome} - R$ ${valorMes.toFixed(2)} - Info: ${infoAlteracao}`);
            
            cronograma.push({
                nome_mes: nomeMesData,
                valor_mes_23: val23,
                valor_mes_24: val24,
                valor_mes: valorMes,
                parcela_numero: parcela_numero,
                info_alteracao: infoAlteracao
            });
        });
        
        console.log('📊 DEBUG: Total de meses coletados:', cronograma.length);
        console.log('📊 DEBUG: Cronograma:', cronograma);
        
        // Verificar se houve erro na criação do cronograma
        if (cronograma.length === 0) {
            console.error('❌ ERRO: Nenhum mês foi coletado para salvar!');
            
            // Verificar se existem linhas readonly (dados já salvos anteriormente)
            const totalLinhasReadonly = $('#corpo_cronograma tr').filter(function() {
                return $(this).find('.cronograma-val-23').prop('readonly');
            }).length;
            
            console.log('🔍 DEBUG: Total de linhas readonly encontradas:', totalLinhasReadonly);
            
            if (totalLinhasReadonly > 0) {
                console.log('✅ DEBUG: Existem dados readonly - coletando TUDO para preview na FASE 3');
                
                // Coletar TODAS as linhas (inclusive readonly) apenas para visualização na FASE 3
                $('#corpo_cronograma tr').each(function(index) {
                    const tr = $(this);
                    const mes = parseInt(tr.find('.cronograma-val-23').data('mes'));
                    const ano = parseInt(tr.find('.cronograma-val-23').data('ano'));
                    
                    const valorTexto23 = tr.find('.cronograma-val-23').val().replace(/[^\d,]/g, '');
                    const valorTexto24 = tr.find('.cronograma-val-24').val().replace(/[^\d,]/g, '');
                    
                    const valor23 = converterMoedaParaCentavos(valorTexto23);
                    const valor24 = converterMoedaParaCentavos(valorTexto24);
                    const valorMes = valor23 + valor24;
                    
                    // Converter valor digitado para formato do banco (- → Base, 1 → Aditivo 1, etc.)
                    const valorDigitado = tr.find('.cronograma-info-alteracao').val();
                    const infoAlteracao = converterInfoAlteracao(valorDigitado);
                    const parcelaNumero = tr.find('td').eq(6).attr('data-parcela-numero') || 
                                         tr.find('.cronograma-input-parcela').val() || '';
                    
                    cronograma.push({
                        mes: mes,
                        ano: ano,
                        valor_23: valor23,
                        valor_24: valor24,
                        valor_mes: valorMes,
                        info_alteracao: infoAlteracao,
                        parcela_numero: parcelaNumero
                    });
                });
                
                console.log('✅ DEBUG: Coletados', cronograma.length, 'meses para preview');
                
                // Avançar direto para FASE 3 sem salvar (dados já estão no banco)
                $('#btnSalvarCronograma').prop('disabled', false).html('<i class="bi bi-check-circle me-2"></i>Salvar Cronograma e Prosseguir');
                avancarParaFase3(cronograma);
                return;
            }
            
            // Se realmente não há nada
            console.error('Possíveis causas:');
            console.error('1. Nenhum checkbox "Salvar?" está marcado');
            console.error('2. Erro ao processar as linhas');
            
            alert('⚠️ Erro: Nenhum mês foi selecionado para salvar!\n\n' +
                  'Verifique se pelo menos um checkbox "Salvar?" está marcado.\n\n' +
                  'Se estiver adicionando parcelas projetadas, marque apenas os NOVOS meses.');
            
            $('#btnSalvarCronograma').prop('disabled', false).html('<i class="bi bi-check-circle me-2"></i>Salvar Cronograma e Prosseguir');
            return;
        }
        
        // Calcular total geral do cronograma
        const totalCronograma = cronograma.reduce((sum, mes) => sum + mes.valor_mes, 0);
        
        // Validar contra total_previsto da parceria (APENAS se NÃO for modo parcelas projetadas)
        if (!modoParcelasProjetadas) {
            const totalPrevisto = parseFloat(termo.total_previsto) || 0;
            
            if (totalPrevisto > 0) {
                const diferenca = Math.abs(totalCronograma - totalPrevisto);
                const percentualDif = (diferenca / totalPrevisto) * 100;
                
                if (diferenca > 0.01) { // Diferença maior que 1 centavo
                    const msgDivergencia = `⚠️ ATENÇÃO: Divergência detectada!\n\n` +
                        `Total do Cronograma: R$ ${totalCronograma.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n` +
                        `Total Previsto (Parceria): R$ ${totalPrevisto.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n` +
                        `Diferença: R$ ${diferenca.toLocaleString('pt-BR', {minimumFractionDigits: 2})} (${percentualDif.toFixed(2)}%)\n\n` +
                        `Deseja continuar mesmo assim?`;
                    
                    if (!confirm(msgDivergencia)) {
                        $('#btnSalvarCronograma').prop('disabled', false).html('<i class="bi bi-check-circle me-2"></i>Salvar Cronograma e Prosseguir');
                        return;
                    }
                }
            }
        } else {
            console.log('🔍 Modo Parcelas Projetadas: Pulando validação de divergência');
        }
        
        // DEBUG: Log dos dados antes de enviar
        console.log('📤 DEBUG: Enviando para o servidor:');
        console.log('  - numero_termo:', termo.numero_termo);
        console.log('  - total meses:', cronograma.length);
        console.log('  - primeiro mês:', cronograma[0]);
        console.log('  - último mês:', cronograma[cronograma.length - 1]);
        console.log('  - cronograma completo:', cronograma);
        
        console.log('🔄 DEBUG: Iniciando requisição AJAX...');
        $('#btnSalvarCronograma').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Salvando...');
        
        $.ajax({
            url: '/gestao_financeira/ultra-liquidacoes/api/salvar-cronograma',
            method: 'POST',
            contentType: 'application/json',
            timeout: 30000, // ⚡ NOVO: Timeout de 30 segundos
            data: JSON.stringify({
                numero_termo: termo.numero_termo,
                cronograma: cronograma,
                info_alteracao: 'Base'
            }),
            success: function(response) {
                console.log('✅ DEBUG: AJAX success callback executado');
                console.log('✅ Resposta do servidor:', response);
                
                if (response.success) {
                    console.log('✅ DEBUG: response.success = true, avançando para FASE 3...');
                    // ⚡ NOVO: Atualizar ultimoInfoAlteracaoSalvo após salvar com sucesso
                    if (cronograma.length > 0) {
                        ultimoInfoAlteracaoSalvo = cronograma[cronograma.length - 1].info_alteracao || 'Base';
                        console.log('💾 Atualizado ultimoInfoAlteracaoSalvo para:', ultimoInfoAlteracaoSalvo);
                    }
                    // Avançar para FASE 3
                    avancarParaFase3(cronograma);
                } else {
                    console.error('❌ DEBUG: response.success = false');
                    console.error('❌ Erro reportado pelo servidor:', response.error);
                    alert('⚠️ Erro: ' + (response.error || 'Erro desconhecido'));
                    $('#btnSalvarCronograma').prop('disabled', false).html('<i class="bi bi-check-circle me-2"></i>Salvar Cronograma e Prosseguir');
                }
            },
            error: function(xhr, status, error) {
                console.error('❌ DEBUG: AJAX error callback executado');
                console.error('❌ Status:', status); // ⚡ NOVO: Log separado para status
                console.error('❌ Erro AJAX completo:', {
                    status: status,
                    error: error,
                    responseText: xhr.responseText,
                    responseJSON: xhr.responseJSON,
                    statusCode: xhr.status
                });
                
                let mensagemErro = 'Erro desconhecido';
                
                // ⚡ NOVO: Tratamento especial para timeout
                if (status === 'timeout') {
                    mensagemErro = 'Operação demorou muito (timeout de 30s). Verifique sua conexão ou tente novamente.';
                } else {
                    try {
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            mensagemErro = xhr.responseJSON.error;
                        } else if (xhr.responseText) {
                            mensagemErro = xhr.responseText.substring(0, 500); // Primeiros 500 caracteres
                        }
                    } catch (e) {
                        mensagemErro = `Status ${xhr.status}: ${error}`;
                    }
                }
                
                alert('❌ Erro ao salvar cronograma:\n\n' + mensagemErro);
                $('#btnSalvarCronograma').prop('disabled', false).html('<i class="bi bi-check-circle me-2"></i>Salvar Cronograma e Prosseguir');
            }
        });
    }
    
    // Avançar para FASE 3: Preview e edição de parcelas
    function avancarParaFase3(cronograma) {
        console.log('🚀 DEBUG: Entrando em avancarParaFase3()');
        console.log('📊 DEBUG: cronograma recebido:', cronograma);
        
        // Ocultar fase 2
        console.log('👁️ DEBUG: Ocultando FASE 2...');
        $('#fase2_cronograma').hide();
        $('#btnSalvarCronograma').hide();
        $('#btnVoltarFase1').hide();
        
        // Mostrar fase 3
        console.log('👁️ DEBUG: Mostrando FASE 3...');
        $('#fase3_parcelas').show();
        $('#btnVoltarFase2').show();
        $('#btnConfirmarParcelas').show();
        
        // CORREÇÃO: Coletar TODOS os meses da FASE 2, não apenas os marcados para salvar
        // Isso permite visualizar e editar todas as parcelas na FASE 3
        const todosCronograma = [];
        
        $('#corpo_cronograma tr').each(function(index) {
            const tr = $(this);
            const mesNome = tr.find('td:eq(2)').text();
            const val23Input = tr.find('.cronograma-val-23');
            const val24Input = tr.find('.cronograma-val-24');
            
            // Converter valor digitado para formato do banco (- → Base, 1 → Aditivo 1, etc.)
            const valorDigitado = tr.find('.cronograma-info-alteracao').val();
            const infoAlteracao = converterInfoAlteracao(valorDigitado);
            
            const tdParcela = tr.find('td').eq(6);
            const inputParcela = tdParcela.find('.cronograma-input-parcela');
            const parcela_numero = inputParcela.length > 0 ? inputParcela.val().trim() : tdParcela.text().trim();
            
            const centavos23 = parseInt(val23Input.data('centavos')) || 0;
            const centavos24 = parseInt(val24Input.data('centavos')) || 0;
            const val23 = centavos23 / 100;
            const val24 = centavos24 / 100;
            
            const mes = parseInt(val23Input.data('mes'));
            const ano = parseInt(val23Input.data('ano'));
            const nomeMesData = new Date(ano, mes - 1, 1).toISOString().split('T')[0];
            
            // Marcar se checkbox está marcado (para saber se é nova)
            const checkboxSalvar = tr.find('.cronograma-checkbox-salvar');
            const eh_mes_novo = checkboxSalvar.is(':checked') && !tr.attr('data-readonly');
            
            todosCronograma.push({
                nome_mes: nomeMesData,
                valor_mes_23: val23,
                valor_mes_24: val24,
                parcela_numero: parcela_numero,
                info_alteracao: infoAlteracao,
                eh_mes_novo: eh_mes_novo
            });
        });
        
        console.log(`📊 Avançando para FASE 3 com ${todosCronograma.length} meses totais (salvos + existentes)`);
        
        // Gerar preview das parcelas agrupadas COM TODOS OS MESES
        gerarPreviewParcelas(todosCronograma);
    }
    
    // Voltar para FASE 2
    function voltarParaFase2() {
        $('#fase3_parcelas').hide();
        $('#btnVoltarFase2').hide();
        $('#btnConfirmarParcelas').hide();
        
        $('#fase2_cronograma').show();
        $('#btnSalvarCronograma').show();
        $('#btnVoltarFase1').show();
    }
    
    // Gerar preview das parcelas finais agrupadas
    function gerarPreviewParcelas(cronograma) {
        const termo = termoSelecionadoGlobal;
        const tbody = $('#corpo_parcelas_finais');
        tbody.empty();
        
        // Agrupar por parcela_numero
        const parcelasAgrupadas = {};
        
        cronograma.forEach(mes => {
            const parcela = mes.parcela_numero;
            if (!parcelasAgrupadas[parcela]) {
                parcelasAgrupadas[parcela] = {
                    parcela_numero: parcela,
                    meses: [],
                    valor_23: 0,
                    valor_24: 0,
                    eh_nova: false  // Flag para indicar se é parcela nova
                };
            }
            parcelasAgrupadas[parcela].meses.push(mes);
            parcelasAgrupadas[parcela].valor_23 += mes.valor_mes_23;
            parcelasAgrupadas[parcela].valor_24 += mes.valor_mes_24;
            
            // Marcar como nova se qualquer mês dessa parcela for maior que o total original
            if (mes.eh_mes_novo) {
                parcelasAgrupadas[parcela].eh_nova = true;
            }
        });
        
        // Criar linhas editáveis para cada parcela
        Object.values(parcelasAgrupadas).forEach((parcela, index) => {
            const primeiroMes = parcela.meses[0];
            const ultimoMes = parcela.meses[parcela.meses.length - 1];
            
            const vigenciaInicial = primeiroMes.nome_mes;
            const vigenciaFinal = ultimoMes.nome_mes;
            const valorPrevisto = parcela.valor_23 + parcela.valor_24;
            
            // Coletar info_alteracao dos meses (pegar o mais comum ou o primeiro)
            const infosAlteracao = parcela.meses.map(m => m.info_alteracao || 'Base');
            const infoAlteracaoMaisComum = infosAlteracao.sort((a,b) =>
                infosAlteracao.filter(v => v===a).length - infosAlteracao.filter(v => v===b).length
            ).pop();
            
            // Determinar tipo de parcela: se for modo projetadas E for parcela nova, marcar como Projetada
            let tipoParcelaDefault = 'Programada';
            if (modoParcelasProjetadas && parcela.eh_nova) {
                tipoParcelaDefault = 'Projetada';
                console.log(`📌 Marcando parcela ${parcela.parcela_numero} como PROJETADA (contém meses novos)`);
            }
            
            const tr = $('<tr>').data('parcela-index', index);
            
            // Checkbox "Salvar?" - TODAS desmarcadas por padrão
            // Será marcado automaticamente quando usuário alterar algum campo
            const tdCheck = $('<td>').addClass('text-center');
            const checkboxSalvar = $('<input>').attr({
                type: 'checkbox',
                class: 'form-check-input parcela-checkbox-salvar',
                checked: false  // Sempre desmarcado inicialmente
            });
            tdCheck.append(checkboxSalvar);
            tr.append(tdCheck);
            
            // Campos editáveis com classe para detectar mudanças
            tr.append($('<td>').html(`<input type="date" class="form-control form-control-sm campo-editavel-parcela" value="${vigenciaInicial}">`));
            tr.append($('<td>').html(`<input type="date" class="form-control form-control-sm campo-editavel-parcela" value="${vigenciaFinal}">`));
            tr.append($('<td>').text(parcela.parcela_numero));
            
            const selectTipo = createSelectTipoParcela(tipoParcelaDefault);
            selectTipo.addClass('campo-editavel-parcela');
            tr.append($('<td>').html(selectTipo));
            
            tr.append($('<td>').addClass('text-muted').text(infoAlteracaoMaisComum)); // Info Alteração como TEXTO
            tr.append($('<td>').html(`<input type="text" class="form-control form-control-sm text-end" value="${parcela.valor_23.toLocaleString('pt-BR', {minimumFractionDigits: 2})}" readonly>`));
            tr.append($('<td>').html(`<input type="text" class="form-control form-control-sm text-end" value="${parcela.valor_24.toLocaleString('pt-BR', {minimumFractionDigits: 2})}" readonly>`));
            tr.append($('<td>').html(`<input type="text" class="form-control form-control-sm text-end" value="${valorPrevisto.toLocaleString('pt-BR', {minimumFractionDigits: 2})}" readonly>`));
            
            const selectStatus = createSelectStatus('Não Pago');
            selectStatus.addClass('campo-editavel-parcela');
            tr.append($('<td>').html(selectStatus));
            
            const selectStatusSec = createSelectStatusSecundario('-');
            selectStatusSec.addClass('campo-editavel-parcela');
            tr.append($('<td>').html(selectStatusSec));
            
            tbody.append(tr);
        });
        
        // ✨ Adicionar event listeners para marcar checkbox automaticamente ao editar
        $('#corpo_parcelas_finais').off('change input', '.campo-editavel-parcela').on('change input', '.campo-editavel-parcela', function() {
            const tr = $(this).closest('tr');
            const checkbox = tr.find('.parcela-checkbox-salvar');
            
            // Marcar checkbox automaticamente quando campo for alterado
            if (!checkbox.prop('checked')) {
                checkbox.prop('checked', true);
                console.log('✅ Checkbox marcado automaticamente - parcela modificada');
            }
        });
    }
    
    // Helper: criar select de tipo de parcela
    function createSelectTipoParcela(valorDefault) {
        const select = $('<select>').addClass('form-select form-select-sm');
        ['Programada', 'Desprogramada', 'Projetada'].forEach(tipo => {
            const option = $('<option>').val(tipo).text(tipo);
            if (tipo === valorDefault) option.prop('selected', true);
            select.append(option);
        });
        return select;
    }
    
    // Helper: criar select de status
    function createSelectStatus(valorDefault) {
        const select = $('<select>').addClass('form-select form-select-sm parcela-status-select');
        // Opção temporária enquanto carrega
        select.append($('<option>').val(valorDefault).text(valorDefault).prop('selected', true));
        
        // ⚡ CORRETO: Usar cache ao invés de fazer AJAX repetido
        carregarStatusPagamento().then(statusList => {
            select.empty();
            // Remover duplicatas e ordenar
            const statusUnicos = [...new Set(statusList.map(st => st.parcela_status))].sort();
            statusUnicos.forEach(st => {
                const option = $('<option>').val(st).text(st);
                if (st === valorDefault) option.prop('selected', true);
                select.append(option);
            });
        }).catch(err => {
            console.error('❌ Erro ao popular status:', err);
            // Manter valor default em caso de erro
        });
        
        return select;
    }
    
    // Helper: criar select de status secundário
    function createSelectStatusSecundario(valorDefault) {
        const select = $('<select>').addClass('form-select form-select-sm parcela-status-sec-select');
        // Opção temporária enquanto carrega
        select.append($('<option>').val(valorDefault).text(valorDefault).prop('selected', true));
        
        // ⚡ CORRETO: Usar cache ao invés de fazer AJAX repetido
        carregarStatusPagamento().then(statusList => {
            select.empty();
            // Extrair status secundários únicos
            const statusSec = new Set();
            statusList.forEach(st => {
                if (st.status_secundario) {
                    statusSec.add(st.status_secundario);
                }
            });
            const statusSecArray = Array.from(statusSec).sort();
            statusSecArray.forEach(sec => {
                const option = $('<option>').val(sec).text(sec);
                if (sec === valorDefault) option.prop('selected', true);
                select.append(option);
            });
        }).catch(err => {
            console.error('❌ Erro ao popular status secundário:', err);
            // Manter valor default em caso de erro
        });
        
        return select;
    }
    
    // Confirmar e salvar parcelas finais
    function confirmarParcelasFinais() {
        const termo = termoSelecionadoGlobal;
        
        console.log('🔍 DEBUG confirmarParcelasFinais:');
        console.log('  termoSelecionadoGlobal:', termo);
        
        if (!termo) {
            alert('⚠️ Erro: termo não selecionado.');
            return;
        }
        
        if (!termo.numero_termo) {
            alert('⚠️ Erro: termo sem numero_termo.');
            console.log('❌ termo.numero_termo está vazio!');
            return;
        }
        
        console.log('  numero_termo:', termo.numero_termo);
        
        const parcelas = [];
        
        $('#corpo_parcelas_finais tr').each(function() {
            const tr = $(this);
            
            // NOVA PROTEÇÃO: Verificar se checkbox "Salvar?" está marcado
            const checkboxSalvar = tr.find('.parcela-checkbox-salvar');
            if (!checkboxSalvar.is(':checked')) {
                console.log(`⏭️ Pulando parcela ${tr.find('td').eq(3).text()} (checkbox desmarcado)`);
                return; // Pula esta iteração
            }
            
            // Coletar dados dos campos CORRETAMENTE pelos nomes das classes
            const vigenciaInicial = tr.find('input[type="date"]').eq(0).val();
            const vigenciaFinal = tr.find('input[type="date"]').eq(1).val();
            const parcelaNome = tr.find('td').eq(3).text();
            const tipoParcela = tr.find('.campo-editavel-parcela').filter('select').eq(0).val();
            
            // Valores readonly - pegar pelo texto, não pelos inputs editáveis
            const tds = tr.find('td');
            const valor23Text = tds.eq(6).find('input').val(); // Coluna Valor 53-23
            const valor24Text = tds.eq(7).find('input').val(); // Coluna Valor 53-24
            const valorPrevistoText = tds.eq(8).find('input').val(); // Coluna Valor Previsto
            
            const valor23 = parseFloat(valor23Text.replace(/\./g, '').replace(',', '.')) || 0;
            const valor24 = parseFloat(valor24Text.replace(/\./g, '').replace(',', '.')) || 0;
            const valorPrevisto = parseFloat(valorPrevistoText.replace(/\./g, '').replace(',', '.')) || 0;
            
            const status = tr.find('.campo-editavel-parcela').filter('select').eq(1).val();
            const statusSecundario = tr.find('.campo-editavel-parcela').filter('select').eq(2).val();
            
            console.log(`  📋 Parcela: ${parcelaNome}`);
            console.log(`    - Valor 53-23: ${valor23} (texto original: ${valor23Text})`);
            console.log(`    - Valor 53-24: ${valor24} (texto original: ${valor24Text})`);
            console.log(`    - Valor Previsto: ${valorPrevisto} (texto original: ${valorPrevistoText})`);
            
            const parcela = {
                vigencia_inicial: vigenciaInicial,
                vigencia_final: vigenciaFinal,
                numero_termo: termo.numero_termo,
                parcela_tipo: tipoParcela,
                parcela_numero: parcelaNome,
                valor_elemento_53_23: valor23,
                valor_elemento_53_24: valor24,
                valor_previsto: valorPrevisto,
                valor_subtraido: 0,
                valor_encaminhado: 0,
                valor_pago: 0,
                parcela_status: status,
                parcela_status_secundario: statusSecundario,
                data_pagamento: null,
                observacoes: ''
            };
            
            parcelas.push(parcela);
        });
        
        console.log('📦 Total de parcelas:', parcelas.length);
        console.log('📦 Modo Parcelas Projetadas:', modoParcelasProjetadas);
        console.log('📦 Payload completo:', { parcelas: parcelas, upsert_mode: modoParcelasProjetadas });
        console.log('📦 JSON stringified:', JSON.stringify({ parcelas: parcelas, upsert_mode: modoParcelasProjetadas }, null, 2));
        
        const textoConfirmacao = modoParcelasProjetadas 
            ? `Confirma a adição/atualização de ${parcelas.length} parcelas projetadas para o termo ${termo.numero_termo}?\n\n⚠️ Modo UPSERT: Parcelas existentes serão atualizadas, novas serão criadas.`
            : `Confirma a criação de ${parcelas.length} parcelas para o termo ${termo.numero_termo}?`;
        
        if (!confirm(textoConfirmacao)) {
            return;
        }
        
        $('#btnConfirmarParcelas').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Salvando...');
        
        $.ajax({
            url: '/gestao_financeira/ultra-liquidacoes/api/adicionar-parcelas',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ 
                parcelas: parcelas,
                upsert_mode: modoParcelasProjetadas  // Flag para backend fazer UPSERT ao invés de INSERT
            }),
            success: function(response) {
                console.log('✅ Resposta do servidor:', response);
                if (response.success) {
                    alert(`✅ ${response.linhas_inseridas} parcelas adicionadas com sucesso!`);
                    $('#modalAdicionarParcelas').modal('hide');
                    carregarDados(); // Recarregar tabela principal
                } else {
                    alert('⚠️ Erro: ' + (response.error || 'Erro desconhecido'));
                }
                $('#btnConfirmarParcelas').prop('disabled', false).html('<i class="bi bi-check-circle me-2"></i>Confirmar e Adicionar Parcelas');
            },
            error: function(xhr) {
                console.log('❌ Erro do servidor:', xhr);
                console.log('❌ Status:', xhr.status);
                console.log('❌ Response:', xhr.responseJSON);
                alert('❌ Erro ao adicionar parcelas: ' + (xhr.responseJSON?.error || 'Erro desconhecido'));
                $('#btnConfirmarParcelas').prop('disabled', false).html('<i class="bi bi-check-circle me-2"></i>Confirmar e Adicionar Parcelas');
            }
        });
    }
    
    // ==================== FIM FUNÇÕES CRONOGRAMA ====================
    
    // ==================== FUNÇÕES CRONOGRAMA EDIÇÃO ====================
    
    // Carregar cronograma existente para edição
    function carregarCronogramaEdicao(numeroTermo) {
        console.log('🔍 DEBUG carregarCronogramaEdicao - numeroTermo:', numeroTermo);
        
        if (!numeroTermo) {
            console.log('⚠️ Número do termo vazio');
            $('#semCronogramaEdicao').show();
            $('#corpoTabelaCronogramaEdicao').empty();
            return;
        }
        
        $('#cronograma_numero_termo_hidden').val(numeroTermo);
        $('#loadingCronogramaEdicao').show();
        $('#semCronogramaEdicao').hide();
        $('#corpoTabelaCronogramaEdicao').empty();
        
        // ⚡ PASSO 1: Buscar valores das parcelas em ultra_liquidacoes
        $.ajax({
            url: `/gestao_financeira/ultra-liquidacoes/api/termo/${numeroTermo}/parcelas`,
            method: 'GET',
            success: function(parcelasResponse) {
                // ⚡ Criar mapa parcela_numero -> SOMA dos valores (para casos de parcelas duplicadas)
                const valoresParcelas = {};
                parcelasResponse.parcelas.forEach(p => {
                    const parcela = p.parcela_numero;
                    const valor = parseFloat(p.valor_previsto || 0);
                    
                    // Se já existe essa parcela, SOMAR os valores
                    if (!valoresParcelas[parcela]) {
                        valoresParcelas[parcela] = 0;
                    }
                    valoresParcelas[parcela] += valor;
                });
                console.log('📊 Valores das parcelas carregados (soma de duplicatas):', valoresParcelas);
                
                // ⚡ PASSO 2: Buscar cronograma
                const url = '/gestao_financeira/ultra-liquidacoes/api/cronograma';
                console.log('📡 Fazendo requisição para:', url);
                console.log('📦 Parâmetros:', { numero_termo: numeroTermo });
                
                $.ajax({
                    url: url,
                    method: 'GET',
                    data: { numero_termo: numeroTermo },
                    success: function(response) {
                console.log('✅ Resposta recebida:', response);
                $('#loadingCronogramaEdicao').hide();
                
                        if (response.success && response.cronograma && response.cronograma.length > 0) {
                            console.log('📊 Renderizando', response.cronograma.length, 'registros');
                            renderizarCronogramaEdicao(response.cronograma, valoresParcelas);
                            
                            // Verificar visibilidade após renderização
                            setTimeout(function() {
                                console.log('👁️ Verificando visibilidade da tabela...');
                                console.log('- Tabela visível:', $('#corpoTabelaCronogramaEdicao').is(':visible'));
                                console.log('- Parent visível:', $('#corpoTabelaCronogramaEdicao').parent().is(':visible'));
                                console.log('- Aba ativa:', $('#tab-cronograma-edicao').hasClass('active'));
                                console.log('- Content visible:', $('#content-cronograma-edicao').hasClass('active show'));
                            }, 100);
                        } else {
                            console.log('⚠️ Nenhum cronograma encontrado - gerando linha inicial');
                            
                            // ⚡ CRIAR LINHA INICIAL baseada na vigência inicial mínima das parcelas
                            if (parcelasResponse.parcelas && parcelasResponse.parcelas.length > 0) {
                                // Buscar a vigência inicial mais antiga
                                console.log('🔍 DEBUG: Total de parcelas recebidas:', parcelasResponse.parcelas.length);
                                let vigenciaInicialMin = null;
                                parcelasResponse.parcelas.forEach((p, index) => {
                                    console.log(`🔍 DEBUG Parcela ${index + 1}:`, {
                                        parcela_numero: p.parcela_numero,
                                        vigencia_inicial: p.vigencia_inicial,
                                        vigencia_inicial_parsed: p.vigencia_inicial ? new Date(p.vigencia_inicial) : null
                                    });
                                    
                                    if (p.vigencia_inicial) {
                                        const vigencia = new Date(p.vigencia_inicial);
                                        if (!vigenciaInicialMin || vigencia < vigenciaInicialMin) {
                                            console.log(`  ✅ Nova vigência mínima: ${vigencia.toISOString()} (anterior: ${vigenciaInicialMin ? vigenciaInicialMin.toISOString() : 'nenhuma'})`);
                                            vigenciaInicialMin = vigencia;
                                        }
                                    }
                                });
                                
                                if (vigenciaInicialMin) {
                                    console.log('📅 Vigência inicial mínima encontrada:', vigenciaInicialMin);
                                    console.log('📅 ISO String:', vigenciaInicialMin.toISOString());
                                    
                                    // Gerar linha inicial com este mês
                                    const mes = vigenciaInicialMin.getMonth() + 1; // 1-12
                                    const ano = vigenciaInicialMin.getFullYear();
                                    console.log(`🔍 DEBUG: Extraído - Mês: ${mes}, Ano: ${ano}`);
                                    
                                    const meses = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
                                    const mesNome = `${meses[mes - 1]}/${String(ano).slice(-2)}`;
                                    console.log(`🔍 DEBUG: mesNome gerado: ${mesNome}`);
                                    
                                    // Criar objeto de cronograma inicial
                                    const cronogramaInicial = [{
                                        id: null,
                                        nome_mes: `${ano}-${String(mes).padStart(2, '0')}-01`,
                                        valor_mes_23: 0,
                                        valor_mes_24: 0,
                                        valor_mes: 0,
                                        parcela_numero: '',
                                        info_alteracao: 'Base'
                                    }];
                                    
                                    console.log('✨ Gerando linha inicial:', cronogramaInicial[0]);
                                    console.log('✨ nome_mes formatado:', cronogramaInicial[0].nome_mes);
                                    renderizarCronogramaEdicao(cronogramaInicial, valoresParcelas);
                                    
                                    // Mostrar mensagem informativa
                                    $('#semCronogramaEdicao').html(`
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle me-2"></i>
                                            <strong>Cronograma vazio!</strong> Foi criada uma linha inicial baseada na vigência do termo (${mesNome}).
                                            Use os botões "Adicionar Mês no Início" ou "Adicionar Mês no Final" para construir o cronograma.
                                        </div>
                                    `).show();
                                } else {
                                    console.log('⚠️ Nenhuma vigência inicial encontrada');
                                    $('#semCronogramaEdicao').html(`
                                        <div class="alert alert-warning">
                                            <i class="bi bi-exclamation-triangle me-2"></i>
                                            <strong>Atenção!</strong> Não foi possível encontrar a vigência inicial das parcelas.
                                            Por favor, verifique se existem parcelas cadastradas para este termo.
                                        </div>
                                    `).show();
                                }
                            } else {
                                console.log('⚠️ Nenhuma parcela encontrada para gerar linha inicial');
                                $('#semCronogramaEdicao').html(`
                                    <div class="alert alert-warning">
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        <strong>Atenção!</strong> Não existem parcelas cadastradas para este termo.
                                        Adicione parcelas antes de criar o cronograma.
                                    </div>
                                `).show();
                            }
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('❌ Erro ao carregar cronograma');
                        console.error('Status:', status);
                        console.error('Error:', error);
                        console.error('Response:', xhr.responseText);
                        console.error('XHR completo:', xhr);
                        $('#loadingCronogramaEdicao').hide();
                        $('#semCronogramaEdicao').show();
                    }
                });
            },
            error: function(xhr, status, error) {
                console.error('❌ Erro ao carregar valores das parcelas');
                $('#loadingCronogramaEdicao').hide();
                $('#semCronogramaEdicao').show();
            }
        });
    }
    
    // Renderizar cronograma na tabela de edição
    function renderizarCronogramaEdicao(cronograma, valoresParcelas = {}) {
        console.log('🎨 Iniciando renderização do cronograma');
        console.log('📋 Total de registros:', cronograma.length);
        console.log('🔍 Primeiro registro:', cronograma[0]);
        console.log('💰 Valores das parcelas recebidos:', valoresParcelas);
        
        const tbody = $('#corpoTabelaCronogramaEdicao');
        console.log('📍 tbody encontrado:', tbody.length > 0 ? 'SIM' : 'NÃO');
        tbody.empty();
        
        // ⚡ AGRUPAR CRONOGRAMA POR PARCELA_NUMERO e calcular totais
        const cronogramoPorParcela = {};
        cronograma.forEach(mes => {
            const parcela = mes.parcela_numero;
            if (!cronogramoPorParcela[parcela]) {
                cronogramoPorParcela[parcela] = {
                    total: 0,
                    meses: []
                };
            }
            const valorMes = parseFloat(mes.valor_mes || 0);
            cronogramoPorParcela[parcela].total += valorMes;
            cronogramoPorParcela[parcela].meses.push(mes);
        });
        console.log('📊 Cronograma agrupado por parcela:', cronogramoPorParcela);
        
        // ⚡ IDENTIFICAR DIVERGÊNCIAS
        const divergencias = {};
        Object.keys(cronogramoPorParcela).forEach(parcela => {
            const totalCronograma = cronogramoPorParcela[parcela].total;
            const valorParcela = valoresParcelas[parcela] || 0;
            const diferenca = Math.abs(totalCronograma - valorParcela);
            
            if (diferenca > 0.01) {
                divergencias[parcela] = {
                    cronograma: totalCronograma,
                    parcela: valorParcela,
                    diferenca: diferenca
                };
                console.log(`⚠️ DIVERGÊNCIA: ${parcela} - Cronograma: R$ ${totalCronograma.toFixed(2)}, Parcela: R$ ${valorParcela.toFixed(2)}`);
            }
        });
        console.log('🚨 Total de divergências:', Object.keys(divergencias).length);
        
        cronograma.forEach(function(mes, index) {
            try {
                // 🔍 DEBUG: Mostrar dados brutos do mês
                if (index === 0) {
                    console.log('🔍 DEBUG PRIMEIRO MÊS - Dados brutos:', mes);
                    console.log('🔍 DEBUG: nome_mes =', mes.nome_mes);
                    console.log('🔍 DEBUG: tipo de nome_mes =', typeof mes.nome_mes);
                }
                
                // Corrigir formato de data (yyyy-mm-dd vindo do backend)
                const [ano, mesNum, dia] = mes.nome_mes.split('-');
                console.log(`🔍 DEBUG Mês ${index + 1}: Split de '${mes.nome_mes}' = ano:${ano}, mesNum:${mesNum}, dia:${dia}`);
                
                const meses = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
                const mesNome = meses[parseInt(mesNum) - 1] + '/' + ano.substr(2);
                console.log(`🔍 DEBUG: mesNum=${mesNum}, parseInt=${parseInt(mesNum)}, índice=${parseInt(mesNum) - 1}, mesNome final=${mesNome}`);
                
                // Valores atuais (podem ser 0 se não preenchidos)
                const val23 = mes.valor_mes_23 !== null ? parseFloat(mes.valor_mes_23) : 0;
                const val24 = mes.valor_mes_24 !== null ? parseFloat(mes.valor_mes_24) : 0;
                const valorMes = mes.valor_mes !== null ? parseFloat(mes.valor_mes) : 0;
                const somaAtual = val23 + val24;
                
                // Validação: se soma diverge do valor_mes
                const divergente = Math.abs(somaAtual - valorMes) > 0.01;
                const diferenca = somaAtual - valorMes;
                
                if (index === 0) {
                    console.log('💰 Primeiro registro - val23:', val23, 'val24:', val24, 'valor_mes:', valorMes, 'divergente:', divergente);
                }
                
                const tr = $('<tr>');
                
                // ⚡ DESTACAR EM AMARELO SE HOUVER DIVERGÊNCIA POR PARCELA_NUMERO
                const parcelaNumero = mes.parcela_numero;
                if (divergencias[parcelaNumero]) {
                    tr.addClass('table-warning');
                    const divInfo = divergencias[parcelaNumero];
                    tr.attr('title', `⚠️ Divergência: Cronograma R$ ${divInfo.cronograma.toFixed(2)} ≠ Parcela R$ ${divInfo.parcela.toFixed(2)}`);
                }
                
                // Manter validação antiga de divergência dentro da linha (23+24 vs valor_mes)
                if (divergente) {
                    tr.attr('data-divergente', 'true');
                    tr.attr('data-diferenca', diferenca.toFixed(2));
                }
                
                // Armazenar valor_mes esperado na linha
                tr.attr('data-valor-mes', valorMes.toFixed(2));
                tr.attr('data-nome-mes', mes.nome_mes);
                tr.attr('data-id', mes.id);
                tr.attr('data-info-alteracao', mes.info_alteracao || 'Base');
                
                // Coluna Info Alteração - input editável com conversão automática
                const tdInfoAlteracao = $('<td>');
                const infoAlteracaoAtual = mes.info_alteracao || 'Base';
                
                // ⚡ CONVERTER de "Base" ou "Aditivo X" para formato editável ("-" ou "X")
                let valorDisplay = '-'; // Padrão para Base
                if (infoAlteracaoAtual && infoAlteracaoAtual !== 'Base') {
                    // Extrair número do formato "Aditivo 1", "Aditivo 2", etc.
                    const match = infoAlteracaoAtual.match(/Aditivo (\d+)/i);
                    if (match) {
                        valorDisplay = match[1]; // Exibir apenas o número (1, 2, 3...)
                    }
                }
                console.log(`🔄 Conversão DB→Frontend: "${infoAlteracaoAtual}" → "${valorDisplay}"`);
                
                const inputInfoAlteracao = $('<input>').attr({
                    type: 'text',
                    maxlength: '2',
                    placeholder: '-'
                }).addClass('form-control form-control-sm text-center cronograma-edicao-info-alteracao').val(valorDisplay);
                tdInfoAlteracao.append(inputInfoAlteracao);
                tr.append(tdInfoAlteracao);
                
                tr.append($('<td>').addClass('fw-bold').text(mesNome));
                tr.append($('<td>').html(`<input type="text" class="form-control form-control-sm cronograma-edicao-val-23" value="${val23.toFixed(2).replace('.', ',')}" data-original="${val23.toFixed(2)}">`));
                tr.append($('<td>').html(`<input type="text" class="form-control form-control-sm cronograma-edicao-val-24" value="${val24.toFixed(2).replace('.', ',')}" data-original="${val24.toFixed(2)}">`));
                
                // Total Mês com badge de erro se divergente
                const tdTotal = $('<td>').addClass('cronograma-edicao-total-mes fw-bold text-end');
                tdTotal.html(`R$ ${valorMes.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`);
                
                if (divergente) {
                    const badgeClass = diferenca > 0 ? 'bg-danger' : 'bg-warning';
                    const sinal = diferenca > 0 ? '+' : '';
                    tdTotal.append(`<br><span class="badge ${badgeClass} mt-1">Divergência: ${sinal}R$ ${Math.abs(diferenca).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>`);
                }
                
                tr.append(tdTotal);
                
                // Nº Parcela - EDITÁVEL
                const tdParcela = $('<td>');
                const inputParcela = $('<input>')
                    .attr('type', 'text')
                    .addClass('form-control form-control-sm cronograma-edicao-parcela-numero')
                    .val(mes.parcela_numero || '')
                    .attr('placeholder', 'Ex: 12ª Parcela')
                    .attr('data-original', mes.parcela_numero || '');
                tdParcela.append(inputParcela);
                tr.append(tdParcela);
                
                // Coluna de ações (botão excluir)
                const tdAcao = $('<td>').addClass('text-center');
                const btnExcluir = $('<button>')
                    .addClass('btn btn-sm btn-danger')
                    .html('<i class="bi bi-trash"></i>')
                    .attr('title', 'Excluir linha')
                    .on('click', function() {
                        if (confirm('Deseja realmente excluir este mês do cronograma?')) {
                            tr.remove();
                            recalcularTotaisCronogramaEdicao();
                        }
                    });
                tdAcao.append(btnExcluir);
                tr.append(tdAcao);
                
                tbody.append(tr);
                
                if (index === 0) {
                    console.log('✅ Primeira linha adicionada ao tbody');
                }
            } catch (error) {
                console.error('❌ Erro ao renderizar registro', index, ':', error);
                console.error('Dados do registro:', mes);
            }
        });
        
        console.log('✅ Renderização concluída');
        console.log('📊 Linhas no tbody:', $('#corpoTabelaCronogramaEdicao tr').length);
        
        // ⚡ ADICIONAR ALERTA NO TOPO SE HOUVER DIVERGÊNCIAS
        $('.alerta-divergencia-cronograma').remove(); // Limpar alertas anteriores
        if (Object.keys(divergencias).length > 0) {
            const alertDiv = $('<div>').addClass('alert alert-warning mb-3 alerta-divergencia-cronograma').html(
                '<strong><i class="bi bi-exclamation-triangle me-2"></i>Divergências Detectadas entre Cronograma e Parcelas:</strong><br>' +
                Object.keys(divergencias).map(parcela => {
                    const div = divergencias[parcela];
                    return `• <strong>${parcela}</strong>: Cronograma R$ ${div.cronograma.toLocaleString('pt-BR', {minimumFractionDigits: 2})} ≠ Parcela R$ ${div.parcela.toLocaleString('pt-BR', {minimumFractionDigits: 2})} (Diferença: R$ ${div.diferenca.toLocaleString('pt-BR', {minimumFractionDigits: 2})})`;
                }).join('<br>')
            );
            $('#corpoTabelaCronogramaEdicao').closest('.table-responsive').before(alertDiv);
        }
        
        // Garantir visibilidade da tabela
        $('#loadingCronogramaEdicao').hide();
        $('#semCronogramaEdicao').hide();
        $('#corpoTabelaCronogramaEdicao').closest('.table-responsive').show();
        
        // Forçar tab-pane CORRETO visível
        $('#content-cronograma-edicao').addClass('active show').css('display', 'block');
        $('#content-cronograma').removeClass('active show');
        
        // Aplicar eventos
        $('.cronograma-edicao-val-23, .cronograma-edicao-val-24').on('input', function() {
            const tr = $(this).closest('tr');
            atualizarTotalMesLinhaEdicao(tr);
        });
        
        $('.cronograma-edicao-val-23, .cronograma-edicao-val-24').on('blur', function() {
            const tr = $(this).closest('tr');
            atualizarTotalMesLinhaEdicao(tr);
            recalcularTotaisCronogramaEdicao();
        });
        
        // ⚡ NOVO: Habilitar colar do Excel no cronograma de edição
        habilitarColarExcelCronogramaEdicao();
        
        recalcularTotaisCronogramaEdicao();
    }
    
    // Função para atualizar o Total Mês de uma linha do cronograma de edição
    function atualizarTotalMesLinhaEdicao(tr) {
        // Pega os valores das colunas 53-23 e 53-24
        let val23 = desformatarValorMonetario(tr.find('.cronograma-edicao-val-23').val() || '0,00');
        let val24 = desformatarValorMonetario(tr.find('.cronograma-edicao-val-24').val() || '0,00');
        val23 = val23 || 0;
        val24 = val24 || 0;
        let total = val23 + val24;
        
        // Atualiza a célula de Total Mês
        const tdTotal = tr.find('.cronograma-edicao-total-mes');
        tdTotal.html('R$ ' + formatarValorMonetario(total));
        
        // Remove qualquer badge de divergência antigo
        tdTotal.find('.badge').remove();
    }
    
    // Validar linha individual do cronograma
    function validarLinhaCronogramaEdicao(tr) {
        const val23Input = tr.find('.cronograma-edicao-val-23');
        const val24Input = tr.find('.cronograma-edicao-val-24');
        const val23 = parseFloat(val23Input.val().replace(',', '.')) || 0;
        const val24 = parseFloat(val24Input.val().replace(',', '.')) || 0;
        const valorMesEsperado = parseFloat(tr.attr('data-valor-mes')) || 0;
        const somaAtual = val23 + val24;
        const diferenca = somaAtual - valorMesEsperado;
        const divergente = Math.abs(diferenca) > 0.01;
        
        // ⚡ MARCAÇÃO VISUAL: Adicionar/remover classe de erro nos campos
        if (divergente) {
            val23Input.addClass('campo-erro');
            val24Input.addClass('campo-erro');
        } else {
            val23Input.removeClass('campo-erro');
            val24Input.removeClass('campo-erro');
        }
        
        // Remover classe de divergente se estiver OK
        if (!divergente) {
            tr.removeClass('table-warning');
            tr.removeAttr('data-divergente');
            tr.removeAttr('data-diferenca');
            
            // Atualizar célula de total sem badge
            const tdTotal = tr.find('.cronograma-edicao-total-mes');
            tdTotal.html(`R$ ${valorMesEsperado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`);
        } else {
            // Adicionar classe de divergente
            tr.addClass('table-warning');
            tr.attr('data-divergente', 'true');
            tr.attr('data-diferenca', diferenca.toFixed(2));
            
            // Atualizar célula de total com badge
            const tdTotal = tr.find('.cronograma-edicao-total-mes');
            const badgeClass = diferenca > 0 ? 'bg-danger' : 'bg-warning';
            const sinal = diferenca > 0 ? '+' : '';
            tdTotal.html(`
                R$ ${valorMesEsperado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                <br><span class="badge ${badgeClass} mt-1">Divergência: ${sinal}R$ ${Math.abs(diferenca).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
            `);
        }
        
        recalcularTotaisCronogramaEdicao();
    }
    
    // Recalcular totais do cronograma de edição
    function recalcularTotaisCronogramaEdicao() {
        let total23 = 0;
        let total24 = 0;
        
        $('#corpoTabelaCronogramaEdicao tr').each(function() {
            const tr = $(this);
            const val23 = parseFloat(tr.find('.cronograma-edicao-val-23').val().replace(',', '.')) || 0;
            const val24 = parseFloat(tr.find('.cronograma-edicao-val-24').val().replace(',', '.')) || 0;
            
            total23 += val23;
            total24 += val24;
        });
        
        const totalGeral = total23 + total24;
        $('#total_23_cronograma_edicao').text('R$ ' + total23.toLocaleString('pt-BR', {minimumFractionDigits: 2}));
        $('#total_24_cronograma_edicao').text('R$ ' + total24.toLocaleString('pt-BR', {minimumFractionDigits: 2}));
        $('#total_geral_cronograma_edicao').text('R$ ' + totalGeral.toLocaleString('pt-BR', {minimumFractionDigits: 2}));
    }
    
    // Limpar linhas duplicadas com valor zero
    function limparLinhasDuplicadasCronogramaEdicao() {
        const totalLinhas = $('#corpoTabelaCronogramaEdicao tr').length;
        
        if (totalLinhas === 0) {
            alert('⚠️ Nenhum cronograma carregado.');
            return;
        }
        
        // Mapear meses e identificar duplicatas com valor 0
        const mesesMap = {};
        const linhasParaRemover = [];
        
        $('#corpoTabelaCronogramaEdicao tr').each(function(index) {
            const tr = $(this);
            const mesNome = tr.find('td').eq(1).text().trim(); // Mês/Ano (ex: "jan/25")
            const val23 = parseFloat(tr.find('.cronograma-edicao-val-23').val().replace(',', '.')) || 0;
            const val24 = parseFloat(tr.find('.cronograma-edicao-val-24').val().replace(',', '.')) || 0;
            const total = val23 + val24;
            
            // Se mês já existe no mapa
            if (mesesMap[mesNome]) {
                // Se a linha atual tem valor 0, marcar para remoção
                if (total === 0) {
                    linhasParaRemover.push({tr: tr, mes: mesNome, motivo: 'duplicada com valor 0'});
                }
                // Se a linha anterior tinha valor 0, marcar ela para remoção
                else if (mesesMap[mesNome].total === 0) {
                    linhasParaRemover.push({tr: mesesMap[mesNome].tr, mes: mesNome, motivo: 'duplicada com valor 0'});
                    // Atualizar mapa com a linha atual
                    mesesMap[mesNome] = {tr: tr, total: total};
                }
            } else {
                // Primeira ocorrência deste mês
                mesesMap[mesNome] = {tr: tr, total: total};
            }
        });
        
        if (linhasParaRemover.length === 0) {
            alert('✅ Nenhuma linha duplicada com valor 0 encontrada.');
            return;
        }
        
        const mensagem = `🗑️ Encontradas ${linhasParaRemover.length} linha(s) duplicada(s) com valor 0.\n\nMeses: ${[...new Set(linhasParaRemover.map(l => l.mes))].join(', ')}\n\nDeseja remover?`;
        
        if (confirm(mensagem)) {
            linhasParaRemover.forEach(item => {
                console.log(`🗑️ Removendo linha duplicada: ${item.mes} (${item.motivo})`);
                item.tr.remove();
            });
            
            recalcularTotaisCronogramaEdicao();
            alert(`✅ ${linhasParaRemover.length} linha(s) removida(s) com sucesso!`);
        }
    }
    
    // Adicionar mês no início do cronograma de edição
    function adicionarMesInicioCronogramaEdicao() {
        const totalLinhas = $('#corpoTabelaCronogramaEdicao tr').length;
        
        if (totalLinhas === 0) {
            alert('⚠️ Nenhum cronograma carregado. Carregue um termo primeiro.');
            return;
        }
        
        // Pegar primeira linha para calcular mês anterior
        const primeiraLinha = $('#corpoTabelaCronogramaEdicao tr:first');
        const mesNomeAtual = primeiraLinha.find('td').eq(1).text().trim();
        
        // Extrair mês e ano do formato "jan/25"
        const partes = mesNomeAtual.split('/');
        const meses = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
        const mesIndex = meses.indexOf(partes[0]);
        const ano = parseInt('20' + partes[1]);
        
        // Calcular mês anterior
        let mesAnteriorIndex = mesIndex - 1;
        let anoAnterior = ano;
        if (mesAnteriorIndex < 0) {
            mesAnteriorIndex = 11;
            anoAnterior = ano - 1;
        }
        
        const mesNomeNovo = `${meses[mesAnteriorIndex]}/${String(anoAnterior).slice(-2)}`;
        const dataCompleta = `${anoAnterior}-${String(mesAnteriorIndex + 1).padStart(2, '0')}-01`;
        
        // Criar nova linha
        const tr = $('<tr>');
        tr.attr('data-nome-mes', dataCompleta);
        tr.attr('data-valor-mes', '0.00');
        tr.attr('data-info-alteracao', 'Base');
        
        // Info Alteração - input editável com conversão automática (padrão: Base = "-")
        const tdInfoAlteracao = $('<td>');
        const inputInfoAlteracao = $('<input>').attr({
            type: 'text',
            maxlength: '2',
            placeholder: '-'
        }).addClass('form-control form-control-sm text-center cronograma-edicao-info-alteracao').val('-');
        tdInfoAlteracao.append(inputInfoAlteracao);
        tr.append(tdInfoAlteracao);
        
        tr.append($('<td>').addClass('fw-bold').text(mesNomeNovo));
        tr.append($('<td>').html('<input type="text" class="form-control form-control-sm cronograma-edicao-val-23" value="0,00" data-original="0">'));
        tr.append($('<td>').html('<input type="text" class="form-control form-control-sm cronograma-edicao-val-24" value="0,00" data-original="0">'));
        tr.append($('<td>').addClass('cronograma-edicao-total-mes fw-bold text-end').html('R$ 0,00'));
        tr.append($('<td>').addClass('text-muted').text(''));
        
        // Botão excluir
        const tdAcao = $('<td>').addClass('text-center');
        const btnExcluir = $('<button>')
            .addClass('btn btn-sm btn-danger')
            .html('<i class="bi bi-trash"></i>')
            .attr('title', 'Excluir linha')
            .on('click', function() {
                if (confirm('Deseja realmente excluir este mês?')) {
                    tr.remove();
                    recalcularTotaisCronogramaEdicao();
                }
            });
        tdAcao.append(btnExcluir);
        tr.append(tdAcao);
        
        $('#corpoTabelaCronogramaEdicao').prepend(tr);
        
        // Aplicar eventos
        tr.find('.cronograma-edicao-val-23, .cronograma-edicao-val-24').on('input', function() {
            validarLinhaCronogramaEdicao(tr);
        });
        
        recalcularTotaisCronogramaEdicao();
        
        // Scroll para o topo
        $('.table-responsive').scrollTop(0);
    }
    
    // Adicionar mês no final do cronograma de edição
    function adicionarMesFinalCronogramaEdicao() {
        const totalLinhas = $('#corpoTabelaCronogramaEdicao tr').length;
        
        if (totalLinhas === 0) {
            alert('⚠️ Nenhum cronograma carregado. Carregue um termo primeiro.');
            return;
        }
        
        // Pegar última linha para calcular próximo mês
        const ultimaLinha = $('#corpoTabelaCronogramaEdicao tr:last');
        const mesNomeAtual = ultimaLinha.find('td').eq(1).text().trim();
        
        // Extrair mês e ano do formato "jan/25"
        const partes = mesNomeAtual.split('/');
        const meses = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
        const mesIndex = meses.indexOf(partes[0]);
        const ano = parseInt('20' + partes[1]);
        
        // Calcular próximo mês
        let proximoMesIndex = mesIndex + 1;
        let proximoAno = ano;
        if (proximoMesIndex > 11) {
            proximoMesIndex = 0;
            proximoAno = ano + 1;
        }
        
        const mesNomeNovo = `${meses[proximoMesIndex]}/${String(proximoAno).slice(-2)}`;
        const dataCompleta = `${proximoAno}-${String(proximoMesIndex + 1).padStart(2, '0')}-01`;
        
        // Criar nova linha
        const tr = $('<tr>');
        tr.attr('data-nome-mes', dataCompleta);
        tr.attr('data-valor-mes', '0.00');
        tr.attr('data-info-alteracao', 'Base');
        
        // Info Alteração - input editável com conversão automática (padrão: Base = "-")
        const tdInfoAlteracao = $('<td>');
        const inputInfoAlteracao = $('<input>').attr({
            type: 'text',
            maxlength: '2',
            placeholder: '-'
        }).addClass('form-control form-control-sm text-center cronograma-edicao-info-alteracao').val('-');
        tdInfoAlteracao.append(inputInfoAlteracao);
        tr.append(tdInfoAlteracao);
        
        tr.append($('<td>').addClass('fw-bold').text(mesNomeNovo));
        tr.append($('<td>').html('<input type="text" class="form-control form-control-sm cronograma-edicao-val-23" value="0,00" data-original="0">'));
        tr.append($('<td>').html('<input type="text" class="form-control form-control-sm cronograma-edicao-val-24" value="0,00" data-original="0">'));
        tr.append($('<td>').addClass('cronograma-edicao-total-mes fw-bold text-end').html('R$ 0,00'));
        tr.append($('<td>').addClass('text-muted').text(''));
        
        // Botão excluir
        const tdAcao = $('<td>').addClass('text-center');
        const btnExcluir = $('<button>')
            .addClass('btn btn-sm btn-danger')
            .html('<i class="bi bi-trash"></i>')
            .attr('title', 'Excluir linha')
            .on('click', function() {
                if (confirm('Deseja realmente excluir este mês?')) {
                    tr.remove();
                    recalcularTotaisCronogramaEdicao();
                }
            });
        tdAcao.append(btnExcluir);
        tr.append(tdAcao);
        
        $('#corpoTabelaCronogramaEdicao').append(tr);
        
        // Aplicar eventos
        tr.find('.cronograma-edicao-val-23, .cronograma-edicao-val-24').on('input', function() {
            validarLinhaCronogramaEdicao(tr);
        });
        
        recalcularTotaisCronogramaEdicao();
        
        // Scroll para o final
        const container = $('.table-responsive');
        container.scrollTop(container[0].scrollHeight);
    }
    
    // Limpar linhas duplicadas com valor zero
    function limparLinhasDuplicadasCronogramaEdicao() {
        const totalLinhas = $('#corpoTabelaCronogramaEdicao tr').length;
        
        if (totalLinhas === 0) {
            alert('⚠️ Nenhum cronograma carregado.');
            return;
        }
        
        // Mapear combinações de parcela_numero + mes/ano + total para identificar duplicatas
        const registrosMap = {};
        const linhasParaRemover = [];
        
        $('#corpoTabelaCronogramaEdicao tr').each(function(index) {
            const tr = $(this);
            const mesNome = tr.find('td').eq(1).text().trim(); // Mês/Ano (ex: "jan/25")
            const parcelaNumero = tr.find('.cronograma-edicao-parcela-numero').val().trim(); // Nº Parcela
            const val23 = parseFloat(tr.find('.cronograma-edicao-val-23').val().replace(',', '.')) || 0;
            const val24 = parseFloat(tr.find('.cronograma-edicao-val-24').val().replace(',', '.')) || 0;
            const total = val23 + val24;
            
            // Criar chave única: parcela_numero + mes/ano + total
            const chave = `${parcelaNumero}|${mesNome}|${total.toFixed(2)}`;
            
            // Verificar duplicatas
            if (registrosMap[chave]) {
                // Linha duplicada encontrada - marcar para remoção
                linhasParaRemover.push({
                    tr: tr, 
                    parcela: parcelaNumero,
                    mes: mesNome, 
                    total: total,
                    motivo: 'duplicada (mesmo parcela_numero, mês/ano e total)'
                });
            } else {
                // Primeira ocorrência desta combinação
                registrosMap[chave] = {tr: tr, parcela: parcelaNumero, mes: mesNome, total: total};
            }
            
            // Também identificar linhas com valor 0 duplicadas (lógica original mantida)
            const chaveMes = mesNome;
            if (total === 0) {
                const chaveZero = `zero|${chaveMes}`;
                if (registrosMap[chaveZero]) {
                    // Já existe uma linha com valor 0 para este mês
                    const jaAdicionada = linhasParaRemover.find(l => l.tr.is(tr));
                    if (!jaAdicionada) {
                        linhasParaRemover.push({
                            tr: tr,
                            parcela: parcelaNumero,
                            mes: mesNome,
                            total: total,
                            motivo: 'duplicada com valor 0'
                        });
                    }
                } else {
                    registrosMap[chaveZero] = {tr: tr, parcela: parcelaNumero, mes: mesNome, total: total};
                }
            }
        });
        
        if (linhasParaRemover.length === 0) {
            alert('✅ Nenhuma linha duplicada encontrada.');
            return;
        }
        
        // Montar mensagem detalhada
        let mensagemDetalhes = linhasParaRemover.map(item => 
            `• ${item.parcela} - ${item.mes} - R$ ${item.total.toFixed(2)}`
        ).join('\n');
        
        const mensagem = `🗑️ Encontradas ${linhasParaRemover.length} linha(s) duplicada(s):\n\n${mensagemDetalhes}\n\nDeseja remover?`;
        
        if (confirm(mensagem)) {
            linhasParaRemover.forEach(item => item.tr.remove());
            recalcularTotaisCronogramaEdicao();
            alert(`✅ ${linhasParaRemover.length} linha(s) removida(s) com sucesso!`);
        }
    }
    
    // ⚡ NOVA FUNÇÃO: Gerar todos os meses baseado nas vigências das parcelas
    function gerarTodosMesesPorVigencia() {
        const numeroTermo = $('#cronograma_numero_termo_hidden').val();
        
        if (!numeroTermo) {
            alert('❌ Erro: Número do termo não identificado.');
            return;
        }
        
        console.log('🔍 Buscando vigências para termo:', numeroTermo);
        
        // Buscar parcelas para extrair vigências
        $.ajax({
            url: `/gestao_financeira/ultra-liquidacoes/api/termo/${numeroTermo}/parcelas`,
            method: 'GET',
            success: function(response) {
                if (!response.parcelas || response.parcelas.length === 0) {
                    alert('⚠️ Nenhuma parcela encontrada para este termo.');
                    return;
                }
                
                console.log('📊 Parcelas recebidas:', response.parcelas.length);
                
                // Encontrar vigência_inicial mínima e vigência_final máxima
                let vigenciaMin = null;
                let vigenciaMax = null;
                
                response.parcelas.forEach(p => {
                    if (p.vigencia_inicial) {
                        const dataInicio = new Date(p.vigencia_inicial);
                        if (!vigenciaMin || dataInicio < vigenciaMin) {
                            vigenciaMin = dataInicio;
                        }
                    }
                    
                    if (p.vigencia_final) {
                        const dataFim = new Date(p.vigencia_final);
                        if (!vigenciaMax || dataFim > vigenciaMax) {
                            vigenciaMax = dataFim;
                        }
                    }
                });
                
                if (!vigenciaMin || !vigenciaMax) {
                    alert('⚠️ Não foi possível determinar o período de vigência das parcelas.');
                    return;
                }
                
                console.log('📅 Vigência mínima:', vigenciaMin.toISOString());
                console.log('📅 Vigência máxima:', vigenciaMax.toISOString());
                
                // Formatar datas para exibição
                const dataInicioFormatada = `${String(vigenciaMin.getMonth() + 1).padStart(2, '0')}/${vigenciaMin.getFullYear()}`;
                const dataFimFormatada = `${String(vigenciaMax.getMonth() + 1).padStart(2, '0')}/${vigenciaMax.getFullYear()}`;
                
                // Calcular quantos meses serão gerados
                const totalMeses = Math.ceil((vigenciaMax - vigenciaMin) / (1000 * 60 * 60 * 24 * 30)) + 1;
                
                const mensagem = `📅 Adicionar todos os meses entre:\n\n` +
                    `Início: ${dataInicioFormatada}\n` +
                    `Fim: ${dataFimFormatada}\n\n` +
                    `Aproximadamente ${totalMeses} meses serão adicionados.\n\n` +
                    `⚠️ ATENÇÃO: Isso irá LIMPAR o cronograma atual!\n\n` +
                    `Deseja continuar?`;
                
                if (!confirm(mensagem)) {
                    return;
                }
                
                // Limpar cronograma atual
                $('#corpoTabelaCronogramaEdicao').empty();
                
                // Gerar todos os meses
                const meses = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
                const dataAtual = new Date(vigenciaMin);
                dataAtual.setDate(1); // Primeiro dia do mês
                
                let mesesGerados = 0;
                
                while (dataAtual <= vigenciaMax) {
                    const mes = dataAtual.getMonth() + 1; // 1-12
                    const ano = dataAtual.getFullYear();
                    const mesNome = `${meses[mes - 1]}/${String(ano).slice(-2)}`;
                    
                    const tr = $('<tr>');
                    
                    // Info Alteração
                    const tdInfoAlteracao = $('<td>');
                    const inputInfoAlteracao = $('<input>').attr({
                        type: 'text',
                        maxlength: '2',
                        placeholder: '-'
                    }).addClass('form-control form-control-sm text-center cronograma-edicao-info-alteracao').val('-');
                    tdInfoAlteracao.append(inputInfoAlteracao);
                    tr.append(tdInfoAlteracao);
                    
                    // Mês/Ano
                    tr.append($('<td>').addClass('fw-bold').text(mesNome));
                    
                    // Valor 53-23
                    tr.append($('<td>').html(`<input type="text" class="form-control form-control-sm cronograma-edicao-val-23" value="0,00" data-original="0.00">`));
                    
                    // Valor 53-24
                    tr.append($('<td>').html(`<input type="text" class="form-control form-control-sm cronograma-edicao-val-24" value="0,00" data-original="0.00">`));
                    
                    // Total Mês
                    const tdTotal = $('<td>').addClass('cronograma-edicao-total-mes fw-bold text-end');
                    tdTotal.html('R$ 0,00');
                    tr.append(tdTotal);
                    
                    // Nº Parcela
                    const tdParcela = $('<td>');
                    const inputParcela = $('<input>')
                        .attr('type', 'text')
                        .addClass('form-control form-control-sm cronograma-edicao-parcela-numero')
                        .val('')
                        .attr('placeholder', 'Ex: 12ª Parcela')
                        .attr('data-original', '');
                    tdParcela.append(inputParcela);
                    tr.append(tdParcela);
                    
                    // Ações
                    const tdAcao = $('<td>').addClass('text-center');
                    const btnExcluir = $('<button>')
                        .addClass('btn btn-sm btn-danger')
                        .html('<i class="bi bi-trash"></i>')
                        .attr('title', 'Excluir linha')
                        .on('click', function() {
                            if (confirm('Deseja excluir esta linha do cronograma?')) {
                                tr.remove();
                                recalcularTotaisCronogramaEdicao();
                            }
                        });
                    tdAcao.append(btnExcluir);
                    tr.append(tdAcao);
                    
                    // Armazenar dados na linha
                    tr.attr('data-nome-mes', `${ano}-${String(mes).padStart(2, '0')}-01`);
                    tr.attr('data-id', ''); // Sem ID = nova linha
                    tr.attr('data-info-alteracao', 'Base');
                    tr.attr('data-valor-mes', '0.00');
                    
                    $('#corpoTabelaCronogramaEdicao').append(tr);
                    
                    mesesGerados++;
                    
                    // Avançar para o próximo mês
                    dataAtual.setMonth(dataAtual.getMonth() + 1);
                }
                
                console.log(`✅ ${mesesGerados} meses gerados com sucesso!`);
                
                // Adicionar eventos aos inputs
                $('.cronograma-edicao-val-23, .cronograma-edicao-val-24').on('input', function() {
                    const tr = $(this).closest('tr');
                    atualizarTotalMesLinhaEdicao(tr);
                });
                
                $('.cronograma-edicao-val-23, .cronograma-edicao-val-24').on('blur', function() {
                    const tr = $(this).closest('tr');
                    atualizarTotalMesLinhaEdicao(tr);
                    recalcularTotaisCronogramaEdicao();
                });
                
                recalcularTotaisCronogramaEdicao();
                $('#semCronogramaEdicao').hide();
                
                alert(`✅ ${mesesGerados} meses adicionados com sucesso!\n\nPeríodo: ${dataInicioFormatada} até ${dataFimFormatada}`);
            },
            error: function(xhr, status, error) {
                console.error('❌ Erro ao buscar parcelas:', error);
                alert('❌ Erro ao buscar parcelas do termo.');
            }
        });
        
        if (confirm(mensagem)) {
            linhasParaRemover.forEach(item => {
                console.log(`🗑️ Removendo: ${item.parcela} - ${item.mes} - R$ ${item.total.toFixed(2)} (${item.motivo})`);
                item.tr.remove();
            });
            
            recalcularTotaisCronogramaEdicao();
            alert(`✅ ${linhasParaRemover.length} linha(s) removida(s) com sucesso!`);
        }
    }
    
    // Habilitar colar do Excel no cronograma de edição
    function habilitarColarExcelCronogramaEdicao() {
        $('#corpoTabelaCronogramaEdicao').off('paste').on('paste', 'input, select', function(e) {
            e.preventDefault();
            
            const clipboardData = e.originalEvent.clipboardData || window.clipboardData;
            const pastedData = clipboardData.getData('text');
            
            console.log('📋 Dados colados do Excel:', pastedData);
            
            // Dividir em linhas e colunas
            const linhas = pastedData.split('\n').filter(l => l.trim());
            const dados = linhas.map(linha => linha.split('\t'));
            
            console.log('📋 Dados parseados:', dados);
            
            // Encontrar a linha e coluna atual
            const inputAtual = $(this);
            const trAtual = inputAtual.closest('tr');
            const indexLinhaAtual = $('#corpoTabelaCronogramaEdicao tr').index(trAtual);
            
            // Determinar qual coluna é (info_alteracao=0, mes=1, val23=2, val24=3, parcela=4)
            let indexColunaAtual = 0;
            if (inputAtual.hasClass('cronograma-edicao-val-23')) indexColunaAtual = 2;
            else if (inputAtual.hasClass('cronograma-edicao-val-24')) indexColunaAtual = 3;
            else if (inputAtual.hasClass('cronograma-edicao-parcela-numero')) indexColunaAtual = 4;
            else if (inputAtual.hasClass('cronograma-edicao-info-alteracao')) indexColunaAtual = 0;
            
            console.log(`🔹 Começando na linha ${indexLinhaAtual}, coluna ${indexColunaAtual}`);
            
            // Colar dados nas células
            dados.forEach((linhaDados, offsetLinha) => {
                const indexLinha = indexLinhaAtual + offsetLinha;
                const tr = $(`#corpoTabelaCronogramaEdicao tr:eq(${indexLinha})`);
                
                if (tr.length === 0) {
                    console.log(`⚠️ Linha ${indexLinha} não existe, pulando...`);
                    return;
                }
                
                linhaDados.forEach((valor, offsetColuna) => {
                    const indexColuna = indexColunaAtual + offsetColuna;
                    
                    // Mapear coluna para seletor
                    let input;
                    if (indexColuna === 0) {
                        input = tr.find('.cronograma-edicao-info-alteracao');
                    } else if (indexColuna === 2) {
                        input = tr.find('.cronograma-edicao-val-23');
                    } else if (indexColuna === 3) {
                        input = tr.find('.cronograma-edicao-val-24');
                    } else if (indexColuna === 4) {
                        input = tr.find('.cronograma-edicao-parcela-numero');
                    }
                    
                    if (input && input.length > 0) {
                        let valorLimpo = valor;
                        
                        // Se for campo monetário, limpar e converter
                        if (indexColuna === 2 || indexColuna === 3) {
                            // Remover R$, espaços, pontos de milhar
                            valorLimpo = valor.replace(/[R$\s]/g, '').replace(/\./g, '').replace(',', '.');
                            const numero = parseFloat(valorLimpo);
                            if (!isNaN(numero)) {
                                valorLimpo = numero.toFixed(2).replace('.', ',');
                            }
                        } else {
                            // Para outros campos (parcela_numero, info_alteracao), manter espaços
                            valorLimpo = valor.trim(); // Apenas remove espaços das pontas
                        }
                        
                        input.val(valorLimpo);
                        console.log(`  ✅ Linha ${indexLinha}, Col ${indexColuna}: ${valorLimpo}`);
                    }
                });
                
                // Revalidar linha
                validarLinhaCronogramaEdicao(tr);
            });
            
            recalcularTotaisCronogramaEdicao();
            console.log('✅ Paste concluído!');
        });
    }
    
    // Salvar alterações do cronograma
    function salvarCronogramaEdicao() {
        console.log('🔄 DEBUG: Iniciando salvarCronogramaEdicao()');
        
        const numeroTermo = $('#cronograma_numero_termo_hidden').val();
        console.log('🔑 DEBUG: numeroTermo =', numeroTermo);
        
        if (!numeroTermo) {
            alert('⚠️ Erro: termo não identificado.');
            return;
        }
        
        const cronograma = [];
        let mesAtual = null;
        let problemasEncontrados = [];
        
        // Contar linhas na tabela
        const totalLinhas = $('#corpoTabelaCronogramaEdicao tr').length;
        console.log('📊 DEBUG: Total de linhas na tabela:', totalLinhas);
        
        $('#corpoTabelaCronogramaEdicao tr').each(function(index) {
            const tr = $(this);
            
            // Converter valor digitado para formato do banco (- → Base, 1 → Aditivo 1, etc.)
            const valorDigitado = tr.find('.cronograma-edicao-info-alteracao').val();
            const infoAlteracao = converterInfoAlteracao(valorDigitado);
            
            const mesNome = tr.find('td').eq(1).text().trim();
            
            // 🔥 CORREÇÃO CRÍTICA: Coletar valores com fallback para data-original
            const input23 = tr.find('.cronograma-edicao-val-23');
            const input24 = tr.find('.cronograma-edicao-val-24');
            
            // Tentar pegar do value, se estiver vazio ou zero, usar data-original
            let val23Raw = input23.val();
            let val24Raw = input24.val();
            
            // Parse dos valores
            let val23 = parseFloat(val23Raw ? val23Raw.replace(',', '.') : '0') || 0;
            let val24 = parseFloat(val24Raw ? val24Raw.replace(',', '.') : '0') || 0;
            
            // 🔥 SE AMBOS FOREM ZERO, tentar recuperar do data-original
            if (val23 === 0 && val24 === 0) {
                const original23 = parseFloat(input23.attr('data-original')) || 0;
                const original24 = parseFloat(input24.attr('data-original')) || 0;
                
                // Se tinha valores originais mas agora estão zerados, usar os originais
                if (original23 !== 0 || original24 !== 0) {
                    console.log(`⚠️ Linha ${index + 1} (${mesNome}): Valores zerados, usando originais: 23=${original23}, 24=${original24}`);
                    val23 = original23;
                    val24 = original24;
                    problemasEncontrados.push(`${mesNome}: Restaurado valores originais`);
                }
            }
            
            const parcela_numero = tr.find('.cronograma-edicao-parcela-numero').val() || '';
            const valorMes = val23 + val24;
            
            if (index === 0) {
                console.log('🔍 DEBUG Primeira linha:', {
                    mesNome, 
                    val23, 
                    val24, 
                    valorMes, 
                    parcela_numero, 
                    infoAlteracao,
                    val23Raw,
                    val24Raw,
                    original23: input23.attr('data-original'),
                    original24: input24.attr('data-original')
                });
            }
            
            // Recriar data com base no mesNome (exemplo: "jan/25")
            // Precisamos inferir a data completa
            const partesMes = mesNome.split('/');
            if (partesMes.length === 2) {
                const mesAbrev = partesMes[0].toLowerCase();
                const ano = parseInt('20' + partesMes[1]);
                
                const mesesMap = {
                    'jan': 1, 'fev': 2, 'mar': 3, 'abr': 4, 'mai': 5, 'jun': 6,
                    'jul': 7, 'ago': 8, 'set': 9, 'out': 10, 'nov': 11, 'dez': 12
                };
                
                const mesNum = mesesMap[mesAbrev];
                if (mesNum) {
                    const dataCompleta = new Date(ano, mesNum - 1, 1);
                    mesAtual = dataCompleta.toISOString().split('T')[0];
                }
            }
            
            if (mesAtual) {
                cronograma.push({
                    info_alteracao: infoAlteracao,
                    nome_mes: mesAtual,
                    valor_mes_23: val23,
                    valor_mes_24: val24,
                    valor_mes: valorMes,
                    parcela_numero: parcela_numero
                });
            }
        });
        
        if (cronograma.length === 0) {
            alert('⚠️ Nenhum dado para salvar.');
            return;
        }
        
        console.log('📊 DEBUG: Cronograma a ser enviado:', cronograma);
        console.log('📊 DEBUG: Total de linhas:', cronograma.length);
        
        // Mostrar problemas encontrados
        if (problemasEncontrados.length > 0) {
            console.warn('⚠️ Problemas corrigidos automaticamente:', problemasEncontrados);
            const mensagemProblemas = problemasEncontrados.join('\n');
            alert(`⚠️ ATENÇÃO: Valores zerados foram restaurados:\n\n${mensagemProblemas}\n\nVerifique se está correto antes de confirmar.`);
        }
        
        // Contar quantos meses têm valores não-zero
        const mesesComValores = cronograma.filter(m => m.valor_mes > 0).length;
        const mensagemConfirm = `Confirma a atualização do cronograma?\n\n` +
            `Total de meses: ${cronograma.length}\n` +
            `Meses com valores: ${mesesComValores}\n` +
            `Meses zerados: ${cronograma.length - mesesComValores}`;
        
        if (!confirm(mensagemConfirm)) {
            return;
        }
        
        // Mostrar loading
        const btnSalvar = $('#btnSalvarCronogramaEdicao');
        btnSalvar.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Salvando...');
        
        $.ajax({
            url: '/gestao_financeira/ultra-liquidacoes/api/salvar-cronograma',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                numero_termo: numeroTermo,
                cronograma: cronograma,
                info_alteracao: 'Base'  // Este campo é mantido por compatibilidade, mas cada linha tem seu próprio info_alteracao
            }),
            success: function(response) {
                btnSalvar.prop('disabled', false).html('💾 Salvar Alterações');
                
                if (response.success) {
                    alert(`✅ Cronograma atualizado com sucesso!\n\n${response.linhas_afetadas} registros salvos.`);
                    // Recarregar o cronograma para refletir as mudanças
                    carregarCronogramaEdicao(numeroTermo);
                } else {
                    alert('⚠️ Erro: ' + (response.error || 'Erro desconhecido'));
                }
            },
            error: function(xhr) {
                btnSalvar.prop('disabled', false).html('💾 Salvar Alterações');
                alert('❌ Erro ao salvar cronograma: ' + (xhr.responseJSON?.error || 'Erro desconhecido'));
                console.error('Erro completo:', xhr);
            }
        });
    }
    
    // ==================== FIM FUNÇÕES CRONOGRAMA EDIÇÃO ====================
    
    // Carregar termos disponíveis (que não estão em ultra_liquidacoes)
    function carregarTermosDisponiveis() {
        $('#loadingTermos').show();
        $('#novo_numero_termo').html('<option value="">Carregando...</option>').prop('disabled', true);
        $('#btnConfirmarAdicionarParcelas').prop('disabled', true);
        $('#info_termo_selecionado').hide();
        
        $.ajax({
            url: '/gestao_financeira/ultra-liquidacoes/api/termos-disponiveis',
            method: 'GET',
            success: function(response) {
                $('#loadingTermos').hide();
                
                if (response.success && response.termos.length > 0) {
                    $('#novo_numero_termo').html('<option value="">Selecione um termo...</option>');
                    
                    response.termos.forEach(function(termo) {
                        let textoOpcao = `${termo.numero_termo} - ${termo.osc}`;
                        if (termo.tipo_disponibilidade === 'prorrogacao') {
                            textoOpcao += ' [PRORROGAÇÃO]';
                        }
                        
                        const option = $('<option>')
                            .val(termo.numero_termo)
                            .text(textoOpcao)
                            .data('termo-info', termo);
                        $('#novo_numero_termo').append(option);
                    });
                    
                    $('#novo_numero_termo').prop('disabled', false);
                } else {
                    $('#novo_numero_termo').html('<option value="">Nenhum termo disponível</option>');
                    alert('ℹ️ Não há termos disponíveis para adicionar. Todos os termos elegíveis já possuem parcelas cadastradas.');
                }
            },
            error: function(xhr) {
                $('#loadingTermos').hide();
                alert('Erro ao carregar termos: ' + (xhr.responseJSON?.error || 'Erro desconhecido'));
            }
        });
    }
    
    // Carregar termos de colaboração vigentes
    function carregarTermosColaboracaoVigentes() {
        $('#lista_termos_colaboracao').html('<option value="">Carregando...</option>');
        
        $.ajax({
            url: '/gestao_financeira/ultra-liquidacoes/api/termos-vigentes-colaboracao',
            method: 'GET',
            success: function(response) {
                if (response.success && response.termos.length > 0) {
                    $('#lista_termos_colaboracao').empty();
                    
                    response.termos.forEach(function(termo) {
                        const opcao = `${termo.numero_termo} - ${termo.osc} (até ${termo.vigencia_final})`;
                        const option = $('<option>')
                            .val(termo.numero_termo)
                            .text(opcao)
                            .data('termo-info', termo);
                        $('#lista_termos_colaboracao').append(option);
                    });
                } else {
                    $('#lista_termos_colaboracao').html('<option value="">Nenhum termo vigente encontrado</option>');
                }
            },
            error: function(xhr) {
                alert('Erro ao carregar termos de colaboração: ' + (xhr.responseJSON?.error || 'Erro desconhecido'));
            }
        });
    }
    
    // Alternar entre seleção normal e seleção de projetadas
    function alternarTipoSelecaoTermo() {
        const isProjetadas = $('#chk_parcelas_projetadas').is(':checked');
        
        if (isProjetadas) {
            $('#selecao_normal').hide();
            $('#selecao_projetadas').show();
            carregarTermosColaboracaoVigentes();
        } else {
            $('#selecao_normal').show();
            $('#selecao_projetadas').hide();
        }
        
        // Limpar seleções
        $('#novo_numero_termo').val('');
        $('#input_termo_colaboracao').val('');
        $('#info_termo_selecionado').hide();
        $('#btnAvancarCronograma').hide();
    }
    
    // Ao selecionar termo de colaboração no input
    $(document).on('change', '#input_termo_colaboracao', function() {
        const numeroTermo = $(this).val();
        
        if (numeroTermo) {
            // Buscar info do termo no datalist
            const option = $('#lista_termos_colaboracao option[value="' + numeroTermo + '"]');
            
            if (option.length > 0) {
                const termoInfo = option.data('termo-info');
                
                if (termoInfo) {
                    termoSelecionadoGlobal = termoInfo;
                    
                    $('#info_novo_osc').text(termoInfo.osc || '-');
                    $('#info_novo_cnpj').text(termoInfo.cnpj || '-');
                    $('#info_novo_vigencia').text(`${termoInfo.vigencia_inicio} a ${termoInfo.vigencia_final}`);
                    $('#info_novo_tipo').text(termoInfo.tipo_termo || '-');
                    $('#info_novo_sei_celeb').text(termoInfo.sei_celeb || '-');
                    $('#info_novo_sei_pc').text(termoInfo.sei_pc || '-');
                    
                    $('#info_termo_selecionado').show();
                    $('#btnAvancarCronograma').show();
                }
            }
        } else {
            termoSelecionadoGlobal = null;
            $('#info_termo_selecionado').hide();
            $('#btnAvancarCronograma').hide();
        }
    });
    
    // Ao selecionar um termo, mostrar suas informações
    $(document).on('change', '#novo_numero_termo', function() {
        const numeroTermo = $(this).val();
        
        if (numeroTermo) {
            const termoInfo = $(this).find('option:selected').data('termo-info');
            
            if (termoInfo) {
                // Salvar globalmente
                termoSelecionadoGlobal = termoInfo;
                
                // Adicionar edital_nome se não existir (para detectar emenda parlamentar)
                if (!termoInfo.edital_nome) {
                    termoInfo.edital_nome = '';  // Buscar do backend se necessário
                }
                
                $('#info_novo_osc').text(termoInfo.osc || '-');
                $('#info_novo_cnpj').text(termoInfo.cnpj || '-');
                $('#info_novo_vigencia').text(`${termoInfo.inicio} a ${termoInfo.final}`);
                $('#info_novo_tipo').text(termoInfo.tipo_contrato || '-');
                $('#info_novo_sei_celeb').text(termoInfo.sei_celeb || '-');
                $('#info_novo_sei_pc').text(termoInfo.sei_pc || '-');
                
                // Mostrar informação de prorrogação se aplicável
                if (termoInfo.info_prorrogacao) {
                    if ($('#info_prorrogacao').length === 0) {
                        $('#info_termo_selecionado').append(`
                            <div class="alert alert-info mt-2" id="info_prorrogacao">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Prorrogação detectada:</strong>
                                <span id="texto_prorrogacao"></span>
                            </div>
                        `);
                    }
                    $('#texto_prorrogacao').text(termoInfo.info_prorrogacao);
                    $('#info_prorrogacao').show();
                } else {
                    $('#info_prorrogacao').hide();
                }
                
                $('#info_termo_selecionado').show();
                
                // Mostrar botão de avançar ao invés de confirmar
                $('#btnAvancarCronograma').show();
            }
        } else {
            termoSelecionadoGlobal = null;
            $('#info_termo_selecionado').hide();
            $('#btnAvancarCronograma').hide();
        }
    });
    
    // Confirmar adição de parcelas
    function confirmarAdicionarParcelas() {
        const numeroTermo = $('#novo_numero_termo').val();
        
        if (!numeroTermo) {
            alert('⚠️ Selecione um termo antes de continuar.');
            return;
        }
        
        if (!confirm(`⚠️ Confirma a importação das parcelas do termo ${numeroTermo}?\n\nAs parcelas serão criadas automaticamente com base nas informações da parceria.`)) {
            return;
        }
        
        $('#btnConfirmarAdicionarParcelas').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Processando...');
        
        $.ajax({
            url: '/gestao_financeira/ultra-liquidacoes/api/adicionar-parcelas',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ numero_termo: numeroTermo }),
            success: function(response) {
                if (response.success) {
                    $('#modalAdicionarParcelas').modal('hide');
                    carregarDados();
                    alert(`✅ ${response.parcelas_criadas} parcelas adicionadas com sucesso para o termo ${numeroTermo}!`);
                }
            },
            error: function(xhr) {
                $('#btnConfirmarAdicionarParcelas').prop('disabled', false).html('<i class="bi bi-check-circle me-2"></i>Confirmar e Adicionar Parcelas');
                alert('Erro ao adicionar parcelas: ' + (xhr.responseJSON?.error || 'Erro desconhecido'));
            }
        });
    }
    
    // Helpers
    function formatarMoeda(valor) {
        return 'R$ ' + parseFloat(valor).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }
    
    function truncarTexto(texto, tamanho) {
        if (!texto) return '-';
        return texto.length > tamanho ? texto.substring(0, tamanho) + '...' : texto;
    }
    
    function converterDataParaInput(dataBr) {
        if (!dataBr) return '';
        const partes = dataBr.split('/');
        if (partes.length !== 3) return '';
        return `${partes[2]}-${partes[1]}-${partes[0]}`;
    }
    
    function converterDataParaMesAno(dataBr) {
        if (!dataBr) return '';
        const partes = dataBr.split('/');
        if (partes.length !== 3) return '';
        // dataBr = dd/mm/aaaa, retorna aaaa-mm
        return `${partes[2]}-${partes[1]}`;
    }
    
    function converterInputParaData(dataInput) {
        if (!dataInput) return '';
        const partes = dataInput.split('-');
        
        // Formato YYYY-MM (input type="month") → converter para 01/MM/YYYY
        if (partes.length === 2) {
            return `01/${partes[1]}/${partes[0]}`;
        }
        
        // Formato YYYY-MM-DD (input type="date") → converter para DD/MM/YYYY
        if (partes.length === 3) {
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        }
        
        return '';
    }
    
    // Formatar valor para moeda brasileira
    function formatarValorMonetario(valor) {
        if (!valor || valor === '') return '';
        // Remove R$, espaços, pontos de milhar e substitui vírgula por ponto
        let numero = valor.toString().replace(/[R$\s]/g, '').replace(/\./g, '').replace(',', '.');
        const valorFloat = parseFloat(numero);
        if (isNaN(valorFloat)) return '';
        
        return valorFloat.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    // Desformatar valor monetário para número
    function desformatarValorMonetario(valorFormatado) {
        if (!valorFormatado || valorFormatado === '') return null;
        // Remove tudo exceto números, pontos e vírgulas
        const limpo = valorFormatado.toString().replace(/[^\d,.]/g, '');
        // Remove TODOS os pontos (separadores de milhar) e substitui vírgula por ponto
        const numero = limpo.replace(/\./g, '').replace(',', '.');
        const valorFloat = parseFloat(numero);
        return isNaN(valorFloat) ? null : valorFloat;
    }
    
    // Aplicar máscara monetária em um input
    function aplicarMascaraMonetaria(input) {
        $(input).on('blur', function() {
            const valor = $(this).val();
            if (valor) {
                const valorFormatado = formatarValorMonetario(valor);
                $(this).val(valorFormatado);
                calcularSubtotais();
            }
        });
        
        $(input).on('focus', function() {
            // Remove formatação ao focar para facilitar edição
            const valor = $(this).val();
            if (valor) {
                const valorNum = desformatarValorMonetario(valor);
                if (valorNum !== null) {
                    $(this).val(valorNum.toString().replace('.', ','));
                }
            }
        });
    }
    
    // Calcular subtotais da tabela
    function calcularSubtotais() {
        let total23 = 0, total24 = 0, totalPrevisto = 0;
        let totalSubtraido = 0, totalEncaminhado = 0, totalPago = 0;
        
        $('#corpoTabelaColetiva tr').each(function() {
            const tr = $(this);
            
            const val23 = desformatarValorMonetario(tr.find('.edit-val-23').val()) || 0;
            const val24 = desformatarValorMonetario(tr.find('.edit-val-24').val()) || 0;
            const valPrevisto = desformatarValorMonetario(tr.find('.edit-val-previsto').val()) || 0;
            const valSubtraido = desformatarValorMonetario(tr.find('.edit-val-subtraido').val()) || 0;
            const valEncaminhado = desformatarValorMonetario(tr.find('.edit-val-encaminhado').val()) || 0;
            const valPago = desformatarValorMonetario(tr.find('.edit-val-pago').val()) || 0;
            
            total23 += val23;
            total24 += val24;
            totalPrevisto += valPrevisto;
            totalSubtraido += valSubtraido;
            totalEncaminhado += valEncaminhado;
            totalPago += valPago;
        });
        
        $('#subtotal-val-23').text('R$ ' + total23.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        $('#subtotal-val-24').text('R$ ' + total24.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        $('#subtotal-val-previsto').text('R$ ' + totalPrevisto.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        $('#subtotal-val-subtraido').text('R$ ' + totalSubtraido.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        $('#subtotal-val-encaminhado').text('R$ ' + totalEncaminhado.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        $('#subtotal-val-pago').text('R$ ' + totalPago.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
    }
    
    // ==================== FUNÇÕES PARA COLAR DO EXCEL ====================
    
    // Habilitar colar do Excel na tabela coletiva
    function habilitarColarExcelColetiva() {
        $('#corpoTabelaColetiva').off('paste').on('paste', 'input', function(e) {
            e.preventDefault();
            
            const clipboardData = e.originalEvent.clipboardData || window.clipboardData;
            const pastedData = clipboardData.getData('Text');
            
            // Verificar se são dados tabulados (Excel)
            if (!pastedData.includes('\t') && !pastedData.includes('\n')) {
                // Dados simples, colar normalmente
                $(this).val(pastedData);
                return;
            }
            
            // Processar dados tabulados
            const rows = pastedData.split('\n').filter(row => row.trim() !== '');
            const startCell = $(this);
            const startTr = startCell.closest('tr');
            const startTdIndex = startCell.closest('td').index();
            const startRowIndex = startTr.index();
            
            const allRows = $('#corpoTabelaColetiva tr');
            
            rows.forEach((rowData, rowOffset) => {
                const targetRowIndex = startRowIndex + rowOffset;
                if (targetRowIndex >= allRows.length) return; // Não extrapolar linhas
                
                const targetTr = $(allRows[targetRowIndex]);
                const cells = rowData.split('\t');
                
                cells.forEach((cellValue, colOffset) => {
                    const targetColIndex = startTdIndex + colOffset;
                    const targetTd = targetTr.find('td').eq(targetColIndex);
                    const input = targetTd.find('input, select');
                    
                    if (input.length > 0) {
                        const trimmedValue = cellValue.trim();
                        
                        // Se é input de valor monetário
                        if (input.hasClass('edit-val-23') || input.hasClass('edit-val-24') || 
                            input.hasClass('edit-val-previsto') || input.hasClass('edit-val-subtraido') ||
                            input.hasClass('edit-val-encaminhado') || input.hasClass('edit-val-pago')) {
                            
                            // Limpar e converter valor (aceita tanto . quanto , como decimal)
                            let valorLimpo = trimmedValue.replace(/[^\d.,\-]/g, '');
                            valorLimpo = valorLimpo.replace(',', '.');
                            const valorFloat = parseFloat(valorLimpo);
                            
                            if (!isNaN(valorFloat)) {
                                input.val(formatarValorMonetario(valorFloat));
                            }
                        }
                        // Se é data
                        else if (input.attr('type') === 'date') {
                            // Tentar converter formatos dd/mm/yyyy ou dd-mm-yyyy
                            const dateMatch = trimmedValue.match(/(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})/);
                            if (dateMatch) {
                                const [_, dia, mes, ano] = dateMatch;
                                input.val(`${ano}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`);
                            }
                        }
                        // Outros inputs (texto, select)
                        else {
                            input.val(trimmedValue);
                        }
                    }
                });
            });
            
            // Recalcular subtotais após colar
            calcularSubtotais();
        });
    }
    
    // Habilitar colar do Excel no cronograma
    function habilitarColarExcelCronograma() {
        $('#corpoTabelaCronogramaEdicao').off('paste').on('paste', 'input', function(e) {
            e.preventDefault();
            
            const clipboardData = e.originalEvent.clipboardData || window.clipboardData;
            const pastedData = clipboardData.getData('Text');
            
            // Verificar se são dados tabulados (Excel)
            if (!pastedData.includes('\t') && !pastedData.includes('\n')) {
                // Dados simples, colar normalmente
                const valorLimpo = pastedData.replace(/[^\d.,\-]/g, '').replace(',', '.');
                const valorFloat = parseFloat(valorLimpo);
                if (!isNaN(valorFloat)) {
                    $(this).val(valorFloat.toFixed(2).replace('.', ','));
                    validarLinhaCronogramaEdicao($(this).closest('tr'));
                }
                return;
            }
            
            // Processar dados tabulados
            const rows = pastedData.split('\n').filter(row => row.trim() !== '');
            const startCell = $(this);
            const startTr = startCell.closest('tr');
            const startTdIndex = startCell.closest('td').index();
            const startRowIndex = startTr.index();
            
            const allRows = $('#corpoTabelaCronogramaEdicao tr');
            
            rows.forEach((rowData, rowOffset) => {
                const targetRowIndex = startRowIndex + rowOffset;
                if (targetRowIndex >= allRows.length) return;
                
                const targetTr = $(allRows[targetRowIndex]);
                const cells = rowData.split('\t');
                
                cells.forEach((cellValue, colOffset) => {
                    const targetColIndex = startTdIndex + colOffset;
                    const targetTd = targetTr.find('td').eq(targetColIndex);
                    const input = targetTd.find('input.cronograma-edicao-val-23, input.cronograma-edicao-val-24');
                    
                    if (input.length > 0) {
                        // Limpar e converter valor
                        let valorLimpo = cellValue.trim().replace(/[^\d.,\-]/g, '');
                        valorLimpo = valorLimpo.replace(',', '.');
                        const valorFloat = parseFloat(valorLimpo);
                        
                        if (!isNaN(valorFloat)) {
                            input.val(valorFloat.toFixed(2).replace('.', ','));
                        }
                    }
                });
                
                // Validar linha após colar
                validarLinhaCronogramaEdicao(targetTr);
            });
            
            // Recalcular totais após colar
            recalcularTotaisCronogramaEdicao();
        });
    }
    
    // ==================== FIM FUNÇÕES COLAR DO EXCEL ====================
    
    // Formatar valor para moeda brasileira
    function formatarValorMonetario(valor) {
        if (!valor || valor === '') return '';
        // Remove R$, espaços, pontos de milhar e substitui vírgula por ponto
        let numero = valor.toString().replace(/[R$\s]/g, '').replace(/\./g, '').replace(',', '.');
        const valorFloat = parseFloat(numero);
        if (isNaN(valorFloat)) return '';
        
        return valorFloat.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    // Desformatar valor monetário para número (duplicata - usar parseMoedaBR quando possível)
    function desformatarValorMonetario(valorFormatado) {
        if (!valorFormatado || valorFormatado === '') return null;
        // Remove tudo exceto números, pontos e vírgulas
        const limpo = valorFormatado.toString().replace(/[^\d,.]/g, '');
        // Remove TODOS os pontos (separadores de milhar) e substitui vírgula por ponto
        const numero = limpo.replace(/\./g, '').replace(',', '.');
        const valorFloat = parseFloat(numero);
        return isNaN(valorFloat) ? null : valorFloat;
    }
    
    // Aplicar máscara monetária em um input
    function aplicarMascaraMonetaria(input) {
        $(input).on('blur', function() {
            const valor = $(this).val();
            if (valor) {
                const valorFormatado = formatarValorMonetario(valor);
                $(this).val(valorFormatado);
                calcularSubtotais();
            }
        });
        
        $(input).on('focus', function() {
            // Remove formatação ao focar para facilitar edição
            const valor = $(this).val();
            if (valor) {
                const valorNum = desformatarValorMonetario(valor);
                if (valorNum !== null) {
                    $(this).val(valorNum.toString().replace('.', ','));
                }
            }
        });
    }
    
    // Calcular subtotais da tabela
    function calcularSubtotais() {
        let total23 = 0, total24 = 0, totalPrevisto = 0;
        let totalSubtraido = 0, totalEncaminhado = 0, totalPago = 0;
        
        $('#corpoTabelaColetiva tr').each(function() {
            const tr = $(this);
            
            const val23 = desformatarValorMonetario(tr.find('.edit-val-23').val()) || 0;
            const val24 = desformatarValorMonetario(tr.find('.edit-val-24').val()) || 0;
            const valPrevisto = desformatarValorMonetario(tr.find('.edit-val-previsto').val()) || 0;
            const valSubtraido = desformatarValorMonetario(tr.find('.edit-val-subtraido').val()) || 0;
            const valEncaminhado = desformatarValorMonetario(tr.find('.edit-val-encaminhado').val()) || 0;
            const valPago = desformatarValorMonetario(tr.find('.edit-val-pago').val()) || 0;
            
            total23 += val23;
            total24 += val24;
            totalPrevisto += valPrevisto;
            totalSubtraido += valSubtraido;
            totalEncaminhado += valEncaminhado;
            totalPago += valPago;
        });
        
        $('#subtotal-val-23').text('R$ ' + total23.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        $('#subtotal-val-24').text('R$ ' + total24.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        $('#subtotal-val-previsto').text('R$ ' + totalPrevisto.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        $('#subtotal-val-subtraido').text('R$ ' + totalSubtraido.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        $('#subtotal-val-encaminhado').text('R$ ' + totalEncaminhado.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        $('#subtotal-val-pago').text('R$ ' + totalPago.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
    }
    
    // ==================== PERSISTÊNCIA DE FILTROS ====================
    
    // Salvar filtros no localStorage
    function salvarFiltros() {
        const filtros = {
            // Filtros de texto
            numero_termo: $('#filtro_numero_termo').val(),
            parcela_numero: $('#filtro_parcela_numero').val(),
            tipo_termo: $('#filtro_tipo_termo').val(),
            tipo_pendencia: $('#filtro_tipo_pendencia').val(),
            data_pagamento: $('#filtro_data_pagamento').val(),
            observacoes: $('#filtro_observacoes').val(),
            osc: $('#filtro_osc').val(),
            cnpj: $('#filtro_cnpj').val(),
            sei_celeb: $('#filtro_sei_celeb').val(),
            sei_pc: $('#filtro_sei_pc').val(),
            
            // Filtros de dropdowns
            parcela_tipo: $('#filtro_parcela_tipo').val(),
            
            // Filtros de vigência
            vig_inicial_mes: $('#filtro_vig_inicial_mes').val(),
            vig_inicial_ano: $('#filtro_vig_inicial_ano').val(),
            vig_final_mes: $('#filtro_vig_final_mes').val(),
            vig_final_ano: $('#filtro_vig_final_ano').val(),
            
            // Checkboxes de colunas
            chk_osc: $('#chk_osc').is(':checked'),
            chk_cnpj: $('#chk_cnpj').is(':checked'),
            chk_projeto: $('#chk_projeto').is(':checked'),
            chk_sei_celeb: $('#chk_sei_celeb').is(':checked'),
            chk_sei_pc: $('#chk_sei_pc').is(':checked'),
            
            // Seção ativa
            secao: secaoAtual
        };
        
        localStorage.setItem('ultra_liquidacoes_filtros', JSON.stringify(filtros));
        console.log('💾 Filtros salvos no localStorage');
    }
    
    // Restaurar filtros do localStorage
    function restaurarFiltros() {
        const filtrosSalvos = localStorage.getItem('ultra_liquidacoes_filtros');
        
        if (!filtrosSalvos) {
            console.log('ℹ️ Nenhum filtro salvo encontrado');
            return;
        }
        
        try {
            const filtros = JSON.parse(filtrosSalvos);
            console.log('📂 Restaurando filtros:', filtros);
            
            // Restaurar filtros de texto
            $('#filtro_numero_termo').val(filtros.numero_termo || '');
            $('#filtro_parcela_numero').val(filtros.parcela_numero || '');
            $('#filtro_tipo_termo').val(filtros.tipo_termo || '');
            $('#filtro_tipo_pendencia').val(filtros.tipo_pendencia || '');
            $('#filtro_data_pagamento').val(filtros.data_pagamento || '');
            $('#filtro_observacoes').val(filtros.observacoes || '');
            $('#filtro_osc').val(filtros.osc || '');
            $('#filtro_cnpj').val(filtros.cnpj || '');
            $('#filtro_sei_celeb').val(filtros.sei_celeb || '');
            $('#filtro_sei_pc').val(filtros.sei_pc || '');
            
            // Restaurar dropdowns
            $('#filtro_parcela_tipo').val(filtros.parcela_tipo || 'Programada');
            
            // Restaurar vigência
            $('#filtro_vig_inicial_mes').val(filtros.vig_inicial_mes || '');
            $('#filtro_vig_inicial_ano').val(filtros.vig_inicial_ano || '');
            $('#filtro_vig_final_mes').val(filtros.vig_final_mes || '');
            $('#filtro_vig_final_ano').val(filtros.vig_final_ano || '');
            
            // Restaurar checkboxes de colunas
            $('#chk_osc').prop('checked', filtros.chk_osc || false);
            $('#chk_cnpj').prop('checked', filtros.chk_cnpj || false);
            $('#chk_projeto').prop('checked', filtros.chk_projeto || false);
            $('#chk_sei_celeb').prop('checked', filtros.chk_sei_celeb || false);
            $('#chk_sei_pc').prop('checked', filtros.chk_sei_pc || false);
            
            // Aplicar visibilidade das colunas
            document.querySelectorAll('.col-osc').forEach(el => {
                el.style.display = filtros.chk_osc ? '' : 'none';
            });
            document.querySelectorAll('.col-cnpj').forEach(el => {
                el.style.display = filtros.chk_cnpj ? '' : 'none';
            });
            document.querySelectorAll('.col-projeto').forEach(el => {
                el.style.display = filtros.chk_projeto ? '' : 'none';
            });
            document.querySelectorAll('.col-sei-celeb').forEach(el => {
                el.style.display = filtros.chk_sei_celeb ? '' : 'none';
            });
            document.querySelectorAll('.col-sei-pc').forEach(el => {
                el.style.display = filtros.chk_sei_pc ? '' : 'none';
            });
            
            // Restaurar seção ativa
            if (filtros.secao) {
                secaoAtual = filtros.secao;
                document.querySelectorAll('.secao-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                const tabAtiva = document.querySelector(`[data-secao="${filtros.secao}"]`);
                if (tabAtiva) {
                    tabAtiva.classList.add('active');
                }
            }
            
            console.log('✅ Filtros restaurados com sucesso');
        } catch (e) {
            console.error('❌ Erro ao restaurar filtros:', e);
            localStorage.removeItem('ultra_liquidacoes_filtros');
        }
    }
</script>


<!-- ============================================================================ -->
<!-- FUNCIONALIDADE: EXPORTAÇÃO CSV EDIÇÃO COLETIVA -->
<!-- ============================================================================ -->
<script>
    // ============================================================================
    // EXPORTAÇÃO CSV DA EDIÇÃO COLETIVA
    // ============================================================================
    $(document).on('click', '#btnExportarCSVColetivo', function() {
        const termo = $('#coletivo_numero_termo_hidden').val();
        if (!termo) {
            toastr.error('Nenhum termo carregado para exportação');
            return;
        }
        
        // Coletar dados da tabela
        const linhas = [];
        const cabecalho = [
            'Vigência Inicial',
            'Vigência Final',
            'Tipo Parcela',
            'Nº Parcela',
            'Valor 53/23',
            'Valor 53/24',
            'Valor Previsto',
            'Subtraído',
            'Encaminhado',
            'Pago',
            'Status',
            'Status Sec.',
            'Data Pgto'
        ];
        linhas.push(cabecalho.join(';'));
        
        $('#corpoTabelaColetiva tr').each(function() {
            const colunas = [];
            $(this).find('td').each(function(idx) {
                const input = $(this).find('input, select');
                let valor = '';
                if (input.length > 0) {
                    valor = input.val() || '';
                } else {
                    valor = $(this).text().trim();
                }
                // Remover ponto e vírgula do valor para não quebrar CSV
                valor = valor.replace(/;/g, ',');
                colunas.push(valor);
            });
            linhas.push(colunas.join(';'));
        });
        
        // Gerar CSV com UTF-8 BOM
        const BOM = '\uFEFF';
        const csvContent = BOM + linhas.join('\r\n');
        
        // Download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `edicao_coletiva_${termo.replace(/\//g, '_')}_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        toastr.success('CSV exportado com sucesso!');
    });
</script>

</html>
