<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ofícios, Documentos e Notificações - FAF</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
            padding-bottom: 40px;
        }
        .main-container {
            max-width: 98%;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .table-container {
            overflow-x: auto;
        }
        .table {
            font-size: 0.9rem;
        }
        .table th {
            background-color: #0d6efd;
            color: white;
            font-weight: 600;
            white-space: nowrap;
        }
        .badge-dilacao {
            font-size: 0.75rem;
        }
        .btn-action {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .filtros-card {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid main-container">
        <!-- Cabeçalho -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="bi bi-envelope-fill me-2 text-warning"></i>Ofícios, Documentos e Notificações</h2>
                <small class="text-muted">Gerenciamento de documentos e notificações de parcerias</small>
            </div>
            <div class="text-end">
                <small>Usuário: <strong>{{ user.email }}</strong></small><br>
                <small>Tipo: <span class="badge bg-info">{{ user.tipo_usuario }}</span></small><br>
                <a href="{{ url_for('main.index') }}" class="btn btn-sm btn-outline-secondary mt-2">
                    <i class="bi bi-arrow-left me-1"></i>Voltar
                </a>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filtros-card">
            <h5 class="mb-3"><i class="bi bi-funnel me-2"></i>Filtros de Pesquisa</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="filtroTipo" class="form-label">Tipo de Documento</label>
                    <select class="form-select" id="filtroTipo">
                        <option value="">Todos</option>
                        <!-- Preenchido via JavaScript -->
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="filtroAno" class="form-label">Ano</label>
                    <input type="number" class="form-control" id="filtroAno" placeholder="Ex: 2025">
                </div>
                <div class="col-md-2">
                    <label for="filtroNumero" class="form-label">Número</label>
                    <input type="number" class="form-control" id="filtroNumero" placeholder="Ex: 123">
                </div>
                <div class="col-md-3">
                    <label for="filtroTermo" class="form-label">Número do Termo</label>
                    <input type="text" class="form-control" id="filtroTermo" placeholder="Ex: TCV/119/2012...">
                </div>
                <div class="col-md-2">
                    <label for="filtroResponsavel" class="form-label">Responsável</label>
                    <select class="form-select" id="filtroResponsavel">
                        <option value="">Todos</option>
                        <!-- Preenchido via JavaScript -->
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="filtroStatus" class="form-label">Status</label>
                    <select class="form-select" id="filtroStatus">
                        <option value="">Todos</option>
                        <option value="Atrasado">Atrasado</option>
                        <option value="No prazo">No prazo</option>
                        <option value="Não aplicável">Não aplicável</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="filtroDocRespondido" class="form-label">Doc Respondido?</label>
                    <select class="form-select" id="filtroDocRespondido">
                        <option value="">Todos</option>
                        <option value="Sim">Sim</option>
                        <option value="Não">Não</option>
                        <option value="-">N/A</option>
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <button class="btn btn-primary" onclick="aplicarFiltros()">
                        <i class="bi bi-search me-2"></i>Buscar
                    </button>
                    <button class="btn btn-secondary" onclick="limparFiltros()">
                        <i class="bi bi-x-circle me-2"></i>Limpar Filtros
                    </button>
                    
                    <!-- Seletor de Limite -->
                    <div class="btn-group ms-3" role="group" aria-label="Limite de registros">
                        <span class="btn btn-outline-secondary disabled">Mostrar:</span>
                        <button type="button" class="btn btn-outline-primary" onclick="alterarLimite(100)">100</button>
                        <button type="button" class="btn btn-outline-primary" onclick="alterarLimite(200)">200</button>
                        <button type="button" class="btn btn-outline-primary" onclick="alterarLimite('todas')">Todas</button>
                    </div>
                    
                    <button class="btn btn-success float-end" onclick="abrirModalNovo()">
                        <i class="bi bi-plus-circle me-2"></i>Adicionar Notificação
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabela de Notificações -->
        <div class="table-container">
            <div id="loadingIndicator" class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-2">Carregando notificações...</p>
            </div>
            <table class="table table-striped table-hover" id="tabelaNotificacoes" style="display: none;">
                <thead>
                    <tr>
                        <th>Tipo Doc</th>
                        <th>Ano</th>
                        <th>Nº Doc</th>
                        <th>Nº Termo</th>
                        <th>Nº Processo</th>
                        <th>OSC</th>
                        <th>Responsável</th>
                        <th>Data Doc</th>
                        <th>Data Pub</th>
                        <th>Data Email/AR</th>
                        <th>Prazo</th>
                        <th>Status</th>
                        <th>Doc Respondido?</th>
                        <th>SEI Doc</th>
                        <th>Observações</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela">
                    <!-- Preenchido via JavaScript -->
                </tbody>
            </table>
            <div id="mensagemVazia" class="alert alert-info" style="display: none;">
                <i class="bi bi-info-circle me-2"></i>Nenhuma notificação encontrada com os filtros aplicados.
            </div>
        </div>
    </div>

    <!-- Modal Adicionar/Editar Notificação -->
    <div class="modal fade" id="modalNotificacao" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitulo">
                        <i class="bi bi-plus-circle me-2"></i>Nova Numeração de Documento
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formNotificacao">
                        <input type="hidden" id="notifId">
                        
                        <div class="row g-3">
                            <!-- Linha 1 -->
                            <div class="col-md-4">
                                <label for="tipoDoc" class="form-label">Tipo de Documento <span class="text-danger">*</span></label>
                                <select class="form-select" id="tipoDoc" required onchange="calcularPrazoFormulario()">
                                    <option value="">-- Selecione --</option>
                                    <!-- Preenchido via JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="anoDoc" class="form-label">Ano <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="anoDoc" min="2000" max="2099" required>
                            </div>
                            <div class="col-md-2">
                                <label for="numeroDoc" class="form-label">Número <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="numeroDoc" min="1" required>
                            </div>
                            <div class="col-md-4">
                                <label for="numeroTermo" class="form-label">Número do Termo</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="numeroTermo" 
                                       list="datalistNumerosTermo" 
                                       placeholder="Digite para buscar..." 
                                       autocomplete="off"
                                       onchange="calcularPrazoFormulario()">
                                <datalist id="datalistNumerosTermo">
                                    <!-- Preenchido via JavaScript -->
                                </datalist>
                            </div>

                            <!-- Linha 2 -->
                            <div class="col-md-4">
                                <label for="nomeResponsavel" class="form-label">Nome do Responsável</label>
                                <select class="form-select" id="nomeResponsavel">
                                    <option value="">-- Selecione --</option>
                                    <!-- Preenchido via JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="processoDoc" class="form-label">Nº Processo do Processo SEI</label>
                                <input type="text" class="form-control" id="processoDoc" placeholder="Ex: SEI 6019.2021/0001234-5">
                            </div>
                            <div class="col-md-4">
                                <label for="seiDoc" class="form-label">SEI do Documento</label>
                                <input type="text" class="form-control" id="seiDoc" placeholder="Ex: 65146846">
                            </div>

                            <!-- Linha 3 - Datas -->
                            <div class="col-md-4">
                                <label for="dataDoc" class="form-label">Data do Documento</label>
                                <input type="date" class="form-control" id="dataDoc">
                            </div>
                            <div class="col-md-4">
                                <label for="dataPub" class="form-label">Data de Publicação</label>
                                <input type="date" class="form-control" id="dataPub" onchange="calcularPrazoFormulario()">
                            </div>
                            <div class="col-md-4">
                                <label for="dataEmailAr" class="form-label">Data do E-mail ou AR</label>
                                <input type="datetime-local" class="form-control" id="dataEmailAr" onchange="calcularPrazoFormulario()">
                            </div>
                            <div class="col-md-3">
                                <label for="prazoCalculado" class="form-label">Prazo Calculado</label>
                                <input type="text" class="form-control" id="prazoCalculado" readonly style="background-color: #e9ecef; font-weight: bold;">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Documento Respondido?</label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="docRespondido" id="docRespondidoSim" value="true">
                                        <label class="form-check-label" for="docRespondidoSim">Sim</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="docRespondido" id="docRespondidoNao" value="false" checked>
                                        <label class="form-check-label" for="docRespondidoNao">Não</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Linha 4 - Dilação -->
                            <div class="col-md-3">
                                <label class="form-label">Dilação</label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="dilacao" id="dilacaoSim" value="true" onchange="toggleDilacaoDias()">
                                        <label class="form-check-label" for="dilacaoSim">Sim</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="dilacao" id="dilacaoNao" value="false" checked onchange="toggleDilacaoDias()">
                                        <label class="form-check-label" for="dilacaoNao">Não</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="dilacaoDias" class="form-label">Dias de Dilação</label>
                                <input type="number" class="form-control" id="dilacaoDias" value="0" min="0" disabled>
                            </div>

                            <!-- Linha 5 - Observações -->
                            <div class="col-12">
                                <label for="observacoes" class="form-label">Observações</label>
                                <textarea class="form-control" id="observacoes" rows="3"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="salvarNotificacao()">
                        <i class="bi bi-check-circle me-2"></i>Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let notificacoes = [];
        let tiposDocumento = [];
        let analistas = [];
        let numerosTermo = [];
        let modalNotificacao = null;
        let tiposCarregados = false;
        let analistasCarregados = false;
        let termosCarregados = false;
        let limiteAtual = 100; // Limite padrão

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[DEBUG] Inicializando página de notificações...');
            modalNotificacao = new bootstrap.Modal(document.getElementById('modalNotificacao'));
            carregarTiposDocumento();
            carregarAnalistas();
            carregarNumerosTermo();
            carregarNotificacoes();
            
            // Event listener para calcular próximo número quando tipo_doc mudar
            document.getElementById('tipoDoc').addEventListener('change', calcularProximoNumero);
            document.getElementById('anoDoc').addEventListener('change', calcularProximoNumero);
            
            // Event listener para autocomplete dinâmico
            document.getElementById('tipoDoc').addEventListener('input', function() {
                if (this.value.length >= 2) {
                    buscarTiposDocumento(this.value);
                }
            });
        });

        // Carregar tipos de documento (filtrados por tipo de usuário)
        async function carregarTiposDocumento() {
            if (tiposCarregados) {
                console.log('[DEBUG] Tipos de documento já carregados, pulando...');
                return;
            }
            
            try {
                console.log('[DEBUG] Carregando tipos de documento...');
                const response = await fetch('/parcerias_notificacoes/api/tipos-documento');
                if (!response.ok) throw new Error('Erro ao carregar tipos de documento');
                
                tiposDocumento = await response.json();
                console.log('[DEBUG] Tipos de documento recebidos:', tiposDocumento.length, tiposDocumento);
                
                const selectModal = document.getElementById('tipoDoc');
                const selectFiltro = document.getElementById('filtroTipo');
                
                selectModal.innerHTML = '<option value="">-- Selecione --</option>';
                // Manter "Todos" no filtro
                selectFiltro.innerHTML = '<option value="">Todos</option>';
                
                tiposDocumento.forEach(tipo => {
                    // Popular select do modal
                    const optionModal = document.createElement('option');
                    optionModal.value = tipo.tipo_documento;
                    optionModal.textContent = tipo.tipo_documento;
                    selectModal.appendChild(optionModal);
                    
                    // Popular select do filtro
                    const optionFiltro = document.createElement('option');
                    optionFiltro.value = tipo.tipo_documento;
                    optionFiltro.textContent = tipo.tipo_documento;
                    selectFiltro.appendChild(optionFiltro);
                });
                
                console.log('[DEBUG] Selects de tipo de documento populados com', tiposDocumento.length, 'opções');
                tiposCarregados = true;
            } catch (error) {
                console.error('[ERRO] ao carregar tipos de documento:', error);
                alert('Erro ao carregar tipos de documento: ' + error.message);
            }
        }
        
        // Autocomplete dinâmico para número do termo
        let timeoutBuscaTermo = null;
        async function buscarNumerosTermo(query) {
            try {
                console.log('[DEBUG] buscarNumerosTermo chamada com query:', query);
                if (timeoutBuscaTermo) clearTimeout(timeoutBuscaTermo);
                
                timeoutBuscaTermo = setTimeout(async () => {
                    console.log('[DEBUG] Executando busca após debounce...');
                    const url = `/parcerias_notificacoes/api/numeros-termo?q=${encodeURIComponent(query)}`;
                    console.log('[DEBUG] URL da busca:', url);
                    
                    const response = await fetch(url);
                    console.log('[DEBUG] Response status:', response.status);
                    
                    if (!response.ok) {
                        console.error('[DEBUG] Resposta não OK');
                        return;
                    }
                    
                    const data = await response.json();
                    console.log('[DEBUG] Dados recebidos:', data);
                    
                    const datalist = document.getElementById('datalistNumerosTermo');
                    if (!datalist) {
                        console.error('[DEBUG] ❌ Datalist não encontrado!');
                        return;
                    }
                    
                    console.log('[DEBUG] Limpando datalist...');
                    datalist.innerHTML = '';
                    
                    if (data.termos && data.termos.length > 0) {
                        console.log('[DEBUG] Populando datalist com', data.termos.length, 'termos');
                        data.termos.forEach(termo => {
                            const option = document.createElement('option');
                            option.value = termo;
                            datalist.appendChild(option);
                        });
                        console.log('[DEBUG] ✅ Datalist populado com sucesso!');
                    } else {
                        console.log('[DEBUG] ⚠️ Nenhum termo encontrado');
                    }
                }, 300); // Debounce de 300ms
            } catch (error) {
                console.error('[ERRO] ao buscar números de termo:', error);
            }
        }

        // Carregar analistas (filtrados por tipo de usuário)
        async function carregarAnalistas() {
            if (analistasCarregados) {
                console.log('[DEBUG] Analistas já carregados, pulando...');
                return;
            }
            
            try {
                console.log('[DEBUG] Carregando analistas...');
                const response = await fetch('/parcerias_notificacoes/api/analistas');
                if (!response.ok) throw new Error('Erro ao carregar analistas');
                
                analistas = await response.json();
                console.log('[DEBUG] Analistas recebidos:', analistas.length, analistas);
                
                // Preencher select do formulário
                const selectForm = document.getElementById('nomeResponsavel');
                selectForm.innerHTML = '<option value="">-- Selecione --</option>';
                
                analistas.forEach(nome => {
                    const option = document.createElement('option');
                    option.value = nome;
                    option.textContent = nome;
                    selectForm.appendChild(option);
                });
                
                // Preencher select do filtro
                const selectFiltro = document.getElementById('filtroResponsavel');
                selectFiltro.innerHTML = '<option value="">Todos</option>';
                
                analistas.forEach(nome => {
                    const option = document.createElement('option');
                    option.value = nome;
                    option.textContent = nome;
                    selectFiltro.appendChild(option);
                });
                
                console.log('[DEBUG] Selects de responsável populados com', analistas.length, 'opções');
                analistasCarregados = true;
            } catch (error) {
                console.error('[ERRO] ao carregar analistas:', error);
                alert('Erro ao carregar analistas: ' + error.message);
            }
        }

        // Carregar números de termo
        async function carregarNumerosTermo() {
            if (termosCarregados) {
                console.log('[DEBUG] Números de termo já carregados, pulando...');
                return;
            }
            
            try {
                console.log('[DEBUG] Carregando números de termo...');
                const response = await fetch('/parcerias_notificacoes/api/numeros-termo');
                if (!response.ok) throw new Error('Erro ao carregar números de termo');
                
                numerosTermo = await response.json();
                console.log('[DEBUG] Números de termo recebidos:', numerosTermo.length);
                
                // Preencher datalist do formulário
                const datalist = document.getElementById('datalistNumerosTermo');
                datalist.innerHTML = '';
                
                numerosTermo.forEach(termo => {
                    const option = document.createElement('option');
                    option.value = termo;
                    datalist.appendChild(option);
                });
                
                // Preencher select do filtro (mantém como select)
                const selectFiltro = document.getElementById('filtroTermo');
                selectFiltro.innerHTML = '<option value="">Todos</option>';
                
                numerosTermo.forEach(termo => {
                    const option = document.createElement('option');
                    option.value = termo;
                    option.textContent = termo;
                    selectFiltro.appendChild(option);
                });
                
                console.log('[DEBUG] Datalist de número de termo populado com', numerosTermo.length, 'opções');
                termosCarregados = true;
                
                // Adicionar event listener para autocomplete dinâmico
                const inputTermo = document.getElementById('numeroTermo');
                if (inputTermo) {
                    console.log('[DEBUG] ✅ Input numeroTermo encontrado! Adicionando event listener...');
                    inputTermo.addEventListener('input', function() {
                        console.log('[DEBUG] Input event disparado! Valor:', this.value, 'Length:', this.value.length);
                        if (this.value.length >= 2) {
                            buscarNumerosTermo(this.value);
                        }
                    });
                    console.log('[DEBUG] ✅ Event listener adicionado com sucesso!');
                } else {
                    console.error('[DEBUG] ❌ Input numeroTermo NÃO encontrado!');
                }
            } catch (error) {
                console.error('[ERRO] ao carregar números de termo:', error);
                alert('Erro ao carregar números de termo: ' + error.message);
            }
        }

        // Calcular próximo número de documento
        async function calcularProximoNumero() {
            const tipoDoc = document.getElementById('tipoDoc').value;
            const anoDoc = document.getElementById('anoDoc').value;
            
            if (!tipoDoc || !anoDoc) return;
            
            try {
                const response = await fetch(`/parcerias_notificacoes/api/proximo-numero?tipo_doc=${encodeURIComponent(tipoDoc)}&ano_doc=${anoDoc}`);
                if (!response.ok) throw new Error('Erro ao calcular próximo número');
                
                const data = await response.json();
                document.getElementById('numeroDoc').value = data.proximo_numero;
                console.log('[DEBUG] Próximo número calculado:', data.proximo_numero);
            } catch (error) {
                console.error('[ERRO] ao calcular próximo número:', error);
            }
        }

        // Calcular prazo no formulário
        async function calcularPrazoFormulario() {
            const tipoDoc = document.getElementById('tipoDoc').value;
            const numeroTermo = document.getElementById('numeroTermo').value;
            const dataPub = document.getElementById('dataPub').value;
            const dataEmailAr = document.getElementById('dataEmailAr').value;
            
            const prazoField = document.getElementById('prazoCalculado');
            
            if (!tipoDoc || !numeroTermo) {
                prazoField.value = '-';
                return;
            }
            
            if (!dataPub && !dataEmailAr) {
                prazoField.value = '-';
                return;
            }
            
            try {
                const params = new URLSearchParams({
                    tipo_doc: tipoDoc,
                    numero_termo: numeroTermo
                });
                
                if (dataPub) params.append('data_pub', dataPub);
                if (dataEmailAr) params.append('data_email_ar', dataEmailAr);
                
                const response = await fetch(`/parcerias_notificacoes/api/calcular-prazo?${params.toString()}`);
                if (!response.ok) throw new Error('Erro ao calcular prazo');
                
                const data = await response.json();
                prazoField.value = data.prazo_info || '-';
                console.log('[DEBUG] Prazo calculado:', data.prazo_info);
            } catch (error) {
                console.error('[ERRO] ao calcular prazo:', error);
                prazoField.value = 'Erro ao calcular';
            }
        }

        // Carregar notificações
        async function carregarNotificacoes() {
            try {
                document.getElementById('loadingIndicator').style.display = 'block';
                document.getElementById('tabelaNotificacoes').style.display = 'none';
                document.getElementById('mensagemVazia').style.display = 'none';

                const params = new URLSearchParams();
                
                const filtroTipo = document.getElementById('filtroTipo').value;
                const filtroAno = document.getElementById('filtroAno').value;
                const filtroNumero = document.getElementById('filtroNumero').value;
                const filtroTermo = document.getElementById('filtroTermo').value;
                const filtroResponsavel = document.getElementById('filtroResponsavel').value;
                const filtroStatus = document.getElementById('filtroStatus').value;
                const filtroDocRespondido = document.getElementById('filtroDocRespondido').value;
                
                if (filtroTipo) params.append('tipo_doc', filtroTipo);
                if (filtroAno) params.append('ano_doc', filtroAno);
                if (filtroNumero) params.append('numero_doc', filtroNumero);
                if (filtroTermo) params.append('numero_termo', filtroTermo);
                if (filtroResponsavel) params.append('nome_responsavel', filtroResponsavel);
                if (filtroStatus) params.append('status', filtroStatus);
                if (filtroDocRespondido) params.append('doc_respondido', filtroDocRespondido);
                
                // Adicionar limite
                params.append('limite', limiteAtual);

                const response = await fetch('/parcerias_notificacoes/api/notificacoes?' + params.toString());
                if (!response.ok) throw new Error('Erro ao carregar notificações');
                
                notificacoes = await response.json();
                renderizarTabela();
                
            } catch (error) {
                console.error('Erro ao carregar notificações:', error);
                alert('Erro ao carregar notificações: ' + error.message);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        // Renderizar tabela
        function renderizarTabela() {
            const tbody = document.getElementById('corpoTabela');
            tbody.innerHTML = '';

            if (notificacoes.length === 0) {
                document.getElementById('mensagemVazia').style.display = 'block';
                document.getElementById('tabelaNotificacoes').style.display = 'none';
                return;
            }

            document.getElementById('tabelaNotificacoes').style.display = 'table';
            document.getElementById('mensagemVazia').style.display = 'none';

            notificacoes.forEach(notif => {
                const tr = document.createElement('tr');
                
                // Processo final: processo_doc ou sei_pc da parceria
                const processoFinal = notif.processo_final || '-';
                
                // Status do prazo com cor
                let statusHtml = '-';
                if (notif.status_prazo === 'Atrasado') {
                    statusHtml = '<span class="badge bg-danger">Atrasado</span>';
                } else if (notif.status_prazo === 'No prazo') {
                    statusHtml = '<span class="badge bg-success">No prazo</span>';
                } else if (notif.status_prazo === 'Não aplicável') {
                    statusHtml = '<span class="badge bg-secondary">Não aplicável</span>';
                }
                
                // Documento respondido
                let docRespondidoHtml = '-';
                if (notif.doc_respondido_texto === 'Sim') {
                    docRespondidoHtml = '<span class="badge bg-primary">Sim</span>';
                } else if (notif.doc_respondido_texto === 'Não') {
                    docRespondidoHtml = '<span class="badge bg-secondary">Não</span>';
                } else if (notif.doc_respondido_texto === '-') {
                    docRespondidoHtml = '-';
                }
                
                tr.innerHTML = `
                    <td>${notif.tipo_doc || '-'}</td>
                    <td>${notif.ano_doc || '-'}</td>
                    <td>${notif.numero_doc || '-'}</td>
                    <td>${notif.numero_termo || '-'}</td>
                    <td>${processoFinal}</td>
                    <td>${notif.osc || '-'}</td>
                    <td>${notif.nome_responsavel || '-'}</td>
                    <td>${notif.data_doc ? formatarData(notif.data_doc) : '-'}</td>
                    <td>${notif.data_pub ? formatarData(notif.data_pub) : '-'}</td>
                    <td>${notif.data_email_ar ? formatarDataHora(notif.data_email_ar) : '-'}</td>
                    <td><strong>${notif.prazo_info || '-'}</strong></td>
                    <td>${statusHtml}</td>
                    <td>${docRespondidoHtml}</td>
                    <td>${notif.sei_doc || '-'}</td>
                    <td>${notif.observacoes ? (notif.observacoes.length > 30 ? notif.observacoes.substring(0, 30) + '...' : notif.observacoes) : '-'}</td>
                    <td class="text-nowrap">
                        <button class="btn btn-sm btn-warning btn-action me-1" onclick="editarNotificacao(${notif.id})" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger btn-action" onclick="excluirNotificacao(${notif.id})" title="Excluir">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        // Aplicar filtros
        function aplicarFiltros() {
            carregarNotificacoes();
        }

        // Limpar filtros
        function limparFiltros() {
            document.getElementById('filtroTipo').value = '';
            document.getElementById('filtroAno').value = '';
            document.getElementById('filtroNumero').value = '';
            document.getElementById('filtroTermo').value = '';
            document.getElementById('filtroResponsavel').value = '';
            document.getElementById('filtroStatus').value = '';
            document.getElementById('filtroDocRespondido').value = '';
            carregarNotificacoes();
        }

        // Alterar limite de registros
        function alterarLimite(novoLimite) {
            limiteAtual = novoLimite;
            console.log('[DEBUG] Limite alterado para:', novoLimite);
            carregarNotificacoes();
        }

        // Abrir modal para nova notificação
        function abrirModalNovo() {
            document.getElementById('formNotificacao').reset();
            document.getElementById('notifId').value = '';
            document.getElementById('modalTitulo').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Nova Numeração de Documento';
            document.getElementById('dilacaoDias').disabled = true;
            
            // Preencher automaticamente com valores padrão
            const hoje = new Date();
            document.getElementById('anoDoc').value = hoje.getFullYear();
            document.getElementById('dataDoc').value = hoje.toISOString().split('T')[0];
            
            // Limpar campo de número (será preenchido quando tipo_doc for selecionado)
            document.getElementById('numeroDoc').value = '';
            
            modalNotificacao.show();
        }

        // Editar notificação
        async function editarNotificacao(id) {
            try {
                console.log('[DEBUG] Editando notificação ID:', id);
                const response = await fetch(`/parcerias_notificacoes/api/notificacoes/${id}`);
                if (!response.ok) throw new Error('Erro ao carregar notificação');
                
                const notif = await response.json();
                console.log('[DEBUG] Dados da notificação:', notif);
                
                document.getElementById('notifId').value = notif.id;
                document.getElementById('anoDoc').value = notif.ano_doc || '';
                document.getElementById('numeroDoc').value = notif.numero_doc || '';
                document.getElementById('numeroTermo').value = notif.numero_termo || '';
                document.getElementById('processoDoc').value = notif.processo_doc || '';
                document.getElementById('seiDoc').value = notif.sei_doc || '';
                document.getElementById('dataDoc').value = notif.data_doc || '';
                document.getElementById('dataPub').value = notif.data_pub || '';
                document.getElementById('dataEmailAr').value = notif.data_email_ar ? notif.data_email_ar.replace(' ', 'T').substring(0, 16) : '';
                document.getElementById('observacoes').value = notif.observacoes || '';
                
                // Selecionar tipo de documento
                console.log('[DEBUG] Selecionando tipo de documento:', notif.tipo_doc);
                const selectTipo = document.getElementById('tipoDoc');
                selectTipo.value = notif.tipo_doc || '';
                console.log('[DEBUG] Valor do select após seleção:', selectTipo.value);
                
                // Selecionar responsável
                console.log('[DEBUG] Selecionando responsável:', notif.nome_responsavel);
                const selectResp = document.getElementById('nomeResponsavel');
                selectResp.value = notif.nome_responsavel || '';
                console.log('[DEBUG] Valor do select após seleção:', selectResp.value);
                
                if (notif.dilacao) {
                    document.getElementById('dilacaoSim').checked = true;
                    document.getElementById('dilacaoDias').disabled = false;
                } else {
                    document.getElementById('dilacaoNao').checked = true;
                    document.getElementById('dilacaoDias').disabled = true;
                }
                document.getElementById('dilacaoDias').value = notif.dilacao_dias || 0;
                
                // Documento Respondido
                if (notif.doc_respondido) {
                    document.getElementById('docRespondidoSim').checked = true;
                } else {
                    document.getElementById('docRespondidoNao').checked = true;
                }
                
                document.getElementById('modalTitulo').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Notificação';
                modalNotificacao.show();
                
                // Calcular prazo após preencher todos os campos
                setTimeout(() => calcularPrazoFormulario(), 100);
                
            } catch (error) {
                console.error('[ERRO] ao carregar notificação:', error);
                alert('Erro ao carregar notificação: ' + error.message);
            }
        }

        // Salvar notificação (criar ou editar)
        async function salvarNotificacao() {
            const form = document.getElementById('formNotificacao');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const notifId = document.getElementById('notifId').value;
            const dilacao = document.getElementById('dilacaoSim').checked;
            const docRespondido = document.getElementById('docRespondidoSim').checked;
            
            const dados = {
                tipo_doc: document.getElementById('tipoDoc').value,
                ano_doc: parseInt(document.getElementById('anoDoc').value),
                numero_doc: parseInt(document.getElementById('numeroDoc').value),
                numero_termo: document.getElementById('numeroTermo').value || null,
                nome_responsavel: document.getElementById('nomeResponsavel').value || null,
                processo_doc: document.getElementById('processoDoc').value || null,
                sei_doc: document.getElementById('seiDoc').value || null,
                data_doc: document.getElementById('dataDoc').value || null,
                data_pub: document.getElementById('dataPub').value || null,
                data_email_ar: document.getElementById('dataEmailAr').value || null,
                observacoes: document.getElementById('observacoes').value || null,
                dilacao: dilacao,
                dilacao_dias: dilacao ? parseInt(document.getElementById('dilacaoDias').value) : 0,
                doc_respondido: docRespondido
            };

            try {
                let response;
                if (notifId) {
                    // Editar
                    response = await fetch(`/parcerias_notificacoes/api/notificacoes/${notifId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                } else {
                    // Criar
                    response = await fetch('/parcerias_notificacoes/api/notificacoes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                }

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.erro || 'Erro ao salvar notificação');
                }

                alert(notifId ? 'Notificação atualizada com sucesso!' : 'Notificação criada com sucesso!');
                modalNotificacao.hide();
                carregarNotificacoes();
                
            } catch (error) {
                console.error('Erro ao salvar notificação:', error);
                alert('Erro ao salvar notificação: ' + error.message);
            }
        }

        // Excluir notificação
        async function excluirNotificacao(id) {
            if (!confirm('Tem certeza que deseja excluir esta notificação?')) {
                return;
            }

            try {
                const response = await fetch(`/parcerias_notificacoes/api/notificacoes/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.erro || 'Erro ao excluir notificação');
                }

                alert('Notificação excluída com sucesso!');
                carregarNotificacoes();
                
            } catch (error) {
                console.error('Erro ao excluir notificação:', error);
                alert('Erro ao excluir notificação: ' + error.message);
            }
        }

        // Toggle dias de dilação
        function toggleDilacaoDias() {
            const dilacaoSim = document.getElementById('dilacaoSim').checked;
            const inputDias = document.getElementById('dilacaoDias');
            
            if (dilacaoSim) {
                inputDias.disabled = false;
            } else {
                inputDias.disabled = true;
                inputDias.value = 0;
            }
        }

        // Formatação de data
        function formatarData(dataStr) {
            if (!dataStr) return '-';
            try {
                const data = new Date(dataStr + 'T00:00:00');
                if (isNaN(data.getTime())) return '-';
                return data.toLocaleDateString('pt-BR');
            } catch {
                return '-';
            }
        }

        function formatarDataHora(dataStr) {
            if (!dataStr) return '-';
            try {
                const data = new Date(dataStr);
                if (isNaN(data.getTime())) return '-';
                
                // Se o horário for meia-noite (00:00:00), mostrar apenas a data
                if (data.getHours() === 0 && data.getMinutes() === 0 && data.getSeconds() === 0) {
                    return data.toLocaleDateString('pt-BR');
                }
                
                return data.toLocaleString('pt-BR');
            } catch {
                return '-';
            }
        }
    </script>
</body>
</html>
