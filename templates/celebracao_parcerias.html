<!-- templates/celebracao_parcerias.html -->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Celebração de Parcerias</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
      padding: 20px;
    }
    .main-container {
      max-width: 100%;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* Header */
    .header-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .header-section h3 {
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 10px;
    }
    .header-section small {
      opacity: 0.9;
      font-size: 1rem;
    }

    /* Tabela */
    .table th {
      white-space: nowrap;
      font-size: 0.85rem;
      font-weight: 600;
      padding: 12px 8px;
    }
    .table td {
      font-size: 0.85rem;
      vertical-align: middle;
      padding: 10px 8px;
    }
    .table-hover tbody tr:hover {
      background-color: #f1f3f5;
      cursor: pointer;
    }

    /* Textarea auto-expansível */
    textarea.auto-resize {
      overflow: hidden;
      resize: none;
      min-height: 72px;
      transition: height 0.1s ease;
    }

    /* Cards */
    .filtro-card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    }
    .filtro-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    /* Table responsive */
    .table-responsive {
      max-height: 65vh;
      overflow-y: auto;
      border-radius: 8px;
    }
    .sticky-header th {
      position: sticky;
      top: 0;
      z-index: 10;
      background-color: #212529;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Badges */
    .badge {
      padding: 6px 12px;
      font-weight: 500;
      font-size: 0.8rem;
    }

    /* Botões */
    .btn {
      border-radius: 8px;
      padding: 8px 16px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .btn-sm {
      padding: 4px 8px;
      font-size: 0.85rem;
    }

    /* Paginação */
    .pagination {
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      border-radius: 8px;
      overflow: hidden;
    }

    /* Stats Badge */
    .stats-badge {
      background: white;
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      display: inline-block;
    }
    .stats-badge i {
      color: #764ba2;
      margin-right: 8px;
    }

    /* Modal header customizado */
    .card-header-custom {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    /* Autocomplete dropdown */
    .autocomplete-list {
      position: absolute;
      z-index: 1050;
      background: white;
      border: 1px solid #dee2e6;
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 200px;
      overflow-y: auto;
      width: 100%;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .autocomplete-list .autocomplete-item {
      padding: 6px 12px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .autocomplete-list .autocomplete-item:hover {
      background-color: #e9ecef;
    }

    /* Indicador de filtro por usuário */
    .user-filter-badge {
      background: rgba(255,255,255,0.2);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>

<div class="container-fluid main-container">

  <!-- ═════════════════════════════════════════════════════════════════════ -->
  <!-- CABEÇALHO                                                           -->
  <!-- ═════════════════════════════════════════════════════════════════════ -->
  <div class="header-section">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h3 class="mb-2">
          <i class="bi bi-handshake me-2"></i>
          Celebração de Parcerias
        </h3>
        <small>Gestão de Parcerias — Acompanhamento de termos e celebrações</small>
        {% if not ver_todos and nome_analista_logado %}
        <div class="mt-2">
          <span class="user-filter-badge">
            <i class="bi bi-person-fill me-1"></i>
            Exibindo registros de: <strong>{{ nome_analista_logado }}</strong>
          </span>
        </div>
        {% endif %}
      </div>
      <div class="d-flex gap-2 align-items-center">
        {% if is_admin %}
        <button class="btn btn-light" onclick="abrirVisualizacaoGeral()" title="Gerenciar Visualização Geral">
          <i class="bi bi-eye me-1"></i> Visualização
        </button>
        {% endif %}
        <a href="{{ url_for('sei_orcamentario.index') }}" class="btn btn-outline-light" title="Gerenciamento de SEI Orçamentário">
          <i class="bi bi-file-earmark-text me-1"></i> SEI Orçamentário
        </a>
        <button class="btn btn-success" onclick="abrirNovaParc()" title="Adicionar nova parceria">
          <i class="bi bi-plus-circle me-1"></i> Nova Parceria
        </button>
        <a href="{{ url_for('celebracao_parcerias.exportar_csv',
            filtro_responsavel=filtro_responsavel, filtro_status=filtro_status,
            filtro_substatus=filtro_substatus, filtro_sei=filtro_sei,
            filtro_tipo_termo=filtro_tipo_termo, filtro_osc=filtro_osc,
            filtro_projeto=filtro_projeto, filtro_unidade=filtro_unidade,
            filtro_edital=filtro_edital, filtro_numero_termo=filtro_numero_termo,
            filtro_status_generico=filtro_status_generico) }}"
           class="btn btn-light" title="Exportar CSV">
          <i class="bi bi-download me-1"></i> CSV
        </a>
        <a href="{{ url_for('main.index') }}" class="btn btn-outline-light btn-lg">
          <i class="bi bi-arrow-left me-2"></i> Voltar
        </a>
      </div>
    </div>
  </div>

  <!-- ═════════════════════════════════════════════════════════════════════ -->
  <!-- FILTROS (Collapse)                                                  -->
  <!-- ═════════════════════════════════════════════════════════════════════ -->
  <div class="card filtro-card mb-4">
    <div class="card-header bg-gradient d-flex justify-content-between align-items-center py-3"
         style="background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 100%);">
      <div>
        <i class="bi bi-funnel-fill me-2" style="color: #764ba2;"></i>
        <strong style="color: #333;">Filtros de Busca</strong>
        {% set filtros_ativos = [] %}
        {% if filtro_responsavel %}{% set _ = filtros_ativos.append('Responsável') %}{% endif %}
        {% if filtro_status %}{% set _ = filtros_ativos.append('Status') %}{% endif %}
        {% if filtro_substatus %}{% set _ = filtros_ativos.append('Substatus') %}{% endif %}
        {% if filtro_sei %}{% set _ = filtros_ativos.append('SEI') %}{% endif %}
        {% if filtro_tipo_termo %}{% set _ = filtros_ativos.append('Tipo Termo') %}{% endif %}
        {% if filtro_osc %}{% set _ = filtros_ativos.append('OSC') %}{% endif %}
        {% if filtro_projeto %}{% set _ = filtros_ativos.append('Projeto') %}{% endif %}
        {% if filtro_unidade %}{% set _ = filtros_ativos.append('Unidade') %}{% endif %}
        {% if filtro_edital %}{% set _ = filtros_ativos.append('Edital') %}{% endif %}
        {% if filtro_numero_termo %}{% set _ = filtros_ativos.append('Nº Termo') %}{% endif %}
        {% if filtro_status_generico %}{% set _ = filtros_ativos.append('Status Genérico') %}{% endif %}
        {% if filtros_ativos %}
          <span class="badge bg-primary ms-2">{{ filtros_ativos|length }} ativo(s)</span>
        {% endif %}
      </div>
      <button class="btn btn-sm btn-outline-secondary" type="button"
              data-bs-toggle="collapse" data-bs-target="#collapseFiltros">
        <i class="bi bi-chevron-down"></i>
      </button>
    </div>
    <div class="collapse {% if filtros_ativos %}show{% endif %}" id="collapseFiltros">
      <div class="card-body">
        <form method="GET" action="{{ url_for('celebracao_parcerias.index') }}" id="formFiltros">
          <div class="row g-2">
            <!-- Linha 1 -->
            <div class="col-md-2">
              <label class="form-label form-label-sm">Responsável</label>
              <div class="position-relative">
                <input type="text" class="form-control form-control-sm autocomplete-input"
                       name="filtro_responsavel" value="{{ filtro_responsavel }}"
                       placeholder="Buscar responsável..." data-campo="responsavel"
                       autocomplete="off">
              </div>
            </div>
            <div class="col-md-2">
              <label class="form-label form-label-sm">Status</label>
              <select class="form-select form-select-sm" name="filtro_status">
                <option value="">Todos</option>
                {% for s in status_list %}
                <option value="{{ s }}" {% if filtro_status == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label form-label-sm">Substatus</label>
              <select class="form-select form-select-sm" name="filtro_substatus">
                <option value="">Todos</option>
                {% for s in substatus_list %}
                <option value="{{ s }}" {% if filtro_substatus == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label form-label-sm">SEI Celebração</label>
              <div class="position-relative">
                <input type="text" class="form-control form-control-sm autocomplete-input"
                       name="filtro_sei" value="{{ filtro_sei }}"
                       placeholder="Buscar SEI..." data-campo="sei_celeb"
                       autocomplete="off">
              </div>
            </div>
            <div class="col-md-2">
              <label class="form-label form-label-sm">Tipo de Termo</label>
              <select class="form-select form-select-sm" name="filtro_tipo_termo">
                <option value="">Todos</option>
                {% for t in tipo_termo_list %}
                <option value="{{ t }}" {% if filtro_tipo_termo == t %}selected{% endif %}>{{ t }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label form-label-sm">OSC</label>
              <div class="position-relative">
                <input type="text" class="form-control form-control-sm autocomplete-input"
                       name="filtro_osc" value="{{ filtro_osc }}"
                       placeholder="Buscar OSC..." data-campo="osc"
                       autocomplete="off">
              </div>
            </div>

            <!-- Linha 2 -->
            <div class="col-md-2">
              <label class="form-label form-label-sm">Projeto</label>
              <div class="position-relative">
                <input type="text" class="form-control form-control-sm autocomplete-input"
                       name="filtro_projeto" value="{{ filtro_projeto }}"
                       placeholder="Buscar projeto..." data-campo="projeto"
                       autocomplete="off">
              </div>
            </div>
            <div class="col-md-2">
              <label class="form-label form-label-sm">Unidade Gestora</label>
              <select class="form-select form-select-sm" name="filtro_unidade">
                <option value="">Todas</option>
                {% for u in unidades_list %}
                <option value="{{ u }}" {% if filtro_unidade == u %}selected{% endif %}>{{ u }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label form-label-sm">Edital</label>
              <div class="position-relative">
                <input type="text" class="form-control form-control-sm autocomplete-input"
                       name="filtro_edital" value="{{ filtro_edital }}"
                       placeholder="Buscar edital..." data-campo="edital_nome"
                       autocomplete="off">
              </div>
            </div>
            <div class="col-md-2">
              <label class="form-label form-label-sm">Nº Termo</label>
              <div class="position-relative">
                <input type="text" class="form-control form-control-sm autocomplete-input"
                       name="filtro_numero_termo" value="{{ filtro_numero_termo }}"
                       placeholder="Buscar nº termo..." data-campo="numero_termo"
                       autocomplete="off">
              </div>
            </div>
            <div class="col-md-2">
              <label class="form-label form-label-sm">Status Genérico</label>
              <select class="form-select form-select-sm" name="filtro_status_generico">
                <option value="">Todos</option>
                {% for sg in status_generico_list %}
                <option value="{{ sg }}" {% if filtro_status_generico == sg %}selected{% endif %}>{{ sg }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="mt-2 d-flex gap-2">
            <button type="submit" class="btn btn-sm btn-primary">
              <i class="bi bi-search me-1"></i> Filtrar
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limparFiltros()">
              <i class="bi bi-x-circle me-1"></i> Limpar Filtros
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ═════════════════════════════════════════════════════════════════════ -->
  <!-- RESUMO E PAGINAÇÃO SUPERIOR                                        -->
  <!-- ═════════════════════════════════════════════════════════════════════ -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="stats-badge">
      <i class="bi bi-database-fill"></i>
      <strong>{{ total }}</strong> registro(s) encontrado(s)
      {% if total > 0 %}
        <span class="text-muted">|</span> Página <strong>{{ page }}</strong> de <strong>{{ total_pages }}</strong>
      {% endif %}
    </div>
    <div class="d-flex align-items-center gap-2">
      <label class="form-label mb-0 text-muted">Exibir:</label>
      <select class="form-select form-select-sm" style="width:90px;" onchange="mudarPorPagina(this.value)">
        {% for pp in [10, 20, 50, 100] %}
        <option value="{{ pp }}" {% if per_page == pp %}selected{% endif %}>{{ pp }}</option>
        {% endfor %}
      </select>
      <span class="text-muted">por página</span>
    </div>
  </div>

  <!-- ═════════════════════════════════════════════════════════════════════ -->
  <!-- TABELA PRINCIPAL                                                    -->
  <!-- ═════════════════════════════════════════════════════════════════════ -->
  <div class="card">
    <div class="table-responsive">
      <table class="table table-hover table-bordered table-sm mb-0">
        <thead class="table-dark sticky-header">
          <tr>
            <th>Responsável</th>
            <th>Status</th>
            <th>Substatus</th>
            <th>SEI Celebração</th>
            <th>Tipo de Termo</th>
            <th>OSC</th>
            <th>Projeto</th>
            <th>Unidade Gestora</th>
            <th class="text-end">Total Previsto</th>
            <th class="text-center" style="min-width:70px;">Ação</th>
          </tr>
        </thead>
        <tbody>
          {% if registros %}
            {% for r in registros %}
            {% set edisp = r.emenda_disp_status or 'none' %}
            <tr{% if edisp == 'all_available' %} style="--bs-table-bg:#dbeeff;"{% elif edisp == 'mixed' %} style="--bs-table-bg:#f0f8ff;"{% endif %}{% if edisp == 'mixed' and r.emenda_disp_detail %} data-bs-toggle="tooltip" data-bs-placement="top" title="{% for e in r.emenda_disp_detail %}{{ e.sei_orc }}: {{ e.disp }}{% if not loop.last %} | {% endif %}{% endfor %}{% if r.emenda_total_valor %} · Total: R$ {{ r.emenda_total_valor | format_brl }}{% endif %}"{% endif %}>
              <td>
                {% if r.responsavel %}
                  <span class="badge bg-primary">{{ r.responsavel }}</span>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td>
                {% if r.status %}
                  <span class="badge bg-info text-dark">{{ r.status }}</span>
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if r.substatus %}
                  <span class="badge bg-secondary">{{ r.substatus }}</span>
                {% else %}
                  -
                {% endif %}
              </td>
              <td>{{ r.sei_celeb or '-' }}</td>
              <td>{{ r.tipo_termo or '-' }}</td>
              <td title="{{ r.osc or '' }}">
                {{ (r.osc or '-')[:45] }}{% if r.osc and r.osc|length > 45 %}...{% endif %}
              </td>
              <td title="{{ r.projeto or '' }}">
                {{ (r.projeto or '-')[:35] }}{% if r.projeto and r.projeto|length > 35 %}...{% endif %}
              </td>
              <td>{{ r.unidade_gestora or '-' }}</td>
              <td class="text-end">
                {% if r.total_previsto is not none %}
                  R$ {{ r.total_previsto | format_brl }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td class="text-center">
                <button class="btn btn-sm btn-info" onclick="verDetalhes({{ r.id }})" title="Ver detalhes">
                  <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary ms-1"
                  onclick="abrirContatosOSC('{{ r.osc | e }}')" title="Contatos da OSC"
                  {% if not r.osc %}disabled{% endif %}>
                  <i class="bi bi-person-lines-fill"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="10" class="text-center text-muted py-4">
                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                Nenhum registro encontrado.
                {% if filtros_ativos %}
                  <br><a href="{{ url_for('celebracao_parcerias.index') }}">Limpar filtros</a>
                {% endif %}
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ═════════════════════════════════════════════════════════════════════ -->
  <!-- PAGINAÇÃO                                                           -->
  <!-- ═════════════════════════════════════════════════════════════════════ -->
  {% if total_pages > 1 %}
  <nav class="mt-3 d-flex justify-content-center">
    <ul class="pagination pagination-sm">
      <!-- Anterior -->
      <li class="page-item {% if page <= 1 %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('celebracao_parcerias.index', page=page-1, per_page=per_page,
           filtro_responsavel=filtro_responsavel, filtro_status=filtro_status,
           filtro_substatus=filtro_substatus, filtro_sei=filtro_sei,
           filtro_tipo_termo=filtro_tipo_termo, filtro_osc=filtro_osc,
           filtro_projeto=filtro_projeto, filtro_unidade=filtro_unidade,
           filtro_edital=filtro_edital, filtro_numero_termo=filtro_numero_termo,
           filtro_status_generico=filtro_status_generico) }}">
          <i class="bi bi-chevron-left"></i> Anterior
        </a>
      </li>

      {% set start_page = [1, page - 2]|max %}
      {% set end_page = [total_pages, start_page + 4]|min %}

      {% if start_page > 1 %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('celebracao_parcerias.index', page=1, per_page=per_page,
             filtro_responsavel=filtro_responsavel, filtro_status=filtro_status,
             filtro_substatus=filtro_substatus, filtro_sei=filtro_sei,
             filtro_tipo_termo=filtro_tipo_termo, filtro_osc=filtro_osc,
             filtro_projeto=filtro_projeto, filtro_unidade=filtro_unidade,
             filtro_edital=filtro_edital, filtro_numero_termo=filtro_numero_termo,
             filtro_status_generico=filtro_status_generico) }}">1</a>
        </li>
        {% if start_page > 2 %}
          <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
      {% endif %}

      {% for p in range(start_page, end_page + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('celebracao_parcerias.index', page=p, per_page=per_page,
             filtro_responsavel=filtro_responsavel, filtro_status=filtro_status,
             filtro_substatus=filtro_substatus, filtro_sei=filtro_sei,
             filtro_tipo_termo=filtro_tipo_termo, filtro_osc=filtro_osc,
             filtro_projeto=filtro_projeto, filtro_unidade=filtro_unidade,
             filtro_edital=filtro_edital, filtro_numero_termo=filtro_numero_termo,
             filtro_status_generico=filtro_status_generico) }}">{{ p }}</a>
        </li>
      {% endfor %}

      {% if end_page < total_pages %}
        {% if end_page < total_pages - 1 %}
          <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('celebracao_parcerias.index', page=total_pages, per_page=per_page,
             filtro_responsavel=filtro_responsavel, filtro_status=filtro_status,
             filtro_substatus=filtro_substatus, filtro_sei=filtro_sei,
             filtro_tipo_termo=filtro_tipo_termo, filtro_osc=filtro_osc,
             filtro_projeto=filtro_projeto, filtro_unidade=filtro_unidade,
             filtro_edital=filtro_edital, filtro_numero_termo=filtro_numero_termo,
             filtro_status_generico=filtro_status_generico) }}">{{ total_pages }}</a>
        </li>
      {% endif %}

      <!-- Próximo -->
      <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('celebracao_parcerias.index', page=page+1, per_page=per_page,
           filtro_responsavel=filtro_responsavel, filtro_status=filtro_status,
           filtro_substatus=filtro_substatus, filtro_sei=filtro_sei,
           filtro_tipo_termo=filtro_tipo_termo, filtro_osc=filtro_osc,
           filtro_projeto=filtro_projeto, filtro_unidade=filtro_unidade,
           filtro_edital=filtro_edital, filtro_numero_termo=filtro_numero_termo,
           filtro_status_generico=filtro_status_generico) }}">
          Próximo <i class="bi bi-chevron-right"></i>
        </a>
      </li>
    </ul>
  </nav>
  {% endif %}
</div>

<!-- ═══════════════════════════════════════════════════════════════════════ -->
<!-- MODAL: Detalhes do Registro                                           -->
<!-- ═══════════════════════════════════════════════════════════════════════ -->
<div class="modal fade" id="modalDetalhes" tabindex="-1" aria-labelledby="modalDetalhesLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header card-header-custom">
        <h5 class="modal-title" id="modalDetalhesLabel">
          <i class="bi bi-pencil-square me-2"></i> Editar Registro
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div id="detalhesConteudo">
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Carregando...</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        <button type="button" class="btn btn-success" id="btnSalvarRegistro" style="display:none" onclick="salvarRegistro()">
          <i class="bi bi-check-circle me-1"></i> Salvar Alterações
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════ -->
<!-- MODAL: Nova Parceria                                                  -->
<!-- ═══════════════════════════════════════════════════════════════════════ -->
<div class="modal fade" id="modalNovaParc" tabindex="-1" aria-labelledby="modalNovaParcLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header card-header-custom">
        <h5 class="modal-title" id="modalNovaParcLabel">
          <i class="bi bi-plus-circle me-2"></i> Adicionar Nova Parceria
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div id="novaParcConteudo"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" id="btnSalvarNova" onclick="salvarNovaParc()">
          <i class="bi bi-plus-circle me-1"></i> Criar Parceria
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════ -->
<!-- MODAL: Visualização Geral (admin)                                     -->
<!-- ═══════════════════════════════════════════════════════════════════════ -->
<div class="modal fade" id="modalVisualizacao" tabindex="-1" aria-labelledby="modalVisualizacaoLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header card-header-custom">
        <h5 class="modal-title" id="modalVisualizacaoLabel">
          <i class="bi bi-eye me-2"></i> Gerenciar Visualização Geral
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-1"></i>
          Marque os analistas que podem ver <strong>todos</strong> os registros de Celebração de Parcerias,
          independentemente de serem responsáveis. Analistas não marcados verão apenas seus próprios registros.
        </div>
        <div id="listaVisualizacao">
          <div class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Carregando...</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="salvarVisualizacaoGeral()">
          <i class="bi bi-check-circle me-1"></i> Salvar
        </button>
      </div>
    </div>
  </div>
</div>


<!-- ═══════════════════════════════════════════════════════════════════════ -->
<!-- SCRIPTS                                                               -->
<!-- ═══════════════════════════════════════════════════════════════════════ -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>// ── Variáveis de listas (do servidor) ──────────────────────────────────────
const RESPONSAVEIS_NOMES = {{ responsaveis | map(attribute='nome_analista') | list | tojson }};
const STATUS_LIST        = {{ status_list | tojson }};
const STATUS_GEN_MAP     = {{ status_generico_map | tojson }};
const STATUS_IDS         = {{ status_ids | tojson }};
const SUBSTATUS_LIST     = {{ substatus_list | tojson }};
const SUBSTATUS_LIMITES  = {{ substatus_limites | tojson }};
const TIPO_TERMO_LIST    = {{ tipo_termo_list | tojson }};
const UNIDADES_LIST      = {{ unidades_list | tojson }};
const STATUS_GEN_LIST    = {{ status_generico_list | tojson }};
const EDITAIS_LIST       = {{ editais_list | tojson }};
const NOME_PG_LIST       = {{ nome_pg_list | tojson }};
const LEI_LIST           = {{ lei_list | tojson }};
const REGIONALIZACAO_MAP = {{ regionalizacao_map | tojson }};
const SEI_TIPO_OPTIONS   = ['Termo Base', 'Plano de Trabalho', 'Orçamento Anual', 'Proposta Técnico-Orçamentário', 'Memória de Cálculo', 'Minuta de Termo', 'Despacho Autorizatório'];
// IDs de status que exigem data de assinatura preenchida
const STATUS_NEED_ASSINATURA = new Set([15, 16, 17, 18, 19, 20]);

// ── Cache de filtros (localStorage) ────────────────────────────────────────
const FILTRO_KEY = 'celebracao_parcerias_filtros';
const FILTRO_DEFAULT = { filtro_status_generico: 'Em celebração' };
const FILTRO_PARAMS = [
  'filtro_responsavel', 'filtro_status', 'filtro_substatus',
  'filtro_sei', 'filtro_tipo_termo', 'filtro_osc', 'filtro_projeto',
  'filtro_unidade', 'filtro_edital', 'filtro_numero_termo', 'filtro_status_generico'
];

document.addEventListener('DOMContentLoaded', function() {
  const url = new URL(window.location.href);

  // Se o usuário clicou em 'Limpar Filtros', limpa o cache e não redireciona
  if (sessionStorage.getItem('celebracao_cleared') === '1') {
    sessionStorage.removeItem('celebracao_cleared');
    localStorage.removeItem(FILTRO_KEY);
    return;
  }

  const filtrosNaURL = FILTRO_PARAMS.filter(
    p => url.searchParams.get(p) && url.searchParams.get(p).trim() !== ''
  );

  if (filtrosNaURL.length > 0) {
    // Salva os filtros ativos no localStorage
    const toSave = {};
    FILTRO_PARAMS.forEach(p => {
      const v = url.searchParams.get(p) || '';
      if (v.trim()) toSave[p] = v;
    });
    localStorage.setItem(FILTRO_KEY, JSON.stringify(toSave));
  } else {
    // Carrega do localStorage ou aplica o default
    let saved = {};
    try { saved = JSON.parse(localStorage.getItem(FILTRO_KEY) || '{}'); } catch(e) {}
    const merged = Object.assign({}, FILTRO_DEFAULT, saved);
    const hasAny = Object.values(merged).some(v => v && v.trim() !== '');
    if (hasAny) {
      url.searchParams.set('page', '1');
      Object.entries(merged).forEach(([k, v]) => {
        if (v && v.trim()) url.searchParams.set(k, v);
      });
      window.location.href = url.toString();
    }
  }

  // Esconder botão salvar quando o modal fechar
  document.getElementById('modalDetalhes').addEventListener('hidden.bs.modal', function() {
    const btn = document.getElementById('btnSalvarRegistro');
    if (btn) { btn.style.display = 'none'; btn.disabled = false; btn.innerHTML = '<i class="bi bi-check-circle me-1"></i> Salvar Alterações'; }
    currentEditId = null;
  });

  // Inicializar tooltips na tabela (linhas com emenda mista)
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
});

function limparFiltros() {
  sessionStorage.setItem('celebracao_cleared', '1');
  window.location.href = '{{ url_for("celebracao_parcerias.index") }}';
}
// ── Paginação ─────────────────────────────────────────────────────────────
function mudarPorPagina(valor) {
  const url = new URL(window.location.href);
  url.searchParams.set('per_page', valor);
  url.searchParams.set('page', '1');
  window.location.href = url.toString();
}

// ── Editar registro (modal) ───────────────────────────────────────────────
let currentEditId = null;

function verDetalhes(id) {
  currentEditId = id;
  const modal = new bootstrap.Modal(document.getElementById('modalDetalhes'));
  const conteudo = document.getElementById('detalhesConteudo');
  const btnSalvar = document.getElementById('btnSalvarRegistro');

  document.getElementById('modalDetalhesLabel').innerHTML =
    `<i class="bi bi-pencil-square me-2"></i> Editar Registro #${id}`;

  conteudo.innerHTML = `
    <div class="text-center py-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Carregando...</span>
      </div>
    </div>`;
  btnSalvar.style.display = 'none';
  modal.show();

  fetch(`/celebracao-parcerias/detalhe/${id}`)
    .then(r => r.json())
    .then(data => {
      if (!data.success) {
        conteudo.innerHTML = `<div class="alert alert-danger">${data.erro}</div>`;
        return;
      }
      conteudo.innerHTML = montarFormularioEdicao(data.registro);
      btnSalvar.style.display = '';
      // Validar SEI e construir Nº Termo com dados existentes
      const seiEl = document.getElementById('edit_sei_celeb');
      if (seiEl && seiEl.value) validarSEI(seiEl);
      const cnpjEl2 = document.getElementById('edit_cnpj');
      if (cnpjEl2 && cnpjEl2.value) validarCNPJ(cnpjEl2);
      rebuildNumeroTermo();
      // Inicializar Status Genérico e filtro de substatus com base no status atual
      const statusEl = document.getElementById('edit_status');
      if (statusEl) aoMudarStatus(statusEl.value);
      // Ativar auto-detecção de Lei ao mudar data de início
      const inicioElLei = document.getElementById('edit_inicio');
      if (inicioElLei) inicioElLei.addEventListener('change', () => autoDetectarLei(false));
      // Auto-detectar Lei na abertura (somente se lei estiver vazia)
      autoDetectarLei(false);
      // Carregar endereços de execução do projeto
      carregarEnderecos(id);
      // Carregar documentos SEI do registro
      carregarSEIDocs(id);
      // Carregar informações adicionais
      carregarInfosAdicionais(id);
      // Ativar tooltips Bootstrap no modal
      conteudo.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
      // Mostrar secção de emenda se aplicável
      verificarEditalEmenda('edit');
    })
    .catch(err => {
      conteudo.innerHTML = `<div class="alert alert-danger">Erro ao carregar detalhes: ${err}</div>`;
    });
}

function salvarRegistro() {
  if (!currentEditId) return;
  const form = document.getElementById('formEditarRegistro');
  if (!form) return;

  const btnSalvar = document.getElementById('btnSalvarRegistro');
  btnSalvar.disabled = true;
  btnSalvar.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Salvando...';

  // Sync múltiplos responsáveis antes de coletar o form
  sincronizarResponsaveis();

  // Validar CNPJ antes de salvar
  const cnpjSave = document.getElementById('edit_cnpj');
  if (cnpjSave && cnpjSave.value) {
    const reCnpj = /^\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}$/;
    if (!reCnpj.test(cnpjSave.value)) {
      cnpjSave.style.borderColor = '#ffc107';
      cnpjSave.style.backgroundColor = '#fffef0';
      const w = document.getElementById('cnpj_warn');
      if (w) w.style.display = '';
      btnSalvar.disabled = false;
      btnSalvar.innerHTML = '<i class="bi bi-check-circle me-1"></i> Salvar Alterações';
      cnpjSave.scrollIntoView({ behavior: 'smooth', block: 'center' });
      return;
    }
  }

  // Validar: status do grupo "Celebrado" (ids 15-20) exige data de assinatura
  const _statusEl = document.getElementById('edit_status');
  const _statusId = _statusEl ? (STATUS_IDS[_statusEl.value] || 0) : 0;
  if (STATUS_NEED_ASSINATURA.has(_statusId)) {
    const assEl = document.getElementById('edit_assinatura');
    if (!assEl || !assEl.value) {
      if (assEl) { assEl.style.borderColor = '#dc3545'; assEl.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
      btnSalvar.disabled = false;
      btnSalvar.innerHTML = '<i class="bi bi-check-circle me-1"></i> Salvar Alterações';
      document.getElementById('detalhesConteudo').insertAdjacentHTML('afterbegin', `
        <div class="alert alert-warning alert-dismissible mb-3" role="alert">
          <i class="bi bi-exclamation-triangle me-1"></i> O status <strong>${_statusEl.value}</strong> exige o preenchimento da <strong>Data de Assinatura</strong>.
          <button class="btn-close" data-bs-dismiss="alert"></button>
        </div>`);
      return;
    }
  }

  // Validar: assinatura e início não podem estar a mais de 6 meses de hoje
  const _inicioVal = (document.getElementById('edit_inicio') || {}).value || '';
  const _assVal    = (document.getElementById('edit_assinatura') || {}).value || '';
  if (_dataFora6Meses(_inicioVal) || _dataFora6Meses(_assVal)) {
    const _badEl = _dataFora6Meses(_inicioVal)
      ? document.getElementById('edit_inicio')
      : document.getElementById('edit_assinatura');
    if (_badEl) { _badEl.style.borderColor = '#dc3545'; _badEl.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
    btnSalvar.disabled = false;
    btnSalvar.innerHTML = '<i class="bi bi-check-circle me-1"></i> Salvar Alterações';
    document.getElementById('detalhesConteudo').insertAdjacentHTML('afterbegin', `
      <div class="alert alert-warning alert-dismissible mb-3" role="alert">
        <i class="bi bi-exclamation-triangle me-1"></i> As datas de <strong>Assinatura</strong> e <strong>Início</strong> não podem estar a mais de <strong>6 meses</strong> da data de hoje.
        <button class="btn-close" data-bs-dismiss="alert"></button>
      </div>`);
    return;
  }

  // ── Campos obrigatórios sempre ───────────────────────────────────────────────
  const _alwaysReq = [
    { id: 'edit_sei_celeb',   label: 'SEI Celebração' },
    { id: 'edit_tipo_termo',  label: 'Tipo de Termo' },
    { id: 'edit_edital_nome', label: 'Edital' },
    { id: 'edit_cnpj',        label: 'CNPJ' },
    { id: 'edit_osc',         label: 'OSC' },
    { id: 'edit_responsavel', label: 'Responsável(eis)' },
    { id: 'edit_projeto',     label: 'Projeto' },
    { id: 'edit_status',      label: 'Status' },
  ];
  // Limpar bordas vermelhas anteriores dos campos req
  _alwaysReq.forEach(f => { const el = document.getElementById(f.id); if (el) el.style.borderColor = ''; });
  const _missingAlways = _alwaysReq.filter(f => {
    const el = document.getElementById(f.id);
    return !el || !el.value.trim();
  });
  if (_missingAlways.length > 0) {
    _missingAlways.forEach(f => { const el = document.getElementById(f.id); if (el) { el.style.borderColor = '#dc3545'; el.style.boxShadow = '0 0 0 0.2rem rgba(220,53,69,.25)'; } });
    btnSalvar.disabled = false;
    btnSalvar.innerHTML = '<i class="bi bi-check-circle me-1"></i> Salvar Alterações';
    document.getElementById('detalhesConteudo').insertAdjacentHTML('afterbegin', `
      <div class="alert alert-danger alert-dismissible mb-3" role="alert">
        <i class="bi bi-x-circle me-1"></i> Campos obrigatórios não preenchidos: <strong>${_missingAlways.map(f => f.label).join(', ')}</strong>.
        <button class="btn-close" data-bs-dismiss="alert"></button>
      </div>`);
    document.getElementById(_missingAlways[0].id)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    return;
  }

  // ── Quando status genérico = Celebrado: TODOS os campos obrigatórios (exceto Substatus) ──
  const _sgValCeleb = (document.getElementById('edit_status_generico') || {}).value || '';
  if (_sgValCeleb === 'Celebrado') {
    const _celebReq = [
      { id: 'edit_numeracao_termo',         label: 'Numeração do Termo' },
      { id: 'edit_unidade_gestora',          label: 'Unidade Gestora' },
      { id: 'edit_endereco_sede',            label: 'Endereço Sede' },
      { id: 'edit_meses',                    label: 'Meses' },
      { id: 'edit_inicio',                   label: 'Início' },
      { id: 'edit_assinatura',               label: 'Assinatura' },
      { id: 'edit_celebracao_secretaria',    label: 'Secretaria' },
      { id: 'edit_total_previsto',           label: 'Total Previsto' },
      { id: 'edit_conta',                    label: 'Conta' },
      { id: 'edit_lei',                      label: 'Lei' },
      { id: 'edit_nome_pg',                  label: 'Nome PG' },
      { id: 'edit_observacoes',              label: 'Observações' },
    ];
    _celebReq.forEach(f => { const el = document.getElementById(f.id); if (el) el.style.borderColor = ''; });
    const _missingCeleb = _celebReq.filter(f => {
      const el = document.getElementById(f.id);
      return !el || !el.value.trim();
    });
    if (_missingCeleb.length > 0) {
      _missingCeleb.forEach(f => { const el = document.getElementById(f.id); if (el) { el.style.borderColor = '#dc3545'; el.style.boxShadow = '0 0 0 0.2rem rgba(220,53,69,.25)'; } });
      btnSalvar.disabled = false;
      btnSalvar.innerHTML = '<i class="bi bi-check-circle me-1"></i> Salvar Alterações';
      document.getElementById('detalhesConteudo').insertAdjacentHTML('afterbegin', `
        <div class="alert alert-warning alert-dismissible mb-3" role="alert">
          <i class="bi bi-exclamation-triangle me-1"></i> Status <strong>Celebrado</strong> exige todos os campos preenchidos. Faltam: <strong>${_missingCeleb.map(f => f.label).join(', ')}</strong>.
          <button class="btn-close" data-bs-dismiss="alert"></button>
        </div>`);
      document.getElementById(_missingCeleb[0].id)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
      return;
    }
  }

  const data = {};
  form.querySelectorAll('input, select, textarea').forEach(el => {
    if (el.name) data[el.name] = el.value;
  });

  // Converter total_previsto de formato BR (454.998,56) para decimal (454998.56)
  if (data.total_previsto) {
    data.total_previsto = data.total_previsto.replace(/\./g, '').replace(',', '.');
  }
  // Incluir endereços de execução do projeto
  data.enderecos = coletarEnderecos();

  // Validar e coletar documentos SEI (sem duplicatas de tipo)
  const seiDocs = coletarSEIDocs();
  if (seiDocs === null) {
    btnSalvar.disabled = false;
    btnSalvar.innerHTML = '<i class="bi bi-check-circle me-1"></i> Salvar Alterações';
    document.getElementById('detalhesConteudo').insertAdjacentHTML('afterbegin', `
      <div class="alert alert-warning alert-dismissible mb-3" role="alert">
        <i class="bi bi-exclamation-triangle me-1"></i> Existem <strong>tipos de documento SEI duplicados</strong>. Cada tipo só pode aparecer uma vez.
        <button class="btn-close" data-bs-dismiss="alert"></button>
      </div>`);
    return;
  }
  data.sei_docs = seiDocs;

  // Coletar informações adicionais
  data.infos_adicionais = coletarInfosAdicionais();

  fetch(`/celebracao-parcerias/editar/${currentEditId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
    .then(r => r.json())
    .then(res => {
      if (res.success) {
        document.getElementById('detalhesConteudo').insertAdjacentHTML('afterbegin', `
          <div class="alert alert-success alert-dismissible mb-3" role="alert">
            <i class="bi bi-check-circle me-1"></i> ${res.mensagem}
            <button class="btn-close" data-bs-dismiss="alert"></button>
          </div>`);
        setTimeout(() => window.location.reload(), 1500);
      } else {
        document.getElementById('detalhesConteudo').insertAdjacentHTML('afterbegin', `
          <div class="alert alert-danger alert-dismissible mb-3" role="alert">
            <i class="bi bi-exclamation-circle me-1"></i> Erro: ${res.erro}
            <button class="btn-close" data-bs-dismiss="alert"></button>
          </div>`);
        btnSalvar.disabled = false;
        btnSalvar.innerHTML = '<i class="bi bi-check-circle me-1"></i> Salvar Alterações';
      }
    })
    .catch(err => {
      alert('Erro: ' + err);
      btnSalvar.disabled = false;
      btnSalvar.innerHTML = '<i class="bi bi-check-circle me-1"></i> Salvar Alterações';
    });
}

function montarFormularioEdicao(r) {
  function esc(v) {
    if (v === null || v === undefined) return '';
    return String(v)
      .replace(/&/g, '&amp;').replace(/"/g, '&quot;')
      .replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }
  function opts(lista, valor) {
    let html = '<option value="">-- Selecione --</option>';
    const v = valor || '';
    const all = [...lista];
    if (v && !all.includes(v)) all.unshift(v);
    all.forEach(o => {
      const sel = o === v ? ' selected' : '';
      html += `<option value="${esc(o)}"${sel}>${esc(o)}</option>`;
    });
    return html;
  }
  function txt(campo, valor, extra = '') {
    return `<input type="text" class="form-control form-control-sm" id="edit_${campo}" name="${campo}" value="${esc(valor)}" ${extra}>`;
  }
  function num(campo, valor, step = '1') {
    const v = (valor !== null && valor !== undefined) ? valor : '';
    return `<input type="number" step="${step}" class="form-control form-control-sm" id="edit_${campo}" name="${campo}" value="${v}">`;
  }
  function dat(campo, valor) {
    return `<input type="date" class="form-control form-control-sm" id="edit_${campo}" name="${campo}" value="${esc(valor)}">`;
  }
  function sel(campo, lista, valor) {
    return `<select class="form-select form-select-sm" id="edit_${campo}" name="${campo}">${opts(lista, valor)}</select>`;
  }
  function fld(label, inputHTML, colMd = 4) {
    return `<div class="col-md-${colMd}">
      <label class="form-label fw-bold text-muted mb-1 small">${label}</label>
      ${inputHTML}
    </div>`;
  }
  function sec(icon, title) {
    return `<div class="col-12">
      <h6 class="text-primary fw-bold border-bottom pb-2 mt-3">
        <i class="bi bi-${icon} me-1"></i> ${title}
      </h6>
    </div>`;
  }

  // Campo CNPJ com máscara, validação e botão de busca de OSC
  function cnpjField(valor) {
    const v = esc(valor);
    return `<div class="input-group input-group-sm">
        <input type="text" class="form-control form-control-sm" id="edit_cnpj" name="cnpj"
          value="${v}" placeholder="00.000.000/0000-00" maxlength="18"
          oninput="formatarCNPJ(this)" onblur="validarCNPJ(this)">
        <button class="btn btn-outline-secondary btn-sm" type="button"
          onclick="buscarOSCporCNPJ()" title="Buscar OSC por este CNPJ">
          <i class="bi bi-search"></i>
        </button>
      </div>
      <div id="cnpj_warn" class="small mt-1 text-warning" style="display:none;">
        <i class="bi bi-exclamation-triangle-fill me-1"></i>Formato esperado: 00.000.000/0000-00
      </div>`;
  }

  // Campo OSC com tooltip de padronização
  const OSC_TOOLTIP = `Padrão de nomenclatura:
• Com acrônimo: AACC: Associação de Apoio à Criança com Câncer
• Com designação: A Alternativa - Associação de Assistência ao Excepcional
• Sem acrônimo: Ação Comunitária Senhor Santo Cristo
Preposições em minúsculo, demais termos com Maiúscula inicial.`;

  function oscField(valor) {
    return `<div class="input-group input-group-sm" id="osc_group">
        <input type="text" class="form-control form-control-sm" id="edit_osc" name="osc"
          value="${esc(valor)}" placeholder="Nome da OSC">
        <span class="input-group-text" style="cursor:help;"
          data-bs-toggle="tooltip" data-bs-placement="top"
          title="${esc(OSC_TOOLTIP)}" id="osc_tip">
          <i class="bi bi-info-circle text-primary"></i>
        </span>
      </div>
      <div id="osc_lookup_result" class="mt-1" style="display:none;"></div>`;
  }

  // Campo Responsável: múltiplos, via pill-buttons (btn-check) + hidden input
  function responsavelField(valor) {
    const selecionados = (valor || '').split(';').map(v => v.trim()).filter(v => v);
    let pills = RESPONSAVEIS_NOMES.map(nome => {
      const safeId = 'resp_' + esc(nome).replace(/[^a-zA-Z0-9]/g,'_');
      const checked = selecionados.includes(nome) ? 'checked' : '';
      return `<span>
          <input class="btn-check resp-check" type="checkbox"
            value="${esc(nome)}" id="${safeId}" autocomplete="off"
            ${checked} onchange="sincronizarResponsaveis()">
          <label class="btn btn-sm btn-outline-primary" for="${safeId}">${esc(nome)}</label>
        </span>`;
    }).join('');
    return `<div class="resp-picker d-flex flex-wrap gap-2 border rounded p-2" style="background:#fff;min-height:46px;">
        ${pills || '<span class="text-muted small align-self-center">Nenhum analista cadastrado</span>'}
      </div>
      <input type="hidden" id="edit_responsavel" name="responsavel" value="${esc(valor || '')}">`;
  }

  // Campo SEI com máscara e validação (definido localmente — formatarSEI/validarSEI são globais)
  function seiField(valor) {
    const v = esc(valor);
    return `<input type="text" class="form-control form-control-sm" id="edit_sei_celeb" name="sei_celeb"
        value="${v}" placeholder="0000.0000/0000000-0" maxlength="20"
        oninput="formatarSEI(this)" onblur="validarSEI(this)">
      <div id="sei_celeb_warn" class="small mt-1 text-warning" style="display:none;">
        <i class="bi bi-exclamation-triangle-fill me-1"></i>Formato esperado: 0000.0000/0000000-0
      </div>`;
  }

  // Campo Nº Termo: somente leitura, auto-construído
  function numeroTermoField(valor) {
    return `<input type="text" class="form-control form-control-sm" id="edit_numero_termo" name="numero_termo"
        value="${esc(valor)}" readonly style="background:#f0f0f0;cursor:not-allowed;"
        placeholder="Gerado automaticamente">`;
  }

  // Campo Substatus: múltiplos, filtrados pelo status id vs substatus_limite
  function substatusField(statusAtual, valorAtual) {
    const selecionados = (valorAtual || '').split(';').map(v => v.trim()).filter(v => v);
    const statusId = STATUS_IDS[statusAtual] || 0;
    // só mostra substatus cujo limite >= statusId (quando statusId > 0)
    const disponiveis = SUBSTATUS_LIST.filter(s =>
      statusId === 0 || (SUBSTATUS_LIMITES[s] || 0) >= statusId
    );
    let checks = disponiveis.map(sub => {
      const checked = selecionados.includes(sub) ? 'checked' : '';
      const safeId = 'sub_' + sub.replace(/[^a-zA-Z0-9]/g,'_');
      return `<div class="form-check">
          <input class="form-check-input substatus-check" type="checkbox"
            value="${esc(sub)}" id="${safeId}"
            ${checked} onchange="sincronizarSubstatus()">
          <label class="form-check-label small" for="${safeId}">${esc(sub)}</label>
        </div>`;
    }).join('');
    if (!checks) checks = '<span class="text-muted small">Nenhum substatus disponível para este status.</span>';
    return `<div class="border rounded p-2" style="max-height:130px;overflow-y:auto;background:#fff;" id="substatus_box">
        ${checks}
      </div>
      <input type="hidden" id="edit_substatus" name="substatus" value="${esc(valorAtual || '')}">`;
  }

  return `<form id="formEditarRegistro">
    <div class="row g-2">
      ${sec('card-heading', 'Identificação')}
      <div class="col-md-1">
        <label class="form-label fw-bold text-muted mb-1 small">ID</label>
        <p class="form-control-plaintext form-control-sm fw-bold">${r.id}</p>
      </div>
      ${fld('SEI Celebração', seiField(r.sei_celeb))}
      ${fld('Nº Termo', numeroTermoField(r.numero_termo))}
      <div class="col-md-4">
        <label class="form-label fw-bold text-muted mb-1 small">Numeração do Termo</label>
        <input type="number" class="form-control form-control-sm" id="edit_numeracao_termo"
          name="numeracao_termo" value="${(r.numeracao_termo !== null && r.numeracao_termo !== undefined) ? r.numeracao_termo : ''}"
          min="1" max="999" step="1" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,3)"
          onchange="rebuildNumeroTermo()">
      </div>
      <div class="col-md-4">
        <label class="form-label fw-bold text-muted mb-1 small">Tipo de Termo</label>
        <select class="form-select form-select-sm" id="edit_tipo_termo" name="tipo_termo"
          onchange="rebuildNumeroTermo()">${opts(TIPO_TERMO_LIST, r.tipo_termo)}</select>
      </div>
      <div class="col-md-4">
        <label class="form-label fw-bold text-muted mb-1 small">Edital</label>
        <select class="form-select form-select-sm" id="edit_edital_nome" name="edital_nome"
          onchange="rebuildNumeroTermo(); verificarEditalEmenda('edit')">${opts(EDITAIS_LIST, r.edital_nome)}</select>
      </div>

      ${/* ── Seção Emenda Parlamentar (edit) ── */''}<div class="col-12" id="sec_emenda_edit" style="display:none;">
        <h6 class="text-warning fw-bold border-bottom pb-2 mt-2">
          <i class="bi bi-cash-coin me-1"></i> Informações de Emenda Parlamentar
        </h6>
        <div id="alerta_emenda_edit" class="mb-2"></div>
        <div class="row g-2">
          <div class="col-md-5">
            <label class="form-label fw-bold text-muted mb-1 small">SEI Orçamentário</label>
            <select class="form-select form-select-sm" id="edit_sei_orcamentario"
              onchange="aoSelecionarSEIorc('edit')">
              <option value="">-- Selecione --</option>
            </select>
          </div>
          <div class="col-md-7">
            <label class="form-label fw-bold text-muted mb-1 small">Vereadores vinculados</label>
            <input type="text" class="form-control form-control-sm" id="edit_vereadores_info" readonly style="background:#f0f0f0;">
          </div>
        </div>
      </div>

      ${sec('building', 'OSC e Projeto')}
      ${fld('CNPJ', cnpjField(r.cnpj), 3)}
      <div class="col-md-6">
        <label class="form-label fw-bold text-muted mb-1 small">OSC</label>
        ${oscField(r.osc)}
      </div>
      <div class="col-12">
        <label class="form-label fw-bold text-muted mb-1 small">Responsável(eis)</label>
        ${responsavelField(r.responsavel)}
      </div>
      <div class="col-12">
        <label class="form-label fw-bold text-muted mb-1 small">Projeto</label>
        <input type="text" class="form-control form-control-sm" id="edit_projeto" name="projeto" value="${esc(r.projeto)}">
      </div>
      <div class="col-12">
        <label class="form-label fw-bold text-muted mb-1 small">
          Endereço Sede
          <span style="cursor:help;" data-bs-toggle="tooltip" data-bs-placement="top"
            title="Esta informação constará no cabeçalho do Termo de Parceria quando firmado.">
            <i class="bi bi-info-circle text-primary ms-1"></i>
          </span>
        </label>
        <input type="text" class="form-control form-control-sm" id="edit_endereco_sede" name="endereco_sede" value="${esc(r.endereco_sede)}">
      </div>

      ${sec('flag', 'Status')}
      <div class="col-md-4">
        <label class="form-label fw-bold text-muted mb-1 small">Status</label>
        <select class="form-select form-select-sm" id="edit_status" name="status"
          onchange="aoMudarStatus(this.value)">${opts(STATUS_LIST, r.status)}</select>
      </div>
      <div class="col-md-4">
        <label class="form-label fw-bold text-muted mb-1 small">
          Status Genérico
          <small class="text-muted fw-normal">(automático)</small>
        </label>
        <input type="text" class="form-control form-control-sm" id="edit_status_generico"
          name="status_generico" value="${esc(r.status_generico)}"
          readonly style="background:#f0f0f0;cursor:not-allowed;">
      </div>
      <div class="col-md-4">
        <label class="form-label fw-bold text-muted mb-1 small">
          Nome PG
          <small class="text-muted fw-normal">(Pessoa Gestora)</small>
        </label>
        <select class="form-select form-select-sm" id="edit_nome_pg" name="nome_pg">${opts(NOME_PG_LIST, r.nome_pg)}</select>
      </div>
      <div class="col-12">
        <label class="form-label fw-bold text-muted mb-1 small">Substatus</label>
        ${substatusField(r.status, r.substatus)}
      </div>

      ${sec('currency-dollar', 'Financeiro')}
      <div class="col-md-4">
        <label class="form-label fw-bold text-muted mb-1 small">Total Previsto (R$)</label>
        <input type="text" class="form-control form-control-sm" id="edit_total_previsto"
          name="total_previsto" value="${brMoney(r.total_previsto)}"
          onblur="formatarTotalPrevisto(this)" placeholder="Ex: 454.998,56">
      </div>
      <div class="col-md-4">
        <label class="form-label fw-bold text-muted mb-1 small">
          Conta
          <span style="cursor:help;" data-bs-toggle="tooltip" data-bs-placement="top"
            title="Informe agência e conta corrente. Ex: 001 / 12345-6">
            <i class="bi bi-info-circle text-primary ms-1"></i>
          </span>
        </label>
        <input type="text" class="form-control form-control-sm" id="edit_conta"
          name="conta" value="${esc(r.conta)}"
          placeholder="Ex: 001 / 12345-6 (agência / conta)">
      </div>
      <div class="col-md-4">
        <label class="form-label fw-bold text-muted mb-1 small">
          Lei / Portaria
          <button type="button" class="btn btn-outline-success btn-sm py-0 ms-1" style="font-size:0.7rem;"
            onclick="autoDetectarLei(true)" title="Detectar portaria automaticamente">
            <i class="bi bi-lightning-charge"></i> Auto
          </button>
        </label>
        <select class="form-select form-select-sm" id="edit_lei" name="lei">${opts(LEI_LIST, r.lei)}</select>
      </div>
      <div class="col-md-4">
        <label class="form-label fw-bold text-muted mb-1 small">Unidade Gestora</label>
        <select class="form-select form-select-sm" id="edit_unidade_gestora" name="unidade_gestora"
          onchange="rebuildNumeroTermo()">${opts(UNIDADES_LIST, r.unidade_gestora)}</select>
      </div>

      ${sec('calendar3', 'Datas e Vigência')}
      ${fld('Meses', `<input type="number" step="1" min="0" class="form-control form-control-sm" id="edit_meses" name="meses" value="${r.meses ?? ''}" onchange="calcularDataFinal()">`, 2)}
      ${fld('Dias', `<input type="number" step="1" min="0" class="form-control form-control-sm" id="edit_dias" name="dias" value="${r.dias ?? ''}" onchange="calcularDataFinal()">`, 2)}
      <div class="col-md-2">
        <label class="form-label fw-bold text-muted mb-1 small">Início</label>
        <input type="date" class="form-control form-control-sm" id="edit_inicio"
          name="inicio" value="${esc(r.inicio)}"
          onchange="rebuildNumeroTermo(); autoDetectarLei(false); calcularDataFinal();">
      </div>
      <div class="col-md-2">
        <label class="form-label fw-bold text-muted mb-1 small">
          Final
          <small class="text-muted fw-normal">(auto)</small>
        </label>
        <input type="date" class="form-control form-control-sm" id="edit_final"
          name="final" value="${esc(r.final)}"
          style="background:#f0f0f0;" title="Calculado automaticamente a partir de Início + Meses + Dias">
      </div>
      <div class="col-md-2">
        <label class="form-label fw-bold text-muted mb-1 small">Assinatura</label>
        <input type="date" class="form-control form-control-sm" id="edit_assinatura"
          name="assinatura" value="${esc(r.assinatura)}" onchange="rebuildNumeroTermo()">
      </div>
      <div class="col-md-2">
        <label class="form-label fw-bold text-muted mb-1 small">Secretaria</label>
        <select class="form-select form-select-sm" id="edit_celebracao_secretaria" name="celebracao_secretaria"
          onchange="rebuildNumeroTermo()">
          ${['SMDHC','SMADS','SME'].map(o => `<option value="${o}"${r.celebracao_secretaria===o?' selected':''}>${o}</option>`).join('')}
        </select>
      </div>

      ${sec('chat-left-text', 'Observações')}
      <div class="col-12">
        <textarea class="form-control form-control-sm" id="edit_observacoes" name="observacoes" rows="4">${esc(r.observacoes)}</textarea>
      </div>

      ${sec('geo-alt', 'Endereços de Execução do Projeto')}
      <div class="col-12">
        ${r.sei_celeb
          ? `<div class="form-check mb-2">
               <input class="form-check-input" type="checkbox" id="projeto_online_check"
                 onchange="toggleProjetoOnline(this)">
               <label class="form-check-label small fw-bold" for="projeto_online_check">
                 <i class="bi bi-wifi me-1"></i> O projeto é integralmente online
               </label>
             </div>
             <div id="enderecos_exec_container" class="mb-2"></div>
             <button type="button" id="btn_add_endereco" class="btn btn-outline-success btn-sm" onclick="adicionarEnderecoExec({})">
               <i class="bi bi-plus-circle me-1"></i> Adicionar Endereço
             </button>`
          : `<div class="alert alert-warning py-2 mb-0">
               <i class="bi bi-exclamation-triangle me-1"></i>
               Preencha o campo <strong>SEI Celebração</strong> e salve antes de adicionar endereços.
             </div>`
        }
      </div>

      ${sec('file-earmark-text', 'Informações de SEI')}
      <div class="col-12">
        ${r.sei_celeb
          ? `<div id="sei_docs_container" class="mb-2"></div>
             <button type="button" class="btn btn-outline-primary btn-sm" onclick="adicionarSEIDoc({})">
               <i class="bi bi-plus-circle me-1"></i> Adicionar Documento SEI
             </button>`
          : `<div class="alert alert-warning py-2 mb-0">
               <i class="bi bi-exclamation-triangle me-1"></i>
               Preencha o campo <strong>SEI Celebração</strong> e salve antes de adicionar documentos SEI.
             </div>`
        }
      </div>

      ${sec('info-circle', 'Informações Adicionais da Parceria')}
      <div class="col-12">
        ${r.sei_celeb
          ? `<div id="infos_adicionais_container"></div>`
          : `<div class="alert alert-warning py-2 mb-0">
               <i class="bi bi-exclamation-triangle me-1"></i>
               Preencha o campo <strong>SEI Celebração</strong> e salve antes de preencher informações adicionais.
             </div>`
        }
      </div>
    </div>
  </form>`;
}

// Sincroniza os checkboxes no hidden input de responsavel
function sincronizarResponsaveis() {
  const form = document.getElementById('formEditarRegistro');
  if (!form) return;
  const checks = form.querySelectorAll('.resp-check:checked');
  const vals = Array.from(checks).map(cb => cb.value).filter(v => v);
  const hidden = document.getElementById('edit_responsavel');
  if (hidden) hidden.value = vals.join(';');
}

// ── Substatus: sincronizar hidden input ───────────────────────────────────
function sincronizarSubstatus() {
  const checks = document.querySelectorAll('#substatus_box .substatus-check:checked');
  const vals = Array.from(checks).map(cb => cb.value).filter(v => v);
  const hidden = document.getElementById('edit_substatus');
  if (hidden) hidden.value = vals.join(';');
}

// ── Status: ao mudar, atualiza Status Genérico e filtra Substatus ─────────
function aoMudarStatus(statusVal) {
  // Preencher Status Genérico automaticamente (readonly)
  const sgEl = document.getElementById('edit_status_generico');
  if (sgEl) sgEl.value = STATUS_GEN_MAP[statusVal] || '';
  // Reconstruir caixas de substatus para o novo status
  const box = document.getElementById('substatus_box');
  if (!box) return;
  const statusId = STATUS_IDS[statusVal] || 0;
  const hiddenAtual = document.getElementById('edit_substatus');
  const selecionados = hiddenAtual ? hiddenAtual.value.split(';').map(v => v.trim()).filter(v => v) : [];
  let html = '';
  SUBSTATUS_LIST.forEach(sub => {
    const limite = SUBSTATUS_LIMITES[sub] || 0;
    if (statusId === 0 || limite < statusId) return; // não disponível para este status
    const safeId = 'sub_' + sub.replace(/[^a-zA-Z0-9]/g,'_');
    const checked = selecionados.includes(sub) ? 'checked' : '';
    html += `<div class="form-check">
      <input class="form-check-input substatus-check" type="checkbox"
        value="${sub}" id="${safeId}" ${checked} onchange="sincronizarSubstatus()">
      <label class="form-check-label small" for="${safeId}">${sub}</label>
    </div>`;
  });
  box.innerHTML = html || '<span class="text-muted small">Nenhum substatus disponível para este status.</span>';
  sincronizarSubstatus();
}

// ── Calcular data final automaticamente ───────────────────────────────────
function calcularDataFinal() {
  const inicioEl = document.getElementById('edit_inicio');
  const mesesEl  = document.getElementById('edit_meses');
  const diasEl   = document.getElementById('edit_dias');
  const finalEl  = document.getElementById('edit_final');
  if (!inicioEl || !finalEl || !inicioEl.value) { if (finalEl) finalEl.value = ''; return; }
  const meses = parseInt(mesesEl?.value) || 0;
  const dias  = parseInt(diasEl?.value)  || 0;
  if (meses === 0 && dias === 0) { finalEl.value = ''; return; }
  const d = new Date(inicioEl.value + 'T00:00:00');
  d.setMonth(d.getMonth() + meses);
  d.setDate(d.getDate() + dias - 1);
  const y  = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  finalEl.value = `${y}-${mm}-${dd}`;
}

// ── Endereços de Execução do Projeto ──────────────────────────────────────
let contadorEndExec = 0;

function adicionarEnderecoExec(dados) {
  const container = document.getElementById('enderecos_exec_container');
  if (!container) return;
  contadorEndExec++;
  const uid  = 'end_' + contadorEndExec;
  const logr = (dados.parceria_logradouro  || '').replace(/"/g, '&quot;');
  const comp = (dados.parceria_complemento || '').replace(/"/g, '&quot;');
  const cep  = (dados.parceria_cep         || '').replace(/"/g, '&quot;');
  const obs  = (dados.observacao           || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  const num  =  dados.parceria_numero      || '';
  const div  = document.createElement('div');
  div.className   = 'endereco-exec-item border rounded p-3 mb-2';
  div.dataset.uid = uid;
  div.innerHTML   = `
    <div class="d-flex justify-content-between mb-2">
      <h6 class="mb-0 small fw-bold text-muted">Endereço #${contadorEndExec}</h6>
      <button type="button" class="btn btn-sm btn-outline-danger py-0"
        onclick="removerEnderecoExec('${uid}')"><i class="bi bi-trash"></i></button>
    </div>
    <div class="row g-2">
      <div class="col-md-8"><label class="form-label small mb-0">Logradouro</label>
        <input type="text" class="form-control form-control-sm ee-logradouro" value="${logr}"></div>
      <div class="col-md-4"><label class="form-label small mb-0">Número</label>
        <input type="number" class="form-control form-control-sm ee-numero" value="${num}"></div>
      <div class="col-md-6"><label class="form-label small mb-0">Complemento</label>
        <input type="text" class="form-control form-control-sm ee-complemento" value="${comp}"></div>
      <div class="col-md-6"><label class="form-label small mb-0">CEP</label>
        <input type="text" class="form-control form-control-sm ee-cep" value="${cep}" placeholder="00000-000"></div>
      <div class="col-12"><label class="form-label small mb-0">Distrito</label>
        <select class="form-select form-select-sm ee-dist-sel" id="dist_${uid}"></select></div>
      <div class="col-md-6"><label class="form-label small mb-0">Subprefeitura <span class="text-muted fw-normal">(auto)</span></label>
        <input type="text" class="form-control form-control-sm ee-subprefeitura" readonly style="background:#f8f9fa;" placeholder="—"></div>
      <div class="col-md-6"><label class="form-label small mb-0">Região <span class="text-muted fw-normal">(auto)</span></label>
        <input type="text" class="form-control form-control-sm ee-regiao" readonly style="background:#f8f9fa;" placeholder="—"></div>
      <div class="col-12"><label class="form-label small mb-0">Observação</label>
        <textarea class="form-control form-control-sm ee-observacao" rows="2">${obs}</textarea></div>
    </div>`;
  container.appendChild(div);
  // CEP mask
  div.querySelector('.ee-cep').addEventListener('input', function(e) {
    let v = e.target.value.replace(/\D/g, '');
    if (v.length > 5) v = v.slice(0, 5) + '-' + v.slice(5, 8);
    e.target.value = v;
  });
  // Select2 para distrito
  const sel = div.querySelector('.ee-dist-sel');
  $(sel).select2({
    theme: 'bootstrap-5', width: '100%',
    ajax: {
      url: '/celebracao-parcerias/api/distritos', dataType: 'json', delay: 250,
      data: function(p) { return { q: p.term }; },
      processResults: function(r) { return { results: r }; }, cache: true
    },
    placeholder: 'Digite para buscar distrito...', allowClear: true, minimumInputLength: 0
  });
  // Auto-fill subprefeitura/região ao selecionar distrito (usa .text do evento, não .val())
  $(sel).on('select2:select', function(e) {
    const distText = e.params?.data?.text || '';
    const sub = div.querySelector('.ee-subprefeitura');
    const reg = div.querySelector('.ee-regiao');
    const info = REGIONALIZACAO_MAP[distText];
    if (sub) sub.value = info ? (info.subprefeitura || '') : '';
    if (reg) reg.value = info ? (info.regiao || '') : '';
  }).on('select2:clear', function() {
    const sub = div.querySelector('.ee-subprefeitura');
    const reg = div.querySelector('.ee-regiao');
    if (sub) sub.value = '';
    if (reg) reg.value = '';
  });
  if (dados.parceria_distrito) {
    const opt = new Option(dados.parceria_distrito, dados.parceria_distrito, true, true);
    $(sel).append(opt).trigger('change');
    // Preencher subprefeitura/região ao carregar dados existentes
    const info = REGIONALIZACAO_MAP[dados.parceria_distrito];
    if (info) {
      const sub = div.querySelector('.ee-subprefeitura');
      const reg = div.querySelector('.ee-regiao');
      if (sub) sub.value = info.subprefeitura || '';
      if (reg) reg.value = info.regiao || '';
    }
  }
}

function removerEnderecoExec(uid) {
  const el = document.querySelector(`[data-uid="${uid}"]`);
  if (el) el.remove();
}

function coletarEnderecos() {
  // Se projeto online, retorna registro especial
  const onlineChk = document.getElementById('projeto_online_check');
  if (onlineChk && onlineChk.checked) return [{ observacao: 'Online' }];
  const result = [];
  document.querySelectorAll('.endereco-exec-item').forEach(item => {
    const sel = item.querySelector('.ee-dist-sel');
    const distText = sel?.options[sel.selectedIndex]?.text || '';
    result.push({
      parceria_logradouro:  item.querySelector('.ee-logradouro')?.value  || '',
      parceria_numero:      item.querySelector('.ee-numero')?.value       || '',
      parceria_complemento: item.querySelector('.ee-complemento')?.value  || '',
      parceria_cep:         item.querySelector('.ee-cep')?.value          || '',
      parceria_distrito:    distText,
      observacao:           item.querySelector('.ee-observacao')?.value   || ''
    });
  });
  return result;
}

async function carregarEnderecos(recordId) {
  const container = document.getElementById('enderecos_exec_container');
  if (!container) return;
  contadorEndExec = 0;
  container.innerHTML = '';
  try {
    const resp = await fetch(`/celebracao-parcerias/enderecos/${recordId}`);
    const d = await resp.json();
    if (d.success && d.enderecos && d.enderecos.length) {
      // Detectar projeto online: registro único com observacao='Online' e sem logradouro
      const isOnline = d.enderecos.length === 1 &&
        d.enderecos[0].observacao === 'Online' &&
        !d.enderecos[0].parceria_logradouro;
      const chk = document.getElementById('projeto_online_check');
      if (isOnline && chk) {
        chk.checked = true;
        toggleProjetoOnline(chk);
      } else {
        d.enderecos.forEach(enc => adicionarEnderecoExec(enc));
      }
    }
  } catch(e) { console.warn('carregarEnderecos:', e); }
}

// ── Informações de SEI ────────────────────────────────────────────────────
let contadorSEIDocs = 0;

function adicionarSEIDoc(dados) {
  const container = document.getElementById('sei_docs_container');
  if (!container) return;
  contadorSEIDocs++;
  const uid     = 'sei_' + contadorSEIDocs;
  const tipoVal  = dados.termo_tipo_sei || 'Termo Base';
  const docVal   = (dados.termo_sei_doc || '').replace(/"/g, '&quot;');
  const criado   = dados.created_por
    ? `<small class="text-muted ms-2">por ${dados.created_por}${dados.created_at ? ' em ' + dados.created_at : ''}</small>`
    : '';
  const div = document.createElement('div');
  div.className   = 'sei-doc-item border rounded p-3 mb-2';
  div.dataset.uid = uid;
  div.innerHTML   = `
    <div class="d-flex justify-content-between align-items-start mb-2">
      <h6 class="mb-0 small fw-bold text-muted">Documento SEI #${contadorSEIDocs}${criado}</h6>
      <button type="button" class="btn btn-sm btn-outline-danger py-0"
        onclick="removerSEIDoc('${uid}')"><i class="bi bi-trash"></i></button>
    </div>
    <div class="row g-2">
      <div class="col-md-5">
        <label class="form-label small mb-0">Tipo do Documento</label>
        <select class="form-select form-select-sm sd-tipo">
          ${SEI_TIPO_OPTIONS.map(t => `<option value="${t}"${t === tipoVal ? ' selected' : ''}>${t}</option>`).join('')}
        </select>
      </div>
      <div class="col-md-7">
        <label class="form-label small mb-0">SEI do Documento</label>
        <input type="text" class="form-control form-control-sm sd-doc"
          placeholder="Ex: 0123456789" maxlength="15" value="${docVal}">
      </div>
    </div>`;
  container.appendChild(div);
}

function removerSEIDoc(uid) {
  const el = document.querySelector(`.sei-doc-item[data-uid="${uid}"]`);
  if (el) el.remove();
}

function coletarSEIDocs() {
  const result = [];
  const tiposSeen = new Set();
  let hasDuplicate = false;
  document.querySelectorAll('.sei-doc-item').forEach(item => {
    const tipoEl = item.querySelector('.sd-tipo');
    const tipo   = tipoEl?.value || '';
    const doc    = item.querySelector('.sd-doc')?.value.trim() || '';
    if (tiposSeen.has(tipo)) {
      hasDuplicate = true;
      if (tipoEl) tipoEl.style.borderColor = '#dc3545';
    } else {
      tiposSeen.add(tipo);
      if (tipoEl) tipoEl.style.borderColor = '';
    }
    result.push({ termo_tipo_sei: tipo, termo_sei_doc: doc });
  });
  if (hasDuplicate) return null; // sinal de erro de validação
  return result;
}

async function carregarSEIDocs(recordId) {
  const container = document.getElementById('sei_docs_container');
  if (!container) return;
  contadorSEIDocs = 0;
  container.innerHTML = '';
  try {
    const resp = await fetch(`/celebracao-parcerias/sei-docs/${recordId}`);
    const d = await resp.json();
    if (d.success && d.sei_docs && d.sei_docs.length) {
      d.sei_docs.forEach(doc => adicionarSEIDoc(doc));
    }
  } catch(e) { console.warn('carregarSEIDocs:', e); }
}

// ── Informações Adicionais da Parceria ────────────────────────────────────
function renderInfosAdicionais(info) {
  const container = document.getElementById('infos_adicionais_container');
  if (!container) return;
  // Responsáveis legais: array de nomes separados por ponto-e-vírgula
  const resps = (info.parceria_responsavel_legal || '').split(';').map(s => s.trim()).filter(Boolean);
  const respsHtml = resps.map((nome, i) => `
    <div class="input-group input-group-sm mb-1 resp-legal-row" data-idx="${i}">
      <input type="text" class="form-control form-control-sm resp-legal-input"
        value="${nome.replace(/"/g, '&quot;')}" placeholder="Nome completo do responsável legal">
      <button type="button" class="btn btn-outline-danger" onclick="this.closest('.resp-legal-row').remove()">
        <i class="bi bi-x"></i>
      </button>
    </div>`).join('');
  container.innerHTML = `
    <div class="row g-3">
      <div class="col-12">
        <label class="form-label small fw-bold mb-1">
          Responsável(is) Legal(is)
          <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip"
            title="Nome(s) completo(s) que constará(ão) no termo. Adicione um por linha."></i>
        </label>
        <div id="resp_legal_list" class="mb-1">${respsHtml}</div>
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="adicionarRespLegal()">
          <i class="bi bi-plus-circle me-1"></i> Adicionar Responsável Legal
        </button>
      </div>
      <div class="col-md-6">
        <label class="form-label small fw-bold mb-1">Beneficiários Diretos</label>
        <input type="number" min="0" step="1" class="form-control form-control-sm"
          id="ia_benef_diretos" value="${info.parceria_beneficiarios_diretos ?? ''}">
      </div>
      <div class="col-md-6">
        <label class="form-label small fw-bold mb-1">Beneficiários Indiretos</label>
        <input type="number" min="0" step="1" class="form-control form-control-sm"
          id="ia_benef_indiretos" value="${info.parceria_beneficiarios_indiretos ?? ''}">
      </div>
      <div class="col-12">
        <label class="form-label small fw-bold mb-1">Objeto</label>
        <textarea class="form-control form-control-sm auto-resize" id="ia_objeto" rows="3"
          placeholder="Descreva o objeto da parceria..."
          oninput="autoResize(this)">${(info.parceria_objeto || '').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</textarea>
      </div>
      <div class="col-12">
        <label class="form-label small fw-bold mb-1">Justificativa do Projeto</label>
        <textarea class="form-control form-control-sm auto-resize" id="ia_justificativa" rows="3"
          placeholder="Descreva a justificativa..."
          oninput="autoResize(this)">${(info.parceria_justificativa_projeto || '').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</textarea>
      </div>
      <div class="col-12">
        <label class="form-label small fw-bold mb-1">Abrangência do Projeto</label>
        <textarea class="form-control form-control-sm auto-resize" id="ia_abrangencia" rows="3"
          placeholder="Descreva a abrangência..."
          oninput="autoResize(this)">${(info.parceria_abrangencia_projeto || '').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</textarea>
      </div>
    </div>`;
  // Reativar tooltips e ajustar tamanho dos textareas conforme conteúdo
  container.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
  autoResizeAll(container);
}

function adicionarRespLegal() {
  const list = document.getElementById('resp_legal_list');
  if (!list) return;
  const idx = list.querySelectorAll('.resp-legal-row').length;
  const div = document.createElement('div');
  div.className = 'input-group input-group-sm mb-1 resp-legal-row';
  div.dataset.idx = idx;
  div.innerHTML = `
    <input type="text" class="form-control form-control-sm resp-legal-input"
      placeholder="Nome completo do responsável legal">
    <button type="button" class="btn btn-outline-danger" onclick="this.closest('.resp-legal-row').remove()">
      <i class="bi bi-x"></i>
    </button>`;
  list.appendChild(div);
  div.querySelector('input').focus();
}

function coletarInfosAdicionais() {
  const container = document.getElementById('infos_adicionais_container');
  if (!container) return null;
  const resps = Array.from(container.querySelectorAll('.resp-legal-input'))
    .map(el => el.value.trim()).filter(Boolean);
  return {
    parceria_responsavel_legal:    resps.join(';') || null,
    parceria_beneficiarios_diretos:   parseInt(document.getElementById('ia_benef_diretos')?.value)  || null,
    parceria_beneficiarios_indiretos: parseInt(document.getElementById('ia_benef_indiretos')?.value) || null,
    parceria_objeto:                  document.getElementById('ia_objeto')?.value.trim()         || null,
    parceria_justificativa_projeto:   document.getElementById('ia_justificativa')?.value.trim()  || null,
    parceria_abrangencia_projeto:     document.getElementById('ia_abrangencia')?.value.trim()    || null,
  };
}

async function carregarInfosAdicionais(recordId) {
  const container = document.getElementById('infos_adicionais_container');
  if (!container) return;
  container.innerHTML = '<span class="text-muted small"><span class="spinner-border spinner-border-sm me-1"></span>Carregando...</span>';
  try {
    const resp = await fetch(`/celebracao-parcerias/infos-adicionais/${recordId}`);
    const d = await resp.json();
    renderInfosAdicionais(d.success ? (d.infos || {}) : {});
  } catch(e) {
    console.warn('carregarInfosAdicionais:', e);
    renderInfosAdicionais({});
  }
}

// ── Projeto online: toggle da seção de endereços ──────────────────────────
function toggleProjetoOnline(chk) {
  const container = document.getElementById('enderecos_exec_container');
  const btnAdd    = document.getElementById('btn_add_endereco');
  if (chk.checked) {
    if (container) { container.innerHTML = ''; }
    if (btnAdd) { btnAdd.style.display = 'none'; }
  } else {
    if (btnAdd) { btnAdd.style.display = ''; }
  }
}

// ── Validação: data está a mais de 6 meses de hoje? ───────────────────────
function _dataFora6Meses(ds) {
  if (!ds) return false;
  const d = new Date(ds + 'T00:00:00');
  const h = new Date(); h.setHours(0, 0, 0, 0);
  const l1 = new Date(h); l1.setMonth(l1.getMonth() - 6);
  const l2 = new Date(h); l2.setMonth(l2.getMonth() + 6);
  return d < l1 || d > l2;
}

// ── Total Previsto: formatação monetária BR ───────────────────────────────
function brMoney(v) {
  if (v === null || v === undefined || v === '') return '';
  const n = parseFloat(String(v).replace(',', '.'));
  if (isNaN(n)) return '';
  return n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatarTotalPrevisto(input) {
  const raw = input.value.replace(/\./g, '').replace(',', '.');
  const n = parseFloat(raw);
  if (!isNaN(n)) {
    input.value = n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }
}

// ── Emenda Parlamentar ──────────────────────────────────────────────────────
const EMENDA_EDITAL_NAME = 'Sem Edital (Emenda Parlamentar)';

async function verificarEditalEmenda(prefix) {
  const editId = prefix === 'edit' ? 'edit_edital_nome' : 'new_edital_nome';
  const edital = document.getElementById(editId)?.value || '';
  const sec = document.getElementById(`sec_emenda_${prefix}`);
  if (!sec) return;
  if (edital !== EMENDA_EDITAL_NAME) { sec.style.display = 'none'; return; }
  sec.style.display = '';

  const seiId  = prefix === 'edit' ? 'edit_sei_celeb' : 'new_sei_celeb';
  const projId = prefix === 'edit' ? 'edit_projeto'   : 'new_projeto';
  const sei    = document.getElementById(seiId)?.value.trim() || '';
  const seiEff = sei && sei !== '-' ? sei : '';
  const projeto = document.getElementById(projId)?.value.trim() || '';

  const alertEl = document.getElementById(`alerta_emenda_${prefix}`);
  if (!seiEff && !projeto) {
    alertEl.innerHTML = '<div class="alert alert-warning py-1 small mb-0"><i class="bi bi-exclamation-triangle-fill me-1"></i>Preencha o SEI Celebração ou o Projeto para carregar as informações de emenda.</div>';
    return;
  }

  alertEl.innerHTML = '<div class="text-muted small"><span class="spinner-border spinner-border-sm me-1"></span>Carregando...</div>';
  try {
    const url = seiEff
      ? `/celebracao-parcerias/api/emendas-por-sei?sei_celeb=${encodeURIComponent(seiEff)}`
      : `/celebracao-parcerias/api/emendas-por-sei?projeto=${encodeURIComponent(projeto)}`;
    const res = await fetch(url);
    const d = await res.json();
    const sel = document.getElementById(`${prefix}_sei_orcamentario`);
    sel.innerHTML = '<option value="">-- Selecione --</option>';
    d.emendas.forEach(e => {
      const opt = document.createElement('option');
      opt.value = e.sei_orcamentario;
      opt.textContent = e.sei_orcamentario;
      sel.appendChild(opt);
    });
    document.getElementById(`${prefix}_vereadores_info`).value = d.vereadores.join(', ') || '—';
    if (d.projeto) {
      const projEl = document.getElementById(projId);
      if (projEl && !projEl.value) projEl.value = d.projeto;
    }
    if (d.total_valor > 0) {
      const totId = prefix === 'edit' ? 'edit_total_previsto' : 'new_total_previsto';
      const totEl = document.getElementById(totId);
      if (totEl) totEl.value = d.total_valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
    }
    if (d.emendas.length === 0) {
      const msg = d.vinculo === 'projeto'
        ? 'Nenhum SEI Orçamentário vinculado a este Projeto.'
        : 'Nenhum SEI Orçamentário vinculado a este SEI Celebração.';
      alertEl.innerHTML = `<div class="alert alert-warning py-1 small mb-0"><i class="bi bi-exclamation-triangle-fill me-1"></i>${msg}</div>`;
    } else if (d.multiplos) {
      const via = d.vinculo === 'projeto' ? 'projeto' : 'SEI Celebração';
      alertEl.innerHTML = `<div class="alert alert-info py-1 small mb-0"><i class="bi bi-info-circle me-1"></i>Há <strong>${d.emendas.length}</strong> processos orçamentários vinculados via <em>${via}</em>. Verifique se todos foram acrescidos.</div>`;
    } else {
      const via = d.vinculo === 'projeto' ? ' <span class="badge bg-secondary" style="font-size:0.7rem;">vínculo por projeto</span>' : '';
      alertEl.innerHTML = via ? `<div class="text-muted small">${via}</div>` : '';
    }
    if (d.emendas.length === 1) sel.value = d.emendas[0].sei_orcamentario;
  } catch (err) {
    document.getElementById(`alerta_emenda_${prefix}`).innerHTML =
      '<div class="alert alert-danger py-1 small mb-0">Erro ao carregar emendas.</div>';
  }
}

function aoSelecionarSEIorc(prefix) {
  /* futuro: auto-preencher projeto conforme SEI Orçamentário selecionado */
}

// ── Lei: auto-detecção via /api/portaria-automatica ───────────────────────
async function autoDetectarLei(forcar) {
  const leiEl = document.getElementById('edit_lei');
  if (!leiEl) return;
  // Não sobrescreve valor existente, a não ser que forçado pelo botão
  if (!forcar && leiEl.value) return;
  const numeroTermo = (document.getElementById('edit_numero_termo') || {}).value || '';
  const inicio = (document.getElementById('edit_inicio') || {}).value || '';
  if (!numeroTermo || !inicio) return;
  try {
    const resp = await fetch('/api/portaria-automatica', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ data_inicio: inicio, numero_termo: numeroTermo })
    });
    const d = await resp.json();
    if (d.portaria) {
      leiEl.value = d.portaria;
      leiEl.style.borderColor = '#28a745';
      setTimeout(() => { leiEl.style.borderColor = ''; }, 2000);
    }
  } catch(e) { console.warn('autoDetectarLei:', e); }
}

// ── CNPJ: máscara e validação ──────────────────────────────────────────────
function formatarCNPJ(input) {
  let d = input.value.replace(/[^\d]/g, '').slice(0, 14);
  let out = '';
  if (d.length > 0)  out  = d.slice(0, Math.min(2, d.length));
  if (d.length > 2)  out += '.' + d.slice(2, Math.min(5, d.length));
  if (d.length > 5)  out += '.' + d.slice(5, Math.min(8, d.length));
  if (d.length > 8)  out += '/' + d.slice(8, Math.min(12, d.length));
  if (d.length > 12) out += '-' + d.slice(12, 14);
  input.value = out;
  validarCNPJ(input);
}

function validarCNPJ(input) {
  const re = /^\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}$/;
  const warn = document.getElementById('cnpj_warn');
  if (!input.value || re.test(input.value)) {
    input.style.borderColor = '';
    input.style.backgroundColor = '';
    if (warn) warn.style.display = 'none';
  } else {
    input.style.borderColor = '#ffc107';
    input.style.backgroundColor = '#fffef0';
    if (warn) warn.style.display = '';
  }
}

// ── CNPJ → OSC lookup ─────────────────────────────────────────────────────
function buscarOSCporCNPJ() {
  const cnpjEl = document.getElementById('edit_cnpj');
  const oscEl  = document.getElementById('edit_osc');
  const resultDiv = document.getElementById('osc_lookup_result');
  if (!cnpjEl || !oscEl || !resultDiv) return;

  const cnpj = cnpjEl.value.trim();
  if (!cnpj) { resultDiv.style.display = 'none'; return; }

  const re = /^\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}$/;
  if (!re.test(cnpj)) {
    resultDiv.style.display = '';
    resultDiv.innerHTML = '<span class="text-warning small"><i class="bi bi-exclamation-triangle-fill me-1"></i>Digite um CNPJ válido antes de buscar.</span>';
    return;
  }

  resultDiv.style.display = '';
  resultDiv.innerHTML = '<span class="text-muted small"><span class="spinner-border spinner-border-sm me-1"></span>Buscando...</span>';

  fetch(`/celebracao-parcerias/cnpj-lookup?cnpj=${encodeURIComponent(cnpj)}`)
    .then(r => r.json())
    .then(data => {
      if (!data.success) {
        resultDiv.innerHTML = `<span class="text-danger small"><i class="bi bi-x-circle me-1"></i>${data.erro}</span>`;
        return;
      }
      if (data.resultados.length === 0) {
        resultDiv.innerHTML = '<span class="text-muted small"><i class="bi bi-info-circle me-1"></i>Nenhuma OSC encontrada para este CNPJ.</span>';
        return;
      }
      if (data.resultados.length === 1) {
        oscEl.value = data.resultados[0];
        resultDiv.innerHTML = `<span class="text-success small"><i class="bi bi-check-circle me-1"></i>OSC preenchida automaticamente.</span>`;
        setTimeout(() => { resultDiv.style.display = 'none'; }, 2500);
        return;
      }
      // Múltiplos resultados: mostrar opções
      let btns = data.resultados.map(nome =>
        `<button type="button" class="btn btn-outline-secondary btn-sm me-1 mb-1"
          onclick="document.getElementById('edit_osc').value=this.dataset.nome; document.getElementById('osc_lookup_result').style.display='none';"
          data-nome="${nome.replace(/"/g,'&quot;')}">${nome}</button>`
      ).join('');
      resultDiv.innerHTML = `<div class="small text-muted mb-1"><i class="bi bi-list-ul me-1"></i>Múltiplos registros encontrados. Escolha:</div>${btns}`;
    })
    .catch(err => {
      resultDiv.innerHTML = `<span class="text-danger small">Erro: ${err}</span>`;
    });
}

// ── SEI: máscara automática e validação ────────────────────────────────────
function formatarSEI(input) {
  let digits = input.value.replace(/[^\d]/g, '').slice(0, 16);
  let out = '';
  if (digits.length > 0)  out  = digits.slice(0, Math.min(4, digits.length));
  if (digits.length > 4)  out += '.' + digits.slice(4, Math.min(8,  digits.length));
  if (digits.length > 8)  out += '/' + digits.slice(8, Math.min(15, digits.length));
  if (digits.length > 15) out += '-' + digits.slice(15, 16);
  input.value = out;
  validarSEI(input);
}

function validarSEI(input) {
  const re = /^\d{4}\.\d{4}\/\d{6,7}-\d$/;
  const warn = document.getElementById('sei_celeb_warn');
  if (!input.value || re.test(input.value)) {
    input.style.borderColor = '';
    input.style.backgroundColor = '';
    if (warn) warn.style.display = 'none';
  } else {
    input.style.borderColor = '#ffc107';
    input.style.backgroundColor = '#fffef0';
    if (warn) warn.style.display = '';
  }
}

// ── Nº Termo: auto-construção ──────────────────────────────────────────────
// ── Auto-resize para textareas ──────────────────────────────────────────
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = el.scrollHeight + 'px';
}
function autoResizeAll(root) {
  (root || document).querySelectorAll('textarea.auto-resize').forEach(autoResize);
}

// ── Nova Parceria ─────────────────────────────────────────────────────────
function abrirNovaParc() {
  const modal = new bootstrap.Modal(document.getElementById('modalNovaParc'));
  document.getElementById('novaParcConteudo').innerHTML = montarFormularioNovo();
  rebuildNumeroTermoNovo();
  document.getElementById('novaParcConteudo').querySelectorAll('[data-bs-toggle="tooltip"]')
    .forEach(el => new bootstrap.Tooltip(el));
  const btnNova = document.getElementById('btnSalvarNova');
  if (btnNova) { btnNova.disabled = false; btnNova.innerHTML = '<i class="bi bi-plus-circle me-1"></i> Criar Parceria'; }
  modal.show();
}

function montarFormularioNovo() {
  function esc(v) {
    if (v === null || v === undefined) return '';
    return String(v).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }
  function opts(lista, selecionado) {
    let html = '<option value="">-- Selecione --</option>';
    lista.forEach(o => { html += `<option value="${esc(o)}"${o===selecionado?' selected':''}>${esc(o)}</option>`; });
    return html;
  }
  function fld(label, inputHTML, colMd=4) {
    return `<div class="col-md-${colMd}"><label class="form-label fw-bold text-muted mb-1 small">${label}</label>${inputHTML}</div>`;
  }
  function sec(icon, title) {
    return `<div class="col-12"><h6 class="text-primary fw-bold border-bottom pb-2 mt-3"><i class="bi bi-${icon} me-1"></i> ${title}</h6></div>`;
  }

  const respChecks = RESPONSAVEIS_NOMES.map(nome => {
    const safeId = 'newresp_' + esc(nome).replace(/[^a-zA-Z0-9]/g,'_');
    return `<span>
      <input class="btn-check new-resp-check" type="checkbox" value="${esc(nome)}"
        id="${safeId}" autocomplete="off" onchange="sincronizarResponsaveisNovo()">
      <label class="btn btn-sm btn-outline-primary" for="${safeId}">${esc(nome)}</label>
    </span>`;
  }).join('');

  return `<form id="formNovaParc">
    <div class="row g-2">
      ${sec('card-heading', 'Identificação')}
      <div class="col-md-4">
        <label class="form-label fw-bold text-muted mb-1 small">SEI Celebração</label>
        <input type="text" class="form-control form-control-sm" id="new_sei_celeb" name="sei_celeb"
          placeholder="0000.0000/0000000-0" maxlength="20" oninput="formatarSEI(this)">
      </div>
      <div class="col-md-4">
        <label class="form-label fw-bold text-muted mb-1 small">Tipo de Termo</label>
        <select class="form-select form-select-sm" id="new_tipo_termo" name="tipo_termo"
          onchange="rebuildNumeroTermoNovo()">${opts(TIPO_TERMO_LIST,'')}</select>
      </div>
      <div class="col-md-4">
        <label class="form-label fw-bold text-muted mb-1 small">Edital</label>
        <select class="form-select form-select-sm" id="new_edital_nome" name="edital_nome"
          onchange="rebuildNumeroTermoNovo(); verificarEditalEmenda('new')">${opts(EDITAIS_LIST,'')}</select>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-bold text-muted mb-1 small">Numeração do Termo</label>
        <input type="number" class="form-control form-control-sm" id="new_numeracao_termo" name="numeracao_termo"
          min="1" max="999" step="1" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,3)"
          onchange="rebuildNumeroTermoNovo()">
      </div>
      <div class="col-md-5">
        <label class="form-label fw-bold text-muted mb-1 small">Nº Termo <small class="text-muted fw-normal">(auto)</small></label>
        <input type="text" class="form-control form-control-sm" id="new_numero_termo" name="numero_termo"
          readonly style="background:#f0f0f0;" placeholder="Gerado automaticamente">
      </div>
      <div class="col-md-4">
        <label class="form-label fw-bold text-muted mb-1 small">Unidade Gestora</label>
        <select class="form-select form-select-sm" id="new_unidade_gestora" name="unidade_gestora"
          onchange="rebuildNumeroTermoNovo()">${opts(UNIDADES_LIST,'')}</select>
      </div>

      ${/* ── Seção Emenda Parlamentar (new) ── */''}<div class="col-12" id="sec_emenda_new" style="display:none;">
        <h6 class="text-warning fw-bold border-bottom pb-2 mt-2">
          <i class="bi bi-cash-coin me-1"></i> Informações de Emenda Parlamentar
        </h6>
        <div id="alerta_emenda_new" class="mb-2"></div>
        <div class="row g-2">
          <div class="col-md-5">
            <label class="form-label fw-bold text-muted mb-1 small">SEI Orçamentário</label>
            <select class="form-select form-select-sm" id="new_sei_orcamentario"
              onchange="aoSelecionarSEIorc('new')">
              <option value="">-- Selecione --</option>
            </select>
          </div>
          <div class="col-md-7">
            <label class="form-label fw-bold text-muted mb-1 small">Vereadores vinculados</label>
            <input type="text" class="form-control form-control-sm" id="new_vereadores_info" readonly style="background:#f0f0f0;">
          </div>
        </div>
      </div>

      ${sec('building', 'OSC e Projeto')}
      ${fld('CNPJ', `<div class="input-group input-group-sm">
        <input type="text" class="form-control form-control-sm" id="new_cnpj" name="cnpj"
          placeholder="00.000.000/0000-00" maxlength="18" oninput="formatarCNPJ(this)">
        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="buscarOSCporCNPJNovo()" title="Buscar OSC"><i class="bi bi-search"></i></button>
      </div>
      <div id="new_cnpj_warn" class="small mt-1 text-warning" style="display:none;"><i class="bi bi-exclamation-triangle-fill me-1"></i>Formato: 00.000.000/0000-00</div>`, 3)}
      <div class="col-md-6">
        <label class="form-label fw-bold text-muted mb-1 small">OSC</label>
        <input type="text" class="form-control form-control-sm" id="new_osc" name="osc" placeholder="Nome da OSC">
        <div id="new_osc_lookup" class="mt-1" style="display:none;"></div>
      </div>
      <div class="col-12">
        <label class="form-label fw-bold text-muted mb-1 small">Responsável(eis)</label>
        <div class="resp-picker d-flex flex-wrap gap-2 border rounded p-2" style="background:#fff;min-height:46px;">
          ${respChecks || '<span class="text-muted small align-self-center">Nenhum analista</span>'}
        </div>
        <input type="hidden" id="new_responsavel" name="responsavel" value="">
      </div>
      <div class="col-12">
        <label class="form-label fw-bold text-muted mb-1 small">Projeto</label>
        <input type="text" class="form-control form-control-sm" id="new_projeto" name="projeto">
      </div>
      <div class="col-12">
        <label class="form-label fw-bold text-muted mb-1 small">Endereço Sede</label>
        <input type="text" class="form-control form-control-sm" id="new_endereco_sede" name="endereco_sede">
      </div>

      ${sec('flag', 'Status')}
      <div class="col-md-4">
        <label class="form-label fw-bold text-muted mb-1 small">Status</label>
        <select class="form-select form-select-sm" id="new_status" name="status"
          onchange="aoMudarStatusNovo(this.value)">${opts(STATUS_LIST,'')}</select>
      </div>
      <div class="col-md-4">
        <label class="form-label fw-bold text-muted mb-1 small">Status Genérico <small class="text-muted fw-normal">(auto)</small></label>
        <input type="text" class="form-control form-control-sm" id="new_status_generico" name="status_generico"
          readonly style="background:#f0f0f0;">
      </div>
      <div class="col-md-4">
        <label class="form-label fw-bold text-muted mb-1 small">Nome PG</label>
        <select class="form-select form-select-sm" id="new_nome_pg" name="nome_pg">${opts(NOME_PG_LIST,'')}</select>
      </div>

      ${sec('calendar3', 'Datas e Vigência')}
      ${fld('Meses', `<input type="number" step="1" min="0" class="form-control form-control-sm" id="new_meses" name="meses" onchange="calcularDataFinalNovo()">`, 2)}
      ${fld('Dias',  `<input type="number" step="1" min="0" class="form-control form-control-sm" id="new_dias"  name="dias"  onchange="calcularDataFinalNovo()">`, 2)}
      <div class="col-md-2">
        <label class="form-label fw-bold text-muted mb-1 small">Início</label>
        <input type="date" class="form-control form-control-sm" id="new_inicio" name="inicio"
          onchange="rebuildNumeroTermoNovo(); calcularDataFinalNovo();">
      </div>
      <div class="col-md-2">
        <label class="form-label fw-bold text-muted mb-1 small">Final <small class="text-muted fw-normal">(auto)</small></label>
        <input type="date" class="form-control form-control-sm" id="new_final" name="final" readonly style="background:#f0f0f0;">
      </div>
      <div class="col-md-2">
        <label class="form-label fw-bold text-muted mb-1 small">Assinatura</label>
        <input type="date" class="form-control form-control-sm" id="new_assinatura" name="assinatura"
          onchange="rebuildNumeroTermoNovo()">
      </div>
      <div class="col-md-2">
        <label class="form-label fw-bold text-muted mb-1 small">Secretaria</label>
        <select class="form-select form-select-sm" id="new_celebracao_secretaria" name="celebracao_secretaria"
          onchange="rebuildNumeroTermoNovo()">
          ${['SMDHC','SMADS','SME'].map(o=>`<option value="${o}">${o}</option>`).join('')}
        </select>
      </div>

      ${sec('cash', 'Financeiro')}
      ${fld('Total Previsto', `<input type="text" class="form-control form-control-sm" id="new_total_previsto" name="total_previsto" placeholder="Ex: 454.998,56" onblur="formatarTotalPrevisto(this)">`, 4)}
      ${fld('Conta', `<input type="text" class="form-control form-control-sm" id="new_conta" name="conta" placeholder="Ex: 001 / 12345-6">`, 4)}
      <div class="col-md-4">
        <label class="form-label fw-bold text-muted mb-1 small">Lei</label>
        <select class="form-select form-select-sm" id="new_lei" name="lei">${opts(LEI_LIST,'')}</select>
      </div>

      ${sec('chat-left-text', 'Observações')}
      <div class="col-12">
        <textarea class="form-control form-control-sm" id="new_observacoes" name="observacoes" rows="3"></textarea>
      </div>
      <div class="col-12">
        <div class="alert alert-info py-2 mt-2 mb-0 small">
          <i class="bi bi-info-circle me-1"></i>
          Após criar, abra o registro para preencher <strong>Endereços de Execução</strong>, <strong>SEI de Documentos</strong> e <strong>Informações Adicionais</strong>.
        </div>
      </div>
    </div>
  </form>`;
}

function aoMudarStatusNovo(statusVal) {
  const sgEl = document.getElementById('new_status_generico');
  if (sgEl) sgEl.value = STATUS_GEN_MAP[statusVal] || '';
}

function calcularDataFinalNovo() {
  const inicioEl = document.getElementById('new_inicio');
  const mesesEl  = document.getElementById('new_meses');
  const diasEl   = document.getElementById('new_dias');
  const finalEl  = document.getElementById('new_final');
  if (!inicioEl || !finalEl || !inicioEl.value) { if (finalEl) finalEl.value = ''; return; }
  const meses = parseInt(mesesEl?.value) || 0;
  const dias  = parseInt(diasEl?.value)  || 0;
  if (meses === 0 && dias === 0) { finalEl.value = ''; return; }
  const d = new Date(inicioEl.value + 'T00:00:00');
  d.setMonth(d.getMonth() + meses);
  d.setDate(d.getDate() + dias - 1);
  finalEl.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function rebuildNumeroTermoNovo() {
  const tipo      = document.getElementById('new_tipo_termo')?.value || '';
  const numStr    = document.getElementById('new_numeracao_termo')?.value || '';
  const assin     = document.getElementById('new_assinatura')?.value || '';
  const secretaria = document.getElementById('new_celebracao_secretaria')?.value.trim() || '';
  const edital    = document.getElementById('new_edital_nome')?.value || '';
  const unidade   = document.getElementById('new_unidade_gestora')?.value.trim() || '';
  const campo     = document.getElementById('new_numero_termo');
  if (!campo) return;
  if (!tipo || !numStr || !assin || !secretaria) { campo.value = ''; return; }
  const prefixMap = { 'Acordo de Cooperação': 'ACP', 'Colaboração': 'TCL', 'Fomento': 'TFM' };
  const prefix = prefixMap[tipo] || tipo;
  const numInt = parseInt(numStr, 10);
  if (isNaN(numInt) || numInt < 1) { campo.value = ''; return; }
  const numPad = String(numInt).padStart(3, '0');
  const ano = assin.substring(0, 4);
  const editalUp = edital.toUpperCase();
  let ultimaParte = unidade;
  if (editalUp.includes('FUMCAD')) ultimaParte = 'FUMCAD';
  else if (editalUp.includes('FMID')) ultimaParte = 'FMID';
  campo.value = `${prefix}/${numPad}/${ano}/${secretaria}${ultimaParte ? '/' + ultimaParte : ''}`;
}

function sincronizarResponsaveisNovo() {
  const checks = document.querySelectorAll('.new-resp-check:checked');
  const hidden = document.getElementById('new_responsavel');
  if (hidden) hidden.value = Array.from(checks).map(cb => cb.value).filter(Boolean).join(';');
}

function buscarOSCporCNPJNovo() {
  const cnpjEl = document.getElementById('new_cnpj');
  const oscEl  = document.getElementById('new_osc');
  const resultDiv = document.getElementById('new_osc_lookup');
  if (!cnpjEl || !oscEl || !resultDiv) return;
  const cnpj = cnpjEl.value.trim();
  if (!cnpj) return;
  const re = /^\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}$/;
  if (!re.test(cnpj)) {
    resultDiv.style.display = '';
    resultDiv.innerHTML = '<span class="text-warning small"><i class="bi bi-exclamation-triangle-fill me-1"></i>CNPJ inválido.</span>';
    return;
  }
  resultDiv.style.display = '';
  resultDiv.innerHTML = '<span class="text-muted small"><span class="spinner-border spinner-border-sm me-1"></span>Buscando...</span>';
  fetch(`/celebracao-parcerias/cnpj-lookup?cnpj=${encodeURIComponent(cnpj)}`)
    .then(r => r.json())
    .then(data => {
      if (!data.success || !data.resultados.length) {
        resultDiv.innerHTML = '<span class="text-muted small">Nenhuma OSC encontrada.</span>';
        return;
      }
      if (data.resultados.length === 1) {
        oscEl.value = data.resultados[0];
        resultDiv.innerHTML = '<span class="text-success small"><i class="bi bi-check-circle me-1"></i>OSC preenchida.</span>';
        setTimeout(() => { resultDiv.style.display = 'none'; }, 2500);
        return;
      }
      const btns = data.resultados.map(nome =>
        `<button type="button" class="btn btn-outline-secondary btn-sm me-1 mb-1"
          onclick="document.getElementById('new_osc').value=this.dataset.nome; document.getElementById('new_osc_lookup').style.display='none';"
          data-nome="${nome.replace(/"/g,'&quot;')}">${nome}</button>`
      ).join('');
      resultDiv.innerHTML = `<div class="small text-muted mb-1">Escolha:</div>${btns}`;
    });
}

async function salvarNovaParc() {
  const form = document.getElementById('formNovaParc');
  if (!form) return;
  const btnSalvar = document.getElementById('btnSalvarNova');
  btnSalvar.disabled = true;
  btnSalvar.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Criando...';

  sincronizarResponsaveisNovo();

  // Validar campos obrigatórios
  const _reqNova = [
    { id: 'new_sei_celeb',   label: 'SEI Celebração' },
    { id: 'new_tipo_termo',  label: 'Tipo de Termo' },
    { id: 'new_edital_nome', label: 'Edital' },
    { id: 'new_cnpj',        label: 'CNPJ' },
    { id: 'new_osc',         label: 'OSC' },
    { id: 'new_responsavel', label: 'Responsável(eis)' },
    { id: 'new_projeto',     label: 'Projeto' },
    { id: 'new_status',      label: 'Status' },
  ];
  _reqNova.forEach(f => { const el = document.getElementById(f.id); if (el) el.style.borderColor = ''; });
  const _missingNova = _reqNova.filter(f => { const el = document.getElementById(f.id); return !el || !el.value.trim(); });
  if (_missingNova.length > 0) {
    _missingNova.forEach(f => { const el = document.getElementById(f.id); if (el) { el.style.borderColor = '#dc3545'; el.style.boxShadow = '0 0 0 0.2rem rgba(220,53,69,.25)'; } });
    btnSalvar.disabled = false;
    btnSalvar.innerHTML = '<i class="bi bi-plus-circle me-1"></i> Criar Parceria';
    document.getElementById('novaParcConteudo').insertAdjacentHTML('afterbegin', `
      <div class="alert alert-danger alert-dismissible mb-3" role="alert">
        <i class="bi bi-x-circle me-1"></i> Campos obrigatórios: <strong>${_missingNova.map(f => f.label).join(', ')}</strong>.
        <button class="btn-close" data-bs-dismiss="alert"></button>
      </div>`);
    document.getElementById(_missingNova[0].id)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    return;
  }

  const data = {};
  form.querySelectorAll('input, select, textarea').forEach(el => { if (el.name) data[el.name] = el.value; });
  if (data.total_previsto) data.total_previsto = data.total_previsto.replace(/\./g,'').replace(',','.');

  fetch('/celebracao-parcerias/criar', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
    .then(r => r.json())
    .then(res => {
      if (res.success) {
        document.getElementById('novaParcConteudo').insertAdjacentHTML('afterbegin', `
          <div class="alert alert-success alert-dismissible mb-3" role="alert">
            <i class="bi bi-check-circle me-1"></i> ${res.mensagem}
            <button class="btn-close" data-bs-dismiss="alert"></button>
          </div>`);
        setTimeout(() => window.location.reload(), 1500);
      } else {
        document.getElementById('novaParcConteudo').insertAdjacentHTML('afterbegin', `
          <div class="alert alert-danger alert-dismissible mb-3" role="alert">
            <i class="bi bi-exclamation-circle me-1"></i> Erro: ${res.erro}
            <button class="btn-close" data-bs-dismiss="alert"></button>
          </div>`);
        btnSalvar.disabled = false;
        btnSalvar.innerHTML = '<i class="bi bi-plus-circle me-1"></i> Criar Parceria';
      }
    })
    .catch(err => {
      btnSalvar.disabled = false;
      btnSalvar.innerHTML = '<i class="bi bi-plus-circle me-1"></i> Criar Parceria';
      alert('Erro: ' + err);
    });
}

// ── Número do Termo (editar) ──────────────────────────────────────────────
function rebuildNumeroTermo() {
  const tipo      = document.getElementById('edit_tipo_termo')?.value || '';
  const numStr    = document.getElementById('edit_numeracao_termo')?.value || '';
  const assin     = document.getElementById('edit_assinatura')?.value || '';
  const secretaria = document.getElementById('edit_celebracao_secretaria')?.value.trim() || '';
  const edital    = document.getElementById('edit_edital_nome')?.value || '';
  const unidade   = document.getElementById('edit_unidade_gestora')?.value.trim() || '';
  const campo     = document.getElementById('edit_numero_termo');
  if (!campo) return;

  if (!tipo || !numStr || !assin || !secretaria) {
    campo.value = '';
    return;
  }

  const prefixMap = { 'Acordo de Cooperação': 'ACP', 'Colaboração': 'TCL', 'Fomento': 'TFM' };
  const prefix = prefixMap[tipo] || tipo;

  const numInt = parseInt(numStr, 10);
  if (isNaN(numInt) || numInt < 1) { campo.value = ''; return; }
  const numPad = String(numInt).padStart(3, '0');

  const ano = assin.substring(0, 4);

  const editalUp = edital.toUpperCase();
  let ultimaParte = unidade;
  if (editalUp.includes('FUMCAD')) ultimaParte = 'FUMCAD';
  else if (editalUp.includes('FMID')) ultimaParte = 'FMID';

  campo.value = `${prefix}/${numPad}/${ano}/${secretaria}${ultimaParte ? '/' + ultimaParte : ''}`;
}




// ── Autocomplete ──────────────────────────────────────────────────────────
let autocompleteTimeout = null;

document.querySelectorAll('.autocomplete-input').forEach(input => {
  input.addEventListener('input', function() {
    const campo = this.dataset.campo;
    const valor = this.value.trim();

    // Remover dropdown anterior
    const existente = this.parentElement.querySelector('.autocomplete-list');
    if (existente) existente.remove();

    if (valor.length < 2) return;

    clearTimeout(autocompleteTimeout);
    autocompleteTimeout = setTimeout(() => {
      fetch(`/celebracao-parcerias/sugestoes/${campo}?q=${encodeURIComponent(valor)}`)
        .then(r => r.json())
        .then(data => {
          if (!data.success || data.valores.length === 0) return;

          const lista = document.createElement('div');
          lista.className = 'autocomplete-list';

          data.valores.forEach(v => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item';
            item.textContent = v;
            item.addEventListener('click', () => {
              input.value = v;
              lista.remove();
            });
            lista.appendChild(item);
          });

          input.parentElement.appendChild(lista);
        })
        .catch(() => {});
    }, 300);
  });

  // Fechar dropdown ao sair do campo
  input.addEventListener('blur', function() {
    setTimeout(() => {
      const existente = this.parentElement.querySelector('.autocomplete-list');
      if (existente) existente.remove();
    }, 200);
  });
});


// ── Visualização Geral (admin) ────────────────────────────────────────────
function abrirVisualizacaoGeral() {
  const modal = new bootstrap.Modal(document.getElementById('modalVisualizacao'));
  const container = document.getElementById('listaVisualizacao');

  container.innerHTML = `
    <div class="text-center py-3">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Carregando...</span>
      </div>
    </div>`;

  modal.show();

  fetch('/celebracao-parcerias/visualizacao-geral')
    .then(r => r.json())
    .then(data => {
      if (!data.success) {
        container.innerHTML = `<div class="alert alert-danger">${data.erro}</div>`;
        return;
      }

      if (data.analistas.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">Nenhum analista DGP cadastrado.</div>';
        return;
      }

      let html = '<div class="list-group">';
      data.analistas.forEach(a => {
        const checked = a.visualizacao_geral ? 'checked' : '';
        const statusBadge = a.status === 'Ativo'
          ? '<span class="badge bg-success ms-2">Ativo</span>'
          : '<span class="badge bg-secondary ms-2">Inativo</span>';

        html += `
          <label class="list-group-item d-flex align-items-center gap-3" style="cursor:pointer;">
            <input type="checkbox" class="form-check-input flex-shrink-0"
                   data-analista-id="${a.id}" ${checked}
                   style="width:1.2em; height:1.2em;">
            <div>
              <strong>${a.nome_analista}</strong>
              ${statusBadge}
              <br><small class="text-muted">RF: ${a.rf || '-'}</small>
            </div>
          </label>`;
      });
      html += '</div>';

      container.innerHTML = html;
    })
    .catch(err => {
      container.innerHTML = `<div class="alert alert-danger">Erro: ${err}</div>`;
    });
}

function salvarVisualizacaoGeral() {
  const checkboxes = document.querySelectorAll('#listaVisualizacao input[type="checkbox"]');
  const analistas = [];

  checkboxes.forEach(cb => {
    analistas.push({
      id: parseInt(cb.dataset.analistaId),
      visualizacao_geral: cb.checked
    });
  });

  fetch('/celebracao-parcerias/visualizacao-geral', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ analistas })
  })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        alert('Visualização geral atualizada com sucesso!');
        bootstrap.Modal.getInstance(document.getElementById('modalVisualizacao')).hide();
      } else {
        alert('Erro: ' + data.erro);
      }
    })
    .catch(err => alert('Erro: ' + err));
}

// ── Contatos da OSC ─────────────────────────────────────────────────────────
let _contatosOscAtual = '';

function abrirContatosOSC(osc) {
  if (!osc) return;
  _contatosOscAtual = osc;
  document.getElementById('modalContatosOscTitulo').textContent = osc;
  document.getElementById('contatosOscLista').innerHTML =
    '<div class="text-muted small text-center py-3"><span class="spinner-border spinner-border-sm me-1"></span>Carregando...</div>';
  document.getElementById('formNovoContatoCeleb').style.display = 'none';
  document.getElementById('formEditarContatoCeleb').style.display = 'none';
  document.getElementById('btnMostrarFormNovoContato').style.display = '';
  const modal = new bootstrap.Modal(document.getElementById('modalContatosOsc'));
  modal.show();
  carregarContatosCeleb(osc);
}

async function carregarContatosCeleb(osc) {
  try {
    const res = await fetch(`/parcerias/contatos/${encodeURIComponent(osc)}`);
    const d = await res.json();
    const lista = document.getElementById('contatosOscLista');
    if (!d.contatos || d.contatos.length === 0) {
      lista.innerHTML = '<p class="text-muted small text-center py-2">Nenhum contato cadastrado.</p>';
      return;
    }
    lista.innerHTML = d.contatos.map(c => `
      <div class="border rounded p-2 mb-2 ${c.status === 'Inativo' ? 'opacity-50' : ''}">
        <div class="d-flex justify-content-between align-items-start gap-2">
          <div class="flex-grow-1">
            <strong>${c.contato_nome || '—'}</strong>
            ${c.contato_posicao ? `<span class="text-muted small ms-1">· ${c.contato_posicao}</span>` : ''}
            <br>
            <span class="badge bg-secondary me-1">${c.contato_tipo || '—'}</span>
            <span class="small">${c.contato_info || '—'}</span>
            ${c.observacao ? `<br><span class="text-muted small fst-italic">${c.observacao}</span>` : ''}
          </div>
          <div class="d-flex gap-1 flex-shrink-0">
            <button class="btn btn-sm btn-outline-primary" style="padding:1px 6px;" onclick="editarContatoCeleb(${c.id},'${(c.contato_nome||'').replace(/'/g,"\\'")}','${(c.contato_posicao||'').replace(/'/g,"\\'")}','${(c.contato_tipo||'').replace(/'/g,"\\'")}','${(c.contato_info||'').replace(/'/g,"\\'")}','${c.status||''}','${(c.observacao||'').replace(/'/g,"\\'")}')">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" style="padding:1px 6px;" onclick="deletarContatoCeleb(${c.id})">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      </div>`).join('');
  } catch (err) {
    document.getElementById('contatosOscLista').innerHTML =
      '<div class="alert alert-danger py-1 small">Erro ao carregar contatos.</div>';
  }
}

function editarContatoCeleb(id, nome, posicao, tipo, info, status, obs) {
  document.getElementById('formNovoContatoCeleb').style.display = 'none';
  const frm = document.getElementById('formEditarContatoCeleb');
  frm.style.display = '';
  frm.dataset.id = id;
  document.getElementById('ec_nome').value = nome;
  document.getElementById('ec_posicao').value = posicao;
  document.getElementById('ec_tipo').value = tipo;
  document.getElementById('ec_info').value = info;
  document.getElementById('ec_status').value = status;
  document.getElementById('ec_obs').value = obs;
}

async function salvarEditarContatoCeleb() {
  const frm = document.getElementById('formEditarContatoCeleb');
  const id = frm.dataset.id;
  const body = {
    contato_nome: document.getElementById('ec_nome').value.trim(),
    contato_posicao: document.getElementById('ec_posicao').value.trim(),
    contato_tipo: document.getElementById('ec_tipo').value,
    contato_info: document.getElementById('ec_info').value.trim(),
    status: document.getElementById('ec_status').value,
    observacao: document.getElementById('ec_obs').value.trim()
  };
  if (!body.contato_nome) { alert('Informe o nome do contato.'); return; }
  try {
    const res = await fetch(`/parcerias/contatos/editar/${id}`, {
      method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)
    });
    const d = await res.json();
    if (res.ok) {
      frm.style.display = 'none';
      carregarContatosCeleb(_contatosOscAtual);
    } else { alert(d.error || d.erro || 'Erro ao salvar.'); }
  } catch (err) { alert('Erro: ' + err); }
}

async function deletarContatoCeleb(id) {
  if (!confirm('Excluir este contato?')) return;
  try {
    const res = await fetch(`/parcerias/contatos/deletar/${id}`, { method: 'POST' });
    const d = await res.json();
    if (res.ok) carregarContatosCeleb(_contatosOscAtual);
    else alert(d.error || d.erro || 'Erro ao excluir.');
  } catch (err) { alert('Erro: ' + err); }
}

async function salvarNovoContatoCeleb() {
  const body = {
    osc: _contatosOscAtual,
    contatos: [{
      nome: document.getElementById('nc_nome').value.trim(),
      posicao: document.getElementById('nc_posicao').value.trim(),
      tipo: document.getElementById('nc_tipo').value,
      info: document.getElementById('nc_info').value.trim(),
      status: document.getElementById('nc_status').value,
      observacao: document.getElementById('nc_obs').value.trim()
    }]
  };
  if (!body.contatos[0].nome) { alert('Informe o nome do contato.'); return; }
  try {
    const res = await fetch('/parcerias/contatos/criar', {
      method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)
    });
    const d = await res.json();
    if (res.ok) {
      document.getElementById('formNovoContatoCeleb').style.display = 'none';
      document.getElementById('btnMostrarFormNovoContato').style.display = '';
      ['nc_nome','nc_posicao','nc_info','nc_obs'].forEach(id => document.getElementById(id).value = '');
      document.getElementById('nc_tipo').value = 'E-mail';
      document.getElementById('nc_status').value = 'Ativo';
      carregarContatosCeleb(_contatosOscAtual);
    } else { alert(d.error || d.erro || 'Erro ao criar contato.'); }
  } catch (err) { alert('Erro: ' + err); }
}

</script>

<!-- Modal: Contatos da OSC -->
<div class="modal fade" id="modalContatosOsc" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h5 class="modal-title"><i class="bi bi-person-lines-fill me-2 text-secondary"></i><span id="modalContatosOscTitulo"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="contatosOscLista"></div>

        <!-- Form: Editar contato -->
        <div id="formEditarContatoCeleb" style="display:none;" class="border rounded p-3 mb-3 bg-light">
          <h6 class="text-primary fw-bold mb-3"><i class="bi bi-pencil me-1"></i>Editar Contato</h6>
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label small fw-bold mb-1">Nome *</label>
              <input type="text" class="form-control form-control-sm" id="ec_nome">
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold mb-1">Posição/Cargo</label>
              <input type="text" class="form-control form-control-sm" id="ec_posicao">
            </div>
            <div class="col-md-4">
              <label class="form-label small fw-bold mb-1">Tipo</label>
              <select class="form-select form-select-sm" id="ec_tipo">
                <option>E-mail</option><option>Telefone Fixo</option><option>Telefone Celular</option>
                <option>WhatsApp</option><option>Outro</option>
              </select>
            </div>
            <div class="col-md-5">
              <label class="form-label small fw-bold mb-1">Informação</label>
              <input type="text" class="form-control form-control-sm" id="ec_info">
            </div>
            <div class="col-md-3">
              <label class="form-label small fw-bold mb-1">Status</label>
              <select class="form-select form-select-sm" id="ec_status">
                <option>Ativo</option><option>Inativo</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label small fw-bold mb-1">Observação</label>
              <input type="text" class="form-control form-control-sm" id="ec_obs">
            </div>
          </div>
          <div class="mt-3 d-flex gap-2">
            <button class="btn btn-sm btn-primary" onclick="salvarEditarContatoCeleb()"><i class="bi bi-check-lg me-1"></i>Salvar</button>
            <button class="btn btn-sm btn-secondary" onclick="document.getElementById('formEditarContatoCeleb').style.display='none'">Cancelar</button>
          </div>
        </div>

        <!-- Botão: Mostrar form novo contato -->
        <button id="btnMostrarFormNovoContato" class="btn btn-sm btn-outline-success w-100 mt-2"
          onclick="this.style.display='none'; document.getElementById('formNovoContatoCeleb').style.display='';">
          <i class="bi bi-plus-circle me-1"></i>Adicionar Contato
        </button>

        <!-- Form: Novo contato -->
        <div id="formNovoContatoCeleb" style="display:none;" class="border rounded p-3 mt-2 bg-light">
          <h6 class="text-success fw-bold mb-3"><i class="bi bi-plus-circle me-1"></i>Novo Contato</h6>
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label small fw-bold mb-1">Nome *</label>
              <input type="text" class="form-control form-control-sm" id="nc_nome">
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold mb-1">Posição/Cargo</label>
              <input type="text" class="form-control form-control-sm" id="nc_posicao">
            </div>
            <div class="col-md-4">
              <label class="form-label small fw-bold mb-1">Tipo</label>
              <select class="form-select form-select-sm" id="nc_tipo">
                <option>E-mail</option><option>Telefone Fixo</option><option>Telefone Celular</option>
                <option>WhatsApp</option><option>Outro</option>
              </select>
            </div>
            <div class="col-md-5">
              <label class="form-label small fw-bold mb-1">Informação</label>
              <input type="text" class="form-control form-control-sm" id="nc_info">
            </div>
            <div class="col-md-3">
              <label class="form-label small fw-bold mb-1">Status</label>
              <select class="form-select form-select-sm" id="nc_status">
                <option>Ativo</option><option>Inativo</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label small fw-bold mb-1">Observação</label>
              <input type="text" class="form-control form-control-sm" id="nc_obs">
            </div>
          </div>
          <div class="mt-3 d-flex gap-2">
            <button class="btn btn-sm btn-success" onclick="salvarNovoContatoCeleb()"><i class="bi bi-check-lg me-1"></i>Salvar</button>
            <button class="btn btn-sm btn-secondary" onclick="document.getElementById('formNovoContatoCeleb').style.display='none'; document.getElementById('btnMostrarFormNovoContato').style.display='';">Cancelar</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
