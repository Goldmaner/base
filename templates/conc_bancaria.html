<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Concilia√ß√£o Banc√°ria - An√°lise PC - FAF</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<style>
    .conc-card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .table-conc {
        font-size: 0.9rem;
        border-collapse: collapse;
        margin-bottom: 0;
        width: 100%;
    }
    
    .table-conc thead th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 600;
        padding: 12px 8px;
        border: none;
        text-align: center;
        vertical-align: middle;
    }
    
    .table-conc tbody td {
        padding: 8px;
        vertical-align: middle;
        border: 1px solid #dee2e6;
    }
    
    .table-conc tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    /* C√©lulas de entrada */
    .cell-input {
        width: 100%;
        border: none;
        padding: 6px;
        text-align: center;
        background: transparent;
    }
    
    .cell-input:focus {
        outline: 2px solid #667eea;
        background: #f0f4ff;
    }
    
    /* C√©lulas monet√°rias */
    .cell-money {
        text-align: right;
        font-family: 'Courier New', monospace;
        font-weight: 600;
    }
    
    /* Input de compet√™ncia com erro */
    .competencia-input.is-invalid {
        border-color: #dc3545;
        padding-right: calc(1.5em + 0.75rem);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }
    
    .invalid-feedback {
        font-size: 0.75rem;
        color: #dc3545;
        margin-top: 0.25rem;
    }
    
    /* C√©lulas mescladas */
    .cell-merged {
        background: linear-gradient(to bottom, #fff 0%, #f0f4ff 100%);
        border-left: 3px solid #667eea !important;
        position: relative;
    }
    
    .cell-merged::before {
        content: '‚Üï';
        position: absolute;
        left: 2px;
        top: 50%;
        transform: translateY(-50%);
        color: #667eea;
        font-size: 12px;
    }
    
    /* Bot√µes de a√ß√£o */
    .btn-action {
        padding: 4px 8px;
        font-size: 0.85rem;
    }
    
    .btn-move {
        padding: 2px 6px;
        font-size: 0.75rem;
    }
    
    /* Container com scroll */
    .table-container {
        max-height: calc(100vh - 250px);
        overflow-y: auto;
        overflow-x: auto;
        border: 1px solid #dee2e6;
        border-radius: 8px;
    }
    
    /* Bot√£o save no menu superior */
    .btn-save-top {
        min-width: 200px;
    }
    
    /* Headers clic√°veis com √≠cone de info */
    .tooltip-header {
        cursor: pointer;
        position: relative;
    }
    
    .tooltip-header .info-icon {
        color: #667eea;
        font-size: 0.9rem;
        margin-left: 5px;
    }
    
    .tooltip-header:hover .info-icon {
        color: #4c63d2;
    }
    
    /* Garantir que thead n√£o cubra modais */
    .table-conc thead {
        position: relative;
        z-index: 1;
    }
    
    .table-conc thead th {
        position: relative;
        z-index: 1;
    }
    
    /* C√©lulas mescladas verticalmente */
    .cell-merged-group {
        border-left: 4px solid #667eea !important;
        background: linear-gradient(to right, #f0f4ff 0%, #fff 10%);
    }
    
    .cell-merged-first {
        border-top: 2px solid #667eea !important;
    }
    
    .cell-merged-last {
        border-bottom: 2px solid #667eea !important;
    }
    
    .merged-cell-content {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
    }
    
    .merged-indicator {
        font-size: 0.75rem;
        color: #667eea;
        margin-left: 5px;
    }
    
    /* Loading indicator */
    .loading {
        display: none;
        text-align: center;
        padding: 20px;
    }
    
    /* Cores das linhas baseado na avalia√ß√£o */
    .avaliacao-avaliado td {
        background-color: #c6efce !important;
    }
    
    .avaliacao-aguardando td {
        background-color: #f2ceef !important;
    }
    
    .avaliacao-pessoa-gestora td {
        background-color: #c0e4f5 !important;
    }
    
    .avaliacao-glosar td {
        background-color: #fbe2d5 !important;
    }
    
    /* Linha de separa√ß√£o entre meses */
    tr.mudanca-mes {
        border-top: 4px solid #007bff !important;
    }
    
    /* C√©lula desabilitada - Seletor mais espec√≠fico para sobrepor cores de avalia√ß√£o */
    td.cell-disabled,
    .avaliacao-avaliado td.cell-disabled,
    .avaliacao-aguardando td.cell-disabled,
    .avaliacao-pessoa-gestora td.cell-disabled,
    .avaliacao-glosar td.cell-disabled {
        background-color: #e9ecef !important;
        cursor: not-allowed;
    }
    
    /* Valida√ß√£o de composi√ß√£o - composi√ß√£o diferente do valor */
    td.composicao-invalida input {
        background-color: #ffcccc !important;
        border: 2px solid #ff0000 !important;
    }
    
    /* Valida√ß√£o de CNPJ - laranja se n√£o tiver 14 d√≠gitos */
    td.cnpj-invalido input {
        background-color: #ffe0b3 !important;
        border: 2px solid #ff9800 !important;
    }
    
    /* Cabe√ßalhos das colunas de Notas Fiscais */
    .table-conc thead th.th-notas-fiscais {
        background: linear-gradient(135deg, #5a3e8c 0%, #3d2861 100%);
    }
    
    /* Cabe√ßalhos das colunas de Documentos */
    .table-conc thead th.th-documentos {
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
    }
    
    /* Indicador de autosave fixo */
    #autosaveStatus {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1050;
        padding: 8px 15px;
        background-color: #28a745;
        color: white;
        border-radius: 5px;
        font-size: 0.85rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        display: none;
    }
</style>
</head>
<body>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-bank me-2"></i>Concilia√ß√£o Banc√°ria</h2>
        <div>
            <button class="btn btn-outline-primary me-2" id="btnMenuSecoes" onclick="toggleMenuSecoes()">
                <i class="bi bi-list-check me-2"></i>Se√ß√µes
            </button>
            <button class="btn btn-outline-warning me-2" id="btnUndo" onclick="desfazerAlteracao()" style="display: none;">
                <i class="bi bi-arrow-counterclockwise me-1"></i>Desfazer
            </button>
            <div class="btn-group me-2">
                <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-pencil-square me-1"></i>Adicionar ou Excluir Linhas
                </button>
                <ul class="dropdown-menu p-3" style="min-width: 320px;">
                    <!-- Adicionar Linhas -->
                    <li>
                        <h6 class="dropdown-header text-primary"><i class="bi bi-plus-circle"></i> Adicionar Linhas</h6>
                    </li>
                    <li class="px-2 mb-3">
                        <div class="input-group input-group-sm">
                            <input type="number" 
                                   class="form-control" 
                                   id="inputAdicionarLinhas" 
                                   placeholder="Quantidade"
                                   min="1"
                                   value="1">
                            <button class="btn btn-primary" onclick="adicionarLinhasEmLote()">
                                <i class="bi bi-plus-lg me-1"></i>Adicionar
                            </button>
                        </div>
                        <small class="text-muted d-block mt-1">Adiciona linhas vazias no final</small>
                    </li>
                    
                    <li><hr class="dropdown-divider"></li>
                    
                    <!-- Excluir Linhas -->
                    <li>
                        <h6 class="dropdown-header text-danger"><i class="bi bi-trash"></i> Excluir Linhas</h6>
                    </li>
                    <li class="px-2">
                        <div class="input-group input-group-sm">
                            <input type="text" 
                                   class="form-control" 
                                   id="inputExcluirLinhas" 
                                   placeholder="Ex: 114-120 ou 5,10,15">
                            <button class="btn btn-danger" onclick="excluirLinhasPorIntervalo()">
                                <i class="bi bi-trash me-1"></i>Excluir
                            </button>
                        </div>
                        <small class="text-muted d-block mt-1">Use intervalos (1-5) ou √≠ndices (2,4,6)</small>
                    </li>
                </ul>
            </div>
            <button class="btn btn-success me-2" onclick="exportarCSV()">
                <i class="bi bi-download me-2"></i>Exportar CSV
            </button>
            <button class="btn btn-danger me-2" onclick="abrirModalPDF()" data-bs-toggle="modal" data-bs-target="#modalExportarPDF">
                <i class="bi bi-file-pdf me-2"></i>Exportar PDF
            </button>
            <button class="btn btn-info me-2" onclick="baixarModelo()">
                <i class="bi bi-file-earmark-arrow-down me-2"></i>Modelo Importa√ß√£o
            </button>
            <button class="btn btn-outline-danger me-2" onclick="limparTabela()">
                <i class="bi bi-trash me-2"></i>Limpar
            </button>
            <a href="/analises_pc" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Voltar
            </a>
        </div>
    </div>

    <!-- Sele√ß√£o de Termo -->
    <div class="conc-card">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="numeroTermo" class="form-label"><strong>N√∫mero do Termo</strong></label>
                <select class="form-select" id="numeroTermo" onchange="carregarExtrato()">
                    <option value="">Selecione um termo...</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="bancoExtrato" class="form-label"><strong>Banco do Extrato</strong></label>
                <select class="form-select" id="bancoExtrato">
                    <option value="">Selecione o banco...</option>
                    <option value="Banco do Brasil">Banco do Brasil</option>
                    <option value="Ita√∫ Unibanco">Ita√∫ Unibanco</option>
                    <option value="Bradesco">Bradesco</option>
                    <option value="Caixa Econ√¥mica Federal">Caixa Econ√¥mica Federal</option>
                    <option value="Santander">Santander</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label"><strong>Mostrar Linhas</strong></label>
                <div class="btn-group w-100" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="setLimite(100)">100</button>
                    <button type="button" class="btn btn-outline-primary" onclick="setLimite(200)">200</button>
                    <button type="button" class="btn btn-outline-primary" onclick="setLimite('todas')">Todas</button>
                </div>
            </div>
            <div class="col-md-1">
                <button class="btn btn-outline-info w-100" onclick="toggleFiltros()" id="btnToggleFiltros">
                    <i class="bi bi-funnel me-1"></i>Filtros
                </button>
            </div>
            <div class="col-md-1">
                <button class="btn btn-primary w-100 btn-save-top" onclick="salvarConciliacao()" id="btnSalvar" style="display: none;">
                    <i class="bi bi-save me-2"></i>Salvar
                </button>
            </div>
            <div class="col-md-1">
                <button class="btn btn-outline-secondary w-100" onclick="irParaUltimaLinha()" title="Ir para a √∫ltima linha">
                    <i class="bi bi-arrow-down-circle"></i>
                </button>
            </div>
            <div class="col-md-1">
                <button class="btn btn-outline-secondary w-100" onclick="renderizarTabela()" title="Atualizar visualiza√ß√£o">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Menu de Se√ß√µes -->
    <div class="conc-card" id="menuSecoes" style="display: none;">
        <h5 class="mb-3"><i class="bi bi-list-check me-2"></i>Se√ß√µes Dispon√≠veis</h5>
        <div class="row g-3">
            <div class="col-md-6">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="secaoExtrato" checked disabled>
                    <label class="form-check-label" for="secaoExtrato">
                        <strong>1. Concilia√ß√£o do Extrato</strong> (10 colunas) - Sempre vis√≠vel
                    </label>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="secaoNotasFiscais" onchange="toggleSecaoNotasFiscais()">
                    <label class="form-check-label" for="secaoNotasFiscais">
                        <strong>2. Notas Fiscais</strong> (3 colunas) - N√∫mero, Chave de Acesso, CNPJ
                    </label>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="secaoDocumentos" onchange="toggleSecaoDocumentos()">
                    <label class="form-check-label" for="secaoDocumentos">
                        <strong>3. Documentos a serem avaliados</strong> (4 colunas) - Guia, Comprovante, Contratos, Fora Munic√≠pio
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros Avan√ßados -->
    <div class="conc-card" id="filtrosAvancados" style="display: none;">
        <div class="row g-3">
            <div class="col-md-2">
                <label for="filtroData" class="form-label"><strong><i class="bi bi-funnel me-1"></i>Filtrar por Data (M√™s/Ano)</strong></label>
                <select class="form-select" id="filtroData" multiple size="4" onchange="aplicarFiltros()">
                    <option value="">Todas as datas</option>
                    <option value="__NAO_PREENCHIDO__" style="color: #dc3545; font-style: italic;">‚ùå N√£o preenchido</option>
                </select>
                <small class="text-muted">Ctrl+Click para m√∫ltipla sele√ß√£o</small>
            </div>
            <div class="col-md-2">
                <label for="filtroCompetencia" class="form-label"><strong><i class="bi bi-funnel me-1"></i>Filtrar por Compet√™ncia</strong></label>
                <select class="form-select" id="filtroCompetencia" multiple size="4" onchange="aplicarFiltros()">
                    <option value="">Todas as compet√™ncias</option>
                    <option value="__NAO_PREENCHIDO__" style="color: #dc3545; font-style: italic;">‚ùå N√£o preenchido</option>
                </select>
                <small class="text-muted">Ctrl+Click para m√∫ltipla sele√ß√£o</small>
            </div>
            <div class="col-md-3">
                <label for="filtroCategoria" class="form-label"><strong><i class="bi bi-funnel me-1"></i>Filtrar por Categoria</strong></label>
                <select class="form-select" id="filtroCategoria" multiple size="4" onchange="aplicarFiltros()">
                    <option value="">Todas as categorias</option>
                    <option value="__NAO_PREENCHIDO__" style="color: #dc3545; font-style: italic;">‚ùå N√£o preenchido</option>
                </select>
                <small class="text-muted">Ctrl+Click para m√∫ltipla sele√ß√£o</small>
            </div>
            <div class="col-md-2">
                <label for="filtroOrigemDestino" class="form-label"><strong><i class="bi bi-funnel me-1"></i>Filtrar por Origem/Destino</strong></label>
                <select class="form-select" id="filtroOrigemDestino" multiple size="4" onchange="aplicarFiltros()">
                    <option value="">Todas as origens/destinos</option>
                    <option value="__NAO_PREENCHIDO__" style="color: #dc3545; font-style: italic;">‚ùå N√£o preenchido</option>
                </select>
                <small class="text-muted">Ctrl+Click para m√∫ltipla sele√ß√£o</small>
            </div>
            <div class="col-md-2">
                <label for="filtroAvaliacao" class="form-label"><strong><i class="bi bi-funnel me-1"></i>Filtrar por Avalia√ß√£o</strong></label>
                <select class="form-select" id="filtroAvaliacao" multiple size="4" onchange="aplicarFiltros()">
                    <option value="">Todas as avalia√ß√µes</option>
                    <option value="__NAO_PREENCHIDO__" style="color: #dc3545; font-style: italic;">‚ùå N√£o preenchido</option>
                    <option value="Avaliado">Avaliado</option>
                    <option value="Aguardando resposta">Aguardando resposta</option>
                    <option value="Pessoa Gestora">Pessoa Gestora</option>
                    <option value="Glosar">Glosar</option>
                </select>
                <small class="text-muted">Ctrl+Click para m√∫ltipla sele√ß√£o</small>
            </div>
            <div class="col-md-1 d-flex flex-column justify-content-end">
                <button class="btn btn-secondary mb-2" onclick="limparFiltros()">
                    <i class="bi bi-x-circle me-1"></i>Limpar
                </button>
                <button class="btn btn-outline-primary" onclick="expandirFiltros()" title="Expandir filtros">
                    <i class="bi bi-arrows-angle-expand"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div class="loading" id="loadingIndicator">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
        <p class="mt-2">Carregando dados...</p>
    </div>

    <!-- Tabela de Concilia√ß√£o -->
    <div class="conc-card">
        <div class="table-container">
            <table class="table table-conc table-sm" id="tabelaConciliacao">
                <thead>
                    <tr>
                        <th style="width: 60px;" class="tooltip-header" onclick="mostrarInfo('indice')">
                            1. √çndice <i class="bi bi-info-circle info-icon"></i>
                        </th>
                        <th style="width: 140px;" class="tooltip-header" onclick="mostrarInfo('data')">
                            2. Data <i class="bi bi-info-circle info-icon"></i>
                        </th>
                        <th style="width: 140px;" class="tooltip-header" onclick="mostrarInfo('credito')">
                            3. Cr√©dito (R$) <i class="bi bi-info-circle info-icon"></i>
                        </th>
                        <th style="width: 140px;" class="tooltip-header" onclick="mostrarInfo('debito')">
                            4. D√©bito (R$) <i class="bi bi-info-circle info-icon"></i>
                        </th>
                        <th style="width: 150px;" class="tooltip-header" onclick="mostrarInfo('composicao')">
                            5. Composi√ß√£o do Valor (R$) <i class="bi bi-info-circle info-icon"></i>
                        </th>
                        <th style="width: 260px;" class="tooltip-header" onclick="mostrarInfo('categoria')">
                            6. Categoria de Transa√ß√£o <i class="bi bi-info-circle info-icon"></i>
                        </th>
                        <th style="width: 130px;" class="tooltip-header" onclick="mostrarInfo('competencia')">
                            7. Compet√™ncia <i class="bi bi-info-circle info-icon"></i>
                        </th>
                        <th style="width: 240px;" class="tooltip-header" onclick="mostrarInfo('origem_destino')">
                            8. Origem ou Destino <i class="bi bi-info-circle info-icon"></i>
                        </th>
                        <th style="width: 180px;" class="tooltip-header" onclick="mostrarInfo('avaliacao')">
                            9. Avalia√ß√£o <i class="bi bi-info-circle info-icon"></i>
                        </th>
                        <th style="width: 250px;" class="tooltip-header" onclick="mostrarInfo('observacoes')">
                            10. Observa√ß√µes <i class="bi bi-info-circle info-icon"></i>
                        </th>
                        <th style="width: 180px;">A√ß√µes</th>
                        <!-- Colunas de Notas Fiscais (Se√ß√£o 2) -->
                        <th style="width: 150px; display: none;" class="th-notas-fiscais col-nf" id="thNumeroNota">
                            11. N√∫mero da Nota
                        </th>
                        <th style="width: 250px; display: none;" class="th-notas-fiscais col-nf" id="thChaveAcesso">
                            12. Chave de Acesso
                        </th>
                        <th style="width: 180px; display: none;" class="th-notas-fiscais col-nf" id="thCnpjNota">
                            13. CNPJ
                        </th>
                        <!-- Colunas de Documentos (Se√ß√£o 3) -->
                        <th style="width: 100px; display: none;" class="th-documentos col-doc tooltip-header" id="thGuia" onclick="mostrarInfo('guia')">
                            14. Guia <i class="bi bi-info-circle info-icon"></i>
                        </th>
                        <th style="width: 150px; display: none;" class="th-documentos col-doc tooltip-header" id="thComprovante" onclick="mostrarInfo('comprovante')">
                            15. Comprovante <i class="bi bi-info-circle info-icon"></i>
                        </th>
                        <th style="width: 120px; display: none;" class="th-documentos col-doc tooltip-header" id="thContratos" onclick="mostrarInfo('contratos')">
                            16. Contratos <i class="bi bi-info-circle info-icon"></i>
                        </th>
                        <th style="width: 150px; display: none;" class="th-documentos col-doc tooltip-header" id="thForaMunicipio" onclick="mostrarInfo('fora_municipio')">
                            17. Fora Munic√≠pio <i class="bi bi-info-circle info-icon"></i>
                        </th>
                    </tr>
                </thead>
                <tbody id="tbodyConciliacao">
                    <!-- Linhas ser√£o inseridas via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Datalist para Origem/Destino (auto-alimentado) -->
<datalist id="datalistOrigemDestino">
</datalist>

<!-- Datalist para Avalia√ß√µes -->
<datalist id="datalistAvaliacoes">
    <option value="Avaliado">Avaliado</option>
    <option value="Aguardando resposta">Aguardando resposta</option>
    <option value="Pessoa Gestora">Pessoa Gestora</option>
    <option value="Glosar">Glosar</option>
</datalist>

<!-- Modal de Informa√ß√£o -->
<div class="modal fade" id="modalInfo" tabindex="-1" aria-labelledby="modalInfoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalInfoLabel">
                    <i class="bi bi-info-circle me-2"></i>Informa√ß√£o
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body" id="modalInfoBody">
                <!-- Conte√∫do ser√° inserido via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Exporta√ß√£o PDF -->
<div class="modal fade" id="modalExportarPDF" tabindex="-1" aria-labelledby="modalExportarPDFLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalExportarPDFLabel">
                    <i class="bi bi-file-pdf me-2"></i>Exportar para PDF
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3"><strong>Selecione as colunas que deseja incluir na exporta√ß√£o:</strong></p>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="indice" id="checkIndice" checked>
                            <label class="form-check-label" for="checkIndice">1. √çndice</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="data" id="checkData" checked>
                            <label class="form-check-label" for="checkData">2. Data</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="credito" id="checkCredito" checked>
                            <label class="form-check-label" for="checkCredito">3. Cr√©dito (R$)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="debito" id="checkDebito" checked>
                            <label class="form-check-label" for="checkDebito">4. D√©bito (R$)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="discriminacao" id="checkDiscriminacao" checked>
                            <label class="form-check-label" for="checkDiscriminacao">5. Composi√ß√£o do Valor (R$)</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="cat_transacao" id="checkCategoria" checked>
                            <label class="form-check-label" for="checkCategoria">6. Categoria de Transa√ß√£o</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="competencia" id="checkCompetencia" checked>
                            <label class="form-check-label" for="checkCompetencia">7. Compet√™ncia</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="origem_destino" id="checkOrigemDestino" checked>
                            <label class="form-check-label" for="checkOrigemDestino">8. Origem ou Destino</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="cat_avaliacao" id="checkAvaliacao" checked>
                            <label class="form-check-label" for="checkAvaliacao">9. Avalia√ß√£o</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="avaliacao_analista" id="checkObservacoes" checked>
                            <label class="form-check-label" for="checkObservacoes">10. Observa√ß√µes</label>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="selecionarTodasColunas()">
                        <i class="bi bi-check-all me-1"></i>Selecionar Todas
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="desmarcarTodasColunas()">
                        <i class="bi bi-x-circle me-1"></i>Desmarcar Todas
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="exportarPDF()">
                    <i class="bi bi-file-pdf me-2"></i>Gerar PDF
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Filtros Expandidos -->
<div class="modal fade" id="modalFiltrosExpandidos" tabindex="-1" aria-labelledby="modalFiltrosExpandidosLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalFiltrosExpandidosLabel">
                    <i class="bi bi-funnel me-2"></i>Filtros Avan√ßados - Visualiza√ß√£o Expandida
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div class="row g-4">
                    <div class="col-md-4">
                        <label for="filtroDataExpandido" class="form-label fw-bold"><i class="bi bi-calendar3 me-1"></i>Data (M√™s/Ano)</label>
                        <select class="form-select" id="filtroDataExpandido" multiple size="12" onchange="sincronizarFiltro('filtroData', 'filtroDataExpandido')">
                            <option value="">Todas as datas</option>
                            <option value="__NAO_PREENCHIDO__" style="color: #dc3545; font-style: italic;">‚ùå N√£o preenchido</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="filtroCompetenciaExpandido" class="form-label fw-bold"><i class="bi bi-calendar-range me-1"></i>Compet√™ncia</label>
                        <select class="form-select" id="filtroCompetenciaExpandido" multiple size="12" onchange="sincronizarFiltro('filtroCompetencia', 'filtroCompetenciaExpandido')">
                            <option value="">Todas as compet√™ncias</option>
                            <option value="__NAO_PREENCHIDO__" style="color: #dc3545; font-style: italic;">‚ùå N√£o preenchido</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="filtroCategoriaExpandido" class="form-label fw-bold"><i class="bi bi-tags me-1"></i>Categoria</label>
                        <select class="form-select" id="filtroCategoriaExpandido" multiple size="12" onchange="sincronizarFiltro('filtroCategoria', 'filtroCategoriaExpandido')">
                            <option value="">Todas as categorias</option>
                            <option value="__NAO_PREENCHIDO__" style="color: #dc3545; font-style: italic;">‚ùå N√£o preenchido</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="filtroOrigemDestinoExpandido" class="form-label fw-bold"><i class="bi bi-arrow-left-right me-1"></i>Origem/Destino</label>
                        <select class="form-select" id="filtroOrigemDestinoExpandido" multiple size="12" onchange="sincronizarFiltro('filtroOrigemDestino', 'filtroOrigemDestinoExpandido')">
                            <option value="">Todas as origens/destinos</option>
                            <option value="__NAO_PREENCHIDO__" style="color: #dc3545; font-style: italic;">‚ùå N√£o preenchido</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="filtroAvaliacaoExpandido" class="form-label fw-bold"><i class="bi bi-clipboard-check me-1"></i>Avalia√ß√£o</label>
                        <select class="form-select" id="filtroAvaliacaoExpandido" multiple size="12" onchange="sincronizarFiltro('filtroAvaliacao', 'filtroAvaliacaoExpandido')">
                            <option value="">Todas as avalia√ß√µes</option>
                            <option value="__NAO_PREENCHIDO__" style="color: #dc3545; font-style: italic;">‚ùå N√£o preenchido</option>
                            <option value="Avaliado">Avaliado</option>
                            <option value="Aguardando resposta">Aguardando resposta</option>
                            <option value="Pessoa Gestora">Pessoa Gestora</option>
                            <option value="Glosar">Glosar</option>
                        </select>
                    </div>
                </div>
                <hr>
                <p class="text-muted mb-0"><small><i class="bi bi-info-circle me-1"></i>Use Ctrl+Click para selecionar m√∫ltiplos itens. As sele√ß√µes s√£o sincronizadas automaticamente.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="limparFiltrosExpandidos()">
                    <i class="bi bi-x-circle me-2"></i>Limpar Todos
                </button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    <i class="bi bi-check-circle me-2"></i>Aplicar e Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let linhas = [];
    let notasFiscais = {}; // Objeto indexado por conc_extrato_id
    let documentosAnalise = {}; // Objeto indexado por conc_extrato_id
    let categoriasAplicabilidade = {}; // Dicion√°rio { categoria: aplicacao (true/false) }
    let categoriasRubricas = {}; // Dicion√°rio { categoria: rubrica }
    let secaoNotasFiscaisAtiva = false;
    let secaoDocumentosAtiva = false;
    let limiteAtual = 100;
    let proximoIndice = 1;
    let historicoAlteracoes = []; // Hist√≥rico para Undo (m√°ximo 20 estados)
    const MAX_HISTORICO = 20;
    
    // Textos informativos
    const infos = {
        'indice': 'N√∫mero sequencial que define a ordem dos lan√ßamentos. Garante ordena√ß√£o correta mesmo com inser√ß√µes posteriores.',
        'data': 'Data da movimenta√ß√£o conforme consta no extrato banc√°rio.',
        'credito': 'Valores positivos de entrada na conta. Somente valores de cr√©dito no extrato. Se preencher este campo, o campo D√©bito ser√° bloqueado.',
        'debito': 'Valores negativos de sa√≠da da conta. Somente valores de d√©bito no extrato. Se preencher este campo, o campo Cr√©dito ser√° bloqueado.',
        'composicao': 'Valores que comp√µem o cr√©dito ou d√©bito. √ötil quando uma movimenta√ß√£o √© composta por m√∫ltiplas transa√ß√µes. Para mesclar valores iguais consecutivos, use o bot√£o de mesclagem.',
        'categoria': 'Categoria da transa√ß√£o baseada nas despesas do termo e nas categorias de an√°lise. As op√ß√µes s√£o filtradas automaticamente de acordo com o tipo de movimenta√ß√£o (cr√©dito ou d√©bito).',
        'competencia': 'M√™s e ano da compet√™ncia da transa√ß√£o (formato: mai/2025). √â preenchida automaticamente com base na data do lan√ßamento. Deve estar dentro do per√≠odo do projeto com toler√¢ncia de 2 meses antes do in√≠cio e 6 meses ap√≥s o t√©rmino.',
        'origem_destino': 'Origem do cr√©dito (de onde veio o recurso) ou destino do d√©bito (para onde foi o pagamento). Campo de texto livre para descrever a contraparte da transa√ß√£o.',
        'avaliacao': 'Status da avalia√ß√£o da transa√ß√£o. Avaliado (verde) = aprovado, Aguardando resposta (rosa) = pendente, Pessoa Gestora (azul) = responsabilidade da PG, Glosar (laranja) = reprovar. A cor se aplica √† linha inteira. Transa√ß√µes com Banco do Brasil ou Administra√ß√£o P√∫blica s√£o automaticamente avaliadas.',
        'observacoes': 'Campo livre para anota√ß√µes e observa√ß√µes do analista sobre a transa√ß√£o. √ötil para registrar informa√ß√µes adicionais, justificativas ou pend√™ncias relacionadas √† an√°lise.'
    };
    
    // Textos informativos das colunas de documentos
    const infosDocumentos = {
        'guia': 'Holerites, notas fiscais, cupons fiscais, recibos ou demonstrativos que contenham informa√ß√µes como: categoria de despesa, compet√™ncia e prestador / fornecedor.',
        'comprovante': 'Comprova√ß√µes banc√°rias ou possibilidade de identifica√ß√£o do destinat√°rio de forma leg√≠vel em extrato banc√°rio da conta corrente.',
        'contratos': 'Contratos dos prestadores de servi√ßo ou loca√ß√£o do im√≥vel, se houver.',
        'fora_municipio': 'Se a contrata√ß√£o do prestador ou houve obten√ß√µes de fornecedores que n√£o est√£o no munic√≠pio de S√£o Paulo, sem justificativa.'
    };
    
    let categoriasDespesas = [];
    let categoriasAnalise = [];
    let periodoTermo = { inicio: null, final: null }; // Per√≠odo do projeto
    let bancoAtual = ''; // Banco do extrato
    let origensDestinosUnicos = new Set(); // Lista din√¢mica de origens/destinos j√° utilizados
    
    // Regras de avalia√ß√£o autom√°tica (edit√°vel)
    const regrasAvaliacao = {
        // Categorias que devem ser automaticamente marcadas como "Glosar" (prioridade m√°xima)
        glosar: [
            'Taxas Banc√°rias'
            // Adicione outras categorias aqui que devem ser glosadas automaticamente
            // Exemplo: 'Multas', 'Juros de Atraso'
        ],
        // Origens/Destinos que devem ser automaticamente marcados como "Avaliado" (prioridade baixa)
        avaliado: [
            'banco do brasil',
            'administra√ß√£o p√∫blica',
            'administra√ß√£o publica'
        ]
    };
    
    // Autosave no cache (localStorage)
    let autosaveTimer = null;
    
    function salvarNoCache() {
        const numeroTermo = document.getElementById('numeroTermo').value;
        if (!numeroTermo) return;
        
        const cacheKey = `autosave_conc_${numeroTermo}`;
        const dataToSave = {
            timestamp: Date.now(),
            linhas: linhas
        };
        
        try {
            localStorage.setItem(cacheKey, JSON.stringify(dataToSave));
            console.log('‚úì Autosave realizado');
            
            // Mostrar indicador visual
            const status = document.getElementById('autosaveStatus');
            if (status) {
                status.style.display = 'block';
                status.textContent = 'üíæ Salvo em cache';
                setTimeout(() => {
                    status.style.display = 'none';
                }, 2000);
            }
        } catch (error) {
            console.error('Erro ao salvar cache:', error);
        }
    }
    
    function limparCache() {
        const numeroTermo = document.getElementById('numeroTermo').value;
        if (!numeroTermo) return;
        
        const cacheKey = `autosave_conc_${numeroTermo}`;
        localStorage.removeItem(cacheKey);
        console.log('Cache limpo');
    }
    
    function agendarAutosave() {
        // Cancelar timer anterior
        if (autosaveTimer) {
            clearTimeout(autosaveTimer);
        }
        
        // Agendar novo autosave para 3 segundos ap√≥s √∫ltima altera√ß√£o
        autosaveTimer = setTimeout(() => {
            salvarNoCache();
        }, 3000);
    }
    
    function toggleFiltros() {
        const filtros = document.getElementById('filtrosAvancados');
        const btn = document.getElementById('btnToggleFiltros');
        
        if (filtros.style.display === 'none') {
            filtros.style.display = 'block';
            btn.classList.remove('btn-outline-info');
            btn.classList.add('btn-info');
        } else {
            filtros.style.display = 'none';
            btn.classList.remove('btn-info');
            btn.classList.add('btn-outline-info');
        }
    }
    
    function toggleMenuSecoes() {
        const menu = document.getElementById('menuSecoes');
        const btn = document.getElementById('btnMenuSecoes');
        
        if (menu.style.display === 'none') {
            menu.style.display = 'block';
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-primary');
        } else {
            menu.style.display = 'none';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-outline-primary');
        }
    }
    
    async function toggleSecaoNotasFiscais() {
        const checkbox = document.getElementById('secaoNotasFiscais');
        secaoNotasFiscaisAtiva = checkbox.checked;
        
        // Mostrar/ocultar colunas de notas fiscais
        const colunasNF = document.querySelectorAll('.col-nf');
        colunasNF.forEach(col => {
            col.style.display = secaoNotasFiscaisAtiva ? '' : 'none';
        });
        
        // Carregar dados apenas ao ativar a se√ß√£o
        if (secaoNotasFiscaisAtiva) {
            await carregarNotasFiscais();
        }
        
        // Re-renderizar tabela
        renderizarTabela();
    }
    
    async function toggleSecaoDocumentos() {
        const checkbox = document.getElementById('secaoDocumentos');
        secaoDocumentosAtiva = checkbox.checked;
        
        // Mostrar/ocultar colunas de documentos
        const colunasDoc = document.querySelectorAll('.col-doc');
        colunasDoc.forEach(col => {
            col.style.display = secaoDocumentosAtiva ? '' : 'none';
        });
        
        // Carregar dados apenas ao ativar a se√ß√£o
        if (secaoDocumentosAtiva) {
            await carregarDocumentosAnalise();
        }
        
        // Re-renderizar tabela
        renderizarTabela();
    }
    
    function mostrarInfo(campo) {
        const modalBody = document.getElementById('modalInfoBody');
        const texto = infos[campo] || infosDocumentos[campo] || 'Informa√ß√£o n√£o dispon√≠vel.';
        modalBody.innerHTML = `<p class="mb-0">${texto}</p>`;
        
        const modal = new bootstrap.Modal(document.getElementById('modalInfo'));
        modal.show();
    }

    // Carregar termos ao iniciar
    document.addEventListener('DOMContentLoaded', function() {
        carregarTermos();
    });

    async function carregarTermos() {
        try {
            console.log('Carregando termos...');
            const response = await fetch('/conc_bancaria/api/termos');
            if (!response.ok) throw new Error('Erro ao carregar termos');
            
            const termos = await response.json();
            console.log('Termos recebidos:', termos);
            const select = document.getElementById('numeroTermo');
            
            termos.forEach(termo => {
                const option = document.createElement('option');
                option.value = termo;
                option.textContent = termo;
                select.appendChild(option);
            });
            
            // Verificar se h√° termo na URL (vindo da p√°gina de an√°lises)
            const urlParams = new URLSearchParams(window.location.search);
            const termoUrl = urlParams.get('termo');
            console.log('Termo da URL:', termoUrl);
            
            if (termoUrl && termos.includes(termoUrl)) {
                console.log('Selecionando termo:', termoUrl);
                select.value = termoUrl;
                await carregarExtrato();
            }
            
        } catch (error) {
            console.error('Erro ao carregar termos:', error);
            alert('Erro ao carregar lista de termos');
        }
    }

    async function carregarExtrato() {
        const numeroTermo = document.getElementById('numeroTermo').value;
        if (!numeroTermo) {
            linhas = [];
            renderizarTabela();
            document.getElementById('btnSalvar').style.display = 'none';
            return;
        }

        try {
            document.getElementById('loadingIndicator').style.display = 'block';
            
            // Carregar categorias e per√≠odo do termo em paralelo
            await Promise.all([
                carregarCategoriasDespesas(numeroTermo),
                carregarCategoriasAnalise(),
                carregarPeriodoTermo(numeroTermo),
                carregarCategoriasAplicabilidade(),
                carregarCategoriasRubricas(numeroTermo)
            ]);
            
            // Carregar banco do termo
            await carregarBancoTermo(numeroTermo);
            
            const params = new URLSearchParams({
                numero_termo: numeroTermo,
                limite: limiteAtual
            });
            
            const response = await fetch('/conc_bancaria/api/extrato?' + params.toString());
            if (!response.ok) throw new Error('Erro ao carregar extrato');
            
            const dados = await response.json();
            
            // Verificar se h√° autosave no cache para este termo
            const cacheKey = `autosave_conc_${numeroTermo}`;
            const autosaveData = localStorage.getItem(cacheKey);
            let usarAutosave = false;
            
            if (autosaveData) {
                const { timestamp, linhas: linhasCache } = JSON.parse(autosaveData);
                const minutosPassados = (Date.now() - timestamp) / 1000 / 60;
                
                if (minutosPassados < 60) { // Cache v√°lido por 1 hora
                    usarAutosave = confirm(`H√° altera√ß√µes n√£o salvas de ${Math.round(minutosPassados)} minutos atr√°s. Deseja recuper√°-las?`);
                    
                    if (usarAutosave) {
                        linhas = linhasCache;
                        proximoIndice = Math.max(...linhas.map(l => l.indice || 0)) + 1;
                    } else {
                        // Limpar cache se usu√°rio recusar
                        localStorage.removeItem(cacheKey);
                    }
                }
            }
            
            if (!usarAutosave) {
                if (dados.length > 0) {
                    // Mapear campos do backend para o frontend
                    linhas = dados.map(item => ({
                        id: item.id,
                        indice: item.indice,
                        data: item.data,
                        credito: item.credito,
                        debito: item.debito,
                        discriminacao: item.discriminacao,
                        cat_transacao: item.cat_transacao,
                        competencia: item.competencia,
                        origem_destino: item.origem_destino,
                        cat_avaliacao: item.cat_avaliacao,
                        avaliacao_analista: item.avaliacao_analista,
                        mesclado_com: item.mesclado_com || []
                    }));
                    proximoIndice = Math.max(...linhas.map(l => l.indice || 0)) + 1;
                } else {
                    // Se n√£o houver dados, iniciar com 20 linhas vazias
                    linhas = [];
                    adicionarLinhas(20);
                }
            }
            
            renderizarTabela();
            document.getElementById('btnSalvar').style.display = 'block';
            
            // Se se√ß√£o de Notas Fiscais est√° ativa, carregar os dados
            if (secaoNotasFiscaisAtiva) {
                await carregarNotasFiscais();
            }
            
        } catch (error) {
            console.error('Erro ao carregar extrato:', error);
            alert('Erro ao carregar extrato');
        } finally {
            document.getElementById('loadingIndicator').style.display = 'none';
        }
    }

    function setLimite(limite) {
        limiteAtual = limite;
        carregarExtrato();
    }
    
    async function carregarCategoriasDespesas(numeroTermo) {
        try {
            const response = await fetch(`/conc_bancaria/api/categorias-despesas?numero_termo=${encodeURIComponent(numeroTermo)}`);
            if (!response.ok) throw new Error('Erro ao carregar categorias de despesas');
            categoriasDespesas = await response.json();
        } catch (error) {
            console.error('Erro ao carregar categorias de despesas:', error);
            categoriasDespesas = [];
        }
    }
    
    async function carregarCategoriasAnalise() {
        try {
            const response = await fetch('/conc_bancaria/api/categorias-analise');
            if (!response.ok) throw new Error('Erro ao carregar categorias de an√°lise');
            categoriasAnalise = await response.json();
        } catch (error) {
            console.error('Erro ao carregar categorias de an√°lise:', error);
            categoriasAnalise = [];
        }
    }
    
    async function carregarCategoriasAplicabilidade() {
        try {
            const response = await fetch('/conc_bancaria/api/categorias-aplicabilidade');
            if (!response.ok) throw new Error('Erro ao carregar aplicabilidade');
            categoriasAplicabilidade = await response.json();
            console.log('Aplicabilidade carregada:', categoriasAplicabilidade);
        } catch (error) {
            console.error('Erro ao carregar aplicabilidade:', error);
            categoriasAplicabilidade = {};
        }
    }
    
    async function carregarCategoriasRubricas(numeroTermo) {
        try {
            const response = await fetch(`/conc_bancaria/api/categorias-rubricas?numero_termo=${encodeURIComponent(numeroTermo)}`);
            if (!response.ok) throw new Error('Erro ao carregar rubricas');
            categoriasRubricas = await response.json();
            console.log('Rubricas carregadas:', categoriasRubricas);
        } catch (error) {
            console.error('Erro ao carregar rubricas:', error);
            categoriasRubricas = {};
        }
    }
    
    async function carregarNotasFiscais() {
        const numeroTermo = document.getElementById('numeroTermo').value;
        if (!numeroTermo) return;
        
        try {
            const response = await fetch(`/conc_bancaria/api/notas-fiscais?numero_termo=${encodeURIComponent(numeroTermo)}`);
            if (!response.ok) throw new Error('Erro ao carregar notas fiscais');
            
            const notas = await response.json();
            
            // Indexar por conc_extrato_id
            notasFiscais = {};
            notas.forEach(nota => {
                notasFiscais[nota.conc_extrato_id] = {
                    id: nota.id,
                    numero_nota: nota.numero_nota || '',
                    chave_acesso: nota.chave_acesso || '',
                    cnpj_nota: nota.cnpj_nota || ''
                };
            });
            
            console.log(`Notas fiscais carregadas: ${notas.length}`);
            console.log('Mapeamento notasFiscais:', notasFiscais);
            
            // Debug: mostrar quais linhas t√™m ID correspondente
            if (notas.length > 0) {
                console.log('IDs das linhas do extrato:', linhas.map((l, i) => `√çndice ${l.indice}: ID=${l.id}`));
                notas.forEach(nf => {
                    const linhaCorrespondente = linhas.find(l => l.id === nf.conc_extrato_id);
                    if (linhaCorrespondente) {
                        console.log(`‚úì NF encontrada: Nota ${nf.numero_nota} est√° na linha com √≠ndice ${linhaCorrespondente.indice} (ID=${nf.conc_extrato_id})`);
                    } else {
                        console.warn(`‚ö† NF √≥rf√£: Nota ${nf.numero_nota} tem conc_extrato_id=${nf.conc_extrato_id}, mas n√£o h√° linha com esse ID`);
                    }
                });
            }
        } catch (error) {
            console.error('Erro ao carregar notas fiscais:', error);
            notasFiscais = {};
        }
    }
    
    async function carregarDocumentosAnalise() {
        const numeroTermo = document.getElementById('numeroTermo').value;
        if (!numeroTermo) return;
        
        try {
            const response = await fetch(`/conc_bancaria/api/documentos-analise?numero_termo=${encodeURIComponent(numeroTermo)}`);
            if (!response.ok) throw new Error('Erro ao carregar documentos de an√°lise');
            
            const documentos = await response.json();
            
            // Indexar por conc_extrato_id e fazer migra√ß√£o de dados antigos SOMENTE no carregamento
            documentosAnalise = {};
            documentos.forEach(doc => {
                // Migra√ß√£o de valores antigos para novos (s√≥ acontece aqui, uma vez)
                let valorGuia = doc.avaliacao_guia || '';
                if (valorGuia === 'aprovado') valorGuia = 'Guia apresentada';
                else if (valorGuia === 'pendente') valorGuia = 'N√£o apresentada';
                // Valores j√° migrados ou novos permanecem como est√£o
                
                let valorComprovante = doc.avaliacao_comprovante || '';
                if (valorComprovante === 'aprovado') valorComprovante = 'Apresentado corretamente';
                else if (valorComprovante === 'pendente') valorComprovante = 'N√£o apresentado';
                // Valores j√° migrados permanecem como est√£o
                
                let valorContratos = doc.avaliacao_contratos || '';
                if (valorContratos === 'aprovado') valorContratos = 'Contratos apresentados';
                // Outros valores permanecem como est√£o
                
                let valorForaMunicipio = doc.avaliacao_fora_municipio || '';
                if (valorForaMunicipio === 'aprovado') valorForaMunicipio = 'S√£o Paulo';
                // Outros valores permanecem como est√£o
                
                documentosAnalise[doc.conc_extrato_id] = {
                    id: doc.id,
                    avaliacao_guia: valorGuia,
                    avaliacao_comprovante: valorComprovante,
                    avaliacao_contratos: valorContratos,
                    avaliacao_fora_municipio: valorForaMunicipio
                };
            });
            
            console.log(`Documentos de an√°lise carregados: ${documentos.length}`);
            
        } catch (error) {
            console.error('Erro ao carregar documentos de an√°lise:', error);
            documentosAnalise = {};
        }
    }
    
    function obterCategoriasFiltradas(linha) {
        const categorias = [];
        const temCredito = linha.credito && linha.credito > 0;
        const temDebito = linha.debito && linha.debito > 0;
        
        // Adicionar categorias de despesas do termo
        categoriasDespesas.forEach(cat => {
            categorias.push({
                valor: cat.categoria_despesa,
                label: cat.categoria_despesa,
                tipo: 'despesa'
            });
        });
        
        // Adicionar categorias de an√°lise filtradas por tipo de transa√ß√£o
        categoriasAnalise.forEach(cat => {
            const tipo = cat.tipo_transacao;
            let adicionar = false;
            
            if (tipo === 'D√©bito / Cr√©dito') {
                adicionar = true; // Sempre adicionar
            } else if (temCredito && tipo === 'Cr√©dito') {
                adicionar = true;
            } else if (temDebito && tipo === 'D√©bito') {
                adicionar = true;
            }
            
            if (adicionar) {
                categorias.push({
                    valor: cat.categoria_extra,
                    label: cat.categoria_extra,
                    tipo: 'analise'
                });
            }
        });
        
        // Remover duplicatas
        return categorias.filter((cat, index, self) => 
            index === self.findIndex(c => c.valor === cat.valor)
        );
    }
    
    async function carregarPeriodoTermo(numeroTermo) {
        try {
            const response = await fetch(`/conc_bancaria/api/periodo-termo?numero_termo=${encodeURIComponent(numeroTermo)}`);
            if (!response.ok) throw new Error('Erro ao carregar per√≠odo do termo');
            const dados = await response.json();
            periodoTermo = dados;
        } catch (error) {
            console.error('Erro ao carregar per√≠odo do termo:', error);
            periodoTermo = { inicio: null, final: null };
        }
    }
    
    async function carregarBancoTermo(numeroTermo) {
        try {
            const response = await fetch(`/conc_bancaria/api/banco?numero_termo=${encodeURIComponent(numeroTermo)}`);
            if (!response.ok) throw new Error('Erro ao carregar banco');
            const dados = await response.json();
            
            if (dados.banco_extrato) {
                document.getElementById('bancoExtrato').value = dados.banco_extrato;
                bancoAtual = dados.banco_extrato;
            } else {
                document.getElementById('bancoExtrato').value = '';
                bancoAtual = '';
            }
        } catch (error) {
            console.error('Erro ao carregar banco do termo:', error);
            document.getElementById('bancoExtrato').value = '';
            bancoAtual = '';
        }
    }
    
    function validarCompetencia(competenciaStr) {
        if (!competenciaStr || !periodoTermo.inicio || !periodoTermo.final) {
            return { valido: true, mensagem: '' };
        }
        
        // Converter competencia (formato: AAAA-MM-DD onde DD=01) para Date
        const competencia = new Date(competenciaStr);
        const inicio = new Date(periodoTermo.inicio);
        const final = new Date(periodoTermo.final);
        
        // Calcular limites com toler√¢ncia
        const limiteInicio = new Date(inicio);
        limiteInicio.setMonth(limiteInicio.getMonth() - 2); // 2 meses antes
        
        const limiteFinal = new Date(final);
        limiteFinal.setMonth(limiteFinal.getMonth() + 6); // 6 meses depois
        
        if (competencia < limiteInicio || competencia > limiteFinal) {
            const mesInicio = (limiteInicio.getMonth() + 1).toString().padStart(2, '0');
            const anoInicio = limiteInicio.getFullYear();
            const mesFinal = (limiteFinal.getMonth() + 1).toString().padStart(2, '0');
            const anoFinal = limiteFinal.getFullYear();
            
            return {
                valido: false,
                mensagem: `Compet√™ncia fora do per√≠odo permitido (${mesInicio}/${anoInicio} a ${mesFinal}/${anoFinal})`
            };
        }
        
        return { valido: true, mensagem: '' };
    }
    
    function formatarCompetenciaParaExibicao(dataStr) {
        if (!dataStr) return '';
        // Parse manual para evitar problemas com timezone: "2025-05-01" -> [2025, 05, 01]
        const partes = dataStr.split('-');
        const ano = partes[0];
        const mes = parseInt(partes[1]) - 1; // M√™s √© 0-indexed
        const meses = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
        return `${meses[mes]}/${ano}`;
    }
    
    function calcularCompetenciaAutomatica(dataStr) {
        if (!dataStr) return null;
        // Parse manual: "2025-05-15" -> [2025, 05, 15]
        const partes = dataStr.split('-');
        const ano = partes[0];
        const mes = partes[1]; // J√° est√° com zero-padding
        // Retornar sempre o dia 01 do m√™s/ano
        return `${ano}-${mes}-01`;
    }
    
    function parseCompetencia(competenciaStr) {
        // Aceita formatos: MM/AAAA ou DD/MM/AAAA
        if (!competenciaStr) return null;
        
        const partes = competenciaStr.trim().split('/');
        
        if (partes.length === 2) {
            // Formato: MM/AAAA ou MM/AA
            const mes = parseInt(partes[0]);
            let ano = parseInt(partes[1]);
            
            // Se ano tem 2 d√≠gitos, converter para 4 (assumir 20XX se >= 00 e <= 99)
            if (ano >= 0 && ano <= 99) {
                ano = 2000 + ano;
            }
            
            if (mes >= 1 && mes <= 12 && ano > 1900) {
                return `${ano}-${mes.toString().padStart(2, '0')}-01`;
            }
        } else if (partes.length === 3) {
            // Formato: DD/MM/AAAA ou DD/MM/AA - ignorar dia, sempre usar 01
            const mes = parseInt(partes[1]);
            let ano = parseInt(partes[2]);
            
            // Se ano tem 2 d√≠gitos, converter para 4
            if (ano >= 0 && ano <= 99) {
                ano = 2000 + ano;
            }
            
            if (mes >= 1 && mes <= 12 && ano > 1900) {
                return `${ano}-${mes.toString().padStart(2, '0')}-01`;
            }
        }
        
        return null;
    }

    function atualizarCompetencia(index, valorInput) {
        // Parse do input do usu√°rio
        const competenciaParsed = parseCompetencia(valorInput);
        
        if (!competenciaParsed) {
            linhas[index].competencia = null;
            linhas[index].competencia_valida = false;
            linhas[index].competencia_erro = 'Formato inv√°lido. Use MM/AAAA';
            renderizarTabela();
            return;
        }
        
        // Validar contra per√≠odo do termo
        const validacao = validarCompetencia(competenciaParsed);
        
        linhas[index].competencia = competenciaParsed;
        linhas[index].competencia_valida = validacao.valido;
        linhas[index].competencia_erro = validacao.valido ? null : validacao.mensagem;
        
        renderizarTabela();
    }

    function formatarExibicaoCompetencia(index, input) {
        // Ao sair do campo, formatar para exibi√ß√£o (mai/2025)
        if (linhas[index].competencia && linhas[index].competencia_valida !== false) {
            input.value = formatarCompetenciaParaExibicao(linhas[index].competencia);
        }
    }

    async function adicionarLinha() {
        // Se estamos em modo limitado (100 ou 200), carregar todas as linhas primeiro
        // para evitar conflitos de √≠ndice com linhas que existem no banco
        if (limiteAtual !== 'todas') {
            const confirmar = confirm(
                'Para adicionar novas linhas com seguran√ßa, o sistema precisa carregar TODAS as linhas dispon√≠veis.\n\n' +
                'Deseja continuar?'
            );
            
            if (!confirmar) return;
            
            // Carregar todas as linhas
            limiteAtual = 'todas';
            await carregarExtrato();
        }
        
        const linha = {
            id: null,
            indice: proximoIndice++,
            data: '',
            credito: null,
            debito: null,
            discriminacao: null,
            cat_transacao: null,
            competencia: null,
            origem_destino: null,
            cat_avaliacao: null,
            avaliacao_analista: null,
            mesclado_com: [],
            _novo: true
        };
        
        linhas.push(linha);
        renderizarTabela();
        document.getElementById('btnSalvar').style.display = 'block';
    }

    async function adicionarLinhaAcima(index) {
        // Se estamos em modo limitado (100 ou 200), carregar todas as linhas primeiro
        if (limiteAtual !== 'todas') {
            const confirmar = confirm(
                'Para adicionar novas linhas com seguran√ßa, o sistema precisa carregar TODAS as linhas dispon√≠veis.\n\n' +
                'Deseja continuar?'
            );
            
            if (!confirmar) return;
            
            // Carregar todas as linhas
            limiteAtual = 'todas';
            await carregarExtrato();
        }
        
        const novaLinha = {
            id: null,
            indice: 0, // Ser√° recalculado
            data: '',
            credito: null,
            debito: null,
            discriminacao: null,
            cat_transacao: null,
            competencia: null,
            origem_destino: null,
            cat_avaliacao: null,
            avaliacao_analista: null,
            mesclado_com: [],
            _novo: true
        };
        
        linhas.splice(index, 0, novaLinha);
        recalcularIndices();
        renderizarTabela();
        document.getElementById('btnSalvar').style.display = 'block';
    }

    async function adicionarLinhasEmLote() {
        // Se estamos em modo limitado (100 ou 200), carregar todas as linhas primeiro
        if (limiteAtual !== 'todas') {
            const confirmar = confirm(
                'Para adicionar novas linhas com seguran√ßa, o sistema precisa carregar TODAS as linhas dispon√≠veis.\n\n' +
                'Deseja continuar?'
            );
            
            if (!confirmar) return;
            
            // Carregar todas as linhas
            limiteAtual = 'todas';
            await carregarExtrato();
        }
        
        const input = document.getElementById('inputAdicionarLinhas');
        const quantidade = parseInt(input.value);
        
        if (isNaN(quantidade) || quantidade < 1) {
            alert('Digite uma quantidade v√°lida (m√≠nimo 1)');
            return;
        }
        
        if (quantidade > 100) {
            if (!confirm(`Voc√™ est√° adicionando ${quantidade} linhas. Isso pode deixar a p√°gina lenta. Continuar?`)) {
                return;
            }
        }
        
        // Salvar estado antes de adicionar
        salvarEstadoNoHistorico();
        
        // Adicionar m√∫ltiplas linhas vazias
        for (let i = 0; i < quantidade; i++) {
            const novaLinha = {
                id: null,
                indice: 0, // Ser√° recalculado
                data: '',
                credito: null,
                debito: null,
                discriminacao: null,
                cat_transacao: null,
                competencia: null,
                origem_destino: null,
                cat_avaliacao: null,
                avaliacao_analista: null,
                mesclado_com: [],
                _novo: true
            };
            linhas.push(novaLinha);
        }
        
        recalcularIndices();
        renderizarTabela();
        document.getElementById('btnSalvar').style.display = 'block';
        
        // Resetar input
        input.value = '1';
        
        // Feedback
        alert(`${quantidade} linha(s) adicionada(s) no final da tabela`);
    }

    async function adicionarLinhaAbaixo(index) {
        // Se estamos em modo limitado (100 ou 200), carregar todas as linhas primeiro
        if (limiteAtual !== 'todas') {
            const confirmar = confirm(
                'Para adicionar novas linhas com seguran√ßa, o sistema precisa carregar TODAS as linhas dispon√≠veis.\n\n' +
                'Deseja continuar?'
            );
            
            if (!confirmar) return;
            
            // Carregar todas as linhas
            limiteAtual = 'todas';
            await carregarExtrato();
        }
        
        const novaLinha = {
            id: null,
            indice: 0, // Ser√° recalculado
            data: '',
            credito: null,
            debito: null,
            discriminacao: null,
            cat_transacao: null,
            competencia: null,
            origem_destino: null,
            cat_avaliacao: null,
            avaliacao_analista: null,
            mesclado_com: [],
            _novo: true
        };
        
        linhas.splice(index + 1, 0, novaLinha);
        recalcularIndices();
        renderizarTabela();
        document.getElementById('btnSalvar').style.display = 'block';
    }

    function duplicarLinha(index, direcao) {
        const linhaOriginal = linhas[index];
        
        // Criar c√≥pia da linha (sem id para for√ßar INSERT)
        const linhaDuplicada = {
            id: null, // Sem ID = nova linha no banco
            indice: 0, // Ser√° recalculado
            data: linhaOriginal.data,
            credito: linhaOriginal.credito,
            debito: linhaOriginal.debito,
            discriminacao: linhaOriginal.discriminacao,
            cat_transacao: linhaOriginal.cat_transacao,
            competencia: linhaOriginal.competencia,
            origem_destino: linhaOriginal.origem_destino,
            cat_avaliacao: linhaOriginal.cat_avaliacao,
            avaliacao_analista: linhaOriginal.avaliacao_analista,
            mesclado_com: [],
            _novo: true
        };
        
        // Inserir acima ou abaixo
        if (direcao === 'acima') {
            linhas.splice(index, 0, linhaDuplicada);
        } else {
            linhas.splice(index + 1, 0, linhaDuplicada);
        }
        
        recalcularIndices();
        renderizarTabela();
        document.getElementById('btnSalvar').style.display = 'block';
    }

    function renderizarTabela() {
        const tbody = document.getElementById('tbodyConciliacao');
        
        // OTIMIZA√á√ÉO 1: Usar DocumentFragment para construir DOM antes de inserir
        // Reduz reflows de N para 1 (melhoria de 50-70% em tabelas grandes)
        const fragment = document.createDocumentFragment();
        
        // OTIMIZA√á√ÉO 2: Cachear identifica√ß√£o de grupos de composi√ß√£o
        // Evita recalcular O(n¬≤) ‚Üí O(n) - cada linha s√≥ √© processada uma vez
        const gruposComposicaoCache = new Map();
        linhas.forEach((_, idx) => {
            gruposComposicaoCache.set(idx, identificarGrupoComposicao(idx));
        });

        linhas.forEach((linha, index) => {
            const tr = document.createElement('tr');
            tr.dataset.index = index;
            
            // Aplicar classe de cor baseado na avalia√ß√£o
            if (linha.cat_avaliacao === 'Avaliado') {
                tr.classList.add('avaliacao-avaliado');
            } else if (linha.cat_avaliacao === 'Aguardando resposta') {
                tr.classList.add('avaliacao-aguardando');
            } else if (linha.cat_avaliacao === 'Pessoa Gestora') {
                tr.classList.add('avaliacao-pessoa-gestora');
            } else if (linha.cat_avaliacao === 'Glosar') {
                tr.classList.add('avaliacao-glosar');
            }
            
            // Detectar mudan√ßa de m√™s: se h√° linha anterior e o m√™s mudou
            // Aplicar borda na linha ATUAL (que inicia o novo m√™s)
            if (index > 0) {
                const linhaAnterior = linhas[index - 1];
                if (linha.data && linhaAnterior.data) {
                    // Parse manual para evitar problemas de timezone
                    const partesAtual = linha.data.split('-'); // "2017-08-01" -> ["2017", "08", "01"]
                    const partesAnterior = linhaAnterior.data.split('-');
                    
                    const anoAtual = parseInt(partesAtual[0]);
                    const mesAtual = parseInt(partesAtual[1]);
                    const anoAnterior = parseInt(partesAnterior[0]);
                    const mesAnterior = parseInt(partesAnterior[1]);
                    
                    // Se mudou o m√™s ou ano, adicionar classe de separa√ß√£o na linha ATUAL
                    if (mesAtual !== mesAnterior || anoAtual !== anoAnterior) {
                        tr.classList.add('mudanca-mes');
                    }
                }
            }
            
            // OTIMIZA√á√ÉO: Usar grupo de composi√ß√£o do cache (pr√©-calculado)
            const grupoInfo = gruposComposicaoCache.get(index);
            
            // C√©lula de √≠ndice simples
            tr.innerHTML = `
                <td class="text-center">${linha.indice || ''}</td>
            `;
            
            // Renderizar c√©lula de cr√©dito
            let htmlCredito = '';
            if (linha.credito) {
                if (grupoInfo.ehGrupo && grupoInfo.tipo === 'credito' && !grupoInfo.ehPrimeira) {
                    // Linha secund√°ria de grupo de composi√ß√£o de cr√©dito
                    htmlCredito = `
                        <td class="${linha.debito ? 'cell-disabled' : ''}" style="background-color: #e8f5e9;">
                            <div style="text-align: center; padding: 6px; color: #2e7d32; font-style: italic;">
                                Cr√©dito composto
                            </div>
                        </td>
                    `;
                } else {
                    // Linha normal ou primeira do grupo
                    htmlCredito = `
                        <td class="${linha.debito ? 'cell-disabled' : ''}">
                            <input type="text" class="cell-input cell-money" 
                                   value="${formatarMoeda(linha.credito)}" 
                                   ${linha.debito ? 'disabled' : ''}
                                   onchange="atualizarValor(${index}, 'credito', this.value)"
                                   onblur="blurCondicional(${index}, this)"
                                   onkeydown="navegarCelula(event, ${index}, 1)">
                        </td>
                    `;
                }
            } else {
                htmlCredito = `
                    <td class="${linha.debito ? 'cell-disabled' : ''}">
                        <input type="text" class="cell-input cell-money" 
                               value="${formatarMoeda(linha.credito)}" 
                               ${linha.debito ? 'disabled' : ''}
                               onchange="atualizarValor(${index}, 'credito', this.value)"
                               onblur="blurCondicional(${index}, this)"
                               onkeydown="navegarCelula(event, ${index}, 1)">
                    </td>
                `;
            }
            
            // Renderizar c√©lula de d√©bito
            let htmlDebito = '';
            if (linha.debito) {
                if (grupoInfo.ehGrupo && grupoInfo.tipo === 'debito' && !grupoInfo.ehPrimeira) {
                    // Linha secund√°ria de grupo de composi√ß√£o de d√©bito
                    htmlDebito = `
                        <td class="${linha.credito ? 'cell-disabled' : ''}" style="background-color: #ffebee;">
                            <div style="text-align: center; padding: 6px; color: #c62828; font-style: italic;">
                                D√©bito composto
                            </div>
                        </td>
                    `;
                } else {
                    // Linha normal ou primeira do grupo
                    htmlDebito = `
                        <td class="${linha.credito ? 'cell-disabled' : ''}">
                            <input type="text" class="cell-input cell-money" 
                                   value="${formatarMoeda(linha.debito)}" 
                                   ${linha.credito ? 'disabled' : ''}
                                   onchange="atualizarValor(${index}, 'debito', this.value)"
                                   onblur="blurCondicional(${index}, this)"
                                   onkeydown="navegarCelula(event, ${index}, 2)">
                        </td>
                    `;
                }
            } else {
                htmlDebito = `
                    <td class="${linha.credito ? 'cell-disabled' : ''}">
                        <input type="text" class="cell-input cell-money" 
                               value="${formatarMoeda(linha.debito)}" 
                               ${linha.credito ? 'disabled' : ''}
                               onchange="atualizarValor(${index}, 'debito', this.value)"
                               onblur="blurCondicional(${index}, this)"
                               onkeydown="navegarCelula(event, ${index}, 2)">
                    </td>
                `;
            }
            
            // Renderizar input com datalist de categoria (busca sugestiva)
            const categoriasFiltradas = obterCategoriasFiltradas(linha);
            const datalistId = `datalist-cat-${index}`;
            let htmlCategoria = `
                <input type="text" 
                       class="form-control form-control-sm cell-input" 
                       list="${datalistId}"
                       value="${linha.cat_transacao || ''}" 
                       onchange="atualizarCampo(${index}, 'cat_transacao', this.value)"
                       onblur="blurCondicionalCategoria(${index})"
                       onkeydown="navegarCelula(event, ${index}, 4)"
                       placeholder="Digite para buscar..."
                       autocomplete="off">
                <datalist id="${datalistId}">
            `;
            categoriasFiltradas.forEach(cat => {
                htmlCategoria += `<option value="${cat.valor}">${cat.label}</option>`;
            });
            htmlCategoria += '</datalist>';
            
            tr.innerHTML += `
                <td>
                    <input type="text" 
                           class="cell-input" 
                           value="${linha.data ? formatarDataParaExibicao(linha.data) : ''}" 
                           onchange="atualizarCampoData(${index}, this.value)"
                           onkeydown="navegarCelulaData(event, ${index})"
                           placeholder="dd/mm/aaaa"
                           maxlength="10">
                </td>
                ${htmlCredito}
                ${htmlDebito}
                <td class="${!validarComposicao(index) ? 'composicao-invalida' : ''}">
                    <input type="text" class="cell-input cell-money" 
                           value="${formatarMoeda(linha.discriminacao)}" 
                           onchange="atualizarValor(${index}, 'discriminacao', this.value)"
                           onblur="blurCondicional(${index}, this)"
                           onkeydown="navegarCelula(event, ${index}, 3)">
                </td>
                <td>${htmlCategoria}</td>
                <td>
                    <input type="text" 
                           class="cell-input competencia-input ${linha.competencia_valida === false ? 'is-invalid' : ''}" 
                           value="${linha.competencia ? formatarCompetenciaParaExibicao(linha.competencia) : ''}" 
                           onchange="atualizarCompetencia(${index}, this.value)"
                           onblur="formatarExibicaoCompetencia(${index}, this)"
                           onkeydown="navegarCelula(event, ${index}, 5)"
                           placeholder="MM/AAAA"
                           autocomplete="off">
                    ${linha.competencia_erro ? `<div class="invalid-feedback d-block">${linha.competencia_erro}</div>` : ''}
                </td>
                <td>
                    <input type="text" 
                           class="cell-input" 
                           list="datalistOrigemDestino"
                           value="${linha.origem_destino || ''}" 
                           onchange="atualizarCampo(${index}, 'origem_destino', this.value)"
                           onkeydown="navegarCelulaOrigemDestino(event, ${index})"
                           placeholder="Origem ou destino..."
                           autocomplete="off">
                </td>
                <td>
                    <input type="text" 
                           class="cell-input" 
                           list="datalistAvaliacoes"
                           value="${linha.cat_avaliacao || ''}" 
                           onchange="atualizarCampo(${index}, 'cat_avaliacao', this.value)"
                           onblur="aplicarCorLinha(${index})"
                           onkeydown="navegarCelula(event, ${index}, 7)"
                           placeholder="Selecione..."
                           autocomplete="off">
                </td>
                <td>
                    <input type="text" 
                           class="cell-input" 
                           value="${linha.avaliacao_analista || ''}" 
                           onchange="atualizarCampo(${index}, 'avaliacao_analista', this.value)"
                           onkeydown="navegarCelula(event, ${index}, 8)"
                           placeholder="Observa√ß√µes..."
                           autocomplete="off">
                </td>
                <td class="text-center text-nowrap">
                    <div class="dropdown">
                        <button class="btn btn-sm btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-three-dots-vertical"></i> A√ß√µes
                        </button>
                        <ul class="dropdown-menu">
                            <!-- Adicionar Linhas -->
                            <li><h6 class="dropdown-header"><i class="bi bi-plus-circle"></i> Adicionar</h6></li>
                            <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); adicionarLinhaAcima(${index})">
                                <i class="bi bi-arrow-up-circle me-2"></i>Adicionar linha acima
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); adicionarLinhaAbaixo(${index})">
                                <i class="bi bi-arrow-down-circle me-2"></i>Adicionar linha abaixo
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); duplicarLinha(${index}, 'acima')">
                                <i class="bi bi-files me-2"></i>Duplicar linha acima
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); duplicarLinha(${index}, 'abaixo')">
                                <i class="bi bi-files me-2"></i>Duplicar linha abaixo
                            </a></li>
                            
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header"><i class="bi bi-arrows-move"></i> Movimenta√ß√£o</h6></li>
                            <li><a class="dropdown-item ${index === 0 ? 'disabled' : ''}" href="#" onclick="event.preventDefault(); moverLinha(${index}, -1)">
                                <i class="bi bi-arrow-up me-2"></i>Mover para cima
                            </a></li>
                            <li><a class="dropdown-item ${index === linhas.length - 1 ? 'disabled' : ''}" href="#" onclick="event.preventDefault(); moverLinha(${index}, 1)">
                                <i class="bi bi-arrow-down me-2"></i>Mover para baixo
                            </a></li>
                            
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header"><i class="bi bi-gear"></i> Outras A√ß√µes</h6></li>
                            <li><a class="dropdown-item ${index === 0 ? 'disabled' : ''}" href="#" onclick="event.preventDefault(); copiarDataAcima(${index})">
                                <i class="bi bi-calendar-plus me-2"></i>Copiar data acima
                            </a></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="event.preventDefault(); excluirLinha(${index})">
                                <i class="bi bi-trash me-2"></i>Excluir linha
                            </a></li>
                        </ul>
                    </div>
                </td>
            `;
            
            // OTIMIZA√á√ÉO 2: Lazy loading para Notas Fiscais
            // S√≥ processar se linha tem ID (linha salva no banco), evita lookup desnecess√°rio
            if (secaoNotasFiscaisAtiva) {
                const nf = linha.id && notasFiscais[linha.id] ? notasFiscais[linha.id] : { numero_nota: '', chave_acesso: '', cnpj_nota: '' };
                const cnpjInvalido = nf.cnpj_nota && nf.cnpj_nota.replace(/\D/g, '').length !== 14;
                
                tr.innerHTML += `
                    <!-- Coluna 11: N√∫mero da Nota -->
                    <td class="col-nf">
                        <input type="number" 
                               class="cell-input" 
                               value="${nf.numero_nota || ''}" 
                               onchange="atualizarCampoNF(${index}, 'numero_nota', this.value)"
                               onkeydown="navegarCelulaNF(event, ${index}, 0)"
                               placeholder="N√∫mero..."
                               autocomplete="off">
                    </td>
                    <!-- Coluna 12: Chave de Acesso -->
                    <td class="col-nf">
                        <input type="text" 
                               class="cell-input" 
                               value="${nf.chave_acesso || ''}" 
                               onchange="atualizarCampoNF(${index}, 'chave_acesso', this.value)"
                               onkeydown="navegarCelulaNF(event, ${index}, 1)"
                               placeholder="Chave de acesso..."
                               autocomplete="off">
                    </td>
                    <!-- Coluna 13: CNPJ -->
                    <td class="col-nf ${cnpjInvalido ? 'cnpj-invalido' : ''}">
                        <input type="text" 
                               class="cell-input" 
                               value="${nf.cnpj_nota || ''}" 
                               onchange="atualizarCampoNF(${index}, 'cnpj_nota', this.value)"
                               onkeydown="navegarCelulaNF(event, ${index}, 2)"
                               placeholder="00.000.000/0001-00"
                               autocomplete="off">
                    </td>
                `;
            }
            
            // OTIMIZA√á√ÉO 2: Lazy loading para Documentos
            // S√≥ processar se linha tem ID, calcular regras sob demanda apenas quando necess√°rio
            if (secaoDocumentosAtiva) {
                const doc = linha.id && documentosAnalise[linha.id] ? documentosAnalise[linha.id] : {};
                
                // Calcular aplicabilidade apenas se linha tem categoria
                const categoria = linha.cat_transacao || '';
                const naoAplicavelGeral = categoria ? (categoriasAplicabilidade[categoria] === true) : false;
                
                // Calcular regras espec√≠ficas apenas se necess√°rio
                const rubrica = categoria && categoriasRubricas[categoria] ? categoriasRubricas[categoria] : '';
                
                // REGRA: "Fora do Munic√≠pio" - n√£o aplic√°vel para Pessoal e Administrativas
                const naoAplicavelForaMunicipio = naoAplicavelGeral || 
                    rubrica === 'Pessoal' || rubrica === 'Administrativas';
                
                // REGRA: "Contratos" - n√£o aplic√°vel para Pessoal, Materiais, Implanta√ß√£o e Imobilizado
                const rubricasSemContrato = ['Pessoal', 'Materiais', 'Implanta√ß√£o', 'Imobilizado'];
                const naoAplicavelContratos = naoAplicavelGeral || rubricasSemContrato.includes(rubrica);
                
                // Usar valores direto do objeto documentosAnalise (j√° migrados no carregamento)
                // MAS: se categoria n√£o aplic√°vel, for√ßar vazio para mostrar "Selecione..."
                const valorGuia = naoAplicavelGeral ? '' : (doc.avaliacao_guia || '');
                const valorComprovante = naoAplicavelGeral ? '' : (doc.avaliacao_comprovante || '');
                const valorContratos = naoAplicavelContratos ? '' : (doc.avaliacao_contratos || '');
                const valorForaMunicipio = naoAplicavelForaMunicipio ? '' : (doc.avaliacao_fora_municipio || '');
                
                tr.innerHTML += `
                    <!-- Coluna 14: Guia -->
                    <td class="col-doc ${naoAplicavelGeral ? 'cell-disabled' : ''}">
                        <select class="form-select form-select-sm" 
                                ${naoAplicavelGeral ? 'disabled' : ''}
                                onchange="atualizarCampoDoc(${index}, 'avaliacao_guia', this.value)"
                                style="cursor: ${naoAplicavelGeral ? 'not-allowed' : 'pointer'}; font-size: 0.875rem;">
                            <option value="" ${!valorGuia || valorGuia === '' ? 'selected' : ''}>Selecione...</option>
                            <option value="Guia apresentada" ${valorGuia === 'Guia apresentada' ? 'selected' : ''}>Guia apresentada</option>
                            <option value="Guia apresentada (cliente divergente)" ${valorGuia === 'Guia apresentada (cliente divergente)' ? 'selected' : ''}>Guia apresentada (cliente divergente)</option>
                            <option value="N√£o apresentada" ${valorGuia === 'N√£o apresentada' ? 'selected' : ''}>N√£o apresentada</option>
                        </select>
                    </td>
                    <!-- Coluna 15: Comprovante -->
                    <td class="col-doc ${naoAplicavelGeral ? 'cell-disabled' : ''}">
                        <select class="form-select form-select-sm" 
                                ${naoAplicavelGeral ? 'disabled' : ''}
                                onchange="atualizarCampoDoc(${index}, 'avaliacao_comprovante', this.value)"
                                style="cursor: ${naoAplicavelGeral ? 'not-allowed' : 'pointer'}; font-size: 0.875rem;">
                            <option value="" ${!valorComprovante || valorComprovante === '' ? 'selected' : ''}>Selecione...</option>
                            <option value="Apresentado corretamente" ${valorComprovante === 'Apresentado corretamente' ? 'selected' : ''}>Apresentado corretamente</option>
                            <option value="N√£o apresentado" ${valorComprovante === 'N√£o apresentado' ? 'selected' : ''}>N√£o apresentado</option>
                            <option value="Cart√£o de Cr√©dito" ${valorComprovante === 'Cart√£o de Cr√©dito' ? 'selected' : ''}>Cart√£o de Cr√©dito</option>
                            <option value="Pago em Esp√©cie" ${valorComprovante === 'Pago em Esp√©cie' ? 'selected' : ''}>Pago em Esp√©cie</option>
                            <option value="Pago em Cheque" ${valorComprovante === 'Pago em Cheque' ? 'selected' : ''}>Pago em Cheque</option>
                        </select>
                    </td>
                    <!-- Coluna 16: Contratos -->
                    <td class="col-doc ${naoAplicavelContratos ? 'cell-disabled' : ''}">
                        <select class="form-select form-select-sm" 
                                ${naoAplicavelContratos ? 'disabled' : ''}
                                onchange="atualizarCampoDoc(${index}, 'avaliacao_contratos', this.value)"
                                style="cursor: ${naoAplicavelContratos ? 'not-allowed' : 'pointer'}; font-size: 0.875rem;">
                            <option value="" ${!valorContratos || valorContratos === '' ? 'selected' : ''}>Selecione...</option>
                            <option value="Contratos apresentados" ${valorContratos === 'Contratos apresentados' ? 'selected' : ''}>Contratos apresentados</option>
                            <option value="N√£o apresentado" ${valorContratos === 'N√£o apresentado' ? 'selected' : ''}>N√£o apresentado</option>
                        </select>
                    </td>
                    <!-- Coluna 17: Fora Munic√≠pio -->
                    <td class="col-doc ${naoAplicavelForaMunicipio ? 'cell-disabled' : ''}">
                        <select class="form-select form-select-sm" 
                                ${naoAplicavelForaMunicipio ? 'disabled' : ''}
                                onchange="atualizarCampoDoc(${index}, 'avaliacao_fora_municipio', this.value)"
                                style="cursor: ${naoAplicavelForaMunicipio ? 'not-allowed' : 'pointer'}; font-size: 0.875rem;">
                            <option value="" ${!valorForaMunicipio || valorForaMunicipio === '' ? 'selected' : ''}>Selecione...</option>
                            <option value="S√£o Paulo" ${valorForaMunicipio === 'S√£o Paulo' ? 'selected' : ''}>S√£o Paulo</option>
                            <option value="Fora do munic√≠pio" ${valorForaMunicipio === 'Fora do munic√≠pio' ? 'selected' : ''}>Fora do munic√≠pio</option>
                        </select>
                    </td>
                `;
            }
            
            // OTIMIZA√á√ÉO: Adicionar ao fragment (n√£o dispara reflow)
            fragment.appendChild(tr);
        });
        
        // OTIMIZA√á√ÉO: Limpar tbody e adicionar fragment de uma vez (1 √∫nico reflow)
        tbody.innerHTML = '';
        tbody.appendChild(fragment);
        
        // Atualizar filtros e datalist ap√≥s renderizar
        popularFiltros();
        atualizarDatalistOrigemDestino();
    }
    
    // Adicionar listener para colar do Excel
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('tabelaConciliacao').addEventListener('paste', function(e) {
            const target = e.target;
            
            // Verificar se est√° em um input da tabela
            if (!target.classList.contains('cell-input') && !target.classList.contains('cell-money')) {
                return;
            }
            
            e.preventDefault();
            
            // Pegar dados do clipboard
            const clipboardData = e.clipboardData || window.clipboardData;
            const pastedData = clipboardData.getData('Text');
            
            if (!pastedData) return;
            
            // Encontrar √≠ndice da linha e coluna atual
            const tr = target.closest('tr');
            const linhaIndex = parseInt(tr.dataset.index);
            
            // Determinar coluna atual
            const td = target.closest('td');
            const allTds = Array.from(tr.children);
            const tdIndex = allTds.indexOf(td);
            
            // Verificar se est√° em coluna de Notas Fiscais
            if (td.classList.contains('col-nf')) {
                // PASTE em colunas de NF
                const colunasNF = ['numero_nota', 'chave_acesso', 'cnpj_nota'];
                const inputsNF = Array.from(tr.querySelectorAll('.col-nf input'));
                const colunaInicialNF = inputsNF.indexOf(target);
                
                if (colunaInicialNF === -1) return;
                
                // Parse dos dados
                const linhasPaste = pastedData
                    .split('\n')
                    .filter(l => l !== '')  // Remover apenas linhas completamente vazias (n√£o trim!)
                    .map(l => l.split('\t'));  // Split preserva c√©lulas vazias como ''
                
                if (linhasPaste.length === 0) return;
                
                // Salvar estado antes de modificar
                salvarEstadoNoHistorico();
                
                // Garantir linhas suficientes
                const linhasNecessarias = linhaIndex + linhasPaste.length;
                while (linhas.length < linhasNecessarias) {
                    adicionarLinha();
                }
                
                // Distribuir dados de NF
                linhasPaste.forEach((dadosLinha, rowOffset) => {
                    const targetLinhaIdx = linhaIndex + rowOffset;
                    const linha = linhas[targetLinhaIdx];
                    
                    if (!linha.id) return; // Pular se linha n√£o salva ainda
                    
                    if (!notasFiscais[linha.id]) {
                        notasFiscais[linha.id] = { numero_nota: '', chave_acesso: '', cnpj_nota: '' };
                    }
                    
                    dadosLinha.forEach((valor, colOffset) => {
                        const colunaIdx = colunaInicialNF + colOffset;
                        if (colunaIdx < colunasNF.length) {
                            const campo = colunasNF[colunaIdx];
                            notasFiscais[linha.id][campo] = valor.trim();
                        }
                    });
                });
                
                renderizarTabela();
                agendarAutosave();
                alert(`‚úì ${linhasPaste.length} linha(s) de NF coladas!`);
                return;
            }
            
            // Mapear √≠ndice de TD para campo (EXTRATO)
            // 0=√≠ndice, 1=data, 2=cr√©dito, 3=d√©bito, 4=composi√ß√£o, 5=categoria, 6=compet√™ncia, 7=origem, 8=avalia√ß√£o, 9=observa√ß√µes, 10=a√ß√µes
            const colunaMap = {
                1: 'data',
                2: 'credito',
                3: 'debito',
                4: 'discriminacao',
                5: 'cat_transacao',
                6: 'competencia',
                7: 'origem_destino',
                8: 'cat_avaliacao',
                9: 'avaliacao_analista'
            };
            
            const colunaInicial = colunaMap[tdIndex];
            if (!colunaInicial) return;
            
            // Salvar estado antes de modificar
            salvarEstadoNoHistorico();
            
            // Parse dos dados (Excel copia com \t para colunas e \n para linhas)
            const linhasPaste = pastedData
                .split('\n')
                .filter(l => l !== '')  // Remover apenas linhas completamente vazias (n√£o trim!)
                .map(l => l.split('\t'));  // Split preserva c√©lulas vazias como ''
            
            // Se n√£o h√° linhas v√°lidas, retornar
            if (linhasPaste.length === 0) return;
            
            // Garantir que temos linhas suficientes
            const linhasNecessarias = linhaIndex + linhasPaste.length;
            while (linhas.length < linhasNecessarias) {
                adicionarLinha();
            }
            
            // Distribuir dados
            const colunasOrdem = ['data', 'credito', 'debito', 'discriminacao', 'cat_transacao', 'competencia', 'origem_destino', 'cat_avaliacao', 'avaliacao_analista'];
            const colunaInicialIdx = colunasOrdem.indexOf(colunaInicial);
            
            linhasPaste.forEach((dadosLinha, rowOffset) => {
                const targetLinhaIdx = linhaIndex + rowOffset;
                if (targetLinhaIdx >= linhas.length) return;
                
                dadosLinha.forEach((valor, colOffset) => {
                    const colunaIdx = colunaInicialIdx + colOffset;
                    if (colunaIdx >= colunasOrdem.length) return;
                    
                    const campo = colunasOrdem[colunaIdx];
                    valor = valor.trim();
                    
                    if (campo === 'credito' || campo === 'debito' || campo === 'discriminacao') {
                        // Converter para n√∫mero (ou null se vazio)
                        const valorNumerico = valor ? parseMoeda(valor) : null;
                        linhas[targetLinhaIdx][campo] = valorNumerico;
                    } else if (campo === 'data') {
                        // Tentar converter data (dd/mm/aaaa ou dd/mm/aa)
                        if (valor && valor.includes('/')) {
                            const partes = valor.split('/');
                            if (partes.length === 3) {
                                let dia = partes[0].padStart(2, '0');
                                let mes = partes[1].padStart(2, '0');
                                let ano = partes[2];
                                
                                // Converter ano de 2 d√≠gitos para 4
                                if (ano.length === 2) {
                                    ano = '20' + ano;
                                }
                                
                                // Formato aaaa-mm-dd
                                linhas[targetLinhaIdx][campo] = `${ano}-${mes}-${dia}`;
                            } else {
                                linhas[targetLinhaIdx][campo] = valor;
                            }
                        } else {
                            // Se vazio ou n√£o tem '/', atribuir vazio ou o valor original
                            linhas[targetLinhaIdx][campo] = valor || '';
                        }
                    } else if (campo === 'competencia') {
                        // Parse compet√™ncia (mai/2025, 05/2025, 01/06/2017, etc)
                        if (valor) {
                            const competenciaParsed = parseCompetencia(valor);
                            if (competenciaParsed) {
                                linhas[targetLinhaIdx][campo] = competenciaParsed;
                            } else {
                                linhas[targetLinhaIdx][campo] = valor;
                            }
                        } else {
                            // C√©lula vazia - atribuir vazio
                            linhas[targetLinhaIdx][campo] = '';
                        }
                    } else {
                        linhas[targetLinhaIdx][campo] = valor;
                    }
                });
            });
            
            renderizarTabela();
            document.getElementById('btnSalvar').style.display = 'block';
            agendarAutosave();
            
            alert(`‚úì ${linhasPaste.length} linha(s) e ${linhasPaste[0].length} coluna(s) coladas com sucesso!`);
        });
    });

    function verificarMesclagem(index) {
        if (index === 0) return false;
        
        const linhaAtual = linhas[index];
        const linhaAnterior = linhas[index - 1];
        
        // Verifica se tem o mesmo valor de d√©bito ou cr√©dito
        const mesmoDebito = linhaAtual.debito && linhaAnterior.debito && 
                           parseFloat(linhaAtual.debito) === parseFloat(linhaAnterior.debito);
        const mesmoCredito = linhaAtual.credito && linhaAnterior.credito && 
                            parseFloat(linhaAtual.credito) === parseFloat(linhaAnterior.credito);
        
        return mesmoDebito || mesmoCredito;
    }
    
    function getGrupoMesclagem(index) {
        // Sistema manual de mesclagem: verifica array mesclado_com
        const linha = linhas[index];
        if (!linha.mesclado_com || linha.mesclado_com.length === 0) return null;
        
        // Esta linha √© a principal (primeira) do grupo
        return {
            inicio: index,
            fim: Math.max(...linha.mesclado_com),
            tamanho: linha.mesclado_com.length + 1,
            isPrimeira: true,
            isUltima: false,
            indices: [index, ...linha.mesclado_com]
        };
    }
    
    function linhaEstaMescladaComoSecundaria(index) {
        // Verifica se esta linha est√° mesclada como secund√°ria (parte de outro grupo)
        return linhas.some((l, i) => i < index && l.mesclado_com && l.mesclado_com.includes(index));
    }

    function atualizarCampo(index, campo, valor) {
        linhas[index][campo] = valor;
        
        // Auto-preencher compet√™ncia quando mudar a data
        if (campo === 'data' && valor) {
            const competenciaAuto = calcularCompetenciaAutomatica(valor);
            if (competenciaAuto && !linhas[index].competencia) {
                linhas[index].competencia = competenciaAuto;
                renderizarTabela();
            }
        }
        
        agendarAutosave();
    }
    
    function atualizarCampoData(index, valor) {
        // Converter dd/mm/aaaa para aaaa-mm-dd
        let dataFormatada = valor;
        
        if (valor && valor.includes('/')) {
            const partes = valor.split('/');
            if (partes.length === 3) {
                const dia = partes[0].padStart(2, '0');
                const mes = partes[1].padStart(2, '0');
                let ano = partes[2];
                
                // Converter ano de 2 d√≠gitos para 4
                if (ano.length === 2) {
                    ano = '20' + ano;
                }
                
                dataFormatada = `${ano}-${mes}-${dia}`;
            }
        }
        
        atualizarCampo(index, 'data', dataFormatada);
    }
    
    function navegarCelulaData(event, linhaIndex) {
        const input = event.target;
        
        // Enter: vai para baixo
        if (event.key === 'Enter') {
            event.preventDefault();
            
            // Formatar data antes de sair (se tiver valor parcial)
            const valor = input.value;
            if (valor && !valor.includes('-')) {
                atualizarCampoData(linhaIndex, valor);
            }
            
            focarCelula(linhaIndex + 1, 0);
            return;
        }
        
        // Tab: vai para direita
        if (event.key === 'Tab' && !event.ctrlKey) {
            event.preventDefault();
            
            // Formatar data antes de sair
            const valor = input.value;
            if (valor && !valor.includes('-')) {
                atualizarCampoData(linhaIndex, valor);
            }
            
            focarCelula(linhaIndex, 1);
            return;
        }
        
        // Ctrl+Tab: vai para esquerda
        if (event.key === 'Tab' && event.ctrlKey) {
            event.preventDefault();
            focarCelula(linhaIndex, -1);
            return;
        }
        
        // Auto-adicionar barras ao digitar data
        if (event.key >= '0' && event.key <= '9') {
            const valor = input.value.replace(/\D/g, '');
            if (valor.length === 2 || valor.length === 4) {
                setTimeout(() => {
                    const atual = input.value.replace(/\D/g, '');
                    if (atual.length === 2) {
                        input.value = atual.slice(0, 2) + '/';
                    } else if (atual.length === 4) {
                        input.value = atual.slice(0, 2) + '/' + atual.slice(2, 4) + '/';
                    }
                }, 10);
            }
        }
    }

    function navegarCelulaOrigemDestino(event, linhaIndex) {
        // Enter: vai para pr√≥xima linha, mesma coluna (Origem/Destino)
        if (event.key === 'Enter') {
            event.preventDefault();
            focarCelula(linhaIndex + 1, 6);
            return;
        }
        
        // Tab: vai para direita (Avalia√ß√£o)
        if (event.key === 'Tab' && !event.ctrlKey) {
            event.preventDefault();
            focarCelula(linhaIndex, 7);
            return;
        }
        
        // Ctrl+Tab: vai para esquerda (Compet√™ncia)
        if (event.key === 'Tab' && event.ctrlKey) {
            event.preventDefault();
            focarCelula(linhaIndex, 5);
            return;
        }
    }
    
    function atualizarCampoNF(index, campo, valor) {
        const linha = linhas[index];
        if (!linha.id) {
            console.warn('Linha n√£o salva ainda - NF ser√° criada ap√≥s salvar extrato');
            return;
        }
        
        // Criar objeto NF se n√£o existir
        if (!notasFiscais[linha.id]) {
            notasFiscais[linha.id] = {
                numero_nota: '',
                chave_acesso: '',
                cnpj_nota: ''
            };
        }
        
        notasFiscais[linha.id][campo] = valor;
        
        // Re-renderizar para validar CNPJ
        if (campo === 'cnpj_nota') {
            renderizarTabela();
        }
        
        agendarAutosave();
    }
    
    function atualizarCampoDoc(index, campo, valorDropdown) {
        const linha = linhas[index];
        if (!linha.id) {
            console.warn('Linha n√£o salva ainda - Documentos ser√£o criados ap√≥s salvar extrato');
            return;
        }
        
        // Criar objeto Documentos se n√£o existir
        if (!documentosAnalise[linha.id]) {
            documentosAnalise[linha.id] = {
                avaliacao_guia: '',
                avaliacao_comprovante: '',
                avaliacao_contratos: '',
                avaliacao_fora_municipio: ''
            };
        }
        
        // Atualizar campo com valor do dropdown (texto direto)
        documentosAnalise[linha.id][campo] = valorDropdown || '';
        
        agendarAutosave();
    }
    
    function navegarCelulaNF(event, linhaIndex, colunaAtual) {
        // colunaAtual: 0 = numero_nota, 1 = chave_acesso, 2 = cnpj_nota
        
        // Enter: vai para baixo na mesma coluna
        if (event.key === 'Enter') {
            event.preventDefault();
            if (linhaIndex < linhas.length - 1) {
                const proximaLinha = linhaIndex + 1;
                const inputs = document.querySelectorAll(`tr[data-index="${proximaLinha}"] .col-nf input`);
                if (inputs[colunaAtual]) {
                    inputs[colunaAtual].focus();
                    inputs[colunaAtual].select();
                }
            }
            return;
        }
        
        // Tab: vai para direita
        if (event.key === 'Tab' && !event.ctrlKey) {
            event.preventDefault();
            const inputs = document.querySelectorAll(`tr[data-index="${linhaIndex}"] .col-nf input`);
            if (colunaAtual < 2) {
                // Pr√≥xima coluna de NF
                inputs[colunaAtual + 1].focus();
                inputs[colunaAtual + 1].select();
            } else {
                // √öltima coluna NF - ir para pr√≥xima linha, primeira coluna NF
                if (linhaIndex < linhas.length - 1) {
                    const proximaLinha = linhaIndex + 1;
                    const inputsProxima = document.querySelectorAll(`tr[data-index="${proximaLinha}"] .col-nf input`);
                    if (inputsProxima[0]) {
                        inputsProxima[0].focus();
                        inputsProxima[0].select();
                    }
                }
            }
            return;
        }
        
        // Ctrl+Tab: vai para esquerda
        if (event.key === 'Tab' && event.ctrlKey) {
            event.preventDefault();
            const inputs = document.querySelectorAll(`tr[data-index="${linhaIndex}"] .col-nf input`);
            if (colunaAtual > 0) {
                // Coluna anterior de NF
                inputs[colunaAtual - 1].focus();
                inputs[colunaAtual - 1].select();
            } else {
                // Primeira coluna NF - voltar para √∫ltima coluna do extrato (Observa√ß√µes)
                focarCelula(linhaIndex, 8);
            }
            return;
        }
    }

    function identificarGrupoComposicao(index) {
        // Identifica se a linha faz parte de um grupo de composi√ß√£o
        // Retorna: { ehGrupo: boolean, ehPrimeira: boolean, inicioGrupo: number, fimGrupo: number, tipo: 'credito'|'debito' }
        
        const linha = linhas[index];
        const valorReferencia = linha.credito || linha.debito;
        
        if (!valorReferencia) {
            return { ehGrupo: false };
        }
        
        // Se composi√ß√£o = valor (d√©bito/cr√©dito), n√£o faz parte de grupo composto
        const composicao = linha.discriminacao || 0;
        if (Math.abs(composicao - valorReferencia) < 0.01) {
            return { ehGrupo: false };
        }
        
        const data = linha.data;
        const tipo = linha.credito ? 'credito' : 'debito';
        
        // Buscar in√≠cio do grupo (para tr√°s)
        // Apenas linhas com composi√ß√£o DIFERENTE do valor principal
        let inicioGrupo = index;
        for (let i = index - 1; i >= 0; i--) {
            const linhaAnterior = linhas[i];
            const valorAnterior = tipo === 'credito' ? linhaAnterior.credito : linhaAnterior.debito;
            const composicaoAnterior = linhaAnterior.discriminacao || 0;
            
            // Verificar: mesma data, mesmo valor, composi√ß√£o ‚â† valor
            if (linhaAnterior.data === data && 
                Math.abs((valorAnterior || 0) - valorReferencia) < 0.01 &&
                Math.abs(composicaoAnterior - valorReferencia) >= 0.01) {
                inicioGrupo = i;
            } else {
                break;
            }
        }
        
        // Buscar fim do grupo (para frente)
        // Apenas linhas com composi√ß√£o DIFERENTE do valor principal
        let fimGrupo = index;
        for (let i = index + 1; i < linhas.length; i++) {
            const linhaPosterior = linhas[i];
            const valorPosterior = tipo === 'credito' ? linhaPosterior.credito : linhaPosterior.debito;
            const composicaoPosterior = linhaPosterior.discriminacao || 0;
            
            // Verificar: mesma data, mesmo valor, composi√ß√£o ‚â† valor
            if (linhaPosterior.data === data && 
                Math.abs((valorPosterior || 0) - valorReferencia) < 0.01 &&
                Math.abs(composicaoPosterior - valorReferencia) >= 0.01) {
                fimGrupo = i;
            } else {
                break;
            }
        }
        
        // Se h√° apenas 1 linha, n√£o √© grupo
        if (inicioGrupo === fimGrupo) {
            return { ehGrupo: false };
        }
        
        // √â um grupo v√°lido!
        // (composi√ß√µes podem ser iguais ou diferentes, o importante √© que composi√ß√£o ‚â† valor)
        return {
            ehGrupo: true,
            ehPrimeira: index === inicioGrupo,
            inicioGrupo: inicioGrupo,
            fimGrupo: fimGrupo,
            tipo: tipo
        };
    }

    function validarComposicao(index) {
        // Validar composi√ß√£o com base em grupos (exclui linhas onde composi√ß√£o = valor)
        
        const linha = linhas[index];
        const valorReferencia = linha.credito || linha.debito;
        const composicao = linha.discriminacao;
        
        if (!valorReferencia) {
            return true; // Sem valor de refer√™ncia, n√£o validar
        }
        
        if (!composicao) {
            return true; // Sem composi√ß√£o ainda, n√£o invalidar
        }
        
        // Se composi√ß√£o = valor, valida√ß√£o individual simples
        if (Math.abs(composicao - valorReferencia) < 0.01) {
            return true; // Composi√ß√£o igual ao valor √© sempre v√°lida
        }
        
        // Usar fun√ß√£o de identifica√ß√£o de grupo (que j√° exclui linhas com composi√ß√£o = valor)
        const grupoInfo = identificarGrupoComposicao(index);
        
        if (!grupoInfo.ehGrupo) {
            // Linha individual com composi√ß√£o ‚â† valor
            // Pode ser v√°lida se houver linhas adjacentes com mesmo valor/data (grupo em forma√ß√£o)
            // Validar como grupo potencial antes de invalidar
            const data = linha.data;
            const tipo = linha.credito ? 'credito' : 'debito';
            
            // Verificar se h√° linhas adjacentes com mesmo valor e data (grupo potencial)
            let temAdjacentes = false;
            
            // Verificar linha anterior
            if (index > 0) {
                const linhaAnt = linhas[index - 1];
                const valorAnt = tipo === 'credito' ? linhaAnt.credito : linhaAnt.debito;
                if (linhaAnt.data === data && Math.abs((valorAnt || 0) - valorReferencia) < 0.01) {
                    temAdjacentes = true;
                }
            }
            
            // Verificar linha posterior
            if (index < linhas.length - 1) {
                const linhaPost = linhas[index + 1];
                const valorPost = tipo === 'credito' ? linhaPost.credito : linhaPost.debito;
                if (linhaPost.data === data && Math.abs((valorPost || 0) - valorReferencia) < 0.01) {
                    temAdjacentes = true;
                }
            }
            
            // Se tem adjacentes, considerar v√°lida (grupo em forma√ß√£o)
            // Se n√£o tem adjacentes, considerar inv√°lida (composi√ß√£o diferente sem grupo)
            return temAdjacentes;
        }
        
        // Linha faz parte de grupo: somar todas as composi√ß√µes do grupo
        const composicoesGrupo = [];
        for (let i = grupoInfo.inicioGrupo; i <= grupoInfo.fimGrupo; i++) {
            composicoesGrupo.push(linhas[i].discriminacao || 0);
        }
        
        const somaComposicoes = composicoesGrupo.reduce((acc, val) => acc + val, 0);
        const diferenca = Math.abs(valorReferencia - somaComposicoes);
        
        return diferenca <= 0.02;
    }

    function validarComposicao_OLD_BACKUP(index) {
        // BACKUP da l√≥gica antiga - manter para refer√™ncia
        const linha = linhas[index];
        const valorReferencia = linha.credito || linha.debito;
        const composicao = linha.discriminacao;
        
        if (!valorReferencia) {
            return true;
        }
        
        if (!composicao) {
            return true;
        }
        
        const data = linha.data;
        const tipo = linha.credito ? 'credito' : 'debito';
        
        // Buscar in√≠cio do grupo (para tr√°s)
        let inicioGrupo = index;
        for (let i = index - 1; i >= 0; i--) {
            const linhaAnterior = linhas[i];
            const valorAnterior = tipo === 'credito' ? linhaAnterior.credito : linhaAnterior.debito;
            
            // Se for mesma data e mesmo valor, faz parte do grupo
            if (linhaAnterior.data === data && Math.abs((valorAnterior || 0) - valorReferencia) < 0.01) {
                inicioGrupo = i;
            } else {
                break; // Linha diferente, fim do grupo
            }
        }
        
        // Buscar fim do grupo (para frente)
        let fimGrupo = index;
        for (let i = index + 1; i < linhas.length; i++) {
            const linhaPosterior = linhas[i];
            const valorPosterior = tipo === 'credito' ? linhaPosterior.credito : linhaPosterior.debito;
            
            // Se for mesma data e mesmo valor, faz parte do grupo
            if (linhaPosterior.data === data && Math.abs((valorPosterior || 0) - valorReferencia) < 0.01) {
                fimGrupo = i;
            } else {
                break; // Linha diferente, fim do grupo
            }
        }
        
        // Se h√° apenas 1 linha no grupo, validar normalmente (1-1)
        if (inicioGrupo === fimGrupo) {
            const diferenca = Math.abs(valorReferencia - composicao);
            return diferenca <= 0.02;
        }
        
        // Grupo com 2+ linhas: verificar se as composi√ß√µes s√£o DIFERENTES
        const composicoesGrupo = [];
        for (let i = inicioGrupo; i <= fimGrupo; i++) {
            composicoesGrupo.push(linhas[i].discriminacao || 0);
        }
        
        // Se todas composi√ß√µes forem iguais, validar como 1-1
        const todasIguais = composicoesGrupo.every(comp => Math.abs(comp - composicoesGrupo[0]) < 0.01);
        if (todasIguais) {
            const diferenca = Math.abs(valorReferencia - composicao);
            return diferenca <= 0.02;
        }
        
        // Composi√ß√µes diferentes: somar e validar o total
        const somaComposicoes = composicoesGrupo.reduce((acc, val) => acc + val, 0);
        const diferenca = Math.abs(valorReferencia - somaComposicoes);
        
        return diferenca <= 0.02;
    }

    function atualizarValor(index, campo, valor) {
        const valorNumerico = parseMoeda(valor);
        linhas[index][campo] = valorNumerico;
        // N√£o renderizar toda tabela no onchange, apenas no onblur
        agendarAutosave();
    }
    
    function verificarAutoPreenchimento(index) {
        // DESABILITADO: Auto-preenchimento de composi√ß√£o
        // O usu√°rio tem controle manual total dos valores
        
        // Renderizar apenas uma vez ap√≥s todas as atualiza√ß√µes
        renderizarTabela();
    }
    
    function verificarAutoPreenchimentoCategoria(index) {
        const linha = linhas[index];
        const categoria = linha.cat_transacao;
        
        if (categoria) {
            // Buscar correspondente da categoria selecionada
            const categoriaObj = categoriasAnalise.find(cat => cat.categoria_extra === categoria);
            if (categoriaObj && categoriaObj.correspondente) {
                let origemDestino = categoriaObj.correspondente;
                
                // Se o correspondente for "Banco", substituir pelo banco atual do termo
                if (origemDestino === 'Banco' && bancoAtual) {
                    origemDestino = bancoAtual;
                }
                
                // Preencher apenas se o campo estiver vazio
                if (!linha.origem_destino) {
                    linha.origem_destino = origemDestino;
                }
            }
        }
        
        // Renderizar ap√≥s atualiza√ß√£o
        renderizarTabela();
    }

    function formatarMoeda(valor) {
        if (!valor || valor === 0) return '';
        return new Intl.NumberFormat('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(valor);
    }

    function formatarCampoMoeda(input) {
        const valor = parseMoeda(input.value);
        if (valor !== null && valor !== 0) {
            input.value = formatarMoeda(valor);
        }
    }

    function parseMoeda(valor) {
        if (!valor) return null;
        
        // Converter para string e remover s√≠mbolos de moeda e espa√ßos
        let valorStr = String(valor).trim();
        
        // Detectar formato brasileiro (1.234,56) vs americano (1,234.56)
        // Se houver v√≠rgula E ponto, o √∫ltimo caractere define o decimal
        const temVirgula = valorStr.includes(',');
        const temPonto = valorStr.includes('.');
        
        if (temVirgula && temPonto) {
            // Tem ambos: descobrir qual √© o decimal pelo √∫ltimo
            const ultimaVirgula = valorStr.lastIndexOf(',');
            const ultimoPonto = valorStr.lastIndexOf('.');
            
            if (ultimaVirgula > ultimoPonto) {
                // Formato brasileiro: 1.234,56
                valorStr = valorStr.replace(/\./g, '').replace(',', '.');
            } else {
                // Formato americano: 1,234.56
                valorStr = valorStr.replace(/,/g, '');
            }
        } else if (temVirgula) {
            // S√≥ v√≠rgula: assumir formato brasileiro
            valorStr = valorStr.replace(/\./g, '').replace(',', '.');
        }
        // Se s√≥ tem ponto, j√° est√° no formato correto
        
        // Remover tudo exceto n√∫meros, ponto e sinal negativo
        valorStr = valorStr.replace(/[^\d.-]/g, '');
        
        return parseFloat(valorStr) || null;
    }
    
    function blurCondicional(index, input) {
        // Apenas formatar a moeda
        formatarCampoMoeda(input);
        
        // REMOVIDO: Auto-preenchimento de composi√ß√£o
        // O usu√°rio ter√° controle total sobre os valores
        
        // N√ÉO renderizar aqui - deixar para o usu√°rio sair completamente da tabela
    }
    
    function blurCondicionalCategoria(index) {
        // Apenas atualizar dados, SEM renderizar
        const linha = linhas[index];
        const categoria = linha.cat_transacao;
        
        if (categoria) {
            const categoriaObj = categoriasAnalise.find(cat => cat.categoria_extra === categoria);
            if (categoriaObj && categoriaObj.correspondente) {
                let origemDestino = categoriaObj.correspondente;
                
                if (origemDestino === 'Banco' && bancoAtual) {
                    origemDestino = bancoAtual;
                }
                
                if (!linha.origem_destino) {
                    linha.origem_destino = origemDestino;
                }
            }
        }
        
        // N√ÉO renderizar aqui
    }
    
    function aplicarCorLinha(index) {
        // Aplicar cor √† linha sem re-renderizar toda a tabela
        const tbody = document.getElementById('tbodyConciliacao');
        const tr = tbody.children[index];
        
        if (!tr) return;
        
        const linha = linhas[index];
        
        // Remover todas as classes de cor
        tr.classList.remove('avaliacao-avaliado', 'avaliacao-aguardando', 'avaliacao-pessoa-gestora', 'avaliacao-glosar');
        
        // Aplicar nova classe baseado na avalia√ß√£o
        if (linha.cat_avaliacao === 'Avaliado') {
            tr.classList.add('avaliacao-avaliado');
        } else if (linha.cat_avaliacao === 'Aguardando resposta') {
            tr.classList.add('avaliacao-aguardando');
        } else if (linha.cat_avaliacao === 'Pessoa Gestora') {
            tr.classList.add('avaliacao-pessoa-gestora');
        } else if (linha.cat_avaliacao === 'Glosar') {
            tr.classList.add('avaliacao-glosar');
        }
    }

    function navegarCelula(event, linhaIndex, colunaAtual) {
        // Enter: vai para baixo (mesma coluna, pr√≥xima linha)
        if (event.key === 'Enter') {
            event.preventDefault();
            focarCelula(linhaIndex + 1, colunaAtual);
            return;
        }
        
        // Tab: vai para direita (pr√≥xima coluna, mesma linha)
        if (event.key === 'Tab' && !event.ctrlKey) {
            event.preventDefault();
            focarCelula(linhaIndex, colunaAtual + 1);
            return;
        }
        
        // Ctrl+Tab: vai para esquerda (coluna anterior, mesma linha)
        if (event.key === 'Tab' && event.ctrlKey) {
            event.preventDefault();
            focarCelula(linhaIndex, colunaAtual - 1);
            return;
        }
    }

    function focarCelula(linhaIndex, colunaIndex) {
        // Validar se a linha existe
        if (linhaIndex < 0 || linhaIndex >= linhas.length) {
            return;
        }
        
        // Mapeamento de colunas edit√°veis (√≠ndices baseados na ordem visual)
        // 0: data, 1: credito, 2: debito, 3: discriminacao, 4: categoria, 5: competencia, 6: origem_destino, 7: avaliacao, 8: observacoes
        const colunasEditaveis = ['data', 'credito', 'debito', 'discriminacao', 'categoria', 'competencia', 'origem_destino', 'avaliacao', 'observacoes'];
        
        // Validar coluna
        if (colunaIndex < 0 || colunaIndex >= colunasEditaveis.length) {
            return;
        }
        
        // Usar requestAnimationFrame para garantir que o DOM esteja pronto
        requestAnimationFrame(() => {
            const tbody = document.getElementById('tbodyConciliacao');
            const linhaElement = tbody.children[linhaIndex];
            
            if (!linhaElement) return;
            
            // Encontrar o input correspondente
            let inputSelector;
            const coluna = colunasEditaveis[colunaIndex];
            
            switch(coluna) {
                case 'data':
                    inputSelector = 'input[placeholder="dd/mm/aaaa"]';
                    break;
                case 'credito':
                case 'debito':
                case 'discriminacao':
                    // Pegar todos inputs tipo texto que s√£o de moeda
                    const inputs = linhaElement.querySelectorAll('input.cell-money');
                    let targetInput;
                    if (coluna === 'credito') targetInput = inputs[0];
                    else if (coluna === 'debito') targetInput = inputs[1];
                    else if (coluna === 'discriminacao') targetInput = inputs[2];
                    
                    if (targetInput && !targetInput.disabled) {
                        targetInput.focus();
                        targetInput.select();
                    }
                    return;
                case 'categoria':
                    // Categoria usa datalist din√¢mico, pegar o input que n√£o √© de avalia√ß√µes nem origem/destino
                    const catInputs = linhaElement.querySelectorAll('input[type="text"][list]');
                    for (let inp of catInputs) {
                        const listId = inp.getAttribute('list');
                        if (listId && listId.startsWith('datalist-cat-')) {
                            if (!inp.disabled) {
                                inp.focus();
                                inp.select();
                            }
                            return;
                        }
                    }
                    return;
                case 'competencia':
                    inputSelector = 'input.competencia-input';
                    break;
                case 'origem_destino':
                    inputSelector = 'input[list="datalistOrigemDestino"]';
                    break;
                case 'avaliacao':
                    inputSelector = 'input[list="datalistAvaliacoes"]';
                    break;
                case 'observacoes':
                    inputSelector = 'input[placeholder="Observa√ß√µes..."]';
                    break;
            }
            
            if (inputSelector) {
                const input = linhaElement.querySelector(inputSelector);
                if (input && !input.disabled) {
                    input.focus();
                    input.select();
                }
            }
        });
    }

    function desmesclarLinha(index) {
        const linha = linhas[index];
        
        if (!linha.mesclado_com || linha.mesclado_com.length === 0) {
            alert('Esta linha n√£o est√° mesclada.');
            return;
        }
        
        if (!confirm(`Desmesclar linha ${index + 1}?`)) {
            return;
        }
        
        // Limpar array de mesclagem
        linha.mesclado_com = [];
        
        renderizarTabela();
        document.getElementById('btnSalvar').style.display = 'block';
        agendarAutosave();
    }

    function copiarDataAcima(index) {
        if (index === 0) {
            alert('Esta √© a primeira linha, n√£o h√° data acima para copiar.');
            return;
        }
        
        // Encontrar a √∫ltima linha com data preenchida (de tr√°s para frente a partir da linha anterior)
        let linhaReferencia = -1;
        for (let i = index - 1; i >= 0; i--) {
            if (linhas[i].data) {
                linhaReferencia = i;
                break;
            }
        }
        
        if (linhaReferencia === -1) {
            alert('N√£o h√° nenhuma data preenchida nas linhas acima.');
            return;
        }
        
        const dataReferencia = linhas[linhaReferencia].data;
        const linhasAfetadas = index - linhaReferencia;
        
        // Preencher todas as linhas entre a refer√™ncia e a atual
        for (let i = linhaReferencia + 1; i <= index; i++) {
            linhas[i].data = dataReferencia;
            
            // Auto-preencher compet√™ncia baseada na data copiada
            if (!linhas[i].competencia) {
                linhas[i].competencia = calcularCompetenciaAutomatica(dataReferencia);
            }
        }
        
        renderizarTabela();
    }
    
    function formatarDataParaExibicao(dataStr) {
        if (!dataStr) return '';
        // Converter aaaa-mm-dd para dd/mm/aaaa
        const partes = dataStr.split('-');
        if (partes.length === 3) {
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        }
        return dataStr;
    }

    function popularFiltros() {
        // Popular filtro de datas (por m√™s/ano)
        const selectData = document.getElementById('filtroData');
        const datasUnicas = new Set();
        
        linhas.forEach(linha => {
            if (linha.data) {
                // Extrair m√™s/ano (formato: aaaa-mm-dd -> mm/aaaa)
                const partes = linha.data.split('-');
                if (partes.length === 3) {
                    const mesAno = `${partes[1]}/${partes[0]}`;
                    datasUnicas.add(mesAno);
                }
            }
        });
        
        selectData.innerHTML = '<option value="">Todas as datas</option>';
        [...datasUnicas].sort().forEach(data => {
            const option = document.createElement('option');
            option.value = data;
            option.textContent = data;
            selectData.appendChild(option);
        });
        
        // Popular filtro de compet√™ncias
        const selectCompetencia = document.getElementById('filtroCompetencia');
        const competenciasUnicas = new Set();
        
        linhas.forEach(linha => {
            if (linha.competencia) {
                const competenciaFormatada = formatarCompetenciaParaExibicao(linha.competencia);
                competenciasUnicas.add(competenciaFormatada);
            }
        });
        
        selectCompetencia.innerHTML = '<option value="">Todas as compet√™ncias</option>';
        [...competenciasUnicas].sort().forEach(comp => {
            const option = document.createElement('option');
            option.value = comp;
            option.textContent = comp;
            selectCompetencia.appendChild(option);
        });
        
        // Popular filtro de categorias
        const selectCategoria = document.getElementById('filtroCategoria');
        const categoriasUnicas = new Set();
        
        linhas.forEach(linha => {
            if (linha.cat_transacao) {
                categoriasUnicas.add(linha.cat_transacao);
            }
        });
        
        selectCategoria.innerHTML = '<option value="">Todas as categorias</option>';
        [...categoriasUnicas].sort().forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            selectCategoria.appendChild(option);
        });
        
        // Popular filtro de origem/destino
        const selectOrigemDestino = document.getElementById('filtroOrigemDestino');
        const origensUnicas = new Set();
        
        linhas.forEach(linha => {
            if (linha.origem_destino) {
                origensUnicas.add(linha.origem_destino);
            }
        });
        
        selectOrigemDestino.innerHTML = '<option value="">Todas as origens/destinos</option>';
        [...origensUnicas].sort().forEach(origem => {
            const option = document.createElement('option');
            option.value = origem;
            option.textContent = origem;
            selectOrigemDestino.appendChild(option);
        });
    }
    
    function aplicarFiltros() {
        const selectData = document.getElementById('filtroData');
        const selectCompetencia = document.getElementById('filtroCompetencia');
        const selectCategoria = document.getElementById('filtroCategoria');
        const selectOrigemDestino = document.getElementById('filtroOrigemDestino');
        const selectAvaliacao = document.getElementById('filtroAvaliacao');
        
        const datasSelecionadas = Array.from(selectData.selectedOptions)
            .map(opt => opt.value)
            .filter(val => val !== '');
        
        const competenciasSelecionadas = Array.from(selectCompetencia.selectedOptions)
            .map(opt => opt.value)
            .filter(val => val !== '');
        
        const categoriasSelecionadas = Array.from(selectCategoria.selectedOptions)
            .map(opt => opt.value)
            .filter(val => val !== '');
        
        const origensSelecionadas = Array.from(selectOrigemDestino.selectedOptions)
            .map(opt => opt.value)
            .filter(val => val !== '');
        
        const avaliacoesSelecionadas = Array.from(selectAvaliacao.selectedOptions)
            .map(opt => opt.value)
            .filter(val => val !== '');
        
        const tbody = document.getElementById('tbodyConciliacao');
        const rows = tbody.getElementsByTagName('tr');
        
        linhas.forEach((linha, index) => {
            const row = rows[index];
            if (!row) return;
            
            let mostrar = true;
            
            // Filtrar por data (m√™s/ano)
            if (datasSelecionadas.length > 0) {
                let mesAnoLinha = '';
                if (linha.data) {
                    const partes = linha.data.split('-');
                    if (partes.length === 3) {
                        mesAnoLinha = `${partes[1]}/${partes[0]}`;
                    }
                }
                // Verificar se "N√£o preenchido" foi selecionado
                const naoPreenchidoData = datasSelecionadas.includes('__NAO_PREENCHIDO__');
                if (naoPreenchidoData && !linha.data) {
                    mostrar = mostrar && true;
                } else if (naoPreenchidoData) {
                    mostrar = mostrar && (datasSelecionadas.includes(mesAnoLinha) || !linha.data);
                } else {
                    mostrar = mostrar && datasSelecionadas.includes(mesAnoLinha);
                }
            }
            
            // Filtrar por compet√™ncia
            if (competenciasSelecionadas.length > 0) {
                const competenciaLinha = linha.competencia ? formatarCompetenciaParaExibicao(linha.competencia) : '';
                const naoPreenchidoComp = competenciasSelecionadas.includes('__NAO_PREENCHIDO__');
                if (naoPreenchidoComp && !linha.competencia) {
                    mostrar = mostrar && true;
                } else if (naoPreenchidoComp) {
                    mostrar = mostrar && (competenciasSelecionadas.includes(competenciaLinha) || !linha.competencia);
                } else {
                    mostrar = mostrar && competenciasSelecionadas.includes(competenciaLinha);
                }
            }
            
            // Filtrar por categoria
            if (categoriasSelecionadas.length > 0) {
                const naoPreenchidoCat = categoriasSelecionadas.includes('__NAO_PREENCHIDO__');
                if (naoPreenchidoCat && (!linha.cat_transacao || linha.cat_transacao.trim() === '')) {
                    mostrar = mostrar && true;
                } else if (naoPreenchidoCat) {
                    mostrar = mostrar && (categoriasSelecionadas.includes(linha.cat_transacao) || !linha.cat_transacao || linha.cat_transacao.trim() === '');
                } else {
                    mostrar = mostrar && categoriasSelecionadas.includes(linha.cat_transacao);
                }
            }
            
            // Filtrar por origem/destino
            if (origensSelecionadas.length > 0) {
                const naoPreenchidoOrig = origensSelecionadas.includes('__NAO_PREENCHIDO__');
                if (naoPreenchidoOrig && (!linha.origem_destino || linha.origem_destino.trim() === '')) {
                    mostrar = mostrar && true;
                } else if (naoPreenchidoOrig) {
                    mostrar = mostrar && (origensSelecionadas.includes(linha.origem_destino) || !linha.origem_destino || linha.origem_destino.trim() === '');
                } else {
                    mostrar = mostrar && origensSelecionadas.includes(linha.origem_destino);
                }
            }
            
            // Filtrar por avalia√ß√£o
            if (avaliacoesSelecionadas.length > 0) {
                const naoPreenchidoAval = avaliacoesSelecionadas.includes('__NAO_PREENCHIDO__');
                if (naoPreenchidoAval && (!linha.cat_avaliacao || linha.cat_avaliacao.trim() === '')) {
                    mostrar = mostrar && true;
                } else if (naoPreenchidoAval) {
                    mostrar = mostrar && (avaliacoesSelecionadas.includes(linha.cat_avaliacao) || !linha.cat_avaliacao || linha.cat_avaliacao.trim() === '');
                } else {
                    mostrar = mostrar && avaliacoesSelecionadas.includes(linha.cat_avaliacao);
                }
            }
            
            row.style.display = mostrar ? '' : 'none';
        });
    }
    
    function atualizarDatalistOrigemDestino() {
        // Atualizar lista de origens/destinos √∫nicos
        linhas.forEach(linha => {
            if (linha.origem_destino) {
                origensDestinosUnicos.add(linha.origem_destino);
            }
        });
        
        // Atualizar datalist
        const datalist = document.getElementById('datalistOrigemDestino');
        datalist.innerHTML = '';
        
        [...origensDestinosUnicos].sort().forEach(origem => {
            const option = document.createElement('option');
            option.value = origem;
            datalist.appendChild(option);
        });
    }
    
    function excluirLinhasPorIntervalo() {
        const input = document.getElementById('inputExcluirLinhas').value.trim();
        
        if (!input) {
            alert('Digite o intervalo ou √≠ndices para excluir.\nExemplos:\n- Intervalo: 114-120\n- M√∫ltiplos: 5,10,15,20\n- Combinado: 1-5,10,15-20');
            return;
        }
        
        const indicesParaExcluir = new Set();
        
        // Parse do input (aceita intervalos e valores individuais)
        const partes = input.split(',').map(p => p.trim());
        
        for (const parte of partes) {
            if (parte.includes('-')) {
                // Intervalo: 114-120
                const [inicio, fim] = parte.split('-').map(n => parseInt(n.trim()));
                
                if (isNaN(inicio) || isNaN(fim)) {
                    alert(`Intervalo inv√°lido: ${parte}`);
                    return;
                }
                
                if (inicio > fim) {
                    alert(`Intervalo inv√°lido: ${parte} (in√≠cio maior que fim)`);
                    return;
                }
                
                for (let i = inicio; i <= fim; i++) {
                    indicesParaExcluir.add(i);
                }
            } else {
                // Valor individual: 5
                const indice = parseInt(parte);
                
                if (isNaN(indice)) {
                    alert(`Valor inv√°lido: ${parte}`);
                    return;
                }
                
                indicesParaExcluir.add(indice);
            }
        }
        
        // Verificar se h√° √≠ndices para excluir
        if (indicesParaExcluir.size === 0) {
            alert('Nenhum √≠ndice v√°lido para excluir');
            return;
        }
        
        // Salvar estado antes de modificar
        salvarEstadoNoHistorico();
        
        // Filtrar linhas pelo √≠ndice
        const linhasOriginais = linhas.length;
        linhas = linhas.filter(linha => !indicesParaExcluir.has(linha.indice));
        
        const linhasExcluidas = linhasOriginais - linhas.length;
        
        if (linhasExcluidas === 0) {
            alert('Nenhuma linha foi exclu√≠da. Verifique se os √≠ndices existem.');
            return;
        }
        
        // Perguntar confirma√ß√£o
        if (!confirm(`${linhasExcluidas} linha(s) ser√£o exclu√≠das. Confirmar?`)) {
            // Desfazer via hist√≥rico
            desfazerAlteracao();
            return;
        }
        
        // Recalcular √≠ndices
        recalcularIndices();
        
        // Re-renderizar
        renderizarTabela();
        
        // Limpar input
        document.getElementById('inputExcluirLinhas').value = '';
        
        document.getElementById('btnSalvar').style.display = 'block';
        agendarAutosave();
        
        alert(`‚úì ${linhasExcluidas} linha(s) exclu√≠da(s) com sucesso!`);
    }
    
    function salvarEstadoNoHistorico() {
        // Salvar snapshot do estado atual
        const snapshot = {
            linhas: JSON.parse(JSON.stringify(linhas)),
            notasFiscais: JSON.parse(JSON.stringify(notasFiscais)),
            timestamp: Date.now()
        };
        
        historicoAlteracoes.push(snapshot);
        
        // Limitar hist√≥rico a MAX_HISTORICO estados
        if (historicoAlteracoes.length > MAX_HISTORICO) {
            historicoAlteracoes.shift();
        }
        
        // Mostrar bot√£o Undo
        const btnUndo = document.getElementById('btnUndo');
        if (btnUndo) {
            btnUndo.style.display = '';
            btnUndo.title = `Desfazer (${historicoAlteracoes.length} estado(s) salvos)`;
        }
    }
    
    function desfazerAlteracao() {
        if (historicoAlteracoes.length === 0) {
            alert('Nenhuma altera√ß√£o para desfazer');
            return;
        }
        
        // Restaurar √∫ltimo estado
        const estadoAnterior = historicoAlteracoes.pop();
        
        linhas = estadoAnterior.linhas;
        notasFiscais = estadoAnterior.notasFiscais;
        
        renderizarTabela();
        
        // Atualizar bot√£o Undo
        const btnUndo = document.getElementById('btnUndo');
        if (btnUndo) {
            if (historicoAlteracoes.length === 0) {
                btnUndo.style.display = 'none';
            } else {
                btnUndo.title = `Desfazer (${historicoAlteracoes.length} estado(s) salvos)`;
            }
        }
        
        document.getElementById('btnSalvar').style.display = 'block';
    }

    function filtrarPorData() {
        const dataFiltro = prompt('Digite a data para filtrar (dd/mm/aaaa) ou deixe vazio para ver todas:');
        
        if (dataFiltro === null) return; // Cancelou
        
        const tbody = document.getElementById('tbodyConciliacao');
        const rows = tbody.getElementsByTagName('tr');
        
        if (!dataFiltro || dataFiltro.trim() === '') {
            // Mostrar todas
            for (let row of rows) {
                row.style.display = '';
            }
            return;
        }
        
        // Converter dd/mm/aaaa para aaaa-mm-dd
        const partes = dataFiltro.split('/');
        if (partes.length !== 3) {
            alert('Formato inv√°lido! Use dd/mm/aaaa');
            return;
        }
        
        const dataFormatada = `${partes[2]}-${partes[1].padStart(2, '0')}-${partes[0].padStart(2, '0')}`;
        
        // Filtrar linhas
        linhas.forEach((linha, index) => {
            const row = rows[index];
            if (row) {
                row.style.display = linha.data === dataFormatada ? '' : 'none';
            }
        });
    }
    
    function filtrarPorCategoria() {
        const categoriaFiltro = prompt('Digite a categoria para filtrar (ou parte dela) ou deixe vazio para ver todas:');
        
        if (categoriaFiltro === null) return; // Cancelou
        
        const tbody = document.getElementById('tbodyConciliacao');
        const rows = tbody.getElementsByTagName('tr');
        
        if (!categoriaFiltro || categoriaFiltro.trim() === '') {
            // Mostrar todas
            for (let row of rows) {
                row.style.display = '';
            }
            return;
        }
        
        const filtroLower = categoriaFiltro.toLowerCase();
        
        // Filtrar linhas (ALIKE - busca parcial case-insensitive)
        linhas.forEach((linha, index) => {
            const row = rows[index];
            if (row) {
                const categoria = linha.cat_transacao || '';
                const match = categoria.toLowerCase().includes(filtroLower);
                row.style.display = match ? '' : 'none';
            }
        });
    }
    
    function limparFiltros() {
        // Limpar sele√ß√µes dos filtros
        document.getElementById('filtroData').selectedIndex = -1;
        document.getElementById('filtroCompetencia').selectedIndex = -1;
        document.getElementById('filtroCategoria').selectedIndex = -1;
        document.getElementById('filtroOrigemDestino').selectedIndex = -1;
        
        const tbody = document.getElementById('tbodyConciliacao');
        const rows = tbody.getElementsByTagName('tr');
        
        // Mostrar todas as linhas
        for (let row of rows) {
            row.style.display = '';
        }
    }

    function moverLinha(index, direcao) {
        if (index + direcao < 0 || index + direcao >= linhas.length) return;
        
        // Trocar posi√ß√µes
        const temp = linhas[index];
        linhas[index] = linhas[index + direcao];
        linhas[index + direcao] = temp;
        
        // Recalcular √≠ndices
        recalcularIndices();
        renderizarTabela();
        agendarAutosave();
    }

    function excluirLinha(index) {
        if (!confirm('Deseja realmente excluir esta linha?')) return;
        
        linhas.splice(index, 1);
        recalcularIndices();
        renderizarTabela();
        agendarAutosave();
    }

    function recalcularIndices() {
        linhas.forEach((linha, i) => {
            linha.indice = i + 1;
        });
        proximoIndice = linhas.length + 1;
    }

    function limparTabela() {
        if (!confirm('Tem certeza que deseja limpar toda a tabela? Esta a√ß√£o n√£o pode ser desfeita.')) {
            return;
        }
        
        linhas = [];
        renderizarTabela();
        document.getElementById('btnSalvar').style.display = 'none';
    }

    function exportarCSV() {
        const numeroTermo = document.getElementById('numeroTermo').value;
        if (!numeroTermo) {
            alert('Selecione um termo antes de exportar.');
            return;
        }
        
        if (linhas.length === 0) {
            alert('N√£o h√° dados para exportar.');
            return;
        }
        
        // Redirecionar para a rota de exporta√ß√£o
        window.location.href = `/conc_bancaria/api/exportar-csv?numero_termo=${encodeURIComponent(numeroTermo)}`;
    }
    
    function selecionarTodasColunas() {
        document.querySelectorAll('#modalExportarPDF input[type="checkbox"]').forEach(cb => {
            cb.checked = true;
        });
    }
    
    function desmarcarTodasColunas() {
        document.querySelectorAll('#modalExportarPDF input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
        });
    }
    
    function expandirFiltros() {
        // Sincronizar valores dos filtros compactos para os expandidos
        sincronizarFiltro('filtroDataExpandido', 'filtroData');
        sincronizarFiltro('filtroCompetenciaExpandido', 'filtroCompetencia');
        sincronizarFiltro('filtroCategoriaExpandido', 'filtroCategoria');
        sincronizarFiltro('filtroOrigemDestinoExpandido', 'filtroOrigemDestino');
        sincronizarFiltro('filtroAvaliacaoExpandido', 'filtroAvaliacao');
        
        // Abrir modal
        const modal = new bootstrap.Modal(document.getElementById('modalFiltrosExpandidos'));
        modal.show();
    }
    
    function sincronizarFiltro(destino, origem) {
        const selectOrigem = document.getElementById(origem);
        const selectDestino = document.getElementById(destino);
        
        if (!selectOrigem || !selectDestino) return;
        
        // Copiar op√ß√µes do origem para destino (se ainda n√£o existirem)
        const opcoesOrigem = Array.from(selectOrigem.options);
        const valoresDestino = Array.from(selectDestino.options).map(opt => opt.value);
        
        opcoesOrigem.forEach(opcao => {
            if (!valoresDestino.includes(opcao.value)) {
                const novaOpcao = opcao.cloneNode(true);
                selectDestino.appendChild(novaOpcao);
            }
        });
        
        // Sincronizar sele√ß√µes
        const selecionadasOrigem = Array.from(selectOrigem.selectedOptions).map(opt => opt.value);
        Array.from(selectDestino.options).forEach(opt => {
            opt.selected = selecionadasOrigem.includes(opt.value);
        });
        
        // Aplicar filtros ap√≥s sincroniza√ß√£o
        aplicarFiltros();
    }
    
    function limparFiltrosExpandidos() {
        // Limpar todos os filtros expandidos
        document.getElementById('filtroDataExpandido').selectedIndex = -1;
        document.getElementById('filtroCompetenciaExpandido').selectedIndex = -1;
        document.getElementById('filtroCategoriaExpandido').selectedIndex = -1;
        document.getElementById('filtroOrigemDestinoExpandido').selectedIndex = -1;
        document.getElementById('filtroAvaliacaoExpandido').selectedIndex = -1;
        
        // Sincronizar com filtros compactos
        sincronizarFiltro('filtroData', 'filtroDataExpandido');
        sincronizarFiltro('filtroCompetencia', 'filtroCompetenciaExpandido');
        sincronizarFiltro('filtroCategoria', 'filtroCategoriaExpandido');
        sincronizarFiltro('filtroOrigemDestino', 'filtroOrigemDestinoExpandido');
        sincronizarFiltro('filtroAvaliacao', 'filtroAvaliacaoExpandido');
    }
    
    function desmarcarTodasColunas() {
        document.querySelectorAll('#modalExportarPDF input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
        });
    }
    
    function exportarPDF() {
        const numeroTermo = document.getElementById('numeroTermo').value;
        if (!numeroTermo) {
            alert('Selecione um termo antes de exportar.');
            return;
        }
        
        if (linhas.length === 0) {
            alert('N√£o h√° dados para exportar.');
            return;
        }
        
        // Coletar colunas selecionadas
        const colunasSelecionadas = [];
        document.querySelectorAll('#modalExportarPDF input[type="checkbox"]:checked').forEach(cb => {
            colunasSelecionadas.push(cb.value);
        });
        
        if (colunasSelecionadas.length === 0) {
            alert('Selecione pelo menos uma coluna para exportar.');
            return;
        }
        
        // Criar query string com colunas selecionadas
        const colunasParam = colunasSelecionadas.join(',');
        
        // Fechar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalExportarPDF'));
        modal.hide();
        
        // Redirecionar para a rota de exporta√ß√£o PDF
        window.location.href = `/conc_bancaria/api/exportar-pdf?numero_termo=${encodeURIComponent(numeroTermo)}&colunas=${encodeURIComponent(colunasParam)}`;
    }
    
    // DESABILITADO: processarMesclagensAutomaticas
    // A valida√ß√£o de composi√ß√£o agora √© baseada apenas em data/valor, n√£o em mesclado_com
    /*
    function processarMesclagensAutomaticas() {
        ...c√≥digo comentado...
    }
    */
    
    function baixarModelo() {
        window.location.href = '/conc_bancaria/api/modelo-importacao';
    }

    async function salvarConciliacao() {
        const numeroTermo = document.getElementById('numeroTermo').value;
        const bancoExtrato = document.getElementById('bancoExtrato').value;
        
        if (!numeroTermo) {
            alert('Selecione um n√∫mero de termo');
            return;
        }

        // Filtrar linhas com pelo menos um campo preenchido
        const linhasParaSalvar = linhas.filter(linha => {
            return linha.data || linha.credito || linha.debito || linha.discriminacao;
        }).map(linha => {
            // Auto-preencher compet√™ncia se estiver vazia mas tiver data
            let competencia = linha.competencia;
            if (!competencia && linha.data) {
                competencia = calcularCompetenciaAutomatica(linha.data);
            }
            
            // Auto-preencher origem_destino se estiver vazia mas tiver categoria
            let origemDestino = linha.origem_destino;
            if (!origemDestino && linha.cat_transacao) {
                const categoria = categoriasAnalise.find(cat => cat.categoria_extra === linha.cat_transacao);
                if (categoria && categoria.correspondente) {
                    origemDestino = categoria.correspondente;
                    
                    // Se o correspondente for "Banco", substituir pelo banco atual do termo
                    if (origemDestino === 'Banco' && bancoAtual) {
                        origemDestino = bancoAtual;
                    }
                }
            }
            
            // Auto-classificar avalia√ß√£o baseado em regras (prioridade: categoria > origem/destino)
            let avaliacaoAuto = linha.cat_avaliacao;
            
            // Regra priorit√°ria: Categoria de Transa√ß√£o
            if (!avaliacaoAuto && linha.cat_transacao && regrasAvaliacao.glosar.includes(linha.cat_transacao)) {
                avaliacaoAuto = 'Glosar';
            }
            
            // Regra secund√°ria: Origem/Destino
            if (!avaliacaoAuto && origemDestino) {
                const origemNormalizada = origemDestino.toLowerCase().trim();
                if (regrasAvaliacao.avaliado.includes(origemNormalizada)) {
                    avaliacaoAuto = 'Avaliado';
                }
            }
            
            // Auto-preencher composi√ß√£o se estiver vazia
            let discriminacao = linha.discriminacao;
            if (!discriminacao && (linha.credito || linha.debito)) {
                discriminacao = linha.credito || linha.debito;
            }
            
            return {
                id: linha.id,
                indice: linha.indice,
                data: linha.data,
                credito: linha.credito,
                debito: linha.debito,
                discriminacao: discriminacao,
                cat_transacao: linha.cat_transacao,
                competencia: competencia,
                origem_destino: origemDestino,
                cat_avaliacao: avaliacaoAuto,
                avaliacao_analista: linha.avaliacao_analista,
                mesclado_com: linha.mesclado_com || []
            };
        });

        if (linhasParaSalvar.length === 0) {
            if (!confirm('N√£o h√° dados para salvar. Deseja salvar mesmo assim (limpar todos os dados existentes)?')) {
                return;
            }
        }

        try {
            document.getElementById('btnSalvar').disabled = true;
            document.getElementById('btnSalvar').innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Salvando...';

            // Salvar extrato
            const response = await fetch('/conc_bancaria/api/extrato', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    numero_termo: numeroTermo,
                    linhas: linhasParaSalvar,
                    modo_completo: limiteAtual === 'todas'  // S√≥ deleta se carregou todas
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.erro || 'Erro ao salvar extrato');
            }

            // Salvar banco (se preenchido)
            if (bancoExtrato) {
                const bancResponse = await fetch('/conc_bancaria/api/banco', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        numero_termo: numeroTermo,
                        banco_extrato: bancoExtrato
                    })
                });

                if (!bancResponse.ok) {
                    console.warn('Aviso: N√£o foi poss√≠vel salvar o banco');
                }
            }

            const resultado = await response.json();
            // N√£o mostrar mensagem de sucesso - apenas erros
            
            // Salvar Notas Fiscais (se se√ß√£o ativada)
            if (secaoNotasFiscaisAtiva && Object.keys(notasFiscais).length > 0) {
                const notasParaSalvar = Object.entries(notasFiscais)
                    .filter(([concExtratoId, nf]) => nf.numero_nota) // S√≥ salvar se tiver n√∫mero da nota
                    .map(([concExtratoId, nf]) => ({
                        conc_extrato_id: parseInt(concExtratoId),
                        numero_nota: nf.numero_nota,
                        chave_acesso: nf.chave_acesso || null,
                        cnpj_nota: nf.cnpj_nota || null
                    }));
                
                if (notasParaSalvar.length > 0) {
                    const nfResponse = await fetch('/conc_bancaria/api/notas-fiscais', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            numero_termo: numeroTermo,
                            notas: notasParaSalvar
                        })
                    });
                    
                    if (!nfResponse.ok) {
                        console.warn('Aviso: N√£o foi poss√≠vel salvar notas fiscais');
                    }
                }
            }
            
            // Salvar documentos de an√°lise se se√ß√£o estiver ativa
            if (secaoDocumentosAtiva) {
                // Incluir TODAS as linhas salvas (com ID), n√£o apenas as editadas
                const documentosParaSalvar = linhas
                    .filter(linha => linha.id) // Apenas linhas j√° salvas no banco
                    .map(linha => {
                        const categoria = linha.cat_transacao || '';
                        const rubrica = categoriasRubricas[categoria] || '';
                        const naoAplicavelGeral = categoriasAplicabilidade[categoria] === true;
                        
                        // Regras espec√≠ficas por rubrica
                        const naoAplicavelForaMunicipio = naoAplicavelGeral || 
                                                          rubrica === 'Pessoal' || 
                                                          rubrica === 'Administrativas';
                        
                        const naoAplicavelContratos = naoAplicavelGeral || 
                                                      ['Pessoal', 'Materiais', 'Implanta√ß√£o', 'Imobilizado'].includes(rubrica);
                        
                        // Buscar documento existente no objeto indexado
                        const doc = documentosAnalise[linha.id] || {};
                        
                        // SISTEMA DE DROPDOWNS: Enviar valores de texto diretamente
                        // Se campo n√£o aplic√°vel ‚Üí enviar string vazia (ser√° ignorado no backend)
                        // Se campo aplic√°vel ‚Üí enviar valor selecionado ou vazio se n√£o selecionado
                        
                        return {
                            conc_extrato_id: linha.id,
                            avaliacao_guia: naoAplicavelGeral ? '' : (doc.avaliacao_guia || ''),
                            avaliacao_comprovante: naoAplicavelGeral ? '' : (doc.avaliacao_comprovante || ''),
                            avaliacao_contratos: naoAplicavelContratos ? '' : (doc.avaliacao_contratos || ''),
                            avaliacao_fora_municipio: naoAplicavelForaMunicipio ? '' : (doc.avaliacao_fora_municipio || '')
                        };
                    });
                
                if (documentosParaSalvar.length > 0) {
                    const docResponse = await fetch('/conc_bancaria/api/documentos-analise', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            numero_termo: numeroTermo,
                            documentos: documentosParaSalvar
                        })
                    });
                    
                    if (!docResponse.ok) {
                        console.warn('Aviso: N√£o foi poss√≠vel salvar documentos de an√°lise');
                    }
                }
            }
            
            // Limpar cache ap√≥s salvar com sucesso
            limparCache();
            
            // Recarregar dados
            await carregarExtrato();
            if (secaoNotasFiscaisAtiva) {
                await carregarNotasFiscais();
            }
            if (secaoDocumentosAtiva) {
                await carregarDocumentosAnalise();
            }

        } catch (error) {
            console.error('Erro ao salvar:', error);
            alert('Erro ao salvar concilia√ß√£o: ' + error.message);
        } finally {
            document.getElementById('btnSalvar').disabled = false;
            document.getElementById('btnSalvar').innerHTML = '<i class="bi bi-save me-2"></i>Salvar Concilia√ß√£o';
        }
    }

    // Fun√ß√£o para ir √† √∫ltima linha da tabela
    function irParaUltimaLinha() {
        const tbody = document.getElementById('tbodyConciliacao');
        if (tbody && tbody.lastElementChild) {
            tbody.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }
    }
</script>

<!-- Indicador de Autosave Fixo -->
<small id="autosaveStatus">üíæ Salvo em cache</small>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
